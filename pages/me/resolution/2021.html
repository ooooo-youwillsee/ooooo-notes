<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. tomcat 自定义错误页 | ooooo-notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="ooooo-notes">
    
    <link rel="preload" href="/ooooo-notes/assets/css/0.styles.3131f072.css" as="style"><link rel="preload" href="/ooooo-notes/assets/js/app.9e671974.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/2.b8d058ee.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/34.a3c3d2e7.js" as="script"><link rel="prefetch" href="/ooooo-notes/assets/js/10.070fdfb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/11.84183183.js"><link rel="prefetch" href="/ooooo-notes/assets/js/12.2bb14091.js"><link rel="prefetch" href="/ooooo-notes/assets/js/13.c606973d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/14.053ec6a5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/15.a6e2b4e8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/16.d2a477f0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/17.f10cce45.js"><link rel="prefetch" href="/ooooo-notes/assets/js/18.8bd5e995.js"><link rel="prefetch" href="/ooooo-notes/assets/js/19.fa0def65.js"><link rel="prefetch" href="/ooooo-notes/assets/js/20.296dafb2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/21.dfb4b437.js"><link rel="prefetch" href="/ooooo-notes/assets/js/22.8d7869ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/23.17c06445.js"><link rel="prefetch" href="/ooooo-notes/assets/js/24.4b0856fa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/25.a5e90306.js"><link rel="prefetch" href="/ooooo-notes/assets/js/26.43a31a17.js"><link rel="prefetch" href="/ooooo-notes/assets/js/27.6a4ef0e8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/28.144d2adb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/29.62c879c0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/3.4ee9dae3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/30.2abba8be.js"><link rel="prefetch" href="/ooooo-notes/assets/js/31.58a1838f.js"><link rel="prefetch" href="/ooooo-notes/assets/js/32.59132869.js"><link rel="prefetch" href="/ooooo-notes/assets/js/33.198f1fc2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/35.bd736ae0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/36.ac6dc637.js"><link rel="prefetch" href="/ooooo-notes/assets/js/37.7eaa3c9b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/38.e7662281.js"><link rel="prefetch" href="/ooooo-notes/assets/js/39.b076f2fb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/4.1928a3f2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/40.e4910957.js"><link rel="prefetch" href="/ooooo-notes/assets/js/41.3013a382.js"><link rel="prefetch" href="/ooooo-notes/assets/js/42.29ff3853.js"><link rel="prefetch" href="/ooooo-notes/assets/js/43.0301b7fc.js"><link rel="prefetch" href="/ooooo-notes/assets/js/44.3374adcd.js"><link rel="prefetch" href="/ooooo-notes/assets/js/45.9ae2e70a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/46.c4ea0801.js"><link rel="prefetch" href="/ooooo-notes/assets/js/47.f1f27d2c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/48.884fb3f3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/49.0bc73d0a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/5.b7a26e17.js"><link rel="prefetch" href="/ooooo-notes/assets/js/50.c3b6667e.js"><link rel="prefetch" href="/ooooo-notes/assets/js/51.fa771bb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/52.bce5e1f5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/53.6bf43ab0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/54.f3e1ffbf.js"><link rel="prefetch" href="/ooooo-notes/assets/js/55.b5521ee5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/56.4cdd83ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/57.3cdd8c38.js"><link rel="prefetch" href="/ooooo-notes/assets/js/58.07c179d8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/59.bf3b4b01.js"><link rel="prefetch" href="/ooooo-notes/assets/js/6.3385832b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/60.7966b7ff.js"><link rel="prefetch" href="/ooooo-notes/assets/js/7.c63d6270.js"><link rel="prefetch" href="/ooooo-notes/assets/js/8.6e07eb0b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/9.78381cd3.js">
    <link rel="stylesheet" href="/ooooo-notes/assets/css/0.styles.3131f072.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ooooo-notes/" class="home-link router-link-active"><!----> <span class="site-name">ooooo-notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/ooooo-notes/pages/me/resolution/2019.html" class="sidebar-link">2019 Resolution</a></li><li><a href="/ooooo-notes/pages/me/resolution/2020.html" class="sidebar-link">2020 Resolution</a></li><li><a href="/ooooo-notes/pages/me/resolution/2021.html" aria-current="page" class="active sidebar-link">2021 Resolution</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-tomcat-自定义错误页" class="sidebar-link">1. tomcat 自定义错误页</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_2-gradle-全局设置仓库镜像" class="sidebar-link">2. gradle 全局设置仓库镜像</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_3-apache-org-等网站无法访问" class="sidebar-link">3. *.apache.org 等网站无法访问</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_4-inetaddress-gethostname-超时" class="sidebar-link">4. InetAddress#getHostName 超时</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_5-nacos-在-tomcat-中无法注册服务" class="sidebar-link">5. nacos 在 tomcat 中无法注册服务</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_6-mysql8-0-第一次安装后-重置密码" class="sidebar-link">6. mysql8.0 第一次安装后，重置密码</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_7-win10-默认没有创建软链接的权限" class="sidebar-link">7. win10，默认没有创建软链接的权限</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_8-搭建-mysql8-0-主从-在同一个机器上" class="sidebar-link">8. 搭建 mysql8.0 主从， 在同一个机器上</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-安装-mysql-运行-systemctl-start-mysqld-service" class="sidebar-link">1. 安装 mysql, 运行 systemctl start mysqld.service</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_2-创建-master-mysql-的配置文件" class="sidebar-link">2. 创建 master mysql 的配置文件</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-etc-my3307-cnf-文件配置" class="sidebar-link" style="padding-left:3rem;">1./etc/my3307.cnf 文件配置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_2-master-服务器初始化" class="sidebar-link" style="padding-left:3rem;">2. master 服务器初始化</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_3-创建-slave-mysql-的配置文件" class="sidebar-link">3. 创建 slave mysql 的配置文件</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-etc-my3308-cnf-文件配置" class="sidebar-link" style="padding-left:3rem;">1. /etc/my3308.cnf 文件配置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_2-slave-服务器初始化" class="sidebar-link" style="padding-left:3rem;">2. slave 服务器初始化</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_4-问题" class="sidebar-link">4. 问题</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_5-参考" class="sidebar-link">5.参考</a></li></ul></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_8-oracle-rac-集群-url-设置" class="sidebar-link">8. oracle RAC 集群 url 设置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_9-vmware-的-ip-地址续约时间和静态ip设置" class="sidebar-link">9. vmware 的 IP 地址续约时间和静态ip设置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_10-部署-k8s" class="sidebar-link">10. 部署 k8s</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-两台机器初始化设置" class="sidebar-link">1. 两台机器初始化设置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-1-hostname-设置" class="sidebar-link" style="padding-left:3rem;">1.1 hostname 设置</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-2-etc-hosts-文件-两个机器都需要" class="sidebar-link" style="padding-left:3rem;">1.2 /etc/hosts 文件 (两个机器都需要)</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-3-创建非-root-用户-两个机器都需要" class="sidebar-link" style="padding-left:3rem;">1.3 创建非 root 用户 (两个机器都需要)</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-4-添加-yum-代理-两个机器都需要" class="sidebar-link" style="padding-left:3rem;">1.4 添加 yum 代理 (两个机器都需要)</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_1-5-安装-docker-服务-两个机器都需要" class="sidebar-link" style="padding-left:3rem;">1.5 安装 docker 服务 (两个机器都需要)</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_2-k8s-的-kubeadm-安装-两台都需要" class="sidebar-link">2. k8s 的 kubeadm 安装 (两台都需要)</a></li><li class="sidebar-sub-header"><a href="/ooooo-notes/pages/me/resolution/2021.html#_3-创建-k8s-集群-两台都需要" class="sidebar-link">3. 创建 k8s 集群 (两台都需要)</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-tomcat-自定义错误页"><a href="#_1-tomcat-自定义错误页" class="header-anchor">#</a> 1. tomcat 自定义错误页</h2> <p>在 <code>conf/server.xml</code> 中的 <strong>Host</strong>标签添加</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
      unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
  &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;
         prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;
         pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;

    // 这是新加的
    &lt;Valve className=&quot;org.apache.catalina.valves.ErrorReportValve&quot;
              errorCode.400=&quot;webapps/ROOT/error.jsp&quot;
              errorCode.0=&quot;webapps/ROOT/error.jsp&quot;
              showReport=&quot;false&quot;
              showServerInfo=&quot;false&quot; /&gt;
    // 这是新加的
&lt;/Host&gt;
</code></pre></div><p>上面的 <strong>error.jsp</strong> 放在 <code>webapps/ROOT/</code></p> <ul><li>参考 https://stackoverflow.com/questions/52814582/tomcat-is-not-redirecting-to-400-bad-request-custom-error-page</li> <li>参考 https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Error_Report_Valve</li></ul> <h2 id="_2-gradle-全局设置仓库镜像"><a href="#_2-gradle-全局设置仓库镜像" class="header-anchor">#</a> 2. gradle 全局设置仓库镜像</h2> <p>在 <code>~\.gradle</code> 目录下新建文件 <code>init.gradle</code>, 内容如下</p> <div class="language- extra-class"><pre class="language-text"><code>allprojects {
    repositories {
        mavenLocal()
			maven { name &quot;Alibaba&quot; ; url &quot;https://maven.aliyun.com/repository/public&quot; }
			maven { name &quot;Bstek&quot; ; url &quot;http://nexus.bsdn.org/content/groups/public/&quot; }
    }

	buildscript {
		repositories {
			maven { name &quot;Alibaba&quot; ; url 'https://maven.aliyun.com/repository/public' }
			maven { name &quot;Bstek&quot; ; url 'http://nexus.bsdn.org/content/groups/public/' }
			maven { name &quot;M2&quot; ; url 'https://plugins.gradle.org/m2/' }
		}
	}
}
</code></pre></div><h2 id="_3-apache-org-等网站无法访问"><a href="#_3-apache-org-等网站无法访问" class="header-anchor">#</a> 3. *.apache.org 等网站无法访问</h2> <p>运行命令 <code>ping apache.org</code> 显示 IP 地址为 127.0.0.1</p> <p>原因就是 DNS 出问题了，解决方法就是 <strong>配置网卡的 DNS 为 114.114.114.114</strong></p> <h2 id="_4-inetaddress-gethostname-超时"><a href="#_4-inetaddress-gethostname-超时" class="header-anchor">#</a> 4. InetAddress#getHostName 超时</h2> <p>解决方法，设置 hosts 文件</p> <p>比如 InetAddress 显示的是 <strong>192.168.130.1</strong>， 所以就在 hosts 文件中添加一条记录 (反解析)</p> <div class="language- extra-class"><pre class="language-text"><code>192.168.130.1 192.168.130.1
</code></pre></div><h2 id="_5-nacos-在-tomcat-中无法注册服务"><a href="#_5-nacos-在-tomcat-中无法注册服务" class="header-anchor">#</a> 5. nacos 在 tomcat 中无法注册服务</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosAutoServiceRegistrationWithTomcat</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">NacosAutoServiceRegistration</span> nacosAutoServiceRegistration<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nacosAutoServiceRegistration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		    <span class="token comment">// 重新设置端口</span>
			nacosAutoServiceRegistration<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;server.port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    l<span class="token comment">// 重新注册</span>
			nacosAutoServiceRegistration<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-mysql8-0-第一次安装后-重置密码"><a href="#_6-mysql8-0-第一次安装后-重置密码" class="header-anchor">#</a> 6. mysql8.0 第一次安装后，重置密码</h2> <ol><li>查看临时密码： <code>cat /var/log/mysqld.log | grep password</code></li> <li>登录 mysql, <code>mysql -uroot -p</code>, 输入临时密码</li> <li>设置简单密码，执行下面的命令</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 设置密码长度</span>
<span class="token builtin class-name">set</span> global validate_password.length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token comment"># 设置可以和登录用户名一样</span>
<span class="token builtin class-name">set</span> global validate_password.check_user_name<span class="token operator">=</span>off<span class="token punctuation">;</span>
<span class="token comment"># 简单密码策略</span>
<span class="token builtin class-name">set</span> global validate_password.policy<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>执行命令 <code>ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';</code> 重置密码</li> <li>创建用户， <code>CREATE USER 'root'@'%' IDENTIFIED BY 'root';</code></li> <li>授权，<code>GRANT ALL ON *.* TO 'root'@'%'</code></li></ol> <h2 id="_7-win10-默认没有创建软链接的权限"><a href="#_7-win10-默认没有创建软链接的权限" class="header-anchor">#</a> 7. win10，默认没有创建软链接的权限</h2> <ol><li>在调试<strong>pulsar</strong>，程序需要创建<strong>软链接</strong></li> <li>系统必须要为<strong>专业版</strong>，才会有<strong>策略组</strong>权限设置</li></ol> <p>参考</p> <ol><li><a href="https://jingyan.baidu.com/article/e52e361588a3b501c60c5184.html" target="_blank" rel="noopener noreferrer">百度经验<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-vista/cc766301(v=ws.10)" target="_blank" rel="noopener noreferrer">win10 软连接权限设置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h2 id="_8-搭建-mysql8-0-主从-在同一个机器上"><a href="#_8-搭建-mysql8-0-主从-在同一个机器上" class="header-anchor">#</a> 8. 搭建 mysql8.0 主从， 在同一个机器上</h2> <h3 id="_1-安装-mysql-运行-systemctl-start-mysqld-service"><a href="#_1-安装-mysql-运行-systemctl-start-mysqld-service" class="header-anchor">#</a> 1. 安装 mysql, 运行 <code>systemctl start mysqld.service</code></h3> <h3 id="_2-创建-master-mysql-的配置文件"><a href="#_2-创建-master-mysql-的配置文件" class="header-anchor">#</a> 2. 创建 master mysql 的配置文件</h3> <h4 id="_1-etc-my3307-cnf-文件配置"><a href="#_1-etc-my3307-cnf-文件配置" class="header-anchor">#</a> 1./etc/my3307.cnf 文件配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3307</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/var/lib/mysql3307/mysql.sock

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/var/lib/mysql3307
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/var/lib/mysql3307/mysql.sock

log-error<span class="token operator">=</span>/var/log/mysqld3307.log
pid-file<span class="token operator">=</span>/var/run/mysqld/mysqld3307.pid

default-time_zone <span class="token operator">=</span> <span class="token string">'+8:00'</span>
max_connect_errors <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3307</span>
<span class="token comment"># diable MySQL X plugin</span>
<span class="token assign-left variable">mysqlx</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token comment"># location where binlog is stored </span>
log-bin<span class="token operator">=</span>/var/lib/mysql/binlog3307

<span class="token comment"># server unique id</span>
server-id<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># each write is synchronized with the hard disk</span>
sync-binlog<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># which database is synchronized</span>
binlog-do-db<span class="token operator">=</span>master_slave_test

<span class="token comment"># expire days for binlog</span>
expire-logs-days<span class="token operator">=</span><span class="token number">7</span>

<span class="token comment"># which database is ignored for binlog</span>
binlog-ignore-db<span class="token operator">=</span>information_schema
binlog-ignore-db<span class="token operator">=</span>performation_schema
binlog-ignore-db<span class="token operator">=</span>sys

<span class="token comment"># skip dns resolve</span>
<span class="token comment"># skip-name-resolve</span>


</code></pre></div><h4 id="_2-master-服务器初始化"><a href="#_2-master-服务器初始化" class="header-anchor">#</a> 2. master 服务器初始化</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 初始化, 会创建 dataDir [/var/lib/mysql3307]</span>
mysqld --defaults-file<span class="token operator">=</span>/etc/my3307.cnf --initialize
<span class="token comment">#  以root用户启动mysql -D表示以守护进程启动</span>
mysqld --defaults-file<span class="token operator">=</span>/etc/my3307.cnf --user<span class="token operator">=</span>root -D
<span class="token comment"># 登录，密码在 cat /var/log/mysqld3307.log | grep password 中</span>
mysql --defaults-file<span class="token operator">=</span>/etc/my3307.cnf  -uroot -p
<span class="token comment"># 重置密码</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'root'</span><span class="token punctuation">;</span>
<span class="token comment"># 创建用户` （可选）</span>
CREATE <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'root'</span><span class="token punctuation">;</span>
<span class="token comment"># 授权 (可选 )</span>
GRANT ALL ON *.* TO <span class="token string">'root'</span>@<span class="token string">'%'</span>

<span class="token comment"># 创建同步 binlog 的用户</span>
CREATE <span class="token environment constant">USER</span> <span class="token string">'replicate_user'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'root'</span><span class="token punctuation">;</span>
grant replication slave,replication client on *.* to <span class="token string">'replicate_user'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>
flush privileges<span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-创建-slave-mysql-的配置文件"><a href="#_3-创建-slave-mysql-的配置文件" class="header-anchor">#</a> 3. 创建 slave mysql 的配置文件</h3> <h4 id="_1-etc-my3308-cnf-文件配置"><a href="#_1-etc-my3308-cnf-文件配置" class="header-anchor">#</a> 1. /etc/my3308.cnf 文件配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3308</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/var/lib/mysql3308/mysql.sock

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>

<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/var/lib/mysql3308
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/var/lib/mysql3308/mysql.sock

log-error<span class="token operator">=</span>/var/log/mysqld3308.log
pid-file<span class="token operator">=</span>/var/run/mysqld/mysqld3308.pid

default-time_zone <span class="token operator">=</span> <span class="token string">'+8:00'</span>
max_connect_errors <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3308</span>
<span class="token comment"># diable MySQL X plugin</span>
<span class="token assign-left variable">mysqlx</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token comment"># location where binlog is stored </span>
log-bin<span class="token operator">=</span>/var/lib/mysql/binlog3308

relay-log<span class="token operator">=</span>slave-relay-bin

<span class="token comment"># server unique id</span>
server-id<span class="token operator">=</span><span class="token number">2</span>

read_only <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># slave sync data to binlog</span>
log_slave_updates <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># each write is synchronized with the hard disk</span>
sync-binlog<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># which database is synchronized</span>
replicate-do-db<span class="token operator">=</span>master_slave_test

<span class="token comment"># expire days for binlog</span>
expire-logs-days<span class="token operator">=</span><span class="token number">7</span>

<span class="token comment"># which database is ignored for binlog</span>
binlog-ignore-db<span class="token operator">=</span>information_schema
binlog-ignore-db<span class="token operator">=</span>performation_schema
binlog-ignore-db<span class="token operator">=</span>sys

<span class="token comment"># skip dns resolve</span>
<span class="token comment"># skip-name-resolve</span>
</code></pre></div><h4 id="_2-slave-服务器初始化"><a href="#_2-slave-服务器初始化" class="header-anchor">#</a> 2. slave 服务器初始化</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 初始化, 会创建 dataDir [/var/lib/mysql3308]</span>
mysqld --defaults-file<span class="token operator">=</span>/etc/my3308.cnf --initialize
<span class="token comment">#  以root用户启动mysql -D表示以守护进程启动</span>
mysqld --defaults-file<span class="token operator">=</span>/etc/my3308.cnf --user<span class="token operator">=</span>root -D
<span class="token comment"># 登录，密码在 cat /var/log/mysqld3308.log | grep password 中</span>
mysql --defaults-file<span class="token operator">=</span>/etc/my3308.cnf  -uroot -p
<span class="token comment"># 重置密码</span>
ALTER <span class="token environment constant">USER</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'root'</span><span class="token punctuation">;</span>

<span class="token comment"># 设置master地址， ip, port, user, password, binlogFile, binlogPosition</span>

<span class="token comment"># 获取 binlogFile, binlogPosition，在 master 服务器上执行</span>
show master status<span class="token punctuation">;</span> 

<span class="token comment"># 设置复制位置</span>
change master to <span class="token assign-left variable">master_host</span><span class="token operator">=</span><span class="token string">'192.168.0.119'</span>, <span class="token assign-left variable">master_port</span><span class="token operator">=</span><span class="token number">3307</span>, <span class="token assign-left variable">master_user</span><span class="token operator">=</span><span class="token string">'replicate_user'</span>,  <span class="token assign-left variable">master_password</span><span class="token operator">=</span><span class="token string">'root'</span>, <span class="token assign-left variable">master_log_file</span><span class="token operator">=</span><span class="token string">'binlog3307.000010'</span>, <span class="token assign-left variable">master_log_pos</span><span class="token operator">=</span><span class="token number">3788</span><span class="token punctuation">;</span>
<span class="token comment"># 开启复制</span>
start slave<span class="token punctuation">;</span>
<span class="token comment"># 查询 slave 的状态, 如果显示 Slave_IO_Running: Yes, Slave_SQL_Running: Yes, 就是正常的</span>
show slave status<span class="token punctuation">\</span>G<span class="token punctuation">;</span>

<span class="token comment"># 如有问题，先停掉 slave, 然后重新设置 master 的复制位置</span>
stop slave<span class="token punctuation">;</span>

</code></pre></div><h3 id="_4-问题"><a href="#_4-问题" class="header-anchor">#</a> 4. 问题</h3> <p>在从库上执行 show slave status\G
显示报错：
Authentication plugin 'caching_sha2_password' reported error
考虑到我的MySQL8 ，</p> <p>查看主库：
<code>SELECT plugin FROM</code>user<code>where user = 'replicate_user';</code>
原来是主库repl的plugin是caching_sha2_password 导致连接不上，修改为mysql_native_password即可解决。</p> <p><code>ALTER USER 'replicate_user'@'%' IDENTIFIED WITH mysql_native_password BY 'root';</code></p> <h3 id="_5-参考"><a href="#_5-参考" class="header-anchor">#</a> 5.参考</h3> <blockquote><p><a href="https://dev.mysql.com/doc/refman/8.0/en/server-configuration-defaults.html" target="_blank" rel="noopener noreferrer">mysql8.0 官方配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="_8-oracle-rac-集群-url-设置"><a href="#_8-oracle-rac-集群-url-设置" class="header-anchor">#</a> 8. oracle RAC 集群 url 设置</h2> <p>spring 的 applicaton.yml:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> oracle.jdbc.driver.OracleDriver
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>oracle<span class="token punctuation">:</span>thin<span class="token punctuation">:</span>@(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=host1)(PORT=1521))(ADDRESS=(PROTOCOL=TCP)(HOST=host2)(PORT=1521))(FAILOVER=on)(LOAD_BALANCE=on))(CONNECT_DATA=(SERVICE_NAME=orcl)))
    <span class="token key atrule">username</span><span class="token punctuation">:</span> system
    <span class="token key atrule">password</span><span class="token punctuation">:</span> system
</code></pre></div><h2 id="_9-vmware-的-ip-地址续约时间和静态ip设置"><a href="#_9-vmware-的-ip-地址续约时间和静态ip设置" class="header-anchor">#</a> 9. vmware 的 IP 地址续约时间和静态ip设置</h2> <p>win10 的路径 <code>C:\ProgramData\VMware</code> 中的 <code>vmnetdhcp.leases</code></p> <h2 id="_10-部署-k8s"><a href="#_10-部署-k8s" class="header-anchor">#</a> 10. 部署 k8s</h2> <h3 id="_1-两台机器初始化设置"><a href="#_1-两台机器初始化设置" class="header-anchor">#</a> 1. 两台机器初始化设置</h3> <h4 id="_1-1-hostname-设置"><a href="#_1-1-hostname-设置" class="header-anchor">#</a> 1.1 hostname 设置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>hostnamectl <span class="token comment"># 查看当前的hostname</span>
hostnamectl set-hostname centos1 <span class="token comment"># 设置主机名为centos1, 在 192.168.130.131 上执行</span>
hostnamectl set-hostname centos2 <span class="token comment"># 设置主机名为centos1, 在 192.168.130.132 上执行</span>
</code></pre></div><h4 id="_1-2-etc-hosts-文件-两个机器都需要"><a href="#_1-2-etc-hosts-文件-两个机器都需要" class="header-anchor">#</a> 1.2 /etc/hosts 文件 (两个机器都需要)</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">192.168</span>.1.8 ooooo
<span class="token number">192.168</span>.130.131 centos1 <span class="token comment"># k8s master</span>
<span class="token number">192.168</span>.130.132 centos2 <span class="token comment"># k8s worker</span>
</code></pre></div><h4 id="_1-3-创建非-root-用户-两个机器都需要"><a href="#_1-3-创建非-root-用户-两个机器都需要" class="header-anchor">#</a> 1.3 创建非 root 用户 (两个机器都需要)</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">useradd</span> ooooo -g ooooo  <span class="token comment"># 添加用户，两个机器都执行</span>
<span class="token function">passwd</span> ooooo <span class="token comment"># 修改用户密码，两个机器都执行</span>
</code></pre></div><h4 id="_1-4-添加-yum-代理-两个机器都需要"><a href="#_1-4-添加-yum-代理-两个机器都需要" class="header-anchor">#</a> 1.4 添加 yum 代理 (两个机器都需要)</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">vim</span> /etc/yum.conf <span class="token comment"># 编辑 yum 配置文件</span>
<span class="token assign-left variable">proxy</span><span class="token operator">=</span>http://ooooo:10800 <span class="token comment"># 在文件中添加一行</span>
</code></pre></div><h4 id="_1-5-安装-docker-服务-两个机器都需要"><a href="#_1-5-安装-docker-服务-两个机器都需要" class="header-anchor">#</a> 1.5 安装 docker 服务 (两个机器都需要)</h4> <blockquote><p><a href="https://docs.docker.com/engine/install/centos/" target="_blank" rel="noopener noreferrer">官方 docker 安装文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>参考文档安装 docker

<span class="token function">sudo</span> <span class="token function">vim</span> /etc/docker/daemon.json <span class="token comment"># 编辑 docker 配置文件， 添加下面 json 配置，这是因为 k8s 默认使用的 cgroup driver 是 systemd</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;exec-opts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation">]</span> 
<span class="token punctuation">}</span>

<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now docker.service <span class="token comment"># 设置 docker 服务开机启动，并且现在启动</span>

<span class="token function">sudo</span> systemctl status docker <span class="token comment"># 查看 docker 服务的状态， 失败了，使用下一条命令查看日志</span>

journalctl -xeu docker <span class="token comment"># 查看 docker 日志服务</span>
</code></pre></div><h3 id="_2-k8s-的-kubeadm-安装-两台都需要"><a href="#_2-k8s-的-kubeadm-安装-两台都需要" class="header-anchor">#</a> 2. k8s 的 kubeadm 安装 (两台都需要)</h3> <blockquote><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener noreferrer">官方 k8s 安装文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>参考文档检查服务器的状态是否可以安装 k8s 服务

<span class="token comment"># 关闭 swap 分区</span>
swapoff -a
<span class="token function">sudo</span> <span class="token builtin class-name">echo</span> vm.swappiness<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.con <span class="token comment"># 永久关闭 swap 分区， k8s 不能运行在有 swap 分区的机器上</span>
<span class="token function">free</span> -h <span class="token comment"># 查看 swap 分区是否关闭，显示 0 表示已关闭 </span>

<span class="token comment"># 检查 br_netfilter 是否被加载，没有任何输出，表示没有加载</span>
lsmod <span class="token operator">|</span> <span class="token function">grep</span> br_netfilter 
<span class="token function">sudo</span> modprobe br_netfilter <span class="token comment"># 加载 br_netfilter 模块</span>

<span class="token comment"># 配置网络</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/k8s.conf</span>
br_netfilter
EOF</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/k8s.conf </span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
<span class="token function">sudo</span> sysctl --system

安装容器运行时<span class="token punctuation">(</span>runtime<span class="token punctuation">)</span>,k8s 高版本采用自动检查方式,不用做任何处理

<span class="token comment"># 添加 k8s 镜像仓库，在前面中，设置了 yum 代理</span>
<span class="token comment"># 在官方文档中多了 exclude=kubelet kubeadm kubectl ，这里去掉, 直接安装最新版本的</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo  </span>
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\<span class="token variable">$basearch</span>
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token comment"># 关闭 selinux</span>
<span class="token function">sudo</span> setenforce <span class="token number">0</span> 
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=enforcing$/SELINUX=permissive/'</span> /etc/selinux/config

<span class="token comment"># 安装 k8s 服务, --disableexcludes=kubernetes 表示排除 kubernetes 之外的镜像源</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl --disableexcludes<span class="token operator">=</span>kubernetes

<span class="token comment"># 设置 kubelet 开机启动，并且现在启动</span>
<span class="token comment"># 启动之后可能会报错，如果原因是 没有读取到 kubelet 的配置文件，这里可以不用管，稍后会重启这个服务</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now kubelet
<span class="token function">sudo</span> systemctl status kubelet <span class="token comment"># 查看 kubelet 的状态</span>
journalctl -xeu kubelet <span class="token comment"># 查看 kubelet 的日志</span>
</code></pre></div><h3 id="_3-创建-k8s-集群-两台都需要"><a href="#_3-创建-k8s-集群-两台都需要" class="header-anchor">#</a> 3. 创建 k8s 集群 (两台都需要)</h3> <blockquote><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener noreferrer">创建 k8s 集群官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model" target="_blank" rel="noopener noreferrer">k8s pod network 插件文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 执行 kubeadm init 命令， 在 k8s master 机器上执行，默认情况下， k8s 创建 pod 不会在 master 机器上</span>
<span class="token comment"># 重点注意: --pod-network-cidr=10.244.0.0/16 这个参数必须要有，没有的话安装 cni 会报错</span>
<span class="token comment"># 注意 preflight 的前置检查输出，可能需要添加 docker group，这个会输出有提示的命令</span>
<span class="token function">sudo</span> kubeadm init --image-repository registry.aliyuncs.com/google_containers --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.130.131 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
<span class="token comment"># 执行命令之后，会有 kubeadm join 输出行</span>
<span class="token comment"># （分为 master-token 和 worker-token）， 类似于下面的命令，在 centos2 上执行 worker-join-token 的命令</span>
<span class="token function">sudo</span> kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.130.131:6443 --token 8auvt0.zfw0ayr45d80q8pb <span class="token punctuation">\</span>
	--discovery-token-ca-cert-hash sha256:efe854739efef5fbaf3f6e28c899481c8d7797c1997fc8315b921a9ede400ca8
	
<span class="token comment"># 在机器上执行 kubeadm join 或者 kubeadm init 命令之后，重启 kubelet 服务	</span>
<span class="token function">sudo</span> systemctl restart kubelet
<span class="token function">sudo</span> systemctl status kubelet

<span class="token comment"># 设置 kubectl 的配置文件， 为 $HOME/.kube/config</span>
<span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

<span class="token comment"># 安装 pod network 插件, 这里使用 flannel 插件</span>
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span class="token comment"># 查看 flannel 是否已经启动完成, cni 也启动成功</span>
kubectl get pods -A
<span class="token comment"># 成功之后会有下面的服务， 都是 running 状态</span>
kube-system   coredns-7f6cbbb7b8-5hqt5          <span class="token number">1</span>/1     Running   <span class="token number">15</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h
kube-system   coredns-7f6cbbb7b8-lwdrv          <span class="token number">1</span>/1     Running   <span class="token number">15</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h
kube-system   etcd-centos1                      <span class="token number">1</span>/1     Running   <span class="token number">18</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h
kube-system   kube-apiserver-centos1            <span class="token number">1</span>/1     Running   <span class="token number">25</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h
kube-system   kube-controller-manager-centos1   <span class="token number">1</span>/1     Running   <span class="token number">12</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h
kube-system   kube-flannel-ds-6lx7s             <span class="token number">1</span>/1     Running   <span class="token number">6</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>    21h
kube-system   kube-flannel-ds-n5tfn             <span class="token number">1</span>/1     Running   <span class="token number">6</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>    21h
kube-system   kube-proxy-78jrm                  <span class="token number">1</span>/1     Running   <span class="token number">8</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>    26h
kube-system   kube-proxy-wl5jg                  <span class="token number">1</span>/1     Running   <span class="token number">8</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>    26h
kube-system   kube-scheduler-centos1            <span class="token number">1</span>/1     Running   <span class="token number">16</span> <span class="token punctuation">(</span>76m ago<span class="token punctuation">)</span>   26h

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ooooo-youwillsee/ooooo-notes/edit/master/docs/pages/me/resolution/2021.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/28/2021, 11:45:39 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ooooo-notes/pages/me/resolution/2020.html" class="prev">
        2020 Resolution
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/ooooo-notes/assets/js/app.9e671974.js" defer></script><script src="/ooooo-notes/assets/js/2.b8d058ee.js" defer></script><script src="/ooooo-notes/assets/js/34.a3c3d2e7.js" defer></script>
  </body>
</html>
