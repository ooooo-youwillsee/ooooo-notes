<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、RDB | ooooo-notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="ooooo-notes">
    
    <link rel="preload" href="/ooooo-notes/assets/css/0.styles.3131f072.css" as="style"><link rel="preload" href="/ooooo-notes/assets/js/app.de550cd6.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/2.b8d058ee.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/5.b7a26e17.js" as="script"><link rel="prefetch" href="/ooooo-notes/assets/js/10.070fdfb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/11.84183183.js"><link rel="prefetch" href="/ooooo-notes/assets/js/12.2bb14091.js"><link rel="prefetch" href="/ooooo-notes/assets/js/13.c606973d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/14.053ec6a5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/15.a6e2b4e8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/16.d2a477f0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/17.f10cce45.js"><link rel="prefetch" href="/ooooo-notes/assets/js/18.8bd5e995.js"><link rel="prefetch" href="/ooooo-notes/assets/js/19.fa0def65.js"><link rel="prefetch" href="/ooooo-notes/assets/js/20.296dafb2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/21.dfb4b437.js"><link rel="prefetch" href="/ooooo-notes/assets/js/22.8d7869ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/23.17c06445.js"><link rel="prefetch" href="/ooooo-notes/assets/js/24.4b0856fa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/25.a5e90306.js"><link rel="prefetch" href="/ooooo-notes/assets/js/26.1205d62a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/27.aa8269e5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/28.144d2adb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/29.e375274a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/3.4ee9dae3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/30.8308cc23.js"><link rel="prefetch" href="/ooooo-notes/assets/js/31.11856ff9.js"><link rel="prefetch" href="/ooooo-notes/assets/js/32.59132869.js"><link rel="prefetch" href="/ooooo-notes/assets/js/33.198f1fc2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/34.18716d8a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/35.bd736ae0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/36.ac6dc637.js"><link rel="prefetch" href="/ooooo-notes/assets/js/37.7eaa3c9b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/38.e7662281.js"><link rel="prefetch" href="/ooooo-notes/assets/js/39.b076f2fb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/4.1928a3f2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/40.e4910957.js"><link rel="prefetch" href="/ooooo-notes/assets/js/41.3013a382.js"><link rel="prefetch" href="/ooooo-notes/assets/js/42.29ff3853.js"><link rel="prefetch" href="/ooooo-notes/assets/js/43.0301b7fc.js"><link rel="prefetch" href="/ooooo-notes/assets/js/44.3374adcd.js"><link rel="prefetch" href="/ooooo-notes/assets/js/45.9ae2e70a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/46.c4ea0801.js"><link rel="prefetch" href="/ooooo-notes/assets/js/47.f1f27d2c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/48.884fb3f3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/49.0bc73d0a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/50.c3b6667e.js"><link rel="prefetch" href="/ooooo-notes/assets/js/51.fa771bb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/52.bce5e1f5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/53.6bf43ab0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/54.f3e1ffbf.js"><link rel="prefetch" href="/ooooo-notes/assets/js/55.b5521ee5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/56.4cdd83ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/57.3cdd8c38.js"><link rel="prefetch" href="/ooooo-notes/assets/js/58.07c179d8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/59.bf3b4b01.js"><link rel="prefetch" href="/ooooo-notes/assets/js/6.3385832b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/60.7966b7ff.js"><link rel="prefetch" href="/ooooo-notes/assets/js/7.c63d6270.js"><link rel="prefetch" href="/ooooo-notes/assets/js/8.6e07eb0b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/9.78381cd3.js">
    <link rel="stylesheet" href="/ooooo-notes/assets/css/0.styles.3131f072.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ooooo-notes/" class="home-link router-link-active"><!----> <span class="site-name">ooooo-notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/ooooo-notes/" aria-current="page" class="sidebar-link">Home</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、rdb"><a href="#_1、rdb" class="header-anchor">#</a> 1、RDB</h2> <h3 id="_1、触发机制"><a href="#_1、触发机制" class="header-anchor">#</a> 1、触发机制</h3> <p>手动触发，分别有 <code>save</code> 和 <code>bgsave</code> 两个命令。</p> <ul><li><code>save</code>： 会阻塞当前 Redis 服务器，直到 RDB 过程完成为止，不建议使用。</li> <li><code>bgsave</code>： Redis 进程会 <strong>fork</strong> 出子进程，子进程进行 RDB 持久化，阻塞只会发生在 <strong>fork</strong> 阶段。</li></ul> <p>自动触发的场景：</p> <ul><li><code>save m n</code> 配置，表示在 m 秒中存在 n 次数据改变，才会触发 <code>bgsave</code>。</li> <li>从节点全量复制过程中，主节点会执行 <code>bgsave</code> 生成 RDB 文件，发送子节点。</li> <li>默认关闭情况下，如果没有开启 AOF，也会执行 <code>bgsave</code>。</li></ul> <h3 id="_2、触发流程"><a href="#_2、触发流程" class="header-anchor">#</a> 2、触发流程</h3> <p><code>bgsave</code> 命令的运行流程如下图：
<img src="/ooooo-notes/assets/img/05_01.8af5c142.png" alt="bgsave 执行流程"></p> <p>说明；</p> <ol><li>执行 <code>bgsave</code> 命令， 判断是否有 AOF/RDB 进程。</li> <li>执行 <code>info stats</code> 命令，选项 <code>latest_fork_usec</code> 表示最后一次 fork 使用的秒数。</li> <li><code>bgsave</code> 命令执行完成后，会出现 <strong>Background saving started</strong> 提示。</li> <li>子进程创建 RDB 文件成功后，对原有的文件进行原子替换, 执行 <code>lastsave</code> 命令获取最后一次生成 RDB 文件的时间，对应 <code>info Persistence</code> 命令中的选项 <code>rdb_last_save_time</code>。</li></ol> <h3 id="_3、rdb-文件的处理"><a href="#_3、rdb-文件的处理" class="header-anchor">#</a> 3、RDB 文件的处理</h3> <p><img src="/ooooo-notes/assets/img/05_02.22c52c3e.png" alt="RDB 配置"></p> <ul><li>RDB 文件通过配置文件参数 <code>dbfilename</code> 和 <code>dir</code>来配置，也可以通过命令 <code>config set dir {dir}</code> 和 <code>config set dbfilename {dbfilename}</code> 来动态配置。</li> <li>RDB 文件默认采用 <strong>LZF</strong> 压缩，通常建议开启，因为主从复制时，需要发送 RDB 文件到从节点，这样可以节省带宽。</li> <li>RDB 默认也开启校验，可以通过脚本 <code>redis-check-rdb</code> 来校验生成相应的错误报告。</li></ul> <h3 id="_4、rdb-的优缺点"><a href="#_4、rdb-的优缺点" class="header-anchor">#</a> 4、RDB 的优缺点</h3> <p>优点：</p> <ul><li>RDB 非常适合备份、全量复制等场景，比如每 6 小时定时执行 <code>bgsave</code>，可用于灾难恢复。</li> <li>RDB 的恢复数据远远快于 AOF 方式。</li></ul> <p>缺点：</p> <ul><li>RDB 无法做到秒级持久化，fork 创建子进程也属于重量级操作。</li> <li>RDB 用特定的二进制格式保存，可能有版本不兼容问题。</li></ul> <h2 id="_2、aof"><a href="#_2、aof" class="header-anchor">#</a> 2、AOF</h2> <blockquote><p>以独立的日志记录每次写命令，重启时再重新执行 AOF 文件中的命令达到恢复数据的目的。
AOF 解决了数据持久化的实时性。</p></blockquote> <h3 id="_1、aof-工作流程"><a href="#_1、aof-工作流程" class="header-anchor">#</a> 1、AOF 工作流程</h3> <ul><li>开启 AOF 需要设置参数 <code>appendonly yes</code>。</li> <li>通过参数 <code>appendfilename</code> 来设置文件名。</li></ul> <p><img src="/ooooo-notes/assets/img/05_04.67faeb21.png" alt="AOF 配置"></p> <p>工作流程如下图：
<img src="/ooooo-notes/assets/img/05_03.a62cbfe1.png" alt="AOF 工作流程"></p> <p>说明：</p> <ol><li>所有的写入命令会追加到 aof_buf (缓冲区)中。</li> <li>AOF 缓冲区会根据同步策略（参数默认设置 <code>appendfsync everysec</code>）来做同步操作。</li> <li>会定期对 AOF 文件进行 <strong>rewrite</strong>，达到压缩的目的，因为可能有些 key 过期了。</li> <li>机器重启时，如果开启了 AOF，则使用 AOF 加载数据。</li></ol> <h3 id="_2、命令写入"><a href="#_2、命令写入" class="header-anchor">#</a> 2、命令写入</h3> <ul><li>AOF 采用文本协议格式，也就是说 AOF 文件中存储就是写入的命令，这样具有阅读性、便于修改。</li> <li>AOF 把命令先写入 aof_buf 中，根据不同的同步策略可以在性能和安全上做出平衡，没有特殊要求，就设置为 <code>everysec</code>。</li></ul> <blockquote><p>三种策略；</p> <ol><li>no: don't fsync, just let the OS flush the data when it wants. Faster.</li> <li>always: fsync after every write to the append only log. Slow, Safest.</li> <li>everysec: fsync only one time every second. Compromise.</li></ol></blockquote> <h3 id="_3、重写机制"><a href="#_3、重写机制" class="header-anchor">#</a> 3、重写机制</h3> <p>AOF 文件可以变小的原因：</p> <ul><li>超时的数据，可以不用再写入文件中。</li> <li>key 过期了，可能含有无效命令，如 <code>del key1</code>。</li> <li>多个命令可以合并成一个，如 <code>lpush list a</code> 和 <code>lpush list b</code> 可以合并为 <code>lpush list a b</code>。</li></ul> <p>触发 AOF 重写方式：</p> <ul><li>手动执行命令 <code>bgrewriteaof</code></li> <li>自动触发，根据配置参数 <code>auto-aof-rewrite-percentage 100</code> 和 <code>auto-aof-rewrite-min-size 64mb</code>。</li></ul> <blockquote><p>参数说明：</p> <ol><li>This is how it works: Redis remembers the size of the AOF file after the
latest rewrite (if no rewrite has happened since the restart, the size of
the AOF at startup is used).</li> <li>This base size is compared to the current size. If the current size is
bigger than the specified percentage, the rewrite is triggered. Also
you need to specify a minimal size for the AOF file to be rewritten, this
is useful to avoid rewriting the AOF file even if the percentage increase
is reached but it is still pretty small</li></ol></blockquote> <p><strong>自动触发时机: aof_current_size &gt; auto-aof-rewrite-min-size &amp;&amp; (aof_current_size - aof_base_size) / aof_base_size &gt; auto-aof-rewrite-percentage</strong></p> <p>AOF 重写流程图如下：
<img src="/ooooo-notes/assets/img/05_05.51f3b984.png" alt="AOF 重写流程"></p> <p>说明：</p> <ol><li>执行 AOF 重写请求，如果有子进程在执行 <code>bgsave</code> 则等待完成之后再操作。</li> <li>fork 子进程进行重写，父进程接受请求，修改命令写入 aof_buf 中根据策略同步到磁盘。</li> <li>fork 操作运用写时复制技术，所以子进程只能共享操作 fork 时的内存，这时父进程可能还在响应请求，所以把重写后的新命令放入 <code>aof_rewrite_buf</code> 缓冲区中。</li> <li>把 <code>aof_rewrite_buf</code> 中数据写入新的 AOF 文件中，根据开启参数 <code>aof-rewrite-incremental-fsync yes</code>，每 32MB 同步到磁盘。</li></ol> <h3 id="_4、重启加载"><a href="#_4、重启加载" class="header-anchor">#</a> 4、重启加载</h3> <p>重启加载图：
<img src="/ooooo-notes/assets/img/05_06.71d7585a.png" alt="重启加载图"></p> <h3 id="_5、文件校验"><a href="#_5、文件校验" class="header-anchor">#</a> 5、文件校验</h3> <p>加载损坏的 AOF 文件会拒绝启动，可以先<strong>备份文件</strong>，然后再执行命令 <code>redis-check-aof [--fix] &lt;file.aof&gt;</code> 来进行修复。</p> <h2 id="_3、问题定位与优化"><a href="#_3、问题定位与优化" class="header-anchor">#</a> 3、问题定位与优化</h2> <h3 id="_1、fork-操作"><a href="#_1、fork-操作" class="header-anchor">#</a> 1、fork 操作</h3> <p>Redis 做 RDB 或者 AOF 重写时，必不可少的操作就是 fork。fork 用的写时复制技术，会复制父进程的内存页表。</p> <p>改善 fork操作的耗时：</p> <ol><li>优先使用物理机或者高效支持 fork 操作的虚拟化技术。</li> <li>fork 耗时和内存量成正比，单个 Redis 实例建议不超过 10G。</li> <li>linux 内存分配策略，避免物理内存不足导致 fork 失败。</li> <li>降低 fork 操作频率，比如避免不必要的全量复制，适当放宽 AOF 自动触发时机。</li></ol> <h3 id="_2、子进程开销监控和优化"><a href="#_2、子进程开销监控和优化" class="header-anchor">#</a> 2、子进程开销监控和优化</h3> <ol><li>CPU，子进程负责把内存中的数据写入文件中，属于 IO 密集型操作，不要和其他 IO 密集型服务部署在一起。</li> <li>内存，写时复制技术，避免在大量写入时做子进程重写操作，导致父进程维护大量页副本，造成内存消耗，可以关闭 <strong>THP</strong>。</li> <li>磁盘，AOF 重写会消耗大量磁盘 IO，可以关闭，参数设置为 <code>no-appendfsync-on-rewrite yes</code>，默认是关闭的，但是开启后，可能丢失数据。</li></ol> <h3 id="_3、aof-追加阻塞"><a href="#_3、aof-追加阻塞" class="header-anchor">#</a> 3、AOF 追加阻塞</h3> <p>AOF 持久化，常用的同步策略是 <code>everysec</code>，用于平衡性能和安全性，对于这种方式，Redis 使用另一个线程每秒执行 fsync 同步磁盘，当系统磁盘繁忙时，可能造成 Redis 主进程阻塞。</p> <p><img src="/ooooo-notes/assets/img/05_07.7fd14057.png" alt="AOF 追加阻塞"></p> <h2 id="_4、多实例部署"><a href="#_4、多实例部署" class="header-anchor">#</a> 4、多实例部署</h2> <p>略</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ooooo-youwillsee/ooooo-notes/edit/master/docs/pages/notes/books/redis-development-and-operation-and-maintenance/05.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/24/2021, 7:54:18 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/ooooo-notes/assets/js/app.de550cd6.js" defer></script><script src="/ooooo-notes/assets/js/2.b8d058ee.js" defer></script><script src="/ooooo-notes/assets/js/5.b7a26e17.js" defer></script>
  </body>
</html>
