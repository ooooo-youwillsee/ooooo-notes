<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、更新语句的执行流程 | ooooo-notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="ooooo-notes">
    
    <link rel="preload" href="/ooooo-notes/assets/css/0.styles.3131f072.css" as="style"><link rel="preload" href="/ooooo-notes/assets/js/app.8b13c703.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/2.b8d058ee.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/8.6e07eb0b.js" as="script"><link rel="prefetch" href="/ooooo-notes/assets/js/10.070fdfb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/11.84183183.js"><link rel="prefetch" href="/ooooo-notes/assets/js/12.2bb14091.js"><link rel="prefetch" href="/ooooo-notes/assets/js/13.c606973d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/14.053ec6a5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/15.a6e2b4e8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/16.d2a477f0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/17.f10cce45.js"><link rel="prefetch" href="/ooooo-notes/assets/js/18.8bd5e995.js"><link rel="prefetch" href="/ooooo-notes/assets/js/19.fa0def65.js"><link rel="prefetch" href="/ooooo-notes/assets/js/20.296dafb2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/21.dfb4b437.js"><link rel="prefetch" href="/ooooo-notes/assets/js/22.8d7869ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/23.17c06445.js"><link rel="prefetch" href="/ooooo-notes/assets/js/24.4b0856fa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/25.a5e90306.js"><link rel="prefetch" href="/ooooo-notes/assets/js/26.1205d62a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/27.7718bce8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/28.03270b5d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/29.ad873480.js"><link rel="prefetch" href="/ooooo-notes/assets/js/3.4ee9dae3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/30.7e553840.js"><link rel="prefetch" href="/ooooo-notes/assets/js/31.11856ff9.js"><link rel="prefetch" href="/ooooo-notes/assets/js/32.59132869.js"><link rel="prefetch" href="/ooooo-notes/assets/js/33.04f07159.js"><link rel="prefetch" href="/ooooo-notes/assets/js/34.203c68aa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/35.bd736ae0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/36.ac6dc637.js"><link rel="prefetch" href="/ooooo-notes/assets/js/37.7eaa3c9b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/38.e7662281.js"><link rel="prefetch" href="/ooooo-notes/assets/js/39.b076f2fb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/4.1928a3f2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/40.e4910957.js"><link rel="prefetch" href="/ooooo-notes/assets/js/41.3013a382.js"><link rel="prefetch" href="/ooooo-notes/assets/js/42.29ff3853.js"><link rel="prefetch" href="/ooooo-notes/assets/js/43.0301b7fc.js"><link rel="prefetch" href="/ooooo-notes/assets/js/44.3374adcd.js"><link rel="prefetch" href="/ooooo-notes/assets/js/45.90106767.js"><link rel="prefetch" href="/ooooo-notes/assets/js/46.74f7bbd1.js"><link rel="prefetch" href="/ooooo-notes/assets/js/47.f1f27d2c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/48.b2bcfe7c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/49.0bc73d0a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/5.b7a26e17.js"><link rel="prefetch" href="/ooooo-notes/assets/js/50.c3b6667e.js"><link rel="prefetch" href="/ooooo-notes/assets/js/51.fa771bb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/52.bce5e1f5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/53.6bf43ab0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/54.f3e1ffbf.js"><link rel="prefetch" href="/ooooo-notes/assets/js/55.b5521ee5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/56.4cdd83ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/57.3cdd8c38.js"><link rel="prefetch" href="/ooooo-notes/assets/js/58.07c179d8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/59.bf3b4b01.js"><link rel="prefetch" href="/ooooo-notes/assets/js/6.3385832b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/60.7966b7ff.js"><link rel="prefetch" href="/ooooo-notes/assets/js/7.c63d6270.js"><link rel="prefetch" href="/ooooo-notes/assets/js/9.78381cd3.js">
    <link rel="stylesheet" href="/ooooo-notes/assets/css/0.styles.3131f072.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ooooo-notes/" class="home-link router-link-active"><!----> <span class="site-name">ooooo-notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/ooooo-notes/" aria-current="page" class="sidebar-link">Home</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、更新语句的执行流程"><a href="#_1、更新语句的执行流程" class="header-anchor">#</a> 1、更新语句的执行流程</h2> <p>创建表 T:</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> create table T<span class="token punctuation">(</span>ID int primary key, c int<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将 ID = 2 这一行的值加 1 的 SQL 语句:</p> <div class="language-shell script extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> update T <span class="token builtin class-name">set</span> <span class="token assign-left variable">c</span><span class="token operator">=</span>c+1 where <span class="token assign-left variable">ID</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>查询语句的那一套流程，更新语句也是同样会走一遍。</p> <p><img src="/ooooo-notes/assets/img/01_01.2a326778.png" alt="查询执行流程"></p> <p>经过<strong>连接器</strong>和<strong>查询缓存</strong>之后，<strong>分析器</strong>通过词法和语法分析知道这是一条更新语句，<strong>优化器</strong>决定要使用 ID 这个索引，<strong>执行器</strong>负责具体执行，找到这一行，然后更新。</p> <p>与查询流程不一样的是，更新流程还涉及两个重要的日志模块： **redo log（重做日志）**和 <strong>binlog（归档日志）</strong>。</p> <h2 id="_2、redo-log"><a href="#_2、redo-log" class="header-anchor">#</a> 2、redo log</h2> <p>redo log 是 InnoDB 引擎特有的日志模块。</p> <p>在 MySQL 中，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。为了提高更新效率，MySQL 使用 WAL（Write-Ahead Logging）技术，它的关键点就是先写日志，再写磁盘。</p> <p>当有记录需要更新时，InnoDB 引擎就会先把记录写到 redo log 里面，并更新内存，这时更新就算完成了。同时，InnoDB引擎会在适当的时候（系统比较空闲），将这个记录更新到磁盘里面。</p> <p>InnoDB的 redo log 是固定大小的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么总共可以记录 4GB 的操作。从头开始写，写到末尾又回到开头循环写。</p> <p><img src="/ooooo-notes/assets/img/02_01.bc6cd9db.png" alt="redo log 写"></p> <p>write pos 是当前记录的位置，一边写一边后移。
checkpoint 是当前要擦除的位置，擦除记录前要把记录更新到数据文件。</p> <p>有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为 <strong>crash-safe</strong>。</p> <h2 id="_3、binlog"><a href="#_3、binlog" class="header-anchor">#</a> 3、binlog</h2> <p>binlog 是 Sever 层的日志模块，只能用于归档，比如主从复制。</p> <p>两种日志不同：</p> <ol><li>redo log 是InnoDB引擎特有的；binlog是MySQL的Server层实现的，所有引擎都可以使用。</li> <li>redo log 是物理日志，记录的是“在某个数据页上做了什么修改”；binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1”。</li> <li>redo log 是循环写，写到末尾又回到开头写；binlog是追加写入，写到一定大小后会切换到下一个，并不会覆盖以前的日志。</li></ol> <h2 id="_4、两阶段提交"><a href="#_4、两阶段提交" class="header-anchor">#</a> 4、两阶段提交</h2> <p>上面简单的 updata 语句的执行流程。</p> <p><img src="/ooooo-notes/assets/img/02_02.987957d0.png" alt="update 执行流程"></p> <ol><li><p>执行器先找引擎取 ID = 2 这一行。ID 是主键，引擎直接用树搜索找到这一行。如果ID=2 这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</p></li> <li><p>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</p></li> <li><p>引擎将这行新数据更新到内存中，同时将这个更新操作记录到 redo log 里面，此时 redo log 处于 <code>prepare</code> 状态。然后告知执行器执行完成了，随时可以提交事务。</p></li> <li><p>执行器生成这个操作的 binlog，并把 binlog 写入磁盘。</p></li> <li><p>执行器调用引擎的提交事务接口，引擎把刚刚写入的 redo log 改成 <code>commit</code> 状态，更新完成。</p></li></ol> <p>如果不使用<strong>两阶段提交</strong>，会有什么问题？</p> <ol><li><p>先写 redo log 后写 binlog。假设在 redo log 写完，binlog 还没有写完的时候，MySQL进程异常重启，binlog 中没有更新的数据。</p></li> <li><p>先写 binlog 后写 redo log。如果在 binlog 写完之后 crash，由于 redo log 没有写，崩溃恢复以后这个事务无效，所以这一行 c 的值是 0，但 binlog 中 c = 1 了。</p></li></ol> <h2 id="_5、配置"><a href="#_5、配置" class="header-anchor">#</a> 5、配置</h2> <p>双1设置：</p> <p><code>innodb_flush_log_at_trx_commit = 1</code> 表示每次事务的 redo log 都直接持久化到磁盘。这样可以保证 MySQL 异常重启之后数据不丢失。</p> <p><code>sync_binlog = 1</code> 表示每次事务的 binlog 都持久化到磁盘。这样可以保证 MySQL 异常重启之后 binlog 不丢失。</p> <h2 id="_6、问题"><a href="#_6、问题" class="header-anchor">#</a> 6、问题</h2> <p>在什么场景下，一天一备会比一周一备更有优势呢？</p> <p>好处是“最长恢复时间”更短。</p> <p>在一天一备的模式里，最坏情况下需要应用一天的 binlog。比如，你每天 0 点做一次全量备份，而要恢复出一个到昨天晚上 23 点的备份。</p> <p>一周一备最坏情况就要应用一周的 binlog 了。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ooooo-youwillsee/ooooo-notes/edit/master/docs/pages/notes/geektime/mysql-45/02.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/4/2021, 5:52:08 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/ooooo-notes/assets/js/app.8b13c703.js" defer></script><script src="/ooooo-notes/assets/js/2.b8d058ee.js" defer></script><script src="/ooooo-notes/assets/js/8.6e07eb0b.js" defer></script>
  </body>
</html>
