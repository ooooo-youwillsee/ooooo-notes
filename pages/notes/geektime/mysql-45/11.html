<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、字符串索引 | ooooo-notes</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="ooooo-notes">
    
    <link rel="preload" href="/ooooo-notes/assets/css/0.styles.3131f072.css" as="style"><link rel="preload" href="/ooooo-notes/assets/js/app.fdd8533b.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/2.b8d058ee.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/19.fa0def65.js" as="script"><link rel="preload" href="/ooooo-notes/assets/js/11.84183183.js" as="script"><link rel="prefetch" href="/ooooo-notes/assets/js/10.070fdfb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/12.2bb14091.js"><link rel="prefetch" href="/ooooo-notes/assets/js/13.c606973d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/14.053ec6a5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/15.a6e2b4e8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/16.d2a477f0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/17.f10cce45.js"><link rel="prefetch" href="/ooooo-notes/assets/js/18.8bd5e995.js"><link rel="prefetch" href="/ooooo-notes/assets/js/20.296dafb2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/21.dfb4b437.js"><link rel="prefetch" href="/ooooo-notes/assets/js/22.8d7869ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/23.17c06445.js"><link rel="prefetch" href="/ooooo-notes/assets/js/24.4b0856fa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/25.a5e90306.js"><link rel="prefetch" href="/ooooo-notes/assets/js/26.1205d62a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/27.7718bce8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/28.03270b5d.js"><link rel="prefetch" href="/ooooo-notes/assets/js/29.e375274a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/3.4ee9dae3.js"><link rel="prefetch" href="/ooooo-notes/assets/js/30.160e079f.js"><link rel="prefetch" href="/ooooo-notes/assets/js/31.11856ff9.js"><link rel="prefetch" href="/ooooo-notes/assets/js/32.59132869.js"><link rel="prefetch" href="/ooooo-notes/assets/js/33.198f1fc2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/34.203c68aa.js"><link rel="prefetch" href="/ooooo-notes/assets/js/35.bd736ae0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/36.ac6dc637.js"><link rel="prefetch" href="/ooooo-notes/assets/js/37.7eaa3c9b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/38.e7662281.js"><link rel="prefetch" href="/ooooo-notes/assets/js/39.b076f2fb.js"><link rel="prefetch" href="/ooooo-notes/assets/js/4.1928a3f2.js"><link rel="prefetch" href="/ooooo-notes/assets/js/40.e4910957.js"><link rel="prefetch" href="/ooooo-notes/assets/js/41.3013a382.js"><link rel="prefetch" href="/ooooo-notes/assets/js/42.29ff3853.js"><link rel="prefetch" href="/ooooo-notes/assets/js/43.0301b7fc.js"><link rel="prefetch" href="/ooooo-notes/assets/js/44.3374adcd.js"><link rel="prefetch" href="/ooooo-notes/assets/js/45.9ae2e70a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/46.c4ea0801.js"><link rel="prefetch" href="/ooooo-notes/assets/js/47.f1f27d2c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/48.b2bcfe7c.js"><link rel="prefetch" href="/ooooo-notes/assets/js/49.0bc73d0a.js"><link rel="prefetch" href="/ooooo-notes/assets/js/5.b7a26e17.js"><link rel="prefetch" href="/ooooo-notes/assets/js/50.c3b6667e.js"><link rel="prefetch" href="/ooooo-notes/assets/js/51.fa771bb4.js"><link rel="prefetch" href="/ooooo-notes/assets/js/52.bce5e1f5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/53.6bf43ab0.js"><link rel="prefetch" href="/ooooo-notes/assets/js/54.f3e1ffbf.js"><link rel="prefetch" href="/ooooo-notes/assets/js/55.b5521ee5.js"><link rel="prefetch" href="/ooooo-notes/assets/js/56.4cdd83ee.js"><link rel="prefetch" href="/ooooo-notes/assets/js/57.3cdd8c38.js"><link rel="prefetch" href="/ooooo-notes/assets/js/58.07c179d8.js"><link rel="prefetch" href="/ooooo-notes/assets/js/59.bf3b4b01.js"><link rel="prefetch" href="/ooooo-notes/assets/js/6.3385832b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/60.7966b7ff.js"><link rel="prefetch" href="/ooooo-notes/assets/js/7.c63d6270.js"><link rel="prefetch" href="/ooooo-notes/assets/js/8.6e07eb0b.js"><link rel="prefetch" href="/ooooo-notes/assets/js/9.78381cd3.js">
    <link rel="stylesheet" href="/ooooo-notes/assets/css/0.styles.3131f072.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ooooo-notes/" class="home-link router-link-active"><!----> <span class="site-name">ooooo-notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Me" class="dropdown-title"><span class="title">Me</span> <span class="arrow down"></span></button> <button type="button" aria-label="Me" class="mobile-dropdown-title"><span class="title">Me</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/plan/2021.html" class="nav-link">
  Plan
</a></li><li class="dropdown-item"><!----> <a href="/ooooo-notes/pages/me/resolution/2021.html" class="nav-link">
  Resolution
</a></li></ul></div></div><div class="nav-item"><a href="/ooooo-notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/ooooo-youwillsee/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/ooooo-youwillsee/ooooo-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/ooooo-notes/" aria-current="page" class="sidebar-link">Home</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、字符串索引"><a href="#_1、字符串索引" class="header-anchor">#</a> 1、字符串索引</h2> <p>假设，你现在维护一个支持邮箱登录的系统，用户表是这么定义的</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> create table SUser<span class="token punctuation">(</span>
ID bigint unsigned primary key,
email varchar<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>, 
<span class="token punctuation">..</span>. 
<span class="token punctuation">)</span>engine<span class="token operator">=</span>innodb<span class="token punctuation">;</span> 
</code></pre></div><p>要使用邮箱登录，一定会出现类似下面的语句：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> f1, f2 from SUser where <span class="token assign-left variable">email</span><span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">;</span>
</code></pre></div><p>email 这个字段上没有索引，那么这个语句就只能做全表扫描。</p> <p>MySQL 是支持前缀索引的，你可以定义字符串的一部分作为索引，例如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> alter table SUser <span class="token function">add</span> index index1<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">## 整个字符串</span>
mysql<span class="token operator">&gt;</span> alter table SUser <span class="token function">add</span> index index2<span class="token punctuation">(</span>email<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">))</span><span class="token punctuation">;</span>  <span class="token comment">## 前 6 个字节</span>
</code></pre></div><p>两个索引图差别如下：</p> <p><img src="/ooooo-notes/assets/img/11_01.cb200e79.png" alt="整个字符串"></p> <p><img src="/ooooo-notes/assets/img/11_02.f0e6e6ba.png" alt="前 6 个字节"></p> <p><strong>使用前缀索引的优势，占用的空间会更小，但可能会增加额外的记录扫描次数。</strong></p> <p>例如分析执行语句 <code>select id,name,email from SUser where email='zhangssxyz@xxx.com';</code> 的过程。</p> <ul><li><p>使用 index1 (整个字符串)：
<div data-v-5d130eac><div data-v-5d130eac> </div><div data-v-5d130eac> </div></div>这个过程中，只需要从 index1 索引树找到满足索引值是 ’zhangssxyz@xxx.com’ 的这条记录，再进行<strong>回表</strong>操作，就可以返回结果。</p></li> <li><p>使用 index2 (前 6 个字节)：
<div data-v-5d130eac><div data-v-5d130eac> </div><div data-v-5d130eac> </div></div>这个过程中，需要从 index2 索引树找到满足索引值是 ’zhangs’ 的全部记录，再进行<strong>回表</strong>操作，逐一判断 email 是 ’zhangssxyz@xxx.com’，最后返回结果。可能有大量以 ’zhangs’ 开头的记录， 所以可能会增加额外的记录扫描次数。</p></li></ul> <p><strong>使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。</strong></p> <p>如果建立<strong>前缀索引</strong>，就要关注区分度，区分度越高越好。
可以使用如下语句，统计不同索引的个数：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> count<span class="token punctuation">(</span>distinct email<span class="token punctuation">)</span> as L from SUser<span class="token punctuation">;</span>
</code></pre></div><p>例如，统计 4~7 个字节的前缀索引：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> 
  count<span class="token punctuation">(</span>distinct left<span class="token punctuation">(</span>email,4<span class="token punctuation">)</span>）as L4,
  count<span class="token punctuation">(</span>distinct left<span class="token punctuation">(</span>email,5<span class="token punctuation">)</span>）as L5,
  count<span class="token punctuation">(</span>distinct left<span class="token punctuation">(</span>email,6<span class="token punctuation">)</span>）as L6,
  count<span class="token punctuation">(</span>distinct left<span class="token punctuation">(</span>email,7<span class="token punctuation">)</span>）as L7,
from SUser<span class="token punctuation">;</span>
</code></pre></div><h2 id="_2、其他方式"><a href="#_2、其他方式" class="header-anchor">#</a> 2、其他方式</h2> <p>对于类似于邮箱这样的字段来说，使用前缀索引的效果可能还不错,遇到前缀的区分度不够好的情况时，我们要怎么办呢？</p> <p>例如对身份证号的解决方法。</p> <ul><li><strong>第一种方式是使用倒序存储。</strong></li></ul> <div class="language-shell script extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> field_list from t where id_card <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'input_id_card_string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><strong>第二种方式是使用hash字段</strong></li></ul> <div class="language-shell script extra-class"><pre class="language-shell"><code><span class="token comment">## 添加索引，用来存储 crc32。</span>
mysql<span class="token operator">&gt;</span> alter table t <span class="token function">add</span> id_card_crc int unsigned, <span class="token function">add</span> index<span class="token punctuation">(</span>id_card_crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 查询时判断 crc32 值</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> field_list from t where <span class="token assign-left variable">id_card_crc</span><span class="token operator">=</span>crc32<span class="token punctuation">(</span><span class="token string">'input_id_card_string'</span><span class="token punctuation">)</span> and <span class="token assign-left variable">id_card</span><span class="token operator">=</span><span class="token string">'input_id_card_string'</span>
</code></pre></div><p><strong>它们的相同点是，都不支持范围查询。</strong></p> <h2 id="_3、问题"><a href="#_3、问题" class="header-anchor">#</a> 3、问题</h2> <p>如果你在维护一个学校的学生信息数据库，学生登录名的统一格式是 ”学号@gmail.com&quot;, 而学号的规则是：十五位的数字，其中前三位是所在城市编号、第四到第六位是学校编号、第七位到第十位是入学年份、最后五位是顺序编号。</p> <p>系统登录的时候都需要学生输入登录名和密码，验证正确后才能继续使用系统。就只考虑登录验证这个行为的话，你会怎么设计这个登录名的索引呢？</p> <p>答案：</p> <p>可以只存入学年份加顺序编号，它们的长度是 9 位。如果数字类型来存这 9 位数字。比如 201100001 ，这样只需要占 4 个字节。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ooooo-youwillsee/ooooo-notes/edit/master/docs/pages/notes/geektime/mysql-45/11.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/8/2021, 1:53:41 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/ooooo-notes/assets/js/app.fdd8533b.js" defer></script><script src="/ooooo-notes/assets/js/2.b8d058ee.js" defer></script><script src="/ooooo-notes/assets/js/19.fa0def65.js" defer></script><script src="/ooooo-notes/assets/js/11.84183183.js" defer></script>
  </body>
</html>
