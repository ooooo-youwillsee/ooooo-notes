<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>- 线偶的IT笔记</title><meta name=Description content="线偶的IT笔记"><meta property="og:title" content><meta property="og:description" content="1、RDB 1、触发机制 手动触发，分别有 save 和 bgsave 两个命令。 save： 会阻塞当前 Redis 服务器，直到 RDB 过程完成为止，不建议使用。 bgsave： Redis 进程会 fork"><meta property="og:type" content="article"><meta property="og:url" content="https://ooooo-youwillsee.github.io/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"><meta property="og:image" content="https://ooooo-youwillsee.github.io/logo.png"><meta property="article:section" content="old-notes"><meta property="article:modified_time" content="2022-09-03T20:43:08+08:00"><meta property="og:site_name" content="我的网站"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ooooo-youwillsee.github.io/logo.png"><meta name=twitter:title content><meta name=twitter:description content="1、RDB 1、触发机制 手动触发，分别有 save 和 bgsave 两个命令。 save： 会阻塞当前 Redis 服务器，直到 RDB 过程完成为止，不建议使用。 bgsave： Redis 进程会 fork"><meta name=application-name content="线偶的IT笔记"><meta name=apple-mobile-web-app-title content="线偶的IT笔记"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ooooo-youwillsee.github.io/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/><link rel=prev href=https://ooooo-youwillsee.github.io/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/><link rel=next href=https://ooooo-youwillsee.github.io/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/><link rel=stylesheet href=/ooooo-notes/css/style.min.css><link rel=preload href=/ooooo-notes/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/ooooo-notes/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/ooooo-notes/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/ooooo-notes/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ooooo-youwillsee.github.io\/ooooo-notes\/old-notes\/books\/redis-development-and-operation-and-maintenance\/05\/"},"genre":"old-notes","wordcount":1865,"url":"https:\/\/ooooo-youwillsee.github.io\/ooooo-notes\/old-notes\/books\/redis-development-and-operation-and-maintenance\/05\/","dateModified":"2022-09-03T20:43:08+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"ooooo-youwillsee"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ooooo-notes/ title=线偶的IT笔记><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>线偶</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/ooooo-notes/posts/><i class='fa fa-list' aria-hidden=true></i> 文章 </a><a class=menu-item href=/ooooo-notes/tags/><i class='fa fa-tags' aria-hidden=true></i> 标签 </a><a class=menu-item href=/ooooo-notes/categories/><i class='fa fa-archive' aria-hidden=true></i> 分类 </a><a class=menu-item href=https://github.com/ooooo-youwillsee title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ooooo-notes/ title=线偶的IT笔记><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>线偶</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ooooo-notes/posts/ title><i class='fa fa-list' aria-hidden=true></i>文章</a><a class=menu-item href=/ooooo-notes/tags/ title><i class='fa fa-tags' aria-hidden=true></i>标签</a><a class=menu-item href=/ooooo-notes/categories/ title><i class='fa fa-archive' aria-hidden=true></i>分类</a><a class=menu-item href=https://github.com/ooooo-youwillsee title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster"></h1><div class=content id=content><h2 id=1rdb>1、RDB</h2><h3 id=1触发机制>1、触发机制</h3><p>手动触发，分别有 <code>save</code> 和 <code>bgsave</code> 两个命令。</p><ul><li><code>save</code>： 会阻塞当前 Redis 服务器，直到 RDB 过程完成为止，不建议使用。</li><li><code>bgsave</code>： Redis 进程会 <strong>fork</strong> 出子进程，子进程进行 RDB 持久化，阻塞只会发生在 <strong>fork</strong> 阶段。</li></ul><p>自动触发的场景：</p><ul><li><code>save m n</code> 配置，表示在 m 秒中存在 n 次数据改变，才会触发 <code>bgsave</code>。</li><li>从节点全量复制过程中，主节点会执行 <code>bgsave</code> 生成 RDB 文件，发送子节点。</li><li>默认关闭情况下，如果没有开启 AOF，也会执行 <code>bgsave</code>。</li></ul><h3 id=2触发流程>2、触发流程</h3><p><code>bgsave</code> 命令的运行流程如下图：
<img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_01.png data-srcset="./imgs/05_01.png, ./imgs/05_01.png 1.5x, ./imgs/05_01.png 2x" data-sizes=auto alt=./imgs/05_01.png title="bgsave 执行流程"></p><p>说明；</p><ol><li>执行 <code>bgsave</code> 命令， 判断是否有 AOF/RDB 进程。</li><li>执行 <code>info stats</code> 命令，选项 <code>latest_fork_usec</code> 表示最后一次 fork 使用的秒数。</li><li><code>bgsave</code> 命令执行完成后，会出现 <strong>Background saving started</strong> 提示。</li><li>子进程创建 RDB 文件成功后，对原有的文件进行原子替换, 执行 <code>lastsave</code> 命令获取最后一次生成 RDB 文件的时间，对应 <code>info Persistence</code> 命令中的选项 <code>rdb_last_save_time</code>。</li></ol><h3 id=3rdb-文件的处理>3、RDB 文件的处理</h3><p><img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_02.png data-srcset="./imgs/05_02.png, ./imgs/05_02.png 1.5x, ./imgs/05_02.png 2x" data-sizes=auto alt=./imgs/05_02.png title="RDB 配置"></p><ul><li>RDB 文件通过配置文件参数 <code>dbfilename</code> 和 <code>dir</code>来配置，也可以通过命令 <code>config set dir {dir}</code> 和 <code>config set dbfilename {dbfilename}</code> 来动态配置。</li><li>RDB 文件默认采用 <strong>LZF</strong> 压缩，通常建议开启，因为主从复制时，需要发送 RDB 文件到从节点，这样可以节省带宽。</li><li>RDB 默认也开启校验，可以通过脚本 <code>redis-check-rdb</code> 来校验生成相应的错误报告。</li></ul><h3 id=4rdb-的优缺点>4、RDB 的优缺点</h3><p>优点：</p><ul><li>RDB 非常适合备份、全量复制等场景，比如每 6 小时定时执行 <code>bgsave</code>，可用于灾难恢复。</li><li>RDB 的恢复数据远远快于 AOF 方式。</li></ul><p>缺点：</p><ul><li>RDB 无法做到秒级持久化，fork 创建子进程也属于重量级操作。</li><li>RDB 用特定的二进制格式保存，可能有版本不兼容问题。</li></ul><h2 id=2aof>2、AOF</h2><blockquote><p>以独立的日志记录每次写命令，重启时再重新执行 AOF 文件中的命令达到恢复数据的目的。
AOF 解决了数据持久化的实时性。</p></blockquote><h3 id=1aof-工作流程>1、AOF 工作流程</h3><ul><li>开启 AOF 需要设置参数 <code>appendonly yes</code>。</li><li>通过参数 <code>appendfilename</code> 来设置文件名。</li></ul><p><img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_04.png data-srcset="./imgs/05_04.png, ./imgs/05_04.png 1.5x, ./imgs/05_04.png 2x" data-sizes=auto alt=./imgs/05_04.png title="AOF 配置"></p><p>工作流程如下图：
<img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_03.png data-srcset="./imgs/05_03.png, ./imgs/05_03.png 1.5x, ./imgs/05_03.png 2x" data-sizes=auto alt=./imgs/05_03.png title="AOF 工作流程"></p><p>说明：</p><ol><li>所有的写入命令会追加到 aof_buf (缓冲区)中。</li><li>AOF 缓冲区会根据同步策略（参数默认设置 <code>appendfsync everysec</code>）来做同步操作。</li><li>会定期对 AOF 文件进行 <strong>rewrite</strong>，达到压缩的目的，因为可能有些 key 过期了。</li><li>机器重启时，如果开启了 AOF，则使用 AOF 加载数据。</li></ol><h3 id=2命令写入>2、命令写入</h3><ul><li>AOF 采用文本协议格式，也就是说 AOF 文件中存储就是写入的命令，这样具有阅读性、便于修改。</li><li>AOF 把命令先写入 aof_buf 中，根据不同的同步策略可以在性能和安全上做出平衡，没有特殊要求，就设置为 <code>everysec</code>。</li></ul><blockquote><p>三种策略；</p><ol><li>no: don&rsquo;t fsync, just let the OS flush the data when it wants. Faster.</li><li>always: fsync after every write to the append only log. Slow, Safest.</li><li>everysec: fsync only one time every second. Compromise.</li></ol></blockquote><h3 id=3重写机制>3、重写机制</h3><p>AOF 文件可以变小的原因：</p><ul><li>超时的数据，可以不用再写入文件中。</li><li>key 过期了，可能含有无效命令，如 <code>del key1</code>。</li><li>多个命令可以合并成一个，如 <code>lpush list a</code> 和 <code>lpush list b</code> 可以合并为 <code>lpush list a b</code>。</li></ul><p>触发 AOF 重写方式：</p><ul><li>手动执行命令 <code>bgrewriteaof</code></li><li>自动触发，根据配置参数 <code>auto-aof-rewrite-percentage 100</code> 和 <code>auto-aof-rewrite-min-size 64mb</code>。</li></ul><blockquote><p>参数说明：</p><ol><li>This is how it works: Redis remembers the size of the AOF file after the
latest rewrite (if no rewrite has happened since the restart, the size of
the AOF at startup is used).</li><li>This base size is compared to the current size. If the current size is
bigger than the specified percentage, the rewrite is triggered. Also
you need to specify a minimal size for the AOF file to be rewritten, this
is useful to avoid rewriting the AOF file even if the percentage increase
is reached but it is still pretty small</li></ol></blockquote><p><strong>自动触发时机: aof_current_size > auto-aof-rewrite-min-size && (aof_current_size - aof_base_size) / aof_base_size > auto-aof-rewrite-percentage</strong></p><p>AOF 重写流程图如下：
<img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_05.png data-srcset="./imgs/05_05.png, ./imgs/05_05.png 1.5x, ./imgs/05_05.png 2x" data-sizes=auto alt=./imgs/05_05.png title="AOF 重写流程"></p><p>说明：</p><ol><li>执行 AOF 重写请求，如果有子进程在执行 <code>bgsave</code> 则等待完成之后再操作。</li><li>fork 子进程进行重写，父进程接受请求，修改命令写入 aof_buf 中根据策略同步到磁盘。</li><li>fork 操作运用写时复制技术，所以子进程只能共享操作 fork 时的内存，这时父进程可能还在响应请求，所以把重写后的新命令放入 <code>aof_rewrite_buf</code> 缓冲区中。</li><li>把 <code>aof_rewrite_buf</code> 中数据写入新的 AOF 文件中，根据开启参数 <code>aof-rewrite-incremental-fsync yes</code>，每 32MB 同步到磁盘。</li></ol><h3 id=4重启加载>4、重启加载</h3><p>重启加载图：
<img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_06.png data-srcset="./imgs/05_06.png, ./imgs/05_06.png 1.5x, ./imgs/05_06.png 2x" data-sizes=auto alt=./imgs/05_06.png title=重启加载图></p><h3 id=5文件校验>5、文件校验</h3><p>加载损坏的 AOF 文件会拒绝启动，可以先<strong>备份文件</strong>，然后再执行命令 <code>redis-check-aof [--fix] &lt;file.aof></code> 来进行修复。</p><h2 id=3问题定位与优化>3、问题定位与优化</h2><h3 id=1fork-操作>1、fork 操作</h3><p>Redis 做 RDB 或者 AOF 重写时，必不可少的操作就是 fork。fork 用的写时复制技术，会复制父进程的内存页表。</p><p>改善 fork操作的耗时：</p><ol><li>优先使用物理机或者高效支持 fork 操作的虚拟化技术。</li><li>fork 耗时和内存量成正比，单个 Redis 实例建议不超过 10G。</li><li>linux 内存分配策略，避免物理内存不足导致 fork 失败。</li><li>降低 fork 操作频率，比如避免不必要的全量复制，适当放宽 AOF 自动触发时机。</li></ol><h3 id=2子进程开销监控和优化>2、子进程开销监控和优化</h3><ol><li>CPU，子进程负责把内存中的数据写入文件中，属于 IO 密集型操作，不要和其他 IO 密集型服务部署在一起。</li><li>内存，写时复制技术，避免在大量写入时做子进程重写操作，导致父进程维护大量页副本，造成内存消耗，可以关闭 <strong>THP</strong>。</li><li>磁盘，AOF 重写会消耗大量磁盘 IO，可以关闭，参数设置为 <code>no-appendfsync-on-rewrite yes</code>，默认是关闭的，但是开启后，可能丢失数据。</li></ol><h3 id=3aof-追加阻塞>3、AOF 追加阻塞</h3><p>AOF 持久化，常用的同步策略是 <code>everysec</code>，用于平衡性能和安全性，对于这种方式，Redis 使用另一个线程每秒执行 fsync 同步磁盘，当系统磁盘繁忙时，可能造成 Redis 主进程阻塞。</p><p><img class=lazyload src=/ooooo-notes/svg/loading.min.svg data-src=./imgs/05_07.png data-srcset="./imgs/05_07.png, ./imgs/05_07.png 1.5x, ./imgs/05_07.png 2x" data-sizes=auto alt=./imgs/05_07.png title="AOF 追加阻塞"></p><h2 id=4多实例部署>4、多实例部署</h2><p>略</p></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.113.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/ooooo-youwillsee target=_blank>ooooo-youwillsee</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/ooooo-notes/lib/gitalk/gitalk.min.css><link rel=stylesheet href=/ooooo-notes/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/ooooo-notes/lib/katex/katex.min.css><link rel=stylesheet href=/ooooo-notes/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/ooooo-notes/lib/gitalk/gitalk.min.js></script><script type=text/javascript src=/ooooo-notes/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/ooooo-notes/lib/lunr/lunr.min.js></script><script type=text/javascript src=/ooooo-notes/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/ooooo-notes/lib/twemoji/twemoji.min.js></script><script type=text/javascript src=/ooooo-notes/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/ooooo-notes/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/ooooo-notes/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/ooooo-notes/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/ooooo-notes/lib/sharer/sharer.min.js></script><script type=text/javascript src=/ooooo-notes/lib/katex/katex.min.js></script><script type=text/javascript src=/ooooo-notes/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/ooooo-notes/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/ooooo-notes/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/ooooo-notes/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{gitalk:{admin:["ooooo-youwillsee"],clientID:"9fcbefe148801287b34f",clientSecret:"3833b0f8bda400fb1ea7093446f340821394e501",id:"0001-01-01T00:00:00Z",owner:"ooooo-youwillsee",repo:"ooooo-notes-gitalk",title:""}},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/ooooo-notes/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"},twemoji:!0}</script><script type=text/javascript src=/ooooo-notes/js/theme.min.js></script></body></html>