# 

## 1、MySQL 的基本架构

![MySQL 基本架构图](./imgs/01_01.png)

主要分为**Server层**和**存储引擎层**。

**Server层**包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

**存储引擎层**负责数据的存储和提取。其架构模式是插件式的，支持 `InnoDB` 、 `MyISAM` 、 `Memory` 等多个存储引擎。现在最常用的存储引擎是 `InnoDB` ，它从 MySQL 5.5.5版本开始成为了默认存储引擎。


## 2、查询语句的执行流程

### 1、连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接。

连接命令：

```shell script
mysql -h$ip -P$port -u$user -p
```

如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。

连接完成后，如果你没有后续的动作，这个连接就处于空闲状态（`Sleep`），通过 `show processlist` 命令查看如下：

![show processlist](./imgs/01_02.png)

客户端长时间处于 `Sleep` 状态，连接器就会自动将它断开。由参数 `wait_timeout` 控制的，默认值是8小时。

数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。建立连接的过程通常是比较复杂的，所以尽量使用长连接。

但全部使用长连接后，有些时候 MySQL 占用内存涨得特别快，这是因为 **MySQL 在执行过程中临时使用的内存是管理在连接对象里面的，这些资源会在连接断开的时候才释放**。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。

长连接解决方案：

1. 定期断开长连接.
2. 在 MySQL 5.7 版本后，通过执行 `mysql_reset_connection`来重新初始化连接资源， 无需重新连接和权限认证。

### 2、查询缓存

**只要对一个表更新，这个表上所有的查询缓存都会被清空。** MySQL 8.0 缓存功能已经被删除。

### 3、分析器

对SQL语句做解析，词法分析（`select`、`insert`、`delete`、`update`）、语法分析（语法是否正确）。

### 4、优化器

优化器选择索引。

例如，对于下面的语句，有两种查询逻辑：

```shell script
mysql> select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;
```

- 先从 t1 里面取出 c = 10 的记录的ID值，再根据 ID 值关联到 t2，再判断 t2 里面 d 的值是否等于 20。
- 先从 t2 里面取出 d = 20 的记录的ID值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。

### 5、执行器

先判断查询权限，如果有权限，执行器就会调用存储引擎提供的接口。

## 3、问题

如果你执行 `select * from T where k=1`，报不存在 K 这一列。是在哪个阶段报出来的？

分析器阶段



