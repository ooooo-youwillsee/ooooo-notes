(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{421:function(_,t,v){_.exports=v.p+"assets/img/04_01.64d55953.png"},422:function(_,t,v){_.exports=v.p+"assets/img/04_02.8969d592.png"},423:function(_,t,v){_.exports=v.p+"assets/img/04_03.ba0ac5d0.png"},424:function(_,t,v){_.exports=v.p+"assets/img/04_04.401b3217.png"},505:function(_,t,v){"use strict";v.r(t);var s=v(33),a=Object(s.a)({},(function(){var _=this,t=_._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h2",{attrs:{id:"_1、客户端通信协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、客户端通信协议"}},[_._v("#")]),_._v(" 1、客户端通信协议")]),_._v(" "),t("p",[_._v("Redis 制定了 RESP（redis序列化协议）实现客户端和服务端的正常交互。")]),_._v(" "),t("h3",{attrs:{id:"_1、发送命令格式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、发送命令格式"}},[_._v("#")]),_._v(" 1、发送命令格式")]),_._v(" "),t("p",[_._v("CRLF 为 '\\r\\n'")]),_._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[_._v("*"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("参数数量"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" CRLF\n$"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("参数 "),t("span",{pre:!0,attrs:{class:"token number"}},[_._v("1")]),_._v(" 的字节数量"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" CRLF\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("参数 "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[_._v("1")]),_._v(">")]),_._v(" CRLF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("..")]),_._v(".\n$"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("参数 N 的字节数量"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" CRLF\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("参数 N"),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" CRLF\n")])])]),t("p",[_._v("以 "),t("code",[_._v("set hello world")]),_._v(" 命令为例：")]),_._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[_._v("*3\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[_._v("$3")]),_._v(" \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[_._v("set")]),_._v(" \n"),t("span",{pre:!0,attrs:{class:"token variable"}},[_._v("$5")]),_._v(" \nhello \n"),t("span",{pre:!0,attrs:{class:"token variable"}},[_._v("$5")]),_._v("\nworld\n")])])]),t("h3",{attrs:{id:"_2、返回结果格式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、返回结果格式"}},[_._v("#")]),_._v(" 2、返回结果格式")]),_._v(" "),t("ul",[t("li",[_._v('状态回复，第一个字节为 "+"。如 '),t("code",[_._v("set")])]),_._v(" "),t("li",[_._v('错误回复，第一个字节为 "-"。如 '),t("code",[_._v("错误命令")])]),_._v(" "),t("li",[_._v('整数回复，第一个字节为 ":"。如 '),t("code",[_._v("incr")])]),_._v(" "),t("li",[_._v('字符串回复，第一个字节为 "$"。如 '),t("code",[_._v("get")])]),_._v(" "),t("li",[_._v('多条字符串回复，第一个字节为 "*"。如 '),t("code",[_._v("mget")])])]),_._v(" "),t("h2",{attrs:{id:"_2、java-客户端-jedis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、java-客户端-jedis"}},[_._v("#")]),_._v(" 2、Java 客户端 Jedis")]),_._v(" "),t("p",[_._v("jedis 用的很少了，请参考 "),t("a",{attrs:{href:"https://lettuce.io/",target:"_blank",rel:"noopener noreferrer"}},[_._v("lettuce"),t("OutboundLink")],1),_._v("、"),t("a",{attrs:{href:"https://redisson.org/",target:"_blank",rel:"noopener noreferrer"}},[_._v("redisson"),t("OutboundLink")],1)]),_._v(" "),t("h2",{attrs:{id:"_3、python-客户端-redis-py"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、python-客户端-redis-py"}},[_._v("#")]),_._v(" 3、Python 客户端 redis-py")]),_._v(" "),t("p",[_._v("略")]),_._v(" "),t("h2",{attrs:{id:"_4、客户端管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、客户端管理"}},[_._v("#")]),_._v(" 4、客户端管理")]),_._v(" "),t("h3",{attrs:{id:"_1、客户端-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、客户端-api"}},[_._v("#")]),_._v(" 1、客户端 API")]),_._v(" "),t("h4",{attrs:{id:"_1、client-list"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、client-list"}},[_._v("#")]),_._v(" 1、"),t("code",[_._v("client list")])]),_._v(" "),t("p",[_._v("与 Redis 服务端相连的所有客户端连接信息")]),_._v(" "),t("p",[t("img",{attrs:{src:v(421),alt:"client list"}})]),_._v(" "),t("p",[_._v("说明：")]),_._v(" "),t("ul",[t("li",[_._v("id: 客户端连接唯一标识，递增，但 Redis 重启后重置为 0。")]),_._v(" "),t("li",[_._v("addr: 客户端 IP 和 PORT。")]),_._v(" "),t("li",[_._v("fd: socket 文件描述符，与 "),t("code",[_._v("lsof")]),_._v(" 命令中 fd 是同一个。")]),_._v(" "),t("li",[_._v("name: 客户端名字，与 "),t("code",[_._v("client setName")]),_._v(" 和 "),t("code",[_._v("client getName")]),_._v(" 有关")])]),_._v(" "),t("p",[_._v("Redis 为每个客户端分配了输入缓冲区，它的作用将客户端发送的命令临时保存，Redis 会从输入缓冲区中拉取命令并执行。不受 "),t("code",[_._v("maxmemory")]),_._v(" 参数影响。")]),_._v(" "),t("ul",[t("li",[_._v("qbuf: 客户端的输入缓冲区总容量")]),_._v(" "),t("li",[_._v("qbuf-free: 客户端的输入缓冲区剩余容量")])]),_._v(" "),t("p",[_._v("输入缓冲区过大的原因：")]),_._v(" "),t("ol",[t("li",[_._v("Redis 处理速度跟不上输入缓冲区的输入速度，可能存在 "),t("strong",[_._v("bigKey")]),_._v("。")]),_._v(" "),t("li",[_._v("Redis 发生了阻塞。")])]),_._v(" "),t("p",[_._v("Redis 为每个客户端分配了输出缓冲区，它的作用是保存命令执行的结果返回给客户端。通过配置文件中的 "),t("code",[_._v("client-output-buffer-limit <class> <hard limit> <soft limit> <soft seconds>")]),_._v(" 来配置。不受 "),t("code",[_._v("maxmemory")]),_._v(" 参数影响。")]),_._v(" "),t("ul",[t("li",[_._v("obl: 固定输出缓冲区大小")]),_._v(" "),t("li",[_._v("oll: 动态输出缓冲区大小，当固定缓冲区满了，就会使用动态缓冲区")]),_._v(" "),t("li",[_._v("omem: 输出缓冲区总计的字节数")])]),_._v(" "),t("p",[_._v("其他信息：")]),_._v(" "),t("ul",[t("li",[_._v("age: 已连接的时间")]),_._v(" "),t("li",[_._v("idle: 最近一次空闲时间")]),_._v(" "),t("li",[_._v("flag: S 表示 slave 客户端，N 表示普通客户端，O 表示执行 "),t("code",[_._v("monitor")]),_._v(" 命令的客户端")]),_._v(" "),t("li",[_._v("db: 数据库索引下标")]),_._v(" "),t("li",[_._v("sub/psub: 当前客户端订阅的频道")]),_._v(" "),t("li",[_._v("multi: 当前事务已执行命令个数")])]),_._v(" "),t("p",[_._v("客户端限制 "),t("code",[_._v("maxclients (默认为 1000)")]),_._v(" 和 "),t("code",[_._v("timeout")]),_._v("，通过 "),t("code",[_._v("config set maxclients 10000")]),_._v(" 命令和 "),t("code",[_._v("config set timeout 30")]),_._v(" 命令来设置。")]),_._v(" "),t("p",[_._v("监控缓冲区方法：")]),_._v(" "),t("ul",[t("li",[_._v("定期执行 "),t("code",[_._v("client list")]),_._v(" 命令，收集 qbuf 和 qbuf-free。")]),_._v(" "),t("li",[_._v("执行 "),t("code",[_._v("info clients")]),_._v(" 命令，找到最大的输入缓冲区 "),t("code",[_._v("client_recent_max_input_buffer")])])]),_._v(" "),t("h4",{attrs:{id:"_2、client-getname-setname"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、client-getname-setname"}},[_._v("#")]),_._v(" 2、"),t("code",[_._v("client getName / setName")])]),_._v(" "),t("p",[_._v("给当前客户端设置名字")]),_._v(" "),t("h4",{attrs:{id:"_3、client-kill"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、client-kill"}},[_._v("#")]),_._v(" 3、"),t("code",[_._v("client kill")])]),_._v(" "),t("p",[_._v("杀掉指定 ip 和 port 的客户端")]),_._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[_._v("  client "),t("span",{pre:!0,attrs:{class:"token function"}},[_._v("kill")]),_._v(" ip:port\n")])])]),t("h4",{attrs:{id:"_4、client-pause"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、client-pause"}},[_._v("#")]),_._v(" 4、"),t("code",[_._v("client pause")])]),_._v(" "),t("p",[_._v("阻塞客户端 timeout 毫秒")]),_._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[_._v("  client pause timeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("(")]),_._v("毫秒"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(")")]),_._v("\n")])])]),t("h4",{attrs:{id:"_5、monitor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、monitor"}},[_._v("#")]),_._v(" 5、"),t("code",[_._v("monitor")])]),_._v(" "),t("p",[_._v("监控 Redis 正在执行的命令，如果并发量过大，会造成输出缓冲区暴涨。")]),_._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[_._v("  monitor\n")])])]),t("h3",{attrs:{id:"_2、客户端相关配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、客户端相关配置"}},[_._v("#")]),_._v(" 2、客户端相关配置")]),_._v(" "),t("p",[_._v("客户端的配置如下：\n"),t("img",{attrs:{src:v(422),alt:"客户端的配置"}})]),_._v(" "),t("ul",[t("li",[t("code",[_._v("timeout")]),_._v("： 空闲连接超时时间")]),_._v(" "),t("li",[t("code",[_._v("tcp-keepalive")]),_._v("： 检查死的连接")]),_._v(" "),t("li",[t("code",[_._v("tcp-backlog")]),_._v(":  TCP 连接过后，会将接受的连接放入队列中，"),t("code",[_._v("tcp-backlog")]),_._v(" 就是这个队列的大小。")])]),_._v(" "),t("h3",{attrs:{id:"_3、客户端统计信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、客户端统计信息"}},[_._v("#")]),_._v(" 3、客户端统计信息")]),_._v(" "),t("h4",{attrs:{id:"_1、info-clients"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、info-clients"}},[_._v("#")]),_._v(" 1、"),t("code",[_._v("info clients")])]),_._v(" "),t("p",[_._v("运行命令如下：\n"),t("img",{attrs:{src:v(423),alt:"info clients"}})]),_._v(" "),t("h4",{attrs:{id:"_2、info-stats"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、info-stats"}},[_._v("#")]),_._v(" 2、"),t("code",[_._v("info stats")])]),_._v(" "),t("p",[_._v("运行命令如下：\n"),t("img",{attrs:{src:v(424),alt:"info stats"}})]),_._v(" "),t("p",[_._v("客户端相关的指标")]),_._v(" "),t("ul",[t("li",[_._v("total_connections_received： 总共接受的连接数")]),_._v(" "),t("li",[_._v("rejected_connections： 拒绝的连接数")])]),_._v(" "),t("h2",{attrs:{id:"_5、客户端常见异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、客户端常见异常"}},[_._v("#")]),_._v(" 5、客户端常见异常")]),_._v(" "),t("h3",{attrs:{id:"_1、无法从连接池中获取连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、无法从连接池中获取连接"}},[_._v("#")]),_._v(" 1、无法从连接池中获取连接")]),_._v(" "),t("p",[_._v("可能的原因：")]),_._v(" "),t("ul",[t("li",[_._v("连接池设置过小。")]),_._v(" "),t("li",[_._v("没有正确使用连接池，用过后没有释放。")]),_._v(" "),t("li",[_._v("具体还是要看"),t("strong",[_._v("选用的客户端")]),_._v("，没有连接了是怎么处理的？（是等待还是直接拒接抛出异常）")])]),_._v(" "),t("h3",{attrs:{id:"_2、客户端读写超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、客户端读写超时"}},[_._v("#")]),_._v(" 2、客户端读写超时")]),_._v(" "),t("p",[_._v("可能的原因：")]),_._v(" "),t("ul",[t("li",[_._v("读写超时时间设置短。")]),_._v(" "),t("li",[_._v("命令本身就很慢。")]),_._v(" "),t("li",[_._v("网络不正常。")]),_._v(" "),t("li",[_._v("Redis 阻塞。")])]),_._v(" "),t("h3",{attrs:{id:"_3、客户端连接超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、客户端连接超时"}},[_._v("#")]),_._v(" 3、客户端连接超时")]),_._v(" "),t("p",[_._v("可能的原因：")]),_._v(" "),t("ul",[t("li",[_._v("连接超时时间设置短。")]),_._v(" "),t("li",[_._v("网络不正常。")]),_._v(" "),t("li",[_._v("Redis 发生阻塞，导致 "),t("code",[_._v("tcp-backlog")]),_._v(" 已满。")])]),_._v(" "),t("h3",{attrs:{id:"_4、客户端缓冲区异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、客户端缓冲区异常"}},[_._v("#")]),_._v(" 4、客户端缓冲区异常")]),_._v(" "),t("p",[_._v("可能的原因：")]),_._v(" "),t("ul",[t("li",[_._v("输出缓冲区满，比如用 "),t("code",[_._v("get")]),_._v(" 命令来获取一个"),t("strong",[_._v("bigKey")]),_._v("。")]),_._v(" "),t("li",[_._v("长时间空闲连接被服务端主动断开。")]),_._v(" "),t("li",[_._v("不正常的并发读写，Redis 对象被多个线程并发操作。")])]),_._v(" "),t("h3",{attrs:{id:"_5、lua-脚本执行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、lua-脚本执行"}},[_._v("#")]),_._v(" 5、Lua 脚本执行")]),_._v(" "),t("p",[_._v("可能的原因：")]),_._v(" "),t("ul",[t("li",[_._v("lua 脚本执行时间超过参数 "),t("code",[_._v("lua-time-limit")]),_._v("。")])]),_._v(" "),t("h3",{attrs:{id:"_6、客户端连接数过大"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、客户端连接数过大"}},[_._v("#")]),_._v(" 6、客户端连接数过大")]),_._v(" "),t("p",[_._v("客户端连接数超过 "),t("code",[_._v("maxclients")]),_._v("，新的连接就会被拒绝。")]),_._v(" "),t("p",[_._v("从两个方面来解决：")]),_._v(" "),t("ul",[t("li",[_._v("客户端：通过下线部分应用节点，使 Redis 的连接数降下来，从而继续找其根本原因，或者调整 "),t("code",[_._v("maxclients")]),_._v(" 参数。")]),_._v(" "),t("li",[_._v("服务端：如果 Redis 是高可用模式，可以把"),t("strong",[_._v("当前的节点故障转移")]),_._v("。")])]),_._v(" "),t("h2",{attrs:{id:"_6、客户端案例分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、客户端案例分析"}},[_._v("#")]),_._v(" 6、客户端案例分析")]),_._v(" "),t("h3",{attrs:{id:"_1、redis-内存陡增"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、redis-内存陡增"}},[_._v("#")]),_._v(" 1、Redis 内存陡增")]),_._v(" "),t("p",[t("strong",[_._v("现象")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("服务端：Redis 主节点内存陡增，从节点内存无变化。")]),_._v(" "),t("li",[_._v("客户端：产生 OOM 异常。")])]),_._v(" "),t("p",[t("strong",[_._v("可能的原因")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("确实有大量的写入，通过执行命令 "),t("code",[_._v("dbsize")]),_._v(" 来获取主从节点的键个数。")]),_._v(" "),t("li",[_._v("排查是否由客户端缓冲区应引发的问题，通过执行命令 "),t("code",[_._v("info clients")]),_._v("来查看。")])]),_._v(" "),t("p",[t("strong",[_._v("处理方法")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("通过命令 "),t("code",[_._v('redis-cli info list | grep -v "omemo=0"')]),_._v("， 找到非零的客户端连接，然后 kill 掉。")]),_._v(" "),t("li",[_._v("可能就是运行命令 "),t("code",[_._v("monitor")]),_._v(" 造成的，一般都建议在生厂环境中禁用 "),t("code",[_._v("monitor")]),_._v("。")])]),_._v(" "),t("h3",{attrs:{id:"_2、客户端周期性超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、客户端周期性超时"}},[_._v("#")]),_._v(" 2、客户端周期性超时")]),_._v(" "),t("p",[t("strong",[_._v("现象")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("客户端：客户端周期性超时")]),_._v(" "),t("li",[_._v("服务端：无明显现象，只是一些慢查询。")])]),_._v(" "),t("p",[t("strong",[_._v("可能的原因")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("网络不正常。")]),_._v(" "),t("li",[_._v("执行命令造成慢查询导致的周期性超时。")])]),_._v(" "),t("p",[t("strong",[_._v("处理方法")]),_._v("：")]),_._v(" "),t("ul",[t("li",[_._v("运维层面，监控慢查询，一旦超多阈值，就发出报警。")]),_._v(" "),t("li",[_._v("避免不正确使用命令，如 "),t("code",[_._v("KEYS *")]),_._v("、"),t("code",[_._v("HGETALL key")]),_._v(" 等。")])])])}),[],!1,null,null,null);t.default=a.exports}}]);