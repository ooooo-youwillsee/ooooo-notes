(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{449:function(s,t,_){s.exports=_.p+"assets/img/06_01.11d8d009.png"},535:function(s,t,_){"use strict";_.r(t);var v=_(33),a=Object(v.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1、全局表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、全局表"}},[s._v("#")]),s._v(" 1、全局表")]),s._v(" "),t("blockquote",[t("p",[s._v("根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类。")])]),s._v(" "),t("p",[s._v("MySQL 加全局读锁的命令："),t("code",[s._v("flush tables with read lock;")]),s._v("（FTWRL）, 解锁命令："),t("code",[s._v("unlock tables;")]),s._v("。让整个库处于"),t("strong",[s._v("只读状态")]),s._v("。任何增删改语句都会被阻塞。")]),s._v(" "),t("p",[s._v("全局锁的典型使用场景是，做全库逻辑备份，也就是 select 所有的数据。")]),s._v(" "),t("p",[s._v("对于 "),t("code",[s._v("MyISAM")]),s._v(" 引擎来说，备份只能加全局锁。")]),s._v(" "),t("p",[s._v("对于 "),t("code",[s._v("Innodb")]),s._v(" 引擎来说，可以使用脚本 "),t("code",[s._v("mysqldump")]),s._v("，参数为 "),t("code",[s._v("–-single-transaction")]),s._v("，来启动一个事务，确保拿到一致性视图来备份数据。"),t("strong",[s._v("MyISAM 不支持事务，所以无法用此脚本。")])]),s._v(" "),t("p",[s._v("全库只读，为什么不使用 "),t("code",[s._v("set global readonly=true")]),s._v(" 的方式，主要原因有两点：")]),s._v(" "),t("ul",[t("li",[s._v("在有些系统中，"),t("code",[s._v("readonly")]),s._v(" 会被用来做其他逻辑，比如判断一个库是主库还是备库。")]),s._v(" "),t("li",[s._v("异常处理机制有差异。 执行 "),t("code",[s._v("FTWRL")]),s._v(" 命令后，客户端发生异常断开，MySQL 会自动释放这个全局锁。如果整库处理 "),t("code",[s._v("readonly")]),s._v(" 状态，客户端发生异常，数据库会一直处于 "),t("code",[s._v("readonly")]),s._v(" 状态。")])]),s._v(" "),t("h2",{attrs:{id:"_2、表级锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、表级锁"}},[s._v("#")]),s._v(" 2、表级锁")]),s._v(" "),t("blockquote",[t("p",[s._v("MySQL 里面表级别的锁有两种：一种是"),t("strong",[s._v("表锁")]),s._v("，一种是"),t("strong",[s._v("元数据锁")]),s._v("（meta data lock，MDL)。")])]),s._v(" "),t("p",[s._v("例如：如果在某个线程 A 中执行 "),t("code",[s._v("lock tables t1 read, t2 write;")]),s._v(" 这个语句，则其他线程写 t1 、读写 t2 的语句都会被阻塞。线程 A 执行 "),t("code",[s._v("unlock tables;")]),s._v(" 语句来解锁。")]),s._v(" "),t("p",[s._v("MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。")]),s._v(" "),t("p",[s._v("在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加"),t("strong",[s._v("MDL读锁")]),s._v("；当要对表做结构变更操作的时候，加"),t("strong",[s._v("MDL写锁")]),s._v("。")]),s._v(" "),t("p",[s._v("给一个小表加个字段，导致整个库挂了。\n"),t("img",{attrs:{src:_(449),alt:"MDL锁影响"}})]),s._v(" "),t("ul",[t("li",[s._v("session A 和 session B 都会加上 "),t("strong",[s._v("MDL读锁")]),s._v("。")]),s._v(" "),t("li",[s._v("session C 要变更表结构，必要要加上 "),t("strong",[s._v("MDL写锁")]),s._v("，此时只能阻塞。")]),s._v(" "),t("li",[s._v("session D 申请 "),t("strong",[s._v("MDL读锁")]),s._v(" 就会被 session C 阻塞。")])]),s._v(" "),t("p",[t("strong",[s._v("MDL 锁必须要等整个事务提交后再释放。")])]),s._v(" "),t("p",[s._v("如何安全地给小表加字段？")]),s._v(" "),t("ul",[t("li",[s._v("首先要解决长事务，"),t("strong",[s._v("事务不提交，就会一直占着 MDL锁")]),s._v("。在 MySQL 的 "),t("code",[s._v("information_schema")]),s._v("  库的 "),t("code",[s._v("innodb_trx")]),s._v(" 表中，你可以查到当前执行中的事务。如果你要做 DDL 变更的表刚好有长事务在执行，要考虑先暂停 DDL，或者 kill 掉这个长事务。")]),s._v(" "),t("li",[s._v("如果要变更的表是一个热点表，虽然数据量不大，但是上面的请求很频繁，而你不得不加个字段, kill 可能未必管用，比较理想的机制是，在 "),t("code",[s._v("alter table")]),s._v(" 语句里面设定等待时间，如果在这个等待时间里面能够拿到 "),t("strong",[s._v("MDL写锁")]),s._v(" 最好，拿不到也不要阻塞后面的业务语句，先放弃。之后再通过重试命令重复这个过程。")])]),s._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("ALTER TABLE tbl_name NOWAIT "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("column")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nALTER TABLE tbl_name WAIT N "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("column")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". \n")])])]),t("h2",{attrs:{id:"_3、问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、问题"}},[s._v("#")]),s._v(" 3、问题")]),s._v(" "),t("p",[s._v("备份一般都会在备库上执行，你在用 "),t("code",[s._v("–-single-transaction")]),s._v(" 方法做逻辑备份的过程中，如果主库上的一个小表做了一个DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？")]),s._v(" "),t("p",[s._v("假设这个 DDL 是针对表 t1 的， 这里把备份过程中几个关键的语句列出来：")]),s._v(" "),t("div",{staticClass:"language-shell script extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("Q1:SET "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("SESSION")]),s._v(" TRANSACTION ISOLATION LEVEL REPEATABLE READ"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nQ2:START TRANSACTION  WITH CONSISTENT SNAPSHOT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n/* other tables */\nQ3:SAVEPOINT sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n/* 时刻 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" */\nQ4:show create table "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("t1"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n/* 时刻 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" */\nQ5:SELECT * FROM "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("t1"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n/* 时刻 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" */\nQ6:ROLLBACK TO SAVEPOINT sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n/* 时刻 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" */\n/* other tables */\n")])])]),t("ul",[t("li",[s._v("在备份开始的时候，为了确保RR（可重复读）隔离级别，再设置一次RR隔离级别(Q1);")]),s._v(" "),t("li",[s._v("启动事务(Q2);")]),s._v(" "),t("li",[s._v("设置一个保存点，这个很重要(Q3);")]),s._v(" "),t("li",[s._v("show create 是为了拿到表结构(Q4)，然后正式导数据 （Q5），回滚到"),t("code",[s._v("SAVEPOINT sp")]),s._v("，在这里的作用是释放 t1 的 MDL锁。")])]),s._v(" "),t("p",[s._v("答案如下：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是DDL后的表结构。")])]),s._v(" "),t("li",[t("p",[s._v('如果在"时刻 2"到达，则 Q5 执行的时候表结构被改过，报 Table definition has changed, please retry transaction，现象：mysqldump 终止；')])]),s._v(" "),t("li",[t("p",[s._v('如果在"时刻2"和"时刻3"之间到达，mysqldump 占着 t1 的 MDL读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成。')])]),s._v(" "),t("li",[t("p",[s._v('从"时刻4"开始，mysqldump 释放了 MDL读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。')])])])])}),[],!1,null,null,null);t.default=a.exports}}]);