[{"categories":null,"content":" jdk åŸºäº 8 ç‰ˆæœ¬ åœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ° HashMap, éå¸¸æœ‰å¿…è¦äº†è§£æºç ã€‚ HashMap åŸºäºæ‹‰é“¾æ³•å’Œçº¢é»‘æ ‘æ¥å®ç°ï¼Œå…³äºè¿™ä¸¤ä¸ªç®—æ³•ï¼Œè¿™é‡Œä¸åšè§£é‡Šã€‚ï¼Œ ","date":"2024-04-01","objectID":"/ooooo-notes/03-hashmap/:0:0","tags":["jdk","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"03 HashMap","uri":"/ooooo-notes/03-hashmap/"},{"categories":null,"content":" ä½¿ç”¨æ–¹å¼ public class HashMapTest { @Test void test() { Map\u003cString, String\u003e map = new HashMap\u003c\u003e(); map.put(\"1\", \"a\"); map.put(\"2\", \"b\"); assertThat(map.remove(\"1\")).isEqualTo(\"a\"); assertThat(map.put(\"2\", \"c\")).isEqualTo(\"b\"); assertThat(map.get(\"2\")).isEqualTo(\"c\"); } } ","date":"2024-04-01","objectID":"/ooooo-notes/03-hashmap/:1:0","tags":["jdk","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"03 HashMap","uri":"/ooooo-notes/03-hashmap/"},{"categories":null,"content":" putæºç ä½ç½®: java.util.HashMap#put åœ¨ HashMap ä¸­ï¼Œå…ˆåˆ©ç”¨æ‹‰é“¾æ³•æ¥æ·»åŠ èŠ‚ç‚¹(è¿™é‡Œæ˜¯å°¾æ’æ³•)ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äº 8 äº†ï¼Œå°±ä¼šå°†é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ã€‚ public V put(K key, V value) { // å…ˆè®¡ç®— key çš„ hash å€¼ï¼Œç„¶åå† putVal return putVal(hash(key), key, value, false, true); } // è°ƒç”¨ hashCode static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u003e\u003e\u003e 16); } æºç ä½ç½®: java.util.HashMap#putVal final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) { Node\u003cK,V\u003e[] tab; Node\u003cK,V\u003e p; int n, i; // è®¡ç®— tab çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º 16 if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; if ((p = tab[i = (n - 1) \u0026 hash]) == null) // è¯´æ˜å½“å‰æ¡¶æ²¡æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹ tab[i] = newNode(hash, key, value, null); else { // è¯´æ˜å½“å‰æ¡¶æœ‰èŠ‚ç‚¹, p è¡¨ç¤ºæ¡¶é‡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ Node\u003cK,V\u003e e; K k; if (p.hash == hash \u0026\u0026 ((k = p.key) == key || (key != null \u0026\u0026 key.equals(k)))) // æ‰¾åˆ°èŠ‚ç‚¹äº† e = p; else if (p instanceof TreeNode) // æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­ e = ((TreeNode\u003cK,V\u003e)p).putTreeVal(this, tab, hash, key, value); else { // éå†é“¾è¡¨ for (int binCount = 0; ; ++binCount) { if ((e = p.next) == null) { p.next = newNode(hash, key, value, null); // é“¾è¡¨é•¿åº¦è¾¾åˆ°8ï¼Œä¼šæŠŠé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ if (binCount \u003e= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); break; } // åˆ¤æ–­å½“å‰èŠ‚ç‚¹ if (e.hash == hash \u0026\u0026 ((k = e.key) == key || (key != null \u0026\u0026 key.equals(k)))) break; // è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ p = e; } } // e è¡¨ç¤ºæ—§å€¼ if (e != null) { // existing mapping for key V oldValue = e.value; if (!onlyIfAbsent || oldValue == null) e.value = value; // LinkedHashMap ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³• afterNodeAccess(e); return oldValue; } } // æ ‡è®°ä¿®æ”¹ ++modCount; // åŠ¨æ€æ‰©å®¹ if (++size \u003e threshold) resize(); // LinkedHashMap ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³• afterNodeInsertion(evict); return null; } ","date":"2024-04-01","objectID":"/ooooo-notes/03-hashmap/:2:0","tags":["jdk","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"03 HashMap","uri":"/ooooo-notes/03-hashmap/"},{"categories":null,"content":" remove remove å’Œ put éå¸¸ç±»ä¼¼ï¼Œéƒ½éœ€è¦æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ æºç ä½ç½®: java.util.HashMap#remove(java.lang.Object) public V remove(Object key) { Node\u003cK,V\u003e e; // å…ˆè®¡ç®— key çš„ hash å€¼ï¼Œç„¶å removeNode return (e = removeNode(hash(key), key, null, false, true)) == null ? null : e.value; } æºç ä½ç½®: java.util.HashMap#removeNode final Node\u003cK,V\u003e removeNode(int hash, Object key, Object value, boolean matchValue, boolean movable) { Node\u003cK,V\u003e[] tab; Node\u003cK,V\u003e p; int n, index; // åˆ¤æ–­æ¡¶é‡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨, p è¡¨ç¤ºæ¡¶é‡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ if ((tab = table) != null \u0026\u0026 (n = tab.length) \u003e 0 \u0026\u0026 (p = tab[index = (n - 1) \u0026 hash]) != null) { Node\u003cK,V\u003e node = null, e; K k; V v; if (p.hash == hash \u0026\u0026 ((k = p.key) == key || (key != null \u0026\u0026 key.equals(k)))) // æ‰¾åˆ°äº†èŠ‚ç‚¹ node = p; else if ((e = p.next) != null) { if (p instanceof TreeNode) // ä»çº¢é»‘è‰²ä¸­è·å–èŠ‚ç‚¹ node = ((TreeNode\u003cK,V\u003e)p).getTreeNode(hash, key); else { // éå†é“¾è¡¨è·å–èŠ‚ç‚¹ do { if (e.hash == hash \u0026\u0026 ((k = e.key) == key || (key != null \u0026\u0026 key.equals(k)))) { node = e; break; } p = e; } while ((e = e.next) != null); } } // node è¡¨ç¤ºæ‰¾åˆ°çš„èŠ‚ç‚¹ if (node != null \u0026\u0026 (!matchValue || (v = node.value) == value || (value != null \u0026\u0026 value.equals(v)))) { if (node instanceof TreeNode) // åˆ é™¤çº¢é»‘æ ‘èŠ‚ç‚¹ ((TreeNode\u003cK,V\u003e)node).removeTreeNode(this, tab, movable); else if (node == p) // åˆ é™¤å¤´ç»“ç‚¹ tab[index] = node.next; else // åˆ é™¤é“¾è¡¨èŠ‚ç‚¹ p.next = node.next; // æ ‡è®°ä¿®æ”¹ ++modCount; --size; // LinkedHashMap ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³• afterNodeRemoval(node); return node; } } return null; } ","date":"2024-04-01","objectID":"/ooooo-notes/03-hashmap/:3:0","tags":["jdk","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"03 HashMap","uri":"/ooooo-notes/03-hashmap/"},{"categories":null,"content":" get get å’Œ put éå¸¸ç±»ä¼¼ï¼Œéƒ½éœ€è¦æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ æºç ä½ç½®: java.util.HashMap#get public V get(Object key) { Node\u003cK,V\u003e e; return (e = getNode(hash(key), key)) == null ? null : e.value; } final Node\u003cK,V\u003e getNode(int hash, Object key) { Node\u003cK,V\u003e[] tab; Node\u003cK,V\u003e first, e; int n; K k; // åˆ¤æ–­æ¡¶é‡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œfirst è¡¨ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ if ((tab = table) != null \u0026\u0026 (n = tab.length) \u003e 0 \u0026\u0026 (first = tab[(n - 1) \u0026 hash]) != null) { if (first.hash == hash \u0026\u0026 // always check first node ((k = first.key) == key || (key != null \u0026\u0026 key.equals(k)))) // æ‰¾åˆ°èŠ‚ç‚¹äº† return first; if ((e = first.next) != null) { if (first instanceof TreeNode) // ä»çº¢é»‘æ ‘ä¸­è·å–èŠ‚ç‚¹ return ((TreeNode\u003cK,V\u003e)first).getTreeNode(hash, key); // éå†é“¾è¡¨è·å–èŠ‚ç‚¹ do { if (e.hash == hash \u0026\u0026 ((k = e.key) == key || (key != null \u0026\u0026 key.equals(k)))) return e; } while ((e = e.next) != null); } } return null; } ","date":"2024-04-01","objectID":"/ooooo-notes/03-hashmap/:4:0","tags":["jdk","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"03 HashMap","uri":"/ooooo-notes/03-hashmap/"},{"categories":null,"content":" java çš„çº¿ç¨‹æ± å¯ä»¥å……å½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œæ‰€ä»¥éœ€è¦è‡ªå®šä¹‰å¼€å‘ã€‚ æ»¡è¶³1ï¼šå¯ä»¥æ ¹æ®ä»»åŠ¡æ•°é‡æ¥åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ã€‚ æ»¡è¶³2ï¼šæ”¯æŒé‡å¤æ‰§è¡Œçš„ä»»åŠ¡ã€‚ ","date":"2024-03-24","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/:0:0","tags":["java"],"title":"ä½¿ç”¨æ—¶é—´è½®å’Œçº¿ç¨‹æ± å®ç°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"categories":null,"content":" RepeatTask public class RepeatTask extends AbstractTask { private final long maxDelay; private final TimeUnit timeUnit; public RepeatTask(Runnable runnable, long maxDelay, TimeUnit timeUnit) { super(runnable); this.maxDelay = maxDelay; this.timeUnit = timeUnit; } @Override public void run() { long prevTime = System.currentTimeMillis(); try { super.run(); } finally { long diff = System.currentTimeMillis() - prevTime; diff = Long.max(maxDelay - diff, 0); taskExecutor.schedule(this, diff, timeUnit); } } } é€šè¿‡è®¡ç®—æ‰§è¡Œçš„æ—¶é—´æ¥åˆ¤æ–­ä¸‹ä¸€æ¬¡çš„å»¶æ—¶æ—¶é—´ï¼Œä»è€Œå®ç°é‡å¤æ‰§è¡Œã€‚ ","date":"2024-03-24","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/:1:0","tags":["java"],"title":"ä½¿ç”¨æ—¶é—´è½®å’Œçº¿ç¨‹æ± å®ç°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"categories":null,"content":" DefaultTaskExecutor private final HashedWheelTimer timer; private final ThreadPoolExecutor threadPoolExecutor; private final TaskExecutorPoolSizeAdjuster poolSizeAdjuster; public DefaultTaskExecutor(ThreadPoolExecutor threadPoolExecutor, TaskExecutorPoolSizeAdjuster poolSizeAdjuster) { assert threadPoolExecutor != null; this.timer = new HashedWheelTimer(new DefaultThreadFactory(\"TaskExecutor-Timer\"), 10, TimeUnit.MILLISECONDS, 100, true, -1, threadPoolExecutor); this.threadPoolExecutor = threadPoolExecutor; this.poolSizeAdjuster = poolSizeAdjuster; init(); } private void init() { if (poolSizeAdjuster != null) { submit(new RepeatTask(() -\u003e { int maxPoolSize = poolSizeAdjuster.calctMaximumPoolSize(); threadPoolExecutor.setMaximumPoolSize(maxPoolSize); int corePoolSize = poolSizeAdjuster.calcCorePoolSize(); threadPoolExecutor.setCorePoolSize(corePoolSize); }, 10, TimeUnit.SECONDS)); } } ä½¿ç”¨ HashedWheelTimer æ¥è°ƒåº¦å»¶æ—¶ä»»åŠ¡ã€‚ åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥ TaskExecutorPoolSizeAdjuster æ¥åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°ã€‚ ","date":"2024-03-24","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/:2:0","tags":["java"],"title":"ä½¿ç”¨æ—¶é—´è½®å’Œçº¿ç¨‹æ± å®ç°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"categories":null,"content":" ç¤ºä¾‹ä»£ç demo-task-executor ","date":"2024-03-24","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/:3:0","tags":["java"],"title":"ä½¿ç”¨æ—¶é—´è½®å’Œçº¿ç¨‹æ± å®ç°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå™¨","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E8%BD%AE%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8/"},{"categories":null,"content":" åœ¨ java ä¸­æœ‰å››ç§å¼•ç”¨ç±»å‹ï¼Œåˆ†ä¸ºå¼ºå¼•ç”¨ï¼Œè½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨ï¼Œè™šå¼•ç”¨ï¼Œè¿™é‡Œä»‹ç»å¦‚ä½•ä½¿ç”¨è½¯å¼•ç”¨æ¥å®ç°ä¸€ä¸ªç¼“å­˜ã€‚ ","date":"2024-03-20","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/:0:0","tags":["java"],"title":"å®ç°ä¸€ä¸ªè½¯å¼•ç”¨ç¼“å­˜","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/"},{"categories":null,"content":" å®ç°ä»£ç  public class SoftReferenceCache\u003cK, V\u003e implements Cache\u003cK, V\u003e { private Map\u003cK, SoftValue\u003cV\u003e\u003e map; private ReferenceQueue\u003cV\u003e referenceQueue; public SoftReferenceCache() { this.map = new HashMap\u003c\u003e(); this.referenceQueue = new ReferenceQueue\u003c\u003e(); } @Override public void put(K key, V value) { removeSoftValue(); this.map.put(key, new SoftValue\u003c\u003e(key, value, referenceQueue)); } @Override public V get(K key) { removeSoftValue(); SoftValue\u003cV\u003e softValue = this.map.get(key); return softValue.getValue(); } // è¿™é‡Œæ²¡æœ‰ä½¿ç”¨é¢å¤–çš„çº¿ç¨‹æ¥å®šæ—¶æ‰§è¡Œæ–¹æ³• protected void removeSoftValue() { while (true) { SoftValue\u003cV\u003e softValue = (SoftValue\u003cV\u003e) referenceQueue.poll(); if (softValue == null) { break; } System.out.println(\"remove unnecessary softValue: \" + softValue); map.remove(softValue.getKey()); } } private class SoftValue\u003cV\u003e extends SoftReference\u003cV\u003e { // ä»å¼•ç”¨é˜Ÿåˆ—ä¸­è·å–æ­¤å¯¹è±¡ï¼Œå°±èƒ½çŸ¥é“æ˜¯å“ªä¸ªkeyå’Œvalueè¦å›æ”¶äº†ã€‚ private K key; public SoftValue(K key, V value, ReferenceQueue\u003cV\u003e referenceQueue) { super(value, referenceQueue); this.key = key; } public K getKey() { return key; } public V getValue() { return super.get(); } @Override public String toString() { return \"SoftValue{\" + \"key=\" + key + '}'; } } } ","date":"2024-03-20","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/:1:0","tags":["java"],"title":"å®ç°ä¸€ä¸ªè½¯å¼•ç”¨ç¼“å­˜","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/"},{"categories":null,"content":" æµ‹è¯•ä»£ç  æ³¨æ„: æˆ‘åœ¨ build.gradle æ–‡ä»¶ä¸­æ·»åŠ äº† test çš„ jvm å‚æ•° jvmArgs = [\"-Xmx10m\", â€œ-Xms10mâ€], æ¥æ¨¡æ‹Ÿå†…å­˜ä¸è¶³æ¥è§¦å‘å›æ”¶è½¯å¼•ç”¨ã€‚ @Test void testSoftReferenceCache() { Cache\u003cString, String\u003e cache = new SoftReferenceCache\u003c\u003e(); for (int i = 0; i \u003c 1_000_000; i++) { System.gc(); cache.put(\"key\" + i, \"value\" + i); } for (int i = 0; i \u003c 10; i++) { cache.get(\"key\" + i); } } ","date":"2024-03-20","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/:2:0","tags":["java"],"title":"å®ç°ä¸€ä¸ªè½¯å¼•ç”¨ç¼“å­˜","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/"},{"categories":null,"content":" ç¤ºä¾‹ä»£ç demo-java-soft-reference ","date":"2024-03-20","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/:3:0","tags":["java"],"title":"å®ç°ä¸€ä¸ªè½¯å¼•ç”¨ç¼“å­˜","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%BD%AF%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98/"},{"categories":null,"content":" jdk åŸºäº 8 ç‰ˆæœ¬ åœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ° ArrayList, éå¸¸æœ‰å¿…è¦äº†è§£æºç ã€‚ ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:0:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" ä½¿ç”¨æ–¹å¼ public class ArrayListTest { @Test void test() { List\u003cString\u003e ids = new ArrayList\u003c\u003e(); assertThat(ids.add(\"1\")).isEqualTo(true); assertThat(ids.add(\"2\")).isEqualTo(true); assertThat(ids.add(\"3\")).isEqualTo(true); assertThat(ids.remove(\"2\")).isEqualTo(true); assertThat(ids.set(0, \"4\")).isEqualTo(\"1\"); assertThat(ids.get(0)).isEqualTo(\"4\"); } } ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:1:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" add æ·»åŠ å…ƒç´ åˆ° ArrayList ä¸­ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿï¼Œåˆ™è§¦å‘ newCapacity = oldCapacity + (oldCapacity \u003e\u003e 1)ã€‚ æºç ä½ç½®: java.util.ArrayList#add public boolean add(E e) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ ensureCapacityInternal(size + 1); // Increments modCount!! // å­˜å…¥å…ƒç´  elementData[size++] = e; return true; } æºç ä½ç½®: java.util.ArrayList#ensureCapacityInternal private void ensureCapacityInternal(int minCapacity) { // å…ˆè®¡ç®—å®¹é‡ï¼Œæ‰©å±•å®¹é‡ ensureExplicitCapacity(calculateCapacity(elementData, minCapacity)); } // è®¡ç®—å®¹é‡ï¼Œæœ€å°ä¸º10 (DEFAULT_CAPACITY = 10) private static int calculateCapacity(Object[] elementData, int minCapacity) { if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) { return Math.max(DEFAULT_CAPACITY, minCapacity); } return minCapacity; } æºç ä½ç½®: java.util.ArrayList#ensureExplicitCapacity // ç¡®ä¿å®¹é‡è¶³å¤Ÿ private void ensureExplicitCapacity(int minCapacity) { modCount++; // overflow-conscious code if (minCapacity - elementData.length \u003e 0) // ç©ºé—´ä¸å¤Ÿï¼Œéœ€è¦æ‰©å®¹ grow(minCapacity); } private void grow(int minCapacity) { // overflow-conscious code int oldCapacity = elementData.length; int newCapacity = oldCapacity + (oldCapacity \u003e\u003e 1); // å¤„ç†æº¢å‡ºæƒ…å†µ if (newCapacity - minCapacity \u003c 0) newCapacity = minCapacity; // å¤„ç†æœ€å¤§æƒ…å†µ if (newCapacity - MAX_ARRAY_SIZE \u003e 0) newCapacity = hugeCapacity(minCapacity); // å¤åˆ¶å…ƒç´ åˆ°æ–°æ•°ç»„ä¸­ elementData = Arrays.copyOf(elementData, newCapacity); } ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:2:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" remove åˆ é™¤å…ƒç´ ï¼Œæœ‰ä¸¤ä¸ªé‡è½½ï¼Œä¸€ä¸ªæ˜¯æ ¹æ®å…ƒç´ æ¥åˆ é™¤ï¼Œä¸€ä¸ªæ˜¯æ ¹æ®ä¸‹æ ‡æ¥åˆ é™¤ï¼Œä¸‹é¢ä»¥æ ¹æ®ä¸‹æ ‡æ¥åˆ é™¤è¯´æ˜ æºç ä½ç½®: java.util.ArrayList#remove(int) public E remove(int index) { // ä¸‹æ ‡æ£€æŸ¥ rangeCheck(index); modCount++; // è·å–æ—§å€¼ E oldValue = elementData(index); int numMoved = size - index - 1; if (numMoved \u003e 0) // æŠŠ index+1 ä¹‹åçš„å…ƒç´ ç§»åŠ¨åˆ° index ä½ç½® System.arraycopy(elementData, index+1, elementData, index, numMoved); // gc elementData[--size] = null; // clear to let GC do its work return oldValue; } ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:3:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" set è®¾ç½®å…ƒç´  æºç ä½ç½®: java.util.ArrayList#set public E set(int index, E element) { // ä¸‹æ ‡æ£€æŸ¥ rangeCheck(index); // è·å–æ—§å€¼ E oldValue = elementData(index); // è®¾ç½®æ–°å€¼ elementData[index] = element; return oldValue; } ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:4:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" get è·å–å…ƒç´  æºç ä½ç½®: java.util.ArrayList#get public E get(int index) { // ä¸‹æ ‡æ£€æŸ¥ rangeCheck(index); // è·å–æ—§å€¼ return elementData(index); } ","date":"2024-03-18","objectID":"/ooooo-notes/01-arraylist/:5:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"01 ArrayList","uri":"/ooooo-notes/01-arraylist/"},{"categories":null,"content":" jdk åŸºäº 8 ç‰ˆæœ¬ åœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ° LinkedList, éå¸¸æœ‰å¿…è¦äº†è§£æºç ã€‚ ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:0:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" ä½¿ç”¨æ–¹å¼ public class LinkedListTest { @Test void test() { List\u003cString\u003e ids = new LinkedList\u003c\u003e(); assertThat(ids.add(\"1\")).isEqualTo(true); assertThat(ids.add(\"2\")).isEqualTo(true); assertThat(ids.add(\"3\")).isEqualTo(true); assertThat(ids.remove(\"2\")).isEqualTo(true); assertThat(ids.set(0, \"4\")).isEqualTo(\"1\"); assertThat(ids.get(0)).isEqualTo(\"4\"); } } ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:1:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" add æ·»åŠ å…ƒç´  æºç ä½ç½®: java.util.LinkedList#add(E) public boolean add(E e) { // æ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ linkLast(e); return true; } void linkLast(E e) { final Node\u003cE\u003e l = last; // æ–°å»ºèŠ‚ç‚¹ final Node\u003cE\u003e newNode = new Node\u003c\u003e(l, e, null); // å°¾ç»“ç‚¹ä¸ºæ–°èŠ‚ç‚¹ last = newNode; if (l == null) first = newNode; else // æ—§å°¾ç»“ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹ l.next = newNode; size++; modCount++; } ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:2:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" remove åˆ é™¤å…ƒç´ ï¼Œæœ‰ä¸¤ä¸ªé‡è½½ï¼Œä¸€ä¸ªæ˜¯æ ¹æ®å…ƒç´ æ¥åˆ é™¤ï¼Œä¸€ä¸ªæ˜¯æ ¹æ®ä¸‹æ ‡æ¥åˆ é™¤ï¼Œä¸‹é¢ä»¥æ ¹æ®ä¸‹æ ‡æ¥åˆ é™¤è¯´æ˜ æºç ä½ç½®: java.util.LinkedList#remove(int) public E remove(int index) { // ä¸‹æ ‡æ£€æŸ¥ checkElementIndex(index); // å…ˆæŸ¥æ‰¾ä¸‹æ ‡å¯¹åº”çš„èŠ‚ç‚¹ï¼Œç„¶ååˆ é™¤ return unlink(node(index)); } æºç ä½ç½®: java.util.LinkedList#node // è·å–ä¸‹æ ‡å¯¹åº”çš„èŠ‚ç‚¹ Node\u003cE\u003e node(int index) { // åˆ¤æ–­æ˜¯å¦ä»å¤´ç»“ç‚¹å¼€å§‹æŸ¥æ‰¾ if (index \u003c (size \u003e\u003e 1)) { Node\u003cE\u003e x = first; for (int i = 0; i \u003c index; i++) x = x.next; return x; } else { Node\u003cE\u003e x = last; for (int i = size - 1; i \u003e index; i--) x = x.prev; return x; } } æºç ä½ç½®: java.util.LinkedList#unlink // åˆ é™¤èŠ‚ç‚¹ E unlink(Node\u003cE\u003e x) { // assert x != null; final E element = x.item; // è·å–åç»§èŠ‚ç‚¹ final Node\u003cE\u003e next = x.next; // è·å–å‰é©±èŠ‚ç‚¹ final Node\u003cE\u003e prev = x.prev; // è¿æ¥å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹ if (prev == null) { first = next; } else { prev.next = next; x.prev = null; } if (next == null) { last = prev; } else { next.prev = prev; x.next = null; } x.item = null; size--; modCount++; return element; } ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:3:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" set è®¾ç½®å…ƒç´  æºç ä½ç½®: java.util.LinkedList#set public E set(int index, E element) { // ä¸‹æ ‡æ£€æŸ¥ checkElementIndex(index); // æ‰¾åˆ°å¯¹åº”ä¸‹æ ‡çš„èŠ‚ç‚¹, åœ¨ remove æ–¹æ³•ä¸­å·²è§£æ Node\u003cE\u003e x = node(index); E oldVal = x.item; // èµ‹å€¼ x.item = element; return oldVal; } ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:4:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" getæºç ä½ç½®: java.util.LinkedList#get public E get(int index) { // ä¸‹æ ‡æ£€æŸ¥ checkElementIndex(index); // æ‰¾åˆ°å¯¹åº”ä¸‹æ ‡çš„èŠ‚ç‚¹, åœ¨ remove æ–¹æ³•ä¸­å·²è§£æ return node(index).item; } ","date":"2024-03-18","objectID":"/ooooo-notes/02-linkedlist/:5:0","tags":["java","source code","æºç åˆ†æ jdk ç³»åˆ—"],"title":"02 LinkedList","uri":"/ooooo-notes/02-linkedlist/"},{"categories":null,"content":" ä»Šå¤©å¥½å¤šäººThere are many people on the subway ","date":"2024-03-06","objectID":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/:1:0","tags":["english","è‹±è¯­æ—¥å¸¸å¯¹è¯"],"title":"è‹±è¯­æ—¥å¸¸å¯¹è¯","uri":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/"},{"categories":null,"content":" åœ°é“è¦ç­‰å¥½ä¹…Itâ€™s a long wait for the subway. ","date":"2024-03-06","objectID":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/:2:0","tags":["english","è‹±è¯­æ—¥å¸¸å¯¹è¯"],"title":"è‹±è¯­æ—¥å¸¸å¯¹è¯","uri":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/"},{"categories":null,"content":" ä¸­åˆä¸çŸ¥é“åƒå•¥I donâ€™t know what to eat for lunch. ","date":"2024-03-06","objectID":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/:3:0","tags":["english","è‹±è¯­æ—¥å¸¸å¯¹è¯"],"title":"è‹±è¯­æ—¥å¸¸å¯¹è¯","uri":"/ooooo-notes/%E8%8B%B1%E8%AF%AD%E6%97%A5%E5%B8%B8%E5%AF%B9%E8%AF%9D/"},{"categories":null,"content":" åªè¦æ¶‰åŠåˆ°æ•°æ®åº“æ“ä½œï¼Œå¿…å®šå°±ä¼šä½¿ç”¨ @Transactional æ³¨è§£ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå±æ€§å°±æ˜¯ propagation(ä¼ æ’­ç±»å‹)ï¼ŒæŒæ¡å®ƒçš„ç”¨æ³•å¾ˆé‡è¦ã€‚æ¼”ç¤ºä»£ç è§æœ«å°¾ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:0:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" æ¼”ç¤ºäº‹åŠ¡ä¼ æ’­","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" åŸºç¡€ä»£ç  å®šä¹‰äº†æ‰€æœ‰çš„ä¼ æ’­ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ¥æ§åˆ¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸ã€‚ @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.REQUIRES_NEW) public void REQUIRES_NEW(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.NESTED) public void NESTED(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.NOT_SUPPORTED) public void NOT_SUPPORTED(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.SUPPORTS) public void SUPPORTS(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.NEVER) public void NEVER(User user, boolean throwException) { insertUser(user, throwException); } @Transactional(propagation = Propagation.MANDATORY) public void MANDATORY(User user, boolean throwException) { insertUser(user, throwException); } ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:1","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_REQUIRED @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_REQUIRED() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.REQUIRED(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¸ä¼šæ’å…¥æ•°æ®, ä¼šæŠ›å‡ºå¼‚å¸¸ åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ REQUIRED, æ‰€ä»¥ä¼šå…±ç”¨ä¹‹å‰çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™æ ·ä¸¤æ¬¡è°ƒç”¨æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦å›æ»šï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ï¼Œå¯¼è‡´äº‹åŠ¡çŠ¶æ€å†²çªã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:2","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_REQUIRES_NEW @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_REQUIRES_NEW() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.REQUIRES_NEW(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¼šæ’å…¥ 111 æ•°æ® åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ REQUIRES_NEW, æ‰€ä»¥ä¼šåˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™æ ·ä¸¤æ¬¡è°ƒç”¨ä¸æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦å›æ»šï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:3","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_NESTED @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_NESTED() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.NESTED(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¼šæ’å…¥ 111 æ•°æ® åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ NESTED, æ‰€ä»¥ä¼šè®¾ç½®ä¿å­˜ç‚¹ï¼Œè¿™æ ·ä¸¤æ¬¡è°ƒç”¨æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦å›æ»šåˆ°ä¿å­˜ç‚¹ï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:4","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_NOT_SUPPORTED @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_NOT_SUPPORTED() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.NOT_SUPPORTED(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¼šæ’å…¥ 111 æ•°æ®, 222 æ•°æ® åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ NOT_SUPPORTED, æ‰€ä»¥ä¼šæŒ‚èµ·äº‹åŠ¡ï¼Œè¿™æ ·åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ˜¯æœ‰äº‹åŠ¡ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œå› ä¸ºæ²¡æœ‰äº‹åŠ¡ï¼Œæ‰€ä»¥ä¸ä¼šå›æ»šï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:5","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_SUPPORTS @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_SUPPORTS() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.SUPPORTS(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¸ä¼šæ’å…¥æ•°æ®, ä¼šæŠ›å‡ºå¼‚å¸¸ åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ SUPPORTS, æ‰€ä»¥ä¼šå…±ç”¨ä¹‹å‰çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™æ ·ä¸¤æ¬¡è°ƒç”¨æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦å›æ»šï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ï¼Œå¯¼è‡´äº‹åŠ¡çŠ¶æ€å†²çªã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:6","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_NEVER @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_NEVER() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.NEVER(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¼šæ’å…¥ 111 æ•°æ® åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ NEVER, æ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ä¸ä¼šç»§ç»­æ‰§è¡Œä»£ç ã€‚ ç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:7","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" REQUIRED_MANDATORY @Transactional(propagation = Propagation.REQUIRED) public void REQUIRED_MANDATORY() { serviceA.REQUIRED(new User(\"111\"), false); try { serviceA.MANDATORY(new User(\"222\"), true); } catch (Exception ignored) { } } ç»“è®ºï¼šä¸ä¼šæ’å…¥æ•°æ®, ä¼šæŠ›å‡ºå¼‚å¸¸ åˆ†æï¼šç¬¬ä¸€æ¬¡è°ƒç”¨åˆ›å»ºæ–°çš„äº‹åŠ¡çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å› ä¸ºæ˜¯ REQUIRED, æ‰€ä»¥ä¼šå…±ç”¨ä¹‹å‰çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™æ ·ä¸¤æ¬¡è°ƒç”¨æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦å›æ»šï¼Œè€Œç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰å¼‚å¸¸ï¼Œäº‹åŠ¡çŠ¶æ€è¦æäº¤ï¼Œå¯¼è‡´äº‹åŠ¡çŠ¶æ€å†²çªã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:1:8","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" äº‹åŠ¡ä¼ æ’­åŸç†æºç ä½ç½®: org.springframework.transaction.support.AbstractPlatformTransactionManager#getTransaction // æ¯ä¸€ä¸ª @Transactional éƒ½ä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•ï¼Œæ¥è·å–äº‹åŠ¡çŠ¶æ€ public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException { ... // è·å–å½“å‰äº‹åŠ¡ Object transaction = doGetTransaction(); // åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å­˜åœ¨ if (isExistingTransaction(transaction)) { // é‡ç‚¹è§£æ return handleExistingTransaction(def, transaction, debugEnabled); } // ä¸‹é¢æ˜¯ä¸å­˜åœ¨äº‹åŠ¡çš„æƒ…å†µ if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) { throw new IllegalTransactionStateException( \"No existing transaction found for transaction marked with propagation 'mandatory'\"); } else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) { SuspendedResourcesHolder suspendedResources = suspend(null); ... try { // å¼€å¯æ–°çš„äº‹åŠ¡ return startTransaction(def, transaction, debugEnabled, suspendedResources); } catch (RuntimeException | Error ex) { resume(null, suspendedResources); throw ex; } } else { ... // ä¸å¼€å§‹äº‹åŠ¡ return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null); } } æºç ä½ç½®: org.springframework.transaction.support.AbstractPlatformTransactionManager#handleExistingTransaction private TransactionStatus handleExistingTransaction( TransactionDefinition definition, Object transaction, boolean debugEnabled) throws TransactionException { // ä¸‹é¢æ˜¯å­˜åœ¨äº‹åŠ¡çš„æƒ…å†µ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) { throw new IllegalTransactionStateException( \"Existing transaction found for transaction marked with propagation 'never'\"); } if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) { ... // æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œä»¥éäº‹åŠ¡æ¥æ‰§è¡Œ Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); return prepareTransactionStatus( definition, null, false, newSynchronization, debugEnabled, suspendedResources); } if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) { ... // æŒ‚èµ·å½“å‰äº‹åŠ¡ SuspendedResourcesHolder suspendedResources = suspend(transaction); try { // å¼€å¯æ–°äº‹åŠ¡ return startTransaction(definition, transaction, debugEnabled, suspendedResources); } catch (RuntimeException | Error beginEx) { resumeAfterBeginException(transaction, suspendedResources, beginEx); throw beginEx; } } if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) { ... if (useSavepointForNestedTransaction()) { ... DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); // åœ¨å½“å‰äº‹åŠ¡ä¸Šï¼Œåˆ›å»ºä¿å­˜ç‚¹ status.createAndHoldSavepoint(); return status; } else { // ä¸æ”¯æŒä¿å­˜ç‚¹ï¼Œå°±å¼€å¯æ–°äº‹åŠ¡ return startTransaction(definition, transaction, debugEnabled, null); } } ... // ç»§ç»­ä½¿ç”¨å½“å‰äº‹åŠ¡ return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null); } è¯´æ˜ï¼šåœ¨ startTransaction æ–¹æ³•ä¸­ï¼Œæ¯æ¬¡éƒ½ä¼šè·å–æ–°è¿æ¥æ¥å¼€å¯äº‹åŠ¡ã€‚ ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:2:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" ä»£ç demo-spring-transaction-propagation ","date":"2024-02-23","objectID":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/:3:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"äº‹åŠ¡ä¼ æ’­ç±»å‹","uri":"/ooooo-notes/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%B1%BB%E5%9E%8B/"},{"categories":null,"content":" å½“æˆ‘ä»¬ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œå¿…å®šä¼šé‡åˆ°ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åœ¨è¯»å†™è¯·æ±‚è¿‡ç¨‹ä¸­æ•°æ®åº“å’Œç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚ ä¸‹é¢å°†åˆ†æä¸ºä»€ä¹ˆä¼šé€ æˆä¸ä¸€è‡´, æ‰€æœ‰çš„ä»£ç å‚è€ƒæœ«å°¾ã€‚ ","date":"2024-01-07","objectID":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/:0:0","tags":["cache"],"title":"ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜","uri":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåæ›´æ–°ç¼“å­˜ æ•°æ®åº“çš„å€¼é»˜è®¤ä¸º 0 è¯»æ“ä½œï¼š public String get(Long id) { // ä»ç¼“å­˜ä¸­åŠ è½½ String userName = userCache.queryUserNameById(id); if (userName == null) { // ä»æ•°æ®åº“ä¸­åŠ è½½ userName = userDB.queryUserNameById(id); // è®¾ç½®åˆ°ç¼“å­˜ä¸­ TestUtil.sleep(200); // è¡¨ç¤º gcï¼Œè¯·æ±‚å»¶è¿Ÿ userCache.setUserNameById(id, userName); } return userName; } å†™æ“ä½œï¼š public void set(Long id, String username) { // æ›´æ–°æ•°æ®åº“ TestUtil.sleep(100); // è¡¨ç¤º gc, è¯·æ±‚å»¶è¿Ÿ userDB.setUserNameById(id, username); // æ›´æ–°ç¼“å­˜ userCache.setUserNameById(id, null); } å®é™…æ‰§è¡Œè¿‡ç¨‹: è¯»æ“ä½œï¼ˆä»ç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œå‘ç°ä¸ºç©ºï¼Œæ‰€ä»¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå¾—åˆ° 0ï¼‰ å†™æ“ä½œï¼ˆæ›´æ–°æ•°æ®åº“å€¼ä¸º 1ï¼Œåˆ é™¤ç¼“å­˜å€¼ï¼‰ è¯»æ“ä½œï¼ˆæ›´æ–°ç¼“å­˜å€¼ä¸º 0ï¼‰ ä¸ä¸€è‡´ï¼ˆæ•°æ®åº“å€¼ä¸º 1ï¼Œç¼“å­˜å€¼ä¸º 0ï¼‰ ä»ä¸Šé¢å¯ä»¥åˆ†æï¼Œæ›´æ–°æ•°æ®åº“å’Œæ›´æ–°ç¼“å­˜çš„é¡ºåºï¼Œæ— è®ºè°å…ˆè°åéƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚ ","date":"2024-01-07","objectID":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/:1:0","tags":["cache"],"title":"ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜","uri":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" åŒæ—¶æ›´æ–°æ•°æ®å†™æ“ä½œï¼ˆAï¼‰ï¼š // username = 1 public void set1(Long id, String username) { // æ›´æ–°ç¼“å­˜ TestUtil.sleep(100); userCache.setUserNameById(id, username); // æ›´æ–°æ•°æ®åº“ userDB.setUserNameById(id, username); } å†™æ“ä½œï¼ˆBï¼‰ï¼š // username = 2 public void set2(Long id, String username) { // æ›´æ–°ç¼“å­˜ userCache.setUserNameById(id, username); // æ›´æ–°æ•°æ®åº“ TestUtil.sleep(200); userDB.setUserNameById(id, username); } å®é™…æ‰§è¡Œè¿‡ç¨‹ï¼š Bï¼ˆæ›´æ–°ç¼“å­˜å€¼ä¸º 2ï¼‰ Aï¼ˆæ›´æ–°ç¼“å­˜å€¼ä¸º 1ï¼Œæ›´æ–°æ•°æ®åº“å€¼ä¸º 1ï¼‰ Bï¼ˆæ›´æ–°æ•°æ®åº“å€¼ä¸º 2ï¼‰ ä¸ä¸€è‡´ï¼ˆæ•°æ®åº“å€¼ä¸º 2ï¼Œç¼“å­˜å€¼ä¸º 1ï¼‰ ä»ä¸Šé¢å¯ä»¥åˆ†æï¼Œæ›´æ–°æ•°æ®åº“å’Œæ›´æ–°ç¼“å­˜çš„é¡ºåºï¼Œæ— è®ºè°å…ˆè°åéƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚ ","date":"2024-01-07","objectID":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/:2:0","tags":["cache"],"title":"ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜","uri":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" è§£å†³æ–¹æ³• ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥ç¡®ä¿æ›´æ–°æ•°æ®åº“å’Œæ›´æ–°ç¼“å­˜æ˜¯åŸå­æ€§ã€‚ ","date":"2024-01-07","objectID":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/:3:0","tags":["cache"],"title":"ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜","uri":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" ä»£ç demo-cache-consistency-question ","date":"2024-01-07","objectID":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/:4:0","tags":["cache"],"title":"ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜","uri":"/ooooo-notes/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" åœ¨ servlet 3.0 çš„è§„èŒƒä¸­ï¼Œæœ‰å¼‚æ­¥servletç‰¹æ€§ï¼Œè¿™ä¸ªå¯ä»¥å¢å¤§ååé‡ã€‚æˆ‘ä»¬æœ‰å¿…è¦çœ‹çœ‹ spring æ˜¯å¦‚ä½•é€‚é…è¿™ä¸ªç‰¹æ€§çš„ã€‚ ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:0:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" å®ç°å¼‚æ­¥ servletåœ¨ spring mvc ä¸­ï¼Œå®ç°å¼‚æ­¥servletæœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚ DeferredResultã€Callableï¼Œç›¸å…³ä»£ç è§æœ«å°¾ã€‚ ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:1:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" DeferredResult æ–¹å¼ @GetMapping(\"/test2\") public DeferredResult\u003cString\u003e test2() { before(); DeferredResult\u003cString\u003e result = new DeferredResult\u003c\u003e(); executor.submit(() -\u003e { process(); result.setResult(\"test2\"); }); after(); return result; } ç›¸å…³æ—¥å¿—: deferredResult-log ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:1:1","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" Callable æ–¹å¼ @GetMapping(\"/test4\") public Callable\u003cString\u003e test4() { before(); Callable\u003cString\u003e callable = () -\u003e { process(); return \"test4\"; }; after(); return callable; } ç›¸å…³æ—¥å¿—: callable-log ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:1:2","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" æºç è§£è¯» åœ¨ spring ä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ HandlerMethodReturnValueHandlerï¼Œä¸“é—¨æ¥å¤„ç†è¯·æ±‚çš„è¿”å›å€¼ã€‚ ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:2:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" å¤„ç† DeferredResultæºç ä½ç½®: org.springframework.web.servlet.mvc.method.annotation.DeferredResultMethodReturnValueHandler public class DeferredResultMethodReturnValueHandler implements HandlerMethodReturnValueHandler { @Override public boolean supportsReturnType(MethodParameter returnType) { // åˆ¤æ–­ç±»å‹ Class\u003c?\u003e type = returnType.getParameterType(); return (DeferredResult.class.isAssignableFrom(type) || ListenableFuture.class.isAssignableFrom(type) || CompletionStage.class.isAssignableFrom(type)); } @Override public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception { ... DeferredResult\u003c?\u003e result; if (returnValue instanceof DeferredResult) { result = (DeferredResult\u003c?\u003e) returnValue; } else if (returnValue instanceof ListenableFuture) { result = adaptListenableFuture((ListenableFuture\u003c?\u003e) returnValue); } else if (returnValue instanceof CompletionStage) { result = adaptCompletionStage((CompletionStage\u003c?\u003e) returnValue); } else { // Should not happen... throw new IllegalStateException(\"Unexpected return value type: \" + returnValue); } // å¼€å§‹å¼‚æ­¥å¤„ç† WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(result, mavContainer); } } ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:2:1","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" å¤„ç† Callableæºç ä½ç½®: org.springframework.web.servlet.mvc.method.annotation.CallableMethodReturnValueHandler public class CallableMethodReturnValueHandler implements HandlerMethodReturnValueHandler { @Override public boolean supportsReturnType(MethodParameter returnType) { // åˆ¤æ–­ç±»å‹ return Callable.class.isAssignableFrom(returnType.getParameterType()); } @Override public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception { ... Callable\u003c?\u003e callable = (Callable\u003c?\u003e) returnValue; // å¼€å§‹å¼‚æ­¥å¤„ç† WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer); } } ä»ä¸Šé¢ä¸¤ä¸ªç±»å¯ä»¥çœ‹å‡ºï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº† WebAsyncManager ç±»çš„ startDeferredResultProcessing æˆ–è€… startCallableProcessing æ–¹æ³•ï¼Œ è¿™ä¸¤ä¸ªæ–¹æ³•çš„å†…éƒ¨å®ç°éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œä¸‹é¢ä»¥ startCallableProcessing ä¸ºä¾‹ã€‚ ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:2:2","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" WebAsyncManageræºç ä½ç½®: org.springframework.web.context.request.async.WebAsyncManager#startCallableProcessing public void startCallableProcessing(final WebAsyncTask\u003c?\u003e webAsyncTask, Object... processingContext) throws Exception { ... List\u003cCallableProcessingInterceptor\u003e interceptors = new ArrayList\u003c\u003e(); interceptors.add(webAsyncTask.getInterceptor()); interceptors.addAll(this.callableInterceptors.values()); interceptors.add(timeoutCallableInterceptor); final Callable\u003c?\u003e callable = webAsyncTask.getCallable(); final CallableInterceptorChain interceptorChain = new CallableInterceptorChain(interceptors); // è®¾ç½®è¶…æ—¶å¤„ç†å™¨ this.asyncWebRequest.addTimeoutHandler(() -\u003e { if (logger.isDebugEnabled()) { logger.debug(\"Async request timeout for \" + formatRequestUri()); } Object result = interceptorChain.triggerAfterTimeout(this.asyncWebRequest, callable); if (result != CallableProcessingInterceptor.RESULT_NONE) { setConcurrentResultAndDispatch(result); } }); // è®¾ç½®é”™è¯¯å¤„ç† this.asyncWebRequest.addErrorHandler(ex -\u003e { if (!this.errorHandlingInProgress) { if (logger.isDebugEnabled()) { logger.debug(\"Async request error for \" + formatRequestUri() + \": \" + ex); } Object result = interceptorChain.triggerAfterError(this.asyncWebRequest, callable, ex); result = (result != CallableProcessingInterceptor.RESULT_NONE ? result : ex); setConcurrentResultAndDispatch(result); } }); // è®¾ç½®å®Œæˆå¤„ç†å™¨ this.asyncWebRequest.addCompletionHandler(() -\u003e interceptorChain.triggerAfterCompletion(this.asyncWebRequest, callable)); // æ‰§è¡Œé’©å­ interceptorChain.applyBeforeConcurrentHandling(this.asyncWebRequest, callable); // å¼€å¯å¼‚æ­¥å¤„ç†ï¼Œå°±æ˜¯ request#startAsync (servlet api) startAsyncProcessing(processingContext); try { Future\u003c?\u003e future = this.taskExecutor.submit(() -\u003e { Object result = null; try { // æ‰§è¡Œé’©å­ applyPreProcess interceptorChain.applyPreProcess(this.asyncWebRequest, callable); // å¤„ç†è¯·æ±‚ result = callable.call(); } catch (Throwable ex) { result = ex; } finally { // æ‰§è¡Œé’©å­ applyPostProcess result = interceptorChain.applyPostProcess(this.asyncWebRequest, callable, result); } // è®¾ç½®ç»“æœ, ç„¶å dispatch, å½“å‰è¿™ä¸ªè¯·æ±‚å°±ä¼šå†æ¬¡å¤„ç†ï¼Œä¼šè¢« RequestMappingHandlerAdapter#invokeHandlerMethod æ‹¦æˆª setConcurrentResultAndDispatch(result); }); interceptorChain.setTaskFuture(future); } catch (RejectedExecutionException ex) { Object result = interceptorChain.applyPostProcess(this.asyncWebRequest, callable, ex); setConcurrentResultAndDispatch(result); throw ex; } } æºç ä½ç½®: org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter#invokeHandlerMethod protected ModelAndView invokeHandlerMethod(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod) throws Exception { ... WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request); // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚æ­¥ç»“æœ if (asyncManager.hasConcurrentResult()) { Object result = asyncManager.getConcurrentResult(); mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0]; asyncManager.clearConcurrentResult(); // è¿™é‡Œä¼šè¿”å›ä¸€ä¸ªæ–°çš„ handlerMethod, è¿™ä¸ªå¾ˆé‡è¦ invocableMethod = invocableMethod.wrapConcurrentResult(result); } // è¿”å› json invocableMethod.invokeAndHandle(webRequest, mavContainer); if (asyncManager.isConcurrentHandlingStarted()) { return null; } // å¯¹äº json è¯·æ±‚æ¥è¯´ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œ return getModelAndView(mavContainer, modelFactory, webRequest); } finally { webRequest.requestCompleted(); } } ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:2:3","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" task çº¿ç¨‹æ± Callable çš„æ‰§è¡Œï¼Œéœ€è¦çº¿ç¨‹æ± ï¼Œé»˜è®¤é…ç½®ç±»å¦‚ä¸‹: æºç ä½ç½®: org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration @Lazy @Bean(name = { APPLICATION_TASK_EXECUTOR_BEAN_NAME, AsyncAnnotationBeanPostProcessor.DEFAULT_TASK_EXECUTOR_BEAN_NAME }) @ConditionalOnMissingBean(Executor.class) public ThreadPoolTaskExecutor applicationTaskExecutor(TaskExecutorBuilder builder) { return builder.build(); } ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:2:4","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" ä»£ç demo-spring-async-servlet ","date":"2024-01-06","objectID":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/:3:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å¼‚æ­¥ servlet åŸç†","uri":"/ooooo-notes/%E5%BC%82%E6%AD%A5-servlet-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" â­• è¿›è¡Œä¸­ âœ… å·²å®Œæˆ âŒ å·²åºŸå¼ƒ â“ æœ‰å¿…è¦ â— é‡è¦æ€§ ğŸ“ è®°ç¬”è®° ğŸ–Šï¸ å†™ä»£ç  ","date":"2024-01-01","objectID":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/:0:0","tags":["learning"],"title":"2024å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1. å…³äºé˜…è¯»0ï¸âƒ£1ï¸âƒ£. ã€Šæ“ä½œç³»ç»Ÿå¯¼è®ºã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåŸä¹¦ç¬¬3ç‰ˆï¼‰ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€ŠMySQLæŠ€æœ¯å†…å¹•ã€‹ â­• 0ï¸âƒ£4ï¸âƒ£. ã€ŠRocketMQæŠ€æœ¯å†…å¹• ç¬¬äºŒç‰ˆã€‹ â­• 0ï¸âƒ£5ï¸âƒ£. ã€ŠVimå®ç”¨æŠ€å·§ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ â­• 0ï¸âƒ£6ï¸âƒ£. ã€ŠCå’ŒæŒ‡é’ˆã€‹ âœ… 0ï¸âƒ£7ï¸âƒ£. ã€ŠCä¸“å®¶ç¼–ç¨‹ã€‹ 0ï¸âƒ£8ï¸âƒ£. ã€ŠCé™·é˜±ä¸ç¼ºé™·ã€‹ 0ï¸âƒ£9ï¸âƒ£. Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾ â­• 1ï¸âƒ£0ï¸âƒ£. é•¿å®‰çš„è”æ âœ… 1ï¸âƒ£1ï¸âƒ£. x86æ±‡ç¼–è¯­è¨€ï¼ˆç¬¬2ç‰ˆï¼‰ 1ï¸âƒ£2ï¸âƒ£. Rustå®æˆ˜ â­• 1ï¸âƒ£3ï¸âƒ£. æœŸè´§åŠè¡ç”Ÿå“åŸºç¡€ï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ â­• ","date":"2024-01-01","objectID":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/:1:0","tags":["learning"],"title":"2024å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2. å…³äºæºç ç¬”è®°0ï¸âƒ£1ï¸âƒ£. ã€Šrocketmq æºç ã€‹ â­• 0ï¸âƒ£2ï¸âƒ£. ã€Šdubbo æºç ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šgrpc-go æºç ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šspring boot æºç ã€‹ â­• 0ï¸âƒ£5ï¸âƒ£. ã€Šnetty æºç ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€Štomcat æºç ã€‹ ","date":"2024-01-01","objectID":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/:2:0","tags":["learning"],"title":"2024å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2024%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ å¦‚æœæˆ‘ä»¬å°† dubbo åº”ç”¨éƒ¨ç½²åœ¨ k8s ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ k8s ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚ ","date":"2023-12-25","objectID":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"13 é›†æˆ k8s","uri":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/"},{"categories":null,"content":" æœåŠ¡è°ƒç”¨æµç¨‹ provider ä½¿ç”¨ KubernetesServiceDiscovery#doRegister æ³¨å†ŒæœåŠ¡å®ä¾‹ï¼Œå…ƒæ•°æ®ä¿¡æ¯ä¼šå­˜æ”¾åœ¨ pod å¯¹è±¡ä¸Š. consumer ä½¿ç”¨ ServiceNameMapping#getMapping æ¥è·å– consumerUrl å¯¹åº”çš„ serviceName. consumer ä½¿ç”¨ KubernetesServiceDiscovery#getInstances æ¥è·å– serviceName å¯¹åº”çš„æœåŠ¡å®ä¾‹. è·å–çš„æœåŠ¡å®ä¾‹ä¸Šé¢å°±ä¼šæœ‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œç„¶åå°±ä¼šä½¿ç”¨å…ƒæ•°æ®ä¿¡æ¯æ¥è·å–æœåŠ¡å®ä¾‹çš„æ‰€æœ‰ url åˆ—è¡¨. æ ¹æ®è¿™äº› url åˆ—è¡¨æ¥åˆ›å»ºå¯¹åº”çš„ invokerï¼Œæ¯”å¦‚ DubboInvoker, TripleInvoker. ","date":"2023-12-25","objectID":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"13 é›†æˆ k8s","uri":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/"},{"categories":null,"content":" KubernetesServiceDiscovery#doRegister æ³¨å†Œå®ä¾‹æºç ä½ç½®: org.apache.dubbo.registry.kubernetes.KubernetesServiceDiscovery#KubernetesServiceDiscovery // KubernetesServiceDiscovery æ„é€ æ–¹æ³• public KubernetesServiceDiscovery(ApplicationModel applicationModel, URL registryURL) { super(applicationModel, registryURL); Config config = KubernetesConfigUtils.createKubernetesConfig(registryURL); // åˆå§‹åŒ– k8s client this.kubernetesClient = new KubernetesClientBuilder().withConfig(config).build(); // HostName ä¸€èˆ¬é»˜è®¤å°±æ˜¯ podName this.currentHostname = System.getenv(\"HOSTNAME\"); this.registryURL = registryURL; this.namespace = config.getNamespace(); // é»˜è®¤éœ€è¦æ³¨å†Œ this.enableRegister = registryURL.getParameter(KubernetesClientConst.ENABLE_REGISTER, true); boolean availableAccess; try { // æ£€æŸ¥ k8s æ˜¯å¦å¯ç”¨ availableAccess = kubernetesClient.pods().withName(currentHostname).get() != null; } catch (Throwable e) { availableAccess = false; } if (!availableAccess) { ... } else { // todo æš‚æ—¶ä¸è§£æ KubernetesMeshEnvListener.injectKubernetesEnv(kubernetesClient, namespace); } } æºç ä½ç½®: org.apache.dubbo.registry.kubernetes.KubernetesServiceDiscovery#doRegister // æ³¨å†Œå®ä¾‹ @Override public void doRegister(ServiceInstance serviceInstance) throws RuntimeException { if (enableRegister) { kubernetesClient .pods() .inNamespace(namespace) // é€‰æ‹©å½“å‰ pod .withName(currentHostname) .edit(pod -\u003e new PodBuilder(pod) .editOrNewMetadata() // æ·»åŠ åˆ°æ³¨è§£ .addToAnnotations(KUBERNETES_PROPERTIES_KEY, JsonUtils.toJson(serviceInstance.getMetadata())) .endMetadata() .build()); if (logger.isInfoEnabled()) { logger.info(\"Write Current Service Instance Metadata to Kubernetes pod. \" + \"Current pod name: \" + currentHostname); } } } æºç ä½ç½®: org.apache.dubbo.registry.kubernetes.KubernetesServiceDiscovery#doUpdate // å®ä¾‹ä¿¡æ¯æ”¹å˜ä¹‹åï¼Œé‡æ–°æ³¨å†Œ @Override public void doUpdate(ServiceInstance oldServiceInstance, ServiceInstance newServiceInstance) throws RuntimeException { reportMetadata(newServiceInstance.getServiceMetadata()); this.doRegister(newServiceInstance); } ","date":"2023-12-25","objectID":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"13 é›†æˆ k8s","uri":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/"},{"categories":null,"content":" KubernetesServiceDiscovery#getInstances è·å–å®ä¾‹æºç ä½ç½®: org.apache.dubbo.registry.kubernetes.KubernetesServiceDiscovery#getInstances @Override public List\u003cServiceInstance\u003e getInstances(String serviceName) throws NullPointerException { Endpoints endpoints = null; // ä» informer ä¸­è·å– SharedIndexInformer\u003cEndpoints\u003e endInformer = ENDPOINTS_INFORMER.get(serviceName); if (endInformer != null) { // get endpoints directly from informer local store List\u003cEndpoints\u003e endpointsList = endInformer.getStore().list(); if (endpointsList.size() \u003e 0) { endpoints = endpointsList.get(0); } } if (endpoints == null) { // ç›´æ¥è·å– endpoints = kubernetesClient .endpoints() .inNamespace(namespace) .withName(serviceName) .get(); } // æ ¹æ® k8s çš„ endpoint æ¥è·å– return toServiceInstance(endpoints, serviceName); } æºç ä½ç½®: org.apache.dubbo.registry.kubernetes.KubernetesServiceDiscovery#toServiceInstance // æ–¹æ³•çš„é€»è¾‘ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰çš„ pod å’Œ endpointï¼Œä»¥ endpoint ä¸ºå‡†ï¼Œç„¶åå¯¹æ¯”ï¼ŒæŒ‘é€‰å‡ºå¯ç”¨çš„ podï¼Œæœ€ç»ˆåŒ…è£…ä¸º serviceInstance private List\u003cServiceInstance\u003e toServiceInstance(Endpoints endpoints, String serviceName) { Map\u003cString, String\u003e serviceSelector = getServiceSelector(serviceName); if (serviceSelector == null) { return new LinkedList\u003c\u003e(); } // è·å– pod Map\u003cString, Pod\u003e pods = kubernetesClient .pods() .inNamespace(namespace) .withLabels(serviceSelector) .list() .getItems() .stream() .collect( Collectors.toMap( pod -\u003e pod.getMetadata().getName(), pod -\u003e pod)); List\u003cServiceInstance\u003e instances = new LinkedList\u003c\u003e(); Set\u003cInteger\u003e instancePorts = new HashSet\u003c\u003e(); // è·å– port for (EndpointSubset endpointSubset : endpoints.getSubsets()) { instancePorts.addAll( endpointSubset.getPorts() .stream().map(EndpointPort::getPort) .collect(Collectors.toSet())); } for (EndpointSubset endpointSubset : endpoints.getSubsets()) { for (EndpointAddress address : endpointSubset.getAddresses()) { // æ£€æŸ¥ endpoint å’Œ pod æ˜¯å¦å…³è”ï¼Œ Pod pod = pods.get(address.getTargetRef().getName()); String ip = address.getIp(); // å¦‚æœ pod ä¸º nullï¼Œè¯´æ˜è¿™ä¸ª pod åˆ é™¤äº† if (pod == null) { logger.warn(REGISTRY_UNABLE_MATCH_KUBERNETES, \"\", \"\", \"Unable to match Kubernetes Endpoint address with Pod. \" + \"EndpointAddress Hostname: \" + address.getTargetRef().getName()); continue; } // éå†æ‰€æœ‰ portï¼Œæ–°å»º ServiceInstance instancePorts.forEach(port -\u003e { ServiceInstance serviceInstance = new DefaultServiceInstance(serviceName, ip, port, ScopeModelUtil.getApplicationModel(getUrl().getScopeModel())); // ä» pod ä¸Šè·å–ä¹‹å‰çš„å…ƒæ•°æ®ä¿¡æ¯ String properties = pod.getMetadata().getAnnotations().get(KUBERNETES_PROPERTIES_KEY); if (StringUtils.isNotEmpty(properties)) { serviceInstance.getMetadata().putAll(JsonUtils.toJavaObject(properties, Map.class)); instances.add(serviceInstance); } else { ... } }); } } return instances; } ","date":"2023-12-25","objectID":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"13 é›†æˆ k8s","uri":"/ooooo-notes/13-%E9%9B%86%E6%88%90-k8s/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ dubbo é›†æˆ spring çš„å®ç°æ–¹å¼ï¼š æä¾› ServiceAnnotationPostProcessor æ¥æ‰«æ @DubboService æ³¨è§£ï¼Œå¯¼å‡ºæœåŠ¡ æä¾› ReferenceAnnotationBeanPostProcessor æ¥æ‰«æ @DubboReference æ³¨è§£ï¼Œå¼•ç”¨æœåŠ¡ æä¾› SpringExtensionInjector æ¥è·å– spring çš„ bean æä¾› DubboInfraBeanRegisterPostProcessor æ¥æ³¨å†Œç›¸å…³ç±»ï¼ŒåŠ è½½ spring é…ç½® ","date":"2023-12-24","objectID":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"12 é›†æˆ spring","uri":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" ServiceAnnotationPostProcessorå¯¹ä¸€ä¸ª HelloService, ä¼šæ³¨å†Œä¸¤ä¸ª beanDefinitionï¼Œåˆ†åˆ«ä¸º HelloService ServiceBean\u003cHelloService\u003e æºç ä½ç½®: org.apache.dubbo.config.spring.beans.factory.annotation.ServiceAnnotationPostProcessor#postProcessBeanFactory @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { // æ‰«ææ–¹æ³•ä¸Šçš„ @DubboServiceï¼Œè¿™ä¸ªå¾ˆå°‘ç”¨ String[] beanNames = beanFactory.getBeanDefinitionNames(); for (String beanName : beanNames) { BeanDefinition beanDefinition = beanFactory.getBeanDefinition(beanName); Map\u003cString, Object\u003e annotationAttributes = getServiceAnnotationAttributes(beanDefinition); if (annotationAttributes != null) { // process @DubboService at java-config @bean method processAnnotatedBeanDefinition(beanName, (AnnotatedBeanDefinition) beanDefinition, annotationAttributes); } } if (!scanned) { // æ‰«æç±»ä¸Šçš„ @DubboServiceï¼Œè¿™ä¸ªç»§ç»­è§£æ scanServiceBeans(resolvedPackagesToScan, registry); } } æºç ä½ç½®: org.apache.dubbo.config.spring.beans.factory.annotation.ServiceAnnotationPostProcessor#scanServiceBeans private void scanServiceBeans(Set\u003cString\u003e packagesToScan, BeanDefinitionRegistry registry) { // æ ‡è®°å·²æ‰«æ scanned = true; if (CollectionUtils.isEmpty(packagesToScan)) { return; } // åˆ›å»ºæ‰«æå™¨ DubboClassPathBeanDefinitionScanner scanner = new DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader); BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry); scanner.setBeanNameGenerator(beanNameGenerator); // æ·»åŠ æ³¨è§£è¿‡æ»¤å™¨ï¼Œæ¯”å¦‚ @DubboService for (Class\u003c? extends Annotation\u003e annotationType : serviceAnnotationTypes) { scanner.addIncludeFilter(new AnnotationTypeFilter(annotationType)); } ScanExcludeFilter scanExcludeFilter = new ScanExcludeFilter(); scanner.addExcludeFilter(scanExcludeFilter); // å¯¹æ¯ä¸ªåŒ…éƒ½è¿›è¡Œæ‰«æ for (String packageToScan : packagesToScan) { // Registers @Service Bean firstï¼Œè¿™ä¸ªä¼šæ³¨å†Œ spring bean scanner.scan(packageToScan); // Finds all BeanDefinitionHolders of @Service whether @ComponentScan scans or not. Set\u003cBeanDefinitionHolder\u003e beanDefinitionHolders = findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator); // æœ‰ @DubboService çš„ beanDefintion if (!CollectionUtils.isEmpty(beanDefinitionHolders)) { if (logger.isInfoEnabled()) { List\u003cString\u003e serviceClasses = new ArrayList\u003c\u003e(beanDefinitionHolders.size()); for (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) { serviceClasses.add(beanDefinitionHolder.getBeanDefinition().getBeanClassName()); } logger.info(\"Found \" + beanDefinitionHolders.size() + \" classes annotated by Dubbo @Service under package [\" + packageToScan + \"]: \" + serviceClasses); } for (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) { // å¤„ç† beanDefinitionï¼Œå¾ˆé‡è¦ processScannedBeanDefinition(beanDefinitionHolder); servicePackagesHolder.addScannedClass(beanDefinitionHolder.getBeanDefinition().getBeanClassName()); } } else { ... } // æ ‡è®°å·²æ‰«æ servicePackagesHolder.addScannedPackage(packageToScan); } } æºç ä½ç½®: org.apache.dubbo.config.spring.beans.factory.annotation.ServiceAnnotationPostProcessor#processScannedBeanDefinition private void processScannedBeanDefinition(BeanDefinitionHolder beanDefinitionHolder) { Class\u003c?\u003e beanClass = resolveClass(beanDefinitionHolder); // æ‰¾åˆ° @DubboService Annotation service = findServiceAnnotation(beanClass); // The attributes of @Service annotation Map\u003cString, Object\u003e serviceAnnotationAttributes = AnnotationUtils.getAttributes(service, true); String serviceInterface = resolveInterfaceName(serviceAnnotationAttributes, beanClass); String annotatedServiceBeanName = beanDefinitionHolder.getBeanName(); // ServiceBean Bean name String beanName = generateServiceBeanName(serviceAnnotationAttributes, serviceInterface); // æ„å»º ServiceBeanDefinition, ä¹Ÿå°±æ˜¯ dubbo çš„ ServiceBean, é‡Œé¢çš„ ref å±æ€§ä¼šå¼•ç”¨ spring bean AbstractBeanDefinition serviceBeanDefinition = buildServiceBeanDefinition(serviceAnnotationAttributes, serviceInterface, annotatedServiceBeanName); // æ³¨å†Œ ServiceBeanDefinition registerServiceBeanDefinition(","date":"2023-12-24","objectID":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"12 é›†æˆ spring","uri":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" ReferenceAnnotationBeanPostProcessoræºç ä½ç½®: org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor#postProcessBeanFactory @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { // éå†æ‰€æœ‰çš„ beanName String[] beanNames = beanFactory.getBeanDefinitionNames(); for (String beanName : beanNames) { Class\u003c?\u003e beanType; // è§£æå‡º beanType if (beanFactory.isFactoryBean(beanName)) { ... beanType = ClassUtils.resolveClass(beanClassName, getClassLoader()); } else { beanType = beanFactory.getType(beanName); } if (beanType != null) { AnnotatedInjectionMetadata metadata = findInjectionMetadata(beanName, beanType, null); try { // æ³¨å…¥å­—æ®µå’Œæ–¹æ³• prepareInjection(metadata); } catch (BeansException e) { throw e; } catch (Exception e) { throw new IllegalStateException(\"Prepare dubbo reference injection element failed\", e); } } } ... } æºç ä½ç½®: org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor#prepareInjection protected void prepareInjection(AnnotatedInjectionMetadata metadata) throws BeansException { try { //find and register bean definition for @DubboReference/@Reference // éå†å­—æ®µ for (AnnotatedFieldElement fieldElement : metadata.getFieldElements()) { if (fieldElement.injectedObject != null) { continue; } Class\u003c?\u003e injectedType = fieldElement.field.getType(); AnnotationAttributes attributes = fieldElement.attributes; // æ³¨å†Œ @DubboReference bean, ä¹Ÿå°±æ˜¯ dubbo çš„ ReferenceBean String referenceBeanName = registerReferenceBean(fieldElement.getPropertyName(), injectedType, attributes, fieldElement.field); //associate fieldElement and reference bean // è®¾ç½®å…³è” fieldElement.injectedObject = referenceBeanName; injectedFieldReferenceBeanCache.put(fieldElement, referenceBeanName); } // éå†æ–¹æ³• for (AnnotatedMethodElement methodElement : metadata.getMethodElements()) { if (methodElement.injectedObject != null) { continue; } Class\u003c?\u003e injectedType = methodElement.getInjectedType(); AnnotationAttributes attributes = methodElement.attributes; // æ³¨å†Œ @DubboReference bean, ä¹Ÿå°±æ˜¯ dubbo çš„ ReferenceBean String referenceBeanName = registerReferenceBean(methodElement.getPropertyName(), injectedType, attributes, methodElement.method); //associate methodElement and reference bean // è®¾ç½®å…³è” methodElement.injectedObject = referenceBeanName; injectedMethodReferenceBeanCache.put(methodElement, referenceBeanName); } } catch (ClassNotFoundException e) { throw new BeanCreationException(\"prepare reference annotation failed\", e); } } ","date":"2023-12-24","objectID":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"12 é›†æˆ spring","uri":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" SpringExtensionInjectoræˆ‘ä»¬å¸¸å¸¸éœ€è¦æ‰©å±•è‡ªå·±çš„ filterï¼Œå¦‚æœåœ¨è¿™ä¸ªç±»ä¸­éœ€è¦è·å– spring çš„ beanï¼Œå°±ä¼šç”¨åˆ°è¿™ä¸ªæ‰©å±•ç±»ã€‚ æºç ä½ç½®: org.apache.dubbo.config.spring.extension.SpringExtensionInjector#getInstance // type: å­—æ®µç±»å‹ // name: å­—æ®µåç§° // å­—æ®µæ˜¯éœ€è¦ setter æ–¹æ³• public \u003cT\u003e T getInstance(Class\u003cT\u003e type, String name) { if (context == null) { // ignore if spring context is not bound return null; } //check @SPI annotation if (type.isInterface() \u0026\u0026 type.isAnnotationPresent(SPI.class)) { return null; } // æœ€ç»ˆè°ƒç”¨ spring çš„ BeanFactory æ¥è·å– bean T bean = getOptionalBean(context, name, type); if (bean != null) { return bean; } //logger.warn(\"No spring extension (bean) named:\" + name + \", try to find an extension (bean) of type \" + type.getName()); return null; } ","date":"2023-12-24","objectID":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"12 é›†æˆ spring","uri":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" DubboInfraBeanRegisterPostProcessoræºç ä½ç½®: org.apache.dubbo.config.spring.context.DubboInfraBeanRegisterPostProcessor#postProcessBeanFactory @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { if (registry != null) { // æ³¨å†Œ ReferenceAnnotationBeanPostProcessor, è´Ÿè´£æ‰«æ @DubboReference ReferenceAnnotationBeanPostProcessor referenceAnnotationBeanPostProcessor = beanFactory.getBean( ReferenceAnnotationBeanPostProcessor.BEAN_NAME, ReferenceAnnotationBeanPostProcessor.class); beanFactory.addBeanPostProcessor(referenceAnnotationBeanPostProcessor); // register PropertySourcesPlaceholderConfigurer bean if not exits DubboBeanUtils.registerPlaceholderConfigurerBeanIfNotExists(beanFactory, registry); } ApplicationModel applicationModel = DubboBeanUtils.getApplicationModel(beanFactory); ModuleModel moduleModel = DubboBeanUtils.getModuleModel(beanFactory); // åˆå§‹åŒ– SpringExtensionInjector SpringExtensionInjector.get(applicationModel).init(applicationContext); SpringExtensionInjector.get(moduleModel).init(applicationContext); DubboBeanUtils.getInitializationContext(beanFactory).setApplicationContext(applicationContext); // å°† spring çš„ environment ä¼ é€’åˆ° dubbo çš„ environment ä¸­ï¼Œé‡è¦ ConfigurableEnvironment environment = (ConfigurableEnvironment) applicationContext.getEnvironment(); SortedMap\u003cString, String\u003e dubboProperties = EnvironmentUtils.filterDubboProperties(environment); applicationModel.modelEnvironment().getAppConfigMap().putAll(dubboProperties); ... } ","date":"2023-12-24","objectID":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/:4:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"12 é›†æˆ spring","uri":"/ooooo-notes/12-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo ä¸­ï¼Œfilter æ˜¯éå¸¸æ ¸å¿ƒçš„ç»„ä»¶ä¹‹ä¸€ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯ä¾é  filter æ¥å®ç°çš„ï¼Œä¸‹é¢æˆ‘æ¥ä»‹ç»å‡ ç§å¸¸ç”¨çš„ filter å®ç°ã€‚ ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ConsumerContextFilter (consumer ä¼ é€’éšå¼å‚æ•°)æºç ä½ç½®: org.apache.dubbo.rpc.cluster.filter.support.ConsumerContextFilter @Override public Result invoke(Invoker\u003c?\u003e invoker, Invocation invocation) throws RpcException { ... RpcContext context = RpcContext.getClientAttachment(); context.setAttachment(REMOTE_APPLICATION_KEY, invoker.getUrl().getApplication()); if (invocation instanceof RpcInvocation) { ((RpcInvocation) invocation).setInvoker(invoker); } // æ·»åŠ  ServerAttachment å‚æ•° ((RpcInvocation) invocation).addObjectAttachments(RpcContext.getServerAttachment().getObjectAttachments()); // æ·»åŠ  ClientAttachment å‚æ•° Map\u003cString, Object\u003e contextAttachments = RpcContext.getClientAttachment().getObjectAttachments(); if (CollectionUtils.isNotEmptyMap(contextAttachments)) { ((RpcInvocation) invocation).addObjectAttachments(contextAttachments); } ... RpcContext.removeClientResponseContext(); return invoker.invoke(invocation); } ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ContextFilter (provider æ¥å—éšå¼å‚æ•°)æºç ä½ç½®: org.apache.dubbo.rpc.filter.ContextFilter @Override public Result invoke(Invoker\u003c?\u003e invoker, Invocation invocation) throws RpcException { Map\u003cString, Object\u003e attachments = invocation.getObjectAttachments(); ... // è®¾ç½® RemoteApplicationName String remoteApplication = invocation.getAttachment(REMOTE_APPLICATION_KEY); if (StringUtils.isNotEmpty(remoteApplication)) { RpcContext.getServiceContext().setRemoteApplicationName(remoteApplication); } else { RpcContext.getServiceContext().setRemoteApplicationName(context.getAttachment(REMOTE_APPLICATION_KEY)); } // æ·»åŠ  invocation ä¸­çš„ attachmentsï¼ˆconsumer ç«¯ä¼ é€’çš„éšå¼å‚æ•°ï¼‰ if (CollectionUtils.isNotEmptyMap(attachments)) { if (context.getObjectAttachments().size() \u003e 0) { context.getObjectAttachments().putAll(attachments); } else { context.setObjectAttachments(attachments); } } try { context.clearAfterEachInvoke(false); return invoker.invoke(invocation); } finally { context.clearAfterEachInvoke(true); if (context.isAsyncStarted()) { removeContext(); } } } ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ClassLoaderFilter (provider è®¾ç½®ç±»åŠ è½½å™¨)æºç ä½ç½®: org.apache.dubbo.rpc.filter.ClassLoaderFilter public Result invoke(Invoker\u003c?\u003e invoker, Invocation invocation) throws RpcException { // è·å–ä¹‹å‰çš„ classloader ClassLoader stagedClassLoader = Thread.currentThread().getContextClassLoader(); // è·å–å½“å‰çš„ classloader ClassLoader effectiveClassLoader; if (invocation.getServiceModel() != null) { effectiveClassLoader = invocation.getServiceModel().getClassLoader(); } else { effectiveClassLoader = invoker.getClass().getClassLoader(); } if (effectiveClassLoader != null) { invocation.put(STAGED_CLASSLOADER_KEY, stagedClassLoader); invocation.put(WORKING_CLASSLOADER_KEY, effectiveClassLoader); Thread.currentThread().setContextClassLoader(effectiveClassLoader); } try { return invoker.invoke(invocation); } finally { // è¿˜åŸ classloader Thread.currentThread().setContextClassLoader(stagedClassLoader); } } ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ActiveLimitFilter (consumer é™æµ)ä»£ç ä¸åˆ†æï¼Œä¸»è¦é€»è¾‘æ˜¯è·å– active å‚æ•°æ¥åˆ¤æ–­ã€‚ ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:4:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ExecuteLimitFilter (provider é™æµ)ä»£ç ä¸åˆ†æï¼Œä¸»è¦é€»è¾‘æ˜¯è·å– executes å‚æ•°æ¥åˆ¤æ–­ ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:5:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" ExceptionFilter (provider å¼‚å¸¸å¤„ç†)æºç ä½ç½®: org.apache.dubbo.rpc.filter.ExceptionFilter @Override public void onResponse(Result appResponse, Invoker\u003c?\u003e invoker, Invocation invocation) { // æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”ä¸æ˜¯æ³›åŒ–è°ƒç”¨ if (appResponse.hasException() \u0026\u0026 GenericService.class != invoker.getInterface()) { try { Throwable exception = appResponse.getException(); // directly throw if it's checked exception // ä¸æ˜¯ RuntimeException, ç›´æ¥ return, ä¼ é€’åˆ° consumer ç«¯ if (!(exception instanceof RuntimeException) \u0026\u0026 (exception instanceof Exception)) { return; } // directly throw if the exception appears in the signature // æ£€æŸ¥æ–¹æ³•ä¸Šå£°æ˜çš„å¼‚å¸¸ try { Method method = invoker.getInterface().getMethod(RpcUtils.getMethodName(invocation), invocation.getParameterTypes()); Class\u003c?\u003e[] exceptionClasses = method.getExceptionTypes(); for (Class\u003c?\u003e exceptionClass : exceptionClasses) { if (exception.getClass().equals(exceptionClass)) { return; } } } catch (NoSuchMethodException e) { return; } // æ£€æŸ¥æ¥å£å’Œå¼‚å¸¸ç±»æ˜¯åŒä¸€ä¸ªjarï¼Œç›´æ¥ returnï¼Œè¿”å›ç»™ consumer ç«¯ String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface()); String exceptionFile = ReflectUtils.getCodeBase(exception.getClass()); if (serviceFile == null || exceptionFile == null || serviceFile.equals(exceptionFile)) { return; } // directly throw if it's JDK exception String className = exception.getClass().getName(); // æ£€æŸ¥æ˜¯ JDK å¼‚å¸¸ï¼Œç›´æ¥ returnï¼Œè¿”å›ç»™ consumer ç«¯ if (className.startsWith(\"java.\") || className.startsWith(\"javax.\")) { return; } // directly throw if it's dubbo exception // æ£€æŸ¥æ˜¯ RpcExceptionï¼Œç›´æ¥ return, è¿”å›ç»™ consumer ç«¯ if (exception instanceof RpcException) { return; } // otherwise, wrap with RuntimeException and throw back to the client // åŒ…è£…ä¸º RuntimeException appResponse.setException(new RuntimeException(StringUtils.toString(exception))); } catch (Throwable e) { ... } } } ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:6:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" GenericFilter (provider æ³›åŒ–è°ƒç”¨)æºç ä½ç½®: org.apache.dubbo.rpc.filter.GenericFilter @Override public Result invoke(Invoker\u003c?\u003e invoker, Invocation inv) throws RpcException { // æ£€æŸ¥æ˜¯å¦ä¸ºæ³›åŒ–è°ƒç”¨ if ((inv.getMethodName().equals($INVOKE) || inv.getMethodName().equals($INVOKE_ASYNC)) \u0026\u0026 inv.getArguments() != null \u0026\u0026 inv.getArguments().length == 3 \u0026\u0026 !GenericService.class.isAssignableFrom(invoker.getInterface())) { // è·å–æ³›åŒ–è°ƒç”¨çš„ æ–¹æ³•åï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°å€¼ String name = ((String) inv.getArguments()[0]).trim(); String[] types = (String[]) inv.getArguments()[1]; Object[] args = (Object[]) inv.getArguments()[2]; try { Method method = findMethodByMethodSignature(invoker.getInterface(), name, types, inv.getServiceModel()); Class\u003c?\u003e[] params = method.getParameterTypes(); ... String generic = inv.getAttachment(GENERIC_KEY); // è·å– GENERIC_KEY å‚æ•° if (StringUtils.isBlank(generic)) { generic = getGenericValueFromRpcContext(); } if (StringUtils.isEmpty(generic) || ProtocolUtils.isDefaultGenericSerialization(generic) || ProtocolUtils.isGenericReturnRawResult(generic)) { // é»˜è®¤åºåˆ—åŒ–æ–¹å¼ï¼Œæ¯”å¦‚ Map è£…æ¢ä¸º JavaBean args = PojoUtils.realize(args, params, method.getGenericParameterTypes()); } } else if (ProtocolUtils.isGsonGenericSerialization(generic)) { // gson åºåˆ—åŒ– args = getGsonGenericArgs(args, method.getGenericParameterTypes()); } else if (ProtocolUtils.isJavaGenericSerialization(generic)) { // java åºåˆ—åŒ– ... } else if (ProtocolUtils.isBeanGenericSerialization(generic)) { // bean åºåˆ—åŒ–ï¼Œå‚æ•°éœ€è¦å®ç° JavaBeanDescriptor æ¥å£ ... } else if (ProtocolUtils.isProtobufGenericSerialization(generic)) { // protobuf åºåˆ—åŒ– } // æ„å»ºæ–°çš„ invocation RpcInvocation rpcInvocation = new RpcInvocation(inv.getTargetServiceUniqueName(), ... // è°ƒç”¨ return invoker.invoke(rpcInvocation); } catch (NoSuchMethodException | ClassNotFoundException e) { throw new RpcException(e.getMessage(), e); } } // ä¸æ˜¯æ³›åŒ–è°ƒç”¨ï¼Œç›´æ¥è°ƒç”¨ return invoker.invoke(inv); } ","date":"2023-12-23","objectID":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/:7:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"11 å¸¸ç”¨è¿‡æ»¤å™¨","uri":"/ooooo-notes/11-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"},{"categories":null,"content":" AopAutoConfiguration è‡ªåŠ¨é…ç½®ç±»æºç ä½ç½®: org.springframework.boot.autoconfigure.aop.AopAutoConfiguration @Configuration(proxyBeanMethods = false) // è‡ªåŠ¨æ¿€æ´» aop é…ç½®, è¿˜ä¼šæ¿€æ´» @EnableAspectJAutoProxy æ³¨è§£ @ConditionalOnProperty(prefix = \"spring.aop\", name = \"auto\", havingValue = \"true\", matchIfMissing = true) public class AopAutoConfiguration { @Configuration(proxyBeanMethods = false) @ConditionalOnClass(Advice.class) static class AspectJAutoProxyingConfiguration { @Configuration(proxyBeanMethods = false) @EnableAspectJAutoProxy(proxyTargetClass = false) // aop ä½¿ç”¨ jdk proxy @ConditionalOnProperty(prefix = \"spring.aop\", name = \"proxy-target-class\", havingValue = \"false\") static class JdkDynamicAutoProxyConfiguration { } @Configuration(proxyBeanMethods = false) @EnableAspectJAutoProxy(proxyTargetClass = true) // aop ä½¿ç”¨ cglib proxy @ConditionalOnProperty(prefix = \"spring.aop\", name = \"proxy-target-class\", havingValue = \"true\", matchIfMissing = true) static class CglibAutoProxyConfiguration { } } @Configuration(proxyBeanMethods = false) @ConditionalOnMissingClass(\"org.aspectj.weaver.Advice\") // cglib proxy æ¿€æ´» @ConditionalOnProperty(prefix = \"spring.aop\", name = \"proxy-target-class\", havingValue = \"true\", matchIfMissing = true) static class ClassProxyingConfiguration { @Bean static BeanFactoryPostProcessor forceAutoProxyCreatorToUseClassProxying() { return (beanFactory) -\u003e { if (beanFactory instanceof BeanDefinitionRegistry) { BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; // æ³¨å†Œ aop ç›¸å…³ç±» AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry); // å¼ºåˆ¶ä½¿ç”¨ proxyTargetClass = true AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry); } }; } } } æºç ä½ç½®: org.springframework.aop.config.AopConfigUtils#registerAutoProxyCreatorIfNecessary // æ³¨å†Œ aop ç›¸å…³ç±» @Nullable public static BeanDefinition registerAutoProxyCreatorIfNecessary( BeanDefinitionRegistry registry, @Nullable Object source) { return registerOrEscalateApcAsRequired(InfrastructureAdvisorAutoProxyCreator.class, registry, source); } private static BeanDefinition registerOrEscalateApcAsRequired( Class\u003c?\u003e cls, BeanDefinitionRegistry registry, @Nullable Object source) { Assert.notNull(registry, \"BeanDefinitionRegistry must not be null\"); // æ£€æŸ¥ä¹‹å‰æ˜¯å¦æ³¨å†Œè¿‡ if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) { BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME); // å’Œå½“å‰æ³¨å†Œç±»ä¸ä¸€æ · if (!cls.getName().equals(apcDefinition.getBeanClassName())) { int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName()); int requiredPriority = findPriorityForClass(cls); // æ¯”è¾ƒä¼˜å…ˆçº§ if (currentPriority \u003c requiredPriority) { // é‡æ–°è®¾ç½® beanClassName apcDefinition.setBeanClassName(cls.getName()); } } return null; } // ä¹‹å‰æ²¡æœ‰æ³¨å†Œè¿‡ RootBeanDefinition beanDefinition = new RootBeanDefinition(cls); beanDefinition.setSource(source); // order æ˜¯æœ€å¤§å€¼ beanDefinition.getPropertyValues().add(\"order\", Ordered.HIGHEST_PRECEDENCE); // åŸºç¡€ç±» beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); // æ³¨å†Œ beanDefinition registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition); return beanDefinition; } æºç ä½ç½®: org.springframework.aop.config.AopConfigUtils // ä»ä¸Šåˆ°ä¸‹ï¼Œä¼˜å…ˆçº§ä¾æ¬¡å˜é«˜ static { // Set up the escalation list... APC_PRIORITY_LIST.add(InfrastructureAdvisorAutoProxyCreator.class); APC_PRIORITY_LIST.add(AspectJAwareAdvisorAutoProxyCreator.class); APC_PRIORITY_LIST.add(AnnotationAwareAspectJAutoProxyCreator.class); } ","date":"2023-12-18","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/:1:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å®ç° aop åŸç†","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" @EnableAspectJAutoProxyæºç ä½ç½®: org.springframework.context.annotation.EnableAspectJAutoProxy @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented // å¯¼å…¥é…ç½®ç±» @Import(AspectJAutoProxyRegistrar.class) public @interface EnableAspectJAutoProxy { /** * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed * to standard Java interface-based proxies. The default is {@code false}. */ // å¦‚æœä¸º trueï¼Œåˆ™ä¸º cglib proxy boolean proxyTargetClass() default false; /** * Indicate that the proxy should be exposed by the AOP framework as a {@code ThreadLocal} * for retrieval via the {@link org.springframework.aop.framework.AopContext} class. * Off by default, i.e. no guarantees that {@code AopContext} access will work. * @since 4.3.1 */ boolean exposeProxy() default false; } æºç ä½ç½®: org.springframework.context.annotation.AspectJAutoProxyRegistrar class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar { /** * Register, escalate, and configure the AspectJ auto proxy creator based on the value * of the @{@link EnableAspectJAutoProxy#proxyTargetClass()} attribute on the importing * {@code @Configuration} class. */ @Override public void registerBeanDefinitions( AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) { // æ¿€æ´» aop ç›¸å…³ç±» AnnotationAwareAspectJAutoProxyCreator AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry); AnnotationAttributes enableAspectJAutoProxy = AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class); if (enableAspectJAutoProxy != null) { if (enableAspectJAutoProxy.getBoolean(\"proxyTargetClass\")) { // å¼ºåˆ¶ä½¿ç”¨ proxyTargetClass = true, ä½¿ç”¨ cglib æ¥å®ç°ä»£ç† AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry); } if (enableAspectJAutoProxy.getBoolean(\"exposeProxy\")) { // å¼ºåˆ¶ä½¿ç”¨ exposeProxy = true, å¯ä»¥ç”¨ AopContext#currentProxy è·å–ä»£ç†å¯¹è±¡ AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry); } } } } ","date":"2023-12-18","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/:2:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å®ç° aop åŸç†","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" AnnotationAwareAspectJAutoProxyCreator è¿™é‡Œä»¥ AnnotationAwareAspectJAutoProxyCreator ä¸ºä¾‹, å½“æˆ‘ä»¬æ·»åŠ äº† org.springframework.boot:spring-boot-starter-aop ä¾èµ–åå°±ä¼šæ¿€æ´»è¿™ä¸ªç±»ã€‚ æºç ä½ç½®: org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessBeforeInstantiation // bean å®ä¾‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³• @Override public Object postProcessBeforeInstantiation(Class\u003c?\u003e beanClass, String beanName) { Object cacheKey = getCacheKey(beanClass, beanName); if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) { if (this.advisedBeans.containsKey(cacheKey)) { return null; } // åŸºç¡€ç±» æˆ–è€… éœ€è¦è·³è¿‡ if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return null; } } // Create proxy here if we have a custom TargetSource. // Suppresses unnecessary default instantiation of the target bean: // The TargetSource will handle target instances in a custom fashion. // è·å–è‡ªå®šä¹‰çš„ targetSource, é»˜è®¤ä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ç”Ÿæˆä»£ç†å¯¹è±¡ TargetSource targetSource = getCustomTargetSource(beanClass, beanName); if (targetSource != null) { if (StringUtils.hasLength(beanName)) { this.targetSourcedBeans.add(beanName); } // è·å–è¿™ä¸ªç±»çš„ advisor Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource); // åˆ›å»ºä»£ç†å¯¹è±¡ Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } // è¿”å› nullï¼Œä¼šç»§ç»­å®ä¾‹åŒ– return null; } æºç ä½ç½®: org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessAfterInitialization // bean åˆå§‹åŒ–ä¹‹åä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³• @Override public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) { if (bean != null) { Object cacheKey = getCacheKey(bean.getClass(), beanName); // å¦‚æœæ²¡æœ‰ early getBean, è¿™é‡Œå°±æ˜¯ null if (this.earlyProxyReferences.remove(cacheKey) != bean) { // åˆ›å»ºä»£ç†å¯¹è±¡, åé¢ç»§ç»­è§£æ return wrapIfNecessary(bean, beanName, cacheKey); } } return bean; } æºç ä½ç½®: org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#wrapIfNecessary protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) { // æœ‰è‡ªå®šä¹‰çš„ targetSource, åˆ™è·³è¿‡ if (StringUtils.hasLength(beanName) \u0026\u0026 this.targetSourcedBeans.contains(beanName)) { return bean; } // ä¸éœ€è¦ä»£ç† if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) { return bean; } // åŸºç¡€ç±» æˆ–è€… åº”è¯¥è·³è¿‡ if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } // Create proxy if we have advice. // è·å– advisor, è¿™ä¸ªä¼šè·å– @Aspectï¼ŒAdvisorï¼Œåé¢ä¼šç»§ç»­è§£æ Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); if (specificInterceptors != DO_NOT_PROXY) { this.advisedBeans.put(cacheKey, Boolean.TRUE); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œåé¢ä¼šç»§ç»­è§£æ Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; } // æ ‡è®°ä¸éœ€è¦ä»£ç† this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; } æºç ä½ç½®: org.springframework.aop.framework.autoproxy.AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean // è·å– advisor @Override @Nullable protected Object[] getAdvicesAndAdvisorsForBean( Class\u003c?\u003e beanClass, String beanName, @Nullable TargetSource targetSource) { // æ‰¾åˆ°åˆé€‚çš„ advisor List\u003cAdvisor\u003e advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) { // è¿”å› nullï¼Œä¸éœ€è¦ä»£ç† return DO_NOT_PROXY; } return advisors.toArray(); } // æ‰¾åˆ°åˆé€‚çš„ advisor protected List\u003cAdvisor\u003e findEligibleAdvisors(Class\u003c?\u003e beanClass, String beanName) { // æ‰¾åˆ°æ‰€æœ‰çš„ advisor bean, åŒ…æ‹¬ @Aspect List\u003cAdvisor\u003e candidateAdvisors = findCandidateAdvisors(); // åˆ¤æ–­ advisor æ˜¯å¦èƒ½åº”ç”¨åˆ° bean, ClassFilter å’Œ MethodMatcher List\u003cAdvisor\u003e eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); // å­ç±»æ‰©å±•ï¼Œç›®å‰ä¼šæ·»åŠ  ExposeInvocationInterceptor extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) { // å¯¹ advisor æ’åº eligibleAdvisors = sortAdvisors(eligibleAdvisors); }","date":"2023-12-18","objectID":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/:3:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"å®ç° aop åŸç†","uri":"/ooooo-notes/%E5%AE%9E%E7%8E%B0-aop-%E5%8E%9F%E7%90%86/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo 2.x ä¸­ï¼Œæœ€å¸¸ç”¨çš„åè®®å°±æ˜¯ dubbo åè®®ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å¼„æ‡‚æ•´ä¸ªå®ç°è¿‡ç¨‹ã€‚ ","date":"2023-12-07","objectID":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"09 dubbo åè®®","uri":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" export å¯¼å‡ºæœåŠ¡æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#export @Override public \u003cT\u003e Exporter\u003cT\u003e export(Invoker\u003cT\u003e invoker) throws RpcException { checkDestroyed(); URL url = invoker.getUrl(); String key = serviceKey(url); // æ·»åŠ åˆ° exporterMap DubboExporter\u003cT\u003e exporter = new DubboExporter\u003cT\u003e(invoker, key, exporterMap); ... // æ‰“å¼€æœåŠ¡ï¼Œä¼šç›‘å¬ç«¯å£ openServer(url); // ä¼˜åŒ–åºåˆ—åŒ–ï¼Œä¸ç”¨å¤ªå…³å¿ƒ optimizeSerialization(url); return exporter; } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#openServer private void openServer(URL url) { checkDestroyed(); String key = url.getAddress(); // åˆ¤æ–­æ˜¯å¦ä¸º server ç«¯ boolean isServer = url.getParameter(IS_SERVER_KEY, true); if (isServer) { // å»¶è¿Ÿåˆå§‹åŒ– ProtocolServer server = serverMap.get(key); if (server == null) { synchronized (this) { server = serverMap.get(key); if (server == null) { // åˆ›å»ºæœåŠ¡ serverMap.put(key, createServer(url)); return; } } } // server supports reset, use together with override server.reset(url); } } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#createServer private ProtocolServer createServer(URL url) { url = URLBuilder.from(url) .addParameterIfAbsent(CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString()) // å¿ƒè·³ .addParameterIfAbsent(HEARTBEAT_KEY, String.valueOf(DEFAULT_HEARTBEAT)) // ç¼–è§£ç  .addParameter(CODEC_KEY, DubboCodec.NAME) .build(); // ä½¿ç”¨ netty String transporter = url.getParameter(SERVER_KEY, DEFAULT_REMOTING_SERVER); if (StringUtils.isNotEmpty(transporter) \u0026\u0026 !url.getOrDefaultFrameworkModel().getExtensionLoader(Transporter.class).hasExtension(transporter)) { throw new RpcException(\"Unsupported server type: \" + transporter + \", url: \" + url); } ExchangeServer server; try { // ç»‘å®šç«¯å£, è®¾ç½® requestHandlerï¼Œå› ä¸º client å’Œ server éƒ½æ˜¯åŒä¸€ä¸ª requestHandler, æœ€åå†è§£æ server = Exchangers.bind(url, requestHandler); } catch (RemotingException e) { throw new RpcException(\"Fail to start server(url: \" + url + \") \" + e.getMessage(), e); } ... return protocolServer; } ","date":"2023-12-07","objectID":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"09 dubbo åè®®","uri":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" refer å¼•ç”¨æœåŠ¡æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#refer @Override public \u003cT\u003e Invoker\u003cT\u003e refer(Class\u003cT\u003e type, URL url) throws RpcException { checkDestroyed(); return protocolBindingRefer(type, url); } @Override public \u003cT\u003e Invoker\u003cT\u003e protocolBindingRefer(Class\u003cT\u003e serviceType, URL url) throws RpcException { checkDestroyed(); // ä¼˜åŒ–åºåˆ—åŒ–ï¼Œä¸éœ€è¦å…³å¿ƒ optimizeSerialization(url); // è·å– clients, åˆ›å»º dubboInvoker DubboInvoker\u003cT\u003e invoker = new DubboInvoker\u003cT\u003e(serviceType, url, getClients(url), invokers); invokers.add(invoker); return invoker; } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#getClients private ClientsProvider getClients(URL url) { // è·å–è¿æ¥æ•°ï¼Œ0è¡¨ç¤ºå…±äº«ä¸€ä¸ªè¿æ¥ int connections = url.getParameter(CONNECTIONS_KEY, 0); // whether to share connection // if not configured, connection is shared, otherwise, one connection for one service if (connections == 0) { ... // è·å–å…±äº«clientï¼Œæœ€ç»ˆè°ƒç”¨ initClient æ–¹æ³• return getSharedClient(url, connections); } // è·å–å¤šä¸ªclient List\u003cExchangeClient\u003e clients = IntStream.range(0, connections) .mapToObj((i) -\u003e initClient(url)) .collect(Collectors.toList()); return new ExclusiveClientsProvider(clients); } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol#initClient private ExchangeClient initClient(URL url) { // ä½¿ç”¨ netty String str = url.getParameter(CLIENT_KEY, url.getParameter(SERVER_KEY, DEFAULT_REMOTING_CLIENT)); ... try { ScopeModel scopeModel = url.getScopeModel(); int heartbeat = UrlUtils.getHeartbeat(url); // Replace InstanceAddressURL with ServiceConfigURL. url = new ServiceConfigURL(DubboCodec.NAME, url.getUsername(), url.getPassword(), url.getHost(), url.getPort(), url.getPath(), url.getAllParameters()); // ç¼–è§£ç  url = url.addParameter(CODEC_KEY, DubboCodec.NAME); // å¿ƒè·³ url = url.addParameterIfAbsent(HEARTBEAT_KEY, Integer.toString(heartbeat)); url = url.setScopeModel(scopeModel); // connection should be lazy return url.getParameter(LAZY_CONNECT_KEY, false) ? new LazyConnectExchangeClient(url, requestHandler) // è¿æ¥ç«¯å£ï¼Œè®¾ç½® requestHandler : Exchangers.connect(url, requestHandler); } catch (RemotingException e) { throw new RpcException(\"Fail to create remoting client for service(\" + url + \"): \" + e.getMessage(), e); } } ","date":"2023-12-07","objectID":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"09 dubbo åè®®","uri":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" requestHandler client å’Œ server å…±ç”¨çš„è¯·æ±‚å¤„ç†å™¨ æºç ä½ç½®: org.apache.dubbo.remoting.exchange.support.ExchangeHandlerAdapter#reply @Override public CompletableFuture\u003cObject\u003e reply(ExchangeChannel channel, Object message) throws RemotingException { ... Invocation inv = (Invocation) message; // è·å– invoker Invoker\u003c?\u003e invoker = inv.getInvoker() == null ? getInvoker(channel, inv) : inv.getInvoker(); // switch TCCL if (invoker.getUrl().getServiceModel() != null) { Thread.currentThread().setContextClassLoader(invoker.getUrl().getServiceModel().getClassLoader()); } // åˆ¤æ–­å›è°ƒæ–¹æ³•æ˜¯å¦å­˜åœ¨ if (Boolean.TRUE.toString().equals(inv.getObjectAttachmentWithoutConvert(IS_CALLBACK_SERVICE_INVOKE))) { String methodsStr = invoker.getUrl().getParameters().get(\"methods\"); boolean hasMethod = false; if (methodsStr == null || !methodsStr.contains(\",\")) { hasMethod = inv.getMethodName().equals(methodsStr); } else { String[] methods = methodsStr.split(\",\"); for (String method : methods) { if (inv.getMethodName().equals(method)) { hasMethod = true; break; } } } if (!hasMethod) { logger.warn(PROTOCOL_FAILED_REFER_INVOKER, \"\", \"\", new IllegalStateException(\"The methodName \" + inv.getMethodName() + \" not found in callback service interface ,invoke will be ignored.\" + \" please update the api interface. url is:\" + invoker.getUrl()) + \" ,invocation is :\" + inv); return null; } } RpcContext.getServiceContext().setRemoteAddress(channel.getRemoteAddress()); // è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼Œè¿”å› AsyncRpcResult Result result = invoker.invoke(inv); return result.thenApply(Function.identity()); } ","date":"2023-12-07","objectID":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"09 dubbo åè®®","uri":"/ooooo-notes/09-dubbo-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo 3.x ä¸­ï¼Œæ–°å¢äº†ä¸€ç§åè®®ï¼Œé‚£å°±æ˜¯ triple åè®®ï¼Œå¯ä»¥å…¼å®¹ grpc åè®®, è¿™ä¸¤ä¸ªåè®®çš„åº•å±‚éƒ½æ˜¯ http2 åè®®ã€‚ triple åè®®å®ç°çš„æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä¼šæŠŠå…³é”®ä»£ç è´´å‡ºæ¥ã€‚ ","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" export å¯¼å‡ºæœåŠ¡æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.TripleProtocol#export @Override public \u003cT\u003e Exporter\u003cT\u003e export(Invoker\u003cT\u003e invoker) throws RpcException { URL url = invoker.getUrl(); String key = serviceKey(url); ... invokers.add(invoker); // æ·»åŠ åˆ° pathResolver, è¿™ä¸ªå¾ˆå…³é”® Invoker\u003c?\u003e previous = pathResolver.add(url.getServiceKey(), invoker); if (previous != null) { ... } ... // åˆå§‹åŒ–çº¿ç¨‹æ±  ExecutorRepository.getInstance(url.getOrDefaultApplicationModel()).createExecutorIfAbsent(ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)); // ç»‘å®šç«¯å£ï¼Œå¼€å¯æœåŠ¡, æ³¨æ„ DefaultPuHandler æ˜¯ç©ºå®ç°ï¼Œè¿™æ˜¯å’Œ DubboProtocol å®ç°çš„ä¸»è¦åŒºåˆ« PortUnificationExchanger.bind(url, new DefaultPuHandler()); // åºåˆ—åŒ–ï¼Œä¸ç”¨å…³å¿ƒ optimizeSerialization(url); return exporter; } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyPortUnificationTransporter#bind // PortUnificationExchanger#bind æœ€ç»ˆä¼šè°ƒç”¨æ­¤æ–¹æ³• // åœ¨ NettyPortUnificationServer çš„çˆ¶ç±»æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨ doOpen æ–¹æ³• @Override public AbstractPortUnificationServer bind(URL url, ChannelHandler handler) throws RemotingException { return new NettyPortUnificationServer(url, handler); } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyPortUnificationServer#doOpen // ä¸‹é¢çš„ä»£ç æ˜¯æ ‡å‡†çš„ netty ä»£ç ï¼Œ æˆ‘ä»¬åªéœ€è¦å…³æ³¨å…¶ä¸­çš„ channelHandler å°±å¯ä»¥äº† public void doOpen() throws Throwable { bootstrap = new ServerBootstrap(); ... bootstrap.group(bossGroup, workerGroup) .channel(NettyEventLoopFactory.serverSocketChannelClass()) .option(ChannelOption.SO_REUSEADDR, Boolean.TRUE) .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE) .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT) .childHandler(new ChannelInitializer\u003cSocketChannel\u003e() { @Override protected void initChannel(SocketChannel ch) throws Exception { // Do not add idle state handler here, because it should be added in the protocol handler. final ChannelPipeline p = ch.pipeline(); // è´Ÿè´£å¿ƒè·³ï¼Œä¸ç”¨å…³å¿ƒ NettyChannelHandler nettyChannelHandler = new NettyChannelHandler(dubboChannels, getUrl(), NettyPortUnificationServer.this); // puHandler æ˜¯æœ€é‡è¦çš„ channelHandler, è´Ÿè´£æ£€æµ‹æ˜¯ grpc è¿˜æ˜¯ triple åè®® NettyPortUnificationServerHandler puHandler = new NettyPortUnificationServerHandler(getUrl(), true, getProtocols(), NettyPortUnificationServer.this, getSupportedUrls(), getSupportedHandlers()); p.addLast(\"channel-handler\", nettyChannelHandler); p.addLast(\"negotiation-protocol\", puHandler); } }); ... } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyPortUnificationServerHandler#decode // å½“æ¥å—åˆ°è¯·æ±‚æ—¶ï¼Œnetty ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³• @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List\u003cObject\u003e out) throws Exception { NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler); ... if (providerConnectionConfig != null \u0026\u0026 isSsl(in)) { // æ£€æµ‹ SSLï¼Œå°±æ˜¯åˆ¤æ–­å‰5ä¸ªå­—ç¬¦ enableSsl(ctx, providerConnectionConfig); } else { // æ£€æµ‹æ˜¯ grpc è¿˜æ˜¯ triple for (final WireProtocol protocol : protocols) { in.markReaderIndex(); ChannelBuffer buf = new NettyBackedChannelBuffer(in); final ProtocolDetector.Result result = protocol.detector().detect(buf); in.resetReaderIndex(); switch (result) { case UNRECOGNIZED: continue; case RECOGNIZED: String protocolName = url.getOrDefaultFrameworkModel().getExtensionLoader(WireProtocol.class) .getExtensionName(protocol); // è·å– handler å’Œ urlï¼Œ ä¸ç”¨å…³å¿ƒ ChannelHandler localHandler = this.handlerMapper.getOrDefault(protocolName, handler); URL localURL = this.urlMapper.getOrDefault(protocolName, url); channel.setUrl(localURL); NettyConfigOperator operator = new NettyConfigOperator(channel, localHandler); // é…ç½® channelHandlerï¼Œéå¸¸é‡è¦ï¼Œåé¢ç»§ç»­è§£æ protocol.configServerProtocolHandler(url, operator); // ç§»é™¤å½“å‰ channelHandlerï¼Œä¸‹ä¸€æ¬¡å°±ä¸éœ€è¦åœ¨æ£€æµ‹äº† ctx.pipeline().remove(this); case NEED_MORE_DATA: return; default: return; } } ... } } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.TripleHttp2Protocol#configServerProtocolHandler // é…ç½® http2 ç›¸å…³çš„ channelHandler @Override public void configServerProtocolHandler(URL url, ChannelOperator operator) { ... final Http2FrameCodec codec = TripleHttp2FrameCodecBuilder.forServer() ... .build(); ExecutorSupport executorSupport = Executo","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" TripleHttp2FrameServerHandler æ¥å—å®¢æˆ·ç«¯çš„æ¶ˆæ¯ æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.transport.TripleHttp2FrameServerHandler#TripleHttp2FrameServerHandler // http2 ä¸­çš„æ¯ä¸ª stream éƒ½ä¼šæ¥å—åˆ°å›è°ƒæ–¹æ³• @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception { if (msg instanceof Http2HeadersFrame) { // å¤„ç† Http2HeadersFrameï¼Œ è¯»å– serviceNameï¼ŒmethodName onHeadersRead(ctx, (Http2HeadersFrame) msg); } else if (msg instanceof Http2DataFrame) { // å¤„ç† Http2DataFrame, è¯»å–æ•°æ® onDataRead(ctx, (Http2DataFrame) msg); } else if (msg instanceof ReferenceCounted) { // ignored ReferenceCountUtil.release(msg); } } // å¤„ç† Http2DataFrame public void onDataRead(ChannelHandlerContext ctx, Http2DataFrame msg) throws Exception { tripleServerStream.transportObserver.onData(msg.content(), msg.isEndStream()); } // å¤„ç† Http2HeadersFrame public void onHeadersRead(ChannelHandlerContext ctx, Http2HeadersFrame msg) throws Exception { Executor executor = executorSupport.getExecutor(msg.headers()); tripleServerStream.setExecutor(executor); // è°ƒç”¨ ServerTransportObserver#onHeader æ–¹æ³• tripleServerStream.transportObserver.onHeader(msg.headers(), msg.isEndStream()); } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.stream.TripleServerStream.ServerTransportObserver#onHeader @Override public void onHeader(Http2Headers headers, boolean endStream) { executor.execute(() -\u003e processHeader(headers, endStream)); } private void processHeader(Http2Headers headers, boolean endStream) { ... String[] parts = path.split(\"/\"); if (parts.length != 3) { responseErr(TriRpcStatus.UNIMPLEMENTED.withDescription(\"Bad path format:\" + path)); return; } String serviceName = parts[1]; String originalMethodName = parts[2]; // ä» pathResolver ä¸­è·å– invoker Invoker\u003c?\u003e invoker = getInvoker(headers, serviceName); ... // headers è½¬æ¢ä¸º map Map\u003cString, Object\u003e requestMetadata = headersToMap(headers, () -\u003e { return Optional.ofNullable(headers.get(TripleHeaderEnum.TRI_HEADER_CONVERT.getHeader())) .map(CharSequence::toString) .orElse(null); }); boolean hasStub = pathResolver.hasNativeStub(path); if (hasStub) { listener = new StubAbstractServerCall(invoker, TripleServerStream.this, frameworkModel, acceptEncoding, serviceName, originalMethodName, executor); } else { // å¸¸ç”¨çš„å°±æ˜¯è¿™ä¸ªï¼Œä¸‹é¢ä»¥è¿™ä¸ªä¸ºä¾‹å­ listener = new ReflectionAbstractServerCall(invoker, TripleServerStream.this, frameworkModel, acceptEncoding, serviceName, originalMethodName, filters, executor); } // must before onHeader deframer = new TriDecoder(deCompressor, new ServerDecoderListener(listener)); // æ ¹æ® methodDescriptor æ¥è·å–æœ€ç»ˆè°ƒç”¨çš„ listenerï¼Œéå¸¸é‡è¦ listener.onHeader(requestMetadata); } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.call.AbstractServerCall#onHeader @Override public void onHeader(Map\u003cString, Object\u003e requestMetadata) { this.requestMetadata = requestMetadata; ... startCall(); } // æ³¨æ„ startCall åº”è¯¥è°ƒç”¨å­ç±»çš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¿½ç•¥ï¼Œç›´æ¥åˆ†æçˆ¶ç±»çš„æ–¹æ³•é€»è¾‘ protected void startCall() { // æ„å»º RpcInvocation RpcInvocation invocation = buildInvocation(methodDescriptor); // éå¸¸é‡è¦ listener = startInternalCall(invocation, methodDescriptor, invoker); } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.call.AbstractServerCall#startInternalCall è®¾ç½®è°ƒç”¨ç›‘å¬å™¨, æ¯”å¦‚ UnaryServerCallListener, ServerStreamServerCallListener, BiStreamServerCallListener protected ServerCall.Listener startInternalCall( RpcInvocation invocation, MethodDescriptor methodDescriptor, Invoker\u003c?\u003e invoker) { this.cancellationContext = RpcContext.getCancellationContext(); ServerCallToObserverAdapter\u003cObject\u003e responseObserver = new ServerCallToObserverAdapter\u003c\u003e(this, cancellationContext); try { ServerCall.Listener listener; switch (methodDescriptor.getRpcType()) { case UNARY: listener = new UnaryServerCallListener(invocation, invoker, responseObserver, packableMethod.needWrapper()); request(2); break; case SERVER_STREAM: listener = new ServerStreamServerCallListener(invocation, invoker, responseObserver); request(2); break; case BI_STREAM: case CLIENT_STREAM: listener = new BiStreamServerCallListener(invocation, invoker, responseObserver); request(1); break; de","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" refer å¼•ç”¨æœåŠ¡æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.TripleProtocol#refer @Override public \u003cT\u003e Invoker\u003cT\u003e refer(Class\u003cT\u003e type, URL url) throws RpcException { // åºåˆ—åŒ–ä¼˜åŒ–ï¼Œä¸ç”¨å…³å¿ƒ optimizeSerialization(url); ExecutorService streamExecutor = getOrCreateStreamExecutor( url.getOrDefaultApplicationModel(), url); // è¿æ¥ç«¯å£ï¼Œæ³¨æ„ DefaultPuHandler æ˜¯ç©ºå®ç°ï¼Œè¿™æ˜¯å’Œ DubboProtocol å®ç°çš„ä¸»è¦åŒºåˆ« AbstractConnectionClient connectionClient = PortUnificationExchanger.connect(url, new DefaultPuHandler()); // åŒ…è£…ä¸º tripleInvoker TripleInvoker\u003cT\u003e invoker = new TripleInvoker\u003c\u003e(type, url, acceptEncodings, connectionClient, invokers, streamExecutor); invokers.add(invoker); return invoker; } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyPortUnificationTransporter#connect // PortUnificationExchanger#connect æœ€ç»ˆä¼šè°ƒç”¨æ­¤æ–¹æ³• @Override public AbstractConnectionClient connect(URL url, ChannelHandler handler) throws RemotingException { ConnectionManager manager = url.getOrDefaultFrameworkModel().getExtensionLoader(ConnectionManager.class).getExtension(MultiplexProtocolConnectionManager.NAME); // è¿æ¥, æœ€ç»ˆä¼šè°ƒç”¨ NettyConnectionManager#connect æ–¹æ³• return manager.connect(url, handler); } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyConnectionManager#connect // åœ¨ NettyConnectionClient çš„çˆ¶ç±»æ„é€ æ–¹æ³•ä¸­ä¼šè°ƒç”¨ doOpen å’Œ doConnect æ–¹æ³• @Override public AbstractConnectionClient connect(URL url, ChannelHandler handler) { try { return new NettyConnectionClient(url, handler); } catch (RemotingException e) { throw new RuntimeException(e); } } æºç ä½ç½®: org.apache.dubbo.remoting.transport.netty4.NettyConnectionClient#doOpen @Override protected void doOpen() throws Throwable { initConnectionClient(); // åˆå§‹åŒ– netty çš„ bootstrap, è®¾ç½®äº† http2 çš„ç¼–è§£ç  initBootstrap(); } @Override protected void doConnect() throws RemotingException { ... createConnectingPromise(); // è¿æ¥ç«¯å£ final ChannelFuture promise = bootstrap.connect(); ...å¿½ç•¥é”™è¯¯å¤„ç†é€»è¾‘ } ","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" TripleInvoker å½“å®¢æˆ·ç«¯è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°±ä¼šæ‰§è¡Œ TripleInvoker#doInvoke æ–¹æ³•, æ¥ä¸‹æ¥åˆ†æè¿™éƒ¨åˆ†é€»è¾‘ã€‚ æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.TripleInvoker#doInvoke // æ ¹æ®ä¸åŒçš„æ–¹å¼æ¥è°ƒç”¨ï¼Œæ¯”å¦‚ invokeUnary, invokeServerStream, invokeBiOrClientStream @Override protected Result doInvoke(final Invocation invocation) { ... ClientCall call = new TripleClientCall(connectionClient, callbackExecutor, getUrl().getOrDefaultFrameworkModel(), writeQueue); AsyncRpcResult result; try { switch (methodDescriptor.getRpcType()) { case UNARY: // é‡ç‚¹åˆ†æè¿™ä¸ª result = invokeUnary(methodDescriptor, invocation, call, callbackExecutor); break; case SERVER_STREAM: result = invokeServerStream(methodDescriptor, invocation, call); break; case CLIENT_STREAM: case BI_STREAM: result = invokeBiOrClientStream(methodDescriptor, invocation, call); break; default: throw new IllegalStateException(\"Can not reach here\"); } return result; } catch (Throwable t) { ...çœç•¥å¤„ç†é”™è¯¯é€»è¾‘ } } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.TripleInvoker#invokeUnary // ä¸€å…ƒè¯·æ±‚é€»è¾‘ AsyncRpcResult invokeUnary(MethodDescriptor methodDescriptor, Invocation invocation, ClientCall call, ExecutorService callbackExecutor) { ... final AsyncRpcResult result; DeadlineFuture future = DeadlineFuture.newFuture(getUrl().getPath(), methodDescriptor.getMethodName(), getUrl().getAddress(), timeout, callbackExecutor); RequestMetadata request = createRequest(methodDescriptor, invocation, timeout); final Object pureArgument; // å°è£…å‚æ•° if (methodDescriptor instanceof StubMethodDescriptor) { pureArgument = invocation.getArguments()[0]; } else { if (methodDescriptor.isGeneric()) { Object[] args = new Object[3]; args[0] = RpcUtils.getMethodName(invocation); args[1] = Arrays.stream(RpcUtils.getParameterTypes(invocation)).map(Class::getName).collect(Collectors.toList()); args[2] = RpcUtils.getArguments(invocation); pureArgument = args; } else { pureArgument = invocation.getArguments(); } } result = new AsyncRpcResult(future, invocation); ... ClientCall.Listener callListener = new UnaryClientCallListener(future); // start æ–¹æ³•éå¸¸é‡è¦ï¼Œåˆ›å»ºäº† TripleClientStream, å¹¶è®¾ç½® channelHandler final StreamObserver\u003cObject\u003e requestObserver = call.start(request, callListener); // å‘é€è¯·æ±‚ requestObserver.onNext(pureArgument); requestObserver.onCompleted(); return result; } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.call.TripleClientCall#start @Override public StreamObserver\u003cObject\u003e start(RequestMetadata metadata, ClientCall.Listener responseListener) { this.requestMetadata = metadata; this.listener = responseListener; // åœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨ initHttp2StreamChannel æ–¹æ³• this.stream = new TripleClientStream(frameworkModel, executor, (Channel) connectionClient.getChannel(true), this, writeQueue); return new ClientCallToObserverAdapter\u003c\u003e(this); } æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.stream.TripleClientStream#initHttp2StreamChannel // åˆå§‹åŒ– http2 stream çš„ channelHandler private TripleStreamChannelFuture initHttp2StreamChannel(Channel parent) { TripleStreamChannelFuture streamChannelFuture = new TripleStreamChannelFuture(parent); Http2StreamChannelBootstrap bootstrap = new Http2StreamChannelBootstrap(parent); bootstrap.handler(new ChannelInboundHandlerAdapter() { @Override public void handlerAdded(ChannelHandlerContext ctx) throws Exception { Channel channel = ctx.channel(); // è´Ÿè´£å‘é€è¯·æ±‚ channel.pipeline().addLast(new TripleCommandOutBoundHandler()); // è´Ÿè´£æ¥å—å“åº” channel.pipeline().addLast(new TripleHttp2ClientResponseHandler(createTransportListener())); } }); CreateStreamQueueCommand cmd = CreateStreamQueueCommand.create(bootstrap, streamChannelFuture); this.writeQueue.enqueue(cmd); return streamChannelFuture; } ","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:4:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" TripleHttp2ClientResponseHandler æ¥å—æœåŠ¡ç«¯çš„æ¶ˆæ¯ æºç ä½ç½®: org.apache.dubbo.rpc.protocol.tri.transport.TripleHttp2ClientResponseHandler#channelRead0 // è´Ÿè´£æ¥å—å“åº” protected void channelRead0(ChannelHandlerContext ctx, Http2StreamFrame msg) throws Exception { if (msg instanceof Http2HeadersFrame) { final Http2HeadersFrame headers = (Http2HeadersFrame) msg; transportListener.onHeader(headers.headers(), headers.isEndStream()); } else if (msg instanceof Http2DataFrame) { final Http2DataFrame data = (Http2DataFrame) msg; transportListener.onData(data.content(), data.isEndStream()); } else { super.channelRead(ctx, msg); } } ","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:5:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»org.apache.dubbo.rpc.protocol.tri.TripleProtocolTest#testDemoProtocol åœ¨è°ƒè¯•è¿‡ç¨‹ï¼Œå¯èƒ½ä¼šå‡ºç°è¶…æ—¶ï¼Œå¯ä»¥æ·»åŠ ä¸‹é¢ä»£ç æ¥è§£å†³ã€‚ URL consumerUrl = URL.valueOf( \"tri://127.0.0.1:\" + availablePort + \"/\" + IGreeter.class.getName()); // æ·»åŠ ä¸‹é¢ä»£ç  RpcContext.getClientAttachment().getObjectAttachments().put(\"timeout\", 180000); ","date":"2023-12-07","objectID":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/:6:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"10 triple åè®®","uri":"/ooooo-notes/10-triple-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ æ¥å£çº§åˆ«å¼•ç”¨æ˜¯ dubbo 2.x ç‰ˆæœ¬çš„æ–¹å¼ï¼Œå…¶ä¸»æµç¨‹å’Œä¹‹å‰çš„ç« èŠ‚ã€å¼•ç”¨æœåŠ¡ã€‘æ²¡æœ‰å·®åˆ«ï¼Œä¸»è¦åŒºåˆ«åœ¨äºæ³¨å†Œä¸­å¿ƒçš„é€»è¾‘ä¸ä¸€æ ·ã€‚ ","date":"2023-12-06","objectID":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"08 å¼•ç”¨æœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" RegistryProtocol#doCreateInvoker åˆ›å»º invokeræºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#doCreateInvoker protected \u003cT\u003e ClusterInvoker\u003cT\u003e doCreateInvoker(DynamicDirectory\u003cT\u003e directory, Cluster cluster, Registry registry, Class\u003cT\u003e type) { directory.setRegistry(registry); directory.setProtocol(protocol); ... directory.buildRouterChain(urlToRegistry); // è®¢é˜… url, directory å®ç°ç±» ä¸º RegistryDirectory directory.subscribe(toSubscribeUrl(urlToRegistry)); return (ClusterInvoker\u003cT\u003e) cluster.join(directory, true); } æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryDirectory#subscribe @Override public void subscribe(URL url) { ... ApplicationModel applicationModel = url.getApplicationModel(); String registryClusterName = registry.getUrl().getParameter(RegistryConstants.REGISTRY_CLUSTER_KEY, registry.getUrl().getParameter(PROTOCOL_KEY)); MetricsEventBus.post(RegistryEvent.toSubscribeEvent(applicationModel,registryClusterName), () -\u003e { // è°ƒç”¨çˆ¶ç±» DynamicDirectory#subscribe super.subscribe(url); return null; } ); // å¼€å¯é…ç½®ç›‘å¬ï¼Œä¸è§£æ if (moduleModel.modelEnvironment().getConfiguration().convert(Boolean.class, org.apache.dubbo.registry.Constants.ENABLE_CONFIGURATION_LISTEN, true)) { consumerConfigurationListener.addNotifyListener(this); referenceConfigurationListener = new ReferenceConfigurationListener(moduleModel, this, url); } } æºç ä½ç½®: org.apache.dubbo.registry.integration.DynamicDirectory#subscribe public void subscribe(URL url) { setSubscribeUrl(url); // è¿™é‡Œä»¥ ZookeeperRegistry ä¸ºä¾‹ registry.subscribe(url, this); } ","date":"2023-12-06","objectID":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"08 å¼•ç”¨æœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" ZookeeperRegistry#subscribe è®¢é˜…æœåŠ¡æºç ä½ç½®: `` @Override public void subscribe(URL url, NotifyListener listener) { ... // ç§»é™¤ url removeFailedSubscribed(url, listener); try { // Sending a subscription request to the server side // è°ƒç”¨å­ç±»çš„è®¢é˜…æ–¹æ³•ï¼Œè¿™é‡Œä»¥ ZookeeperRegistry ä¸ºä¾‹ doSubscribe(url, listener); } catch (Exception e) { Throwable t = e; List\u003cURL\u003e urls = getCacheUrls(url); if (CollectionUtils.isNotEmpty(urls)) { notify(url, listener, urls); } else { // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) \u0026\u0026 url.getParameter(Constants.CHECK_KEY, true); boolean skipFailback = t instanceof SkipFailbackWrapperException; // æ£€æŸ¥ check å‚æ•°ï¼Œå¦‚æœä¸º trueï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡è®¢é˜…æœåŠ¡è¦æˆåŠŸ if (check || skipFailback) { if (skipFailback) { t = t.getCause(); } throw new IllegalStateException(\"Failed to subscribe \" + url + \", cause: \" + t.getMessage(), t); } else { logger.error(REGISTRY_FAILED_NOTIFY_EVENT, \"\", \"\", \"Failed to subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); } } // è®°å½•å¤±è´¥çš„urlï¼Œ ç¨åå®šæ—¶ä»»åŠ¡ä¼šå†æ¬¡è®¢é˜… addFailedSubscribed(url, listener); } } æºç ä½ç½®: org.apache.dubbo.registry.zookeeper.ZookeeperRegistry#doSubscribe @Override public void doSubscribe(final URL url, final NotifyListener listener) { try { checkDestroyed(); // è®¢é˜…æ‰€æœ‰æ¥å£ï¼Œdubbo-admin æœåŠ¡ä¼šä½¿ç”¨ï¼Œè¿™ä¸ªä¸åˆ†æ if (ANY_VALUE.equals(url.getServiceInterface())) { ... } else { CountDownLatch latch = new CountDownLatch(1); try { List\u003cURL\u003e urls = new ArrayList\u003c\u003e(); /* Iterate over the category value in URL. With default settings, the path variable can be when url is a consumer URL: /dubbo/[service name]/providers, /dubbo/[service name]/configurators /dubbo/[service name]/routers */ // ç›‘å¬æ¯ä¸€ä¸ªè·¯å¾„ for (String path : toCategoriesPath(url)) { ConcurrentMap\u003cNotifyListener, ChildListener\u003e listeners = ConcurrentHashMapUtils.computeIfAbsent(zkListeners, url, k -\u003e new ConcurrentHashMap\u003c\u003e()); // è¿™é‡ŒæŠŠ listener æ·»åŠ è¿›å»äº†ï¼Œç­‰ url æ›´æ”¹æ—¶ï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•° ChildListener zkListener = ConcurrentHashMapUtils.computeIfAbsent(listeners, listener, k -\u003e new RegistryChildListenerImpl(url, k, latch)); if (zkListener instanceof RegistryChildListenerImpl) { // latch ä¸ºäº†ç›‘å¬åˆ° urls æ—¶ï¼Œé€šçŸ¥ä¸»çº¿ç¨‹ ((RegistryChildListenerImpl) zkListener).setLatch(latch); } // åˆ›å»ºæ ¹è·¯å¾„ï¼Œæ¯”å¦‚ /dubbo/${interfaceName}/consumers zkClient.create(path, false, true); // è·å–æ‰€æœ‰çš„å­è·¯å¾„ï¼Œç”¨äºç¬¬ä¸€æ¬¡åˆå§‹åŒ– urls List\u003cString\u003e children = zkClient.addChildListener(path, zkListener); if (children != null) { // The invocation point that may cause 1-1. urls.addAll(toUrlsWithEmpty(url, path, children)); } } // æ‰§è¡Œå›è°ƒå‡½æ•° notify(url, listener, urls); } finally { // tells the listener to run only after the sync notification of main thread finishes. latch.countDown(); } } } catch (Throwable e) { ... } } ","date":"2023-12-06","objectID":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"08 å¼•ç”¨æœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/08-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ æ¥å£çº§åˆ«å¯¼å‡ºæ˜¯ dubbo 2.x ç‰ˆæœ¬çš„æ–¹å¼ï¼Œå…¶ä¸»æµç¨‹å’Œä¹‹å‰çš„ç« èŠ‚ã€å¯¼å‡ºæœåŠ¡ã€‘æ²¡æœ‰å·®åˆ«ï¼Œä¸»è¦åŒºåˆ«åœ¨äºæ³¨å†Œä¸­å¿ƒçš„é€»è¾‘ä¸ä¸€æ ·ã€‚ ","date":"2023-12-05","objectID":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"07 å¯¼å‡ºæœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" RegistryProtocol#export å¯¼å‡ºæœåŠ¡æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#export @Override public \u003cT\u003e Exporter\u003cT\u003e export(final Invoker\u003cT\u003e originInvoker) throws RpcException { ... // è·å– registryï¼Œæ¯”å¦‚ ZookeeperRegistry (æ¥å£çº§æ³¨å†Œ) final Registry registry = getRegistry(registryUrl); final URL registeredProviderUrl = getUrlToRegistry(providerUrl, registryUrl); // decide if we need to delay publish (provider itself and registry should both need to register) // å¦‚æœæ˜¯æ¥å£çº§åˆ«ï¼Œregister ä¸º true boolean register = providerUrl.getParameter(REGISTER_KEY, true) \u0026\u0026 registryUrl.getParameter(REGISTER_KEY, true); if (register) { // æ³¨å†Œ providerUrlï¼Œæœ€ç»ˆè°ƒç”¨ ZookeeperRegistry#registry æ–¹æ³• register(registry, registeredProviderUrl); } ... return new DestroyableExporter\u003c\u003e(exporter); } ","date":"2023-12-05","objectID":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"07 å¯¼å‡ºæœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" ZookeeperRegistry#register æ³¨å†ŒæœåŠ¡æºç ä½ç½®: org.apache.dubbo.registry.support.FailbackRegistry#register // æ³¨å†Œ url, è¿™ä¸ªç±»æ˜¯ ZookeeperRegistry çš„ çˆ¶ç±» @Override public void register(URL url) { ... super.register(url); // ç§»é™¤ url removeFailedRegistered(url); removeFailedUnregistered(url); try { // Sending a registration request to the server side // è°ƒç”¨å­ç±»çš„æ³¨å†Œæ–¹æ³•, è¿™é‡Œä»¥ ZookeeperRegistry ä¸ºä¾‹ doRegister(url); } catch (Exception e) { Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) \u0026\u0026 url.getParameter(Constants.CHECK_KEY, true) \u0026\u0026 (url.getPort() != 0); boolean skipFailback = t instanceof SkipFailbackWrapperException; // æ£€æŸ¥ check å‚æ•°ï¼Œå¦‚æœæ˜¯ trueï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡ä¸€å®šè¦æ³¨å†ŒæˆåŠŸ if (check || skipFailback) { if (skipFailback) { t = t.getCause(); } throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t); } else { logger.error(INTERNAL_ERROR, \"unknown error in registry module\", \"\", \"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); } // Record a failed registration request to a failed list, retry regularly // æ·»åŠ å¤±è´¥çš„ urlï¼Œç¨åå®šæ—¶ä»»åŠ¡ä¼šé‡æ–°æ³¨å†Œ addFailedRegistered(url); } } æºç ä½ç½®: org.apache.dubbo.registry.zookeeper.ZookeeperRegistry#doRegister @Override public void doRegister(URL url) { try { checkDestroyed(); // åˆ›å»º zookeeper ä¸´æ—¶èŠ‚ç‚¹ï¼Œ è·¯å¾„ä¸º /dubbo/${interfaceName}/providers/ zkClient.create(toUrlPath(url), url.getParameter(DYNAMIC_KEY, true), true); } catch (Throwable e) { throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); } } ","date":"2023-12-05","objectID":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"07 å¯¼å‡ºæœåŠ¡ï¼ˆæ¥å£çº§åˆ«ï¼‰","uri":"/ooooo-notes/07-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BA%A7%E5%88%AB/"},{"categories":null,"content":" ä¸ºä»€ä¹ˆå­¦ç°åœ¨å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿéƒ½ä¼šä½¿ç”¨åˆ°åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œæ¯”å¦‚ nacosã€zookeeperã€consulã€etcdã€tikv ç­‰ç­‰ï¼Œè€Œ raft å¯ä»¥è¯´æ˜¯æœ€ç®€å•çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ã€‚ ","date":"2023-12-05","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-raft/:1:0","tags":["raft","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ raft","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-raft/"},{"categories":null,"content":" æ€ä¹ˆå­¦ raft åè®®åŠ¨ç”»æ¼”ç¤º raft åè®®è®ºæ–‡ æ‰¾ä¸€ä¸ª raft åè®®çš„æºç å®ç°ï¼Œæ¯”å¦‚ consul-raft åŠ¨æ‰‹å®ç° raft åè®® ~ MITè¯¾ç¨‹ ","date":"2023-12-05","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-raft/:2:0","tags":["raft","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ raft","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-raft/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo ä¸­å¼•ç”¨æœåŠ¡çš„æºç æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œåªä»‹ç»ä¸»è¦æµç¨‹ã€‚ ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" DefaultModuleDeployer#referServices å¼•ç”¨æœåŠ¡æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultModuleDeployer#referServices private void referServices() { // éå†æ‰€æœ‰çš„ reference configManager.getReferences().forEach(rc -\u003e { try { ReferenceConfig\u003c?\u003e referenceConfig = (ReferenceConfig\u003c?\u003e) rc; // åˆ·æ–°é…ç½® if (!referenceConfig.isRefreshed()) { referenceConfig.refresh(); } if (rc.shouldInit()) { // å¼‚æ­¥å¼•ç”¨ if (referAsync || rc.shouldReferAsync()) { ExecutorService executor = executorRepository.getServiceReferExecutor(); CompletableFuture\u003cVoid\u003e future = CompletableFuture.runAsync(() -\u003e { try { referenceCache.get(rc, false); } catch (Throwable t) { logger.error(CONFIG_FAILED_EXPORT_SERVICE, \"\", \"\", \"Failed to async export service config: \" + getIdentifier() + \" , catch error : \" + t.getMessage(), t); } }, executor); asyncReferringFutures.add(future); } else { // åŒæ­¥å¼•ç”¨ referenceCache.get(rc, false); } } } catch (Throwable t) { ... } }); } æºç ä½ç½®: org.apache.dubbo.config.utils.SimpleReferenceCache#get // åŒæ­¥å¼•ç”¨ public \u003cT\u003e T get(ReferenceConfigBase\u003cT\u003e rc, boolean check) { String key = generator.generateKey(rc); Class\u003c?\u003e type = rc.getInterfaceClass(); boolean singleton = rc.getSingleton() == null || rc.getSingleton(); T proxy = null; // Check existing proxy of the same 'key' and 'type' first. if (singleton) { // å•ä¾‹å¯¹è±¡ï¼Œä»ç¼“å­˜ referenceKeyMap ä¸­è·å– proxy = get(key, (Class\u003cT\u003e) type); } else { logger.warn(CONFIG_API_WRONG_USE, \"\", \"\", \"Using non-singleton ReferenceConfig and ReferenceCache at the same time may cause memory leak. \" + \"Call ReferenceConfig#get() directly for non-singleton ReferenceConfig instead of using ReferenceCache#get(ReferenceConfig)\"); } // ç¬¬ä¸€æ¬¡è·å– if (proxy == null) { // æ·»åŠ åˆ° referenceTypeMap List\u003cReferenceConfigBase\u003c?\u003e\u003e referencesOfType = ConcurrentHashMapUtils.computeIfAbsent(referenceTypeMap, type, _t -\u003e Collections.synchronizedList(new ArrayList\u003c\u003e())); referencesOfType.add(rc); // æ·»åŠ åˆ° referenceKeyMap List\u003cReferenceConfigBase\u003c?\u003e\u003e referenceConfigList = ConcurrentHashMapUtils.computeIfAbsent(referenceKeyMap, key, _k -\u003e Collections.synchronizedList(new ArrayList\u003c\u003e())); referenceConfigList.add(rc); // è·å–ä»£ç†å¯¹è±¡ proxy = rc.get(check); } return proxy; } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ReferenceConfig#get è·å–ä»£ç†å¯¹è±¡æºç ä½ç½®: org.apache.dubbo.config.ReferenceConfig#get // è·å–ä»£ç†å¯¹è±¡ public T get(boolean check) { ... if (ref == null) { if (getScopeModel().isLifeCycleManagedExternally()) { // prepare model for reference getScopeModel().getDeployer().prepare(); } else { // ensure start module, compatible with old api usage // å¯åŠ¨æ¨¡å— getScopeModel().getDeployer().start(); } // åˆå§‹åŒ– init(check); } return ref; } æºç ä½ç½®: org.apache.dubbo.config.ReferenceConfig#init // åˆå§‹åŒ– protected synchronized void init(boolean check) { if (initialized \u0026\u0026 ref != null) { return; } try { // åˆ·æ–°é…ç½® if (!this.isRefreshed()) { this.refresh(); } //auto detect proxy type String proxyType = getProxy(); if (StringUtils.isBlank(proxyType) \u0026\u0026 DubboStub.class.isAssignableFrom(interfaceClass)) { setProxy(CommonConstants.NATIVE_STUB); } // init serviceMetadata initServiceMetadata(consumer); serviceMetadata.setServiceType(getServiceInterfaceClass()); // TODO, uncomment this line once service key is unified serviceMetadata.generateServiceKey(); // æ·»åŠ é…ç½®ï¼Œå¦‚ application, consumer, interface Map\u003cString, String\u003e referenceParameters = appendConfig(); ModuleServiceRepository repository = getScopeModel().getServiceRepository(); ServiceDescriptor serviceDescriptor; if (CommonConstants.NATIVE_STUB.equals(getProxy())) { serviceDescriptor = StubSuppliers.getServiceDescriptor(interfaceName); repository.registerService(serviceDescriptor); } else { serviceDescriptor = repository.registerService(interfaceClass); } // åˆ›å»º consumerModel consumerModel = new ConsumerModel(serviceMetadata.getServiceKey(), proxy, serviceDescriptor, getScopeModel(), serviceMetadata, createAsyncMethodInfo(), interfaceClassLoader); // Compatible with dependencies on ServiceModel#getReferenceConfig() , and will be removed in a future version. consumerModel.setConfig(this); // æ³¨å†Œ consumerModel repository.registerConsumer(consumerModel); serviceMetadata.getAttachments().putAll(referenceParameters); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªæœ€é‡è¦ ref = createProxy(referenceParameters); serviceMetadata.setTarget(ref); serviceMetadata.addAttribute(PROXY_CLASS_REF, ref); // è®¾ç½®é”€æ¯å›è°ƒå‡½æ•° consumerModel.setDestroyRunner(getDestroyRunner()); consumerModel.setProxyObject(ref); consumerModel.initMethodModels(); // æ£€æŸ¥å¯ç”¨æ€§ï¼Œdubbo3 é»˜è®¤ä¸º false if (check) { checkInvokerAvailable(0); } } catch (Throwable t) { logAndCleanup(t); throw t; } // æ ‡è®°å·²åˆå§‹åŒ– initialized = true; } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:1","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ReferenceConfig#createProxy åˆ›å»ºä»£ç†æºç ä½ç½®: org.apache.dubbo.config.ReferenceConfig#createProxy // åˆ›å»ºä»£ç†å¯¹è±¡ private T createProxy(Map\u003cString, String\u003e referenceParameters) { urls.clear(); // mesh mode è¿™ä¸€èŠ‚ä¸è§£æï¼Œä»¥åä¼šç»§ç»­è§£æ meshModeHandleUrl(referenceParameters); if (StringUtils.isNotEmpty(url)) { // user specified URL, could be peer-to-peer address, or register center's address. // url ä¸ä¸ºç©º, è¯´æ˜æ˜¯ç›´è¿ parseUrl(referenceParameters); } else { // if protocols not in jvm checkRegistry // ä»æ³¨å†Œä¸­å¿ƒæ¥è·å– urls aggregateUrlFromRegistry(referenceParameters); } // æ ¹æ® urls æ¥åˆ›å»º invoker createInvoker(); ... // å‘å¸ƒæœåŠ¡å®šä¹‰ MetadataUtils.publishServiceDefinition(consumerUrl, consumerModel.getServiceModel(), getApplicationModel()); // create service proxy // è·å–ä»£ç†å¯¹è±¡ return (T) proxyFactory.getProxy(invoker, ProtocolUtils.isGeneric(generic)); } æºç ä½ç½®: org.apache.dubbo.config.ReferenceConfig#aggregateUrlFromRegistry // é€šè¿‡æ³¨å†Œä¸­å¿ƒæ¥è·å– urls private void aggregateUrlFromRegistry(Map\u003cString, String\u003e referenceParameters) { checkRegistry(); // åŠ è½½æ‰€æœ‰çš„æ³¨å†Œä¸­å¿ƒ List\u003cURL\u003e us = ConfigValidationUtils.loadRegistries(this, false); if (CollectionUtils.isNotEmpty(us)) { // éå†æ‰€æœ‰çš„æ³¨å†Œä¸­å¿ƒåœ°å€ for (URL u : us) { // åŠ è½½ç›‘æ§åœ°å€ URL monitorUrl = ConfigValidationUtils.loadMonitor(this, u); if (monitorUrl != null) { u = u.putAttribute(MONITOR_KEY, monitorUrl); } u = u.setScopeModel(getScopeModel()); u = u.setServiceModel(consumerModel); if (isInjvm() != null \u0026\u0026 isInjvm()) { u = u.addParameter(LOCAL_PROTOCOL, true); } // æŠŠ referenceParameters æ·»åŠ åˆ° registryUrl çš„ REFER_KEY å‚æ•°ä¸­ urls.add(u.putAttribute(REFER_KEY, referenceParameters)); } } ... } æºç ä½ç½®: org.apache.dubbo.config.ReferenceConfig#createInvoker // æ ¹æ® urls æ¥åˆ›å»º invoker // ä¸€ä¸ª url è¡¨ç¤ºä¸€ç§æ³¨å†Œä¸­å¿ƒ private void createInvoker() { // å•æ³¨å†Œä¸­å¿ƒ if (urls.size() == 1) { URL curUrl = urls.get(0); // åˆ©ç”¨ SPI æœºåˆ¶ç”Ÿæˆå¯¹åº”çš„ invoker, è¿™æ—¶ url æ˜¯ registryUrl, æ‰€ä»¥å®ç°ç±»å°±æ˜¯ RegistryProtocol invoker = protocolSPI.refer(interfaceClass, curUrl); // registry url, mesh-enable and unloadClusterRelated is true, not need Cluster. if (!UrlUtils.isRegistry(curUrl) \u0026\u0026 !curUrl.getParameter(UNLOAD_CLUSTER_RELATED, false)) { List\u003cInvoker\u003c?\u003e\u003e invokers = new ArrayList\u003c\u003e(); invokers.add(invoker); invoker = Cluster.getCluster(getScopeModel(), Cluster.DEFAULT).join(new StaticDirectory(curUrl, invokers), true); } } else { // å¤šæ³¨å†Œä¸­å¿ƒ List\u003cInvoker\u003c?\u003e\u003e invokers = new ArrayList\u003c\u003e(); URL registryUrl = null; for (URL url : urls) { // For multi-registry scenarios, it is not checked whether each referInvoker is available. // Because this invoker may become available later. // æ¯ä¸ª url éƒ½æ˜¯åˆ›å»ºä¸€ä¸ª invoker invokers.add(protocolSPI.refer(interfaceClass, url)); if (UrlUtils.isRegistry(url)) { // use last registry url registryUrl = url; } } ...çœç•¥ invokers èšåˆçš„ä»£ç  } } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:2","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" RegistryProtocol#refer å¼•ç”¨æœåŠ¡æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#refer // å¼•ç”¨æœåŠ¡ @Override @SuppressWarnings(\"unchecked\") public \u003cT\u003e Invoker\u003cT\u003e refer(Class\u003cT\u003e type, URL url) throws RpcException { url = getRegistryUrl(url); // è·å–æ³¨å†Œä¸­å¿ƒ Registry registry = getRegistry(url); if (RegistryService.class.equals(type)) { return proxyFactory.getInvoker((T) registry, type, url); } // qs æ˜¯ consumer é…ç½®, åœ¨ä¹‹å‰å·²ç»æŠŠ consumer çš„é…ç½®å­˜å…¥ REFER_KEY ä¸­ Map\u003cString, String\u003e qs = (Map\u003cString, String\u003e) url.getAttribute(REFER_KEY); ... // è·å– clusterï¼Œé»˜è®¤æ˜¯ failover Cluster cluster = Cluster.getCluster(url.getScopeModel(), qs.get(CLUSTER_KEY)); // å¼•ç”¨æœåŠ¡ return doRefer(cluster, registry, type, url, qs); } æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#doRefer // å¼•ç”¨æœåŠ¡ protected \u003cT\u003e Invoker\u003cT\u003e doRefer(Cluster cluster, Registry registry, Class\u003cT\u003e type, URL url, Map\u003cString, String\u003e parameters) { Map\u003cString, Object\u003e consumerAttribute = new HashMap\u003c\u003e(url.getAttributes()); consumerAttribute.remove(REFER_KEY); String p = isEmpty(parameters.get(PROTOCOL_KEY)) ? CONSUMER : parameters.get(PROTOCOL_KEY); // æ„å»º consumerUrl URL consumerUrl = new ServiceConfigURL( p, null, null, parameters.get(REGISTER_IP_KEY), 0, getPath(parameters, type), parameters, consumerAttribute ); url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl); // å®ç°ç±»ä¸º ServiceDiscoveryMigrationInvoker ClusterInvoker\u003cT\u003e migrationInvoker = getMigrationInvoker(this, cluster, registry, type, url, consumerUrl); // æ‰§è¡Œ RegistryProtocolListener é’©å­å‡½æ•°ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ MigrationRuleListener#onRefer æ–¹æ³• return interceptInvoker(migrationInvoker, url, consumerUrl); } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:3","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" MigrationRuleListener#onRefer æ‰§è¡Œé’©å­å‡½æ•°æºç ä½ç½®: `` // æ‰§è¡Œé’©å­å‡½æ•° @Override public void onRefer(RegistryProtocol registryProtocol, ClusterInvoker\u003c?\u003e invoker, URL consumerUrl, URL registryURL) { MigrationRuleHandler\u003c?\u003e migrationRuleHandler = ConcurrentHashMapUtils.computeIfAbsent(handlers, (MigrationInvoker\u003c?\u003e) invoker, _key -\u003e { ((MigrationInvoker\u003c?\u003e) invoker).setMigrationRuleListener(this); return new MigrationRuleHandler\u003c\u003e((MigrationInvoker\u003c?\u003e) invoker, consumerUrl); }); // è¿ç§»è§„åˆ™ migrationRuleHandler.doMigrate(rule); } æºç ä½ç½®: org.apache.dubbo.registry.client.migration.MigrationRuleHandler#doMigrate // è¿ç§»è§„åˆ™ public synchronized void doMigrate(MigrationRule rule) { // è¿™é‡Œä¼šèµ°åˆ°è¿™ä¸ªåˆ†æ”¯ if (migrationInvoker instanceof ServiceDiscoveryMigrationInvoker) { // åˆ·æ–° invoker refreshInvoker(MigrationStep.FORCE_APPLICATION, 1.0f, rule); return; } ...çœç•¥è·å– step çš„ä»£ç  } æºç ä½ç½®: org.apache.dubbo.registry.client.migration.MigrationRuleHandler#refreshInvoker // åˆ·æ–° invoker private boolean refreshInvoker(MigrationStep step, Float threshold, MigrationRule newRule) { if (step == null || threshold == null) { throw new IllegalStateException(\"Step or threshold of migration rule cannot be null\"); } MigrationStep originStep = currentStep; // è¿™é‡Œçš„ step ä¸º FORCE_APPLICATION if ((currentStep == null || currentStep != step) || !currentThreshold.equals(threshold)) { boolean success = true; switch (step) { case APPLICATION_FIRST: migrationInvoker.migrateToApplicationFirstInvoker(newRule); break; case FORCE_APPLICATION: // å¼ºåˆ¶ä½¿ç”¨æœåŠ¡çº§åˆ«å¼•ç”¨ success = migrationInvoker.migrateToForceApplicationInvoker(newRule); break; case FORCE_INTERFACE: default: success = migrationInvoker.migrateToForceInterfaceInvoker(newRule); } ... return success; } // ignore if step is same with previous, will continue override rule for MigrationInvoker return true; } æºç ä½ç½®: org.apache.dubbo.registry.client.migration.MigrationInvoker#migrateToForceApplicationInvoker @Override public boolean migrateToForceApplicationInvoker(MigrationRule newRule) { CountDownLatch latch = new CountDownLatch(1); // åˆ·æ–° invoker, è¿™ä¸ªå¾ˆé‡è¦ refreshServiceDiscoveryInvoker(latch); if (invoker == null) { // invoker is absent, ignore threshold check this.currentAvailableInvoker = serviceDiscoveryInvoker; return true; } // wait and compare threshold // ç­‰å¾…åˆæ¬¡ invoker åˆ›å»ºæˆåŠŸ waitAddressNotify(newRule, latch); ... return false; } æºç ä½ç½®: `` protected void refreshServiceDiscoveryInvoker(CountDownLatch latch) { clearListener(serviceDiscoveryInvoker); // éœ€è¦åˆ·æ–° if (needRefresh(serviceDiscoveryInvoker)) { if (logger.isDebugEnabled()) { logger.debug(\"Re-subscribing instance addresses, current interface \" + type.getName()); } if (serviceDiscoveryInvoker != null) { serviceDiscoveryInvoker.destroy(); } // è·å– invoker, registryProtocol çš„å®ç°ç±»ä¸º RegistryProtocol serviceDiscoveryInvoker = registryProtocol.getServiceDiscoveryInvoker(cluster, registry, type, url); } // è®¾ç½®ç›‘å¬å™¨ setListener(serviceDiscoveryInvoker, () -\u003e { latch.countDown(); ... if (step == APPLICATION_FIRST) { calcPreferredInvoker(rule); } }); } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:4","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" RegistryProtocol#getServiceDiscoveryInvoker è·å– invokeræºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#getServiceDiscoveryInvoker // è·å– invoker public \u003cT\u003e ClusterInvoker\u003cT\u003e getServiceDiscoveryInvoker(Cluster cluster, Registry registry, Class\u003cT\u003e type, URL url) { // åˆ›å»º directory DynamicDirectory\u003cT\u003e directory = new ServiceDiscoveryRegistryDirectory\u003c\u003e(type, url); // åˆ›å»º invoker return doCreateInvoker(directory, cluster, registry, type); } æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#doCreateInvoker // åˆ›å»º invoker protected \u003cT\u003e ClusterInvoker\u003cT\u003e doCreateInvoker(DynamicDirectory\u003cT\u003e directory, Cluster cluster, Registry registry, Class\u003cT\u003e type) { directory.setRegistry(registry); directory.setProtocol(protocol); // all attributes of REFER_KEY Map\u003cString, String\u003e parameters = new HashMap\u003c\u003e(directory.getConsumerUrl().getParameters()); // åˆ›å»º consumerUrl URL urlToRegistry = new ServiceConfigURL( parameters.get(PROTOCOL_KEY) == null ? CONSUMER : parameters.get(PROTOCOL_KEY), parameters.remove(REGISTER_IP_KEY), 0, getPath(parameters, type), parameters ); urlToRegistry = urlToRegistry.setScopeModel(directory.getConsumerUrl().getScopeModel()); urlToRegistry = urlToRegistry.setServiceModel(directory.getConsumerUrl().getServiceModel()); // æ³¨å†Œ consumerUrlï¼Œæœ‰åŠ©äºæ’æŸ¥é—®é¢˜ if (directory.isShouldRegister()) { directory.setRegisteredConsumerUrl(urlToRegistry); registry.register(directory.getRegisteredConsumerUrl()); } // åˆ›å»º routerChain, ä¾‹å¦‚ TagStateRouter directory.buildRouterChain(urlToRegistry); // è®¢é˜…æœåŠ¡ directory.subscribe(toSubscribeUrl(urlToRegistry)); return (ClusterInvoker\u003cT\u003e) cluster.join(directory, true); } æºç ä½ç½®: org.apache.dubbo.registry.client.ServiceDiscoveryRegistryDirectory#subscribe // è®¢é˜…æœåŠ¡ @Override public void subscribe(URL url) { // å¼€å¯é…ç½®ç›‘å¬ï¼Œkey: ${applicationName}.configurators if (moduleModel.modelEnvironment().getConfiguration().convert(Boolean.class, Constants.ENABLE_CONFIGURATION_LISTEN, true)) { enableConfigurationListen = true; getConsumerConfigurationListener(moduleModel).addNotifyListener(this); referenceConfigurationListener = new ReferenceConfigurationListener(this.moduleModel, this, url); } else { enableConfigurationListen = false; } // è°ƒç”¨çˆ¶ç±» DynamicDirectory#subscribe super.subscribe(url); } æºç ä½ç½®: org.apache.dubbo.registry.integration.DynamicDirectory#subscribe // è®¢é˜…æœåŠ¡ public void subscribe(URL url) { setSubscribeUrl(url); // è¿™é‡Œçš„ registry æ˜¯ ServiceDiscoveryRegistry registry.subscribe(url, this); } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:5","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ServiceDiscoveryRegistry#subscribe è®¢é˜…æœåŠ¡æºç ä½ç½®: org.apache.dubbo.registry.client.ServiceDiscoveryRegistry#subscribe // è®¢é˜…æœåŠ¡ @Override public final void subscribe(URL url, NotifyListener listener) { // ä¸ç”¨è®¢é˜… if (!shouldSubscribe(url)) { // Should Not Subscribe return; } // è®¢é˜… doSubscribe(url, listener); } // è®¢é˜… @Override public void doSubscribe(URL url, NotifyListener listener) { url = addRegistryClusterKey(url); // æ·»åŠ  url åˆ° metadataInfo serviceDiscovery.subscribe(url, listener); // ä» provided-by ä¸­è§£æ serviceNames Set\u003cString\u003e mappingByUrl = ServiceNameMapping.getMappingByUrl(url); String key = ServiceNameMapping.buildMappingKey(url); // è¯´æ˜è¿™ä¸ª url æ˜¯ç¬¬ä¸€æ¬¡è®¢é˜… if (mappingByUrl == null) { // è·å–é” Lock mappingLock = serviceNameMapping.getMappingLock(key); try { mappingLock.lock(); // ä»ç¼“å­˜ä¸­è·å– url å¯¹åº”çš„ serviceNames mappingByUrl = serviceNameMapping.getMapping(url); try { // åˆ›å»º mappingListenerï¼Œå½“ mapping æ”¹å˜æ—¶ï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³• MappingListener mappingListener = new DefaultMappingListener(url, mappingByUrl, listener); // è·å– url å¯¹åº”çš„ serviceNames, å¹¶å¼€å§‹ç›‘å¬ mapping // å¯¹åº”çš„ provider æºç æ˜¯ ServiceConfig#exported æ–¹æ³• mappingByUrl = serviceNameMapping.getAndListen(this.getUrl(), url, mappingListener); mappingListeners.put(url.getProtocolServiceKey(), mappingListener); } catch (Exception e) { logger.warn(INTERNAL_ERROR, \"\", \"\", \"Cannot find app mapping for service \" + url.getServiceInterface() + \", will not migrate.\", e); } ... } finally { mappingLock.unlock(); } } // æ ¹æ® serviceNames æ¥è·å– url subscribeURLs(url, listener, mappingByUrl); } æºç ä½ç½®: org.apache.dubbo.registry.client.ServiceDiscoveryRegistry#subscribeURLs // æ ¹æ® serviceNames æ¥è·å– url protected void subscribeURLs(URL url, NotifyListener listener, Set\u003cString\u003e serviceNames) { // æ’åº serviceNames, ç”¨æ¥å½“åš key serviceNames = toTreeSet(serviceNames); String serviceNamesKey = toStringKeys(serviceNames); String serviceKey = url.getServiceKey(); logger.info(String.format(\"Trying to subscribe from apps %s for service key %s, \", serviceNamesKey, serviceKey)); // register ServiceInstancesChangedListener Lock appSubscriptionLock = getAppSubscription(serviceNamesKey); try { // åŠ é” appSubscriptionLock.lock(); ServiceInstancesChangedListener serviceInstancesChangedListener = serviceListeners.get(serviceNamesKey); if (serviceInstancesChangedListener == null) { // åˆ›å»º serviceInstancesChangedListener // å½“ serviceName ä¸‹çš„ instance å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•° serviceInstancesChangedListener = serviceDiscovery.createListener(serviceNames); // å¯¹æ¯ä¸€ä¸ª serviceName éƒ½è·å– instancesï¼Œç„¶åæ‰§è¡Œå›è°ƒå‡½æ•° for (String serviceName : serviceNames) { List\u003cServiceInstance\u003e serviceInstances = serviceDiscovery.getInstances(serviceName); if (CollectionUtils.isNotEmpty(serviceInstances)) { // è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œé‡ç‚¹åˆ†æ serviceInstancesChangedListener.onEvent(new ServiceInstancesChangedEvent(serviceName, serviceInstances)); } } // æ·»åŠ ç¼“å­˜ serviceListeners.put(serviceNamesKey, serviceInstancesChangedListener); } ... } finally { appSubscriptionLock.unlock(); } } æºç ä½ç½®: org.apache.dubbo.registry.client.event.listener.ServiceInstancesChangedListener#onEvent public void onEvent(ServiceInstancesChangedEvent event) { // åˆ¤æ–­ event if (destroyed.get() || !accept(event) || isRetryAndExpired(event)) { return; } // å¤„ç† event doOnEvent(event); } æºç ä½ç½®: org.apache.dubbo.registry.client.event.listener.ServiceInstancesChangedListener#doOnEvent // å¤„ç† event private synchronized void doOnEvent(ServiceInstancesChangedEvent event) { if (destroyed.get() || !accept(event) || isRetryAndExpired(event)) { return; } // åˆ·æ–°å®ä¾‹ refreshInstance(event); Map\u003cString, List\u003cServiceInstance\u003e\u003e revisionToInstances = new HashMap\u003c\u003e(); Map\u003cServiceInfo, Set\u003cString\u003e\u003e localServiceToRevisions = new HashMap\u003c\u003e(); // grouping all instances of this app(service name) by revision // æŒ‰ç…§ revsion æ¥åˆ†ç±» instance for (Map.Entry\u003cString, List\u003cServiceInstance\u003e\u003e entry : allInstances.entrySet()) { List\u003cServiceInstance\u003e instances = entry.getValue(); for (ServiceInstance instance : instances) { String revision = getExportedServicesRevision(instance); if (revision == null || EMPTY_RE","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:6","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ServiceDiscoveryRegistryDirectory#notify æ‰§è¡Œå›è°ƒæºç ä½ç½®: org.apache.dubbo.registry.client.ServiceDiscoveryRegistryDirectory#notify // å›è°ƒ urls @Override public synchronized void notify(List\u003cURL\u003e instanceUrls) { if (isDestroyed()) { return; } // Set the context of the address notification thread. RpcServiceContext.getServiceContext().setConsumerUrl(getConsumerUrl()); // 3.x added for extend URL address // æ‰§è¡Œ AddressListener å›è°ƒ ExtensionLoader\u003cAddressListener\u003e addressListenerExtensionLoader = getUrl().getOrDefaultModuleModel().getExtensionLoader(AddressListener.class); List\u003cAddressListener\u003e supportedListeners = addressListenerExtensionLoader.getActivateExtension(getUrl(), (String[]) null); if (supportedListeners != null \u0026\u0026 !supportedListeners.isEmpty()) { for (AddressListener addressListener : supportedListeners) { instanceUrls = addressListener.notify(instanceUrls, getConsumerUrl(), this); } } // åˆ·æ–° invoker refreshOverrideAndInvoker(instanceUrls); } ","date":"2023-11-27","objectID":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/:1:7","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"06 å¼•ç”¨æœåŠ¡","uri":"/ooooo-notes/06-%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo ä¸­å¯¼å‡ºæœåŠ¡çš„æºç æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œåªä»‹ç»ä¸»è¦æµç¨‹ã€‚ ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" DefaultModuleDeployer#exportServices å¯¼å‡ºæœåŠ¡æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultModuleDeployer#exportServices // å¯¼å‡ºæœåŠ¡ private void exportServices() { // éå† serviceConfig for (ServiceConfigBase sc : configManager.getServices()) { exportServiceInternal(sc); } } private void exportServiceInternal(ServiceConfigBase sc) { ServiceConfig\u003c?\u003e serviceConfig = (ServiceConfig\u003c?\u003e) sc; // åˆ·æ–°æœåŠ¡ if (!serviceConfig.isRefreshed()) { serviceConfig.refresh(); } if (sc.isExported()) { return; } // å¼‚æ­¥å¯¼å‡ºæœåŠ¡ if (exportAsync || sc.shouldExportAsync()) { ExecutorService executor = executorRepository.getServiceExportExecutor(); CompletableFuture\u003cVoid\u003e future = CompletableFuture.runAsync(() -\u003e { try { if (!sc.isExported()) { sc.export(); exportedServices.add(sc); } } catch (Throwable t) { logger.error(CONFIG_FAILED_EXPORT_SERVICE, \"\", \"\", \"Failed to async export service config: \" + getIdentifier() + \" , catch error : \" + t.getMessage(), t); } }, executor); asyncExportingFutures.add(future); } else { // åŒæ­¥å¯¼å‡ºæœåŠ¡ if (!sc.isExported()) { sc.export(RegisterTypeEnum.AUTO_REGISTER_BY_DEPLOYER); exportedServices.add(sc); } } } æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#export // å¯¼å‡ºæœåŠ¡ @Override public void export(RegisterTypeEnum registerType) { if (this.exported) { return; } if (getScopeModel().isLifeCycleManagedExternally()) { // prepare model for reference getScopeModel().getDeployer().prepare(); } else { // ensure start module, compatible with old api usage getScopeModel().getDeployer().start(); } synchronized (this) { if (this.exported) { return; } // åˆ·æ–°é…ç½® if (!this.isRefreshed()) { this.refresh(); } if (this.shouldExport()) { // åˆå§‹åŒ–ï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ– serviceListeners å’Œ serviceMetadata this.init(); if (shouldDelay()) { // should register if delay export // å»¶è¿Ÿå¯¼å‡º doDelayExport(); } else if (Integer.valueOf(-1).equals(getDelay()) \u0026\u0026 Boolean.parseBoolean(ConfigurationUtils.getProperty( getScopeModel(), CommonConstants.DUBBO_MANUAL_REGISTER_KEY, \"false\"))) { // should not register by default doExport(RegisterTypeEnum.MANUAL_REGISTER); } else { // å¯¼å‡ºæœåŠ¡ doExport(registerType); } } } } æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#doExport protected synchronized void doExport(RegisterTypeEnum registerType) { if (unexported) { throw new IllegalStateException(\"The service \" + interfaceClass.getName() + \" has already unexported!\"); } if (exported) { return; } if (StringUtils.isEmpty(path)) { path = interfaceName; } // å¯¼å‡º urlsï¼Œè¿™ä¸ªå¾ˆé‡è¦ doExportUrls(registerType); // æ ‡è®°å·²å¯¼å‡ºï¼Œæ‰§è¡Œ serviceNameMapping.map(url)ï¼Œè¿™ä¸ªå¾ˆé‡è¦ exported(); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" doExportUrls å¯¼å‡ºæ¥å£æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#doExportUrls // å¯¼å‡º urls // å› ä¸º dubbo æ”¯æŒå¤šåè®®æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ¯ä¸ªåè®®æ‰§è¡Œå¯¼å‡ºæœåŠ¡ private void doExportUrls(RegisterTypeEnum registerType) { // è·å– ServiceRepositoryï¼Œè°ƒç”¨çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¥è·å–æ¥å£çš„å…ƒæ•°æ®ä¿¡æ¯ ModuleServiceRepository repository = getScopeModel().getServiceRepository(); ServiceDescriptor serviceDescriptor; final boolean serverService = ref instanceof ServerService; if (serverService) { serviceDescriptor = ((ServerService) ref).getServiceDescriptor(); // æ³¨å†ŒæœåŠ¡å…ƒæ•°æ® repository.registerService(serviceDescriptor); } else { // æ³¨å†ŒæœåŠ¡å…ƒæ•°æ® serviceDescriptor = repository.registerService(getInterfaceClass()); } // åˆ›å»º ProviderModel providerModel = new ProviderModel(serviceMetadata.getServiceKey(), ref, serviceDescriptor, getScopeModel(), serviceMetadata, interfaceClassLoader); // Compatible with dependencies on ServiceModel#getServiceConfig(), and will be removed in a future version providerModel.setConfig(this); providerModel.setDestroyRunner(getDestroyRunner()); // æ³¨å†Œ provider repository.registerProvider(providerModel); // åŠ è½½æ³¨å†Œä¸­å¿ƒé…ç½®, å¾ˆé‡è¦ List\u003cURL\u003e registryURLs = ConfigValidationUtils.loadRegistries(this, true); // éå†åè®® for (ProtocolConfig protocolConfig : protocols) { String pathKey = URL.buildKey(getContextPath(protocolConfig) .map(p -\u003e p + \"/\" + path) .orElse(path), group, version); // stub service will use generated service name if (!serverService) { // In case user specified path, register service one more time to map it to path. repository.registerService(pathKey, interfaceClass); } // å¯¹æ¯ä¸ªåè®®å¯¼å‡ºæœåŠ¡ï¼Œå¾ˆé‡è¦ doExportUrlsFor1Protocol(protocolConfig, registryURLs, registerType); } // è®¾ç½® urls providerModel.setServiceUrls(urls); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:1","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" loadRegistries åŠ è½½æ³¨å†Œä¸­å¿ƒæºç ä½ç½®: org.apache.dubbo.config.utils.ConfigValidationUtils#loadRegistries // åŠ è½½æ³¨å†Œä¸­å¿ƒé…ç½® public static List\u003cURL\u003e loadRegistries(AbstractInterfaceConfig interfaceConfig, boolean provider) { // check \u0026\u0026 override if necessary List\u003cURL\u003e registryList = new ArrayList\u003c\u003e(); ApplicationConfig application = interfaceConfig.getApplication(); List\u003cRegistryConfig\u003e registries = interfaceConfig.getRegistries(); if (CollectionUtils.isNotEmpty(registries)) { // éå† registries for (RegistryConfig config : registries) { // try to refresh registry in case it is set directly by user using config.setRegistries() // åˆ·æ–°é…ç½® if (!config.isRefreshed()) { config.refresh(); } String address = config.getAddress(); if (StringUtils.isEmpty(address)) { address = ANYHOST_VALUE; } // æ˜¯å¯ç”¨çš„åœ°å€ if (!RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) { // ç»„åˆå‚æ•° Map\u003cString, String\u003e map = new HashMap\u003cString, String\u003e(); AbstractConfig.appendParameters(map, application); AbstractConfig.appendParameters(map, config); map.put(PATH_KEY, RegistryService.class.getName()); AbstractInterfaceConfig.appendRuntimeParameters(map); if (!map.containsKey(PROTOCOL_KEY)) { map.put(PROTOCOL_KEY, DUBBO_PROTOCOL); } List\u003cURL\u003e urls = UrlUtils.parseURLs(address, map); // ç»„åˆ url for (URL url : urls) { url = URLBuilder.from(url) // ä¿ç•™åŸå§‹çš„åè®®ç±»å‹ï¼Œå¯¹æœåŠ¡çº§åˆ«æ³¨å†Œæœ‰ç”¨ .addParameter(REGISTRY_KEY, url.getProtocol()) // æå–æ³¨å†Œç±»å‹ï¼Œè®¾ç½®åè®®ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œåœ¨ dubbo 3.0 æœ‰æœåŠ¡çº§åˆ«å’Œæ¥å£çº§åˆ«ä¸¤ç§æ³¨å†Œæ–¹å¼ .setProtocol(extractRegistryType(url)) .setScopeModel(interfaceConfig.getScopeModel()) .build(); // provider delay register state will be checked in RegistryProtocol#export if (provider || url.getParameter(SUBSCRIBE_KEY, true)) { registryList.add(url); } } } } } // å…¼å®¹å¤„ç†ï¼Œä¸è§£æ return genCompatibleRegistries(interfaceConfig.getScopeModel(), registryList, provider); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:2","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" doExportUrlsFor1Protocol å¯¹å•åè®®å¯¼å‡ºæºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#doExportUrlsFor1Protocol // å¯¹å•ä¸ªåè®®å¯¼å‡º private void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List\u003cURL\u003e registryURLs, RegisterTypeEnum registerType) { Map\u003cString, String\u003e map = buildAttributes(protocolConfig); // remove null key and null value map.keySet().removeIf(key -\u003e StringUtils.isEmpty(key) || StringUtils.isEmpty(map.get(key))); // init serviceMetadata attachments serviceMetadata.getAttachments().putAll(map); // æ„å»º url URL url = buildUrl(protocolConfig, map); // è®¾ç½®å•ç‹¬çš„ executor, ä¹‹åä¼šç”¨è¿™ä¸ª executor å»æ‰§è¡Œè¯·æ±‚ processServiceExecutor(url); // å¯¼å‡º url exportUrl(url, registryURLs, registerType); initServiceMethodMetrics(url); } æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#exportUrl // å¯¼å‡º url private void exportUrl(URL url, List\u003cURL\u003e registryURLs, RegisterTypeEnum registerType) { // è·å– scope, scope åˆ†ä¸º remote å’Œ local, é»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸¤ç§éƒ½ä¼šå¯¼å‡º String scope = url.getParameter(SCOPE_KEY); // don't export when none is configured if (!SCOPE_NONE.equalsIgnoreCase(scope)) { // export to local if the config is not remote (export to remote only when config is remote) if (!SCOPE_REMOTE.equalsIgnoreCase(scope)) { // å¯¼å‡ºæœ¬åœ°æœåŠ¡, ä¸è§£æè¿™ä¸ª exportLocal(url); } // export to remote if the config is not local (export to local only when config is local) if (!SCOPE_LOCAL.equalsIgnoreCase(scope)) { // export to extra protocol is used in remote export // extProtocol é»˜è®¤ä¸ºç©º String extProtocol = url.getParameter(\"ext.protocol\", \"\"); List\u003cString\u003e protocols = new ArrayList\u003c\u003e(); if (StringUtils.isNotBlank(extProtocol)) { // export original url url = URLBuilder.from(url). addParameter(IS_PU_SERVER_KEY, Boolean.TRUE.toString()). removeParameter(\"ext.protocol\"). build(); } // å¯¼å‡ºè¿œç¨‹æœåŠ¡, è¿™ä¸ªå¾ˆé‡è¦ url = exportRemote(url, registryURLs, registerType); if (!isGeneric(generic) \u0026\u0026 !getScopeModel().isInternal()) { // å…ƒæ•°æ®ä¸­å¿ƒï¼Œå‘å¸ƒæœåŠ¡å®šä¹‰ï¼Œè¿™ä¸ªå¾ˆé‡è¦ MetadataUtils.publishServiceDefinition(url, providerModel.getServiceModel(), getApplicationModel()); } if (StringUtils.isNotBlank(extProtocol)) { String[] extProtocols = extProtocol.split(\",\", -1); protocols.addAll(Arrays.asList(extProtocols)); } // export extra protocols // å¯¼å‡ºé¢å¤–åè®® for (String protocol : protocols) { if (StringUtils.isNotBlank(protocol)) { URL localUrl = URLBuilder.from(url). setProtocol(protocol). build(); // å¯¼å‡ºè¿œç¨‹æœåŠ¡, è¿™ä¸ªå¾ˆé‡è¦ localUrl = exportRemote(localUrl, registryURLs, registerType); if (!isGeneric(generic) \u0026\u0026 !getScopeModel().isInternal()) { // å…ƒæ•°æ®ä¸­å¿ƒï¼Œå‘å¸ƒæœåŠ¡å®šä¹‰ï¼Œè¿™ä¸ªå¾ˆé‡è¦ MetadataUtils.publishServiceDefinition(localUrl, providerModel.getServiceModel(), getApplicationModel()); } this.urls.add(localUrl); } } } } this.urls.add(url); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:3","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" exportRemote å¯¼å‡ºæ¥å£æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#exportRemote // å¯¹æ¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œéƒ½å¯¼å‡ºæ¥å£ private URL exportRemote(URL url, List\u003cURL\u003e registryURLs, RegisterTypeEnum registerType) { if (CollectionUtils.isNotEmpty(registryURLs) \u0026\u0026 registerType != RegisterTypeEnum.NEVER_REGISTER) { // éå† registryUrl for (URL registryURL : registryURLs) { // dubbo3 ä¸­æ˜¯ service-registry if (SERVICE_REGISTRY_PROTOCOL.equals(registryURL.getProtocol())) { url = url.addParameterIfAbsent(SERVICE_NAME_MAPPING_KEY, \"true\"); } //if protocol is only injvm ,not register // å¦‚æœæ˜¯ injvm åè®®ï¼Œè·³è¿‡ if (LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) { continue; } // æ·»åŠ  dynamic å‚æ•°ï¼Œè¡¨ç¤ºè¿™ä¸ªæ¥å£æ˜¯ä¸´æ—¶çš„ï¼Œå½“æ³¨å†Œä¸­å¿ƒæ³¨é”€æ—¶ï¼Œéœ€è¦æ³¨é”€è¿™ä¸ªæ¥å£ url = url.addParameterIfAbsent(DYNAMIC_KEY, registryURL.getParameter(DYNAMIC_KEY)); // æ·»åŠ  monitor å‚æ•° URL monitorUrl = ConfigValidationUtils.loadMonitor(this, registryURL); if (monitorUrl != null) { url = url.putAttribute(MONITOR_KEY, monitorUrl); } // For providers, this is used to enable custom proxy to generate invoker // æ·»åŠ  proxy å‚æ•°ï¼Œå¯ä»¥è‡ªå®šä¹‰ä»£ç†å®ç°, é»˜è®¤ä¸º javassist String proxy = url.getParameter(PROXY_KEY); if (StringUtils.isNotEmpty(proxy)) { registryURL = registryURL.addParameter(PROXY_KEY, proxy); } if (logger.isInfoEnabled()) { if (url.getParameter(REGISTER_KEY, true)) { logger.info(\"Register dubbo service \" + interfaceClass.getName() + \" url \" + url + \" to registry \" + registryURL.getAddress()); } else { logger.info(\"Export dubbo service \" + interfaceClass.getName() + \" to url \" + url); } } // å¯¼å‡º urlï¼Œè¿™é‡Œå¾ˆé‡è¦ï¼ŒæŠŠ url æ·»åŠ åˆ° registryUrl çš„ export å‚æ•°ä¸­ doExportUrl(registryURL.putAttribute(EXPORT_KEY, url), true, registerType); } } else { if (logger.isInfoEnabled()) { logger.info(\"Export dubbo service \" + interfaceClass.getName() + \" to url \" + url); } // å¯¼å‡ºurlï¼Œä¸ä¼šæŠŠæ¥å£æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ doExportUrl(url, true, registerType); } return url; } æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#doExportUrl // å¯¼å‡ºæ¥å£ private void doExportUrl(URL url, boolean withMetaData, RegisterTypeEnum registerType) { // åœ¨ dubbo3 ä¸­ï¼ŒregisterType é»˜è®¤å°±æ˜¯ AUTO_REGISTER_BY_DEPLOYER if (!url.getParameter(REGISTER_KEY, true)) { registerType = RegisterTypeEnum.MANUAL_REGISTER; } if (registerType == RegisterTypeEnum.NEVER_REGISTER || registerType == RegisterTypeEnum.MANUAL_REGISTER || registerType == RegisterTypeEnum.AUTO_REGISTER_BY_DEPLOYER) { url = url.addParameter(REGISTER_KEY, false); } // åŒ…è£… refï¼Œç”Ÿæˆ invoker Invoker\u003c?\u003e invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url); if (withMetaData) { invoker = new DelegateProviderMetaDataInvoker(invoker, this); } // é€šè¿‡ SPI æœºåˆ¶è·å–å¯¹åº”çš„å®ç°ç±»ï¼Œè¿™é‡Œçš„ url æ˜¯ registryUrlï¼Œå®ç°ç±»ä¸º RegistryProtocol Exporter\u003c?\u003e exporter = protocolSPI.export(invoker); // æ³¨å†Œ exporter exporters.computeIfAbsent(registerType, k -\u003e new CopyOnWriteArrayList\u003c\u003e()).add(exporter); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:4","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" RegistryProtocol#export å¯¼å‡ºæ¥å£æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#export // å¯¼å‡ºæ¥å£ @Override public \u003cT\u003e Exporter\u003cT\u003e export(final Invoker\u003cT\u003e originInvoker) throws RpcException { // è·å– registryUrl URL registryUrl = getRegistryUrl(originInvoker); // è·å– providerUrl, ä¹‹å‰è¿™ä¸ªurl æ”¾åœ¨ registryUrl çš„ export å‚æ•°ä¸­ URL providerUrl = getProviderUrl(originInvoker); // Subscribe the override data // FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call // the same service. Because the subscribed is cached key with the name of the service, it causes the // subscription information to cover. // ä¸€äº›è¦†ç›–é…ç½®çš„ç›‘å¬å™¨ï¼Œè¿™é‡ŒåŒ…æ‹¬ provider, service ä¸¤ä¸ªç»´åº¦çš„ final URL overrideSubscribeUrl = getSubscribedOverrideUrl(providerUrl); final OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker); Map\u003cURL, Set\u003cNotifyListener\u003e\u003e overrideListeners = getProviderConfigurationListener(overrideSubscribeUrl).getOverrideListeners(); overrideListeners.computeIfAbsent(overrideSubscribeUrl, k -\u003e new ConcurrentHashSet\u003c\u003e()) .add(overrideSubscribeListener); providerUrl = overrideUrlWithConfig(providerUrl, overrideSubscribeListener); //export invoker // å¯¼å‡ºæ¥å£ï¼Œè¿™ä¸ªæœ€é‡è¦ final ExporterChangeableWrapper\u003cT\u003e exporter = doLocalExport(originInvoker, providerUrl); // url to registry // æ ¹æ® SPI æœºåˆ¶è·å–å¯¹åº”çš„ registry å®ç°ç±», æ¯”å¦‚ ServiceDiscoveryRegistry final Registry registry = getRegistry(registryUrl); // è·å–æ³¨å†Œçš„ url final URL registeredProviderUrl = getUrlToRegistry(providerUrl, registryUrl); // decide if we need to delay publish (provider itself and registry should both need to register) // å†³å®šæ˜¯å¦è¦æ³¨å†Œ urlï¼Œåˆšæ‰æ˜¯ AUTO_REGISTER_BY_DEPLOYERï¼Œæ‰€ä»¥ä¸ä¼šæ³¨å†Œ boolean register = providerUrl.getParameter(REGISTER_KEY, true) \u0026\u0026 registryUrl.getParameter(REGISTER_KEY, true); if (register) { register(registry, registeredProviderUrl); } // register stated url on provider model registerStatedUrl(registryUrl, registeredProviderUrl, register); // è®¾ç½®ä¸€äº›å‚æ•° exporter.setRegisterUrl(registeredProviderUrl); exporter.setSubscribeUrl(overrideSubscribeUrl); exporter.setNotifyListener(overrideSubscribeListener); exporter.setRegistered(register); ... // æ‰§è¡Œ RegistryProtocolListener é’©å­å‡½æ•° notifyExport(exporter); //Ensure that a new exporter instance is returned every time export return new DestroyableExporter\u003c\u003e(exporter); } æºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol#doLocalExport // å¯¼å‡ºæ¥å£ private \u003cT\u003e ExporterChangeableWrapper\u003cT\u003e doLocalExport(final Invoker\u003cT\u003e originInvoker, URL providerUrl) { String providerUrlKey = getProviderUrlKey(originInvoker); String registryUrlKey = getRegistryUrlKey(originInvoker); Invoker\u003c?\u003e invokerDelegate = new InvokerDelegate\u003c\u003e(originInvoker, providerUrl); // æ ¹æ® SPI æœºåˆ¶è·å–å¯¹åº”çš„å®ç°ç±»ï¼Œå¦‚ DubboProtocol, TripleProtocol, åœ¨åé¢çš„ç« èŠ‚ä¼šç»§ç»­è§£æ ReferenceCountExporter\u003c?\u003e exporter = exporterFactory.createExporter(psfdsnroviderUrlKey, () -\u003e protocol.export(invokerDelegate)); // è®°å½•å¯¼å‡ºçš„æ¥å£ return (ExporterChangeableWrapper\u003cT\u003e) bounds.computeIfAbsent(providerUrlKey, _k -\u003e new ConcurrentHashMap\u003c\u003e()) .computeIfAbsent(registryUrlKey, s -\u003e { // ExporterChangeableWrapper è¿™ä¸ªç±»å¾ˆé‡è¦ï¼Œåç»­ä¼šè°ƒç”¨ registry æ–¹æ³•æ¥æ³¨å†Œæ¥å£ return new ExporterChangeableWrapper\u003c\u003e( (ReferenceCountExporter\u003cT\u003e) exporter, originInvoker); }); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:5","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ServiceConfig#exportedæºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#exported // åœ¨å¯¼å‡ºæ¥å£åï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• protected void exported() { exported = true; List\u003cURL\u003e exportedURLs = this.getExportedUrls(); exportedURLs.forEach(url -\u003e { if (url.getParameters().containsKey(SERVICE_NAME_MAPPING_KEY)) { ServiceNameMapping serviceNameMapping = ServiceNameMapping.getDefaultExtension(getScopeModel()); ScheduledExecutorService scheduledExecutor = getScopeModel().getBeanFactory() .getBean(FrameworkExecutorRepository.class).getSharedScheduledExecutor(); // å¯¹æ¥å£åˆ›å»ºå¯¹åº”çš„ mapppingï¼Œè¿™æ ·å¯ä»¥æ ¹æ®æ¥å£æ¥è·å–æ˜¯æœåŠ¡åï¼Œå¾ˆé‡è¦ mapServiceName(url, serviceNameMapping, scheduledExecutor); } }); // æ‰§è¡Œ ServiceListener é’©å­å‡½æ•° onExported(); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:1:6","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" DefaultModuleDeployer#registerServices æ³¨å†ŒæœåŠ¡æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultModuleDeployer#registerServices // æ³¨å†ŒæœåŠ¡ private void registerServices() { // éå†æ‰€æœ‰çš„ service for (ServiceConfigBase sc : configManager.getServices()) { if (!Boolean.FALSE.equals(sc.isRegister())) { // æ³¨å†Œ service, è¿™ä¸ªå¾ˆé‡è¦ registerServiceInternal(sc); } } // åˆ·æ–°æœåŠ¡å®ä¾‹, è¿™ä¸ªå¾ˆé‡è¦ applicationDeployer.refreshServiceInstance(); } æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultModuleDeployer#registerServiceInternal // æ³¨å†Œ service private void registerServiceInternal(ServiceConfigBase sc) { ServiceConfig\u003c?\u003e serviceConfig = (ServiceConfig\u003c?\u003e) sc; // åˆ·æ–°é…ç½® if (!serviceConfig.isRefreshed()) { serviceConfig.refresh(); } if (!sc.isExported()) { return; } // æ³¨å†Œ sc.register(true); } æºç ä½ç½®: org.apache.dubbo.config.ServiceConfig#register // æ³¨å†Œ, byDeployer å‚æ•°ä¸º true @Override public void register(boolean byDeployer) { if (!this.exported) { return; } synchronized (this) { if (!this.exported) { return; } // AUTO_REGISTER ç±»å‹çš„æ³¨å†Œ for (Exporter\u003c?\u003e exporter : exporters.getOrDefault(RegisterTypeEnum.AUTO_REGISTER, Collections.emptyList())) { exporter.register(); } // AUTO_REGISTER_BY_DEPLOYER ç±»å‹çš„æ³¨å†Œ, dubbo3 é»˜è®¤èµ°è¿™é‡Œ if (byDeployer) { for (Exporter\u003c?\u003e exporter : exporters.getOrDefault(RegisterTypeEnum.AUTO_REGISTER_BY_DEPLOYER, Collections.emptyList())) { // exporter å®ç°ç±»ä¸º ExporterChangeableWrapper exporter.register(); } } } } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ExporterChangeableWrapper#registeræºç ä½ç½®: org.apache.dubbo.registry.integration.RegistryProtocol.ExporterChangeableWrapper#register // ExporterChangeableWrapper åœ¨ RegistryProtocol#doLocalExport æ–¹æ³•ä¸­ä¼šç”Ÿæˆ @Override public void register() { if (registered.compareAndSet(false, true)) { URL registryUrl = getRegistryUrl(originInvoker); // æ ¹æ® SPI æœºåˆ¶è·å– registry, å®ç°ç±»ä¸º ServiceDiscoveryRegistryï¼ˆæœåŠ¡çº§åˆ«æ³¨å†Œï¼‰ï¼ŒZookeeperRegistryï¼ˆæ¥å£çº§åˆ«æ³¨å†Œï¼‰ Registry registry = getRegistry(registryUrl); // æ³¨å†Œ urlï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œè¿™é‡Œåªåˆ†æ ServiceDiscoveryRegistry#register RegistryProtocol.register(registry, getRegisterUrl()); ProviderModel providerModel = frameworkModel.getServiceRepository() .lookupExportedService(getRegisterUrl().getServiceKey()); // æ ‡è®°å·²æ³¨å†Œ List\u003cProviderModel.RegisterStatedURL\u003e statedUrls = providerModel.getStatedUrl(); statedUrls.stream() .filter(u -\u003e u.getRegistryUrl().equals(registryUrl) \u0026\u0026 u.getProviderUrl().getProtocol().equals(getRegisterUrl().getProtocol())) .forEach(u -\u003e u.setRegistered(true)); logger.info(\"Registered dubbo service \" + getRegisterUrl().getServiceKey() + \" url \" + getRegisterUrl() + \" to registry \" + registryUrl); } } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:2:1","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ServiceDiscoveryRegistry#register æœåŠ¡çº§åˆ«æ³¨å†Œæºç ä½ç½®: org.apache.dubbo.registry.client.ServiceDiscoveryRegistry#register @Override public final void register(URL url) { if (!shouldRegister(url)) { // Should Not Register return; } doRegister(url); } @Override public void doRegister(URL url) { // fixme, add registry-cluster is not necessary anymore url = addRegistryClusterKey(url); // æ³¨å†Œ url serviceDiscovery.register(url); } æºç ä½ç½®: org.apache.dubbo.registry.client.AbstractServiceDiscovery#register @Override public void register(URL url) { // åªæ˜¯æ·»åŠ äº† urlï¼Œå®é™…å¹¶æ²¡æœ‰å‘å¸ƒ metadataInfo.addService(url); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:2:2","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" DefaultApplicationDeployer#refreshServiceInstance åˆ·æ–°æœåŠ¡å®ä¾‹æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#refreshServiceInstance @Override public void refreshServiceInstance() { if (registered) { try { // åˆ·æ–°å…ƒæ•°æ®å’Œå®ä¾‹ ServiceInstanceMetadataUtils.refreshMetadataAndInstance(applicationModel); } catch (Exception e) { logger.error(CONFIG_REFRESH_INSTANCE_ERROR, \"\", \"\", \"Refresh instance and metadata error.\", e); } } } // åˆ·æ–°å…ƒæ•°æ®å’Œå®ä¾‹ public static void refreshMetadataAndInstance(ApplicationModel applicationModel) { RegistryManager registryManager = applicationModel.getBeanFactory().getBean(RegistryManager.class); // update service instance revision // å¯¹æ¯ä¸€ä¸ª serviceDiscovery éƒ½æ›´æ–° registryManager.getServiceDiscoveries().forEach(ServiceDiscovery::update); } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ServiceDiscovery#update æ›´æ–°æœåŠ¡å®ä¾‹æºç ä½ç½®: org.apache.dubbo.registry.client.AbstractServiceDiscovery#update @Override public synchronized void update() throws RuntimeException { if (isDestroy) { return; } // æ³¨å†Œå®ä¾‹, ä¼šæ ¹æ® metadataInfo åˆ›å»º serviceInstance if (this.serviceInstance == null) { register(); } if (!isValidInstance(this.serviceInstance)) { return; } ServiceInstance oldServiceInstance = this.serviceInstance; DefaultServiceInstance newServiceInstance = new DefaultServiceInstance((DefaultServiceInstance) oldServiceInstance); // è®¡ç®— revision æ˜¯å¦å‘ç”Ÿæ”¹å˜ boolean revisionUpdated = calOrUpdateInstanceRevision(newServiceInstance); if (revisionUpdated) { logger.info(String.format(\"Metadata of instance changed, updating instance with revision %s.\", newServiceInstance.getServiceMetadata().getRevision())); // æ›´æ–°æœåŠ¡å®ä¾‹ doUpdate(oldServiceInstance, newServiceInstance); this.serviceInstance = newServiceInstance; } } æºç ä½ç½®: org.apache.dubbo.registry.client.AbstractServiceDiscovery#doUpdate protected void doUpdate(ServiceInstance oldServiceInstance, ServiceInstance newServiceInstance) { // æ³¨é”€æ—§çš„æœåŠ¡å®ä¾‹ this.doUnregister(oldServiceInstance); this.serviceInstance = newServiceInstance; if (!EMPTY_REVISION.equals(getExportedServicesRevision(newServiceInstance))) { // æŠ¥å‘ŠæœåŠ¡å…ƒæ•°æ® reportMetadata(newServiceInstance.getServiceMetadata()); // æ³¨å†Œæ–°çš„æœåŠ¡å®ä¾‹ this.doRegister(newServiceInstance); } } ","date":"2023-11-25","objectID":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/:3:1","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"05 å¯¼å‡ºæœåŠ¡","uri":"/ooooo-notes/05-%E5%AF%BC%E5%87%BA%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" ä¸ºä»€ä¹ˆå­¦åœ¨åç«¯å¼€å‘ä¸­ï¼Œrpc æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨åˆ°çš„æŠ€æœ¯ï¼Œè€Œ dubbo æ˜¯ java çš„ä¸€ç§æµè¡Œçš„ rpc æ¡†æ¶ã€‚ ","date":"2023-11-24","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-dubbo/:1:0","tags":["dubbo","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ dubbo","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-dubbo/"},{"categories":null,"content":" æ€ä¹ˆå­¦ åœ¨ B ç«™ä¸­ï¼Œæ‰¾ä¸€ä¸ª dubbo çš„å…¥é—¨è§†é¢‘æ¥å­¦ä¹  å­¦ä¹ github dubbo-samples å­¦ä¹ å®˜æ–¹æ–‡æ¡£ é˜…è¯»æºç github dubbo ","date":"2023-11-24","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-dubbo/:2:0","tags":["dubbo","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ dubbo","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-dubbo/"},{"categories":null,"content":" åœ¨ spring boot ä¸­ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª bean å®ç° filter æ¥å£ï¼Œspring boot å°±ä¼šæŠŠè¿™ä¸ª filter åŠ å…¥åˆ° servlet å®¹å™¨ä¸­ã€‚ åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¸¸ç”¨çš„æ¥å£å°±æ˜¯ OncePerRequestFilter å’Œ OrderedFilter, æ‰€ä»¥æ¥çœ‹çœ‹ spring boot æ˜¯å¦‚ä½•é€‚é… servlet è§„èŒƒã€‚ ","date":"2023-11-18","objectID":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/:0:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"é€‚é… servlet è§„èŒƒ","uri":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/"},{"categories":null,"content":" åˆ›å»º WebServeræºç ä½ç½®: org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#onRefresh // åœ¨ spring å®¹å™¨åˆ·æ–°æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³• @Override protected void onRefresh() { super.onRefresh(); try { // åˆ›å»º webServer createWebServer(); } catch (Throwable ex) { throw new ApplicationContextException(\"Unable to start web server\", ex); } } æºç ä½ç½®: org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#createWebServer // åˆ›å»º webServer private void createWebServer() { WebServer webServer = this.webServer; ServletContext servletContext = getServletContext(); if (webServer == null \u0026\u0026 servletContext == null) { StartupStep createWebServer = this.getApplicationStartup().start(\"spring.boot.webserver.create\"); // è·å–å·¥å‚ç±»ï¼Œæ¯”å¦‚æœ‰ tomcatï¼Œjetty çš„å®ç°, è¿™ä¸ªçœç•¥äº†ã€‚ ServletWebServerFactory factory = getWebServerFactory(); createWebServer.tag(\"factory\", factory.getClass().toString()); // åˆ›å»º webServerï¼Œé‡ç‚¹çœ‹è¿™ä¸ª this.webServer = factory.getWebServer(getSelfInitializer()); createWebServer.end(); // æ³¨å†Œé’©å­ getBeanFactory().registerSingleton(\"webServerGracefulShutdown\", new WebServerGracefulShutdownLifecycle(this.webServer)); getBeanFactory().registerSingleton(\"webServerStartStop\", new WebServerStartStopLifecycle(this, this.webServer)); } ... } æºç ä½ç½®: org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#getSelfInitializer // è·å– ServletContextInitializer private org.springframework.boot.web.servlet.ServletContextInitializer getSelfInitializer() { return this::selfInitialize; } private void selfInitialize(ServletContext servletContext) throws ServletException { prepareWebApplicationContext(servletContext); registerApplicationScope(servletContext); WebApplicationContextUtils.registerEnvironmentBeans(getBeanFactory(), servletContext); // åˆå§‹åŒ– ServletContextInitializer, é‡Œé¢å°±åŒ…æ‹¬ filterï¼Œservletï¼Œlistener for (ServletContextInitializer beans : getServletContextInitializerBeans()) { beans.onStartup(servletContext); } } // ServletContextInitializerBeans çš„æ„é€ æ–¹æ³•å¾ˆé‡è¦ protected Collection\u003cServletContextInitializer\u003e getServletContextInitializerBeans() { return new ServletContextInitializerBeans(getBeanFactory()); } ","date":"2023-11-18","objectID":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/:1:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"é€‚é… servlet è§„èŒƒ","uri":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/"},{"categories":null,"content":" ServletContextInitializerBeans é€‚é…å™¨æºç ä½ç½®: org.springframework.boot.web.servlet.ServletContextInitializerBeans#ServletContextInitializerBeans // ServletContextInitializerBeans çš„æ„é€ å‡½æ•° public ServletContextInitializerBeans(ListableBeanFactory beanFactory, Class\u003c? extends ServletContextInitializer\u003e... initializerTypes) { this.initializers = new LinkedMultiValueMap\u003c\u003e(); this.initializerTypes = (initializerTypes.length != 0) ? Arrays.asList(initializerTypes) : Collections.singletonList(ServletContextInitializer.class); // é€‚é… filterï¼Œservletï¼Œlistenerï¼Œå¾ˆé‡è¦ addServletContextInitializerBeans(beanFactory); // é€‚é… filterï¼Œservletï¼Œå¾ˆé‡è¦ addAdaptableBeans(beanFactory); // æ’åº ServletContextInitializer List\u003cServletContextInitializer\u003e sortedInitializers = this.initializers.values().stream() .flatMap((value) -\u003e value.stream().sorted(AnnotationAwareOrderComparator.INSTANCE)) .collect(Collectors.toList()); this.sortedList = Collections.unmodifiableList(sortedInitializers); logMappings(this.initializers); } æºç ä½ç½®: org.springframework.boot.web.servlet.ServletContextInitializerBeans#addServletContextInitializerBeans // é€‚é… filterï¼Œservletï¼Œlistener private void addServletContextInitializerBeans(ListableBeanFactory beanFactory) { for (Class\u003c? extends ServletContextInitializer\u003e initializerType : this.initializerTypes) { for (Entry\u003cString, ? extends ServletContextInitializer\u003e initializerBean : getOrderedBeansOfType(beanFactory, initializerType)) { addServletContextInitializerBean(initializerBean.getKey(), initializerBean.getValue(), beanFactory); } } } private void addServletContextInitializerBean(String beanName, ServletContextInitializer initializer, ListableBeanFactory beanFactory) { // é€‚é… servlet if (initializer instanceof ServletRegistrationBean) { Servlet source = ((ServletRegistrationBean\u003c?\u003e) initializer).getServlet(); addServletContextInitializerBean(Servlet.class, beanName, initializer, beanFactory, source); } // é€‚é… filter else if (initializer instanceof FilterRegistrationBean) { Filter source = ((FilterRegistrationBean\u003c?\u003e) initializer).getFilter(); addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source); } // é€‚é… filter else if (initializer instanceof DelegatingFilterProxyRegistrationBean) { String source = ((DelegatingFilterProxyRegistrationBean) initializer).getTargetBeanName(); addServletContextInitializerBean(Filter.class, beanName, initializer, beanFactory, source); } // é€‚é… listener else if (initializer instanceof ServletListenerRegistrationBean) { EventListener source = ((ServletListenerRegistrationBean\u003c?\u003e) initializer).getListener(); addServletContextInitializerBean(EventListener.class, beanName, initializer, beanFactory, source); } else { addServletContextInitializerBean(ServletContextInitializer.class, beanName, initializer, beanFactory, initializer); } } æºç ä½ç½®: org.springframework.boot.web.servlet.ServletContextInitializerBeans#addAdaptableBeans // é€‚é… filterï¼Œservlet protected void addAdaptableBeans(ListableBeanFactory beanFactory) { MultipartConfigElement multipartConfig = getMultipartConfig(beanFactory); // é€‚é… servlet addAsRegistrationBean(beanFactory, Servlet.class, new ServletRegistrationBeanAdapter(multipartConfig)); // é€‚é… filter addAsRegistrationBean(beanFactory, Filter.class, new FilterRegistrationBeanAdapter()); for (Class\u003c?\u003e listenerType : ServletListenerRegistrationBean.getSupportedTypes()) { addAsRegistrationBean(beanFactory, EventListener.class, (Class\u003cEventListener\u003e) listenerType, new ServletListenerRegistrationBeanAdapter()); } } ","date":"2023-11-18","objectID":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/:2:0","tags":["spring boot","source code","æºç åˆ†æ spring boot ç³»åˆ—"],"title":"é€‚é… servlet è§„èŒƒ","uri":"/ooooo-notes/%E9%80%82%E9%85%8D-servlet-%E8%A7%84%E8%8C%83/"},{"categories":null,"content":" å­—æ®µæ›´æ–°ä¸ºnullçš„ä»£ç  // å®ä½“ç±»å­—æ®µè®¾ç½® @TableField(value = \"LOCK_EXP_TIME_\", updateStrategy = FieldStrategy.IGNORED) private Date lockExpirationTime; // mapperæ“ä½œ JobEntity jobEntity = new JobEntity(); jobEntity.setId(1); jobEntity.setLockExpirationTime(null); JobEntityMapper.updateById(jobEntity); ","date":"2023-11-07","objectID":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/:1:0","tags":["mybatis"],"title":"mybatis-plus æ›´æ–°å­—æ®µä¸º null çš„å‘","uri":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/"},{"categories":null,"content":" é—®é¢˜ä¸Šé¢çš„æ“ä½œå¯èƒ½ä¼šæŠ›å‡ºä¸‹é¢çš„å¼‚å¸¸ ### Cause: org.apache.ibatis.type.TypeException: Could not set parameters for mapping: ParameterMapping{property='et.lockExpirationTime', mode=IN, javaType=class java.lang.Object, jdbcType=null, numericScale=null, resultMapId='null', jdbcTypeName='null', expression='null'}. Cause: org.apache.ibatis.type.TypeException: Error setting null for parameter #2 with JdbcType OTHER . Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. ","date":"2023-11-07","objectID":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/:2:0","tags":["mybatis"],"title":"mybatis-plus æ›´æ–°å­—æ®µä¸º null çš„å‘","uri":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/"},{"categories":null,"content":" è§£å†³æ–¹æ³• // æ·»åŠ  jdbcType @TableField(value = \"LOCK_EXP_TIME_\", updateStrategy = FieldStrategy.IGNORED, jdbcType = JdbcType.TIMESTAMP) private Date lockExpirationTime; ","date":"2023-11-07","objectID":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/:3:0","tags":["mybatis"],"title":"mybatis-plus æ›´æ–°å­—æ®µä¸º null çš„å‘","uri":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/"},{"categories":null,"content":" ç›¸åº”çš„æºç æºç ä½ç½®: com.baomidou.mybatisplus.core.MybatisParameterHandler#setParameters try { typeHandler.setParameter(ps, i + 1, value, jdbcType); } catch (TypeException | SQLException e) { throw new TypeException(\"Could not set parameters for mapping: \" + parameterMapping + \". Cause: \" + e, e); } ","date":"2023-11-07","objectID":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/:4:0","tags":["mybatis"],"title":"mybatis-plus æ›´æ–°å­—æ®µä¸º null çš„å‘","uri":"/ooooo-notes/mybatis-plus-%E6%9B%B4%E6%96%B0%E5%AD%97%E6%AE%B5%E4%B8%BA-null-%E7%9A%84%E5%9D%91/"},{"categories":null,"content":" rocketmq åŸºäº 5.1.4 ç‰ˆæœ¬ åœ¨ rocketmq ä¸­ï¼Œæ¶ˆæ¯åˆ†ä¸ºå¤šä¸ªç±»å‹ï¼Œæ¯”å¦‚æ™®é€šæ¶ˆæ¯ã€æ‰¹é‡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯ç­‰ï¼Œè¿™ä¸€èŠ‚ä¸»è¦ä»‹ç»æ™®é€šæ¶ˆæ¯çš„é€»è¾‘ï¼Œåé¢çš„ç« èŠ‚ä¼šç»§ç»­ä»‹ç»å…¶ä»–æ¶ˆæ¯ã€‚ ","date":"2023-10-20","objectID":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/:0:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"03 producer å‘é€æ¶ˆæ¯","uri":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/"},{"categories":null,"content":" producer å‘é€æ¶ˆæ¯æºç ä½ç½®: org.apache.rocketmq.client.producer.DefaultMQProducer#send // å‘é€æ¶ˆæ¯ public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException { msg.setTopic(withNamespace(msg.getTopic())); // autoBatch é»˜è®¤ false if (this.getAutoBatch() \u0026\u0026 !(msg instanceof MessageBatch)) { // é€šè¿‡ç´¯åŠ å™¨æ¥å®ç°æ‰¹é‡æ¶ˆæ¯ï¼Œå¢å¤§ååé‡ return sendByAccumulator(msg, null, null); } else { // ç›´æ¥å‘é€, æœ€ç»ˆä¼šè°ƒç”¨ DefaultMQProducerImpl#sendDefaultImpl return sendDirect(msg, null, null); } } æºç ä½ç½®: org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendDefaultImpl // å‘é€æ¶ˆæ¯ private SendResult sendDefaultImpl( Message msg, final CommunicationMode communicationMode, final SendCallback sendCallback, final long timeout ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException { this.makeSureStateOK(); // æ ¡éªŒæ¶ˆæ¯ Validators.checkMessage(msg, this.defaultMQProducer); final long invokeID = random.nextLong(); long beginTimestampFirst = System.currentTimeMillis(); long beginTimestampPrev = beginTimestampFirst; long endTimestamp = beginTimestampFirst; // è·å– topicï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šä» namesrv ä¸­åŒæ­¥ topic TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic()); if (topicPublishInfo != null \u0026\u0026 topicPublishInfo.ok()) { boolean callTimeout = false; MessageQueue mq = null; Exception exception = null; SendResult sendResult = null; // åŒæ­¥è°ƒç”¨ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•° int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; int times = 0; String[] brokersSent = new String[timesTotal]; boolean resetIndex = false; // å¦‚æœå¤±è´¥ï¼Œé‡è¯• for (; times \u003c timesTotal; times++) { String lastBrokerName = null == mq ? null : mq.getBrokerName(); if (times \u003e 0) { resetIndex = true; } // æ ¹æ®ç­–ç•¥æ¥é€‰æ‹© queue, å®ç°æ–¹å¼æœ‰éšæœºã€å¯ç”¨æ€§ã€å»¶è¿Ÿ MessageQueue mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName, resetIndex); if (mqSelected != null) { mq = mqSelected; // è®°å½•æ¯æ¬¡é€‰æ‹©çš„ queue brokersSent[times] = mq.getBrokerName(); try { ... // å‘é€æ¶ˆæ¯, å¾ˆé‡è¦ sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime); endTimestamp = System.currentTimeMillis(); // æ›´æ–°å»¶è¿Ÿå’Œå¯ç”¨æ€§ this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true); // æ ¹æ®é€šä¿¡æ¨¡å¼æ¥è¿”å›ç»“æœ switch (communicationMode) { case ASYNC: return null; case ONEWAY: return null; case SYNC: if (sendResult.getSendStatus() != SendStatus.SEND_OK) { if (this.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) { continue; } } return sendResult; default: break; } } catch (MQClientException e) { endTimestamp = System.currentTimeMillis(); // æ›´æ–°å»¶è¿Ÿå’Œå¯ç”¨æ€§ this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true); ... continue; } catch (RemotingException e) { endTimestamp = System.currentTimeMillis(); // æ›´æ–°å»¶è¿Ÿå’Œå¯ç”¨æ€§ this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true, true); ... exception = e; continue; } catch (MQBrokerException e) { endTimestamp = System.currentTimeMillis(); // æ›´æ–°å»¶è¿Ÿå’Œå¯ç”¨æ€§ this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true, false); ... exception = e; } catch (InterruptedException e) { endTimestamp = System.currentTimeMillis(); // æ›´æ–°å»¶è¿Ÿå’Œå¯ç”¨æ€§ this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true); ... throw e; } } else { break; } } if (sendResult != null) { return sendResult; } ... // æŠ›å‡ºå¼‚å¸¸ throw mqClientException; } ... } æºç ä½ç½®: org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl#sendKernelImpl // å‘é€æ¶ˆæ¯, å¾ˆé‡è¦ private SendResult sendKernelImpl(final Message msg, final MessageQueue mq, final CommunicationMode communicationMode, final SendCallback sendCallback, final TopicPublishInfo topicPublishInfo, final long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException { long beginStartTime = System.currentTimeMillis(); // è·å– brokerName å’Œ brokerAddr String brokerName = this.mQClientFactory.getBrokerNameFr","date":"2023-10-20","objectID":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/:1:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"03 producer å‘é€æ¶ˆæ¯","uri":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/"},{"categories":null,"content":" broker æ¥å—æ¶ˆæ¯æºç ä½ç½®: org.apache.rocketmq.remoting.protocol.header.SendMessageRequestHeader#parseRequestHeader // å¤„ç† RequestCode.SEND_MESSAGE_V2 public static SendMessageRequestHeader parseRequestHeader(RemotingCommand request) throws RemotingCommandException { SendMessageRequestHeaderV2 requestHeaderV2 = null; SendMessageRequestHeader requestHeader = null; switch (request.getCode()) { case RequestCode.SEND_BATCH_MESSAGE: case RequestCode.SEND_MESSAGE_V2: // è·å– requestHeaderV2 requestHeaderV2 = (SendMessageRequestHeaderV2) request .decodeCommandCustomHeader(SendMessageRequestHeaderV2.class); case RequestCode.SEND_MESSAGE: if (null == requestHeaderV2) { requestHeader = (SendMessageRequestHeader) request .decodeCommandCustomHeader(SendMessageRequestHeader.class); } else { // requestHeaderV2 è½¬ä¸º requestHeader requestHeader = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV1(requestHeaderV2); } default: break; } return requestHeader; } æºç ä½ç½®: org.apache.rocketmq.broker.processor.SendMessageProcessor#processRequest // public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException { SendMessageContext sendMessageContext; switch (request.getCode()) { case RequestCode.CONSUMER_SEND_MSG_BACK: return this.consumerSendMsgBack(ctx, request); default: // è§£æ requestHeader SendMessageRequestHeader requestHeader = parseRequestHeader(request); if (requestHeader == null) { return null; } TopicQueueMappingContext mappingContext = this.brokerController.getTopicQueueMappingManager().buildTopicQueueMappingContext(requestHeader, true); // å¤„ç†é™æ€ topic RemotingCommand rewriteResult = this.brokerController.getTopicQueueMappingManager().rewriteRequestForStaticTopic(requestHeader, mappingContext); if (rewriteResult != null) { return rewriteResult; } ... RemotingCommand response; if (requestHeader.isBatch()) { // å¤„ç†æ‰¹é‡æ¶ˆæ¯ response = this.sendBatchMessage(ctx, request, sendMessageContext, requestHeader, mappingContext, (ctx1, response1) -\u003e executeSendMessageHookAfter(response1, ctx1)); } else { // å¤„ç†æ¶ˆæ¯ response = this.sendMessage(ctx, request, sendMessageContext, requestHeader, mappingContext, (ctx12, response12) -\u003e executeSendMessageHookAfter(response12, ctx12)); } return response; } } æºç ä½ç½®: org.apache.rocketmq.broker.processor.SendMessageProcessor#sendMessage // å¤„ç†æ¶ˆæ¯ // ä»£ç éå¸¸å¤šï¼Œæ²‰ä¸‹å¿ƒæ¥çœ‹ public RemotingCommand sendMessage(final ChannelHandlerContext ctx, final RemotingCommand request, final SendMessageContext sendMessageContext, final SendMessageRequestHeader requestHeader, final TopicQueueMappingContext mappingContext, final SendMessageCallback sendMessageCallback) throws RemotingCommandException { // è®¾ç½® response, æ·»åŠ å±æ€§ PROPERTY_MSG_REGIONï¼ŒPROPERTY_TRACE_SWITCH final RemotingCommand response = preSend(ctx, request, requestHeader); if (response.getCode() != -1) { return response; } final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader(); final byte[] body = request.getBody(); int queueIdInt = requestHeader.getQueueId(); // è·å– topic é…ç½® TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic()); // éšæœºé€‰æ‹©ä¸€ä¸ª queue if (queueIdInt \u003c 0) { queueIdInt = randomQueueId(topicConfig.getWriteQueueNums()); } MessageExtBrokerInner msgInner = new MessageExtBrokerInner(); msgInner.setTopic(requestHeader.getTopic()); msgInner.setQueueId(queueIdInt); Map\u003cString, String\u003e oriProps = MessageDecoder.string2messageProperties(requestHeader.getProperties()); // å¤„ç†é‡è¯•å’Œæ­»ä¿¡æ¶ˆæ¯ if (!handleRetryAndDLQ(requestHeader, response, request, msgInner, topicConfig, oriProps)) { return response; } msgInner.setBody(body); msgInner.setFlag(requestHeader.getFlag()); // ç”Ÿæˆæ¶ˆæ¯å”¯ä¸€ID String uniqKey = oriProps.get(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX); if (uniqKey == null || uniqKey.length() \u003c= 0) { uniqKey = MessageClientIDSetter.createUniqID(); oriProps.put(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX, uniqKey); } ... // è®¾ç½® tag ","date":"2023-10-20","objectID":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/:2:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"03 producer å‘é€æ¶ˆæ¯","uri":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/"},{"categories":null,"content":" æµ‹è¯•ç±»org.apache.rocketmq.test.client.consumer.topic.OneConsumerMulTopicIT#testSynSendMessage ","date":"2023-10-20","objectID":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/:3:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"03 producer å‘é€æ¶ˆæ¯","uri":"/ooooo-notes/03-producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/"},{"categories":null,"content":" rocketmq åŸºäº 5.1.4 ç‰ˆæœ¬ ","date":"2023-10-19","objectID":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/:0:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"02 broker æ³¨å†Œ namesvr","uri":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/"},{"categories":null,"content":" broker å‘èµ·æ³¨å†Œè¯·æ±‚æºç ä½ç½®: org.apache.rocketmq.broker.BrokerController#start // å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œå‘èµ· broker æ³¨å†Œ public void start() throws Exception { ... if (!isIsolated \u0026\u0026 !this.messageStoreConfig.isEnableDLegerCommitLog() \u0026\u0026 !this.messageStoreConfig.isDuplicationEnable()) { changeSpecialServiceStatus(this.brokerConfig.getBrokerId() == MixAll.MASTER_ID); // æ³¨å†Œ broker this.registerBrokerAll(true, false, true); } // å®šæ—¶ä»»åŠ¡ scheduledFutures.add(this.scheduledExecutorService.scheduleAtFixedRate(new AbstractBrokerRunnable(this.getBrokerIdentity()) { @Override public void run0() { try { if (System.currentTimeMillis() \u003c shouldStartTime) { BrokerController.LOG.info(\"Register to namesrv after {}\", shouldStartTime); return; } if (isIsolated) { BrokerController.LOG.info(\"Skip register for broker is isolated\"); return; } // æ³¨å†Œ broker BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister()); } catch (Throwable e) { BrokerController.LOG.error(\"registerBrokerAll Exception\", e); } } }, 1000 * 10, Math.max(10000, Math.min(brokerConfig.getRegisterNameServerPeriod(), 60000)), TimeUnit.MILLISECONDS)); ... } æºç ä½ç½®: org.apache.rocketmq.broker.BrokerController#registerBrokerAll // æ³¨å†Œ broker, éœ€è¦æŠŠ broker çš„ topic é…ç½®æ¨é€åˆ° namesrv ä¸­ public synchronized void registerBrokerAll(final boolean checkOrderConfig, boolean oneway, boolean forceRegister) { ConcurrentMap\u003cString, TopicConfig\u003e topicConfigMap = this.getTopicConfigManager().getTopicConfigTable(); ConcurrentHashMap\u003cString, TopicConfig\u003e topicConfigTable = new ConcurrentHashMap\u003c\u003e(); // éå† topic for (TopicConfig topicConfig : topicConfigMap.values()) { // è®¾ç½®æƒé™ if (!PermName.isWriteable(this.getBrokerConfig().getBrokerPermission()) || !PermName.isReadable(this.getBrokerConfig().getBrokerPermission())) { topicConfigTable.put(topicConfig.getTopicName(), new TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(), topicConfig.getPerm() \u0026 getBrokerConfig().getBrokerPermission())); } else { topicConfigTable.put(topicConfig.getTopicName(), topicConfig); } // topic å¾ˆå¤šï¼Œåˆ†å‡ ä¸ªè¯·æ±‚ if (this.brokerConfig.isEnableSplitRegistration() \u0026\u0026 topicConfigTable.size() \u003e= this.brokerConfig.getSplitRegistrationSize()) { TopicConfigAndMappingSerializeWrapper topicConfigWrapper = this.getTopicConfigManager().buildSerializeWrapper(topicConfigTable); doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper); topicConfigTable.clear(); } } // topic çš„ TopicQueueMappingInfo, æš‚æ—¶ä¸ç”¨å…³å¿ƒ Map\u003cString, TopicQueueMappingInfo\u003e topicQueueMappingInfoMap = this.getTopicQueueMappingManager().getTopicQueueMappingTable().entrySet().stream() .map(entry -\u003e new AbstractMap.SimpleImmutableEntry\u003c\u003e(entry.getKey(), TopicQueueMappingDetail.cloneAsMappingInfo(entry.getValue()))) .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue)); TopicConfigAndMappingSerializeWrapper topicConfigWrapper = this.getTopicConfigManager(). buildSerializeWrapper(topicConfigTable, topicQueueMappingInfoMap); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ³¨å†Œ if (this.brokerConfig.isEnableSplitRegistration() || forceRegister || needRegister(this.brokerConfig.getBrokerClusterName(), this.getBrokerAddr(), this.brokerConfig.getBrokerName(), this.brokerConfig.getBrokerId(), this.brokerConfig.getRegisterBrokerTimeoutMills(), this.brokerConfig.isInBrokerContainer())) { // æ³¨å†Œ broker åˆ°æ‰€æœ‰çš„ namesrv doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper); } } æºç ä½ç½®: org.apache.rocketmq.broker.BrokerController#doRegisterBrokerAll // æ³¨å†Œ broker åˆ°æ‰€æœ‰çš„ namesrv protected void doRegisterBrokerAll(boolean checkOrderConfig, boolean oneway, TopicConfigSerializeWrapper topicConfigWrapper) { if (shutdown) { BrokerController.LOG.info(\"BrokerController#doResterBrokerAll: broker has shutdown, no need to register any more.\"); return; } // å‘èµ· RegisterBrokerRequestHeader è¯·æ±‚, RequestCode.REGISTER_BROKER List\u003cRegisterBrokerResult\u003e registerBrokerResultList = this.brokerOuterAPI.registerBrokerAll( this.brokerConfig.getBrokerClusterName(), this.getBrokerAddr(), this.brokerConfig.ge","date":"2023-10-19","objectID":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/:1:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"02 broker æ³¨å†Œ namesvr","uri":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/"},{"categories":null,"content":" namesrv å¤„ç†æ³¨å†Œè¯·æ±‚æºç ä½ç½®: org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor#processRequest public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException { ... case RequestCode.REGISTER_BROKER: // æ³¨å†Œ broker return this.registerBroker(ctx, request); ... } æºç ä½ç½®: org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor#registerBroker // æ³¨å†Œ broker public RemotingCommand registerBroker(ChannelHandlerContext ctx, RemotingCommand request) throws RemotingCommandException { // è§£æå‡º RegisterBrokerResponseHeader final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class); final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader(); final RegisterBrokerRequestHeader requestHeader = (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class); // æ ¡éªŒ crc32 if (!checksum(ctx, request, requestHeader)) { response.setCode(ResponseCode.SYSTEM_ERROR); response.setRemark(\"crc32 not match\"); return response; } TopicConfigSerializeWrapper topicConfigWrapper = null; List\u003cString\u003e filterServerList = null; // è·å– topic é…ç½® Version brokerVersion = MQVersion.value2Version(request.getVersion()); if (brokerVersion.ordinal() \u003e= MQVersion.Version.V3_0_11.ordinal()) { final RegisterBrokerBody registerBrokerBody = extractRegisterBrokerBodyFromRequest(request, requestHeader); topicConfigWrapper = registerBrokerBody.getTopicConfigSerializeWrapper(); filterServerList = registerBrokerBody.getFilterServerList(); } else { // RegisterBrokerBody of old version only contains TopicConfig. topicConfigWrapper = extractRegisterTopicConfigFromRequest(request); } // æ³¨å†Œ broker å’Œ topic ä¿¡æ¯ RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker( requestHeader.getClusterName(), requestHeader.getBrokerAddr(), requestHeader.getBrokerName(), requestHeader.getBrokerId(), requestHeader.getHaServerAddr(), request.getExtFields().get(MixAll.ZONE_NAME), requestHeader.getHeartbeatTimeoutMillis(), requestHeader.getEnableActingMaster(), topicConfigWrapper, filterServerList, ctx.channel() ); if (result == null) { // Register single topic route info should be after the broker completes the first registration. response.setCode(ResponseCode.SYSTEM_ERROR); response.setRemark(\"register broker failed\"); return response; } // è¿”å› master å’Œ HaMaster åœ°å€ responseHeader.setHaServerAddr(result.getHaServerAddr()); responseHeader.setMasterAddr(result.getMasterAddr()); ... return response; } æºç ä½ç½®: org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#registerBroker // æ³¨å†Œ broker å’Œ topic ä¿¡æ¯ // æ­¤æ–¹æ³•çš„ä»£ç æ¯”è¾ƒå¤šï¼Œä½†å¤„ç†é€»è¾‘æ¯”è¾ƒæ¸…æ™° public RegisterBrokerResult registerBroker( final String clusterName, final String brokerAddr, final String brokerName, final long brokerId, final String haServerAddr, final String zoneName, final Long timeoutMillis, final Boolean enableActingMaster, final TopicConfigSerializeWrapper topicConfigWrapper, final List\u003cString\u003e filterServerList, final Channel channel) { RegisterBrokerResult result = new RegisterBrokerResult(); try { this.lock.writeLock().lockInterruptibly(); //init or update the cluster info // æ›´æ–° cluster ä¿¡æ¯ Set\u003cString\u003e brokerNames = ConcurrentHashMapUtils.computeIfAbsent((ConcurrentHashMap\u003cString, Set\u003cString\u003e\u003e) this.clusterAddrTable, clusterName, k -\u003e new HashSet\u003c\u003e()); brokerNames.add(brokerName); boolean registerFirst = false; // æ·»åŠ  broker ä¿¡æ¯ BrokerData brokerData = this.brokerAddrTable.get(brokerName); if (null == brokerData) { registerFirst = true; brokerData = new BrokerData(clusterName, brokerName, new HashMap\u003c\u003e()); this.brokerAddrTable.put(brokerName, brokerData); } boolean isOldVersionBroker = enableActingMaster == null; brokerData.setEnableActingMaster(!isOldVersionBroker \u0026\u0026 enableActingMaster); brokerData.setZoneName(zoneName); Map\u003cLong, String\u003e brokerAddrsMap = brokerData.getBrokerAddrs(); boolean isMinBrokerIdChanged = false; long prevMinBrokerI","date":"2023-10-19","objectID":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/:2:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"02 broker æ³¨å†Œ namesvr","uri":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/"},{"categories":null,"content":" namesrv æ£€æŸ¥å¤±æ•ˆçš„ brokeræºç ä½ç½®: org.apache.rocketmq.namesrv.NamesrvController#startScheduleService private void startScheduleService() { // æ‰«æå¤±æ•ˆçš„ broker this.scanExecutorService.scheduleAtFixedRate(NamesrvController.this.routeInfoManager::scanNotActiveBroker, 5, this.namesrvConfig.getScanNotActiveBrokerInterval(), TimeUnit.MILLISECONDS); ... } æºç ä½ç½®: org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#scanNotActiveBroker // æ‰«æå¤±æ•ˆçš„ broker public void scanNotActiveBroker() { try { log.info(\"start scanNotActiveBroker\"); // éå† brokerLiveTable for (Entry\u003cBrokerAddrInfo, BrokerLiveInfo\u003e next : this.brokerLiveTable.entrySet()) { long last = next.getValue().getLastUpdateTimestamp(); long timeoutMillis = next.getValue().getHeartbeatTimeoutMillis(); // æ£€æŸ¥æ—¶é—´ if ((last + timeoutMillis) \u003c System.currentTimeMillis()) { RemotingHelper.closeChannel(next.getValue().getChannel()); log.warn(\"The broker channel expired, {} {}ms\", next.getKey(), timeoutMillis); this.onChannelDestroy(next.getKey()); } } } catch (Exception e) { log.error(\"scanNotActiveBroker exception\", e); } } ","date":"2023-10-19","objectID":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/:3:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"02 broker æ³¨å†Œ namesvr","uri":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/"},{"categories":null,"content":" æµ‹è¯•ç±»org.apache.rocketmq.test.client.consumer.topic.OneConsumerMulTopicIT#testSynSendMessage ","date":"2023-10-19","objectID":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/:4:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"02 broker æ³¨å†Œ namesvr","uri":"/ooooo-notes/02-broker-%E6%B3%A8%E5%86%8C-namesvr/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ åœ¨è¿™ä¸€èŠ‚ï¼Œè¯¦ç»†ä»‹ç» BoundaryEvent, è¿™æ˜¯å·¥ä½œæµæ¡†æ¶ä¸­å¾ˆé‡è¦çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶æ¶‰åŠåˆ°å®šæ—¶ä»»åŠ¡ã€‚ å…ˆæ¥çœ‹çœ‹ BoundaryEvent çš„ xml å®šä¹‰ \u003cuserTask id=\"firstTask\" name=\"First Task\" /\u003e \u003c!-- åœ¨åˆ°è¾¾ firstTask èŠ‚ç‚¹æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ --\u003e \u003cboundaryEvent id=\"escalationTimer1\" cancelActivity=\"true\" attachedToRef=\"firstTask\"\u003e \u003ctimerEventDefinition\u003e \u003ctimeDuration\u003ePT2H\u003c/timeDuration\u003e \u003c/timerEventDefinition\u003e \u003c/boundaryEvent\u003e \u003c!-- åœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹åï¼Œä¼šæµè½¬åˆ° secondTask èŠ‚ç‚¹ --\u003e \u003csequenceFlow id=\"flow3\" sourceRef=\"escalationTimer1\" targetRef=\"secondTask\" /\u003e \u003cuserTask id=\"secondTask\" name=\"Second Task\" /\u003e ","date":"2023-10-17","objectID":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"10 activiti å®šæ—¶ä»»åŠ¡","uri":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},{"categories":null,"content":" æ‰§è¡Œ BoundaryEventæºç ä½ç½®: org.activiti.engine.impl.agenda.ContinueProcessOperation#executeSynchronous // æ¯æµè½¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±ä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³• protected void executeSynchronous(FlowNode flowNode) { commandContext.getHistoryManager().recordActivityStart(execution); .... // Execute any boundary events, sub process boundary events will be executed from the activity behavior if (!inCompensation \u0026\u0026 flowNode instanceof Activity) { // Only activities can have boundary events List\u003cBoundaryEvent\u003e boundaryEvents = ((Activity) flowNode).getBoundaryEvents(); if (CollectionUtil.isNotEmpty(boundaryEvents)) { // æ‰§è¡Œ BoundaryEvent executeBoundaryEvents(boundaryEvents, execution); } } // Execute actual behavior ActivityBehavior activityBehavior = (ActivityBehavior) flowNode.getBehavior(); if (activityBehavior != null) { executeActivityBehavior(activityBehavior, flowNode); } else { logger.debug(\"No activityBehavior on activity '{}' with execution {}\", flowNode.getId(), execution.getId()); Context.getAgenda().planTakeOutgoingSequenceFlowsOperation(execution, true); } } æºç ä½ç½®: org.activiti.engine.impl.agenda.ContinueProcessOperation#executeBoundaryEvents // æ‰§è¡Œ BoundaryEvent protected void executeBoundaryEvents(Collection\u003cBoundaryEvent\u003e boundaryEvents, ExecutionEntity execution) { // The parent execution becomes a scope, and a child execution is created for each of the boundary events // éå† boundaryEvents for (BoundaryEvent boundaryEvent : boundaryEvents) { if (CollectionUtil.isEmpty(boundaryEvent.getEventDefinitions()) || (boundaryEvent.getEventDefinitions().get(0) instanceof CompensateEventDefinition)) { continue; } // A Child execution of the current execution is created to represent the boundary event being active // åˆ›å»ºå­èŠ‚ç‚¹, ä¼šæ–°å¢ä¸€æ¡ ACT_RU_EXECUTION è¡¨çš„æ•°æ® ExecutionEntity childExecutionEntity = commandContext.getExecutionEntityManager().createChildExecution((ExecutionEntity) execution); childExecutionEntity.setParentId(execution.getId()); childExecutionEntity.setCurrentFlowElement(boundaryEvent); childExecutionEntity.setScope(false); // è·å– behavior ActivityBehavior boundaryEventBehavior = ((ActivityBehavior) boundaryEvent.getBehavior()); logger.debug(\"Executing boundary event activityBehavior {} with execution {}\", boundaryEventBehavior.getClass(), childExecutionEntity.getId()); // æ‰§è¡Œ behavior boundaryEventBehavior.execute(childExecutionEntity); } } æºç ä½ç½®: org.activiti.engine.impl.bpmn.behavior.BoundaryTimerEventActivityBehavior#execute // æ‰§è¡Œ behavior public void execute(DelegateExecution execution) { ExecutionEntity executionEntity = (ExecutionEntity) execution; if (!(execution.getCurrentFlowElement() instanceof BoundaryEvent)) { throw new ActivitiException(\"Programmatic error: \" + this.getClass() + \" should not be used for anything else than a boundary event\"); } JobManager jobManager = Context.getCommandContext().getJobManager(); // åˆ›å»ºå®šæ—¶ä»»åŠ¡ TimerJobEntity timerJob = jobManager.createTimerJob(timerEventDefinition, interrupting, executionEntity, TriggerTimerEventJobHandler.TYPE, TimerEventHandler.createConfiguration(execution.getCurrentActivityId(), timerEventDefinition.getEndDate(), timerEventDefinition.getCalendarName())); if (timerJob != null) { // è°ƒåº¦å®šæ—¶ä»»åŠ¡, ä¼šæ–°å¢ä¸€æ¡ ACT_RU_TIMER_JOB è¡¨ jobManager.scheduleTimerJob(timerJob); } } public void scheduleTimerJob(TimerJobEntity timerJob) { ... // ä¼šæ–°å¢ä¸€æ¡ ACT_RU_TIMER_JOB è¡¨ processEngineConfiguration.getTimerJobEntityManager().insert(timerJob); .. } ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“é‡åˆ° BoundaryEvent æ—¶ï¼Œæ•°æ®åº“å°±ä¼šæ’å…¥ä¸¤æ¡æ•°æ®ï¼Œåˆ†åˆ«ä¸º ACT_RU_EXECUTION å’Œ ACT_RU_TIMER_JOBã€‚å½“å‰èŠ‚ç‚¹å¦‚æœåœä½äº†ï¼Œè¿™äº›æ•°æ®å°±ä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚ ","date":"2023-10-17","objectID":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"10 activiti å®šæ—¶ä»»åŠ¡","uri":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},{"categories":null,"content":" è½®è¯¢ timerJobæºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.AcquireTimerJobsRunnable#run // åœ¨å·¥ä½œæµæ¡†æ¶å¯åŠ¨æ—¶,è¿™ä¸ªè½®è¯¢ä»»åŠ¡å°±ä¼šæ‰§è¡Œ public synchronized void run() { log.info(\"{} starting to acquire async jobs due\"); Thread.currentThread().setName(\"activiti-acquire-timer-jobs\"); final CommandExecutor commandExecutor = asyncExecutor.getProcessEngineConfiguration().getCommandExecutor(); while (!isInterrupted) { try { // è·å–åˆ°æœŸçš„ timerJob final AcquiredTimerJobEntities acquiredJobs = commandExecutor.execute(new AcquireTimerJobsCmd(asyncExecutor)); commandExecutor.execute(new Command\u003cVoid\u003e() { @Override public Void execute(CommandContext commandContext) { for (TimerJobEntity job : acquiredJobs.getJobs()) { // ç§»åŠ¨ timerJob åˆ° job ä¸­ï¼Œä¹Ÿå°±æ˜¯ ACT_RU_TIMER_JOB è¡¨æ•°æ®åˆ° ACT_RU_JOB è¡¨ jobManager.moveTimerJobToExecutableJob(job); } return null; } }); } catch (ActivitiOptimisticLockingException optimisticLockingException) { // å‘ç”Ÿè¿™ä¸ªå¼‚å¸¸ï¼Œè¯´æ˜åŒæ—¶æœ‰å¦å¤–ä¸€ä¸ªæœåŠ¡è·å–ç›¸åŒçš„ timerJob if (log.isDebugEnabled()) { log.debug(\"Optimistic locking exception during timer job acquisition. If you have multiple timer executors running against the same database, \" + \"this exception means that this thread tried to acquire a timer job, which already was acquired by another timer executor acquisition thread.\" + \"This is expected behavior in a clustered environment. \" + \"You can ignore this message if you indeed have multiple timer executor acquisition threads running against the same database. \" + \"Exception message: {}\", optimisticLockingException.getMessage()); } } catch (Throwable e) { log.error(\"exception during timer job acquisition: {}\", e.getMessage(), e); millisToWait = asyncExecutor.getDefaultTimerJobAcquireWaitTimeInMillis(); } ...çœç•¥ç­‰å¾…çš„ä»£ç  } log.info(\"{} stopped async job due acquisition\"); } æºç ä½ç½®: org.activiti.engine.impl.cmd.AcquireTimerJobsCmd#execute // è·å–åˆ°æœŸçš„ timerJob public AcquiredTimerJobEntities execute(CommandContext commandContext) { AcquiredTimerJobEntities acquiredJobs = new AcquiredTimerJobEntities(); // æŸ¥æ‰¾åˆ°æœŸçš„ timerJob, mapperId = selectTimerJobsToExecute List\u003cTimerJobEntity\u003e timerJobs = commandContext.getTimerJobEntityManager() .findTimerJobsToExecute(new Page(0, asyncExecutor.getMaxAsyncJobsDuePerAcquisition())); for (TimerJobEntity job : timerJobs) { // é”å®š timerJob, é˜²æ­¢æœ‰å…¶ä»–æœåŠ¡è·å– // è¿™é‡Œåªæ˜¯è®¾ç½®äº†å±æ€§ï¼Œå› ä¸º TimerJobEntity å®ç°äº† HasRevision æ¥å£ï¼Œä¼šæ ¹æ® reversion æ¥åˆ¤æ–­æ˜¯å¦å¹¶å‘ lockJob(commandContext, job, asyncExecutor.getAsyncJobLockTimeInMillis()); acquiredJobs.addJob(job); } return acquiredJobs; } æºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.DefaultJobManager#moveTimerJobToExecutableJob // ç§»åŠ¨ timerJob åˆ° job ä¸­ public JobEntity moveTimerJobToExecutableJob(TimerJobEntity timerJob) { ... // åˆ›å»º job JobEntity executableJob = createExecutableJobFromOtherJob(timerJob); // æ’å…¥ job boolean insertSuccesful = processEngineConfiguration.getJobEntityManager().insertJobEntity(executableJob); if (insertSuccesful) { // åˆ é™¤ timerJob processEngineConfiguration.getTimerJobEntityManager().delete(timerJob); // è§¦å‘ job æ‰§è¡Œï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ asyncExecutor.executeAsyncJob(job) triggerExecutorIfNeeded(executableJob); return executableJob; } return null; } ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå…ˆä¼šç­›é€‰åˆ°æœŸçš„ timerJob, ç„¶åç§»åŠ¨åˆ° job ä¸­ï¼Œç„¶åå†è§¦å‘æ‰§è¡Œã€‚ ","date":"2023-10-17","objectID":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"10 activiti å®šæ—¶ä»»åŠ¡","uri":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},{"categories":null,"content":" æ‰§è¡Œ jobæºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.DefaultAsyncJobExecutor#executeAsyncJob // asyncExecutor.executeAsyncJob(job) public boolean executeAsyncJob(final Job job) { Runnable runnable = null; if (isActive) { // åˆ›å»º ExecuteAsyncRunnable runnable = createRunnableForJob(job); try { // æ‰§è¡Œ ExecuteAsyncRunnable executorService.execute(runnable); } catch (RejectedExecutionException e) { CommandContext commandContext = Context.getCommandContext(); if (commandContext != null) { // å‘ç”Ÿå¼‚å¸¸ï¼Œè§£é” job commandContext.getJobManager().unacquire(job); } else { processEngineConfiguration.getCommandExecutor().execute(new Command\u003cVoid\u003e() { public Void execute(CommandContext commandContext) { // å‘ç”Ÿå¼‚å¸¸ï¼Œè§£é” job commandContext.getJobManager().unacquire(job); return null; } }); } // Job queue full, returning true so (if wanted) the acquiring can be throttled return false; } } else { temporaryJobQueue.add(job); } return true; } æºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.ExecuteAsyncRunnable#run // æ‰§è¡Œ ExecuteAsyncRunnable public void run() { if (job == null) { job = processEngineConfiguration.getCommandExecutor().execute(new Command\u003cJobEntity\u003e() { @Override public JobEntity execute(CommandContext commandContext) { return commandContext.getJobEntityManager().findById(jobId); } }); } runInternal(); } protected void runInternal(){ // é”å®š job boolean lockNotNeededOrSuccess = lockJobIfNeeded(); if (lockNotNeededOrSuccess) { // æ‰§è¡Œ job executeJob(); // è§£é” job unlockJobIfNeeded(); } } æºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.ExecuteAsyncRunnable#executeJob // æ‰§è¡Œ job protected void executeJob() { try { // æ‰§è¡Œ ExecuteAsyncJobCmd, æœ€ç»ˆå°±ä¼šæ‰§è¡Œ commandContext.getJobManager().execute(job) processEngineConfiguration.getCommandExecutor().execute(new ExecuteAsyncJobCmd(jobId)); } catch (final ActivitiOptimisticLockingException e) { // å¤„ç†å¤±è´¥çš„ job, æœ€ç»ˆä¼šæ‰§è¡Œ JobRetryCmdï¼Œè¿™ä¸ªå°±ä¸è§£æäº† handleFailedJob(e); } catch (Throwable exception) { // å¤„ç†å¤±è´¥çš„ job, æœ€ç»ˆä¼šæ‰§è¡Œ JobRetryCmdï¼Œè¿™ä¸ªå°±ä¸è§£æäº† handleFailedJob(exception); // Finally, Throw the exception to indicate the ExecuteAsyncJobCmd failed String message = \"Job \" + jobId + \" failed\"; log.error(message, exception); } } æºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.DefaultJobManager#execute // commandContext.getJobManager().execute(job) @Override public void execute(Job job) { if (job instanceof JobEntity) { if (Job.JOB_TYPE_MESSAGE.equals(job.getJobType())) { executeMessageJob((JobEntity) job); } else if (Job.JOB_TYPE_TIMER.equals(job.getJobType())) { // æ‰§è¡Œ timerJob executeTimerJob((JobEntity) job); } } else { throw new ActivitiException(\"Only jobs with type JobEntity are supported to be executed\"); } } æºç ä½ç½®: org.activiti.engine.impl.asyncexecutor.DefaultJobManager#executeTimerJob // æ‰§è¡Œ timerJob protected void executeTimerJob(JobEntity timerEntity) { TimerJobEntityManager timerJobEntityManager = processEngineConfiguration.getTimerJobEntityManager(); ... // timerJob å·²ç»åˆ°æœŸäº†ï¼Œåˆ é™¤ timerJob, dueDate å±æ€§æ˜¯åœ¨ xml æ–‡ä»¶ä¸­é…ç½®çš„ if (timerEntity.getDuedate() != null \u0026\u0026 !isValidTime(timerEntity, timerEntity.getDuedate(), variableScope)) { if (logger.isDebugEnabled()) { logger.debug(\"Timer {} fired. but the dueDate is after the endDate. Deleting timer.\", timerEntity.getId()); } processEngineConfiguration.getJobEntityManager().delete(timerEntity); return; } // ä½¿ç”¨ jobHandler æ¥æ‰§è¡Œ job executeJobHandler(timerEntity); // åˆ é™¤ job processEngineConfiguration.getJobEntityManager().delete(timerEntity); if (logger.isDebugEnabled()) { logger.debug(\"Timer {} fired. Deleting timer.\", timerEntity.getId()); } // repeat å±æ€§ä¸ä¸ºç©ºï¼Œç»§ç»­åˆ›å»º timerJob æ¥æ‰§è¡Œ if (timerEntity.getRepeat() != null) { TimerJobEntity newTimerJobEntity = timerJobEntityManager.createAndCalculateNextTimer(timerEntity, variableScope); if (newTimerJobEntity != null) { scheduleTimerJob(newTimerJobEntity); } } } ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“è·å–åˆ°ä¸€ä¸ª job æ—¶ï¼Œæœ€ç»ˆç”± jobManager è´Ÿè´£æ‰§è¡Œ jobã€‚ ","date":"2023-10-17","objectID":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"10 activiti å®šæ—¶ä»»åŠ¡","uri":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»å®šæ—¶ä»»åŠ¡çš„ä»£ç åœ¨å·¥ä½œæµä¸­æ˜¯æœ€å¤æ‚çš„ï¼Œä¸€å®šè¦å¤šè°ƒè¯•å‡ éã€‚ org.activiti.engine.test.bpmn.event.timer.BoundaryTimerEventTest#testMultipleTimersOnUserTask ","date":"2023-10-17","objectID":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/:4:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"10 activiti å®šæ—¶ä»»åŠ¡","uri":"/ooooo-notes/10-activiti-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ å·¥ä½œæµæ“ä½œæ•°æ®åº“ï¼Œå¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œ SQL è¯­å¥æ¥å®Œæˆçš„ï¼Œè€Œæ˜¯é€šè¿‡æ“ä½œç¼“å­˜å¯¹è±¡æ¥å®ç°çš„ã€‚ ","date":"2023-10-16","objectID":"/ooooo-notes/09-dbsqlsession/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"09 DbSqlSession","uri":"/ooooo-notes/09-dbsqlsession/"},{"categories":null,"content":" Entity ç±»æºç ä½ç½®: org.activiti.engine.impl.persistence.entity.Entity // æ¯ä¸ªæ•°æ®åº“å®ä½“å¯¹è±¡éƒ½ä¼šå®ç°è¿™ä¸ªæ¥å£ public interface Entity { String getId(); void setId(String id); boolean isInserted(); // æ ‡è®°å¯¹è±¡æ˜¯æ–°å¢çš„ void setInserted(boolean inserted); boolean isUpdated(); // æ ‡è®°å¯¹è±¡æ˜¯æ›´æ–°çš„ void setUpdated(boolean updated); boolean isDeleted(); // æ ‡è®°å¯¹è±¡æ˜¯åˆ é™¤çš„ void setDeleted(boolean deleted); /** * Returns a representation of the object, as would be stored in the database. * Used when deciding if updates have occurred to the object or not since it was last loaded. */ // æŒä¹…åŒ–çŠ¶æ€ï¼Œå½“å¯¹è±¡çš„å±æ€§æ²¡æœ‰æ”¹åŠ¨æ—¶ï¼Œä¸éœ€è¦æ›´æ–°åˆ°æ•°æ®åº“ Object getPersistentState(); } ","date":"2023-10-16","objectID":"/ooooo-notes/09-dbsqlsession/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"09 DbSqlSession","uri":"/ooooo-notes/09-dbsqlsession/"},{"categories":null,"content":" HasRevision ç±»æºç ä½ç½®: org.activiti.engine.impl.db.HasRevision // å®ç°å¹¶å‘æ§åˆ¶çš„å®ä½“éœ€è¦å®ç°è¿™ä¸ªæ¥å£ // æ‰§è¡Œ update è¯­å¥ï¼Œç±»ä¼¼ä¸ update reversion = ${revsionNext} where reversion = ${reversion} // åˆ¤æ–­è¿™ä¸ªè¯­å¥çš„å½±å“æ¡æ•°ï¼Œå°±å¯ä»¥çŸ¥é“æ˜¯å¦æœ‰å¹¶å‘äº† public interface HasRevision { void setRevision(int revision); int getRevision(); int getRevisionNext(); } ","date":"2023-10-16","objectID":"/ooooo-notes/09-dbsqlsession/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"09 DbSqlSession","uri":"/ooooo-notes/09-dbsqlsession/"},{"categories":null,"content":" DbSqlSession ç±»æºç ä½ç½®: org.activiti.engine.impl.db.DbSqlSession#insert // æ’å…¥å®ä½“ public void insert(Entity entity) { // åˆ†é… id if (entity.getId() == null) { String id = dbSqlSessionFactory.getIdGenerator().getNextId(); entity.setId(id); } // åŠ å…¥ç¼“å­˜ Class\u003c? extends Entity\u003e clazz = entity.getClass(); if (!insertedObjects.containsKey(clazz)) { insertedObjects.put(clazz, new LinkedHashMap\u003cString, Entity\u003e()); // order of insert is important, hence LinkedHashMap } insertedObjects.get(clazz).put(entity.getId(), entity); entityCache.put(entity, false); // False -\u003e entity is inserted, so always changed // è®¾ç½®ä¸ºæ–°å¢ entity.setInserted(true); } æºç ä½ç½®: org.activiti.engine.impl.db.DbSqlSession#update // æ›´æ–°å®ä½“ public void update(Entity entity) { entityCache.put(entity, false); // false -\u003e we don't store state, meaning it will always be seen as changed // è®¾ç½®ä¸ºæ›´æ–° entity.setUpdated(true); } æºç ä½ç½®: org.activiti.engine.impl.db.DbSqlSession#delete // åˆ é™¤å®ä½“ public void delete(Entity entity) { // æ·»åŠ ç¼“å­˜ Class\u003c? extends Entity\u003e clazz = entity.getClass(); if (!deletedObjects.containsKey(clazz)) { deletedObjects.put(clazz, new LinkedHashMap\u003cString, Entity\u003e()); // order of insert is important, hence LinkedHashMap } deletedObjects.get(clazz).put(entity.getId(), entity); // è®¾ç½®ä¸ºåˆ é™¤ entity.setDeleted(true); } æºç ä½ç½®: org.activiti.engine.impl.db.DbSqlSession#flush // æ›´æ–°åˆ°æ•°æ®åº“ï¼Œæ­¤æ—¶äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ public void flush() { // æœ‰äº›æ›´æ–°å¯¹è±¡å¯èƒ½æ ‡è®°åˆ é™¤äº†ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤ determineUpdatedObjects(); // Needs to be done before the removeUnnecessaryOperations, as removeUnnecessaryOperations will remove stuff from the cache // æœ‰äº›æ–°å¢å¯¹è±¡å¯èƒ½æ ‡è®°åˆ é™¤äº†ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤ removeUnnecessaryOperations(); if (log.isDebugEnabled()) { debugFlush(); } // æ‰§è¡Œ SQL è¯­å¥ flushInserts(); flushUpdates(); flushDeletes(); } æºç ä½ç½®: org.activiti.engine.impl.db.DbSqlSession#commit // æäº¤äº‹åŠ¡ public void commit() { sqlSession.commit(); } ","date":"2023-10-16","objectID":"/ooooo-notes/09-dbsqlsession/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"09 DbSqlSession","uri":"/ooooo-notes/09-dbsqlsession/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ ä»ä¹‹å‰çš„åˆ†æå¯ä»¥å‘ç°ï¼Œå·¥ä½œæµçš„æ¯ä¸ªæ“ä½œéƒ½æ˜¯ä¸€ä¸ª Command, æ‰€ä»¥æœ‰å¿…è¦çœ‹çœ‹å†…éƒ¨çš„å®ç°æœºåˆ¶ã€‚ ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" Command ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.Command // æ¥å£éå¸¸ç®€å•ï¼Œæ‰§è¡Œè¿‡ç¨‹çš„å‚æ•°éƒ½ä» commandContext ä¸­è·å– public interface Command\u003cT\u003e { T execute(CommandContext commandContext); } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" CommandExecutor ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.CommandExecutor // æ¥å£éå¸¸ç®€å•ï¼Œç”¨æ¥æ‰§è¡Œä¸€ä¸ª Command // å®ç°ç±»ä¸º CommandExecutorImpl public interface CommandExecutor { /** * @return the default {@link CommandConfig}, used if none is provided. */ CommandConfig getDefaultConfig(); /** * Execute a command with the specified {@link CommandConfig}. */ \u003cT\u003e T execute(CommandConfig config, Command\u003cT\u003e command); /** * Execute a command with the default {@link CommandConfig}. */ \u003cT\u003e T execute(Command\u003cT\u003e command); } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" CommandConfig ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.CommandConfig // è¿™ä¸ªç±»éå¸¸é‡è¦ï¼Œæ§åˆ¶å‘½ä»¤çš„äº‹åŠ¡çº§åˆ«å’ŒContextå¤ç”¨ public class CommandConfig { private boolean contextReusePossible; private TransactionPropagation propagation; } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" æ‰§è¡Œå‘½ä»¤æºç ä½ç½®: org.activiti.engine.impl.cfg.CommandExecutorImpl#execute // æ‰§è¡Œå‘½ä»¤ @Override public \u003cT\u003e T execute(CommandConfig config, Command\u003cT\u003e command) { // å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ return first.execute(config, command); } è¿è¡Œ org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior CommandInterceptor é¡ºåº ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæœ‰å››ä¸ªæ‹¦æˆªå™¨ï¼ŒLogInterceptorã€CommandContextInterceptorã€TransactionContextInterceptorã€CommandInvokerã€‚ ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:4:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" CommandContextInterceptor ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.CommandContextInterceptor#execute // è¿™ä¸ªæ‹¦æˆªå™¨ç”¨æ¥åˆ›å»º context public \u003cT\u003e T execute(CommandConfig config, Command\u003cT\u003e command) { CommandContext context = Context.getCommandContext(); boolean contextReused = false; // We need to check the exception, because the transaction can be in a // rollback state, and some other command is being fired to compensate (eg. decrementing job retries) // context ä¸å¤ç”¨, éœ€è¦åˆ›å»ºæ–°çš„ context if (!config.isContextReusePossible() || context == null || context.getException() != null) { context = commandContextFactory.createCommandContext(command); } else { log.debug(\"Valid context found. Reusing it for the current command '{}'\", command.getClass().getCanonicalName()); // è®¾ç½®å¤ç”¨ contextReused = true; context.setReused(true); } try { // Push on stack // æ”¾å…¥æ ˆä¸­ï¼Œå¯ä»¥é€šè¿‡ Context æ¥è·å– Context.setCommandContext(context); Context.setProcessEngineConfiguration(processEngineConfiguration); // æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ return next.execute(config, command); } catch (Throwable e) { // è®¾ç½®å¼‚å¸¸ // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰§è¡Œæœ‰å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šä¿ç•™åœ¨ context ä¸­ // å½“æœ‰å¤šä¸ª context æ—¶ï¼Œåé¢ context çš„å¼‚å¸¸ï¼Œä¸ä¼šä¼ é€’åˆ°å‰é¢çš„ context context.exception(e); } finally { try { // å¦‚æœä¸å¤ç”¨ï¼Œå…³é—­ context if (!contextReused) { // æ‰§è¡Œè¯­å¥ï¼Œä½†ä¸ä¼šæäº¤äº‹åŠ¡ context.close(); } } finally { // Pop from stack // ä»æ ˆä¸­ç§»é™¤ Context.removeCommandContext(); Context.removeProcessEngineConfiguration(); Context.removeBpmnOverrideContext(); } } return null; } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:5:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" TransactionContextInterceptor ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.TransactionContextInterceptor#execute // è¿™ä¸ªæ‹¦æˆªå™¨ç”¨æ¥åˆ›å»º transactionContext // ä¸ spring é›†æˆæ—¶ï¼Œä¼šæœ‰å¦å¤–ä¸€ä¸ªæ‹¦æˆªå™¨ SpringTransactionInterceptor æ¥å¼€å¯äº‹åŠ¡ public \u003cT\u003e T execute(CommandConfig config, Command\u003cT\u003e command) { CommandContext commandContext = Context.getCommandContext(); // Storing it in a variable, to reference later (it can change during command execution) boolean isReused = commandContext.isReused(); try { if (transactionContextFactory != null \u0026\u0026 !isReused) { // åˆ›å»º transactionContext TransactionContext transactionContext = transactionContextFactory.openTransactionContext(commandContext); Context.setTransactionContext(transactionContext); // æ·»åŠ å…³é—­ç›‘å¬å™¨ï¼Œåœ¨å…³é—­æ—¶ä¼šæäº¤äº‹åŠ¡ï¼Œåœ¨å¼‚å¸¸æ—¶ä¼šå›æ»šäº‹åŠ¡ commandContext.addCloseListener(new TransactionCommandContextCloseListener(transactionContext)); } // æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ return next.execute(config, command); } finally { if (transactionContextFactory != null \u0026\u0026 !isReused) { Context.removeTransactionContext(); } } } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:6:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" SpringTransactionInterceptor ç±»æºç ä½ç½®: org.activiti.spring.SpringTransactionInterceptor#execute æ‹¦æˆªå™¨é¡ºåºå‚è€ƒ: org.activiti.engine.impl.cfg.ProcessEngineConfigurationImpl#getDefaultCommandInterceptors // ä¸ spring é›†æˆæ—¶ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨ä¼šè‡ªåŠ¨æ¿€æ´»ï¼Œè´Ÿè´£å¼€å§‹äº‹åŠ¡ // è¿™ä¸ªæ‹¦æˆªå™¨åœ¨ CommandContextInterceptor ä¹‹å‰ public \u003cT\u003e T execute(final CommandConfig config, final Command\u003cT\u003e command) { LOGGER.debug(\"Running command with propagation {}\", config.getTransactionPropagation()); TransactionTemplate transactionTemplate = new TransactionTemplate(transactionManager); // è®¾ç½®äº‹åŠ¡ä¼ æ’­è¡Œä¸º transactionTemplate.setPropagationBehavior(getPropagation(config)); // å¼€å¯äº‹åŠ¡ T result = transactionTemplate.execute(new TransactionCallback\u003cT\u003e() { public T doInTransaction(TransactionStatus status) { return next.execute(config, command); } }); return result; } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:7:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" CommandInvoker ç±»æºç ä½ç½®: org.activiti.engine.impl.interceptor.CommandInvoker#execute // è¿™ä¸ªæ‹¦æˆªå™¨è´Ÿè´£æ‰§è¡Œå‘½ä»¤ public \u003cT\u003e T execute(final CommandConfig config, final Command\u003cT\u003e command) { final CommandContext commandContext = Context.getCommandContext(); // Execute the command. // This will produce operations that will be put on the agenda. // æ·»åŠ å‘½ä»¤åˆ° Agenda ä¸­, è¿™é‡Œçš„è®¾è®¡å¾ˆç²¾å¦™ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå‘½ä»¤ä¸­æ‰§è¡Œå¦å¤–çš„å‘½ä»¤ commandContext.getAgenda().planOperation(new Runnable() { @Override public void run() { commandContext.setResult(command.execute(commandContext)); } }); // Run loop for agenda // å–å‡ºå‘½ä»¤æ¥æ‰§è¡Œ executeOperations(commandContext); // At the end, call the execution tree change listeners. // TODO: optimization: only do this when the tree has actually changed (ie check dbSqlSession). if (commandContext.hasInvolvedExecutions()) { Context.getAgenda().planExecuteInactiveBehaviorsOperation(); executeOperations(commandContext); } // è·å–ç»“æœ return (T) commandContext.getResult(); } // å–å‡ºå‘½ä»¤æ¥æ‰§è¡Œ protected void executeOperations(final CommandContext commandContext) { while (!commandContext.getAgenda().isEmpty()) { Runnable runnable = commandContext.getAgenda().getNextOperation(); executeOperation(runnable); } } ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:8:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" æµ‹è¯•ç±»org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior ","date":"2023-10-15","objectID":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/:9:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"08 CommandExecutor æ‰§è¡Œå‘½ä»¤","uri":"/ooooo-notes/08-commandexecutor-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" rocketmq åŸºäº 5.1.4 ç‰ˆæœ¬ ","date":"2023-10-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:0:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"01 æ­å»º rocketmq æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" å¯åŠ¨ namesrvåœ¨ org.apache.rocketmq.namesrv.NamesrvStartup ä¸­ï¼Œé…ç½®ç¯å¢ƒå˜é‡ ROCKETMQ_HOMEï¼Œå¦‚ä¸‹å›¾ã€‚ å¯åŠ¨ namesrv ","date":"2023-10-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"01 æ­å»º rocketmq æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" å¯åŠ¨ brokeråœ¨ org.apache.rocketmq.broker.BrokerController ä¸­ï¼Œé…ç½®ç¯å¢ƒå˜é‡ ROCKETMQ_HOME å’Œå¯åŠ¨å‚æ•°ï¼Œå¦‚ä¸‹å›¾ã€‚ # -n æŒ‡å®š namesrv çš„åœ°å€ # -c æŒ‡å®š broker é…ç½®æ–‡ä»¶ -n localhost:9876 -c C:\\Users\\ooooo\\Development\\Code\\Demo\\rocketmq\\rocketmq-home\\conf\\broker.conf å¯åŠ¨ broker ","date":"2023-10-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"01 æ­å»º rocketmq æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" æµ‹è¯•ç±»åœ¨ rocketmq ä¸­æœ‰å¾ˆå¤šçš„æµ‹è¯•ç±»ï¼Œåœ¨çœ‹æºç çš„æ—¶å€™ï¼Œéœ€è¦è°ƒè¯•æµ‹è¯•ç±»ï¼Œæ¯”å¦‚ org.apache.rocketmq.test.client.consumer.topic.OneConsumerMulTopicIT#testSynSendMessage ","date":"2023-10-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:3:0","tags":["rocketmq","source code","æºç åˆ†æ rocketmq ç³»åˆ—"],"title":"01 æ­å»º rocketmq æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-rocketmq-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ é€šè¿‡åœ¨ã€agendaæµè½¬èŠ‚ç‚¹ã€‘ç« èŠ‚ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„è¡Œä¸ºç”±å¯¹åº”çš„ behavior æ¥å†³å®šï¼Œæ‰€ä»¥æœ‰å¿…è¦çœ‹çœ‹å¸¸ç”¨çš„ behavior å®ç°ã€‚ ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" StartEventå¯¹åº”çš„ behavior ç±»: NoneStartEventActivityBehavior å¯ä»¥è¿è¡Œ org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior æ¥è°ƒè¯•ã€‚ // æ²¡æœ‰å®ç° executeï¼Œç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„æ–¹æ³• public void execute(DelegateExecution execution) { // ç¦»å¼€èŠ‚ç‚¹ leave(execution); } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" ReceiveTaskå¯¹åº”çš„ behavior ç±»: ReceiveTaskActivityBehavior å¯ä»¥è¿è¡Œ org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior æ¥è°ƒè¯•ã€‚ // ç©ºå®ç°ï¼Œè¡¨ç¤ºåœåœ¨å½“å‰èŠ‚ç‚¹ public void execute(DelegateExecution execution) { // Do nothing: waitstate behavior } // è°ƒç”¨ org.activiti.engine.RuntimeService#trigger æ–¹æ³•æ¥æµè½¬åˆ°ä¸‹ä¸ªèŠ‚ç‚¹ public void trigger(DelegateExecution execution, String signalName, Object data) { leave(execution); } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" ServiceTaskå®é™…ä¸Šæœ‰å¤šä¸ªå®ç°ç±»ï¼Œåˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œè¿™é‡Œä»¥ DefaultServiceTaskBehavior ä¸ºä¾‹. å¯ä»¥è¿è¡Œæ¨¡å— activiti-examples/activiti-api-basic-connector-example æ¥è°ƒè¯•ã€‚ @Override public void execute(DelegateExecution execution) { // è·å– connector Connector connector = getConnector(getImplementation(execution)); // æ‰§è¡Œ IntegrationContext integrationContext = connector.apply(integrationContextBuilder.from(execution)); variablesPropagator.propagate(execution, integrationContext.getOutBoundVariables()); // ç¦»å¼€èŠ‚ç‚¹ leave(execution); } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" UserTaskå¯¹åº”çš„ behavior ç±»: UserTaskActivityBehavior å¯ä»¥è¿è¡Œ org.activiti.examples.bpmn.usertask.SkipExpressionUserTaskTest#test æ¥è°ƒè¯• // è¿™ä¸ªæ–¹æ³•çš„ä»£ç æ¯”è¾ƒå¤šï¼Œä½†æ˜¯ä»£ç ç»“æ„å¾ˆæ¸…æ™° public void execute(DelegateExecution execution) { CommandContext commandContext = Context.getCommandContext(); TaskEntityManager taskEntityManager = commandContext.getTaskEntityManager(); // åˆ›å»º TaskEntityï¼Œç„¶åå¡«å……å‚æ•° TaskEntity task = taskEntityManager.create(); ExecutionEntity executionEntity = (ExecutionEntity) execution; task.setExecution(executionEntity); task.setTaskDefinitionKey(userTask.getId()); task.setBusinessKey(executionEntity.getProcessInstanceBusinessKey()); ... // æ–°å¢ ACT_RU_TASK è¡¨æ•°æ® taskEntityManager.insert(task, executionEntity); ... if (skipUserTask) { // åˆ é™¤ ACT_RU_TASK è¡¨æ•°æ® taskEntityManager.deleteTask(task, null, false, false); // ç¦»å¼€èŠ‚ç‚¹ leave(execution); } } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:4:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" BoundaryTimerEventå¯¹åº”çš„ behavior ç±»: BoundaryTimerEventActivityBehavior å¯ä»¥è¿è¡Œ org.activiti.examples.bpmn.event.timer.BoundaryTimerEventTest#testInterruptingTimerDuration æ¥è°ƒè¯• è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œæ¶‰åŠåˆ°å·¥ä½œæµçš„å®šæ—¶å™¨ï¼Œä»¥åä¼šç»§ç»­è§£æ @Override public void execute(DelegateExecution execution) { ExecutionEntity executionEntity = (ExecutionEntity) execution; // åˆ¤æ–­æ˜¯å¦ä¸ºè¾¹ç•Œäº‹ä»¶ if (!(execution.getCurrentFlowElement() instanceof BoundaryEvent)) { throw new ActivitiException(\"Programmatic error: \" + this.getClass() + \" should not be used for anything else than a boundary event\"); } JobManager jobManager = Context.getCommandContext().getJobManager(); // åˆ›å»ºå®šæ—¶ä»»åŠ¡ TimerJobEntity timerJob = jobManager.createTimerJob(timerEventDefinition, interrupting, executionEntity, TriggerTimerEventJobHandler.TYPE, TimerEventHandler.createConfiguration(execution.getCurrentActivityId(), timerEventDefinition.getEndDate(), timerEventDefinition.getCalendarName())); if (timerJob != null) { // è°ƒåº¦å®šæ—¶ä»»åŠ¡, æ’å…¥åˆ° ACT_RU_TIMER_JOB è¡¨ jobManager.scheduleTimerJob(timerJob); } } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:5:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" EndEventå¯¹åº”çš„ behavior ç±»: NoneEndEventActivityBehavior å¯ä»¥è¿è¡Œ org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior æ¥è°ƒè¯•ã€‚ public void execute(DelegateExecution execution) { // EndEvent æ²¡æœ‰è¿çº¿äº†ï¼Œæ‰€ä»¥ä¼šç»“æŸæµç¨‹, ä¼šæ‰§è¡Œ Agenda#planEndExecutionOperation Context.getAgenda().planTakeOutgoingSequenceFlowsOperation((ExecutionEntity) execution, true); } ","date":"2023-10-14","objectID":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/:6:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"07 å¸¸ç”¨çš„ ActivityBehavior","uri":"/ooooo-notes/07-%E5%B8%B8%E7%94%A8%E7%9A%84-activitybehavior/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ Agenda ç±»æ˜¯å·¥ä½œæµæ¡†æ¶ä¸­éå¸¸é‡è¦çš„ç±»ï¼Œå®ƒæ§åˆ¶ç€èŠ‚ç‚¹æ€ä¹ˆæµè½¬ã€‚è¿™éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å¤šè°ƒè¯•å‡ éã€‚ä¸‹é¢çš„ä»£ç å®é™…ä¸Šæ˜¯ä¸€ä¸ªé—­ç¯ï¼Œä»å¼€å§‹çš„ä»£ç ï¼Œç»è¿‡æµè½¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆå›åˆ°äº†å¼€å§‹çš„ä»£ç ã€‚ ","date":"2023-10-13","objectID":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"06 Agenda æµè½¬èŠ‚ç‚¹","uri":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/"},{"categories":null,"content":" æµè½¬èŠ‚ç‚¹æºç ä½ç½®: org.activiti.engine.impl.agenda.DefaultActivitiEngineAgenda#planContinueProcessOperation // æµè½¬ startEvent èŠ‚ç‚¹ï¼Œåœ¨å¯åŠ¨æµç¨‹ä¹‹åï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• @Override public void planContinueProcessOperation(ExecutionEntity execution) { // æœ€ç»ˆä¼šæ‰§è¡Œ ContinueProcessOperation#run æ–¹æ³• planOperation(new ContinueProcessOperation(commandContext, execution)); } æºç ä½ç½®: org.activiti.engine.impl.agenda.ContinueProcessOperation#run // æ‰§è¡Œ ContinueProcessOperation#run æ–¹æ³• @Override public void run() { // è·å–å½“å‰èŠ‚ç‚¹ FlowElement currentFlowElement = getCurrentFlowElement(execution); if (currentFlowElement instanceof FlowNode) { // å¤„ç†èŠ‚ç‚¹ continueThroughFlowNode((FlowNode) currentFlowElement); } else if (currentFlowElement instanceof SequenceFlow) { // å¤„ç†è¿çº¿ continueThroughSequenceFlow((SequenceFlow) currentFlowElement); } else { throw new ActivitiException(\"Programmatic error: no current flow element found or invalid type: \" + currentFlowElement + \". Halting.\"); } } æºç ä½ç½®: org.activiti.engine.impl.agenda.ContinueProcessOperation#continueThroughFlowNode // å¤„ç†èŠ‚ç‚¹ protected void continueThroughFlowNode(FlowNode flowNode) { // Check if it's the initial flow element. If so, we must fire the execution listeners for the process too if (flowNode.getIncomingFlows() != null \u0026\u0026 flowNode.getIncomingFlows().size() == 0 \u0026\u0026 flowNode.getSubProcess() == null) { // å‘å¸ƒ StartExecution äº‹ä»¶ executeProcessStartExecutionListeners(); } ... if (isMultiInstance(flowNode)) { // the multi instance execution will look at async executeMultiInstanceSynchronous(flowNode); } else if (forceSynchronousOperation || !flowNode.isAsynchronous()) { // åŒæ­¥æ‰§è¡Œï¼Œè¿™é‡Œä¼šç­‰å¾…æµè½¬èŠ‚ç‚¹å®Œæˆ, é‡ç‚¹åˆ†æè¿™ä¸ªï¼Œé»˜è®¤éƒ½æ˜¯åŒæ­¥æ‰§è¡Œ executeSynchronous(flowNode); } else { // å¼‚æ­¥æ‰§è¡Œ, ä¸ä¼šç­‰å¾… executeAsynchronous(flowNode); } } æºç ä½ç½®: org.activiti.engine.impl.agenda.ContinueProcessOperation#executeSynchronous // åŒæ­¥æ‰§è¡Œï¼Œè¿™é‡Œä¼šç­‰å¾…æµè½¬èŠ‚ç‚¹å®Œæˆ protected void executeSynchronous(FlowNode flowNode) { // ä¼šæ’å…¥åˆ°å†å²èŠ‚ç‚¹è¡¨ ACT_HI_ACTINST commandContext.getHistoryManager().recordActivityStart(execution); // Execution listener: event 'start' // æ‰§è¡Œç›‘å¬å™¨ï¼Œé»˜è®¤ä¸ºç©º if (CollectionUtil.isNotEmpty(flowNode.getExecutionListeners())) { executeExecutionListeners(flowNode, ExecutionListener.EVENTNAME_START); } // Execute any boundary events, sub process boundary events will be executed from the activity behavior if (!inCompensation \u0026\u0026 flowNode instanceof Activity) { // Only activities can have boundary events List\u003cBoundaryEvent\u003e boundaryEvents = ((Activity) flowNode).getBoundaryEvents(); if (CollectionUtil.isNotEmpty(boundaryEvents)) { // æ‰§è¡Œ BoundaryEventï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œä¼šåœ¨ä»¥åçš„ç« èŠ‚è§£æ // è¿™é‡Œä¼šæ–°å¢ä¸€æ¡ ACT_RU_EXECUTION è¡¨çš„æ•°æ® executeBoundaryEvents(boundaryEvents, execution); } } // Execute actual behavior // è·å– behavior, åœ¨ã€è§£ææµç¨‹ã€‘ç« èŠ‚è¯´è¿‡çš„ ActivityBehavior activityBehavior = (ActivityBehavior) flowNode.getBehavior(); if (activityBehavior != null) { // æ‰§è¡Œ behavior // å½“å‰çš„ flowNode æ˜¯ StartEventï¼Œæ‰€ä»¥ behavior ä¸º NoneStartEventActivityBehavior executeActivityBehavior(activityBehavior, flowNode); } else { logger.debug(\"No activityBehavior on activity '{}' with execution {}\", flowNode.getId(), execution.getId()); // behavior ä¸º nullï¼Œä¼šæµè½¬åˆ°ä¸‹ä¸ªèŠ‚ç‚¹ Context.getAgenda().planTakeOutgoingSequenceFlowsOperation(execution, true); } } æºç ä½ç½®: org.activiti.engine.impl.bpmn.behavior.FlowNodeActivityBehavior#execute // NoneStartEventActivityBehavior æ²¡æœ‰å®ç° execute æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• public void execute(DelegateExecution execution) { // ç¦»å¼€å½“å‰èŠ‚ç‚¹ leave(execution); } // ç¦»å¼€å½“å‰èŠ‚ç‚¹ public void leave(DelegateExecution execution) { // æ‰§è¡Œ outgoing bpmnActivityBehavior.performDefaultOutgoingBehavior((ExecutionEntity) execution); } // æ‰§è¡Œ outgoing protected void performOutgoingBehavior(ExecutionEntity execution, boolean checkConditions, boolean throwExceptionIfExecutionStuck) { // æ‰§è¡Œ TakeOutgoingSequenceFlowsOperation#run æ–¹æ³• getAgenda().planTakeOutgoingSequenceFlowsOperation(execution, true); } æºç ä½ç½®: org.activiti.engine.impl.agenda.TakeOutgoingSequenceFlowsOperation#run // TakeOutgoingSequenceFlowsOperation @Override public void run() { // å½“å‰èŠ‚ç‚¹å…ƒç´ ï¼Œæ­¤æ—¶æ˜¯ startEvent FlowElement currentFlowElement = getCurre","date":"2023-10-13","objectID":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"06 Agenda æµè½¬èŠ‚ç‚¹","uri":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/"},{"categories":null,"content":" æµ‹è¯•ç±»org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior ","date":"2023-10-13","objectID":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"06 Agenda æµè½¬èŠ‚ç‚¹","uri":"/ooooo-notes/06-agenda-%E6%B5%81%E8%BD%AC%E8%8A%82%E7%82%B9/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ å¯åŠ¨æµç¨‹çš„æ–¹æ³•æœ‰å¤šä¸ªï¼Œè¿™é‡Œä»¥ startProcessInstanceByKey ä¸ºå…¥å£æ¥åˆ†æ ","date":"2023-10-12","objectID":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"05 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" å¯åŠ¨æµç¨‹æºç ä½ç½®: org.activiti.engine.impl.RuntimeServiceImpl#startProcessInstanceByKey // å¯åŠ¨æµç¨‹ public ProcessInstance startProcessInstanceByKey(String processDefinitionKey) { // æ‰§è¡Œ StartProcessInstanceCmd return commandExecutor.execute(new StartProcessInstanceCmd\u003cProcessInstance\u003e(processDefinitionKey, null, null, null)); } æºç ä½ç½®: org.activiti.engine.impl.cmd.StartProcessInstanceCmd#execute // æ‰§è¡Œ StartProcessInstanceCmd public ProcessInstance execute(CommandContext commandContext) { // åœ¨éƒ¨ç½²æµç¨‹æ—¶ï¼Œä¼šå°†æµç¨‹å®šä¹‰åŠ å…¥åˆ°ç¼“å­˜ DeploymentManager deploymentCache = commandContext.getProcessEngineConfiguration().getDeploymentManager(); ProcessDefinitionRetriever processRetriever = new ProcessDefinitionRetriever(this.tenantId, deploymentCache); // è·å–æµç¨‹å®šä¹‰ ProcessDefinition processDefinition = processRetriever.getProcessDefinition(this.processDefinitionId, this.processDefinitionKey); processInstanceHelper = commandContext.getProcessEngineConfiguration().getProcessInstanceHelper(); // åˆ›å»ºå’Œå¯åŠ¨æµç¨‹å®ä¾‹ ProcessInstance processInstance = createAndStartProcessInstance(processDefinition, businessKey, processInstanceName, variables, transientVariables); return processInstance; } æºç ä½ç½®: org.activiti.engine.impl.util.ProcessInstanceHelper#createAndStartProcessInstance // åˆ›å»ºå’Œå¯åŠ¨æµç¨‹å®ä¾‹ protected ProcessInstance createAndStartProcessInstance(ProcessDefinition processDefinition, String businessKey, String processInstanceName, Map\u003cString, Object\u003e variables, Map\u003cString, Object\u003e transientVariables, boolean startProcessInstance) { // è·å–ä¸»æµç¨‹ Process process = this.getActiveProcess(processDefinition); // è·å–å¼€å§‹å…ƒç´ ï¼Œå°±æ˜¯ StartEvent å¯¹è±¡ FlowElement initialFlowElement = this.getInitialFlowElement(process, processDefinition.getId()); // åˆ›å»ºå’Œå¯åŠ¨æµç¨‹ return createAndStartProcessInstanceWithInitialFlowElement(processDefinition, businessKey, processInstanceName, initialFlowElement, process, variables, transientVariables, startProcessInstance); } æºç ä½ç½®: org.activiti.engine.impl.util.ProcessInstanceHelper#createAndStartProcessInstanceWithInitialFlowElement public ProcessInstance createAndStartProcessInstanceWithInitialFlowElement(ProcessDefinition processDefinition, String businessKey, String processInstanceName, FlowElement initialFlowElement, Process process, Map\u003cString, Object\u003e variables, Map\u003cString, Object\u003e transientVariables, boolean startProcessInstance) { // åˆ›å»ºæµç¨‹å®ä¾‹ ExecutionEntity processInstance = createProcessInstanceWithInitialFlowElement(processDefinition, businessKey, processInstanceName, initialFlowElement, process); if (startProcessInstance) { CommandContext commandContext = Context.getCommandContext(); // å¯åŠ¨æµç¨‹å®ä¾‹ startProcessInstance(processInstance, commandContext, variables, initialFlowElement, transientVariables); } // è¿”å› return processInstance; } ","date":"2023-10-12","objectID":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"05 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" åˆ›å»ºæµç¨‹å®ä¾‹æºç ä½ç½®: org.activiti.engine.impl.util.ProcessInstanceHelper#createProcessInstanceWithInitialFlowElement // åˆ›å»ºæµç¨‹å®ä¾‹ public ExecutionEntity createProcessInstanceWithInitialFlowElement(ProcessDefinition processDefinition, String businessKey, String processInstanceName, FlowElement initialFlowElement, Process process) { CommandContext commandContext = Context.getCommandContext(); // Create the process instance String initiatorVariableName = null; if (initialFlowElement instanceof StartEvent) { initiatorVariableName = ((StartEvent) initialFlowElement).getInitiator(); } // åˆ›å»ºçˆ¶èŠ‚ç‚¹ï¼Œè¿™é‡Œä¼šæ–°å¢ä¸€æ¡ ACT_RU_EXECUTION è¡¨çš„æ•°æ® // scope ä¸º trueï¼ŒprocessInstanceId å°±æ˜¯è‡ªå·±çš„Id ExecutionEntity processInstance = commandContext.getExecutionEntityManager() .createProcessInstanceExecution(processDefinition, businessKey, processDefinition.getTenantId(), initiatorVariableName); ... // Create the first execution that will visit all the process definition elements // åˆ›å»ºå­èŠ‚ç‚¹ï¼Œè¿™é‡Œä¼šæ–°å¢ä¸€æ¡ ACT_RU_EXECUTION è¡¨çš„æ•°æ® // scope ä¸º false, processInstanceId æ˜¯çˆ¶èŠ‚ç‚¹çš„ Id ExecutionEntity execution = commandContext.getExecutionEntityManager().createChildExecution(processInstance); execution.setCurrentFlowElement(initialFlowElement); // å¯åŠ¨æµç¨‹ï¼Œä¸€èˆ¬å°±ä¼šåˆ›å»ºä¸¤æ¡æ•°æ®åœ¨ ACT_RU_EXECUTION è¡¨ä¸­ï¼Œè¿™ä¸ªå¾ˆé‡è¦ return processInstance; } ","date":"2023-10-12","objectID":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"05 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" å¯åŠ¨æµç¨‹å®ä¾‹æºç ä½ç½®: org.activiti.engine.impl.util.ProcessInstanceHelper#startProcessInstance // å¯åŠ¨æµç¨‹å®ä¾‹ public void startProcessInstance(ExecutionEntity processInstance, CommandContext commandContext, Map\u003cString, Object\u003e variables, FlowElement initialFlowElement, Map\u003cString, Object\u003e transientVariables) { Process process = ProcessDefinitionUtil.getProcess(processInstance.getProcessDefinitionId()); createProcessVariables(processInstance, variables, transientVariables, process); recordStartProcessInstance(commandContext, initialFlowElement, processInstance); ...çœç•¥äº†äº‹ä»¶å­æµç¨‹çš„ä»£ç  // åœ¨åˆ›å»ºæµç¨‹æ—¶ï¼Œä¼šå°†å­èŠ‚ç‚¹åŠ å…¥åˆ°çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­, è¿™æ ·å°±å¯ä»¥ä»æµç¨‹å®ä¾‹ä¸­è·å–å­èŠ‚ç‚¹ // There will always be one child execution created ExecutionEntity execution = processInstance.getExecutions().get(0); execution.setAppVersion(processInstance.getAppVersion()); // æµè½¬èŠ‚ç‚¹ï¼Œè¿™ä¸ªéå¸¸é‡è¦, ä¼šåœ¨ä¸‹ä¸€èŠ‚ç»§ç»­åˆ†æ commandContext.getAgenda().planContinueProcessOperation(execution); } ","date":"2023-10-12","objectID":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"05 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior ","date":"2023-10-12","objectID":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:4:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"05 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/05-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" ä¸ºä»€ä¹ˆå­¦æƒ³å¼€å‘å‰ç«¯çš„äººï¼Œå°±å¿…é¡»å­¦ä¹  vueï¼Œæˆ‘ä¹‹å‰ä¹Ÿå­¦ä¹ è¿‡ï¼Œæ‰€ä»¥æˆ‘æ¥è°ˆè°ˆæ€ä¹ˆå­¦ä¹  vueã€‚ ","date":"2023-10-12","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-vue/:1:0","tags":["vue","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ vue","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-vue/"},{"categories":null,"content":" æ€ä¹ˆå­¦ å¦‚æœä½ æ²¡æœ‰çœ‹è¿‡å®˜æ–¹æ–‡æ¡£ï¼Œè¯´æ˜ä½ å¤§æ¦‚ç‡æ˜¯ä¸€ä¸ª vue èœé¸Ÿã€‚ vue å®˜æ–¹æ–‡æ¡£ vue router å®˜æ–¹æ–‡æ¡£ vuex å®˜æ–¹æ–‡æ¡£ vite å®˜æ–¹æ–‡æ¡£(è¿›é˜¶å¿…å¤‡) pinia å®˜æ–¹æ–‡æ¡£(è¿›é˜¶å¿…å¤‡) ä¹¦ç±-Vue.jsè®¾è®¡ä¸å®ç°(å¼ºçƒˆæ¨è) å­¦ä¹ å®Œä¸Šè¿°çŸ¥è¯†ï¼Œä½ å¯ä»¥ç†Ÿç»ƒæŒæ¡ vue äº†ï¼Œä½ è¿˜éœ€è¦çœ‹ä¸€äº›å®é™…çš„ä»£ç , æ¨ègithub-v3-admin-vite (starå¤šä¸€ç‚¹ï¼Œæˆ‘ä¸ªäººæ²¡æœ‰çœ‹è¿‡) å¼€æºæ¡†æ¶ï¼Œæœ€é‡è¦çš„å°±æ˜¯è¦ç†Ÿæ‚‰æºç ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ çœ‹ vue çš„æºç ï¼Œç„¶åå°±æ¯•ä¸šäº†ã€‚ ","date":"2023-10-12","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-vue/:2:0","tags":["vue","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ vue","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-vue/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ æ¯æ¬¡éƒ¨ç½²æ–°çš„æµç¨‹ï¼Œå¿…å®šä¼šè§£ææµç¨‹æ¥æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œå¹¶å°† xml å…ƒç´ æ˜ å°„åˆ° java å¯¹è±¡ä¸Šã€‚ ","date":"2023-10-11","objectID":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"04 è§£ææµç¨‹","uri":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" è§£ææµç¨‹æºç ä½ç½®: org.activiti.engine.impl.bpmn.deployer.ParsedDeploymentBuilder#createBpmnParseFromResource // åœ¨éƒ¨ç½²æµç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•æ¥è§£ææµç¨‹ protected BpmnParse createBpmnParseFromResource(ResourceEntity resource) { String resourceName = resource.getName(); // æµç¨‹æ–‡ä»¶çš„å­—èŠ‚æµ ByteArrayInputStream inputStream = new ByteArrayInputStream(resource.getBytes()); // åˆ›å»ºè§£æå¯¹è±¡ï¼Œè®¾ç½®å­—èŠ‚æµ BpmnParse bpmnParse = bpmnParser.createParse() .sourceInputStream(inputStream) .setSourceSystemId(resourceName) .deployment(deployment) .name(resourceName); // è®¾ç½®æ ¡éªŒå‚æ•° if (deploymentSettings != null) { // Schema validation if needed if (deploymentSettings.containsKey(DeploymentSettings.IS_BPMN20_XSD_VALIDATION_ENABLED)) { bpmnParse.setValidateSchema((Boolean) deploymentSettings.get(DeploymentSettings.IS_BPMN20_XSD_VALIDATION_ENABLED)); } // Process validation if needed if (deploymentSettings.containsKey(DeploymentSettings.IS_PROCESS_VALIDATION_ENABLED)) { bpmnParse.setValidateProcess((Boolean) deploymentSettings.get(DeploymentSettings.IS_PROCESS_VALIDATION_ENABLED)); } } else { // On redeploy, we assume it is validated at the first deploy bpmnParse.setValidateSchema(false); bpmnParse.setValidateProcess(false); } // æ‰§è¡Œè§£ææµç¨‹ bpmnParse.execute(); return bpmnParse; } æºç ä½ç½®: org.activiti.engine.impl.bpmn.parser.BpmnParse#execute // æ‰§è¡Œè§£ææµç¨‹ public BpmnParse execute() { try { ProcessEngineConfigurationImpl processEngineConfiguration = Context.getProcessEngineConfiguration(); BpmnXMLConverter converter = new BpmnXMLConverter(); boolean enableSafeBpmnXml = false; String encoding = null; if (processEngineConfiguration != null) { enableSafeBpmnXml = processEngineConfiguration.isEnableSafeBpmnXml(); encoding = processEngineConfiguration.getXmlEncoding(); } // è§£æ xml å…ƒç´ ï¼Œè½¬æ¢ä¸º java å¯¹è±¡ï¼Œä¼šè°ƒç”¨ convertToBpmnModel æ–¹æ³• bpmnModel = converter.convertToBpmnModel(streamSource, validateSchema, enableSafeBpmnXml, encoding); ... // Attach logic to the processes (eg. map ActivityBehaviors to bpmn model elements) // åº”ç”¨è§£æå™¨ï¼Œè¿™ä¸ªå¾ˆé‡è¦ applyParseHandlers(); // Finally, process the diagram interchange info processDI(); } catch (Exception e) { ... } return this; } æºç ä½ç½®: org.activiti.bpmn.converter.BpmnXMLConverter#convertToBpmnModel // è§£æ xml å…ƒç´ ï¼Œè½¬æ¢ä¸º java å¯¹è±¡ public BpmnModel convertToBpmnModel(XMLStreamReader xtr) { BpmnModel model = new BpmnModel(); model.setStartEventFormTypes(startEventFormTypes); model.setUserTaskFormTypes(userTaskFormTypes); try { Process activeProcess = null; List\u003cSubProcess\u003e activeSubProcessList = new ArrayList\u003cSubProcess\u003e(); while (xtr.hasNext()) { try { xtr.next(); } catch (Exception e) { LOGGER.debug(\"Error reading XML document\", e); throw new XMLException(\"Error reading XML\", e); } ...çœç•¥äº†ä¸€å †çš„åˆ¤æ–­ä»£ç  } else if (ELEMENT_DI_EDGE.equals(xtr.getLocalName())) { bpmnEdgeParser.parse(xtr, model); } else { if (!activeSubProcessList.isEmpty() \u0026\u0026 ELEMENT_MULTIINSTANCE.equalsIgnoreCase(xtr.getLocalName())) { multiInstanceParser.parseChildElement(xtr, activeSubProcessList.get(activeSubProcessList.size() - 1), model); } else if (convertersToBpmnMap.containsKey(xtr.getLocalName())) { if (activeProcess != null) { // è·å–XMLè½¬æ¢å™¨, å°† XML å…ƒç´ è½¬æ¢ä¸º java å¯¹è±¡ // å½“ä½ éœ€è¦æ‰©å±•æµç¨‹æ–‡ä»¶æ—¶ï¼Œè¿™é‡Œçš„ä»£ç å¾ˆæœ‰ç”¨ BaseBpmnXMLConverter converter = convertersToBpmnMap.get(xtr.getLocalName()); converter.convertToBpmnModel(xtr, model, activeProcess, activeSubProcessList); } } } } for (Process process : model.getProcesses()) { for (Pool pool : model.getPools()) { if (process.getId().equals(pool.getProcessRef())) { pool.setExecutable(process.isExecutable()); } } // å¤„ç†æµç¨‹å…ƒç´ ï¼Œè®¾ç½®èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿ processFlowElements(process.getFlowElements(), process); } } catch (XMLException e) { throw e; } catch (Exception e) { LOGGER.error(\"Error processing BPMN document\", e); throw new XMLException(\"Error processing BPMN document\", e); } return model; } æºç ä½ç½®: org.activiti.engine.impl.bpmn.parser.BpmnParse#applyParseHandlers // åº”ç”¨è§£æå™¨ï¼Œä¼šå¯¹æµç¨‹å…ƒç´ è®¾ç½® behavior, è¿™ä¸ªå¾ˆé‡è¦ protected void applyParseHandlers() { sequenceFlows = new HashMap\u003cString, SequenceFlow\u003e(); // éå†æ¯ä¸ªæµç¨‹ for (Process process : bpmnModel.getProce","date":"2023-10-11","objectID":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"04 è§£ææµç¨‹","uri":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior ","date":"2023-10-11","objectID":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"04 è§£ææµç¨‹","uri":"/ooooo-notes/04-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ ","date":"2023-10-10","objectID":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"03 éƒ¨ç½²æµç¨‹","uri":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" éƒ¨ç½²æµç¨‹æºç ä½ç½®: org.activiti.engine.impl.repository.DeploymentBuilderImpl#deploy // éƒ¨ç½²æµç¨‹ public Deployment deploy() { return repositoryService.deploy(this); } // org.activiti.engine.impl.RepositoryServiceImpl#deploy public Deployment deploy(DeploymentBuilderImpl deploymentBuilder) { // æ‰§è¡Œ DeployCmd, æœ€ç»ˆä¼šæ‰§è¡Œ DeployCmd#execute æ–¹æ³• return commandExecutor.execute(new DeployCmd\u003cDeployment\u003e(deploymentBuilder)); } æºç ä½ç½®: org.activiti.engine.impl.cmd.DeployCmd#execute // æ‰§è¡Œ DeployCmd#execute æ–¹æ³• public Deployment execute(CommandContext commandContext) { // æ‰§è¡Œéƒ¨ç½² return executeDeploy(commandContext); } protected Deployment executeDeploy(CommandContext commandContext) { // DeploymentEntity è¡¨ç¤ºéƒ¨ç½², é‡Œé¢åŒ…å«äº†æµç¨‹æ–‡ä»¶ DeploymentEntity newDeployment = setUpNewDeploymentFromContext(commandContext); // åˆ¤æ–­æ˜¯å¦è¿‡æ»¤é‡å¤çš„ // æ¯æ¬¡éƒ¨ç½²æµç¨‹ï¼Œå¯èƒ½åªæœ‰ä¸€éƒ¨åˆ†çš„æµç¨‹å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥ä¸éœ€è¦éƒ¨ç½²æ‰€æœ‰çš„æµç¨‹ if (deploymentBuilder.isDuplicateFilterEnabled()) { ... if (!existingDeployments.isEmpty()) { DeploymentEntity existingDeployment = (DeploymentEntity) existingDeployments.get(0); // å¯¹æ¯”æµç¨‹æ–‡ä»¶æ˜¯å¦å‘ç”Ÿæ”¹åŠ¨ if (deploymentsDiffer(newDeployment, existingDeployment)) { applyUpgradeLogic(newDeployment, existingDeployment); } else { LOGGER.info(\"An existing deployment of version {} matching the current one was found, no need to deploy again.\", existingDeployment.getVersion()); return existingDeployment; } } } // æŒä¹…åŒ–éƒ¨ç½²ï¼Œä¼šæŠŠæµç¨‹æ–‡ä»¶æ’å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œä¹Ÿä¼šè¿”å› deploymentId å’Œ version persistDeploymentInDatabase(commandContext, newDeployment); ... LOGGER.info(\"Launching new deployment with version: \" + newDeployment.getVersion()); // éƒ¨ç½²æµç¨‹ commandContext.getProcessEngineConfiguration().getDeploymentManager().deploy(newDeployment, deploymentSettings); ... return newDeployment; } æºç ä½ç½®: org.activiti.engine.impl.persistence.deploy.DeploymentManager#deploy // éƒ¨ç½²æµç¨‹ public void deploy(DeploymentEntity deployment, Map\u003cString, Object\u003e deploymentSettings) { // deployers é»˜è®¤åªæœ‰ä¸€ä¸ªå®ç° BpmnDeployer for (Deployer deployer : deployers) { deployer.deploy(deployment, deploymentSettings); } } æºç ä½ç½®: org.activiti.engine.impl.bpmn.deployer.BpmnDeployer#deploy // éƒ¨ç½²æµç¨‹ @Override public void deploy(DeploymentEntity deployment, Map\u003cString, Object\u003e deploymentSettings) { log.debug(\"Processing deployment {}\", deployment.getName()); // The ParsedDeployment represents the deployment, the process definitions, and the BPMN // resource, parse, and model associated with each process definition. // è¿™é‡Œä¼šè§£ææµç¨‹æ–‡ä»¶ï¼Œå¾ˆé‡è¦, ä¼šåœ¨ä¸‹ä¸€èŠ‚ç»§ç»­è§£æ ParsedDeployment parsedDeployment = parsedDeploymentBuilderFactory .getBuilderForDeploymentAndSettings(deployment, deploymentSettings) .build(); // æ ¡éªŒ processDefinitionKey æ˜¯å¦é‡å¤ bpmnDeploymentHelper.verifyProcessDefinitionsDoNotShareKeys(parsedDeployment.getAllProcessDefinitions()); ... // è®¾ç½®ä¸€äº›å±æ€§ï¼Œç„¶åä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ if (deployment.isNew()) { Map\u003cProcessDefinitionEntity, ProcessDefinitionEntity\u003e mapOfNewProcessDefinitionToPreviousVersion = getPreviousVersionsOfProcessDefinitions(parsedDeployment); setProcessDefinitionVersionsAndIds(parsedDeployment, mapOfNewProcessDefinitionToPreviousVersion); setProcessDefinitionAppVersion(parsedDeployment); persistProcessDefinitionsAndAuthorizations(parsedDeployment); updateTimersAndEvents(parsedDeployment, mapOfNewProcessDefinitionToPreviousVersion); dispatchProcessDefinitionEntityInitializedEvent(parsedDeployment); } else { makeProcessDefinitionsConsistentWithPersistedVersions(parsedDeployment); } // æµç¨‹å®šä¹‰æ›´æ–°åˆ°ç¼“å­˜ä¸­ cachingAndArtifactsManager.updateCachingAndArtifacts(parsedDeployment); // è¿™é‡Œä¸æ˜¯ä¸»è¦é€»è¾‘ï¼Œå¯ä»¥ä¸ç”¨å…³å¿ƒ for (ProcessDefinitionEntity processDefinition : parsedDeployment.getAllProcessDefinitions()) { BpmnModel bpmnModel = parsedDeployment.getBpmnModelForProcessDefinition(processDefinition); createLocalizationValues(processDefinition.getId(), bpmnModel.getProcessById(processDefinition.getKey())); } } ","date":"2023-10-10","objectID":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"03 éƒ¨ç½²æµç¨‹","uri":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»org.activiti.examples.processdefinitions.ProcessDefinitionsTest#testProcessDefinitionDescription ","date":"2023-10-10","objectID":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"03 éƒ¨ç½²æµç¨‹","uri":"/ooooo-notes/03-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œactiviti éƒ½ä¼šä¸ spring boot æ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™ä¸€èŠ‚å°±æ¥ä»‹ç» activiti æ˜¯å¦‚ä½•é›†æˆ spring çš„ã€‚ ","date":"2023-10-09","objectID":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"02 é›†æˆ spring","uri":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" activitiProperties é…ç½®é…ç½®ç±»: org.activiti.spring.boot.ActivitiProperties java @ConfigurationProperties(\"spring.activiti\") public class ActivitiProperties { private boolean checkProcessDefinitions = true; // å¼€å¯å®šæ—¶å™¨ private boolean asyncExecutorActivate = true; private String deploymentName = \"SpringAutoDeployment\"; // é‚®ä»¶ç›¸å…³çš„é…ç½® private String mailServerHost = \"localhost\"; private int mailServerPort = 1025; private String mailServerUserName; private String mailServerPassword; private String mailServerDefaultFrom; private boolean mailServerUseSsl; private boolean mailServerUseTls; // æ•°æ®åº“ç›¸å…³é…ç½® private String databaseSchemaUpdate = \"true\"; private String databaseSchema; private boolean dbHistoryUsed = false; // æœ¬åœ°æµ‹è¯•ï¼Œå»ºè®®è®¾ç½®ä¸º full private HistoryLevel historyLevel = HistoryLevel.NONE; // æµç¨‹å®šä¹‰çš„è·¯å¾„ private String processDefinitionLocationPrefix = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + \"**/processes/\"; private List\u003cString\u003e processDefinitionLocationSuffixes = asList(\"**.bpmn20.xml\", \"**.bpmn\"); // è‡ªå®šä¹‰çš„ mapper æ–‡ä»¶ private List\u003cString\u003e customMybatisMappers; private List\u003cString\u003e customMybatisXMLMappers; private boolean useStrongUuids = true; private boolean copyVariablesToLocalForTasks = true; // æœ‰ä¸åŒçš„éƒ¨ç½²ç­–ç•¥ private String deploymentMode = \"default\"; private boolean serializePOJOsInVariablesToJson = true; private String javaClassFieldForJackson = JsonTypeInfo.Id.CLASS.getDefaultPropertyName() } ","date":"2023-10-09","objectID":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"02 é›†æˆ spring","uri":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" springBoot è‡ªåŠ¨é…ç½®æºç ä½ç½®: org.activiti.spring.boot.ProcessEngineAutoConfiguration // ä¸»è¦æ„å»ºäº† SpringProcessEngineConfiguration, ProcessEngineConfigurationConfigurer, è¿˜æœ‰ä¸€äº›äº‹ä»¶ç›‘å¬å™¨ // SpringProcessEngineConfiguration: æµç¨‹å¼•æ“çš„é…ç½®ç±»ï¼Œè´¯å½»å…¨å±€ï¼Œéå¸¸é‡è¦ // ProcessEngineConfigurationConfigurer: é…ç½®æµç¨‹å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°è¿™ä¸ªæ¥å£æ¥è‡ªå®šä¹‰é…ç½® // å®ƒçš„çˆ¶ç±» AbstractProcessEngineAutoConfigurationï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›å¸¸ç”¨çš„ service ç±»ï¼Œæ¯”å¦‚ RuntimeService @AutoConfiguration @AutoConfigureAfter(name = {\"org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration\", \"org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration\"}) @EnableConfigurationProperties({ActivitiProperties.class, AsyncExecutorProperties.class}) public class ProcessEngineAutoConfiguration extends AbstractProcessEngineAutoConfiguration { ... @Bean @ConditionalOnMissingBean @DependsOnDatabaseInitialization public SpringProcessEngineConfiguration springProcessEngineConfiguration( DataSource dataSource, PlatformTransactionManager transactionManager, SpringAsyncExecutor springAsyncExecutor, ActivitiProperties activitiProperties, ResourceFinder resourceFinder, List\u003cResourceFinderDescriptor\u003e resourceFinderDescriptors, ApplicationUpgradeContextService applicationUpgradeContextService, @Autowired(required = false) List\u003cProcessEngineConfigurationConfigurer\u003e processEngineConfigurationConfigurers, @Autowired(required = false) List\u003cProcessEngineConfigurator\u003e processEngineConfigurators) throws IOException { SpringProcessEngineConfiguration conf = new SpringProcessEngineConfiguration(applicationUpgradeContextService); conf.setConfigurators(processEngineConfigurators); ... if (processEngineConfigurationConfigurers != null) { for (ProcessEngineConfigurationConfigurer processEngineConfigurationConfigurer : processEngineConfigurationConfigurers) { processEngineConfigurationConfigurer.configure(conf); } } springAsyncExecutor.applyConfig(conf); return conf; } @Bean @Order(Ordered.HIGHEST_PRECEDENCE) public ProcessEngineConfigurationConfigurer asyncExecutorPropertiesConfigurer(AsyncExecutorProperties properties) { return (configuration) -\u003e { configuration.setAsyncExecutorMessageQueueMode(properties.isMessageQueueMode()); ... configuration.setAsyncFailedJobWaitTime(properties.getRetryWaitTimeInMillis()); }; } } æºç ä½ç½®: org.activiti.spring.boot.AbstractProcessEngineAutoConfiguration#processEngine // æ ¹æ®æµç¨‹å¼•æ“é…ç½®ç”Ÿæˆå¯¹åº”çš„ FactoryBean, åœ¨åˆå§‹åŒ–æ—¶ï¼Œå°±ä¼šè°ƒç”¨ FactoryBean#getObject æ–¹æ³•ã€‚ @Bean public ProcessEngineFactoryBean processEngine(SpringProcessEngineConfiguration configuration) { return super.springProcessEngineBean(configuration); } // FactoryBean#getObject public ProcessEngine getObject() throws Exception { // é…ç½®è¡¨è¾¾å¼ç®¡ç†å™¨, å¯ä»¥ä»è¡¨è¾¾å¼æ‰§è¡Œ spring bean çš„æ–¹æ³• configureExpressionManager(); // é…ç½®äº‹åŠ¡ç®¡ç†ï¼Œå°±æ˜¯ spring äº‹åŠ¡ configureExternallyManagedTransactions(); if (processEngineConfiguration.getBeans() == null) { processEngineConfiguration.setBeans(new SpringBeanFactoryProxyMap(applicationContext)); } // æ„å»ºæµç¨‹å¼•æ“, è¿™é‡Œçš„ processEngineConfiguration æ˜¯ SpringProcessEngineConfiguration ç±» this.processEngine = processEngineConfiguration.buildProcessEngine(); return this.processEngine; } æºç ä½ç½®: org.activiti.engine.impl.cfg.SpringProcessEngineConfiguration#buildProcessEngine // æ„å»ºæµç¨‹å¼•æ“ @Override public ProcessEngine buildProcessEngine() { // è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• super#buildProcessEngine ProcessEngine processEngine = super.buildProcessEngine(); ProcessEngines.setInitialized(true); // è‡ªåŠ¨éƒ¨ç½²æµç¨‹æ–‡ä»¶ autoDeployResources(processEngine); return processEngine; } // super#buildProcessEngine @Override public ProcessEngine buildProcessEngine() { // åˆå§‹åŒ–ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šç»„ä»¶éœ€è¦åˆå§‹åŒ– init(); // åˆ›å»ºæµç¨‹å¼•æ“ ProcessEngineImpl processEngine = new ProcessEngineImpl(this); postProcessEngineInitialisation(); return processEngine; } æºç ä½ç½®: org.activiti.spring.SpringProcessEngineConfiguration#autoDeployResources // è‡ªåŠ¨éƒ¨ç½²æµç¨‹æ–‡ä»¶ protected void autoDeployResources(ProcessEngine processEngine) { // è·å–è‡ªåŠ¨éƒ¨ç½²ç­–ç•¥, é»˜è®¤æ˜¯ DefaultAutoDeploymentStrategy final AutoDeploymentStrategy strategy = getAutoDeploymentStrategy(deploymentMode); // éƒ¨ç½²æµç¨‹ strategy.deployResources(depl","date":"2023-10-09","objectID":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"02 é›†æˆ spring","uri":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" æµ‹è¯•ç±»å¯åŠ¨ç¤ºä¾‹ç¨‹åº activiti-examples/activiti-api-basic-full-example-bean ","date":"2023-10-09","objectID":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/:3:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"02 é›†æˆ spring","uri":"/ooooo-notes/02-%E9%9B%86%E6%88%90-spring/"},{"categories":null,"content":" activiti åŸºäº 8.0.0 ç‰ˆæœ¬ ","date":"2023-10-08","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:0:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"01 æ­å»º activiti æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" ä¸‹è½½æºç å’Œç¼–è¯‘ git clone git@github.com:Activiti/Activiti.git mvn clean package -DskipTests ","date":"2023-10-08","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"01 æ­å»º activiti æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" è¿è¡Œç¤ºä¾‹ç¨‹åºåœ¨æºç ä¸­æœ‰æ¨¡å— activiti-examples/activiti-api-basic-full-example-beanï¼Œè¿™æ˜¯ä¸€ä¸ª spring boot åº”ç”¨ï¼Œæ˜¯å¯ä»¥ç›´æ¥å¯åŠ¨çš„ï¼Œé»˜è®¤æ˜¯ä»¥h2å†…å­˜æ•°æ®åº“æ¥è¿è¡Œçš„ï¼Œå»ºè®®ä½¿ç”¨MySQLæ•°æ®åº“ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥æ›´æ–¹ä¾¿æ¥è§‚å¯Ÿæ•°æ®åº“ä¸­çš„æ•°æ®ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ¨èä½ ä½¿ç”¨æµ‹è¯•ç±»æ¥è°ƒè¯•ä»£ç ã€‚ åœ¨æ¨¡å— activiti-core/activiti-engine ä¸‹ï¼Œsrc/test/resources/activiti.cfg.xml ä¸­å¯ä»¥é…ç½®æ•°æ®åº“ï¼Œä¹Ÿå»ºè®®ä½¿ç”¨MySQLæ•°æ®åº“ã€‚ å¦‚æœä½ èƒ½æˆåŠŸè¿è¡Œ org.activiti.examples.bpmn.receivetask.ReceiveTaskTest#testWaitStateBehavior, è¯´æ˜ä½ çš„ç¯å¢ƒæ²¡æœ‰é—®é¢˜äº†ã€‚ ","date":"2023-10-08","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["activiti","source code","æºç åˆ†æ activiti ç³»åˆ—"],"title":"01 æ­å»º activiti æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-activiti-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" ä¸ºä»€ä¹ˆå­¦å¦‚æœä½ è¦äº†è§£å­˜å‚¨æ–¹é¢çš„çŸ¥è¯†ï¼Œleveldb ä½ å¿…é¡»è¦æ‡‚ã€‚è¿™æ˜¯å› ä¸ºå­˜å‚¨ä¼šæ¶‰åŠåˆ°LSM æ ‘å’ŒB+ æ ‘ï¼Œè€Œ leveldb æ˜¯LSM æ ‘çš„å®ç°ã€‚ç°åœ¨çš„å•æœºå­˜å‚¨å¼•æ“ä¼šç”¨åˆ° leveldb æˆ–è€… rocksdbã€‚ ","date":"2023-10-08","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-leveldb/:1:0","tags":["leveldb","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ leveldb","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-leveldb/"},{"categories":null,"content":" æ€ä¹ˆå­¦ leveldb çš„æºç æ¯”è¾ƒå°‘ï¼Œåªæœ‰1wè¡Œï¼Œæ‰€ä»¥å»ºè®®ä½ çœ‹æºç  å‚è€ƒèµ„æ–™ ç®€ä¹¦-leveldbä»å…¥é—¨åˆ°åŸç†è¯¦è§£ çŸ¥ä¹-æ·±å…¥åˆ†æleveldbå­˜å‚¨å¼•æ“ æºç -github ","date":"2023-10-08","objectID":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-leveldb/:2:0","tags":["leveldb","ä»é›¶å­¦æŠ€æœ¯ç³»åˆ—"],"title":"ä»é›¶å­¦ leveldb","uri":"/ooooo-notes/%E4%BB%8E%E9%9B%B6%E5%AD%A6-leveldb/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo ä¸­æ”¯æŒé…ç½®ä¸­å¿ƒï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ™ä¼šæ£€æŸ¥æ³¨å†Œä¸­å¿ƒèƒ½å¦å½“ä½œé…ç½®ä¸­å¿ƒã€‚ ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" å¯åŠ¨é…ç½®ä¸­å¿ƒæºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#startConfigCenter // å¯åŠ¨é…ç½®ä¸­å¿ƒ private void startConfigCenter() { // load application config // åŠ è½½é…ç½® configManager.loadConfigsOfTypeFromProps(ApplicationConfig.class); // try set model name if (StringUtils.isBlank(applicationModel.getModelName())) { applicationModel.setModelName(applicationModel.tryGetApplicationName()); } // load config centers // åŠ è½½é…ç½® configManager.loadConfigsOfTypeFromProps(ConfigCenterConfig.class); // ä½¿ç”¨æ³¨å†Œä¸­å¿ƒæ¥ä½œä¸ºé…ç½®ä¸­å¿ƒ, é»˜è®¤æƒ…å†µä¸‹ zk å’Œ nacos éƒ½æ˜¯æ”¯æŒçš„ // å¯ä»¥é€šè¿‡å±æ€§ RegistryConfig#useAsConfigCenter æ¥é…ç½® useRegistryAsConfigCenterIfNecessary(); // check Config Center Collection\u003cConfigCenterConfig\u003e configCenters = configManager.getConfigCenters(); if (CollectionUtils.isEmpty(configCenters)) { // æ²¡æœ‰é…ç½®ä¸­å¿ƒï¼Œnew ä¸€ä¸ªç©ºçš„ ConfigCenterConfig configCenterConfig = new ConfigCenterConfig(); configCenterConfig.setScopeModel(applicationModel); configCenterConfig.refresh(); ConfigValidationUtils.validateConfigCenterConfig(configCenterConfig); if (configCenterConfig.isValid()) { configManager.addConfigCenter(configCenterConfig); configCenters = configManager.getConfigCenters(); } } else { // éå†é…ç½®ä¸­å¿ƒ for (ConfigCenterConfig configCenterConfig : configCenters) { // é…ç½®ä¸­å¿ƒæ‰§è¡Œ refresh configCenterConfig.refresh(); // æ ¡éªŒ ConfigValidationUtils.validateConfigCenterConfig(configCenterConfig); } } if (CollectionUtils.isNotEmpty(configCenters)) { CompositeDynamicConfiguration compositeDynamicConfiguration = new CompositeDynamicConfiguration(); // éå†é…ç½®ä¸­å¿ƒ for (ConfigCenterConfig configCenter : configCenters) { // Pass config from ConfigCenterBean to environment // æ›´æ–°é…ç½®åˆ° externalConfigï¼Œå…¨å±€é…ç½® environment.updateExternalConfigMap(configCenter.getExternalConfiguration()); // æ›´æ–°é…ç½®åˆ° appExternalConfig, åº”ç”¨çº§åˆ«é…ç½® environment.updateAppExternalConfigMap(configCenter.getAppExternalConfiguration()); // Fetch config from remote config center // ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½® compositeDynamicConfiguration.addConfiguration(prepareEnvironment(configCenter)); } // è®¾ç½®åŠ¨æ€é…ç½® environment.setDynamicConfiguration(compositeDynamicConfiguration); } } ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" åŠ è½½é…ç½®æºç ä½ç½®: org.apache.dubbo.config.context.AbstractConfigManager#loadConfigsOfTypeFromProps public \u003cT extends AbstractConfig\u003e List\u003cT\u003e loadConfigsOfTypeFromProps(Class\u003cT\u003e cls) { List\u003cT\u003e tmpConfigs = new ArrayList\u003c\u003e(); // dubbo.properties æ–‡ä»¶é…ç½® PropertiesConfiguration properties = environment.getPropertiesConfiguration(); // load multiple configs with id Set\u003cString\u003e configIds = this.getConfigIdsFromProps(cls); // åŠ è½½å¤šé…ç½®ï¼Œæ¯”å¦‚ key: dubbo.protocols.id-xxx.name configIds.forEach(id -\u003e { if (!this.getConfig(cls, id).isPresent()) { T config; try { config = createConfig(cls, scopeModel); config.setId(id); } catch (Exception e) { throw new IllegalStateException(\"create config instance failed, id: \" + id + \", type:\" + cls.getSimpleName()); } String key = null; boolean addDefaultNameConfig = false; try { // add default name config (same as id), e.g. dubbo.protocols.rest.port=1234 key = DUBBO + \".\" + AbstractConfig.getPluralTagName(cls) + \".\" + id + \".name\"; if (properties.getProperty(key) == null) { properties.setProperty(key, id); addDefaultNameConfig = true; } config.refresh(); this.addConfig(config); tmpConfigs.add(config); } catch (Exception e) { logger.error(COMMON_PROPERTY_TYPE_MISMATCH, \"\", \"\", \"load config failed, id: \" + id + \", type:\" + cls.getSimpleName(), e); throw new IllegalStateException(\"load config failed, id: \" + id + \", type:\" + cls.getSimpleName()); } finally { if (addDefaultNameConfig \u0026\u0026 key != null) { properties.remove(key); } } } }); // If none config of the type, try load single config // åŠ è½½å•é…ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´å•é…ç½®å’Œå¤šé…ç½®åŒæ—¶å­˜åœ¨ï¼Œå¤šé…ç½®ä¼˜å…ˆ if (this.getConfigs(cls).isEmpty()) { // load single config // configurationMaps ä¸­åŒ…å«å¤šä¸ªé…ç½®ï¼Œæ¯”å¦‚ç¯å¢ƒå˜é‡ï¼Œdubbo.properies æ–‡ä»¶é…ç½®ï¼Œç³»ç»Ÿå‚æ•°ç­‰ List\u003cMap\u003cString, String\u003e\u003e configurationMaps = environment.getConfigurationMaps(); if (ConfigurationUtils.hasSubProperties(configurationMaps, AbstractConfig.getTypePrefix(cls))) { T config; try { config = createConfig(cls, scopeModel); config.refresh(); } catch (Exception e) { throw new IllegalStateException(\"create default config instance failed, type:\" + cls.getSimpleName()); } this.addConfig(config); tmpConfigs.add(config); } } return tmpConfigs; } ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½®æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#prepareEnvironment // ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½® private DynamicConfiguration prepareEnvironment(ConfigCenterConfig configCenter) { if (configCenter.isValid()) { ... DynamicConfiguration dynamicConfiguration; try { // è·å–åŠ¨æ€é…ç½® dynamicConfiguration = getDynamicConfiguration(configCenter.toUrl()); } catch (Exception e) { ... } ApplicationModel applicationModel = getApplicationModel(); // é…ç½®æ–‡ä»¶å°±æ˜¯ key if (StringUtils.isNotEmpty(configCenter.getConfigFile())) { // è·å–é…ç½®å†…å®¹, å…¨å±€çº§åˆ«çš„ String configContent = dynamicConfiguration.getProperties(configCenter.getConfigFile(), configCenter.getGroup()); if (StringUtils.isNotEmpty(configContent)) { logger.info(String.format(\"Got global remote configuration from config center with key-%s and group-%s: \\n %s\", configCenter.getConfigFile(), configCenter.getGroup(), configContent)); } String appGroup = getApplication().getName(); String appConfigContent = null; String appConfigFile = null; if (isNotEmpty(appGroup)) { appConfigFile = isNotEmpty(configCenter.getAppConfigFile()) ? configCenter.getAppConfigFile() : configCenter.getConfigFile(); // è·å–é…ç½®å†…å®¹, åº”ç”¨çº§åˆ«çš„ appConfigContent = dynamicConfiguration.getProperties(appConfigFile, appGroup); if (StringUtils.isNotEmpty(appConfigContent)) { logger.info(String.format(\"Got application specific remote configuration from config center with key %s and group %s: \\n %s\", appConfigFile, appGroup, appConfigContent)); } } try { // è§£æé…ç½® Map\u003cString, String\u003e configMap = parseProperties(configContent); Map\u003cString, String\u003e appConfigMap = parseProperties(appConfigContent); // æ›´æ–°é…ç½® environment.updateExternalConfigMap(configMap); environment.updateAppExternalConfigMap(appConfigMap); ... } catch (IOException e) { throw new IllegalStateException(\"Failed to parse configurations from Config Center.\", e); } } return dynamicConfiguration; } return null; } ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" Environment åˆå§‹åŒ–æºç ä½ç½®: org.apache.dubbo.common.config.Environment#initialize @Override public void initialize() throws IllegalStateException { if (initialized.compareAndSet(false, true)) { // å±æ€§é…ç½®ï¼Œåé¢ä¼šè¯´ this.propertiesConfiguration = new PropertiesConfiguration(scopeModel); // ç³»ç»Ÿé…ç½® this.systemConfiguration = new SystemConfiguration(); // ç¯å¢ƒå˜é‡ this.environmentConfiguration = new EnvironmentConfiguration(); // é…ç½®ä¸­å¿ƒçš„å…¨å±€é…ç½® this.externalConfiguration = new InmemoryConfiguration(\"ExternalConfig\"); // é…ç½®ä¸­å¿ƒçš„åº”ç”¨é…ç½® this.appExternalConfiguration = new InmemoryConfiguration(\"AppExternalConfig\"); // æœ¬åœ°çš„åº”ç”¨é…ç½® this.appConfiguration = new InmemoryConfiguration(\"AppConfig\"); loadMigrationRule(); } } // external config, such as config-center global/default config private InmemoryConfiguration externalConfiguration; // external app config, such as config-center app config private InmemoryConfiguration appExternalConfiguration; // local app config , such as Spring Environment/PropertySources/application.properties private InmemoryConfiguration appConfiguration; ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:4:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" PropertiesConfiguration åˆå§‹åŒ–æºç ä½ç½®: org.apache.dubbo.common.config.PropertiesConfiguration#refresh // PropertiesConfiguration æ„é€ å‡½æ•° public PropertiesConfiguration(ScopeModel scopeModel) { this.scopeModel = scopeModel; // åˆ·æ–°é…ç½® refresh(); } // åˆ·æ–°é…ç½® public void refresh() { properties = ConfigUtils.getProperties(scopeModel.getClassLoaders()); } // ConfigUtils#getProperties public static Properties getProperties(Set\u003cClassLoader\u003e classLoaders) { String path = System.getProperty(CommonConstants.DUBBO_PROPERTIES_KEY); if (StringUtils.isEmpty(path)) { path = System.getenv(CommonConstants.DUBBO_PROPERTIES_KEY); if (StringUtils.isEmpty(path)) { // dubbo.properties æ–‡ä»¶ path = CommonConstants.DEFAULT_DUBBO_PROPERTIES; } } return ConfigUtils.loadProperties(classLoaders, path, false, true); } ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:5:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" æµ‹è¯•ç±»org.apache.dubbo.config.context.ConfigManagerTest#testLoadConfigsOfTypeFromProps org.apache.dubbo.configcenter.support.nacos.NacosDynamicConfigurationTest#testGetConfig: éœ€è¦å¯åŠ¨ä¸€ä¸ª nacos æœåŠ¡ org.apache.dubbo.configcenter.support.zookeeper.ZookeeperDynamicConfigurationTest#testGetConfig: éœ€è¦å¯åŠ¨ä¸€ä¸ª zk æœåŠ¡ ","date":"2023-09-28","objectID":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/:6:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"04 é…ç½®åŠ è½½","uri":"/ooooo-notes/04-%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ ","date":"2023-09-16","objectID":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"03 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" å…¥å£ç¨‹åº // registryã€protocolã€referenceã€service éƒ½ä¼šè°ƒç”¨ configManager#addConfigï¼Œå¾ˆé‡è¦ã€‚ DubboBootstrap bootstrap = DubboBootstrap.getInstance(); // è®¾ç½®åº”ç”¨é…ç½® bootstrap.application(new ApplicationConfig(\"dubbo-demo-api-consumer\")) // æ³¨å†Œä¸­å¿ƒ .registry(registryConfig) // åè®®é…ç½® .protocol(new ProtocolConfig(CommonConstants.DUBBO, -1)) // æœåŠ¡å¼•ç”¨ .reference(reference) // æœåŠ¡æš´éœ² .service(service) // å¯åŠ¨ dubbo .start(); æºç ä½ç½®: org.apache.dubbo.config.context.AbstractConfigManager#addConfig public final \u003cT extends AbstractConfig\u003e T addConfig(AbstractConfig config) { if (config == null) { return null; } // ignore MethodConfig // ä¸æ”¯æŒ if (!isSupportConfigType(config.getClass())) { throw new IllegalArgumentException(\"Unsupported config type: \" + config); } if (config.getScopeModel() != scopeModel) { config.setScopeModel(scopeModel); } // è·å– tagName, ç„¶åæ·»åŠ  Map\u003cString, AbstractConfig\u003e configsMap = configsCache.computeIfAbsent(getTagName(config.getClass()), type -\u003e new ConcurrentHashMap\u003c\u003e()); // fast check duplicated equivalent config before write lock if (!(config instanceof ReferenceConfigBase || config instanceof ServiceConfigBase)) { for (AbstractConfig value : configsMap.values()) { if (value.equals(config)) { return (T) value; } } } // lock by config type synchronized (configsMap) { return (T) addIfAbsent(config, configsMap); } } ","date":"2023-09-16","objectID":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"03 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" å¯åŠ¨ dubboæºç ä½ç½®: org.apache.dubbo.config.bootstrap.DubboBootstrap#start public DubboBootstrap start(boolean wait) { Future future = applicationDeployer.start(); if (wait) { try { future.get(); } catch (Exception e) { throw new IllegalStateException(\"await dubbo application start finish failure\", e); } } return this; } æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#start @Override public Future start() { synchronized (startLock) { // åˆ¤æ–­çŠ¶æ€ if (isStopping() || isStopped() || isFailed()) { throw new IllegalStateException(getIdentifier() + \" is stopping or stopped, can not start again\"); } try { // maybe call start again after add new module, check if any new module // æœ‰å¾…å¯åŠ¨çš„æ¨¡å— boolean hasPendingModule = hasPendingModule(); // æ­£åœ¨å¯åŠ¨ if (isStarting()) { // currently, is starting, maybe both start by module and application // if it has new modules, start them if (hasPendingModule) { // å¯åŠ¨æ¨¡å— startModules(); } // if it is starting, reuse previous startFuture return startFuture; } // if is started and no new module, just return if (isStarted() \u0026\u0026 !hasPendingModule) { return CompletableFuture.completedFuture(false); } // pending -\u003e starting : first start app // started -\u003e starting : re-start app // æ”¹å˜çŠ¶æ€ä¸ºæ­£åœ¨å¯åŠ¨, æ‰§è¡Œå›è°ƒå‡½æ•° DeployListener onStarting(); // åˆå§‹åŒ– initialize(); // å¯åŠ¨ doStart(); } catch (Throwable e) { onFailed(getIdentifier() + \" start failure\", e); throw e; } return startFuture; } } æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#initialize // åˆå§‹åŒ– @Override public void initialize() { if (initialized) { return; } // Ensure that the initialization is completed when concurrent calls synchronized (startLock) { if (initialized) { return; } // æ‰§è¡Œ DeployListener#onInitialize é’©å­å‡½æ•° onInitialize(); // register shutdown hook // æ³¨å†Œ shutdown é’©å­ registerShutdownHook(); // å¯åŠ¨é…ç½®ä¸­å¿ƒï¼Œä¹‹åä¼šç”¨ä¸€ç« æ¥è¯´ startConfigCenter(); // åŠ è½½åº”ç”¨é…ç½® loadApplicationConfigs(); // åˆå§‹åŒ– modoule deployer initModuleDeployers(); initMetricsReporter(); initMetricsService(); // @since 2.7.8 // å¯åŠ¨å…ƒæ•°æ®ä¸­å¿ƒ startMetadataCenter(); // å˜æ›´çŠ¶æ€ initialized = true; if (logger.isInfoEnabled()) { logger.info(getIdentifier() + \" has been initialized!\"); } } } æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultApplicationDeployer#doStart // å¯åŠ¨ private void doStart() { // å¯åŠ¨æ¨¡å— startModules(); } // å¯åŠ¨æ¨¡å— private void startModules() { // ensure init and start internal module first // å¯åŠ¨å†…éƒ¨æ¨¡å— prepareInternalModule(); // filter and start pending modules, ignore new module during starting, throw exception of module start // å¯åŠ¨å¤–éƒ¨æ¨¡å— for (ModuleModel moduleModel : applicationModel.getModuleModels()) { if (moduleModel.getDeployer().isPending()) { moduleModel.getDeployer().start(); } } } æºç ä½ç½®: org.apache.dubbo.config.deploy.DefaultModuleDeployer#start // å¯åŠ¨æ¨¡å— @Override public Future start() throws IllegalStateException { // initializeï¼Œmaybe deadlock applicationDeployer lock \u0026 moduleDeployer lock // åˆå§‹åŒ–, ä¸Šé¢å·²ç»è¯´è¿‡äº† applicationDeployer.initialize(); // å¯åŠ¨ï¼ŒåŠ é” return startSync(); } private synchronized Future startSync() throws IllegalStateException { // åˆ¤æ–­çŠ¶æ€ if (isStopping() || isStopped() || isFailed()) { throw new IllegalStateException(getIdentifier() + \" is stopping or stopped, can not start again\"); } try { if (isStarting() || isStarted()) { return startFuture; } // å˜æ›´çŠ¶æ€ï¼Œå¯åŠ¨ä¸­ onModuleStarting(); // åˆå§‹åŒ–ï¼ŒåŠ è½½é…ç½® initialize(); // export services // æš´éœ²æœåŠ¡ï¼Œå¾ˆé‡è¦ exportServices(); // prepare application instance // exclude internal module to avoid wait itself if (moduleModel != moduleModel.getApplicationModel().getInternalModule()) { applicationDeployer.prepareInternalModule(); } // refer services // å¼•ç”¨æœåŠ¡ï¼Œå¾ˆé‡è¦ referServices(); // if no async export/refer services, just set started // ä¸‹é¢çš„é€»è¾‘åˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥å¤„ç†, é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ if (asyncExportingFutures.isEmpty() \u0026\u0026 asyncReferringFutures.isEmpty()) { // publish module started event // å˜æ›´çŠ¶æ€ä¸ºå·²å¯åŠ¨ï¼Œæš´éœ² metadataService, è¿™ä¸ªå¾ˆé‡è¦ onModuleStarted(); // register services to registry // æ³¨å†ŒæœåŠ¡ï¼Œåˆ·æ–°å…ƒæ•°æ® registerServices(); // check reference config // æ£€æŸ¥ checkReferences(); // complete module start futu","date":"2023-09-16","objectID":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"03 å¯åŠ¨æµç¨‹","uri":"/ooooo-notes/03-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ è¿™é‡Œçš„ client æ˜¯æŒ‡ nacos SDKï¼Œä¹Ÿå°±æ˜¯æ¨¡å— nacos-client. ","date":"2023-09-16","objectID":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"21 client è®¢é˜…é…ç½®","uri":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" æ·»åŠ è®¢é˜…è€…æºç ä½ç½®: com.alibaba.nacos.client.config.NacosConfigService#addListener // æ·»åŠ ç›‘å¬å™¨ @Override public void addListener(String dataId, String group, Listener listener) throws NacosException { worker.addTenantListeners(dataId, group, Arrays.asList(listener)); } // æ·»åŠ ç›‘å¬å™¨ public void addTenantListeners(String dataId, String group, List\u003c? extends Listener\u003e listeners) throws NacosException { group = blank2defaultGroup(group); String tenant = agent.getTenant(); // æ·»åŠ åˆ° CacheData é‡Œé¢ï¼Œå¯¹åŒä¸€ä¸ª dataId, group, tenant å¯èƒ½æœ‰å¤šä¸ª listener CacheData cache = addCacheDataIfAbsent(dataId, group, tenant); synchronized (cache) { for (Listener listener : listeners) { cache.addListener(listener); } // ä¸åˆ é™¤ cache.setDiscard(false); // å’ŒæœåŠ¡å™¨ä¸ä¸€è‡´ cache.setConsistentWithServer(false); // é€šçŸ¥ç›‘å¬é…ç½® agent.notifyListenConfig(); } } ","date":"2023-09-16","objectID":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"21 client è®¢é˜…é…ç½®","uri":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" é€šçŸ¥ç›‘å¬é…ç½®æºç ä½ç½®: com.alibaba.nacos.client.config.impl.ClientWorker.ConfigRpcTransportClient#notifyListenConfig // é€šçŸ¥ç›‘å¬é…ç½® @Override public void notifyListenConfig() { // å‘é˜Ÿåˆ— listenExecutebell æ·»åŠ ä¸€ä¸ªé€šçŸ¥ listenExecutebell.offer(bellItem); } // å®¢æˆ·ç«¯å¯åŠ¨ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• @Override public void startInternal() { executor.schedule(() -\u003e { while (!executor.isShutdown() \u0026\u0026 !executor.isTerminated()) { try { // è·å–é€šçŸ¥, æœ€å¤§é—´éš”æ—¶é—´ä¸º 5 ç§’ listenExecutebell.poll(5L, TimeUnit.SECONDS); if (executor.isShutdown() || executor.isTerminated()) { continue; } // æ‰§è¡Œé…ç½®ç›‘å¬ executeConfigListen(); } catch (Throwable e) { LOGGER.error(\"[rpc listen execute] [rpc listen] exception\", e); try { Thread.sleep(50L); } catch (InterruptedException interruptedException) { //ignore } notifyListenConfig(); } } }, 0L, TimeUnit.MILLISECONDS); } æºç ä½ç½®: `` // æ‰§è¡Œé…ç½®ç›‘å¬ @Override public void executeConfigListen() { Map\u003cString, List\u003cCacheData\u003e\u003e listenCachesMap = new HashMap\u003c\u003e(16); Map\u003cString, List\u003cCacheData\u003e\u003e removeListenCachesMap = new HashMap\u003c\u003e(16); long now = System.currentTimeMillis(); // æ¯éš”ä¸€æ®µæ—¶é—´éƒ½éœ€è¦å…¨åŒæ­¥é…ç½® boolean needAllSync = now - lastAllSyncTime \u003e= ALL_SYNC_INTERNAL; // éå† cacheMap, è¿™ä¸ª map éƒ½æ˜¯è¦ç›‘å¬çš„é…ç½® for (CacheData cache : cacheMap.get().values()) { synchronized (cache) { //check local listeners consistent. // åˆ¤æ–­æ˜¯å¦å’ŒæœåŠ¡ç«¯ä¸€è‡´ï¼Œä¸ä¸€è‡´ï¼Œéœ€è¦åˆ·æ–°é…ç½® if (cache.isConsistentWithServer()) { // æ£€æŸ¥é…ç½® md5 å€¼, ä¸ä¸€è‡´å°±æ¨é€ç»™è®¢é˜…è€… cache.checkListenerMd5(); if (!needAllSync) { continue; } } // ä¸æ˜¯åˆ é™¤çš„é…ç½®ï¼Œ if (!cache.isDiscard()) { //get listen config if (!cache.isUseLocalConfigInfo()) { List\u003cCacheData\u003e cacheDatas = listenCachesMap.get(String.valueOf(cache.getTaskId())); if (cacheDatas == null) { cacheDatas = new LinkedList\u003c\u003e(); listenCachesMap.put(String.valueOf(cache.getTaskId()), cacheDatas); } // æ·»åŠ è¦ç›‘å¬çš„é…ç½® cacheDatas.add(cache); } } else if (cache.isDiscard() \u0026\u0026 CollectionUtils.isEmpty(cache.getListeners())) { // æ˜¯åˆ é™¤çš„é…ç½®ï¼Œå¹¶ä¸”è®¢é˜…è€…æ˜¯ç©º if (!cache.isUseLocalConfigInfo()) { List\u003cCacheData\u003e cacheDatas = removeListenCachesMap.get(String.valueOf(cache.getTaskId())); if (cacheDatas == null) { cacheDatas = new LinkedList\u003c\u003e(); removeListenCachesMap.put(String.valueOf(cache.getTaskId()), cacheDatas); } // æ·»åŠ è¦åˆ é™¤çš„è®¢é˜…è€… cacheDatas.add(cache); } } } } //execute check listen ,return true if has change keys. // æ‹‰å–é…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦æ”¹å˜ boolean hasChangedKeys = checkListenCache(listenCachesMap); //execute check remove listen. // åˆ é™¤ç›‘å¬ checkRemoveListenCache(removeListenCachesMap); // è®°å½•å…¨åŒæ­¥çš„æ—¶é—´ if (needAllSync) { lastAllSyncTime = now; } //If has changed keys,notify re sync md5. // æœ‰é…ç½®æ”¹å˜ï¼Œé‡æ–°å†è¿è¡Œä¸€æ¬¡, æ¨é€é…ç½®ç»™è®¢é˜…è€… if (hasChangedKeys) { notifyListenConfig(); } } æºç ä½ç½®: com.alibaba.nacos.client.config.impl.ClientWorker.ConfigRpcTransportClient#checkListenCache // æ‹‰å–é…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦æ”¹å˜ private boolean checkListenCache(Map\u003cString, List\u003cCacheData\u003e\u003e listenCachesMap) { final AtomicBoolean hasChangedKeys = new AtomicBoolean(false); if (!listenCachesMap.isEmpty()) { List\u003cFuture\u003e listenFutures = new ArrayList\u003c\u003e(); // éå† listenCachesMap, æ¯ä¸€ä¸ª taskId, æœ‰ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ‹‰å–é…ç½® for (Map.Entry\u003cString, List\u003cCacheData\u003e\u003e entry : listenCachesMap.entrySet()) { String taskId = entry.getKey(); ExecutorService executorService = ensureSyncExecutor(taskId); Future future = executorService.submit(() -\u003e { List\u003cCacheData\u003e listenCaches = entry.getValue(); //reset notify change flag. // é‡ç½® for (CacheData cacheData : listenCaches) { cacheData.getReceiveNotifyChanged().set(false); } // æ„å»º ConfigBatchListenRequest è¯·æ±‚ï¼Œé‡Œé¢æœ‰ md5 å€¼ ConfigBatchListenRequest configChangeListenRequest = buildConfigRequest(listenCaches); configChangeListenRequest.setListen(true); try { RpcClient rpcClient = ensureRpcClient(taskId); // è¯·æ±‚æœåŠ¡ç«¯ï¼Œå¦‚æœ md5 å€¼ä¸ä¸€æ ·ï¼Œå°±ä¼šè¿”å› ConfigChangeBatchListenResponse listenResponse = (ConfigChangeBatchListenResponse) requestProxy( rpcClient, configChangeListenRequest); if (listenResponse != null \u0026\u0026 listenResponse.isSuccess()) { // è¡¨ç¤ºæ˜¯å¦æ‹‰å–è¿‡é…ç½® Set\u003cString\u003e changeKeys = new HashSet\u003cString\u003e(); List\u003cConfigChangeBatchListenResponse.ConfigContext\u003e changedConfigs = listenResponse.getChangedConfigs(); //handle changed keys,notify listener if (!CollectionUtils.is","date":"2023-09-16","objectID":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"21 client è®¢é˜…é…ç½®","uri":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" åˆ·æ–°é…ç½®ï¼Œé€šçŸ¥è®¢é˜…è€…æºç ä½ç½®: com.alibaba.nacos.client.config.impl.ClientWorker#refreshContentAndCheck // åˆ·æ–°é…ç½®ï¼Œé€šçŸ¥è®¢é˜…è€… private void refreshContentAndCheck(CacheData cacheData, boolean notify) { try { // è·å–é…ç½® ConfigResponse response = getServerConfig(cacheData.dataId, cacheData.group, cacheData.tenant, 3000L, notify); cacheData.setEncryptedDataKey(response.getEncryptedDataKey()); cacheData.setContent(response.getContent()); if (null != response.getConfigType()) { cacheData.setType(response.getConfigType()); } if (notify) { LOGGER.info(\"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}\", agent.getName(), cacheData.dataId, cacheData.group, cacheData.tenant, cacheData.getMd5(), ContentUtils.truncateContent(response.getContent()), response.getConfigType()); } // æ£€æŸ¥ md5 å€¼ cacheData.checkListenerMd5(); } catch (Exception e) { LOGGER.error(\"refresh content and check md5 fail ,dataId={},group={},tenant={} \", cacheData.dataId, cacheData.group, cacheData.tenant, e); } } // æ£€æŸ¥ md5 å€¼ void checkListenerMd5() { for (ManagerListenerWrap wrap : listeners) { // ä¸ä¸€è‡´ï¼Œé€šçŸ¥è®¢é˜…è€… if (!md5.equals(wrap.lastCallMd5)) { safeNotifyListener(dataId, group, content, type, md5, encryptedDataKey, wrap); } } } ","date":"2023-09-16","objectID":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"21 client è®¢é˜…é…ç½®","uri":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" rpcClient åˆå§‹åŒ–æºç ä½ç½®: com.alibaba.nacos.client.config.impl.ClientWorker.ConfigRpcTransportClient#ensureRpcClient private RpcClient ensureRpcClient(String taskId) throws NacosException { synchronized (ClientWorker.this) { Map\u003cString, String\u003e labels = getLabels(); Map\u003cString, String\u003e newLabels = new HashMap\u003c\u003e(labels); newLabels.put(\"taskId\", taskId); RpcClient rpcClient = RpcClientFactory.createClient(uuid + \"_config-\" + taskId, getConnectionType(), newLabels, RpcClientTlsConfig.properties(this.properties)); if (rpcClient.isWaitInitiated()) { // åˆå§‹åŒ– rpcClient initRpcClientHandler(rpcClient); rpcClient.setTenant(getTenant()); rpcClient.clientAbilities(initAbilities()); // å¯åŠ¨ rpcClient.start(); } return rpcClient; } } æºç ä½ç½®: com.alibaba.nacos.client.config.impl.ClientWorker.ConfigRpcTransportClient#initRpcClientHandler private void initRpcClientHandler(final RpcClient rpcClientInner) { /* * Register Config Change /Config ReSync Handler */ // æ³¨å†Œé…ç½®é€šçŸ¥çš„ requestHandler rpcClientInner.registerServerRequestHandler((request) -\u003e { if (request instanceof ConfigChangeNotifyRequest) { ConfigChangeNotifyRequest configChangeNotifyRequest = (ConfigChangeNotifyRequest) request; LOGGER.info(\"[{}] [server-push] config changed. dataId={}, group={},tenant={}\", rpcClientInner.getName(), configChangeNotifyRequest.getDataId(), configChangeNotifyRequest.getGroup(), configChangeNotifyRequest.getTenant()); String groupKey = GroupKey.getKeyTenant(configChangeNotifyRequest.getDataId(), configChangeNotifyRequest.getGroup(), configChangeNotifyRequest.getTenant()); CacheData cacheData = cacheMap.get().get(groupKey); if (cacheData != null) { synchronized (cacheData) { cacheData.getReceiveNotifyChanged().set(true); cacheData.setConsistentWithServer(false); notifyListenConfig(); } } return new ConfigChangeNotifyResponse(); } return null; }); // ClientConfigMetricRequest rpcClientInner.registerServerRequestHandler((request) -\u003e { if (request instanceof ClientConfigMetricRequest) { ClientConfigMetricResponse response = new ClientConfigMetricResponse(); response.setMetrics(getMetrics(((ClientConfigMetricRequest) request).getMetricsKeys())); return response; } return null; }); // è¿æ¥äº‹ä»¶ rpcClientInner.registerConnectionListener(new ConnectionEventListener() { @Override public void onConnected() { LOGGER.info(\"[{}] Connected,notify listen context...\", rpcClientInner.getName()); notifyListenConfig(); } @Override public void onDisConnect() { String taskId = rpcClientInner.getLabels().get(\"taskId\"); LOGGER.info(\"[{}] DisConnected,clear listen context...\", rpcClientInner.getName()); Collection\u003cCacheData\u003e values = cacheMap.get().values(); for (CacheData cacheData : values) { if (StringUtils.isNotBlank(taskId)) { if (Integer.valueOf(taskId).equals(cacheData.getTaskId())) { cacheData.setConsistentWithServer(false); } } else { cacheData.setConsistentWithServer(false); } } } }); // æŒ‘é€‰ä¸‹ä¸€ä¸ªåœ°å€ rpcClientInner.serverListFactory(new ServerListFactory() { @Override public String genNextServer() { return ConfigRpcTransportClient.super.serverListManager.getNextServerAddr(); } @Override public String getCurrentServer() { return ConfigRpcTransportClient.super.serverListManager.getCurrentServerAddr(); } @Override public List\u003cString\u003e getServerList() { return ConfigRpcTransportClient.super.serverListManager.getServerUrls(); } }); // åœ°å€å˜åŠ¨çš„ç›‘å¬å™¨ subscriber = new Subscriber() { @Override public void onEvent(Event event) { rpcClientInner.onServerListChange(); } @Override public Class\u003c? extends Event\u003e subscribeType() { return ServerlistChangeEvent.class; } }; NotifyCenter.registerSubscriber(subscriber); } ","date":"2023-09-16","objectID":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"21 client è®¢é˜…é…ç½®","uri":"/ooooo-notes/21-client-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ åœ¨ dubbo ä¸­ï¼ŒExtensionLoader æ˜¯å¾ˆé‡è¦çš„ç±»ï¼Œå®ç°äº† dubbo çš„æ‰©å±•æœºåˆ¶ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼ŒgetExtensionã€getActivateExtensionã€getAdaptiveExtensionã€‚ ","date":"2023-09-15","objectID":"/ooooo-notes/02-extensionloader/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"02 ExtensionLoader","uri":"/ooooo-notes/02-extensionloader/"},{"categories":null,"content":" getExtension æ–¹æ³•æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#getExtension // æ ¹æ® name æ¥è·å–æ‰©å±• public T getExtension(String name) { T extension = getExtension(name, true); if (extension == null) { throw new IllegalArgumentException(\"Not find extension: \" + name); } return extension; } // æ ¹æ® name æ¥è·å–æ‰©å±• public T getExtension(String name, boolean wrap) { checkDestroyed(); if (StringUtils.isEmpty(name)) { throw new IllegalArgumentException(\"Extension name == null\"); } // è·å–é»˜è®¤æ‰©å±• if (\"true\".equals(name)) { return getDefaultExtension(); } String cacheKey = name; if (!wrap) { cacheKey += \"_origin\"; } final Holder\u003cObject\u003e holder = getOrCreateHolder(cacheKey); Object instance = holder.get(); if (instance == null) { synchronized (holder) { instance = holder.get(); if (instance == null) { // åˆ›å»º extension instance = createExtension(name, wrap); holder.set(instance); } } } return (T) instance; } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#createExtension // åˆ›å»º extension private T createExtension(String name, boolean wrap) { // è·å–æ‰©å±•çš„ class, è¯»å– META-INF/dubbo/internal, META-INF/services, META-INF/dubbo ç›®å½•ä¸‹ Class\u003c?\u003e clazz = getExtensionClasses().get(name); if (clazz == null || unacceptableExceptions.contains(name)) { throw findException(name); } try { // ä»ç¼“å­˜ä¸­è·å–å¯¹è±¡ T instance = (T) extensionInstances.get(clazz); if (instance == null) { // åˆ›å»º extension å®ä¾‹ extensionInstances.putIfAbsent(clazz, createExtensionInstance(clazz)); instance = (T) extensionInstances.get(clazz); instance = postProcessBeforeInitialization(instance, name); // æ³¨å…¥å±æ€§ injectExtension(instance); instance = postProcessAfterInitialization(instance, name); } if (wrap) { List\u003cClass\u003c?\u003e\u003e wrapperClassesList = new ArrayList\u003c\u003e(); if (cachedWrapperClasses != null) { wrapperClassesList.addAll(cachedWrapperClasses); wrapperClassesList.sort(WrapperComparator.COMPARATOR); Collections.reverse(wrapperClassesList); } if (CollectionUtils.isNotEmpty(wrapperClassesList)) { // éå†åŒ…è£…ç±» for (Class\u003c?\u003e wrapperClass : wrapperClassesList) { Wrapper wrapper = wrapperClass.getAnnotation(Wrapper.class); boolean match = (wrapper == null) || ((ArrayUtils.isEmpty( wrapper.matches()) || ArrayUtils.contains(wrapper.matches(), name)) \u0026\u0026 !ArrayUtils.contains(wrapper.mismatches(), name)); if (match) { // æ³¨å…¥ç±» instance = injectExtension( (T) wrapperClass.getConstructor(type).newInstance(instance)); instance = postProcessAfterInitialization(instance, name); } } } } // Warning: After an instance of Lifecycle is wrapped by cachedWrapperClasses, it may not still be Lifecycle instance, this application may not invoke the lifecycle.initialize hook. // åˆå§‹åŒ– extension initExtension(instance); return instance; } catch (Throwable t) { throw new IllegalStateException( \"Extension instance (name: \" + name + \", class: \" + type + \") couldn't be instantiated: \" + t.getMessage(), t); } } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#getExtensionClasses // è·å–æ‰©å±•çš„ class, è¯»å– META-INF/dubbo/internal, META-INF/services, META-INF/dubbo ç›®å½•ä¸‹ private Map\u003cString, Class\u003c?\u003e\u003e getExtensionClasses() { // å•ä¾‹å»¶è¿ŸåŠ è½½ Map\u003cString, Class\u003c?\u003e\u003e classes = cachedClasses.get(); if (classes == null) { synchronized (cachedClasses) { classes = cachedClasses.get(); if (classes == null) { try { // åŠ è½½ extension class classes = loadExtensionClasses(); } catch (InterruptedException e) { logger.error(COMMON_ERROR_LOAD_EXTENSION, \"\", \"\", \"Exception occurred when loading extension class (interface: \" + type + \")\", e); throw new IllegalStateException( \"Exception occurred when loading extension class (interface: \" + type + \")\", e); } cachedClasses.set(classes); } } } return classes; } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#loadExtensionClasses // åŠ è½½ extension class private Map\u003cString, Class\u003c?\u003e\u003e loadExtensionClasses() throws InterruptedException { checkDestroyed(); cacheDefaultExtensionName(); Map\u003cString, Class\u003c?\u003e\u003e extensionClasses = new HashMap\u003c\u003e(); // éå† strategies for (LoadingStrategy strategy : strategies) { // åŠ è½½ç›®å½•ä¸­ç±», æœ€ç»ˆä¼šè°ƒç”¨ loadCla","date":"2023-09-15","objectID":"/ooooo-notes/02-extensionloader/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"02 ExtensionLoader","uri":"/ooooo-notes/02-extensionloader/"},{"categories":null,"content":" getActivateExtension æ–¹æ³•æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#getActivateExtension // è·å– Activate Extension public List\u003cT\u003e getActivateExtension(URL url, String key, String group) { String value = url.getParameter(key); // è·å– Activate return getActivateExtension(url, StringUtils.isEmpty(value) ? null : COMMA_SPLIT_PATTERN.split(value), group); } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#getActivateExtension // è·å– Activate public List\u003cT\u003e getActivateExtension(URL url, String[] values, String group) { checkDestroyed(); // solve the bug of using @SPI's wrapper method to report a null pointer exception. Map\u003cClass\u003c?\u003e, T\u003e activateExtensionsMap = new TreeMap\u003c\u003e(activateComparator); List\u003cString\u003e names = values == null ? new ArrayList\u003c\u003e(0) : Arrays.stream(values).map(StringUtils::trim).collect(Collectors.toList()); Set\u003cString\u003e namesSet = new HashSet\u003c\u003e(names); // åˆ¤æ–­æ˜¯å¦ç§»é™¤é»˜è®¤çš„ if (!namesSet.contains(REMOVE_VALUE_PREFIX + DEFAULT_KEY)) { if (cachedActivateGroups.size() == 0) { synchronized (cachedActivateGroups) { // cache all extensions if (cachedActivateGroups.size() == 0) { // ç¡®ä¿ extension å·²ç»åŠ è½½ï¼Œè¿™ä¸ªæ–¹æ³•ä¸Šé¢å·²ç»åˆ†æè¿‡äº† getExtensionClasses(); // éå†æ‰€æœ‰çš„ activate class for (Map.Entry\u003cString, Object\u003e entry : cachedActivates.entrySet()) { String name = entry.getKey(); Object activate = entry.getValue(); String[] activateGroup, activateValue; // è·å– @Activate çš„ group å’Œ value if (activate instanceof Activate) { activateGroup = ((Activate) activate).group(); activateValue = ((Activate) activate).value(); } else if (activate instanceof com.alibaba.dubbo.common.extension.Activate) { activateGroup = ((com.alibaba.dubbo.common.extension.Activate) activate).group(); activateValue = ((com.alibaba.dubbo.common.extension.Activate) activate).value(); } else { continue; } cachedActivateGroups.put(name, new HashSet\u003c\u003e(Arrays.asList(activateGroup))); String[][] keyPairs = new String[activateValue.length][]; for (int i = 0; i \u003c activateValue.length; i++) { if (activateValue[i].contains(\":\")) { keyPairs[i] = new String[2]; String[] arr = activateValue[i].split(\":\"); keyPairs[i][0] = arr[0]; keyPairs[i][1] = arr[1]; } else { keyPairs[i] = new String[1]; keyPairs[i][0] = activateValue[i]; } } // åŠ å…¥åˆ°ç¼“å­˜ä¸­ cachedActivateValues.put(name, keyPairs); } } } } // traverse all cached extensions cachedActivateGroups.forEach((name, activateGroup) -\u003e { // åˆ¤æ–­ group å’Œ name æ˜¯å¦åŒ¹é… if (isMatchGroup(group, activateGroup) \u0026\u0026 !namesSet.contains( name) \u0026\u0026 !namesSet.contains(REMOVE_VALUE_PREFIX + name) \u0026\u0026 isActive( cachedActivateValues.get(name), url)) { // ä¿å­˜é»˜è®¤çš„ activate activateExtensionsMap.put(getExtensionClass(name), getExtension(name)); } }); } // æœ‰é»˜è®¤çš„é…ç½®, ç»„åˆ activate if (namesSet.contains(DEFAULT_KEY)) { // will affect order // `ext1,default,ext2` means ext1 will happens before all of the default extensions while ext2 will after them ArrayList\u003cT\u003e extensionsResult = new ArrayList\u003c\u003e( activateExtensionsMap.size() + names.size()); for (String name : names) { if (name.startsWith(REMOVE_VALUE_PREFIX) || namesSet.contains( REMOVE_VALUE_PREFIX + name)) { continue; } if (DEFAULT_KEY.equals(name)) { extensionsResult.addAll(activateExtensionsMap.values()); continue; } if (containsExtension(name)) { extensionsResult.add(getExtension(name)); } } return extensionsResult; } else { // add extensions, will be sorted by its order for (String name : names) { if (name.startsWith(REMOVE_VALUE_PREFIX) || namesSet.contains( REMOVE_VALUE_PREFIX + name)) { continue; } if (DEFAULT_KEY.equals(name)) { continue; } if (containsExtension(name)) { activateExtensionsMap.put(getExtensionClass(name), getExtension(name)); } } return new ArrayList\u003c\u003e(activateExtensionsMap.values()); } } ","date":"2023-09-15","objectID":"/ooooo-notes/02-extensionloader/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"02 ExtensionLoader","uri":"/ooooo-notes/02-extensionloader/"},{"categories":null,"content":" getAdaptiveExtension æ–¹æ³•æºç ä½ç½®: `` public T getAdaptiveExtension() { checkDestroyed(); // å»¶è¿Ÿè·å– Object instance = cachedAdaptiveInstance.get(); if (instance == null) { if (createAdaptiveInstanceError != null) { throw new IllegalStateException( \"Failed to create adaptive instance: \" + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError); } synchronized (cachedAdaptiveInstance) { instance = cachedAdaptiveInstance.get(); if (instance == null) { try { // åˆ›å»º Adaptive instance = createAdaptiveExtension(); cachedAdaptiveInstance.set(instance); } catch (Throwable t) { createAdaptiveInstanceError = t; throw new IllegalStateException( \"Failed to create adaptive instance: \" + t.toString(), t); } } } } return (T) instance; } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#createAdaptiveExtension // åˆ›å»º Adaptive private T createAdaptiveExtension() { try { // è·å– AdaptiveExtensionClass, å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šåŠ¨æ€åˆ›å»º T instance = (T) getAdaptiveExtensionClass().newInstance(); instance = postProcessBeforeInitialization(instance, null); injectExtension(instance); instance = postProcessAfterInitialization(instance, null); initExtension(instance); return instance; } catch (Exception e) { throw new IllegalStateException( \"Can't create adaptive extension \" + type + \", cause: \" + e.getMessage(), e); } } æºç ä½ç½®: org.apache.dubbo.common.extension.ExtensionLoader#createAdaptiveExtensionClass // åŠ¨æ€åˆ›å»º private Class\u003c?\u003e createAdaptiveExtensionClass() { // Adaptive Classes' ClassLoader should be the same with Real SPI interface classes' ClassLoader ClassLoader classLoader = type.getClassLoader(); try { if (NativeUtils.isNative()) { return classLoader.loadClass(type.getName() + \"$Adaptive\"); } } catch (Throwable ignore) { } // ç”Ÿæˆä»£ç  String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate(); org.apache.dubbo.common.compiler.Compiler compiler = extensionDirector.getExtensionLoader( org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension(); // ç¼–è¯‘ä»£ç ï¼Œç„¶ååŠ è½½ return compiler.compile(type, code, classLoader); } ","date":"2023-09-15","objectID":"/ooooo-notes/02-extensionloader/:3:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"02 ExtensionLoader","uri":"/ooooo-notes/02-extensionloader/"},{"categories":null,"content":" æµ‹è¯•ç±»org.apache.dubbo.common.extension.ExtensionLoaderTest#test_getExtension org.apache.dubbo.common.extension.ExtensionLoaderTest#test_getExtension_WithWrapper org.apache.dubbo.common.extension.ExtensionLoaderTest#test_getActivateExtension_WithWrapper1 org.apache.dubbo.common.extension.ExtensionLoader_Adaptive_Test#test_getAdaptiveExtension_customizeAdaptiveKey org.apache.dubbo.common.extension.ExtensionLoader_Adaptive_Test#test_getAdaptiveExtension_protocolKey ","date":"2023-09-15","objectID":"/ooooo-notes/02-extensionloader/:4:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"02 ExtensionLoader","uri":"/ooooo-notes/02-extensionloader/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ è¿™é‡Œçš„ client æ˜¯æŒ‡ nacos SDKï¼Œä¹Ÿå°±æ˜¯æ¨¡å— nacos-client. ","date":"2023-09-15","objectID":"/ooooo-notes/20-client-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"20 client è·å–é…ç½®","uri":"/ooooo-notes/20-client-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" è·å–é…ç½®æºç ä½ç½®: com.alibaba.nacos.client.config.NacosConfigService#getConfig // è·å–é…ç½® @Override public String getConfig(String dataId, String group, long timeoutMs) throws NacosException { return getConfigInner(namespace, dataId, group, timeoutMs); } æºç ä½ç½®: com.alibaba.nacos.client.config.NacosConfigService#getConfigInner // è·å–é…ç½® private String getConfigInner(String tenant, String dataId, String group, long timeoutMs) throws NacosException { group = blank2defaultGroup(group); // æ£€æŸ¥å‚æ•° ParamUtils.checkKeyParam(dataId, group); ConfigResponse cr = new ConfigResponse(); cr.setDataId(dataId); cr.setTenant(tenant); cr.setGroup(group); // We first try to use local failover content if exists. // A config content for failover is not created by client program automatically, // but is maintained by user. // This is designed for certain scenario like client emergency reboot, // changing config needed in the same time, while nacos server is down. // æ˜¯å¦ä»æœ¬åœ°è·å–, é»˜è®¤ä¸æ˜¯ String content = LocalConfigInfoProcessor.getFailover(worker.getAgentName(), dataId, group, tenant); if (content != null) { LOGGER.warn(\"[{}] [get-config] get failover ok, dataId={}, group={}, tenant={}, config={}\", worker.getAgentName(), dataId, group, tenant, ContentUtils.truncateContent(content)); cr.setContent(content); String encryptedDataKey = LocalEncryptedDataKeyProcessor .getEncryptDataKeyFailover(agent.getName(), dataId, group, tenant); cr.setEncryptedDataKey(encryptedDataKey); configFilterChainManager.doFilter(null, cr); content = cr.getContent(); return content; } try { // è·å–é…ç½®ï¼Œå‘é€ ConfigQueryRequest è¯·æ±‚ï¼Œä¼šè¢« ConfigQueryRequestHandler å¤„ç† ConfigResponse response = worker.getServerConfig(dataId, group, tenant, timeoutMs, false); cr.setContent(response.getContent()); cr.setEncryptedDataKey(response.getEncryptedDataKey()); // åŠ è§£å¯† configFilterChainManager.doFilter(null, cr); content = cr.getContent(); return content; } catch (NacosException ioe) { if (NacosException.NO_RIGHT == ioe.getErrCode()) { throw ioe; } LOGGER.warn(\"[{}] [get-config] get from server error, dataId={}, group={}, tenant={}, msg={}\", worker.getAgentName(), dataId, group, tenant, ioe.toString()); } // è·å–æœ¬åœ°å¿«ç…§, è¿”å› content = LocalConfigInfoProcessor.getSnapshot(worker.getAgentName(), dataId, group, tenant); if (content != null) { LOGGER.warn(\"[{}] [get-config] get snapshot ok, dataId={}, group={}, tenant={}, config={}\", worker.getAgentName(), dataId, group, tenant, ContentUtils.truncateContent(content)); } cr.setContent(content); String encryptedDataKey = LocalEncryptedDataKeyProcessor .getEncryptDataKeySnapshot(agent.getName(), dataId, group, tenant); cr.setEncryptedDataKey(encryptedDataKey); configFilterChainManager.doFilter(null, cr); content = cr.getContent(); return content; } ","date":"2023-09-15","objectID":"/ooooo-notes/20-client-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"20 client è·å–é…ç½®","uri":"/ooooo-notes/20-client-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" dubbo åŸºäº 3.2.6 ç‰ˆæœ¬ æºç åˆ†æï¼Œä¸»è¦ä»‹ç»æœåŠ¡çº§åˆ«çš„æ³¨å†Œå’Œå‘ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸‹å‚æ•°æ¥å¯ç”¨ã€‚ é€‰å– dubbo-demo-api æ¨¡å—ä½œä¸ºç¤ºä¾‹ã€‚ ","date":"2023-09-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:0:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"01 æ­å»º dubbo æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" provider ç¤ºä¾‹ç¨‹åº public class Application { private static final String REGISTRY_URL = \"zookeeper://127.0.0.1:2181\"; public static void main(String[] args) { startWithBootstrap(); } private static void startWithBootstrap() { ServiceConfig\u003cDemoServiceImpl\u003e service = new ServiceConfig\u003c\u003e(); service.setInterface(DemoService.class); service.setRef(new DemoServiceImpl()); RegistryConfig registryConfig = new RegistryConfig(REGISTRY_URL); // æ³¨å†Œç±»å‹ä¸º service registryConfig.setParameters(Collections.singletonMap(RegistryConstants.REGISTRY_TYPE_KEY, RegistryConstants.SERVICE_REGISTRY_TYPE)); DubboBootstrap bootstrap = DubboBootstrap.getInstance(); bootstrap.application(new ApplicationConfig(\"dubbo-demo-api-provider\")) .registry(registryConfig) .protocol(new ProtocolConfig(CommonConstants.DUBBO, -1)) .service(service) .start() .await(); } } ","date":"2023-09-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"01 æ­å»º dubbo æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" consumer ç¤ºä¾‹ç¨‹åº public class Application { private static final String REGISTRY_URL = \"zookeeper://127.0.0.1:2181\"; public static void main(String[] args) { runWithBootstrap(); } private static void runWithBootstrap() { ReferenceConfig\u003cDemoService\u003e reference = new ReferenceConfig\u003c\u003e(); reference.setInterface(DemoService.class); reference.setGeneric(\"true\"); RegistryConfig registryConfig = new RegistryConfig(REGISTRY_URL); // æ³¨å†Œç±»å‹ä¸º service registryConfig.setParameters(Collections.singletonMap(RegistryConstants.REGISTRY_TYPE_KEY, RegistryConstants.SERVICE_REGISTRY_TYPE)); DubboBootstrap bootstrap = DubboBootstrap.getInstance(); bootstrap.application(new ApplicationConfig(\"dubbo-demo-api-consumer\")) .registry(registryConfig) .protocol(new ProtocolConfig(CommonConstants.DUBBO, -1)) .reference(reference) .start(); DemoService demoService = bootstrap.getCache().get(reference); String message = demoService.sayHello(\"dubbo\"); System.out.println(message); // generic invoke GenericService genericService = (GenericService) demoService; Object genericInvokeResult = genericService.$invoke(\"sayHello\", new String[]{String.class.getName()}, new Object[]{\"dubbo generic invoke\"}); System.out.println(genericInvokeResult.toString()); } } ","date":"2023-09-14","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["dubbo","source code","æºç åˆ†æ dubbo ç³»åˆ—"],"title":"01 æ­å»º dubbo æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-dubbo-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œè®¢é˜…é…ç½®åˆ†ä¸º httpé•¿è½®è¯¢ å’Œ grpc ä¸¤ç§æ–¹å¼ã€‚ ","date":"2023-09-14","objectID":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"19 è®¢é˜…é…ç½®","uri":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" http é•¿è½®è¯¢æºç ä½ç½®: com.alibaba.nacos.config.server.controller.ConfigController#listener // http é•¿è½®è¯¢ @PostMapping(\"/listener\") @Secured(action = ActionTypes.READ, signType = SignType.CONFIG) public void listener(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { // å¯ç”¨ servlet å¼‚æ­¥ request.setAttribute(\"org.apache.catalina.ASYNC_SUPPORTED\", true); // è·å–è¦ç›‘å¬çš„é…ç½® String probeModify = request.getParameter(\"Listening-Configs\"); if (StringUtils.isBlank(probeModify)) { LOGGER.warn(\"invalid probeModify is blank\"); throw new IllegalArgumentException(\"invalid probeModify\"); } probeModify = URLDecoder.decode(probeModify, Constants.ENCODE); Map\u003cString, String\u003e clientMd5Map; try { // è§£æå‡º md5 å€¼ï¼Œkey æ˜¯ groupKey, value æ˜¯ md5 å€¼ clientMd5Map = MD5Util.getClientMd5Map(probeModify); } catch (Throwable e) { throw new IllegalArgumentException(\"invalid probeModify\"); } // do long-polling // é•¿è½®è¯¢ inner.doPollingConfig(request, response, clientMd5Map, probeModify.length()); } æºç ä½ç½®: com.alibaba.nacos.config.server.controller.ConfigServletInner#doPollingConfig // é•¿è½®è¯¢ public String doPollingConfig(HttpServletRequest request, HttpServletResponse response, Map\u003cString, String\u003e clientMd5Map, int probeRequestSize) throws IOException { // Long polling. // æ˜¯å¦æ”¯æŒé•¿è½®è¯¢, åˆ¤æ–­è¯·æ±‚å¤´ Long-Pulling-Timeout æ˜¯å¦å­˜åœ¨ if (LongPollingService.isSupportLongPolling(request)) { // æ·»åŠ é•¿è½®è¯¢ longPollingService.addLongPollingClient(request, response, clientMd5Map, probeRequestSize); return HttpServletResponse.SC_OK + \"\"; } // Compatible with short polling logic. // ä¸‹é¢çš„é€»è¾‘éƒ½æ˜¯å…¼å®¹çŸ­è½®è¯¢çš„ï¼Œä¹Ÿå°±æ˜¯ç«‹é©¬å¯¹æ¯” md5 å€¼æ˜¯å¦å‘ç”Ÿæ”¹å˜ // å¦‚æœä¸ä¸€æ ·ï¼Œè¿”å›æ”¹å˜çš„ groupKeyï¼Œä¸‹é¢çš„é€»è¾‘å°±ä¸çœ‹äº† List\u003cString\u003e changedGroups = MD5Util.compareMd5(request, response, clientMd5Map); // Compatible with short polling result. String oldResult = MD5Util.compareMd5OldResult(changedGroups); String newResult = MD5Util.compareMd5ResultString(changedGroups); String version = request.getHeader(Constants.CLIENT_VERSION_HEADER); if (version == null) { version = \"2.0.0\"; } int versionNum = Protocol.getVersionNumber(version); // Before 2.0.4 version, return value is put into header. if (versionNum \u003c START_LONG_POLLING_VERSION_NUM) { response.addHeader(Constants.PROBE_MODIFY_RESPONSE, oldResult); response.addHeader(Constants.PROBE_MODIFY_RESPONSE_NEW, newResult); } else { request.setAttribute(\"content\", newResult); } // Disable cache. response.setHeader(\"Pragma\", \"no-cache\"); response.setDateHeader(\"Expires\", 0); response.setHeader(\"Cache-Control\", \"no-cache,no-store\"); response.setStatus(HttpServletResponse.SC_OK); return HttpServletResponse.SC_OK + \"\"; } æºç ä½ç½®: com.alibaba.nacos.config.server.service.LongPollingService#addLongPollingClient // æ·»åŠ é•¿è½®è¯¢ public void addLongPollingClient(HttpServletRequest req, HttpServletResponse rsp, Map\u003cString, String\u003e clientMd5Map, int probeRequestSize) { // str å°±æ˜¯é•¿è½®è¯¢çš„è¶…æ—¶æ—¶é—´ï¼Œç”±å®¢æˆ·ç«¯ä¼ å…¥ String str = req.getHeader(LongPollingService.LONG_POLLING_HEADER); String noHangUpFlag = req.getHeader(LongPollingService.LONG_POLLING_NO_HANG_UP_HEADER); int delayTime = SwitchService.getSwitchInteger(SwitchService.FIXED_DELAY_TIME, 500); // Add delay time for LoadBalance, and one response is returned 500 ms in advance to avoid client timeout. long timeout = -1L; // å›ºå®šé•¿è½®è¯¢çš„æ—¶é—´ if (isFixedPolling()) { timeout = Math.max(10000, getFixedPollingInterval()); // Do nothing but set fix polling timeout. } else { // è®¡ç®—é•¿è½®è¯¢æ—¶é—´ timeout = Math.max(10000, Long.parseLong(str) - delayTime); long start = System.currentTimeMillis(); List\u003cString\u003e changedGroups = MD5Util.compareMd5(req, rsp, clientMd5Map); // å¦‚æœ md5 å€¼æœ‰å˜åŒ–ï¼Œç«‹å³è¿”å›ç»“æœ if (changedGroups.size() \u003e 0) { generateResponse(req, rsp, changedGroups); LogUtil.CLIENT_LOG.info(\"{}|{}|{}|{}|{}|{}|{}\", System.currentTimeMillis() - start, \"instant\", RequestUtil.getRemoteIp(req), \"polling\", clientMd5Map.size(), probeRequestSize, changedGroups.size()); return; } else if (noHangUpFlag != null \u0026\u0026 noHangUpFlag.equalsIgnoreCase(TRUE_STR)) { // ä¸æŒ‚èµ·è¯·æ±‚ LogUtil.CLIENT_LOG.info(\"{}|{}|{}|{}|{}|{}|{}\", System.currentTimeMill","date":"2023-09-14","objectID":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"19 è®¢é˜…é…ç½®","uri":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" grpc è®¢é˜…æºç ä½ç½®: com.alibaba.nacos.config.server.remote.ConfigChangeBatchListenRequestHandler#handle // grpc ç›‘å¬é…ç½® public ConfigChangeBatchListenResponse handle(ConfigBatchListenRequest configChangeListenRequest, RequestMeta meta) throws NacosException { String connectionId = StringPool.get(meta.getConnectionId()); String tag = configChangeListenRequest.getHeader(Constants.VIPSERVER_TAG); ConfigChangeBatchListenResponse configChangeBatchListenResponse = new ConfigChangeBatchListenResponse(); for (ConfigBatchListenRequest.ConfigListenContext listenContext : configChangeListenRequest .getConfigListenContexts()) { String groupKey = GroupKey2 .getKey(listenContext.getDataId(), listenContext.getGroup(), listenContext.getTenant()); groupKey = StringPool.get(groupKey); String md5 = StringPool.get(listenContext.getMd5()); // ç›‘å¬é…ç½® if (configChangeListenRequest.isListen()) { // æ·»åŠ ç›‘å¬ configChangeListenContext.addListen(groupKey, md5, connectionId); boolean isUptoDate = ConfigCacheService.isUptodate(groupKey, md5, meta.getClientIp(), tag); // å¦‚æœæœ‰å˜åŠ¨ï¼Œç›´æ¥è¿”å›é…ç½® if (!isUptoDate) { configChangeBatchListenResponse.addChangeConfig(listenContext.getDataId(), listenContext.getGroup(), listenContext.getTenant()); } } else { // å–æ¶ˆç›‘å¬ configChangeListenContext.removeListen(groupKey, connectionId); } } return configChangeBatchListenResponse; } æºç ä½ç½®: com.alibaba.nacos.config.server.remote.ConfigChangeListenContext#addListen // æ·»åŠ ç›‘å¬ public synchronized void addListen(String groupKey, String md5, String connectionId) { // 1.add groupKeyContext Set\u003cString\u003e listenClients = groupKeyContext.get(groupKey); if (listenClients == null) { groupKeyContext.putIfAbsent(groupKey, new HashSet\u003c\u003e()); listenClients = groupKeyContext.get(groupKey); } listenClients.add(connectionId); // 2.add connectionIdContext HashMap\u003cString, String\u003e groupKeys = connectionIdContext.get(connectionId); if (groupKeys == null) { connectionIdContext.putIfAbsent(connectionId, new HashMap\u003c\u003e(16)); groupKeys = connectionIdContext.get(connectionId); } groupKeys.put(groupKey, md5); } æºç ä½ç½®: com.alibaba.nacos.config.server.remote.ConfigChangeListenContext#removeListen // å–æ¶ˆç›‘å¬ public synchronized void removeListen(String groupKey, String connectionId) { //1. remove groupKeyContext Set\u003cString\u003e connectionIds = groupKeyContext.get(groupKey); if (connectionIds != null) { connectionIds.remove(connectionId); if (connectionIds.isEmpty()) { groupKeyContext.remove(groupKey); } } //2.remove connectionIdContext HashMap\u003cString, String\u003e groupKeys = connectionIdContext.get(connectionId); if (groupKeys != null) { groupKeys.remove(groupKey); } } æºç ä½ç½®: com.alibaba.nacos.config.server.remote.RpcConfigChangeNotifier#configDataChanged // æ¥å— LocalDataChangeEvent äº‹ä»¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³• public void configDataChanged(String groupKey, String dataId, String group, String tenant, boolean isBeta, List\u003cString\u003e betaIps, String tag) { Set\u003cString\u003e listeners = configChangeListenContext.getListeners(groupKey); if (CollectionUtils.isEmpty(listeners)) { return; } int notifyClientCount = 0; for (final String client : listeners) { // è·å–è¿æ¥ Connection connection = connectionManager.getConnection(client); if (connection == null) { continue; } ConnectionMeta metaInfo = connection.getMetaInfo(); //beta ips check. String clientIp = metaInfo.getClientIp(); String clientTag = metaInfo.getTag(); // åˆ¤æ–­ beat é…ç½® if (isBeta \u0026\u0026 betaIps != null \u0026\u0026 !betaIps.contains(clientIp)) { continue; } //tag check // åˆ¤æ–­ tag é…ç½® if (StringUtils.isNotBlank(tag) \u0026\u0026 !tag.equals(clientTag)) { continue; } ConfigChangeNotifyRequest notifyRequest = ConfigChangeNotifyRequest.build(dataId, group, tenant); // æ¨é€é…ç½®çš„ groupKey RpcPushTask rpcPushRetryTask = new RpcPushTask(notifyRequest, 50, client, clientIp, metaInfo.getAppName()); push(rpcPushRetryTask); notifyClientCount++; } Loggers.REMOTE_PUSH.info(\"push [{}] clients ,groupKey=[{}]\", notifyClientCount, groupKey); } ","date":"2023-09-14","objectID":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"19 è®¢é˜…é…ç½®","uri":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.config.ConfigLongPollReturnChanges_CITCase#testAdd ","date":"2023-09-14","objectID":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"19 è®¢é˜…é…ç½®","uri":"/ooooo-notes/19-%E8%AE%A2%E9%98%85%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œåˆ é™¤é…ç½®åˆ†ä¸º http å’Œ grpc ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º ConfigControllerV2#deleteConfig å’Œ ConfigRemoveRequestHandlerã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘å°±é€‰æ‹© http çš„æ–¹å¼æ¥åˆ†æä»£ç ã€‚ ","date":"2023-09-13","objectID":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"18 åˆ é™¤é…ç½®","uri":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" åˆ é™¤é…ç½®æºç ä½ç½®: com.alibaba.nacos.config.server.controller.v2.ConfigControllerV2#deleteConfig // æ¥å— http è¯·æ±‚ public Result\u003cBoolean\u003e deleteConfig(HttpServletRequest request, @RequestParam(\"dataId\") String dataId, @RequestParam(\"group\") String group, @RequestParam(value = \"namespaceId\", required = false, defaultValue = StringUtils.EMPTY) String namespaceId, @RequestParam(value = \"tag\", required = false) String tag) throws NacosException { //fix issue #9783 namespaceId = NamespaceUtil.processNamespaceParameter(namespaceId); // check namespaceId // æ£€æŸ¥å‚æ•° ParamUtils.checkTenantV2(namespaceId); ParamUtils.checkParam(dataId, group, \"datumId\", \"rm\"); ParamUtils.checkParamV2(tag); String clientIp = RequestUtil.getRemoteIp(request); String srcUser = RequestUtil.getSrcUserName(request); // åˆ é™¤é…ç½® return Result.success(configOperationService.deleteConfig(dataId, group, namespaceId, tag, clientIp, srcUser)); } æºç ä½ç½®: com.alibaba.nacos.config.server.service.ConfigOperationService#deleteConfig // åˆ é™¤é…ç½® public Boolean deleteConfig(String dataId, String group, String namespaceId, String tag, String clientIp, String srcUser) { // è¿™ä¸ªæ–¹æ³•ä¸­æ²¡æœ‰åˆ é™¤ beta é…ç½®ï¼Œæ˜¯å› ä¸ºæœ‰å•ç‹¬çš„æ¥å£æ¥æ“ä½œï¼Œæ¥å£ä¸º ConfigController#stopBeta if (StringUtils.isBlank(tag)) { // åˆ é™¤ configInfo configInfoPersistService.removeConfigInfo(dataId, group, namespaceId, clientIp, srcUser); } else { // åˆ é™¤ configInfoTag configInfoTagPersistService.removeConfigInfoTag(dataId, group, namespaceId, tag, clientIp, srcUser); } final Timestamp time = TimeUtils.getCurrentTime(); // è®°å½•æ—¥å¿— ConfigTraceService.logPersistenceEvent(dataId, group, namespaceId, null, time.getTime(), clientIp, ConfigTraceService.PERSISTENCE_EVENT_REMOVE, null); // å‘å¸ƒ ConfigDataChangeEvent äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶åœ¨å‘å¸ƒé…ç½®ç« èŠ‚ä¸­åˆ†æè¿‡äº† ConfigChangePublisher .notifyConfigChange(new ConfigDataChangeEvent(false, dataId, group, namespaceId, tag, time.getTime())); return true; } ","date":"2023-09-13","objectID":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"18 åˆ é™¤é…ç½®","uri":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.config.ConfigAPI_V2_CITCase#test ","date":"2023-09-13","objectID":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"18 åˆ é™¤é…ç½®","uri":"/ooooo-notes/18-%E5%88%A0%E9%99%A4%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" build.gradle æ–‡ä»¶ plugins { id(\"com.linecorp.thrift-gradle-plugin\") version \"0.5.0\" } dependencies { api('org.apache.thrift:libthrift:0.19.0') api('org.springframework.boot:spring-boot-starter-logging') api('cn.hutool:hutool-all') testImplementation('org.springframework.boot:spring-boot-starter-test') } ","date":"2023-09-13","objectID":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/:1:0","tags":["thrift"],"title":"ç®€å•å°è£… thrift åè®®","uri":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" example.thrift æ–‡ä»¶æ–‡ä»¶æ”¾åœ¨è·¯å¾„: src/main/thrift, è¿è¡Œ gradle å‘½ä»¤ compileThrift /** * The first thing to know about are types. The available types in Thrift are: * * bool Boolean, one byte * i8 (byte) Signed 8-bit integer * i16 Signed 16-bit integer * i32 Signed 32-bit integer * i64 Signed 64-bit integer * double 64-bit floating point value * string String * binary Blob (byte array) * map\u003ct1,t2\u003e Map from one type to another * list\u003ct1\u003e Ordered list of one type * set\u003ct1\u003e Set of unique elements of one type * * Did you also notice that Thrift supports C style comments? */ /** * Thrift files can namespace, package, or prefix their output in various * target languages. */ namespace cl example namespace cpp example namespace d example namespace dart example namespace java example namespace php example namespace perl example namespace haxe example namespace netstd example service Calculator { i32 add(1:i32 num1, 2:i32 num2), } ","date":"2023-09-13","objectID":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/:2:0","tags":["thrift"],"title":"ç®€å•å°è£… thrift åè®®","uri":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" thrift server ä»£ç  @Slf4j public class ThriftServer implements Closeable { private static final String CLASS_NAME_SUFFIX_IFACE = \"$Iface\"; private static final String CLASS_NAME_SUFFIX_PROCESSOR = \"$Processor\"; private final TMultiplexedProcessor multiplexedProcessor = new TMultiplexedProcessor(); private final AtomicBoolean started = new AtomicBoolean(false); private int port; private TNonblockingServerSocket serverSocket; public ThriftServer(int port) { this.port = port; } public void startServer() { if (!started.compareAndSet(false, true)) { return; } try { serverSocket = new TNonblockingServerSocket(port); } catch (TTransportException e) { log.error(\"start thrift server\", e); throw new RuntimeException(e); } TThreadedSelectorServer.Args args = new TThreadedSelectorServer.Args(serverSocket).processor(multiplexedProcessor); TServer server = new TThreadedSelectorServer(args); new Thread(() -\u003e { log.info(\"start thrift server on port {}\",port); server.serve(); log.info(\"stop thrift server on port {}\", port); }, \"thrift-server\").start(); } public void addService(Object service) { Class\u003c?\u003e interfaceClass = findInterfaceClass(service); addProcessor(interfaceClass, service); } private synchronized void addProcessor(Class\u003c?\u003e interfaceClass, Object service) { String processorClassName = interfaceClass.getName().replace(CLASS_NAME_SUFFIX_IFACE, CLASS_NAME_SUFFIX_PROCESSOR); Class\u003c?\u003e processorClass; try { processorClass = Class.forName(processorClassName, true, interfaceClass.getClassLoader()); } catch (ClassNotFoundException e) { throw new RuntimeException(e); } TProcessor processor = (TProcessor) ReflectUtil.newInstance(processorClass, service); log.info(\"add thrift interface {}\", interfaceClass); multiplexedProcessor.registerProcessor(interfaceClass.getName(), processor); } private static Class\u003c?\u003e findInterfaceClass(Object service) { Assert.notNull(service); Class\u003c?\u003e clazz = service.getClass(); Class\u003c?\u003e interfaceClazz = null; for (Class\u003c?\u003e c : clazz.getInterfaces()) { if (c.getName().contains(CLASS_NAME_SUFFIX_IFACE)) { interfaceClazz = c; break; } } if (interfaceClazz == null) { throw new IllegalArgumentException(\"service is not thrift implement object\"); } return interfaceClazz; } @Override public void close() throws IOException { if (serverSocket != null) { serverSocket.close(); } } } ","date":"2023-09-13","objectID":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/:3:0","tags":["thrift"],"title":"ç®€å•å°è£… thrift åè®®","uri":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" thrift client ä»£ç  @Slf4j public class ThriftClient implements Closeable { private static final String CLASS_NAME_SUFFIX_IFACE = \"$Iface\"; private static final String CLASS_NAME_SUFFIX_CLIENT = \"$Client\"; private TTransport transport; private TProtocol protocol; private final AtomicBoolean started = new AtomicBoolean(false); private String host; private int port; public ThriftClient(String host, int port) { this.host = host; this.port = port; } public void startClient() { if (!started.compareAndSet(false, true)) { return; } try { transport = new TSocket(host, port); transport.open(); TTransport framedTransport = new TFramedTransport(transport, Integer.MAX_VALUE); protocol = new TBinaryProtocol(framedTransport); } catch (TTransportException e) { log.info(\"connect thrift error\", e); throw new RuntimeException(e); } } public \u003cT extends TServiceClient\u003e T getClient(String interfaceClassName) { log.info(\"add thrift interface {}\", interfaceClassName); String clientClassName = interfaceClassName.replace(CLASS_NAME_SUFFIX_IFACE, CLASS_NAME_SUFFIX_CLIENT); Class\u003cT\u003e clientClass = ClassUtil.loadClass(clientClassName); TMultiplexedProtocol multiplexedProtocol = new TMultiplexedProtocol(protocol, interfaceClassName); return ReflectUtil.newInstance(clientClass, multiplexedProtocol); } public void close() { if (transport != null) { transport.close(); } } } ","date":"2023-09-13","objectID":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/:4:0","tags":["thrift"],"title":"ç®€å•å°è£… thrift åè®®","uri":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»ç›¸å…³ä»£ç å®ç°ç±»: CalculatorHandler public class CalculatorHandler implements Calculator.Iface { @Override public int add(int num1, int num2) throws TException { System.out.println(\"num1: \" + num1 + \", num2: \" + num2); return num1 + num2; } } æµ‹è¯•ç±»: MultiThriftExampleTest public class MultiThriftExampleTest { @Test void test1() throws Exception { @Cleanup ThriftServer thriftServer = new ThriftServer(9090); thriftServer.addService(new CalculatorHandler()); thriftServer.startServer(); @Cleanup ThriftClient thriftClient = new ThriftClient(\"localhost\", 9090); thriftClient.startClient(); Calculator.Client client = thriftClient.getClient(Calculator.Iface.class.getName()); int sum = client.add(1, 2); assertEquals(3, sum); } @Test void test2() throws TException { startServer(); startClient(); } private void startClient() throws TException { try { TimeUnit.SECONDS.sleep(3); } catch (InterruptedException e) { throw new RuntimeException(e); } TTransport transport = new TSocket(\"localhost\", 9090); transport.open(); TTransport framedTransport = new TFramedTransport(transport, Integer.MAX_VALUE); TProtocol protocol = new TBinaryProtocol(framedTransport); TMultiplexedProtocol multiplexedProtocol = new TMultiplexedProtocol(protocol, Calculator.Iface.class.getName()); Calculator.Client client = new Calculator.Client(multiplexedProtocol); int add = client.add(1, 2); System.out.println(\"add: \" + add); transport.close(); } private void startServer() { CalculatorHandler handler = new CalculatorHandler(); Calculator.Processor\u003cCalculatorHandler\u003e processor = new Calculator.Processor\u003c\u003e(handler); TNonblockingServerSocket serverSocket; try { serverSocket = new TNonblockingServerSocket(9090); } catch (TTransportException e) { throw new RuntimeException(e); } TMultiplexedProcessor multiplexedProcessor = new TMultiplexedProcessor(); multiplexedProcessor.registerProcessor(Calculator.Iface.class.getName(), processor); TServer server = new TThreadedSelectorServer(new TThreadedSelectorServer.Args(serverSocket).processor(multiplexedProcessor)); new Thread(() -\u003e { System.out.println(\"Starting the simple server...\"); server.serve(); }).start(); } } ","date":"2023-09-13","objectID":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/:5:0","tags":["thrift"],"title":"ç®€å•å°è£… thrift åè®®","uri":"/ooooo-notes/%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85-thrift-%E5%8D%8F%E8%AE%AE/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œè·å–é…ç½®åˆ†ä¸º http å’Œ grpc ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º ConfigControllerV2#getConfig å’Œ ConfigQueryRequestHandlerã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘å°±é€‰æ‹© http çš„æ–¹å¼æ¥åˆ†æä»£ç ã€‚ ","date":"2023-09-12","objectID":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"17 è·å–é…ç½®","uri":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" è·å–é…ç½®æºç ä½ç½®: com.alibaba.nacos.config.server.controller.v2.ConfigControllerV2#getConfig // æ¥å— http è¯·æ±‚ public void getConfig(HttpServletRequest request, HttpServletResponse response, @RequestParam(\"dataId\") String dataId, @RequestParam(\"group\") String group, @RequestParam(value = \"namespaceId\", required = false, defaultValue = StringUtils.EMPTY) String namespaceId, @RequestParam(value = \"tag\", required = false) String tag) throws NacosException, IOException, ServletException { // check namespaceId // æ£€æŸ¥å‚æ•° ParamUtils.checkTenantV2(namespaceId); namespaceId = NamespaceUtil.processNamespaceParameter(namespaceId); // check params ParamUtils.checkParam(dataId, group, \"datumId\", \"content\"); ParamUtils.checkParamV2(tag); final String clientIp = RequestUtil.getRemoteIp(request); String isNotify = request.getHeader(\"notify\"); // è·å–é…ç½® inner.doGetConfig(request, response, dataId, group, namespaceId, tag, isNotify, clientIp, true); } æºç ä½ç½®: com.alibaba.nacos.config.server.controller.ConfigServletInner#doGetConfig // è·å–é…ç½® public String doGetConfig(HttpServletRequest request, HttpServletResponse response, String dataId, String group, String tenant, String tag, String isNotify, String clientIp, boolean isV2) throws IOException, ServletException { ... final String groupKey = GroupKey2.getKey(dataId, group, tenant); String autoTag = request.getHeader(\"Vipserver-Tag\"); String requestIpApp = RequestUtil.getAppName(request); // è·å–è¯»é” int lockResult = tryConfigReadLock(groupKey); final String requestIp = RequestUtil.getRemoteIp(request); boolean isBeta = false; boolean isSli = false; // è·å–é”æˆåŠŸ if (lockResult \u003e 0) { // LockResult \u003e 0 means cacheItem is not null and other thread can`t delete this cacheItem FileInputStream fis = null; try { String md5 = Constants.NULL; long lastModified = 0L; CacheItem cacheItem = ConfigCacheService.getContentCache(groupKey); // åˆ¤æ–­é…ç½®æ˜¯å¦ä¸º beta if (cacheItem.isBeta() \u0026\u0026 cacheItem.getIps4Beta().contains(clientIp)) { isBeta = true; } ... File file = null; ConfigInfoBase configInfoBase = null; PrintWriter out; // ä¸‹é¢çš„é€»è¾‘åˆ†ä¸º beta å’Œ tagï¼Œåˆ†åˆ«è¯»å–ä¸åŒçš„è¡¨æˆ–è€…æ–‡ä»¶ if (isBeta) { md5 = cacheItem.getMd54Beta(); lastModified = cacheItem.getLastModifiedTs4Beta(); if (PropertyUtil.isDirectRead()) { configInfoBase = configInfoBetaPersistService.findConfigInfo4Beta(dataId, group, tenant); } else { file = DiskUtil.targetBetaFile(dataId, group, tenant); } response.setHeader(\"isBeta\", \"true\"); } else { if (StringUtils.isBlank(tag)) { if (isUseTag(cacheItem, autoTag)) { if (cacheItem.tagMd5 != null) { md5 = cacheItem.tagMd5.get(autoTag); } if (cacheItem.tagLastModifiedTs != null) { lastModified = cacheItem.tagLastModifiedTs.get(autoTag); } // ä» configInfoTag ä¸­è¯»å– if (PropertyUtil.isDirectRead()) { configInfoBase = configInfoTagPersistService.findConfigInfo4Tag(dataId, group, tenant, autoTag); } else { file = DiskUtil.targetTagFile(dataId, group, tenant, autoTag); } response.setHeader(com.alibaba.nacos.api.common.Constants.VIPSERVER_TAG, URLEncoder.encode(autoTag, StandardCharsets.UTF_8.displayName())); } else { md5 = cacheItem.getMd5(); lastModified = cacheItem.getLastModifiedTs(); // ä» configInfo ä¸­è¯»å– if (PropertyUtil.isDirectRead()) { configInfoBase = configInfoPersistService.findConfigInfo(dataId, group, tenant); } else { file = DiskUtil.targetFile(dataId, group, tenant); } if (configInfoBase == null \u0026\u0026 fileNotExist(file)) { // FIXME CacheItem // No longer exists. It is impossible to simply calculate the push delayed. Here, simply record it as - 1. ConfigTraceService.logPullEvent(dataId, group, tenant, requestIpApp, -1, ConfigTraceService.PULL_EVENT_NOTFOUND, -1, requestIp, notify); // pullLog.info(\"[client-get] clientIp={}, {}, // no data\", // new Object[]{clientIp, groupKey}); // æ²¡æœ‰é…ç½®ï¼Œè¿”å›404 return get404Result(response, isV2); } isSli = true; } } else { if (cacheItem.tagMd5 != null) { md5 = cacheItem.tagMd5.get(tag); } if (cacheItem.tagLastModifiedTs != null) { Long lm = cacheItem.tagLastModifiedTs.get(tag); if (lm != null) { lastModified = lm; } } // ä» con","date":"2023-09-12","objectID":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"17 è·å–é…ç½®","uri":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.config.ConfigAPI_V2_CITCase#test ","date":"2023-09-12","objectID":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"17 è·å–é…ç½®","uri":"/ooooo-notes/17-%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œå‘å¸ƒé…ç½®åˆ†ä¸º http å’Œ grpc ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º ConfigControllerV2#publishConfig å’Œ ConfigPublishRequestHandlerã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘å°±é€‰æ‹© http çš„æ–¹å¼æ¥åˆ†æä»£ç ã€‚ ","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" å‘å¸ƒé…ç½®æºç ä½ç½®: com.alibaba.nacos.config.server.controller.v2.ConfigControllerV2#publishConfig // æ¥å— http è¯·æ±‚ï¼Œå‘å¸ƒé…ç½® public Result\u003cBoolean\u003e publishConfig(ConfigForm configForm, HttpServletRequest request) throws NacosException { // check required field configForm.validate(); // encrypted Pair\u003cString, String\u003e pair = EncryptionHandler.encryptHandler(configForm.getDataId(), configForm.getContent()); configForm.setContent(pair.getSecond()); //fix issue #9783 configForm.setNamespaceId(NamespaceUtil.processNamespaceParameter(configForm.getNamespaceId())); // check param ParamUtils.checkTenantV2(configForm.getNamespaceId()); ParamUtils.checkParam(configForm.getDataId(), configForm.getGroup(), \"datumId\", configForm.getContent()); ParamUtils.checkParamV2(configForm.getTag()); if (StringUtils.isBlank(configForm.getSrcUser())) { configForm.setSrcUser(RequestUtil.getSrcUserName(request)); } if (!ConfigType.isValidType(configForm.getType())) { configForm.setType(ConfigType.getDefaultType().getType()); } ConfigRequestInfo configRequestInfo = new ConfigRequestInfo(); configRequestInfo.setSrcIp(RequestUtil.getRemoteIp(request)); configRequestInfo.setRequestIpApp(RequestUtil.getAppName(request)); configRequestInfo.setBetaIps(request.getHeader(\"betaIps\")); String encryptedDataKey = pair.getFirst(); // configOperationService å‘å¸ƒé…ç½® return Result.success(configOperationService.publishConfig(configForm, configRequestInfo, encryptedDataKey)); } æºç ä½ç½®: com.alibaba.nacos.config.server.service.ConfigOperationService#publishConfig // configOperationService å‘å¸ƒé…ç½® public Boolean publishConfig(ConfigForm configForm, ConfigRequestInfo configRequestInfo, String encryptedDataKey) throws NacosException { // ç»„è£…å‚æ•° Map\u003cString, Object\u003e configAdvanceInfo = getConfigAdvanceInfo(configForm); // æ£€æŸ¥å‚æ•° ParamUtils.checkParam(configAdvanceInfo); // dataId é»‘åå•æ ¡éªŒ if (AggrWhitelist.isAggrDataId(configForm.getDataId())) { LOGGER.warn(\"[aggr-conflict] {} attempt to publish single data, {}, {}\", configRequestInfo.getSrcIp(), configForm.getDataId(), configForm.getGroup()); throw new NacosApiException(HttpStatus.FORBIDDEN.value(), ErrorCode.INVALID_DATA_ID, \"dataId:\" + configForm.getDataId() + \" is aggr\"); } final Timestamp time = TimeUtils.getCurrentTime(); // å°è£…ä¸º configInfo å¯¹è±¡ ConfigInfo configInfo = new ConfigInfo(configForm.getDataId(), configForm.getGroup(), configForm.getNamespaceId(), configForm.getAppName(), configForm.getContent()); configInfo.setType(configForm.getType()); configInfo.setEncryptedDataKey(encryptedDataKey); if (StringUtils.isBlank(configRequestInfo.getBetaIps())) { if (StringUtils.isBlank(configForm.getTag())) { // æ²¡æœ‰ beta å’Œ tagï¼Œæ’å…¥æˆ–è€…æ›´æ–° config_info è¡¨ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ configInfoPersistService.insertOrUpdate(configRequestInfo.getSrcIp(), configForm.getSrcUser(), configInfo, time, configAdvanceInfo, false); // å‘å¸ƒ ConfigDataChangeEvent äº‹ä»¶ ConfigChangePublisher.notifyConfigChange( new ConfigDataChangeEvent(false, configForm.getDataId(), configForm.getGroup(), configForm.getNamespaceId(), time.getTime())); } else { // æœ‰ tagï¼Œæ’å…¥æˆ–è€…æ›´æ–° config_info_tag è¡¨ï¼Œæ³¨æ„æ§åˆ¶å°æ²¡æœ‰ç”¨åˆ°è¿™ä¸ª configInfoTagPersistService.insertOrUpdateTag(configInfo, configForm.getTag(), configRequestInfo.getSrcIp(), configForm.getSrcUser(), time, false); // å‘å¸ƒ ConfigDataChangeEvent äº‹ä»¶ ConfigChangePublisher.notifyConfigChange( new ConfigDataChangeEvent(false, configForm.getDataId(), configForm.getGroup(), configForm.getNamespaceId(), configForm.getTag(), time.getTime())); } } else { // beta publish // æœ‰ beta, æ’å…¥æˆ–è€…æ›´æ–° config_info_beta è¡¨ configInfoBetaPersistService.insertOrUpdateBeta(configInfo, configRequestInfo.getBetaIps(), configRequestInfo.getSrcIp(), configForm.getSrcUser(), time, false); // å‘å¸ƒ ConfigDataChangeEvent äº‹ä»¶ ConfigChangePublisher.notifyConfigChange( new ConfigDataChangeEvent(true, configForm.getDataId(), configForm.getGroup(), configForm.getNamespaceId(), time.getTime())); } // è®°å½•æ—¥å¿— ConfigTraceService.logPersistenceEvent(configForm.getDataId(), configForm.getGroup(), configForm.getNamespaceId(), configRequestInfo.ge","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" å¤„ç† ConfigDataChangeEvent äº‹ä»¶æºç ä½ç½®: com.alibaba.nacos.config.server.service.notify.AsyncNotifyService#AsyncNotifyService // å¤„ç† ConfigDataChangeEvent äº‹ä»¶ @Autowired public AsyncNotifyService(ServerMemberManager memberManager) { this.memberManager = memberManager; // Register ConfigDataChangeEvent to NotifyCenter. // åˆ†é…äº‹ä»¶çš„ç¼“å†²å¤§å° NotifyCenter.registerToPublisher(ConfigDataChangeEvent.class, NotifyCenter.ringBufferSize); // Register A Subscriber to subscribe ConfigDataChangeEvent. // æ³¨å†Œ ConfigDataChangeEvent çš„è®¢é˜…è€… NotifyCenter.registerSubscriber(new Subscriber() { @Override public void onEvent(Event event) { // Generate ConfigDataChangeEvent concurrently if (event instanceof ConfigDataChangeEvent) { ConfigDataChangeEvent evt = (ConfigDataChangeEvent) event; long dumpTs = evt.lastModifiedTs; String dataId = evt.dataId; String group = evt.group; String tenant = evt.tenant; String tag = evt.tag; MetricsMonitor.incrementConfigChangeCount(tenant, group, dataId); Collection\u003cMember\u003e ipList = memberManager.allMembers(); // In fact, any type of queue here can be Queue\u003cNotifySingleRpcTask\u003e rpcQueue = new LinkedList\u003c\u003e(); // éå†é›†ç¾¤æˆå‘˜åˆ—è¡¨, æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ // A æœåŠ¡é…ç½®å‘ç”Ÿæ”¹å˜ä¹‹åï¼Œå¿…é¡»æ¨é€ç»™ B æœåŠ¡ï¼Œå› ä¸º B æœåŠ¡å¯èƒ½æœ‰è®¢é˜…è€…æ¥ç›‘å¬è¿™ä¸ªé…ç½®ã€‚ for (Member member : ipList) { // grpc report data change only rpcQueue.add( new NotifySingleRpcTask(dataId, group, tenant, tag, dumpTs, evt.isBeta, member)); } if (!rpcQueue.isEmpty()) { // çº¿ç¨‹æ± è°ƒåº¦ AsyncRpcTask ConfigExecutor.executeAsyncNotify(new AsyncRpcTask(rpcQueue)); } } } @Override public Class\u003c? extends Event\u003e subscribeType() { return ConfigDataChangeEvent.class; } }); } æºç ä½ç½®: com.alibaba.nacos.config.server.service.notify.AsyncNotifyService.AsyncRpcTask // çº¿ç¨‹æ± è°ƒåº¦ AsyncRpcTask class AsyncRpcTask implements Runnable { ... @Override public void run() { while (!queue.isEmpty()) { // ä»é˜Ÿåˆ—ä¸­å–å‡º task NotifySingleRpcTask task = queue.poll(); ConfigChangeClusterSyncRequest syncRequest = new ConfigChangeClusterSyncRequest(); syncRequest.setDataId(task.getDataId()); syncRequest.setGroup(task.getGroup()); syncRequest.setBeta(task.isBeta); syncRequest.setLastModified(task.getLastModified()); syncRequest.setTag(task.tag); syncRequest.setTenant(task.getTenant()); Member member = task.member; // æ˜¯å½“å‰æœåŠ¡ if (memberManager.getSelf().equals(member)) { // å¤„ç†é€»è¾‘åˆ†ä¸ºæ˜¯ä¸æ˜¯ betaï¼Œè°ƒç”¨çš„æ–¹æ³•éƒ½æ˜¯ dumpService#dump if (syncRequest.isBeta()) { dumpService.dump(syncRequest.getDataId(), syncRequest.getGroup(), syncRequest.getTenant(), syncRequest.getLastModified(), NetUtils.localIP(), true); } else { dumpService.dump(syncRequest.getDataId(), syncRequest.getGroup(), syncRequest.getTenant(), syncRequest.getTag(), syncRequest.getLastModified(), NetUtils.localIP()); } continue; } // åœ°å€æ˜¯æœ‰æ•ˆçš„ if (memberManager.hasMember(member.getAddress())) { // start the health check and there are ips that are not monitored, put them directly in the notification queue, otherwise notify boolean unHealthNeedDelay = memberManager.isUnHealth(member.getAddress()); if (unHealthNeedDelay) { // target ip is unhealthy, then put it in the notification list ConfigTraceService.logNotifyEvent(task.getDataId(), task.getGroup(), task.getTenant(), null, task.getLastModified(), InetUtils.getSelfIP(), ConfigTraceService.NOTIFY_EVENT_UNHEALTH, 0, member.getAddress()); // get delay time and set fail count to the task // å¦‚æœåœ°å€æ˜¯ä¸å¥åº·çš„ï¼Œå»¶æ—¶æ¥æ‰§è¡Œ task asyncTaskExecute(task); } else { // grpc report data change only try { // åœ°å€æ˜¯å¥åº·çš„ï¼Œç”¨ grpc æ¥å‘é€ ConfigChangeClusterSyncRequest è¯·æ±‚ï¼Œ // ä¼šè¢« ConfigChangeClusterSyncRequestHandler æ¥å¤„ç† configClusterRpcClientProxy .syncConfigChange(member, syncRequest, new AsyncRpcNotifyCallBack(task)); } catch (Exception e) { MetricsMonitor.getConfigNotifyException().increment(); // å‘é€å¼‚å¸¸ï¼Œå»¶æ—¶æ¥é‡è¯• asyncTaskExecute(task); } } } else { //No nothig if member has offline. } } } } æºç ä½ç½®: com.alibaba.nacos.config.server.remote.ConfigChangeClusterSyncRequestHandler#handle // å¤„ç† ConfigChangeClusterSyncRequest è¯·æ±‚ @Override public ConfigChangeClusterSyncResponse handle(ConfigChangeClusterSyncRequest configChangeSyncRequest, RequestMeta meta) throws N","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" dumpService#dump æ–¹æ³•æºç ä½ç½®: com.alibaba.nacos.config.server.service.dump.DumpService#dump // dumpService#dump æ–¹æ³• public void dump(String dataId, String group, String tenant, long lastModified, String handleIp, boolean isBeta) { String groupKey = GroupKey2.getKey(dataId, group, tenant); String taskKey = String.join(\"+\", dataId, group, tenant, String.valueOf(isBeta)); // æ·»åŠ äº† DumpTaskï¼Œä¼šè¢« DumpProcessor æ¥å¤„ç† dumpTaskMgr.addTask(taskKey, new DumpTask(groupKey, lastModified, handleIp, isBeta)); DUMP_LOG.info(\"[dump-task] add task. groupKey={}, taskKey={}\", groupKey, taskKey); } æºç ä½ç½®: com.alibaba.nacos.config.server.service.dump.processor.DumpProcessor#process // å¤„ç† DumpTask @Override public boolean process(NacosTask task) { DumpTask dumpTask = (DumpTask) task; String[] pair = GroupKey2.parseKey(dumpTask.getGroupKey()); String dataId = pair[0]; String group = pair[1]; String tenant = pair[2]; long lastModified = dumpTask.getLastModified(); String handleIp = dumpTask.getHandleIp(); boolean isBeta = dumpTask.isBeta(); String tag = dumpTask.getTag(); ConfigDumpEvent.ConfigDumpEventBuilder build = ConfigDumpEvent.builder().namespaceId(tenant).dataId(dataId) .group(group).isBeta(isBeta).tag(tag).lastModifiedTs(lastModified).handleIp(handleIp); // ä¸‹é¢çš„é€»è¾‘åˆåˆ†ä¸º beta, tag if (isBeta) { // if publish beta, then dump config, update beta cache ConfigInfo4Beta cf = configInfoBetaPersistService.findConfigInfo4Beta(dataId, group, tenant); // cf ä¸º nullï¼Œè¯´æ˜ä¹‹å‰åˆ é™¤äº† build.remove(Objects.isNull(cf)); build.betaIps(Objects.isNull(cf) ? null : cf.getBetaIps()); build.content(Objects.isNull(cf) ? null : cf.getContent()); build.encryptedDataKey(Objects.isNull(cf) ? null : cf.getEncryptedDataKey()); return DumpConfigHandler.configDump(build.build()); } if (StringUtils.isBlank(tag)) { ConfigInfo cf = configInfoPersistService.findConfigInfo(dataId, group, tenant); build.remove(Objects.isNull(cf)); build.content(Objects.isNull(cf) ? null : cf.getContent()); build.type(Objects.isNull(cf) ? null : cf.getType()); build.encryptedDataKey(Objects.isNull(cf) ? null : cf.getEncryptedDataKey()); } else { ConfigInfo4Tag cf = configInfoTagPersistService.findConfigInfo4Tag(dataId, group, tenant, tag); build.remove(Objects.isNull(cf)); build.content(Objects.isNull(cf) ? null : cf.getContent()); } // è°ƒç”¨ DumpConfigHandler#configDump æ–¹æ³• return DumpConfigHandler.configDump(build.build()); } æºç ä½ç½®: com.alibaba.nacos.config.server.service.dump.DumpConfigHandler#configDump // DumpConfigHandler#configDump æ–¹æ³• public static boolean configDump(ConfigDumpEvent event) { ... // å¤„ç†é€»è¾‘åˆåˆ†ä¸º beatï¼Œ tag if (event.isBeta()) { boolean result; if (event.isRemove()) { // åˆ é™¤é…ç½® result = ConfigCacheService.removeBeta(dataId, group, namespaceId); if (result) { // è®°å½•æ—¥å¿— ConfigTraceService.logDumpEvent(dataId, group, namespaceId, null, lastModified, event.getHandleIp(), ConfigTraceService.DUMP_EVENT_REMOVE_OK, System.currentTimeMillis() - lastModified, 0); } return result; } else { // æ›´æ–°é…ç½® result = ConfigCacheService .dumpBeta(dataId, group, namespaceId, content, lastModified, event.getBetaIps(), encryptedDataKey); if (result) { // è®°å½•æ—¥å¿— ConfigTraceService.logDumpEvent(dataId, group, namespaceId, null, lastModified, event.getHandleIp(), ConfigTraceService.DUMP_EVENT_OK, System.currentTimeMillis() - lastModified, content.length()); } } return result; } if (StringUtils.isBlank(event.getTag())) { // dataId é»‘åå•åŠ è½½ if (dataId.equals(AggrWhitelist.AGGRIDS_METADATA)) { AggrWhitelist.load(content); } // clientIp ç™½åå• if (dataId.equals(ClientIpWhiteList.CLIENT_IP_WHITELIST_METADATA)) { ClientIpWhiteList.load(content); } // switchMeta å…ƒæ•°æ® if (dataId.equals(SwitchService.SWITCH_META_DATAID)) { SwitchService.load(content); } boolean result; if (!event.isRemove()) { // æ›´æ–°é…ç½® result = ConfigCacheService .dump(dataId, group, namespaceId, content, lastModified, type, encryptedDataKey); ... } else { // åˆ é™¤é…ç½® result = ConfigCacheService.remove(dataId, group, namespaceId); ... } return result; } else { // boolean result; if (!event.isRemove","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" å¤„ç† LocalDataChangeEvent äº‹ä»¶æºç ä½ç½®: `` // å¤„ç† LocalDataChangeEvent äº‹ä»¶ @Override public void onEvent(LocalDataChangeEvent event) { ... // å¤„ç†äº‹ä»¶ configDataChanged(groupKey, dataId, group, tenant, isBeta, betaIps, tag); } // å¤„ç†äº‹ä»¶ public void configDataChanged(String groupKey, String dataId, String group, String tenant, boolean isBeta, List\u003cString\u003e betaIps, String tag) { Set\u003cString\u003e listeners = configChangeListenContext.getListeners(groupKey); if (CollectionUtils.isEmpty(listeners)) { return; } int notifyClientCount = 0; // éå†æ‰€æœ‰è®¢é˜…è€… for (final String client : listeners) { // è·å– Connection Connection connection = connectionManager.getConnection(client); if (connection == null) { continue; } ConnectionMeta metaInfo = connection.getMetaInfo(); //beta ips check. String clientIp = metaInfo.getClientIp(); String clientTag = metaInfo.getTag(); // åˆ¤æ–­æ˜¯å¦è¦ beta æ¨é€ if (isBeta \u0026\u0026 betaIps != null \u0026\u0026 !betaIps.contains(clientIp)) { continue; } //tag check // åˆ¤æ–­æ˜¯å¦è¦ tag æ¨é€ if (StringUtils.isNotBlank(tag) \u0026\u0026 !tag.equals(clientTag)) { continue; } ConfigChangeNotifyRequest notifyRequest = ConfigChangeNotifyRequest.build(dataId, group, tenant); // å°è£…ä¸º RpcPushTaskï¼Œé”™è¯¯æ¬¡æ•°ä¸º 50 RpcPushTask rpcPushRetryTask = new RpcPushTask(notifyRequest, 50, client, clientIp, metaInfo.getAppName()); // å¼‚æ­¥æ¨é€é…ç½®æ•°æ® push(rpcPushRetryTask); notifyClientCount++; } Loggers.REMOTE_PUSH.info(\"push [{}] clients ,groupKey=[{}]\", notifyClientCount, groupKey); } // å¼‚æ­¥æ¨é€é…ç½®æ•°æ® private void push(RpcPushTask retryTask) { ConfigChangeNotifyRequest notifyRequest = retryTask.notifyRequest; if (retryTask.isOverTimes()) { // é”™è¯¯æ¬¡æ•°è¾¾åˆ°ä¸Šé™ Loggers.REMOTE_PUSH .warn(\"push callback retry fail over times .dataId={},group={},tenant={},clientId={},will unregister client.\", notifyRequest.getDataId(), notifyRequest.getGroup(), notifyRequest.getTenant(), retryTask.connectionId); // æ³¨é”€è¿æ¥ connectionManager.unregister(retryTask.connectionId); } else if (connectionManager.getConnection(retryTask.connectionId) != null) { // first time:delay 0s; second time:delay 2s; third time:delay 4s // çº¿ç¨‹æ± å»¶è¿Ÿè°ƒåº¦ ConfigExecutor.getClientConfigNotifierServiceExecutor() .schedule(retryTask, retryTask.tryTimes * 2, TimeUnit.SECONDS); } else { // client is already offline, ignore task. } } æºç ä½ç½®: com.alibaba.nacos.config.server.remote.RpcConfigChangeNotifier.RpcPushTask#run // RpcPushTask æ‰§è¡Œ @Override public void run() { tryTimes++; TpsCheckRequest tpsCheckRequest = new TpsCheckRequest(); tpsCheckRequest.setPointName(POINT_CONFIG_PUSH); // æ£€æŸ¥ tpsï¼Œé»˜è®¤æ²¡æœ‰å®ç° if (!tpsControlManager.check(tpsCheckRequest).isSuccess()) { push(this); } else { // å‘é€ notifyRequest è¯·æ±‚ç»™å®¢æˆ·ç«¯ rpcPushService.pushWithCallback(connectionId, notifyRequest, new AbstractPushCallBack(3000L) { @Override public void onSuccess() { TpsCheckRequest tpsCheckRequest = new TpsCheckRequest(); tpsCheckRequest.setPointName(POINT_CONFIG_PUSH_SUCCESS); tpsControlManager.check(tpsCheckRequest); } @Override public void onFail(Throwable e) { TpsCheckRequest tpsCheckRequest = new TpsCheckRequest(); tpsCheckRequest.setPointName(POINT_CONFIG_PUSH_FAIL); tpsControlManager.check(tpsCheckRequest); Loggers.REMOTE_PUSH.warn(\"Push fail\", e); push(RpcPushTask.this); } }, ConfigExecutor.getClientConfigNotifierServiceExecutor()); } } ","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.config.ConfigAPI_V2_CITCase#test ","date":"2023-09-11","objectID":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"16 å‘å¸ƒé…ç½®","uri":"/ooooo-notes/16-%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œæ‰‹åŠ¨åˆ›å»º serviceï¼Œæ›´æ–° serviceï¼Œåˆ é™¤ serviceï¼Œæ›´æ–° instanceï¼Œéƒ½æ˜¯é€šè¿‡ raft åè®®æ¥å®ç°çš„ï¼Œæ‰€ä»¥æ¥ç®€å•ä»‹ç»ä¸‹ã€‚ ","date":"2023-09-09","objectID":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"15 åŒæ­¥æœåŠ¡å’Œå®ä¾‹å…ƒæ•°æ®ä¿¡æ¯","uri":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/"},{"categories":null,"content":" service å…ƒæ•°æ®åŒæ­¥æºç ä½ç½®: com.alibaba.nacos.naming.core.ServiceOperatorV2Impl // ä¸‹é¢è¿™äº›æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ metadataOperateService çš„ updateServiceMetadata æˆ–è€… deleteServiceMetadata // åˆ›å»º service public void create(Service service, ServiceMetadata metadata) throws NacosException { // æ£€æŸ¥ service if (ServiceManager.getInstance().containSingleton(service)) { throw new NacosApiException(NacosException.INVALID_PARAM, ErrorCode.SERVICE_ALREADY_EXIST, String.format(\"specified service %s already exists!\", service.getGroupedServiceName())); } // raft åè®®æ›´æ–°æœåŠ¡å…ƒæ•°æ® metadataOperateService.updateServiceMetadata(service, metadata); } // æ›´æ–° service @Override public void update(Service service, ServiceMetadata metadata) throws NacosException { // æ£€æŸ¥ service if (!ServiceManager.getInstance().containSingleton(service)) { throw new NacosApiException(NacosException.INVALID_PARAM, ErrorCode.SERVICE_NOT_EXIST, String.format(\"service %s not found!\", service.getGroupedServiceName())); } // raft åè®®æ›´æ–°æœåŠ¡å…ƒæ•°æ® metadataOperateService.updateServiceMetadata(service, metadata); } // åˆ é™¤ service @Override public void delete(String namespaceId, String serviceName) throws NacosException { Service service = getServiceFromGroupedServiceName(namespaceId, serviceName, true); // raft åè®®åˆ é™¤æœåŠ¡å…ƒæ•°æ® delete(service); } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.NamingMetadataOperateService#updateServiceMetadata // æ›´æ–°æœåŠ¡å…ƒæ•°æ® public void updateServiceMetadata(Service service, ServiceMetadata serviceMetadata) { MetadataOperation\u003cServiceMetadata\u003e operation = buildMetadataOperation(service); operation.setMetadata(serviceMetadata); // æ„å»º WriteRequest, è¿™é‡Œçš„ group æ˜¯ naming_service_metadata WriteRequest operationLog = WriteRequest.newBuilder().setGroup(Constants.SERVICE_METADATA) .setOperation(DataOperation.CHANGE.name()).setData(ByteString.copyFrom(serializer.serialize(operation))) .build(); // æäº¤å…ƒæ•°æ® submitMetadataOperation(operationLog); } // åˆ é™¤æœåŠ¡å…ƒæ•°æ® public void delete(Service service) throws NacosException { // æ£€æŸ¥ service if (!ServiceManager.getInstance().containSingleton(service)) { throw new NacosApiException(NacosException.INVALID_PARAM, ErrorCode.SERVICE_NOT_EXIST, String.format(\"service %s not found!\", service.getGroupedServiceName())); } // åˆ é™¤ serviceï¼Œå¿…é¡»å…ˆæ³¨é”€æ‰€æœ‰çš„ instance if (!serviceStorage.getPushData(service).getHosts().isEmpty()) { throw new NacosApiException(NacosException.INVALID_PARAM, ErrorCode.SERVICE_DELETE_FAILURE, \"Service \" + service.getGroupedServiceName() + \" is not empty, can't be delete. Please unregister instance first\"); } // åˆ é™¤æœåŠ¡å…ƒæ•°æ® metadataOperateService.deleteServiceMetadata(service); } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.NamingMetadataOperateService#submitMetadataOperation // æäº¤å…ƒæ•°æ®, ä½¿ç”¨ raft åè®®, æœ€åä¼šè¢« ServiceMetadataProcessor#onApply å¤„ç† private void submitMetadataOperation(WriteRequest operationLog) { try { Response response = cpProtocol.write(operationLog); if (!response.getSuccess()) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, \"do metadata operation failed \" + response.getErrMsg()); } } catch (Exception e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, \"do metadata operation failed\", e); } } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.ServiceMetadataProcessor#onApply @Override public Response onApply(WriteRequest request) { readLock.lock(); try { MetadataOperation\u003cServiceMetadata\u003e op = serializer.deserialize(request.getData().toByteArray(), processType); switch (DataOperation.valueOf(request.getOperation())) { case ADD: addClusterMetadataToService(op); break; case CHANGE: updateServiceMetadata(op); break; case DELETE: deleteServiceMetadata(op); break; default: return Response.newBuilder().setSuccess(false) .setErrMsg(\"Unsupported operation \" + request.getOperation()).build(); } return Response.newBuilder().setSuccess(true).build(); } catch (Exception e) { Loggers.RAFT.error(\"onApply {} service metadata operation failed. \", request.getOperation(), e); String errorMessage = null == e.getMessage() ? e.getClass().getName() : e.getMe","date":"2023-09-09","objectID":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"15 åŒæ­¥æœåŠ¡å’Œå®ä¾‹å…ƒæ•°æ®ä¿¡æ¯","uri":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/"},{"categories":null,"content":" instance å…ƒæ•°æ®åŒæ­¥æºç ä½ç½®: com.alibaba.nacos.naming.core.InstanceOperatorClientImpl#updateInstance // æ›´æ–°å®ä¾‹å…ƒæ•°æ® @Override public void updateInstance(String namespaceId, String serviceName, Instance instance) throws NacosException { NamingUtils.checkInstanceIsLegal(instance); Service service = getService(namespaceId, serviceName, instance.isEphemeral()); // æ£€æŸ¥ service if (!ServiceManager.getInstance().containSingleton(service)) { throw new NacosApiException(NacosException.INVALID_PARAM, ErrorCode.INSTANCE_ERROR, \"service not found, namespace: \" + namespaceId + \", service: \" + service); } String metadataId = InstancePublishInfo .genMetadataId(instance.getIp(), instance.getPort(), instance.getClusterName()); // æ›´æ–°å®ä¾‹å…ƒæ•°æ® metadataOperateService.updateInstanceMetadata(service, metadataId, buildMetadata(instance)); } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.NamingMetadataOperateService#updateInstanceMetadata // æ›´æ–°å®ä¾‹å…ƒæ•°æ® public void updateInstanceMetadata(Service service, String metadataId, InstanceMetadata instanceMetadata) { MetadataOperation\u003cInstanceMetadata\u003e operation = buildMetadataOperation(service); operation.setTag(metadataId); operation.setMetadata(instanceMetadata); // æ„é€  WriteRequest è¯·æ±‚ï¼Œæ³¨æ„è¿™é‡Œçš„ group ä¸º naming_instance_metadata WriteRequest operationLog = WriteRequest.newBuilder().setGroup(Constants.INSTANCE_METADATA) .setOperation(DataOperation.CHANGE.name()).setData(ByteString.copyFrom(serializer.serialize(operation))) .build(); // æäº¤å…ƒæ•°æ®è¯·æ±‚ submitMetadataOperation(operationLog); } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.NamingMetadataOperateService#submitMetadataOperation // æäº¤å…ƒæ•°æ®è¯·æ±‚ private void submitMetadataOperation(WriteRequest operationLog) { try { // raft æäº¤è¯·æ±‚ï¼Œä¼šè¢« InstanceMetadataProcessor#onApply æ¥å¤„ç† Response response = cpProtocol.write(operationLog); if (!response.getSuccess()) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, \"do metadata operation failed \" + response.getErrMsg()); } } catch (Exception e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, \"do metadata operation failed\", e); } } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.metadata.InstanceMetadataProcessor#onApply @Override public Response onApply(WriteRequest request) { readLock.lock(); try { MetadataOperation\u003cInstanceMetadata\u003e op = serializer.deserialize(request.getData().toByteArray(), processType); switch (DataOperation.valueOf(request.getOperation())) { case ADD: case CHANGE: updateInstanceMetadata(op); break; case DELETE: deleteInstanceMetadata(op); break; default: return Response.newBuilder().setSuccess(false) .setErrMsg(\"Unsupported operation \" + request.getOperation()).build(); } return Response.newBuilder().setSuccess(true).build(); } catch (Exception e) { Loggers.RAFT.error(\"onApply {} instance metadata operation failed. \", request.getOperation(), e); String errorMessage = null == e.getMessage() ? e.getClass().getName() : e.getMessage(); return Response.newBuilder().setSuccess(false).setErrMsg(errorMessage).build(); } finally { readLock.unlock(); } } ","date":"2023-09-09","objectID":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"15 åŒæ­¥æœåŠ¡å’Œå®ä¾‹å…ƒæ•°æ®ä¿¡æ¯","uri":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#createService ","date":"2023-09-09","objectID":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"15 åŒæ­¥æœåŠ¡å’Œå®ä¾‹å…ƒæ•°æ®ä¿¡æ¯","uri":"/ooooo-notes/15-%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF/"},{"categories":null,"content":"raft èŠ‚ç‚¹åœ¨æœºå™¨ipå˜åŠ¨ä¹‹åï¼Œå¯èƒ½å‡ºç°é€‰ä¸»ä¸æˆåŠŸçš„é—®é¢˜ã€‚ ","date":"2023-09-08","objectID":"/ooooo-notes/raft-%E5%8D%8F%E8%AE%AE%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE-ip/:0:0","tags":["raft"],"title":"raft åè®®é‡æ–°è®¾ç½® ip","uri":"/ooooo-notes/raft-%E5%8D%8F%E8%AE%AE%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE-ip/"},{"categories":null,"content":" è§£å†³æ–¹æ³•ä¸‹é¢æ˜¯ nacos çš„ JRaft è§£å†³æ–¹æ³• @Test public void test() throws IOException { String[] groupIds = {\"naming_instance_metadata\", \"naming_persistent_service_v2\", \"naming_service_metadata\"}; String logPath = \"/Users/ooooo/nacos/data/protocol/raft/%s/log\"; // éå† groupId for (String groupId : groupIds) { // logStorage LogStorage logStorage = new RocksDBLogStorage(String.format(logPath, groupId), new RaftOptions()); // logStorageOptions LogStorageOptions logStorageOptions = new LogStorageOptions(); logStorageOptions.setConfigurationManager(new ConfigurationManager()); logStorageOptions.setLogEntryCodecFactory(LogEntryV2CodecFactory.getInstance()); logStorageOptions.setGroupId(groupId); // åˆå§‹åŒ– boolean init = logStorage.init(logStorageOptions); if (init) { // è·å–æœ€åä¸€ä¸ª index long lastLogIndex = logStorage.getLastLogIndex(); System.out.println(lastLogIndex); // æ–°å¢é…ç½® LogEntry logEntry = new LogEntry(); logEntry.setType(EnumOutter.EntryType.ENTRY_TYPE_CONFIGURATION); logEntry.setPeers(Collections.singletonList(PeerId.parsePeer(\"127.0.0.1:7848\"))); // æ·»åŠ åˆ°æ—¥å¿—ä¸­ boolean b = logStorage.appendEntry(logEntry); System.out.println(b); } } } ","date":"2023-09-08","objectID":"/ooooo-notes/raft-%E5%8D%8F%E8%AE%AE%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE-ip/:1:0","tags":["raft"],"title":"raft åè®®é‡æ–°è®¾ç½® ip","uri":"/ooooo-notes/raft-%E5%8D%8F%E8%AE%AE%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE-ip/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raft åè®®çš„åˆå§‹åŒ–æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftProtocol#init @Override public void init(RaftConfig config) { // åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ– if (initialized.compareAndSet(false, true)) { this.raftConfig = config; // è¿™é‡Œæ˜¯ä¸€ä¸ªç©ºæ–¹æ³• NotifyCenter.registerToSharePublisher(RaftEvent.class); // raftServer åˆå§‹åŒ– this.raftServer.init(this.raftConfig); // raftServer å¯åŠ¨ this.raftServer.start(); // There is only one consumer to ensure that the internal consumption // is sequential and there is no concurrent competition // ç›‘å¬ RaftEvent äº‹ä»¶ NotifyCenter.registerSubscriber(new Subscriber\u003cRaftEvent\u003e() { @Override public void onEvent(RaftEvent event) { Loggers.RAFT.info(\"This Raft event changes : {}\", event); final String groupId = event.getGroupId(); Map\u003cString, Map\u003cString, Object\u003e\u003e value = new HashMap\u003c\u003e(); Map\u003cString, Object\u003e properties = new HashMap\u003c\u003e(); final String leader = event.getLeader(); final Long term = event.getTerm(); final List\u003cString\u003e raftClusterInfo = event.getRaftClusterInfo(); final String errMsg = event.getErrMsg(); // Leader information needs to be selectively updated. If it is valid data, // the information in the protocol metadata is updated. MapUtil.putIfValNoEmpty(properties, MetadataKey.LEADER_META_DATA, leader); MapUtil.putIfValNoNull(properties, MetadataKey.TERM_META_DATA, term); MapUtil.putIfValNoEmpty(properties, MetadataKey.RAFT_GROUP_MEMBER, raftClusterInfo); MapUtil.putIfValNoEmpty(properties, MetadataKey.ERR_MSG, errMsg); value.put(groupId, properties); // ä¿å­˜å…ƒæ•°æ® metaData.load(value); // The metadata information is injected into the metadata information of the node // ä¼šå‘å¸ƒ MembersChangeEvent äº‹ä»¶ injectProtocolMetaData(metaData); } @Override public Class\u003c? extends Event\u003e subscribeType() { return RaftEvent.class; } }); } } ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raftServer çš„åˆå§‹åŒ–æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#init void init(RaftConfig config) { this.raftConfig = config; this.serializer = SerializeFactory.getDefault(); Loggers.RAFT.info(\"Initializes the Raft protocol, raft-config info : {}\", config); // åˆå§‹åŒ– raft çº¿ç¨‹æ±  RaftExecutor.init(config); // è§£æé…ç½® final String self = config.getSelfMember(); String[] info = InternetAddressUtil.splitIPPortStr(self); selfIp = info[0]; selfPort = Integer.parseInt(info[1]); localPeerId = PeerId.parsePeer(self); nodeOptions = new NodeOptions(); // Set the election timeout time. The default is 5 seconds. // é€‰ä¸¾çš„è¶…æ—¶æ—¶é—´ int electionTimeout = Math.max(ConvertUtils.toInt(config.getVal(RaftSysConstants.RAFT_ELECTION_TIMEOUT_MS), RaftSysConstants.DEFAULT_ELECTION_TIMEOUT), RaftSysConstants.DEFAULT_ELECTION_TIMEOUT); // è¯·æ±‚è¶…æ—¶æ—¶é—´ rpcRequestTimeoutMs = ConvertUtils.toInt(raftConfig.getVal(RaftSysConstants.RAFT_RPC_REQUEST_TIMEOUT_MS), RaftSysConstants.DEFAULT_RAFT_RPC_REQUEST_TIMEOUT_MS); // å…±äº«å®šæ—¶å™¨ nodeOptions.setSharedElectionTimer(true); nodeOptions.setSharedVoteTimer(true); nodeOptions.setSharedStepDownTimer(true); nodeOptions.setSharedSnapshotTimer(true); nodeOptions.setElectionTimeoutMs(electionTimeout); // é…ç½® raft RaftOptions raftOptions = RaftOptionsBuilder.initRaftOptions(raftConfig); nodeOptions.setRaftOptions(raftOptions); // open jraft node metrics record function nodeOptions.setEnableMetrics(true); CliOptions cliOptions = new CliOptions(); // åˆå§‹åŒ– raft çš„ cliService this.cliService = RaftServiceFactory.createAndInitCliService(cliOptions); // cliService çš„é€šä¿¡ç±», ä»è¿™ä¸ªç±»ä¸­å¯ä»¥æ‹¿åˆ° rpcClient this.cliClientService = (CliClientServiceImpl) ((CliServiceImpl) this.cliService).getCliClientService(); } ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raftServer çš„å¯åŠ¨æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#start synchronized void start() { // åˆ¤æ–­æ˜¯å¦å·²ç»å¯åŠ¨ if (!isStarted) { Loggers.RAFT.info(\"========= The raft protocol is starting... =========\"); try { // init raft group node // åˆå§‹åŒ– raft çš„èŠ‚ç‚¹åˆ—è¡¨ com.alipay.sofa.jraft.NodeManager raftNodeManager = com.alipay.sofa.jraft.NodeManager.getInstance(); for (String address : raftConfig.getMembers()) { PeerId peerId = PeerId.parsePeer(address); conf.addPeer(peerId); raftNodeManager.addAddress(peerId.getEndpoint()); } // è®¾ç½®èŠ‚ç‚¹é…ç½® nodeOptions.setInitialConf(conf); // åˆ›å»º rpcServer å’Œè‡ªå®šä¹‰è¯·æ±‚å¤„ç†å™¨, è¿™ä¸ª server åœ¨å¤šä¸ª raft group ä¸­æ˜¯å…±äº«çš„ rpcServer = JRaftUtils.initRpcServer(this, localPeerId); // rpcServer åˆå§‹åŒ– if (!this.rpcServer.init(null)) { Loggers.RAFT.error(\"Fail to init [BaseRpcServer].\"); throw new RuntimeException(\"Fail to init [BaseRpcServer].\"); } // Initialize multi raft group service framework isStarted = true; // åˆ›å»º raftGroup createMultiRaftGroup(processors); Loggers.RAFT.info(\"========= The raft protocol start finished... =========\"); } catch (Exception e) { Loggers.RAFT.error(\"raft protocol start failure, cause: \", e); throw new JRaftException(e); } } } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.utils.JRaftUtils#initRpcServer // åˆ›å»º rpcServer å’Œè‡ªå®šä¹‰è¯·æ±‚å¤„ç†å™¨ public static RpcServer initRpcServer(JRaftServer server, PeerId peerId) { GrpcRaftRpcFactory raftRpcFactory = (GrpcRaftRpcFactory) RpcFactoryHelper.rpcFactory(); // æ³¨å†Œ protobuf åºåˆ—åŒ–ç±» raftRpcFactory.registerProtobufSerializer(Log.class.getName(), Log.getDefaultInstance()); raftRpcFactory.registerProtobufSerializer(GetRequest.class.getName(), GetRequest.getDefaultInstance()); raftRpcFactory.registerProtobufSerializer(WriteRequest.class.getName(), WriteRequest.getDefaultInstance()); raftRpcFactory.registerProtobufSerializer(ReadRequest.class.getName(), ReadRequest.getDefaultInstance()); raftRpcFactory.registerProtobufSerializer(Response.class.getName(), Response.getDefaultInstance()); // æ³¨å†Œå“åº”ç±» MarshallerRegistry registry = raftRpcFactory.getMarshallerRegistry(); registry.registerResponseInstance(Log.class.getName(), Response.getDefaultInstance()); registry.registerResponseInstance(GetRequest.class.getName(), Response.getDefaultInstance()); registry.registerResponseInstance(WriteRequest.class.getName(), Response.getDefaultInstance()); registry.registerResponseInstance(ReadRequest.class.getName(), Response.getDefaultInstance()); final RpcServer rpcServer = raftRpcFactory.createRpcServer(peerId.getEndpoint()); // æ·»åŠ  raft çš„ requestProcessor RaftRpcServerFactory.addRaftRequestProcessors(rpcServer, RaftExecutor.getRaftCoreExecutor(), RaftExecutor.getRaftCliServiceExecutor()); // æ³¨å†Œè‡ªå®šä¹‰çš„ requestProcessor rpcServer.registerProcessor(new NacosWriteRequestProcessor(server, SerializeFactory.getDefault())); rpcServer.registerProcessor(new NacosReadRequestProcessor(server, SerializeFactory.getDefault())); return rpcServer; } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#createMultiRaftGroup // åˆ›å»º raftGroup // ä»è¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡º // æ¯ä¸ª groupName éƒ½ä¼šå¯¹åº”ä¸€ä¸ª processorï¼Œä¸€ä¸ª NacosStateMachineï¼Œä¸€ä¸ª Nodeã€‚ synchronized void createMultiRaftGroup(Collection\u003cRequestProcessor4CP\u003e processors) { // There is no reason why the LogProcessor cannot be processed because of the synchronization if (!this.isStarted) { // æ·»åŠ  processor this.processors.addAll(processors); return; } // raft æ—¥å¿—å­˜å‚¨è·¯å¾„ final String parentPath = Paths.get(EnvUtil.getNacosHome(), \"data/protocol/raft\").toString(); // éå† processors for (RequestProcessor4CP processor : processors) { final String groupName = processor.group(); // åˆ¤æ–­ group æ˜¯å¦é‡å¤ if (multiRaftGroup.containsKey(groupName)) { throw new DuplicateRaftGroupException(groupName); } // Ensure that each Raft Group has its own configuration and NodeOptions Configuration configuration = conf.copy(); NodeOptions copy = nodeOptions.copy(); // åˆå§‹åŒ–ç›®å½• JRaftUtils.initDirectory(parentPath, groupName, copy); // Here, the LogProcessor is passed into StateMachine, and when the StateMachine // triggers onApply, ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raft èŠ‚ç‚¹å˜æ›´æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#registerSelfToCluster // å¢åŠ èŠ‚ç‚¹ void registerSelfToCluster(String groupId, PeerId selfIp, Configuration conf) { while (!isShutdown) { try { // è·å– groupId å¯¹åº”çš„æˆå‘˜åˆ—è¡¨ List\u003cPeerId\u003e peerIds = cliService.getPeers(groupId, conf); if (peerIds.contains(selfIp)) { return; } // æ·»åŠ è‡ªå·±çš„ ip åˆ°é›†ç¾¤ä¸­ Status status = cliService.addPeer(groupId, conf, selfIp); if (status.isOk()) { return; } Loggers.RAFT.warn(\"Failed to join the cluster, retry...\"); } catch (Exception e) { Loggers.RAFT.error(\"Failed to join the cluster, retry...\", e); } ThreadUtils.sleep(1_000L); } } æºç ä½ç½®: com.alibaba.nacos.consistency.ConsistencyProtocol#memberChange // åˆ é™¤èŠ‚ç‚¹ @Override public void memberChange(Set\u003cString\u003e addresses) { // è¿™é‡Œä¼šé‡è¯• 5 æ¬¡ for (int i = 0; i \u003c 5; i++) { // åˆ é™¤èŠ‚ç‚¹ if (this.raftServer.peerChange(jRaftMaintainService, addresses)) { return; } ThreadUtils.sleep(100L); } Loggers.RAFT.warn(\"peer removal failed\"); } boolean peerChange(JRaftMaintainService maintainService, Set\u003cString\u003e newPeers) { // This is only dealing with node deletion, the Raft protocol, where the node adds itself to the cluster when it starts up Set\u003cString\u003e oldPeers = new HashSet\u003c\u003e(this.raftConfig.getMembers()); this.raftConfig.setMembers(localPeerId.toString(), newPeers); oldPeers.removeAll(newPeers); // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æœ‰åˆ é™¤ï¼Œä¸ºç©ºï¼Œè¡¨ç¤ºèŠ‚ç‚¹ä¸å˜æˆ–è€…æœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥ if (oldPeers.isEmpty()) { return true; } Set\u003cString\u003e waitRemove = oldPeers; AtomicInteger successCnt = new AtomicInteger(0); // éå† multiRaftGroup æ¥åˆ é™¤ multiRaftGroup.forEach(new BiConsumer\u003cString, RaftGroupTuple\u003e() { @Override public void accept(String group, RaftGroupTuple tuple) { Map\u003cString, String\u003e params = new HashMap\u003c\u003e(); params.put(JRaftConstants.GROUP_ID, group); params.put(JRaftConstants.COMMAND_NAME, JRaftConstants.REMOVE_PEERS); params.put(JRaftConstants.COMMAND_VALUE, StringUtils.join(waitRemove, StringUtils.COMMA)); // æ‰§è¡Œåˆ é™¤å‘½ä»¤, REMOVE_PEERS RestResult\u003cString\u003e result = maintainService.execute(params); if (result.ok()) { successCnt.incrementAndGet(); } else { Loggers.RAFT.error(\"Node removal failed : {}\", result); } } }); return successCnt.get() == multiRaftGroup.size(); } // æºç ä½ç½®ï¼šcom.alibaba.nacos.core.distributed.raft.utils.JRaftOps#REMOVE_PEERS REMOVE_PEERS(JRaftConstants.REMOVE_PEERS) { @Override public RestResult\u003cString\u003e execute(CliService cliService, String groupId, Node node, Map\u003cString, String\u003e args) { final Configuration conf = node.getOptions().getInitialConf(); final String peers = args.get(JRaftConstants.COMMAND_VALUE); // éå†èŠ‚ç‚¹ for (String s : peers.split(\",\")) { List\u003cPeerId\u003e peerIds = cliService.getPeers(groupId, conf); final PeerId waitRemove = PeerId.parsePeer(s); // ä¸åŒ…å«ï¼Œåˆ™ä¸éœ€è¦åˆ é™¤ if (!peerIds.contains(waitRemove)) { continue; } // åˆ é™¤èŠ‚ç‚¹ Status status = cliService.removePeer(groupId, conf, waitRemove); if (!status.isOk()) { return RestResultUtils.failed(status.getErrorMsg()); } } return RestResultUtils.success(); } }, ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raft çš„è¯·æ±‚å¤„ç†è¿‡ç¨‹è¿™é‡Œä»¥ writeRequest ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ raft æ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚çš„ã€‚ æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.PersistentClientOperationServiceImpl#registerInstance // å®¢æˆ·ç«¯å‘èµ·æ³¨å†ŒæŒä¹…åŒ–å®ä¾‹ @Override public void registerInstance(Service service, Instance instance, String clientId) { Service singleton = ServiceManager.getInstance().getSingleton(service); if (singleton.isEphemeral()) { throw new NacosRuntimeException(NacosException.INVALID_PARAM, String.format(\"Current service %s is ephemeral service, can't register persistent instance.\", singleton.getGroupedServiceName())); } final InstanceStoreRequest request = new InstanceStoreRequest(); request.setService(service); request.setInstance(instance); request.setClientId(clientId); // è¿™é‡Œè®¾ç½®äº† raft group, ç­‰ä¸‹ä¼šç”¨åˆ° final WriteRequest writeRequest = WriteRequest.newBuilder().setGroup(group()) .setData(ByteString.copyFrom(serializer.serialize(request))).setOperation(DataOperation.ADD.name()) .build(); try { // raftProtocol æ¥å†™è¯·æ±‚ protocol.write(writeRequest); Loggers.RAFT.info(\"Client registered. service={}, clientId={}, instance={}\", service, instance, clientId); } catch (Exception e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, e); } } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftProtocol#write // raftProtocol æ¥å†™è¯·æ±‚ @Override public Response write(WriteRequest request) throws Exception { // å¼‚æ­¥è¯·æ±‚ CompletableFuture\u003cResponse\u003e future = writeAsync(request); // Here you wait for 10 seconds, as long as possible, for the request to complete return future.get(10_000L, TimeUnit.MILLISECONDS); } @Override public CompletableFuture\u003cResponse\u003e writeAsync(WriteRequest request) { // raftServer æäº¤è¯·æ±‚ return raftServer.commit(request.getGroup(), request, new CompletableFuture\u003c\u003e()); } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#commit // raftServer æäº¤è¯·æ±‚ public CompletableFuture\u003cResponse\u003e commit(final String group, final Message data, final CompletableFuture\u003cResponse\u003e future) { LoggerUtils.printIfDebugEnabled(Loggers.RAFT, \"data requested this time : {}\", data); // é€šè¿‡ group æ‰¾åˆ°å¯¹åº”çš„ raft é…ç½® final RaftGroupTuple tuple = findTupleByGroup(group); if (tuple == null) { future.completeExceptionally(new IllegalArgumentException(\"No corresponding Raft Group found : \" + group)); return future; } // åŒ…è£… future å›è°ƒå‡½æ•° FailoverClosureImpl closure = new FailoverClosureImpl(future); final Node node = tuple.node; if (node.isLeader()) { // The leader node directly applies this request // å¦‚æœæ˜¯ leaderï¼Œç›´æ¥ apply è¯·æ±‚ applyOperation(node, data, closure); } else { // Forward to Leader for request processing // å¦‚æœä¸æ˜¯ leaderï¼ŒæŠŠè¯·æ±‚è½¬å‘ç»™ leaderï¼Œåé¢ leader ç»§ç»­ apply è¯·æ±‚ invokeToLeader(group, data, rpcRequestTimeoutMs, closure); } return future; } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#applyOperation // leader èŠ‚ç‚¹ apply è¯·æ±‚ public void applyOperation(Node node, Message data, FailoverClosure closure) { final Task task = new Task(); // è®¾ç½®å›è°ƒ task.setDone(new NacosClosure(data, status -\u003e { // æŠŠå“åº”è®¾ç½®ç»™ closure, closure å°±æ˜¯ FailoverClosureImpl NacosClosure.NacosStatus nacosStatus = (NacosClosure.NacosStatus) status; closure.setThrowable(nacosStatus.getThrowable()); closure.setResponse(nacosStatus.getResponse()); closure.run(nacosStatus); })); // add request type field at the head of task data. // å°è£…è¯·æ±‚ï¼ŒWriteRequest æˆ–è€… ReadRequest byte[] requestTypeFieldBytes = new byte[2]; requestTypeFieldBytes[0] = ProtoMessageUtil.REQUEST_TYPE_FIELD_TAG; if (data instanceof ReadRequest) { requestTypeFieldBytes[1] = ProtoMessageUtil.REQUEST_TYPE_READ; } else { requestTypeFieldBytes[1] = ProtoMessageUtil.REQUEST_TYPE_WRITE; } byte[] dataBytes = data.toByteArray(); // è®¾ç½®æ•°æ® task.setData((ByteBuffer) ByteBuffer.allocate(requestTypeFieldBytes.length + dataBytes.length) .put(requestTypeFieldBytes).put(dataBytes).position(0)); // apply è¯·æ±‚ï¼Œå†™å…¥ä¸»èŠ‚ç‚¹æ—¥å¿—ï¼Œå¤åˆ¶æ—¥å¿—åˆ°ä»èŠ‚ç‚¹ï¼Œè¶…è¿‡åŠæ•°èŠ‚ç‚¹æˆåŠŸï¼Œç„¶åæ‰§è¡ŒçŠ¶æ€æœº NacosStateMachine node.apply(task); } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.NacosStateMachine#onApply // æ‰§è¡ŒçŠ¶æ€æœº @Override public void onApply(Iterator iter) { int index = 0; ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" è½¬å‘è¯·æ±‚ç»™ leaderæºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#invokeToLeader // è½¬å‘è¯·æ±‚ç»™ leader private void invokeToLeader(final String group, final Message request, final int timeoutMillis, FailoverClosure closure) { try { final Endpoint leaderIp = Optional.ofNullable(getLeader(group)) .orElseThrow(() -\u003e new NoLeaderException(group)).getEndpoint(); // è°ƒç”¨ cliClientService æ¥è½¬å‘è¯·æ±‚ cliClientService.getRpcClient().invokeAsync(leaderIp, request, new InvokeCallback() { @Override public void complete(Object o, Throwable ex) { if (Objects.nonNull(ex)) { closure.setThrowable(ex); closure.run(new Status(RaftError.UNKNOWN, ex.getMessage())); return; } if (!((Response)o).getSuccess()) { closure.setThrowable(new IllegalStateException(((Response) o).getErrMsg())); closure.run(new Status(RaftError.UNKNOWN, ((Response) o).getErrMsg())); return; } closure.setResponse((Response) o); closure.run(Status.OK()); } @Override public Executor executor() { return RaftExecutor.getRaftCliServiceExecutor(); } }, timeoutMillis); } catch (Exception e) { closure.setThrowable(e); closure.run(new Status(RaftError.UNKNOWN, e.toString())); } } æºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.processor.NacosWriteRequestProcessor // æ¥å— WriteRequest public class NacosWriteRequestProcessor extends AbstractProcessor implements RpcProcessor\u003cWriteRequest\u003e { private static final String INTEREST_NAME = WriteRequest.class.getName(); private final JRaftServer server; public NacosWriteRequestProcessor(JRaftServer server, Serializer serializer) { super(serializer); this.server = server; } @Override public void handleRequest(RpcContext rpcCtx, WriteRequest request) { // å¤„ç†è¯·æ±‚ handleRequest(server, request.getGroup(), rpcCtx, request); } @Override public String interest() { return INTEREST_NAME; } } // å¤„ç†è¯·æ±‚ protected void handleRequest(final JRaftServer server, final String group, final RpcContext rpcCtx, Message message) { try { ... // å¦‚æœæ˜¯ leader èŠ‚ç‚¹ï¼Œå°±å¤„ç†è¯·æ±‚ï¼Œå¦åˆ™è¿”å›é”™è¯¯ if (tuple.getNode().isLeader()) { execute(server, rpcCtx, message, tuple); } else { rpcCtx.sendResponse( Response.newBuilder().setSuccess(false).setErrMsg(\"Could not find leader : \" + group).build()); } } catch (Throwable e) { Loggers.RAFT.error(\"handleRequest has error : \", e); rpcCtx.sendResponse(Response.newBuilder().setSuccess(false).setErrMsg(e.toString()).build()); } } // æ‰§è¡Œè¯·æ±‚ protected void execute(JRaftServer server, final RpcContext asyncCtx, final Message message, final JRaftServer.RaftGroupTuple tuple) { ... // apply è¯·æ±‚ï¼Œè¿™ä¸ªå’Œä¸Šé¢çš„é€»è¾‘ä¸€æ ·ï¼Œä¸ç»§ç»­åˆ†æäº† server.applyOperation(tuple.getNode(), message, closure); } ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:6:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" raft å¤„ç† ReadRequestæºç ä½ç½®: com.alibaba.nacos.core.distributed.raft.JRaftServer#get // raft å¤„ç† ReadRequest CompletableFuture\u003cResponse\u003e get(final ReadRequest request) { final String group = request.getGroup(); CompletableFuture\u003cResponse\u003e future = new CompletableFuture\u003c\u003e(); // æ£€æŸ¥ group æ˜¯å¦å­˜åœ¨ final RaftGroupTuple tuple = findTupleByGroup(group); if (Objects.isNull(tuple)) { future.completeExceptionally(new NoSuchRaftGroupException(group)); return future; } final Node node = tuple.node; final RequestProcessor processor = tuple.processor; try { // raft åè®®çš„ä¸€è‡´æ€§è¯»ï¼Œå¦‚æœè¿”å›æˆåŠŸï¼Œå¯ä»¥ç¡®ä¿æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œç›´æ¥æœ¬åœ°å¤„ç†å°±å¯ä»¥ node.readIndex(BytesUtil.EMPTY_BYTES, new ReadIndexClosure() { @Override public void run(Status status, long index, byte[] reqCtx) { if (status.isOk()) { try { Response response = processor.onRequest(request); future.complete(response); } catch (Throwable t) { MetricsMonitor.raftReadIndexFailed(); future.completeExceptionally(new ConsistencyException( \"The conformance protocol is temporarily unavailable for reading\", t)); } return; } // è¿”å›é”™è¯¯ï¼Œä» leader ä¸­è¯»å–æ•°æ® MetricsMonitor.raftReadIndexFailed(); Loggers.RAFT.error(\"ReadIndex has error : {}, go to Leader read.\", status.getErrorMsg()); MetricsMonitor.raftReadFromLeader(); readFromLeader(request, future); } }); return future; } catch (Throwable e) { MetricsMonitor.raftReadFromLeader(); Loggers.RAFT.warn(\"Raft linear read failed, go to Leader read logic : {}\", e.toString()); // run raft read readFromLeader(request, future); return future; } } // ä» leader ä¸­è¯»å–æ•°æ® public void readFromLeader(final ReadRequest request, final CompletableFuture\u003cResponse\u003e future) { commit(request.getGroup(), request, future); } // æäº¤è¯·æ±‚, è¿™ä¸ªæ–¹æ³•ä¸Šé¢å·²ç»è§£æè¿‡äº† public CompletableFuture\u003cResponse\u003e commit(final String group, final Message data, final CompletableFuture\u003cResponse\u003e future) { LoggerUtils.printIfDebugEnabled(Loggers.RAFT, \"data requested this time : {}\", data); final RaftGroupTuple tuple = findTupleByGroup(group); if (tuple == null) { future.completeExceptionally(new IllegalArgumentException(\"No corresponding Raft Group found : \" + group)); return future; } FailoverClosureImpl closure = new FailoverClosureImpl(future); final Node node = tuple.node; if (node.isLeader()) { // The leader node directly applies this request applyOperation(node, data, closure); } else { // Forward to Leader for request processing invokeToLeader(group, data, rpcRequestTimeoutMs, closure); } return future; } ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:7:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" nacos ä¸­çš„ raft ç”¨æ³• com.alibaba.nacos.naming.core.v2.service.impl.PersistentClientOperationServiceImpl: å®¢æˆ·ç«¯æ³¨å†Œå®ä¾‹ com.alibaba.nacos.naming.consistency.persistent.impl.PersistentServiceProcessor: naming æ¨¡å—ï¼Œé…ç½®ç®¡ç† com.alibaba.nacos.config.server.service.repository.embedded.DistributedDatabaseOperateImpl: å†…åµŒæ•°æ®åº“ ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:8:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_false ","date":"2023-09-06","objectID":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/:9:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"14 CP åè®® Raft","uri":"/ooooo-notes/14-cp-%E5%8D%8F%E8%AE%AE-raft/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ åœ¨ nacos ä¸­ï¼Œé›†ç¾¤æˆå‘˜åˆ†ä¸ºé™æ€åŠ è½½å’ŒåŠ¨æ€åŠ è½½ï¼Œé™æ€åŠ è½½å°±æ˜¯è¯»å– cluster.conf æ–‡ä»¶ï¼ŒåŠ¨æ€åŠ è½½å°±æ˜¯ä»ä¸€ä¸ªæ¥å£ä¸­è·å–ã€‚ ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" é›†ç¾¤æˆå‘˜åŠ è½½çš„å…¥å£æºç ä½ç½®: com.alibaba.nacos.core.cluster.ServerMemberManager#initAndStartLookup private void initAndStartLookup() throws NacosException { // æŸ¥æ‰¾å¯¹åº”çš„ lookup, lookup çš„å®ç°æœ‰ file, standalone, address this.lookup = LookupFactory.createLookUp(this); // æ˜¯å¦ä½¿ç”¨ address lookup isUseAddressServer = this.lookup.useAddressServer(); // å¯åŠ¨ lookup this.lookup.start(); } æºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.LookupFactory#createLookUp // æŸ¥æ‰¾å¯¹åº”çš„ lookup public static MemberLookup createLookUp(ServerMemberManager memberManager) throws NacosException { // ä¸æ˜¯ standalone æ¨¡å¼ if (!EnvUtil.getStandaloneMode()) { // lookupType é»˜è®¤ä¸ºç©º String lookupType = EnvUtil.getProperty(LOOKUP_MODE_TYPE); // æ ¹æ® lookupType æ¥é€‰æ‹© LookupType type = chooseLookup(lookupType); LOOK_UP = find(type); currentLookupType = type; } else { // standalone lookup LOOK_UP = new StandaloneMemberLookup(); } // æ³¨å…¥ memberManager LOOK_UP.injectMemberManager(memberManager); Loggers.CLUSTER.info(\"Current addressing mode selection : {}\", LOOK_UP.getClass().getSimpleName()); return LOOK_UP; } æºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.LookupFactory#chooseLookup // æ ¹æ® lookupType æ¥é€‰æ‹© private static LookupType chooseLookup(String lookupType) { // lookupType ä¸ä¸ºç©ºï¼Œåˆ™è¿”å› if (StringUtils.isNotBlank(lookupType)) { LookupType type = LookupType.sourceOf(lookupType); if (Objects.nonNull(type)) { return type; } } // åˆ¤æ–­ cluster.conf æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±æ˜¯ file lookup File file = new File(EnvUtil.getClusterConfFilePath()); if (file.exists() || StringUtils.isNotBlank(EnvUtil.getMemberList())) { return LookupType.FILE_CONFIG; } // é»˜è®¤è¿”å› address lookup return LookupType.ADDRESS_SERVER; } ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" standalone lookupæºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.StandaloneMemberLookup // è¿™ä¸ªç±»ï¼Œå°±æ˜¯æ·»åŠ äº†è‡ªå·±çš„ url public class StandaloneMemberLookup extends AbstractMemberLookup { @Override public void doStart() { String url = EnvUtil.getLocalAddress(); // å‘å¸ƒ MembersChangeEvent äº‹ä»¶ afterLookup(MemberUtil.readServerConf(Collections.singletonList(url))); } @Override protected void doDestroy() throws NacosException { } @Override public boolean useAddressServer() { return false; } } ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" file lookupæºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.FileConfigMemberLookup#doStart @Override public void doStart() throws NacosException { // è¯»å–æ–‡ä»¶, ç„¶åå‘å¸ƒ MembersChangeEvent äº‹ä»¶ readClusterConfFromDisk(); // Use the inotify mechanism to monitor file changes and automatically // trigger the reading of cluster.conf try { // åŠ¨æ€ç›‘å¬é…ç½®æ–‡ä»¶ WatchFileCenter.registerWatcher(EnvUtil.getConfPath(), watcher); } catch (Throwable e) { Loggers.CLUSTER.error(\"An exception occurred in the launch file monitor : {}\", e.getMessage()); } } // ç›‘å¬å™¨ï¼Œä¼šç›‘å¬ cluster.conf æ–‡ä»¶ï¼Œå¦‚æœå˜åŠ¨ï¼Œå°±é‡æ–°è¯»å–æ–‡ä»¶ private FileWatcher watcher = new FileWatcher() { @Override public void onChange(FileChangeEvent event) { readClusterConfFromDisk(); } @Override public boolean interest(String context) { return StringUtils.contains(context, DEFAULT_SEARCH_SEQ); } }; ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" address lookupæºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.AddressServerMemberLookup#doStart @Override public void doStart() throws NacosException { // æœ€å¤§çš„æ˜¯å¤±è´¥ä¸ªæ•° this.maxFailCount = Integer.parseInt(EnvUtil.getProperty(HEALTH_CHECK_FAIL_COUNT_PROPERTY, DEFAULT_HEALTH_CHECK_FAIL_COUNT)); // åˆå§‹åŒ–å‘ç°åœ°å€ initAddressSys(); // è¿è¡Œï¼Œè·å–åœ°å€ run(); } æºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.AddressServerMemberLookup#initAddressSys // åˆå§‹åŒ–å‘ç°åœ°å€ // è·å–åŸŸåï¼Œç«¯å£ï¼Œç„¶åæ‹¼è£…ä¸ºåœ°å€ private void initAddressSys() { String envDomainName = System.getenv(ADDRESS_SERVER_DOMAIN_ENV); if (StringUtils.isBlank(envDomainName)) { domainName = EnvUtil.getProperty(ADDRESS_SERVER_DOMAIN_PROPERTY, DEFAULT_SERVER_DOMAIN); } else { domainName = envDomainName; } String envAddressPort = System.getenv(ADDRESS_SERVER_PORT_ENV); if (StringUtils.isBlank(envAddressPort)) { addressPort = EnvUtil.getProperty(ADDRESS_SERVER_PORT_PROPERTY, DEFAULT_SERVER_POINT); } else { addressPort = envAddressPort; } String envAddressUrl = System.getenv(ADDRESS_SERVER_URL_ENV); if (StringUtils.isBlank(envAddressUrl)) { addressUrl = EnvUtil.getProperty(ADDRESS_SERVER_URL_PROPERTY, EnvUtil.getContextPath() + \"/\" + \"serverlist\"); } else { addressUrl = envAddressUrl; } addressServerUrl = HTTP_PREFIX + domainName + \":\" + addressPort + addressUrl; envIdUrl = HTTP_PREFIX + domainName + \":\" + addressPort + \"/env\"; Loggers.CORE.info(\"ServerListService address-server port:\" + addressPort); Loggers.CORE.info(\"ADDRESS_SERVER_URL:\" + addressServerUrl); } æºç ä½ç½®: com.alibaba.nacos.core.cluster.lookup.AddressServerMemberLookup#run // è¿è¡Œï¼Œè·å–åœ°å€ private void run() throws NacosException { // With the address server, you need to perform a synchronous member node pull at startup // Repeat three times, successfully jump out boolean success = false; Throwable ex = null; int maxRetry = EnvUtil.getProperty(ADDRESS_SERVER_RETRY_PROPERTY, Integer.class, DEFAULT_SERVER_RETRY_TIME); // é‡è¯•æ¬¡æ•° for (int i = 0; i \u003c maxRetry; i++) { try { // è·å–é›†ç¾¤æˆå‘˜åœ°å€, å‘å¸ƒ MembersChangeEvent äº‹ä»¶ syncFromAddressUrl(); success = true; break; } catch (Throwable e) { ex = e; Loggers.CLUSTER.error(\"[serverlist] exception, error : {}\", ExceptionUtil.getAllExceptionMsg(ex)); } } if (!success) { throw new NacosException(NacosException.SERVER_ERROR, ex); } // å®šæ—¶è°ƒç”¨ GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), DEFAULT_SYNC_TASK_DELAY_MS); } ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.core.cluster.MemberLookup_ITCase#test_a_lookup_file_config com.alibaba.nacos.test.core.cluster.MemberLookup_ITCase#test_c_lookup_address_server ","date":"2023-09-05","objectID":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"13 é›†ç¾¤æˆå‘˜ç®¡ç†","uri":"/ooooo-notes/13-%E9%9B%86%E7%BE%A4%E6%88%90%E5%91%98%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ nacos å¯¹äºä¸´æ—¶å®ä¾‹æ³¨å†Œï¼Œé‡‡ç”¨çš„æ˜¯ AP åè®®ï¼Œæˆ‘ä»¬çœ‹çœ‹æ˜¯æ€ä¹ˆè®¾è®¡çš„ã€‚ ","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" DistroProtocol åˆå§‹åŒ–æºç ä½ç½®: com.alibaba.nacos.core.distributed.distro.DistroProtocol#DistroProtocol // DistroProtocol æ„é€ å‡½æ•° public DistroProtocol(ServerMemberManager memberManager, DistroComponentHolder distroComponentHolder, DistroTaskEngineHolder distroTaskEngineHolder) { this.memberManager = memberManager; this.distroComponentHolder = distroComponentHolder; this.distroTaskEngineHolder = distroTaskEngineHolder; // å¼€å§‹å®šæ—¶ä»»åŠ¡ startDistroTask(); } // å¼€å§‹å®šæ—¶ä»»åŠ¡ private void startDistroTask() { // standalone è¡¨ç¤ºå•ä¸ªèŠ‚ç‚¹ï¼Œä¸ç”¨å¼€å¯å®šæ—¶ä»»åŠ¡ if (EnvUtil.getStandaloneMode()) { isInitialized = true; return; } // å®šæ—¶ä»»åŠ¡ï¼ŒåŒæ­¥å½“å‰èŠ‚ç‚¹çš„æ•°æ®ç»™å…¶ä»–èŠ‚ç‚¹, æœ€ç»ˆä¼šæ‰§è¡Œ DistroVerifyTimedTask startVerifyTask(); // å®šæ—¶ä»»åŠ¡ï¼Œä»å…¶ä»–èŠ‚ç‚¹åŠ è½½æ•°æ®ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ DistroLoadDataTask startLoadTask(); } ","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" DistroVerifyTimedTask åŒæ­¥èŠ‚ç‚¹æ•°æ®æ¥ç»­çº¦DistroVerifyTimedTask æºç ä½ç½®: com.alibaba.nacos.core.distributed.distro.task.verify.DistroVerifyTimedTask // åŒæ­¥å½“å‰èŠ‚ç‚¹çš„æ•°æ®ç»™å…¶ä»–èŠ‚ç‚¹, è¿™ä¸ªç±»å¾ˆé‡è¦ // åœ¨ distro åè®®ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªä¼šå¤„ç†éƒ¨åˆ†æ•°æ®, æ•°æ®çš„ç‰ˆæœ¬è¦é€šè¿‡å®šæ—¶ä»»åŠ¡æ¥å‘é€ç»™å…¶ä»–èŠ‚ç‚¹è¿›è¡Œç»­çº¦ï¼Œ // å¦åˆ™ client ä¸‹ä¸€æ¬¡è¯·æ±‚åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå› ä¸ºæ•°æ®æ²¡æœ‰å®šæ—¶ç»­çº¦ï¼Œä¼šå¯¼è‡´è¿™ä¸ªæ•°æ®ä¼šè¿‡æœŸåˆ é™¤. public class DistroVerifyTimedTask implements Runnable { ... @Override public void run() { try { // è·å–å…¶ä»–èŠ‚ç‚¹åˆ—è¡¨ List\u003cMember\u003e targetServer = serverMemberManager.allMembersWithoutSelf(); if (Loggers.DISTRO.isDebugEnabled()) { Loggers.DISTRO.debug(\"server list is: {}\", targetServer); } // æ ¹æ® type æ¥åŒæ­¥æ•°æ® for (String each : distroComponentHolder.getDataStorageTypes()) { verifyForDataStorage(each, targetServer); } } catch (Exception e) { Loggers.DISTRO.error(\"[DISTRO-FAILED] verify task failed.\", e); } } private void verifyForDataStorage(String type, List\u003cMember\u003e targetServer) { // DistroDataStorage æ•°æ®å­˜å‚¨ï¼Œç›®å‰åªæœ‰ä¸€ä¸ªå®ç°ç±» DistroClientDataProcessor DistroDataStorage dataStorage = distroComponentHolder.findDataStorage(type); if (!dataStorage.isFinishInitial()) { Loggers.DISTRO.warn(\"data storage {} has not finished initial step, do not send verify data\", dataStorage.getClass().getSimpleName()); return; } // è·å–å½“å‰èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¾ˆé‡è¦ List\u003cDistroData\u003e verifyData = dataStorage.getVerifyData(); if (null == verifyData || verifyData.isEmpty()) { return; } // åŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹ for (Member member : targetServer) { DistroTransportAgent agent = distroComponentHolder.findTransportAgent(type); if (null == agent) { continue; } // åŒæ­¥æ•°æ®, æ‰§è¡Œ DistroVerifyExecuteTask executeTaskExecuteEngine.addTask(member.getAddress() + type, new DistroVerifyExecuteTask(agent, verifyData, member.getAddress(), type)); } } } æºç ä½ç½®: com.alibaba.nacos.naming.consistency.ephemeral.distro.v2.DistroClientDataProcessor#getVerifyData // è·å–å½“å‰èŠ‚ç‚¹çš„æ•°æ® public List\u003cDistroData\u003e getVerifyData() { List\u003cDistroData\u003e result = null; for (String each : clientManager.allClientId()) { Client client = clientManager.getClient(each); if (null == client || !client.isEphemeral()) { continue; } // æ˜¯å½“å‰èŠ‚ç‚¹çš„æ•°æ® if (clientManager.isResponsibleClient(client)) { // clientId å’Œ reversion æ¥æ ¡éªŒæ•°æ®ï¼Œå¹¶è¿›è¡Œç»­çº¦ DistroClientVerifyInfo verifyData = new DistroClientVerifyInfo(client.getClientId(), client.getRevision()); DistroKey distroKey = new DistroKey(client.getClientId(), TYPE); DistroData data = new DistroData(distroKey, ApplicationUtils.getBean(Serializer.class).serialize(verifyData)); data.setType(DataOperation.VERIFY); if (result == null) { result = new LinkedList\u003c\u003e(); } result.add(data); } } return result; } æºç ä½ç½®: com.alibaba.nacos.core.distributed.distro.task.verify.DistroVerifyExecuteTask#run // åŒæ­¥æ•°æ® // æ•°æ®ä¼šåŒ…è£…ä¸º DistroDataRequest, ä¼šè¢« DistroDataRequestHandler å¤„ç† @Override public void run() { for (DistroData each : verifyData) { try { if (transportAgent.supportCallbackTransport()) { doSyncVerifyDataWithCallback(each); } else { doSyncVerifyData(each); } } catch (Exception e) { Loggers.DISTRO .error(\"[DISTRO-FAILED] verify data for type {} to {} failed.\", resourceType, targetServer, e); } } } æºç ä½ç½®: com.alibaba.nacos.naming.remote.rpc.handler.DistroDataRequestHandler#handle // DistroDataRequestHandler å¤„ç† DistroDataRequest // è¿™äº›æ–¹æ³•éƒ½æ˜¯å§”æ‰˜ DistroProtocol ç±»æ¥å®Œæˆå…·ä½“çš„è°ƒç”¨ @Override public DistroDataResponse handle(DistroDataRequest request, RequestMeta meta) throws NacosException { try { switch (request.getDataOperation()) { case VERIFY: return handleVerify(request.getDistroData(), meta); case SNAPSHOT: return handleSnapshot(); case ADD: case CHANGE: case DELETE: return handleSyncData(request.getDistroData()); case QUERY: return handleQueryData(request.getDistroData()); default: return new DistroDataResponse(); } } catch (Exception e) { Loggers.DISTRO.error(\"[DISTRO-FAILED] distro handle with exception\", e); DistroDataResponse result = new DistroDataResponse(); result.setErrorCode(ResponseCode.FAIL.getCode()); result.setMessage(\"handle distro request with exception\"); return result; } } // å¤„ç† VERIFY è¯·æ±‚ private DistroDataResponse handleVerify(DistroData distroData, RequestMeta meta) { DistroDataResponse re","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" DistroLoadDataTask åŠ è½½æ•°æ®æºç ä½ç½®: com.alibaba.nacos.core.distributed.distro.task.load.DistroLoadDataTask#run @Override public void run() { try { load(); if (!checkCompleted()) { GlobalExecutor.submitLoadDataTask(this, distroConfig.getLoadDataRetryDelayMillis()); } else { loadCallback.onSuccess(); Loggers.DISTRO.info(\"[DISTRO-INIT] load snapshot data success\"); } } catch (Exception e) { loadCallback.onFailed(e); Loggers.DISTRO.error(\"[DISTRO-INIT] load snapshot data failed. \", e); } } // åŠ è½½èŠ‚ç‚¹æ•°æ® private void load() throws Exception { // æ£€æŸ¥èŠ‚ç‚¹åˆ—è¡¨ while (memberManager.allMembersWithoutSelf().isEmpty()) { Loggers.DISTRO.info(\"[DISTRO-INIT] waiting server list init...\"); TimeUnit.SECONDS.sleep(1); } while (distroComponentHolder.getDataStorageTypes().isEmpty()) { Loggers.DISTRO.info(\"[DISTRO-INIT] waiting distro data storage register...\"); TimeUnit.SECONDS.sleep(1); } // ä»è¿œç«¯åŠ è½½å¿«ç…§æ•°æ®, ç”¨äºæœåŠ¡å¿«é€Ÿå¯åŠ¨ for (String each : distroComponentHolder.getDataStorageTypes()) { if (!loadCompletedMap.containsKey(each) || !loadCompletedMap.get(each)) { loadCompletedMap.put(each, loadAllDataSnapshotFromRemote(each)); } } } ","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" DistroFilter æ‹¦æˆªè¯·æ±‚æºç ä½ç½®: com.alibaba.nacos.naming.web.DistroFilter#doFilter // DistroFilter ä¼šæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { ReuseHttpServletRequest req = new ReuseHttpServletRequest((HttpServletRequest) servletRequest); HttpServletResponse resp = (HttpServletResponse) servletResponse; String urlString = req.getRequestURI(); if (StringUtils.isNotBlank(req.getQueryString())) { urlString += \"?\" + req.getQueryString(); } try { // è·å–è¯·æ±‚å¯¹åº”çš„æ–¹æ³• Method method = controllerMethodsCache.getMethod(req); String path = new URI(req.getRequestURI()).getPath(); if (method == null) { throw new NoSuchMethodException(req.getMethod() + \" \" + path); } // æ–¹æ³•æ˜¯å¦æœ‰ @CanDistro æ³¨è§£ï¼Œæ²¡æœ‰å°±ç›´æ¥æ”¾è¡Œï¼Œä¸å¤„ç† if (!method.isAnnotationPresent(CanDistro.class)) { filterChain.doFilter(req, resp); return; } // è·å–è¯·æ±‚å‚æ•°ä¸­çš„ ip å’Œ port String distroTag = distroTagGenerator.getResponsibleTag(req); // å½“å‰èŠ‚ç‚¹æ˜¯å¦å“åº”è¯¥è¯·æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥æ”¾è¡Œï¼Œè¿™ä¸ªå¾ˆé‡è¦, åé¢ç»§ç»­è§£æ if (distroMapper.responsible(distroTag)) { filterChain.doFilter(req, resp); return; } // proxy request to other server if necessary: String userAgent = req.getHeader(HttpHeaderConsts.USER_AGENT_HEADER); // åˆ¤æ–­å¿…é¡»æ˜¯ client çš„è¯·æ±‚ï¼Œä¸èƒ½æ˜¯ server ä¹‹é—´çš„è¯·æ±‚ if (StringUtils.isNotBlank(userAgent) \u0026\u0026 userAgent.contains(UtilsAndCommons.NACOS_SERVER_HEADER)) { // This request is sent from peer server, should not be redirected again: Loggers.SRV_LOG.error(\"receive invalid redirect request from peer {}\", req.getRemoteAddr()); resp.sendError(HttpServletResponse.SC_BAD_REQUEST, \"receive invalid redirect request from peer \" + req.getRemoteAddr()); return; } // è·å–è½¬å‘èŠ‚ç‚¹, æ ¹æ® ip:port çš„ hash å€¼å¯¹ serverList.size() å–ä½™æ¥è®¡ç®— final String targetServer = distroMapper.mapSrv(distroTag); List\u003cString\u003e headerList = new ArrayList\u003c\u003e(16); Enumeration\u003cString\u003e headers = req.getHeaderNames(); while (headers.hasMoreElements()) { String headerName = headers.nextElement(); headerList.add(headerName); headerList.add(req.getHeader(headerName)); } final String body = IoUtils.toString(req.getInputStream(), StandardCharsets.UTF_8.name()); final Map\u003cString, String\u003e paramsValue = HttpClient.translateParameterMap(req.getParameterMap()); // ç”¨ HttpClient æ¥è½¬å‘è¯·æ±‚åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Š RestResult\u003cString\u003e result = HttpClient .request(HTTP_PREFIX + targetServer + req.getRequestURI(), headerList, paramsValue, body, PROXY_CONNECT_TIMEOUT, PROXY_READ_TIMEOUT, StandardCharsets.UTF_8.name(), req.getMethod()); String data = result.ok() ? result.getData() : result.getMessage(); try { // å“åº”å®¢æˆ·ç«¯è¯·æ±‚ WebUtils.response(resp, data, result.getCode()); } catch (Exception ignore) { Loggers.SRV_LOG.warn(\"[DISTRO-FILTER] request failed: \" + distroMapper.mapSrv(distroTag) + urlString); } } catch (AccessControlException e) { resp.sendError(HttpServletResponse.SC_FORBIDDEN, \"access denied: \" + ExceptionUtil.getAllExceptionMsg(e)); } catch (NoSuchMethodException e) { resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, \"no such api:\" + req.getMethod() + \":\" + req.getRequestURI()); } catch (Exception e) { Loggers.SRV_LOG.warn(\"[DISTRO-FILTER] Server failed: \", e); resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, \"Server failed, \" + ExceptionUtil.getAllExceptionMsg(e)); } } æºç ä½ç½®: com.alibaba.nacos.naming.core.DistroMapper#responsible // å½“å‰èŠ‚ç‚¹æ˜¯å¦å“åº”è¯¥è¯·æ±‚ public boolean responsible(String responsibleTag) { final List\u003cString\u003e servers = healthyList; if (!switchDomain.isDistroEnabled() || EnvUtil.getStandaloneMode()) { return true; } if (CollectionUtils.isEmpty(servers)) { // means distro config is not ready yet return false; } // å½“å‰èŠ‚ç‚¹åœ°å€æ‰¾ä¸åˆ°ï¼Œä¸è½¬å‘è¯·æ±‚ String localAddress = EnvUtil.getLocalAddress(); int index = servers.indexOf(localAddress); int lastIndex = servers.lastIndexOf(localAddress); if (lastIndex \u003c 0 || index \u003c 0) { return true; } // è·å– hash å€¼ï¼Œç„¶åå–ä½™ int target = distroHash(responsibleTag) % servers.size(); return target \u003e= index \u0026\u0026 target \u003c= lastIndex; } ","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-29","objectID":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"12 AP åè®® Distro","uri":"/ooooo-notes/12-ap-%E5%8D%8F%E8%AE%AE-distro/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ nacos åŸºäº grpc çš„é•¿è¿æ¥æ¥å®ç° client å’Œ server çš„é€šä¿¡ã€‚ åœ¨æœ‰å¤šä¸ª server ç«¯æ—¶ï¼Œæœ€åˆå¼€å§‹ client çš„è¿æ¥ä¼šå‡åŒ€åˆ†å¸ƒåœ¨ server ç«¯ï¼Œå½“é‡æ–°ä¸Šçº¿ server æ—¶ï¼Œè¿™æ—¶å€™ client çš„è¿æ¥ä¼šåç§»åˆ°å…¶ä»– server ç«¯ï¼Œè¿™æ ·ä¼šé€ æˆ server ç«¯è¯·æ±‚è´Ÿè½½ä¸å‡åŒ€ã€‚ connection ","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" client å‘èµ·è¿æ¥æºç ä½ç½®: com.alibaba.nacos.common.remote.client.grpc.GrpcClient#connectToServer // GrpcClient å‘é€ ConnectionSetupRequest è¯·æ±‚ï¼Œå»ºç«‹è¿æ¥ @Override public Connection connectToServer(ServerInfo serverInfo) { try { ... int port = serverInfo.getServerPort() + rpcPortOffset(); ManagedChannel managedChannel = createNewManagedChannel(serverInfo.getServerIp(), port); RequestGrpc.RequestFutureStub newChannelStubTemp = createNewChannelStub(managedChannel); if (newChannelStubTemp != null) { // æ£€æŸ¥è¿æ¥ Response response = serverCheck(serverInfo.getServerIp(), port, newChannelStubTemp); if (response == null || !(response instanceof ServerCheckResponse)) { shuntDownChannel(managedChannel); return null; } BiRequestStreamGrpc.BiRequestStreamStub biRequestStreamStub = BiRequestStreamGrpc.newStub( newChannelStubTemp.getChannel()); GrpcConnection grpcConn = new GrpcConnection(serverInfo, grpcExecutor); grpcConn.setConnectionId(((ServerCheckResponse) response).getConnectionId()); //create stream request and bind connection event to this connection. StreamObserver\u003cPayload\u003e payloadStreamObserver = bindRequestStream(biRequestStreamStub, grpcConn); // stream observer to send response to server grpcConn.setPayloadStreamObserver(payloadStreamObserver); grpcConn.setGrpcFutureServiceStub(newChannelStubTemp); grpcConn.setChannel(managedChannel); //send a setup request. // å‘é€ ConnectionSetupRequest è¯·æ±‚ï¼Œå»ºç«‹è¿æ¥ ConnectionSetupRequest conSetupRequest = new ConnectionSetupRequest(); ... grpcConn.sendRequest(conSetupRequest); //wait to register connection setup Thread.sleep(100L); return grpcConn; } return null; } catch (Exception e) { LOGGER.error(\"[{}]Fail to connect to server!,error={}\", GrpcClient.this.getName(), e); } return null; } ","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" server æ¥å—è¿æ¥æºç ä½ç½®: com.alibaba.nacos.core.remote.grpc.GrpcBiStreamRequestAcceptor#requestBiStream // GrpcBiStreamRequestAcceptor å¤„ç† client è¯·æ±‚ @Override public void onNext(Payload payload) { ... // å¤„ç† ConnectionSetupRequest è¯·æ±‚ if (parseObj instanceof ConnectionSetupRequest) { ConnectionSetupRequest setUpRequest = (ConnectionSetupRequest) parseObj; Map\u003cString, String\u003e labels = setUpRequest.getLabels(); String appName = \"-\"; if (labels != null \u0026\u0026 labels.containsKey(Constants.APPNAME)) { appName = labels.get(Constants.APPNAME); } ConnectionMeta metaInfo = new ConnectionMeta(connectionId, payload.getMetadata().getClientIp(), remoteIp, remotePort, localPort, ConnectionType.GRPC.getType(), setUpRequest.getClientVersion(), appName, setUpRequest.getLabels()); metaInfo.setTenant(setUpRequest.getTenant()); Connection connection = new GrpcConnection(metaInfo, responseObserver, GrpcServerConstants.CONTEXT_KEY_CHANNEL.get()); connection.setAbilities(setUpRequest.getAbilities()); boolean rejectSdkOnStarting = metaInfo.isSdkSource() \u0026\u0026 !ApplicationUtils.isStarted(); // æ³¨å†Œ connectionId å’Œ connection if (rejectSdkOnStarting || !connectionManager.register(connectionId, connection)) { //Not register to the connection manager if current server is over limit or server is starting. try { Loggers.REMOTE_DIGEST.warn(\"[{}]Connection register fail,reason:{}\", connectionId, rejectSdkOnStarting ? \" server is not started\" : \" server is over limited.\"); connection.request(new ConnectResetRequest(), 3000L); connection.close(); } catch (Exception e) { //Do nothing. if (connectionManager.traced(clientIp)) { Loggers.REMOTE_DIGEST .warn(\"[{}]Send connect reset request error,error={}\", connectionId, e); } } } ... } } æºç ä½ç½®: com.alibaba.nacos.core.remote.ConnectionManager#register // æ³¨å†Œ connectionId å’Œ connection public synchronized boolean register(String connectionId, Connection connection) { // åˆ¤æ–­æ˜¯å¦è¿æ¥ if (connection.isConnected()) { String clientIp = connection.getMetaInfo().clientIp; if (connections.containsKey(connectionId)) { return true; } if (checkLimit(connection)) { return false; } if (traced(clientIp)) { connection.setTraced(true); } // æ·»åŠ  connection connections.put(connectionId, connection); if (!connectionForClientIp.containsKey(clientIp)) { connectionForClientIp.put(clientIp, new AtomicInteger(0)); } // è®¡ç®— clientIp çš„è¿æ¥æ•°ï¼Œè¿™ä¸ªæ•°å€¼å¯ä»¥ä¾›æˆ‘ä»¬åˆ¤æ–­ æ˜¯å¦éœ€è¦ reloadClient (åé¢ä¼šä»‹ç»è¿™ä¸ª http è¯·æ±‚) connectionForClientIp.get(clientIp).getAndIncrement(); // connection å›è°ƒå‡½æ•° clientConnectionEventListenerRegistry.notifyClientConnected(connection); LOGGER.info(\"new connection registered successfully, connectionId = {},connection={} \", connectionId, connection); return true; } return false; } æºç ä½ç½®: com.alibaba.nacos.core.remote.ClientConnectionEventListenerRegistry#notifyClientConnected // ClientConnectionEventListenerRegistry é€šè¿‡ registerClientConnectionEventListener æ–¹æ³•æ¥æ³¨å†Œ // ClientConnectionEventListener çš„å®ç°ç±»æœ‰ ConnectionBasedClientManager å’Œ RpcAckCallbackInitorOrCleaner, å®ƒä»¬éƒ½åœ¨çˆ¶ç±»ä¸­æ³¨å†Œäº† // connection å›è°ƒå‡½æ•° public void notifyClientConnected(final Connection connection) { for (ClientConnectionEventListener clientConnectionEventListener : clientConnectionEventListeners) { try { clientConnectionEventListener.clientConnected(connection); } catch (Throwable throwable) { Loggers.REMOTE .info(\"[NotifyClientConnected] failed for listener {}\", clientConnectionEventListener.getName(), throwable); } } } // connection å›è°ƒå‡½æ•° public void notifyClientDisConnected(final Connection connection) { for (ClientConnectionEventListener clientConnectionEventListener : clientConnectionEventListeners) { try { clientConnectionEventListener.clientDisConnected(connection); } catch (Throwable throwable) { Loggers.REMOTE.info(\"[NotifyClientDisConnected] failed for listener {}\", clientConnectionEventListener.getName(), throwable); } } } // æ³¨å†Œ listener public void registerClientConnectionEventListener(ClientConnectionEventListener listener) { Loggers.REMOTE.info(\"[ClientConnectionEventListenerRegistry] registry listener - \" + liste","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" reloadClient é‡ç½®è¿æ¥æºç ä½ç½®: com.alibaba.nacos.core.controller.ServerLoaderController#reloadSingle @Secured(resource = Commons.NACOS_CORE_CONTEXT_V2 + \"/loader\", action = ActionTypes.WRITE) @GetMapping(\"/reloadClient\") public ResponseEntity\u003cString\u003e reloadSingle(@RequestParam String connectionId, @RequestParam(value = \"redirectAddress\", required = false) String redirectAddress) { // å‘é€ ConnectResetRequest è¯·æ±‚ï¼Œé‡ç½®å®¢æˆ·ç«¯ connectionManager.loadSingle(connectionId, redirectAddress); return ResponseEntity.ok().body(\"success\"); } æºç ä½ç½®: com.alibaba.nacos.core.remote.ConnectionManager#loadSingle // å‘é€ ConnectResetRequest è¯·æ±‚ï¼Œé‡ç½®å®¢æˆ·ç«¯ public void loadSingle(String connectionId, String redirectAddress) { Connection connection = getConnection(connectionId); if (connection != null) { // isSdkSource è¡¨ç¤ºæ˜¯ nacos å®¢æˆ·ç«¯ if (connection.getMetaInfo().isSdkSource()) { ConnectResetRequest connectResetRequest = new ConnectResetRequest(); if (StringUtils.isNotBlank(redirectAddress) \u0026\u0026 redirectAddress.contains(Constants.COLON)) { String[] split = redirectAddress.split(Constants.COLON); connectResetRequest.setServerIp(split[0]); connectResetRequest.setServerPort(split[1]); } try { // å‘é€ connectResetRequest è¯·æ±‚ç»™å®¢æˆ·ç«¯ï¼Œä¼šè¢« ConnectResetRequestHandler å¤„ç† connection.request(connectResetRequest, 3000L); } catch (ConnectionAlreadyClosedException e) { // å‘é€å¼‚å¸¸ï¼Œè¯´æ˜è¿™ä¸ªè¿æ¥å·²ç»æ–­å¼€äº†ï¼Œæ‰€ä»¥æ³¨é”€ connectionId unregister(connectionId); } catch (Exception e) { LOGGER.error(\"error occurs when expel connection, connectionId: {} \", connectionId, e); } } } } æºç ä½ç½®: com.alibaba.nacos.common.remote.client.RpcClient.ConnectResetRequestHandler // ConnectResetRequestHandler å¤„ç† ConnectResetRequest è¯·æ±‚ // åœ¨ RpcClient çš„ start æ–¹æ³•ä¸­æ·»åŠ äº† ServerRequestHandler class ConnectResetRequestHandler implements ServerRequestHandler { @Override public Response requestReply(Request request) { if (request instanceof ConnectResetRequest) { try { synchronized (RpcClient.this) { if (isRunning()) { ConnectResetRequest connectResetRequest = (ConnectResetRequest) request; if (StringUtils.isNotBlank(connectResetRequest.getServerIp())) { ServerInfo serverInfo = resolveServerInfo( connectResetRequest.getServerIp() + Constants.COLON + connectResetRequest.getServerPort()); // æŒ‡å®š serverInfo å˜æ¢ sever switchServerAsync(serverInfo, false); } else { // å˜æ¢ sever switchServerAsync(); } } } } catch (Exception e) { LoggerUtils.printIfErrorEnabled(LOGGER, \"[{}] Switch server error, {}\", rpcClientConfig.name(), e); } return new ConnectResetResponse(); } return null; } } ","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" server æ–­å¼€è¿æ¥æ£€æŸ¥æºç ä½ç½®: com.alibaba.nacos.core.remote.grpc.AddressTransportFilter#transportTerminated // AddressTransportFilter åœ¨ BaseGrpcServer çš„ startServer æ–¹æ³•ä¸­æ³¨å†Œ @Override public void transportTerminated(Attributes transportAttrs) { // è·å– connectionId String connectionId = null; try { connectionId = transportAttrs.get(ATTR_TRANS_KEY_CONN_ID); } catch (Exception e) { // Ignore } if (StringUtils.isNotBlank(connectionId)) { Loggers.REMOTE_DIGEST .info(\"Connection transportTerminated,connectionId = {} \", connectionId); // æ³¨é”€ connectionId, å›è°ƒ clientConnectionEventListener æ¥å£ connectionManager.unregister(connectionId); } } ","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.core.remote.ConnectionManagerTest#testLoadSingle ","date":"2023-08-28","objectID":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"11 è¿æ¥ç®¡ç†","uri":"/ooooo-notes/11-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ è¿™é‡Œçš„ client æ˜¯æŒ‡ nacos SDKï¼Œä¹Ÿå°±æ˜¯æ¨¡å— nacos-client. ","date":"2023-08-27","objectID":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"10 client è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" è®¢é˜…æœåŠ¡çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.client.naming.NacosNamingService#subscribe // NacosNamingService è®¢é˜…æœåŠ¡ @Override public void subscribe(String serviceName, String groupName, List\u003cString\u003e clusters, EventListener listener) throws NacosException { if (null == listener) { return; } String clusterString = StringUtils.join(clusters, \",\"); // ç›‘å¬æœåŠ¡æ”¹å˜çš„å›è°ƒå‡½æ•°ï¼ŒchangeNotifier è®¢é˜…äº† InstancesChangeEvent äº‹ä»¶ changeNotifier.registerListener(groupName, serviceName, clusterString, listener); // clientProxy çš„å®ç°ç±»ä¸º NamingClientProxyDelegate clientProxy.subscribe(serviceName, groupName, clusterString); } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate#subscribe // NamingClientProxyDelegate è®¢é˜…æœåŠ¡ @Override public ServiceInfo subscribe(String serviceName, String groupName, String clusters) throws NacosException { NAMING_LOGGER.info(\"[SUBSCRIBE-SERVICE] service:{}, group:{}, clusters:{} \", serviceName, groupName, clusters); String serviceNameWithGroup = NamingUtils.getGroupedName(serviceName, groupName); String serviceKey = ServiceInfo.getKey(serviceNameWithGroup, clusters); // æ³¨å†Œ UpdateTask, å‘é€ http è¯·æ±‚æ¥å…¨é‡æ›´æ–°, è¿™ä¸ªåé¢è¯´ serviceInfoUpdateService.scheduleUpdateIfAbsent(serviceName, groupName, clusters); ServiceInfo result = serviceInfoHolder.getServiceInfoMap().get(serviceKey); if (null == result || !isSubscribed(serviceName, groupName, clusters)) { // grpc è®¢é˜…æœåŠ¡, è¿”å› serviceInfo result = grpcClientProxy.subscribe(serviceName, groupName, clusters); } // å¤„ç† serviceInfo, å‘å¸ƒ InstancesChangeEvent äº‹ä»¶ serviceInfoHolder.processServiceInfo(result); return result; } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy#subscribe // grpc è®¢é˜…æœåŠ¡ @Override public ServiceInfo subscribe(String serviceName, String groupName, String clusters) throws NacosException { if (NAMING_LOGGER.isDebugEnabled()) { NAMING_LOGGER.debug(\"[GRPC-SUBSCRIBE] service:{}, group:{}, cluster:{} \", serviceName, groupName, clusters); } // æ ‡è®°æœåŠ¡è¦è®¢é˜…ï¼Œåœ¨ redoService çš„å®šæ—¶ä»»åŠ¡ä¸­é‡æ–°è®¢é˜… redoService.cacheSubscriberForRedo(serviceName, groupName, clusters); // è®¢é˜…æœåŠ¡ return doSubscribe(serviceName, groupName, clusters); } // redoService.cacheSubscriberForRedo public void cacheSubscriberForRedo(String serviceName, String groupName, String cluster) { String key = ServiceInfo.getKey(NamingUtils.getGroupedName(serviceName, groupName), cluster); SubscriberRedoData redoData = SubscriberRedoData.build(serviceName, groupName, cluster); synchronized (subscribes) { // æ ‡è®°è®¢é˜… subscribes.put(key, redoData); } } // è®¢é˜…æœåŠ¡ public ServiceInfo doSubscribe(String serviceName, String groupName, String clusters) throws NacosException { SubscribeServiceRequest request = new SubscribeServiceRequest(namespaceId, groupName, serviceName, clusters, true); // å‘é€ SubscribeServiceRequest è¯·æ±‚ï¼Œä¼šè¢« SubscribeServiceRequestHandler å¤„ç† SubscribeServiceResponse response = requestToServer(request, SubscribeServiceResponse.class); // æ ‡è®°æœåŠ¡å·²è®¢é˜… redoService.subscriberRegistered(serviceName, groupName, clusters); return response.getServiceInfo(); } æºç ä½ç½®: com.alibaba.nacos.naming.remote.rpc.handler.SubscribeServiceRequestHandler#handle // SubscribeServiceRequestHandler å¤„ç†è¯·æ±‚ @Override @Secured(action = ActionTypes.READ) public SubscribeServiceResponse handle(SubscribeServiceRequest request, RequestMeta meta) throws NacosException { String namespaceId = request.getNamespace(); String serviceName = request.getServiceName(); String groupName = request.getGroupName(); String app = request.getHeader(\"app\", \"unknown\"); String groupedServiceName = NamingUtils.getGroupedName(serviceName, groupName); Service service = Service.newService(namespaceId, groupName, serviceName, true); // æŠŠè®¢é˜…çš„ä¿¡æ¯åŒ…è£…ä¸º Subscriber å¯¹è±¡ Subscriber subscriber = new Subscriber(meta.getClientIp(), meta.getClientVersion(), app, meta.getClientIp(), namespaceId, groupedServiceName, 0, request.getClusters()); // ç¬¬ä¸€æ¬¡è®¢é˜…è¦è¿”å›å¯¹åº”çš„ serviceInfo ServiceInfo serviceInfo = ServiceUtil.selectInstancesWithHealthyProtection(serviceStorage.getData(service), metadataManager.getServiceMetadata(servic","date":"2023-08-27","objectID":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"10 client è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" grpc è®¢é˜…å¤„ç†æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy#start // start æ–¹æ³•åœ¨ NamingGrpcClientProxy æ„é€ å‡½æ•°ä¸­è°ƒç”¨ private void start(ServerListFactory serverListFactory, ServiceInfoHolder serviceInfoHolder) throws NacosException { // serverListFactory æ¥é€‰æ‹©æœåŠ¡ rpcClient.serverListFactory(serverListFactory); // ç›‘å¬ connectionEvent äº‹ä»¶ rpcClient.registerConnectionListener(redoService); // client å¤„ç† server è¯·æ±‚, é‡ç‚¹çœ‹ NamingPushRequestHandler rpcClient.registerServerRequestHandler(new NamingPushRequestHandler(serviceInfoHolder)); rpcClient.start(); // æ³¨å†Œäº‹ä»¶è®¢é˜… NotifyCenter.registerSubscriber(this); } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.NamingPushRequestHandler#requestReply // client å¤„ç† server è¯·æ±‚ @Override public Response requestReply(Request request) { if (request instanceof NotifySubscriberRequest) { // æœåŠ¡å®ä¾‹å˜åŠ¨äº†ï¼ŒæœåŠ¡ç«¯æ¨é€ serviceInfo NotifySubscriberRequest notifyRequest = (NotifySubscriberRequest) request; // å¤„ç† serviceInfo, å‘å¸ƒ InstancesChangeEvent äº‹ä»¶ serviceInfoHolder.processServiceInfo(notifyRequest.getServiceInfo()); return new NotifySubscriberResponse(); } return null; } æºç ä½ç½®: com.alibaba.nacos.client.naming.event.InstancesChangeNotifier#onEvent // InstancesChangeNotifier ç›‘å¬ InstancesChangeEvent äº‹ä»¶ @Override public void onEvent(InstancesChangeEvent event) { String key = ServiceInfo .getKey(NamingUtils.getGroupedName(event.getServiceName(), event.getGroupName()), event.getClusters()); ConcurrentHashSet\u003cEventListener\u003e eventListeners = listenerMap.get(key); if (CollectionUtils.isEmpty(eventListeners)) { return; } for (final EventListener listener : eventListeners) { // éå†å›è°ƒå‡½æ•° final com.alibaba.nacos.api.naming.listener.Event namingEvent = transferToNamingEvent(event); if (listener instanceof AbstractEventListener \u0026\u0026 ((AbstractEventListener) listener).getExecutor() != null) { ((AbstractEventListener) listener).getExecutor().execute(() -\u003e listener.onEvent(namingEvent)); } else { listener.onEvent(namingEvent); } } } ","date":"2023-08-27","objectID":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"10 client è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" UpdateTask å…¨é‡æ›´æ–°æºç ä½ç½®: com.alibaba.nacos.client.naming.core.ServiceInfoUpdateService.UpdateTask#run // UpdateTask å®šæ—¶æ‹‰å–å…¨é‡çš„ instances @Override public void run() { long delayTime = DEFAULT_DELAY; try { // åˆ¤æ–­æ˜¯å¦è®¢é˜…æœåŠ¡ if (!changeNotifier.isSubscribed(groupName, serviceName, clusters) \u0026\u0026 !futureMap.containsKey( serviceKey)) { NAMING_LOGGER.info(\"update task is stopped, service:{}, clusters:{}\", groupedServiceName, clusters); isCancel = true; return; } ServiceInfo serviceObj = serviceInfoHolder.getServiceInfoMap().get(serviceKey); // ç¬¬ä¸€æ¬¡æ‹‰å– if (serviceObj == null) { serviceObj = namingClientProxy.queryInstancesOfService(serviceName, groupName, clusters, 0, false); serviceInfoHolder.processServiceInfo(serviceObj); lastRefTime = serviceObj.getLastRefTime(); return; } // åˆ¤æ–­è¿‡æœŸæ—¶é—´ï¼Œç„¶åå†æ‹‰å– if (serviceObj.getLastRefTime() \u003c= lastRefTime) { serviceObj = namingClientProxy.queryInstancesOfService(serviceName, groupName, clusters, 0, false); serviceInfoHolder.processServiceInfo(serviceObj); } lastRefTime = serviceObj.getLastRefTime(); if (CollectionUtils.isEmpty(serviceObj.getHosts())) { incFailCount(); return; } // TODO multiple time can be configured. // æ›´æ–°å»¶æ—¶æ—¶é—´ delayTime = serviceObj.getCacheMillis() * DEFAULT_UPDATE_CACHE_TIME_MULTIPLE; resetFailCount(); } catch (NacosException e) { handleNacosException(e); } catch (Throwable e) { handleUnknownException(e); } finally { if (!isCancel) { // ä¸‹ä¸€æ¬¡æ‹‰å–ä»»åŠ¡ executor.schedule(this, Math.min(delayTime \u003c\u003c failCount, DEFAULT_DELAY * 60), TimeUnit.MILLISECONDS); } } } ","date":"2023-08-27","objectID":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"10 client è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.SubscribeCluster_ITCase#subscribeAdd ","date":"2023-08-27","objectID":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"10 client è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/10-client-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ è¿™é‡Œçš„ client æ˜¯æŒ‡ nacos SDKï¼Œä¹Ÿå°±æ˜¯æ¨¡å— nacos-client. ","date":"2023-08-26","objectID":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"09 client æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨é”€å®ä¾‹çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.client.naming.NacosNamingService#deregisterInstance // å…¥å£ç±»: NacosNamingService @Override public void deregisterInstance(String serviceName, String groupName, Instance instance) throws NacosException { // clientProxy çš„å®ç°ç±»ä¸º NamingClientProxyDelegate clientProxy.deregisterService(serviceName, groupName, instance); } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate#deregisterService // NamingClientProxyDelegate æ³¨é”€å®ä¾‹ // ä¸´æ—¶å®ä¾‹, grpcClientProxy // æŒä¹…åŒ–å®ä¾‹, httpClientProxy @Override public void deregisterService(String serviceName, String groupName, Instance instance) throws NacosException { getExecuteClientProxy(instance).deregisterService(serviceName, groupName, instance); } // æ ¹æ®æ˜¯å¦ä¸ºä¸´æ—¶å®ä¾‹æ¥è·å– clientProxy private NamingClientProxy getExecuteClientProxy(Instance instance) { return instance.isEphemeral() ? grpcClientProxy : httpClientProxy; } ","date":"2023-08-26","objectID":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"09 client æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨é”€ä¸´æ—¶å®ä¾‹æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy#deregisterService @Override public void deregisterService(String serviceName, String groupName, Instance instance) throws NacosException { NAMING_LOGGER .info(\"[DEREGISTER-SERVICE] {} deregistering service {} with instance: {}\", namespaceId, serviceName, instance); // æ ‡è®° instance è¦æ³¨é”€ï¼Œå¯ä»¥åœ¨ redoService å®šæ—¶ä»»åŠ¡é‡è¯• redoService.instanceDeregister(serviceName, groupName); // æ³¨é”€å®ä¾‹ doDeregisterService(serviceName, groupName, instance); } // redoService.instanceDeregister public void instanceDeregister(String serviceName, String groupName) { String key = NamingUtils.getGroupedName(serviceName, groupName); synchronized (registeredInstances) { InstanceRedoData redoData = registeredInstances.get(key); if (null != redoData) { // è®¾ç½®æ³¨é”€ä¸­ redoData.setUnregistering(true); // è®¾ç½®æœ€ç»ˆçŠ¶æ€ redoData.setExpectedRegistered(false); } } } // æ³¨é”€å®ä¾‹ public void doDeregisterService(String serviceName, String groupName, Instance instance) throws NacosException { InstanceRequest request = new InstanceRequest(namespaceId, serviceName, groupName, NamingRemoteConstants.DE_REGISTER_INSTANCE, instance); // å‘é€ InstanceRequest è¯·æ±‚ï¼Œä¼šè¢« InstanceRequestHandler å¤„ç† requestToServer(request, Response.class); // æ ‡è®° instance å·²ç»æ³¨é”€ redoService.instanceDeregistered(serviceName, groupName); } æºç ä½ç½®: com.alibaba.nacos.naming.remote.rpc.handler.InstanceRequestHandler#handle // InstanceRequestHandler å¤„ç†è¯·æ±‚ @Override @Secured(action = ActionTypes.WRITE) public InstanceResponse handle(InstanceRequest request, RequestMeta meta) throws NacosException { Service service = Service .newService(request.getNamespace(), request.getGroupName(), request.getServiceName(), true); switch (request.getType()) { ... case NamingRemoteConstants.DE_REGISTER_INSTANCE: return deregisterInstance(service, request, meta); } } // æ³¨é”€å®ä¾‹ private InstanceResponse deregisterInstance(Service service, InstanceRequest request, RequestMeta meta) { // è¿™ä¸ªé€»è¾‘åœ¨ã€æ³¨é”€å®ä¾‹ã€‘ç« èŠ‚ä¸­åˆ†æè¿‡äº† clientOperationService.deregisterInstance(service, request.getInstance(), meta.getConnectionId()); NotifyCenter.publishEvent(new DeregisterInstanceTraceEvent(System.currentTimeMillis(), meta.getClientIp(), true, DeregisterInstanceReason.REQUEST, service.getNamespace(), service.getGroup(), service.getName(), request.getInstance().getIp(), request.getInstance().getPort())); return new InstanceResponse(NamingRemoteConstants.DE_REGISTER_INSTANCE); } ","date":"2023-08-26","objectID":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"09 client æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨é”€æŒä¹…åŒ–å®ä¾‹æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.http.NamingHttpClientProxy#deregisterService // å‘é€ä¸€ä¸ª http è¯·æ±‚ @Override public void deregisterService(String serviceName, String groupName, Instance instance) throws NacosException { NAMING_LOGGER .info(\"[DEREGISTER-SERVICE] {} deregistering service {} with instance: {}\", namespaceId, serviceName, instance); if (instance.isEphemeral()) { return; } final Map\u003cString, String\u003e params = new HashMap\u003c\u003e(16); params.put(CommonParams.NAMESPACE_ID, namespaceId); params.put(CommonParams.SERVICE_NAME, NamingUtils.getGroupedName(serviceName, groupName)); params.put(CommonParams.CLUSTER_NAME, instance.getClusterName()); params.put(IP_PARAM, instance.getIp()); params.put(PORT_PARAM, String.valueOf(instance.getPort())); params.put(EPHEMERAL_PARAM, String.valueOf(instance.isEphemeral())); reqApi(UtilAndComs.nacosUrlInstance, params, HttpMethod.DELETE); } ","date":"2023-08-26","objectID":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"09 client æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-26","objectID":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"09 client æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/09-client-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ è¿™é‡Œçš„ client æ˜¯æŒ‡ nacos SDKï¼Œä¹Ÿå°±æ˜¯æ¨¡å— nacos-client. ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨å†Œå®ä¾‹çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.client.naming.NacosNamingService // NacosNamingService æ³¨å†Œå®ä¾‹ï¼Œæœ€åç”± NamingClientProxyDelegate æ¥æ³¨å†Œã€‚ @Override public void registerInstance(String serviceName, String groupName, Instance instance) throws NacosException { // æ£€æŸ¥å‚æ•° NamingUtils.checkInstanceIsLegal(instance); // æ³¨å†Œå®ä¾‹ï¼ŒclientProxy å®ç°ç±»ä¸º NamingClientProxyDelegateï¼Œå…·ä½“åˆ†ä¸º httpClientProxy å’Œ grpcClientProxy clientProxy.registerService(serviceName, groupName, instance); } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate#registerService // æ ¹æ®æ˜¯å¦ä¸ºä¸´æ—¶å®ä¾‹é€‰æ‹©å¯¹åº”çš„å®ç°æ¥æ³¨å†Œå®ä¾‹ @Override public void registerService(String serviceName, String groupName, Instance instance) throws NacosException { getExecuteClientProxy(instance).registerService(serviceName, groupName, instance); } // ä¸´æ—¶å®ä¾‹å°±æ˜¯ grpcClientProxy, å› ä¸º grpc å¯ä»¥é€šè¿‡é•¿è¿æ¥æ¥ç»´æŒï¼Œè¿æ¥æ–­å¼€ï¼Œè¯´æ˜ä¸´æ—¶å®ä¾‹æ³¨é”€äº† // æŒä¹…åŒ–å®ä¾‹å°±æ˜¯ httpClientProxy, å› ä¸ºæŒä¹…åŒ–å®ä¾‹åªéœ€è¦ä¸€æ¬¡è¯·æ±‚å°±å¯ä»¥äº†ï¼Œåç»­ä¸éœ€è¦ç»´æŒ private NamingClientProxy getExecuteClientProxy(Instance instance) { return instance.isEphemeral() ? grpcClientProxy : httpClientProxy; } ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨å†Œä¸´æ—¶å®ä¾‹æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy#registerService @Override public void registerService(String serviceName, String groupName, Instance instance) throws NacosException { NAMING_LOGGER.info(\"[REGISTER-SERVICE] {} registering service {} with instance {}\", namespaceId, serviceName, instance); // æ ‡è®°è¿™ä¸ª instance è¦æ³¨å†Œï¼Œåœ¨è¿æ¥æ–­å¼€ä¹‹åé€šè¿‡ redoService çš„å®šæ—¶ä»»åŠ¡é‡æ–°æ³¨å†Œ redoService.cacheInstanceForRedo(serviceName, groupName, instance); // æ³¨å†Œå®ä¾‹ doRegisterService(serviceName, groupName, instance); } // redoService.cacheInstanceForRedo public void cacheInstanceForRedo(String serviceName, String groupName, Instance instance) { String key = NamingUtils.getGroupedName(serviceName, groupName); InstanceRedoData redoData = InstanceRedoData.build(serviceName, groupName, instance); synchronized (registeredInstances) { registeredInstances.put(key, redoData); } } // æ³¨å†Œå®ä¾‹ public void doRegisterService(String serviceName, String groupName, Instance instance) throws NacosException { InstanceRequest request = new InstanceRequest(namespaceId, serviceName, groupName, NamingRemoteConstants.REGISTER_INSTANCE, instance); // å‘é€ InstanceRequest è¯·æ±‚ï¼Œä¼šè¢« InstanceRequestHandler å¤„ç† requestToServer(request, Response.class); // æ ‡è®° instance å·²ç»æ³¨å†Œè¿‡ redoService.instanceRegistered(serviceName, groupName); } æºç ä½ç½®: com.alibaba.nacos.naming.remote.rpc.handler.InstanceRequestHandler#handle // InstanceRequestHandler å¤„ç†è¯·æ±‚ @Override @Secured(action = ActionTypes.WRITE) public InstanceResponse handle(InstanceRequest request, RequestMeta meta) throws NacosException { Service service = Service .newService(request.getNamespace(), request.getGroupName(), request.getServiceName(), true); switch (request.getType()) { case NamingRemoteConstants.REGISTER_INSTANCE: return registerInstance(service, request, meta); ... } } private InstanceResponse registerInstance(Service service, InstanceRequest request, RequestMeta meta) throws NacosException { // æ³¨å†Œå®ä¾‹ï¼Œè¿™ä¸ªé€»è¾‘åœ¨ã€æ³¨å†Œå®ä¾‹ã€‘ç« èŠ‚åˆ†æè¿‡äº† clientOperationService.registerInstance(service, request.getInstance(), meta.getConnectionId()); NotifyCenter.publishEvent(new RegisterInstanceTraceEvent(System.currentTimeMillis(), meta.getClientIp(), true, service.getNamespace(), service.getGroup(), service.getName(), request.getInstance().getIp(), request.getInstance().getPort())); return new InstanceResponse(NamingRemoteConstants.REGISTER_INSTANCE); } ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨å†ŒæŒä¹…åŒ–å®ä¾‹æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.http.NamingHttpClientProxy#registerService // NamingHttpClientProxy æ³¨å†Œå®ä¾‹ // å‘é€ http è¯·æ±‚, ä¼šè¢« com.alibaba.nacos.naming.controllers.InstanceController#register å¤„ç†, è¿™ä¸ªé€»è¾‘åœ¨ã€æ³¨å†Œå®ä¾‹ã€‘ç« èŠ‚åˆ†æè¿‡äº† public void registerService(String serviceName, String groupName, Instance instance) throws NacosException { NAMING_LOGGER.info(\"[REGISTER-SERVICE] {} registering service {} with instance: {}\", namespaceId, serviceName, instance); String groupedServiceName = NamingUtils.getGroupedName(serviceName, groupName); if (instance.isEphemeral()) { throw new UnsupportedOperationException( \"Do not support register ephemeral instances by HTTP, please use gRPC replaced.\"); } final Map\u003cString, String\u003e params = new HashMap\u003c\u003e(32); params.put(CommonParams.NAMESPACE_ID, namespaceId); params.put(CommonParams.SERVICE_NAME, groupedServiceName); params.put(CommonParams.GROUP_NAME, groupName); params.put(CommonParams.CLUSTER_NAME, instance.getClusterName()); params.put(IP_PARAM, instance.getIp()); params.put(PORT_PARAM, String.valueOf(instance.getPort())); params.put(WEIGHT_PARAM, String.valueOf(instance.getWeight())); params.put(REGISTER_ENABLE_PARAM, String.valueOf(instance.isEnabled())); params.put(HEALTHY_PARAM, String.valueOf(instance.isHealthy())); params.put(EPHEMERAL_PARAM, String.valueOf(instance.isEphemeral())); params.put(META_PARAM, JacksonUtils.toJson(instance.getMetadata())); reqApi(UtilAndComs.nacosUrlInstance, params, HttpMethod.POST); } ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" redoService å®šæ—¶ä»»åŠ¡æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.redo.NamingGrpcRedoService // NamingGrpcRedoService æ„é€ å‡½æ•° public NamingGrpcRedoService(NamingGrpcClientProxy clientProxy) { this.redoExecutor = new ScheduledThreadPoolExecutor(REDO_THREAD, new NameThreadFactory(REDO_THREAD_NAME)); // å®šæ—¶è°ƒåº¦ RedoScheduledTask this.redoExecutor.scheduleWithFixedDelay(new RedoScheduledTask(clientProxy, this), DEFAULT_REDO_DELAY, DEFAULT_REDO_DELAY, TimeUnit.MILLISECONDS); } æºç ä½ç½®: com.alibaba.nacos.client.naming.remote.gprc.redo.RedoScheduledTask#run // RedoScheduledTask å®šæ—¶ä»»åŠ¡ @Override public void run() { // åˆ¤æ–­æ˜¯å¦å·²è¿æ¥ï¼Œé€šè¿‡ NamingGrpcRedoService#onConnected æ¥æ”¹å˜çŠ¶æ€ if (!redoService.isConnected()) { LogUtils.NAMING_LOGGER.warn(\"Grpc Connection is disconnect, skip current redo task\"); return; } // å› ä¸º grpc è¿æ¥å¯èƒ½ä¼šæ–­ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ³¨å†Œå®ä¾‹å’Œè®¢é˜…æœåŠ¡ try { // é‡æ–°æ³¨å†Œå®ä¾‹ redoForInstances(); // é‡æ–°è®¢é˜…æœåŠ¡ redoForSubscribes(); } catch (Exception e) { LogUtils.NAMING_LOGGER.warn(\"Redo task run with unexpected exception: \", e); } } ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-25","objectID":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"08 client æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/08-client-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ nacos çš„ grpc client ä½¿ç”¨çš„æ˜¯ç”Ÿæˆçš„ä»£ç ï¼Œä½ç½®åœ¨ com.alibaba.nacos.api.grpc.auto ","date":"2023-08-24","objectID":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"07 grpc client è®¾è®¡","uri":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" client çš„å¯åŠ¨æºç ä½ç½®: com.alibaba.nacos.common.remote.client.RpcClient#start // RpcClient æ˜¯çˆ¶ç±»ï¼Œå®Œæˆäº†åŸºæœ¬åŠŸèƒ½ï¼Œæ¯”å¦‚é‡è¯•ã€è¿æ¥äº‹ä»¶ public final void start() throws NacosException { // åˆå§‹åŒ–çŠ¶æ€å˜ä¸ºå¯åŠ¨ä¸­çŠ¶æ€ boolean success = rpcClientStatus.compareAndSet(RpcClientStatus.INITIALIZED, RpcClientStatus.STARTING); if (!success) { return; } // åˆå§‹åŒ–å®¢æˆ·ç«¯äº‹ä»¶çº¿ç¨‹æ±  clientEventExecutor = new ScheduledThreadPoolExecutor(2, r -\u003e { ... }); // connection event consumer. // è¿æ¥äº‹ä»¶ clientEventExecutor.submit(() -\u003e { while (!clientEventExecutor.isTerminated() \u0026\u0026 !clientEventExecutor.isShutdown()) { ConnectionEvent take; try { take = eventLinkedBlockingQueue.take(); if (take.isConnected()) { notifyConnected(); } else if (take.isDisConnected()) { notifyDisConnected(); } } catch (Throwable e) { // Do nothing } } }); // é‡è¿äº‹ä»¶ clientEventExecutor.submit(() -\u003e { while (true) { try { if (isShutdown()) { break; } ReconnectContext reconnectContext = reconnectionSignal.poll(rpcClientConfig.connectionKeepAlive(), TimeUnit.MILLISECONDS); if (reconnectContext == null) { // check alive time. // è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œå‘é€ HealthCheckRequest è¯·æ±‚ if (System.currentTimeMillis() - lastActiveTimeStamp \u003e= rpcClientConfig.connectionKeepAlive()) { boolean isHealthy = healthCheck(); if (!isHealthy) { // åˆ¤æ–­å½“å‰è¿æ¥ if (currentConnection == null) { continue; } LoggerUtils.printIfInfoEnabled(LOGGER, \"[{}] Server healthy check fail, currentConnection = {}\", rpcClientConfig.name(), currentConnection.getConnectionId()); RpcClientStatus rpcClientStatus = RpcClient.this.rpcClientStatus.get(); // å·²ç»å…³é—­äº†ï¼Œæ— éœ€æ£€æŸ¥äº† if (RpcClientStatus.SHUTDOWN.equals(rpcClientStatus)) { break; } boolean statusFLowSuccess = RpcClient.this.rpcClientStatus.compareAndSet( rpcClientStatus, RpcClientStatus.UNHEALTHY); if (statusFLowSuccess) { reconnectContext = new ReconnectContext(null, false); } else { continue; } } else { lastActiveTimeStamp = System.currentTimeMillis(); continue; } } else { continue; } } // æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²ç»åˆ é™¤ if (reconnectContext.serverInfo != null) { // clear recommend server if server is not in server list. boolean serverExist = false; for (String server : getServerListFactory().getServerList()) { ServerInfo serverInfo = resolveServerInfo(server); if (serverInfo.getServerIp().equals(reconnectContext.serverInfo.getServerIp())) { serverExist = true; reconnectContext.serverInfo.serverPort = serverInfo.serverPort; break; } } if (!serverExist) { LoggerUtils.printIfInfoEnabled(LOGGER, \"[{}] Recommend server is not in server list, ignore recommend server {}\", rpcClientConfig.name(), reconnectContext.serverInfo.getAddress()); // èµ‹å€¼ä¸º nullï¼Œä¼šæŒ‘é€‰ä¸‹ä¸€ä¸ªæœåŠ¡æ¥è¿›è¡Œé‡è¿ reconnectContext.serverInfo = null; } } // è¿›è¡Œé‡è¿ reconnect(reconnectContext.serverInfo, reconnectContext.onRequestFail); } catch (Throwable throwable) { // Do nothing } } }); // connect to server, try to connect to server sync retryTimes times, async starting if failed. Connection connectToServer = null; rpcClientStatus.set(RpcClientStatus.STARTING); // é‡è¯• int startUpRetryTimes = rpcClientConfig.retryTimes(); while (startUpRetryTimes \u003e 0 \u0026\u0026 connectToServer == null) { try { startUpRetryTimes--; // è·å–ä¸‹ä¸€ä¸ª serverInfoï¼Œå› ä¸º nacos çš„åœ°å€å¯ä»¥é…ç½®å¤šä¸ªï¼Œæˆ–è€…é…ç½®ä¸€ä¸ª http åœ°å€æ¥åŠ¨æ€è·å– ServerInfo serverInfo = nextRpcServer(); LoggerUtils.printIfInfoEnabled(LOGGER, \"[{}] Try to connect to server on start up, server: {}\", rpcClientConfig.name(), serverInfo); // è¿æ¥æœåŠ¡ï¼Œç”±å­ç±»æ¥å®ç°ï¼Œæ¥ä¸‹æ¥ç»§ç»­çœ‹ connectToServer = connectToServer(serverInfo); } catch (Throwable e) { LoggerUtils.printIfWarnEnabled(LOGGER, \"[{}] Fail to connect to server on start up, error message = {}, start up retry times left: {}\", rpcClientConfig.name(), e.getMessage(), startUpRetryTimes, e); } } // å‘ eventLinkedBlockingQueue é˜Ÿåˆ—ä¸­æ·»åŠ  ConnectionEvent, äº§ç”Ÿè¿æ¥äº‹ä»¶ if (connectToServer != null) { LoggerUtils.printIfInfoEnabled(LOGGER, \"[{}] Success to connect to server [{}] on start up, connectionId = {}\", rpcClientConfig.name(), connectToServer.serverInfo.getAddress(), connectToServer.getConnectionId()); // è®¾ç½®å½“å‰è¿æ¥ this.currentConnection = connectToServer; rpcClientStatus.set(RpcClientStatus.RUNNING); eventLinke","date":"2023-08-24","objectID":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"07 grpc client è®¾è®¡","uri":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" è¿æ¥ grpc serveræºç ä½ç½®: com.alibaba.nacos.common.remote.client.grpc.GrpcClient#connectToServer // å­ç±»å®ç°è¿æ¥ grpc server // 1. å‘é€ ServerCheckRequest è¯·æ±‚æ¥æ£€æŸ¥æœåŠ¡, ä¼šè¿”å› connectionId // 2. å‘é€ ConnectionSetupRequest è¯·æ±‚æ¥æ³¨å†Œ connection // 3. æœ€ååŒ…è£…ä¸º GrpcConnection @Override public Connection connectToServer(ServerInfo serverInfo) { try { if (grpcExecutor == null) { this.grpcExecutor = createGrpcExecutor(serverInfo.getServerIp()); } // è®¡ç®—ç«¯å£åç§»ï¼Œå¯¹äº sdkClient æ¥è¯´ï¼Œå°±æ˜¯ 8848 + 1000 = 9848 // å¦‚æœç”¨ nginx æ¥åšä»£ç†ï¼Œ9848 ç«¯å£ä¹Ÿéœ€è¦ä»£ç† int port = serverInfo.getServerPort() + rpcPortOffset(); ManagedChannel managedChannel = createNewManagedChannel(serverInfo.getServerIp(), port); // å•ä¸€è¯·æ±‚ RequestGrpc.RequestFutureStub newChannelStubTemp = createNewChannelStub(managedChannel); if (newChannelStubTemp != null) { // å‘é€ ServerCheckRequest è¯·æ±‚ï¼Œä¼šè¢« GrpcRequestAcceptor#request å¤„ç† Response response = serverCheck(serverInfo.getServerIp(), port, newChannelStubTemp); if (response == null || !(response instanceof ServerCheckResponse)) { shuntDownChannel(managedChannel); return null; } // æµå¼è¯·æ±‚ BiRequestStreamGrpc.BiRequestStreamStub biRequestStreamStub = BiRequestStreamGrpc.newStub( newChannelStubTemp.getChannel()); GrpcConnection grpcConn = new GrpcConnection(serverInfo, grpcExecutor); grpcConn.setConnectionId(((ServerCheckResponse) response).getConnectionId()); //create stream request and bind connection event to this connection. // client æµå¼å¤„ç†è¯·æ±‚ StreamObserver\u003cPayload\u003e payloadStreamObserver = bindRequestStream(biRequestStreamStub, grpcConn); // stream observer to send response to server grpcConn.setPayloadStreamObserver(payloadStreamObserver); grpcConn.setGrpcFutureServiceStub(newChannelStubTemp); grpcConn.setChannel(managedChannel); //send a setup request. // å‘é€ ConnectionSetupRequest è¯·æ±‚ï¼Œä¼šè¢« GrpcBiStreamRequestAcceptor#requestBiStream å¤„ç†ï¼Œæ³¨å†Œ connection ConnectionSetupRequest conSetupRequest = new ConnectionSetupRequest(); conSetupRequest.setClientVersion(VersionUtils.getFullClientVersion()); conSetupRequest.setLabels(super.getLabels()); conSetupRequest.setAbilities(super.clientAbilities); conSetupRequest.setTenant(super.getTenant()); grpcConn.sendRequest(conSetupRequest); //wait to register connection setup Thread.sleep(100L); return grpcConn; } return null; } catch (Exception e) { LOGGER.error(\"[{}]Fail to connect to server!,error={}\", GrpcClient.this.getName(), e); } return null; } æºç ä½ç½®: com.alibaba.nacos.common.remote.client.grpc.GrpcClient#bindRequestStream // client æµå¼å¤„ç†è¯·æ±‚ // onNext: å¤„ç†è¯·æ±‚ // onError å’Œ onCompleted æ¥å˜æ¢ grpc server private StreamObserver\u003cPayload\u003e bindRequestStream(final BiRequestStreamGrpc.BiRequestStreamStub streamStub, final GrpcConnection grpcConn) { return streamStub.requestBiStream(new StreamObserver\u003cPayload\u003e() { @Override public void onNext(Payload payload) { LoggerUtils.printIfDebugEnabled(LOGGER, \"[{}]Stream server request receive, original info: {}\", grpcConn.getConnectionId(), payload.toString()); try { Object parseBody = GrpcUtils.parse(payload); final Request request = (Request) parseBody; if (request != null) { try { // å¤„ç†æœåŠ¡ç«¯è¯·æ±‚ Response response = handleServerRequest(request); if (response != null) { response.setRequestId(request.getRequestId()); // å“åº” sendResponse(response); } else { LOGGER.warn(\"[{}]Fail to process server request, ackId-\u003e{}\", grpcConn.getConnectionId(), request.getRequestId()); } } catch (Exception e) { LoggerUtils.printIfErrorEnabled(LOGGER, \"[{}]Handle server request exception: {}\", grpcConn.getConnectionId(), payload.toString(), e.getMessage()); Response errResponse = ErrorResponse.build(NacosException.CLIENT_ERROR, \"Handle server request error\"); errResponse.setRequestId(request.getRequestId()); sendResponse(errResponse); } } } catch (Exception e) { LoggerUtils.printIfErrorEnabled(LOGGER, \"[{}]Error to process server push response: {}\", grpcConn.getConnectionId(), payload.getBody().getValue().toStringUtf8()); } } @Override public void onError(Throwable throwable) { boolean isRunning = isRunning(); boolean isAbandon = grpcConn.isAbandon","date":"2023-08-24","objectID":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"07 grpc client è®¾è®¡","uri":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-24","objectID":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"07 grpc client è®¾è®¡","uri":"/ooooo-notes/07-grpc-client-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ nacos åœ¨ 2.0 ç‰ˆæœ¬ä¸­å¼•å…¥äº† grpcï¼Œç”¨æ¥å¤„ç†httpè¿æ¥æ•°è¿‡å¤šçš„é—®é¢˜ï¼Œæ‰€ä»¥æœ‰å¿…è¦çœ‹çœ‹nacos æ˜¯æ€ä¹ˆä½¿ç”¨ grpcçš„ï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬ç†æ¸…æ•´ä¸ªè¯·æ±‚æµç¨‹ã€‚ åœ¨ nacos ä¸­åªå®šä¹‰äº†ä¸¤ä¸ªé€šç”¨çš„è¯·æ±‚æ¨¡å‹ï¼Œä¸€ä¸ªæ˜¯ request-response, å¦å¤–ä¸€ä¸ªå°±æ˜¯åŸºäºåŒå‘æµçš„ request-response. ","date":"2023-08-23","objectID":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"06 grpc server è®¾è®¡","uri":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" grpc server çš„å¯åŠ¨æ‰€æœ‰çš„ grpc æœåŠ¡éƒ½åŸºäºè¿™ä¸ª BaseGrpcServer ï¼Œå­ç±»é€šè¿‡ä¸åŒé…ç½®æ¥å®šåˆ¶æœåŠ¡ï¼Œæ¯”å¦‚ç«¯å£ã€è¶…æ—¶æ—¶é—´ æºç ä½ç½®: com.alibaba.nacos.core.remote.grpc.BaseGrpcServer // åœ¨çˆ¶ç±»ä¸­è°ƒç”¨ start æ–¹æ³•ï¼Œæ¥æ‰§è¡Œ startServer æ–¹æ³• @Override public void startServer() throws Exception { final MutableHandlerRegistry handlerRegistry = new MutableHandlerRegistry(); // æ·»åŠ  rpc è¯·æ±‚ addServices(handlerRegistry, new GrpcConnectionInterceptor()); NettyServerBuilder builder = NettyServerBuilder.forPort(getServicePort()).executor(getRpcExecutor()); // é…ç½® tls if (grpcServerConfig.getEnableTls()) { if (grpcServerConfig.getCompatibility()) { builder.protocolNegotiator(new OptionalTlsProtocolNegotiator(getSslContextBuilder())); } else { builder.sslContext(getSslContextBuilder()); } } // é…ç½® grpc server çš„å‚æ•° server = builder.maxInboundMessageSize(getMaxInboundMessageSize()).fallbackHandlerRegistry(handlerRegistry) .compressorRegistry(CompressorRegistry.getDefaultInstance()) .decompressorRegistry(DecompressorRegistry.getDefaultInstance()) // è¿æ¥çš„è¿‡æ»¤å™¨ï¼Œè®¾ç½®äº†ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ ATTR_TRANS_KEY_CONN_ID .addTransportFilter(new AddressTransportFilter(connectionManager)) .keepAliveTime(getKeepAliveTime(), TimeUnit.MILLISECONDS) .keepAliveTimeout(getKeepAliveTimeout(), TimeUnit.MILLISECONDS) .permitKeepAliveTime(getPermitKeepAliveTime(), TimeUnit.MILLISECONDS) .build(); // å¯åŠ¨ grpc server server.start(); } // æ·»åŠ  rpc è¯·æ±‚ // è¿™é‡Œæ·»åŠ äº†ä¸¤ä¸ªé€šç”¨çš„è¯·æ±‚æ¨¡å‹ï¼Œpayload -\u003e payload , stream payload \u003c-\u003e stream payload // æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šç”± grpcCommonRequestAcceptor å’Œ grpcBiStreamRequestAcceptor æ¥å¤„ç†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆå¤„ç†è¯·æ±‚çš„ private void addServices(MutableHandlerRegistry handlerRegistry, ServerInterceptor... serverInterceptor) { // unary common call register. final MethodDescriptor\u003cPayload, Payload\u003e unaryPayloadMethod = MethodDescriptor.\u003cPayload, Payload\u003enewBuilder() .setType(MethodDescriptor.MethodType.UNARY) .setFullMethodName(MethodDescriptor.generateFullMethodName(GrpcServerConstants.REQUEST_SERVICE_NAME, GrpcServerConstants.REQUEST_METHOD_NAME)) .setRequestMarshaller(ProtoUtils.marshaller(Payload.getDefaultInstance())) .setResponseMarshaller(ProtoUtils.marshaller(Payload.getDefaultInstance())).build(); // å®šä¹‰ payload -\u003e payload final ServerCallHandler\u003cPayload, Payload\u003e payloadHandler = ServerCalls .asyncUnaryCall((request, responseObserver) -\u003e grpcCommonRequestAcceptor.request(request, responseObserver)); final ServerServiceDefinition serviceDefOfUnaryPayload = ServerServiceDefinition.builder( GrpcServerConstants.REQUEST_SERVICE_NAME) .addMethod(unaryPayloadMethod, payloadHandler).build(); handlerRegistry.addService(ServerInterceptors.intercept(serviceDefOfUnaryPayload, serverInterceptor)); // bi stream register. // å®šä¹‰ stream payload \u003c-\u003e stream payload final ServerCallHandler\u003cPayload, Payload\u003e biStreamHandler = ServerCalls.asyncBidiStreamingCall( (responseObserver) -\u003e grpcBiStreamRequestAcceptor.requestBiStream(responseObserver)); final MethodDescriptor\u003cPayload, Payload\u003e biStreamMethod = MethodDescriptor.\u003cPayload, Payload\u003enewBuilder() .setType(MethodDescriptor.MethodType.BIDI_STREAMING).setFullMethodName(MethodDescriptor .generateFullMethodName(GrpcServerConstants.REQUEST_BI_STREAM_SERVICE_NAME, GrpcServerConstants.REQUEST_BI_STREAM_METHOD_NAME)) .setRequestMarshaller(ProtoUtils.marshaller(Payload.newBuilder().build())) .setResponseMarshaller(ProtoUtils.marshaller(Payload.getDefaultInstance())).build(); final ServerServiceDefinition serviceDefOfBiStream = ServerServiceDefinition .builder(GrpcServerConstants.REQUEST_BI_STREAM_SERVICE_NAME).addMethod(biStreamMethod, biStreamHandler).build(); handlerRegistry.addService(ServerInterceptors.intercept(serviceDefOfBiStream, serverInterceptor)); } ","date":"2023-08-23","objectID":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"06 grpc server è®¾è®¡","uri":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" GrpcRequestAcceptor å¤„ç†å•ä¸€è¯·æ±‚æºç ä½ç½®: com.alibaba.nacos.core.remote.grpc.GrpcRequestAcceptor // GrpcRequestAcceptor å¤„ç†è¯·æ±‚ // è¯·æ±‚çš„é€»è¾‘æ¯”è¾ƒæ¸…æ¥šï¼Œæœ€ç»ˆç”± RequestHandler æ¥å¤„ç†è¯·æ±‚ @Override public void request(Payload grpcRequest, StreamObserver\u003cPayload\u003e responseObserver) { // trace è¯·æ±‚ traceIfNecessary(grpcRequest, true); String type = grpcRequest.getMetadata().getType(); //server is on starting. // server æ­£åœ¨å¯åŠ¨ä¸­ï¼Œ è¿”å›é”™è¯¯ if (!ApplicationUtils.isStarted()) { Payload payloadResponse = GrpcUtils.convert( ErrorResponse.build(NacosException.INVALID_SERVER_STATUS, \"Server is starting,please try later.\")); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } // server check. // æ£€æŸ¥è¯·æ±‚å¤„ç†ï¼Œåœ¨å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œä¼šå‘é€ ServerCheckRequest è¯·æ±‚ if (ServerCheckRequest.class.getSimpleName().equals(type)) { Payload serverCheckResponseP = GrpcUtils.convert(new ServerCheckResponse(GrpcServerConstants.CONTEXT_KEY_CONN_ID.get())); traceIfNecessary(serverCheckResponseP, false); responseObserver.onNext(serverCheckResponseP); responseObserver.onCompleted(); return; } // æ ¹æ® type æ¥è·å– handlerï¼Œè¿™é‡Œæœ€é‡è¦ RequestHandler requestHandler = requestHandlerRegistry.getByRequestType(type); //no handler found. // æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ handlerï¼Œè¿”å›é”™è¯¯ if (requestHandler == null) { Loggers.REMOTE_DIGEST.warn(String.format(\"[%s] No handler for request type : %s :\", \"grpc\", type)); Payload payloadResponse = GrpcUtils .convert(ErrorResponse.build(NacosException.NO_HANDLER, \"RequestHandler Not Found\")); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } //check connection status. // æ£€æŸ¥è¿æ¥çŠ¶æ€, åœ¨å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œä¼šå‘é€ ConnectionSetupRequest è¯·æ±‚æ¥åˆ›å»º Connection String connectionId = GrpcServerConstants.CONTEXT_KEY_CONN_ID.get(); boolean requestValid = connectionManager.checkValid(connectionId); if (!requestValid) { Loggers.REMOTE_DIGEST .warn(\"[{}] Invalid connection Id ,connection [{}] is un registered ,\", \"grpc\", connectionId); Payload payloadResponse = GrpcUtils .convert(ErrorResponse.build(NacosException.UN_REGISTER, \"Connection is unregistered.\")); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } Object parseObj = null; try { // æ ¹æ® grpcRequest ä¸­çš„ type æ¥è¿›è¡Œ json ååºåˆ—åŒ– parseObj = GrpcUtils.parse(grpcRequest); } catch (Exception e) { Loggers.REMOTE_DIGEST .warn(\"[{}] Invalid request receive from connection [{}] ,error={}\", \"grpc\", connectionId, e); Payload payloadResponse = GrpcUtils.convert(ErrorResponse.build(NacosException.BAD_GATEWAY, e.getMessage())); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } // æ— æ•ˆçš„è¯·æ±‚ï¼Œè¿”å›é”™è¯¯ if (parseObj == null) { Loggers.REMOTE_DIGEST.warn(\"[{}] Invalid request receive ,parse request is null\", connectionId); Payload payloadResponse = GrpcUtils .convert(ErrorResponse.build(NacosException.BAD_GATEWAY, \"Invalid request\")); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } // åªèƒ½æ˜¯ request å¯¹è±¡ if (!(parseObj instanceof Request)) { Loggers.REMOTE_DIGEST .warn(\"[{}] Invalid request receive ,parsed payload is not a request,parseObj={}\", connectionId, parseObj); Payload payloadResponse = GrpcUtils .convert(ErrorResponse.build(NacosException.BAD_GATEWAY, \"Invalid request\")); traceIfNecessary(payloadResponse, false); responseObserver.onNext(payloadResponse); responseObserver.onCompleted(); return; } Request request = (Request) parseObj; try { // è·å–å¯¹åº”çš„ connectionï¼Œè®¾ç½® requestMeta Connection connection = connectionManager.getConnection(GrpcServerConstants.CONTEXT_KEY_CONN_ID.get()); RequestMeta requestMeta = new RequestMeta(); requestMeta.setClientIp(connection.getMetaInfo().getClientIp()); requestMeta.setConnectionId(GrpcServerConstants.CONTEXT_KEY_CONN_ID.get()); requestMeta.setClientVersion(connection.getMetaInfo().getVersion()); requestMeta.setLabels(connection.getMetaInf","date":"2023-08-23","objectID":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"06 grpc server è®¾è®¡","uri":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" GrpcBiStreamRequestAcceptor å¤„ç†æµå¼è¯·æ±‚æºç ä½ç½®: com.alibaba.nacos.core.remote.grpc.GrpcBiStreamRequestAcceptor // GrpcBiStreamRequestAcceptor å¤„ç†æµå¼è¯·æ±‚ // å¤„ç†é€»è¾‘æ¯”è¾ƒæ¸…æ¥šï¼Œä¸»è¦åˆ†ä¸º onNext(æ­£å¸¸è¯·æ±‚)ã€onError(é”™è¯¯è¯·æ±‚)ã€onCompleted(å…³é—­è¯·æ±‚) // åœ¨æµå¼å¤„ç†ä¸­ï¼Œæ²¡æœ‰ requestHandler æ¥å¤„ç†è¯·æ±‚ï¼Œ // è¿™æ˜¯å› ä¸ºæµå¼è¯·æ±‚ä¸»è¦æ˜¯ æœåŠ¡ç«¯å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥å—åå‘é€ ack response @Override public StreamObserver\u003cPayload\u003e requestBiStream(StreamObserver\u003cPayload\u003e responseObserver) { StreamObserver\u003cPayload\u003e streamObserver = new StreamObserver\u003cPayload\u003e() { final String connectionId = GrpcServerConstants.CONTEXT_KEY_CONN_ID.get(); final Integer localPort = GrpcServerConstants.CONTEXT_KEY_CONN_LOCAL_PORT.get(); final int remotePort = GrpcServerConstants.CONTEXT_KEY_CONN_REMOTE_PORT.get(); String remoteIp = GrpcServerConstants.CONTEXT_KEY_CONN_REMOTE_IP.get(); String clientIp = \"\"; @Override public void onNext(Payload payload) { // è·å–å®¢æˆ·ç«¯çš„ ip clientIp = payload.getMetadata().getClientIp(); traceDetailIfNecessary(payload); Object parseObj; try { // ååºåˆ—åŒ–å¯¹è±¡ parseObj = GrpcUtils.parse(payload); } catch (Throwable throwable) { Loggers.REMOTE_DIGEST .warn(\"[{}]Grpc request bi stream,payload parse error={}\", connectionId, throwable); return; } // è¯·æ±‚å¯¹è±¡ä¸º nullï¼Œä¸å¤„ç† if (parseObj == null) { Loggers.REMOTE_DIGEST .warn(\"[{}]Grpc request bi stream,payload parse null ,body={},meta={}\", connectionId, payload.getBody().getValue().toStringUtf8(), payload.getMetadata()); return; } // å¤„ç† ConnectionSetupRequest è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å¯åŠ¨æ—¶ä¼šå‘é€è¿™ä¸ªè¯·æ±‚ if (parseObj instanceof ConnectionSetupRequest) { ConnectionSetupRequest setUpRequest = (ConnectionSetupRequest) parseObj; Map\u003cString, String\u003e labels = setUpRequest.getLabels(); String appName = \"-\"; if (labels != null \u0026\u0026 labels.containsKey(Constants.APPNAME)) { appName = labels.get(Constants.APPNAME); } ConnectionMeta metaInfo = new ConnectionMeta(connectionId, payload.getMetadata().getClientIp(), remoteIp, remotePort, localPort, ConnectionType.GRPC.getType(), setUpRequest.getClientVersion(), appName, setUpRequest.getLabels()); metaInfo.setTenant(setUpRequest.getTenant()); // æ–°å»º connection Connection connection = new GrpcConnection(metaInfo, responseObserver, GrpcServerConstants.CONTEXT_KEY_CHANNEL.get()); connection.setAbilities(setUpRequest.getAbilities()); boolean rejectSdkOnStarting = metaInfo.isSdkSource() \u0026\u0026 !ApplicationUtils.isStarted(); // æ³¨å†Œ connection å¯¹è±¡, å¦‚æœä¸æˆåŠŸï¼Œåˆ™å…³é—­è¿æ¥ if (rejectSdkOnStarting || !connectionManager.register(connectionId, connection)) { //Not register to the connection manager if current server is over limit or server is starting. try { Loggers.REMOTE_DIGEST.warn(\"[{}]Connection register fail,reason:{}\", connectionId, rejectSdkOnStarting ? \" server is not started\" : \" server is over limited.\"); connection.request(new ConnectResetRequest(), 3000L); connection.close(); } catch (Exception e) { //Do nothing. if (connectionManager.traced(clientIp)) { Loggers.REMOTE_DIGEST .warn(\"[{}]Send connect reset request error,error={}\", connectionId, e); } } } } else if (parseObj instanceof Response) { // å¤„ç† response è¯·æ±‚ï¼Œè¯·æ±‚å¯èƒ½éœ€è¦ ack Response response = (Response) parseObj; if (connectionManager.traced(clientIp)) { Loggers.REMOTE_DIGEST .warn(\"[{}]Receive response of server request ,response={}\", connectionId, response); } // ack é€šçŸ¥ RpcAckCallbackSynchronizer.ackNotify(connectionId, response); connectionManager.refreshActiveTime(connectionId); } else { Loggers.REMOTE_DIGEST .warn(\"[{}]Grpc request bi stream,unknown payload receive ,parseObj={}\", connectionId, parseObj); } } @Override public void onError(Throwable t) { if (connectionManager.traced(clientIp)) { Loggers.REMOTE_DIGEST.warn(\"[{}]Bi stream on error,error={}\", connectionId, t); } if (responseObserver instanceof ServerCallStreamObserver) { ServerCallStreamObserver serverCallStreamObserver = ((ServerCallStreamObserver) responseObserver); if (serverCallStreamObserver.isCancelled()) { //client close the stream. } else { try { serverCallStreamObserver.onCompleted(); } catch (Throwable throwable) { //ignore } } } } @Override public void onCompleted() { if (connectionMa","date":"2023-08-23","objectID":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"06 grpc server è®¾è®¡","uri":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.core.remote.grpc.GrpcServerTest#testGrpcSdkServer com.alibaba.nacos.core.remote.grpc.GrpcServerTest#testGrpcClusterServer ","date":"2023-08-23","objectID":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"06 grpc server è®¾è®¡","uri":"/ooooo-notes/06-grpc-server-%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ ","date":"2023-08-22","objectID":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"05 ä»»åŠ¡æ‰§è¡Œå™¨çš„è®¾è®¡","uri":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" ä»»åŠ¡æ‰§è¡Œå™¨çš„è®¾è®¡åœ¨ nacos ä¸­ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½å®ç°äº† NacosTask æ¥å£ï¼Œæ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå™¨éƒ½å®ç°äº† NacosTaskExecuteEngine æ¥å£ã€‚ æ¥ä¸‹æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ¥å£çš„è®¾è®¡ // NacosTask public interface NacosTask { /** * Judge Whether this nacos task should do. * * @return true means the nacos task should be done, otherwise false */ // å¯¹äºç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ return true. // å¯¹äºå»¶æ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåˆ¤æ–­ System.currentTimeMillis() - this.lastProcessTime \u003e= this.taskInterval. boolean shouldProcess(); } // NacosTaskExecuteEngine // ä»æ¥å£ä¸­å¯ä»¥çœ‹å‡º // 1. addTask, ä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª task // 2. addProcessor, ä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª processor, æœ‰é»˜è®¤çš„ processor public interface NacosTaskExecuteEngine\u003cT extends NacosTask\u003e extends Closeable { /** * Get Task size in execute engine. * * @return size of task */ int size(); /** * Whether the execute engine is empty. * * @return true if the execute engine has no task to do, otherwise false */ boolean isEmpty(); /** * Add task processor {@link NacosTaskProcessor} for execute engine. * * @param key key of task * @param taskProcessor task processor */ void addProcessor(Object key, NacosTaskProcessor taskProcessor); /** * Remove task processor {@link NacosTaskProcessor} form execute engine for key. * * @param key key of task */ void removeProcessor(Object key); /** * Try to get {@link NacosTaskProcessor} by key, if non-exist, will return default processor. * * @param key key of task * @return task processor for task key or default processor if task processor for task key non-exist */ NacosTaskProcessor getProcessor(Object key); /** * Get all processor key. * * @return collection of processors */ Collection\u003cObject\u003e getAllProcessorKey(); /** * Set default task processor. If do not find task processor by task key, use this default processor to process * task. * * @param defaultTaskProcessor default task processor */ void setDefaultTaskProcessor(NacosTaskProcessor defaultTaskProcessor); /** * Add task into execute pool. * * @param key key of task * @param task task */ void addTask(Object key, T task); /** * Remove task. * * @param key key of task * @return nacos task */ T removeTask(Object key); /** * Get all task keys. * * @return collection of task keys. */ Collection\u003cObject\u003e getAllTaskKeys(); } ","date":"2023-08-22","objectID":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"05 ä»»åŠ¡æ‰§è¡Œå™¨çš„è®¾è®¡","uri":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" å…·ä½“å®ç°ç±»(ä¸¾ä¾‹)PushDelayTask å’Œ PushDelayTaskExecuteEngine æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.task.PushDelayTask // PushDelayTask çš„æ„é€ æ–¹æ³• // delay: å»¶æ—¶çš„äº‹ä»¶ // targetClient: æ¨é€çš„ clientId public PushDelayTask(Service service, long delay, String targetClient) { this.service = service; this.pushToAll = false; this.targetClients = new HashSet\u003c\u003e(1); this.targetClients.add(targetClient); setTaskInterval(delay); // è®¾ç½®ä¸Šä¸€æ¬¡å¤„ç†æ—¶é—´ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦è¿‡æœŸ setLastProcessTime(System.currentTimeMillis()); } // æ¯ä¸€ä¸ªå»¶æ—¶ä»»åŠ¡éƒ½ä¼šæœ‰ merge æ–¹æ³•, ç”¨æ¥åˆå¹¶ç›¸åŒçš„ task, è¿™æ ·å¯ä»¥æ›´é«˜æ•ˆçš„å¤„ç†ä»»åŠ¡ // æ¯”å¦‚å› ä¸ºå®¢æˆ·ç«¯é‡è¯•ï¼Œå‘èµ·äº†ä¸¤ä¸ªä¸€æ ·çš„ taskï¼Œç»è¿‡ merge ä¹‹åï¼Œå¤„ç†ä¸€ä¸ªå°±è¡Œã€‚ @Override public void merge(AbstractDelayTask task) { if (!(task instanceof PushDelayTask)) { return; } PushDelayTask oldTask = (PushDelayTask) task; if (isPushToAll() || oldTask.isPushToAll()) { pushToAll = true; targetClients = null; } else { targetClients.addAll(oldTask.getTargetClients()); } setLastProcessTime(Math.min(getLastProcessTime(), task.getLastProcessTime())); Loggers.PUSH.info(\"[PUSH] Task merge for {}\", service); } // shouldProcess æ–¹æ³•åœ¨çˆ¶ç±»ä¸Šé¢, åˆ¤æ–­å½“å‰ä»»åŠ¡éƒ½æ˜¯è¿‡æœŸ @Override public boolean shouldProcess() { return (System.currentTimeMillis() - this.lastProcessTime \u003e= this.taskInterval); } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.task.PushDelayTaskExecuteEngine#PushDelayTaskExecuteEngine // PushDelayTaskExecuteEngine çš„åˆå§‹åŒ– public PushDelayTaskExecuteEngine(ClientManager clientManager, ClientServiceIndexesManager indexesManager, ServiceStorage serviceStorage, NamingMetadataManager metadataManager, PushExecutor pushExecutor, SwitchDomain switchDomain) { ... // è®¾ç½®é»˜è®¤çš„processor, ç”¨æ¥å¤„ç†ä»»åŠ¡, è¿™é‡Œæ²¡æœ‰ç‰¹æ®Šçš„ processor setDefaultTaskProcessor(new PushDelayTaskProcessor(this)); } // åœ¨çˆ¶ç±» NacosDelayTaskExecuteEngine ä¸­ç”¨å•ä¸€çš„çº¿ç¨‹æ± æ¥å¯åŠ¨ï¼Œç„¶åå¤„ç†ä»»åŠ¡ public NacosDelayTaskExecuteEngine(String name, int initCapacity, Logger logger, long processInterval) { ... tasks = new ConcurrentHashMap\u003c\u003e(initCapacity); // çº¿ç¨‹æ±  processingExecutor = ExecutorFactory.newSingleScheduledExecutorService(new NameThreadFactory(name)); // æœ€åè°ƒç”¨è‡ªå·±çš„æ–¹æ³•æ¥å¤„ç†ä»»åŠ¡ processingExecutor .scheduleWithFixedDelay(new ProcessRunnable(), processInterval, processInterval, TimeUnit.MILLISECONDS); } // å¤„ç†ä»»åŠ¡ private class ProcessRunnable implements Runnable { @Override public void run() { try { processTasks(); } catch (Throwable e) { getEngineLog().error(e.toString(), e); } } } // åœ¨çˆ¶ç±» NacosDelayTaskExecuteEngine ä¸­ // com.alibaba.nacos.common.task.engine.NacosDelayTaskExecuteEngine#processTasks protected void processTasks() { // è·å–æ‰€æœ‰çš„ keyï¼Œå› ä¸º addTask æ–¹æ³•ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª task éƒ½ä¼šå…³è”åˆ°ä¸€ä¸ª key Collection\u003cObject\u003e keys = getAllTaskKeys(); for (Object taskKey : keys) { // åˆ¤æ–­ task æ˜¯å¦åˆ°æœŸï¼Œæ¯ä¸ª task åˆ›å»ºæ—¶éƒ½æ˜¯æŒ‡å®š taskInterval AbstractDelayTask task = removeTask(taskKey); if (null == task) { continue; } // è·å–ç›¸åº”çš„ processor æ¥å¤„ç†ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯é»˜è®¤çš„ processor, æ¯”å¦‚ PushDelayTaskProcessor, ä¸‹é¢ä¼šè¯´è¿™ä¸ªç±» NacosTaskProcessor processor = getProcessor(taskKey); if (null == processor) { getEngineLog().error(\"processor not found for task, so discarded. \" + task); continue; } try { // å¤„ç† taskï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œé‡æ–°æ·»åŠ  task // ReAdd task if process failed if (!processor.process(task)) { retryFailedTask(taskKey, task); } } catch (Throwable e) { getEngineLog().error(\"Nacos task execute error \", e); retryFailedTask(taskKey, task); } } } // é‡æ–°æ·»åŠ  task private void retryFailedTask(Object key, AbstractDelayTask task) { task.setLastProcessTime(System.currentTimeMillis()); addTask(key, task); } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.task.PushDelayTaskExecuteEngine.PushDelayTaskProcessor // PushDelayTaskProcessor å¤„ç† PushDelayTask, é‡æ–°åŒ…è£…ä¸º PushExecuteTask, ç„¶åæ”¾å…¥çº¿ç¨‹æ± ä¸­è¿è¡Œ private static class PushDelayTaskProcessor implements NacosTaskProcessor { private final PushDelayTaskExecuteEngine executeEngine; public PushDelayTaskProcessor(PushDelayTaskExecuteEngine executeEngine) { this.executeEngine = executeEngine; } @Override public boolean process(NacosTask task) { PushDelayTask pushDelayTask = (PushDelayTask) task; Service service = pushDelayTask.getService(); NamingExecuteTaskDispatcher.getInstance() .dispatchAndExecuteTask(service, new PushExecuteTask(servi","date":"2023-08-22","objectID":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"05 ä»»åŠ¡æ‰§è¡Œå™¨çš„è®¾è®¡","uri":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.common.task.engine.NacosDelayTaskExecuteEngineTest ","date":"2023-08-22","objectID":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"05 ä»»åŠ¡æ‰§è¡Œå™¨çš„è®¾è®¡","uri":"/ooooo-notes/05-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":" æ—¶é—´è½®çš„ç”¨æ³• // é»˜è®¤é—´éš”æ—¶é—´ä¸º 100 æ¯«ç§’ Timer timer = new HashedWheelTimer(); Timeout timeout = timer.newTimeout(new TimerTask() { @Override public void run(Timeout timeout) throws Exception { System.out.println(\"run\"); } }, 10, TimeUnit.SECONDS); timer.stop(); ","date":"2023-08-22","objectID":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/:1:0","tags":["netty","source code","æºç åˆ†æ netty ç³»åˆ—"],"title":"æ—¶é—´è½®ç®—æ³•","uri":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/"},{"categories":null,"content":" æ—¶é—´è½®çš„åŸç† æœ‰ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œæ¯ä¸ªæ ¼å­éƒ½æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¯éš” interval æ—¶é—´ï¼ŒæŒ‡é’ˆå°±ä¼šç§»åŠ¨åˆ°ä¸‹ä¸€æ ¼ï¼Œç„¶åæŠŠé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‹¿å‡ºæ¥åˆ¤æ–­æ˜¯å¦åˆ°æœŸå¹¶æ‰§è¡Œã€‚ timer ","date":"2023-08-22","objectID":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/:2:0","tags":["netty","source code","æºç åˆ†æ netty ç³»åˆ—"],"title":"æ—¶é—´è½®ç®—æ³•","uri":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/"},{"categories":null,"content":" netty çš„æ—¶é—´è½®æºç ä½ç½®: io.netty.util.HashedWheelTimer#HashedWheelTimer // å…ˆæ¥çœ‹çœ‹æ„é€ å‡½æ•° // threadFactory: å¯ä»¥ç”¨æ¥æŒ‡å®šçº¿ç¨‹çš„åç§° // tickDuration, unit : é—´éš”æ—¶é—´ // ticksPerWheel: ç¯å½¢æ•°ç»„çš„å¤§å°, ä¹Ÿå°±æ˜¯æ—¶é—´è½®çš„å¤§å° // leakDetection: æ£€æŸ¥èµ„æºï¼Œé»˜è®¤å¼€å¯ // maxPendingTimeouts: å®šæ—¶ä»»åŠ¡ä¸Šé™ä¸ªæ•° // taskExecutor: ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œé»˜è®¤æ˜¯åŒæ­¥æ‰§è¡Œï¼Œå¯ä»¥è‡ªå®šä¹‰æ¥å¼‚æ­¥æ‰§è¡Œ public HashedWheelTimer( ThreadFactory threadFactory, long tickDuration, TimeUnit unit, int ticksPerWheel, boolean leakDetection, long maxPendingTimeouts, Executor taskExecutor) { checkNotNull(threadFactory, \"threadFactory\"); checkNotNull(unit, \"unit\"); checkPositive(tickDuration, \"tickDuration\"); checkPositive(ticksPerWheel, \"ticksPerWheel\"); this.taskExecutor = checkNotNull(taskExecutor, \"taskExecutor\"); // Normalize ticksPerWheel to power of two and initialize the wheel. // åˆ›å»ºæ—¶é—´è½®, å…¶å¤§å°æ˜¯ 2 çš„å€æ•°ï¼Œæœ€æ¥è¿‘äº ticksPerWheel wheel = createWheel(ticksPerWheel); mask = wheel.length - 1; // Convert tickDuration to nanos. long duration = unit.toNanos(tickDuration); // Prevent overflow. if (duration \u003e= Long.MAX_VALUE / wheel.length) { throw new IllegalArgumentException(String.format( \"tickDuration: %d (expected: 0 \u003c tickDuration in nanos \u003c %d\", tickDuration, Long.MAX_VALUE / wheel.length)); } if (duration \u003c MILLISECOND_NANOS) { logger.warn(\"Configured tickDuration {} smaller than {}, using 1ms.\", tickDuration, MILLISECOND_NANOS); this.tickDuration = MILLISECOND_NANOS; } else { this.tickDuration = duration; } // åˆ›å»º work çº¿ç¨‹ï¼Œæ¥è¿›è¡Œ sleep workerThread = threadFactory.newThread(worker); leak = leakDetection || !workerThread.isDaemon() ? leakDetector.track(this) : null; this.maxPendingTimeouts = maxPendingTimeouts; // æ—¶é—´è½®ä¸èƒ½å¼€å¯å¤ªå¤šï¼Œå› ä¸ºæ¯ä¸ªæ—¶é—´è½®éƒ½è¦ work çº¿ç¨‹æ¥è½®è¯¢ if (INSTANCE_COUNTER.incrementAndGet() \u003e INSTANCE_COUNT_LIMIT \u0026\u0026 WARNED_TOO_MANY_INSTANCES.compareAndSet(false, true)) { reportTooManyInstances(); } } // åˆ›å»ºæ—¶é—´è½®, å®é™…å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åé€šè¿‡ i++ % size æ¥è¾¾åˆ°ç¯å½¢æ•°ç»„ private static HashedWheelBucket[] createWheel(int ticksPerWheel) { //ticksPerWheel may not be greater than 2^30 checkInRange(ticksPerWheel, 1, 1073741824, \"ticksPerWheel\"); // ticksPerWheel æ˜¯ 2 çš„å€æ•° ticksPerWheel = normalizeTicksPerWheel(ticksPerWheel); HashedWheelBucket[] wheel = new HashedWheelBucket[ticksPerWheel]; for (int i = 0; i \u003c wheel.length; i ++) { wheel[i] = new HashedWheelBucket(); } return wheel; } æºç ä½ç½®: io.netty.util.HashedWheelTimer#newTimeout // æ·»åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ @Override public Timeout newTimeout(TimerTask task, long delay, TimeUnit unit) { checkNotNull(task, \"task\"); checkNotNull(unit, \"unit\"); long pendingTimeoutsCount = pendingTimeouts.incrementAndGet(); // åˆ¤æ–­å®šæ—¶ä»»åŠ¡çš„ä¸ªæ•° if (maxPendingTimeouts \u003e 0 \u0026\u0026 pendingTimeoutsCount \u003e maxPendingTimeouts) { pendingTimeouts.decrementAndGet(); throw new RejectedExecutionException(\"Number of pending timeouts (\" + pendingTimeoutsCount + \") is greater than or equal to maximum allowed pending \" + \"timeouts (\" + maxPendingTimeouts + \")\"); } // å¯åŠ¨ work çº¿ç¨‹ï¼Œè¿™é‡Œæ˜¯æ‡’åŠ è½½ï¼Œä¸€å®šæ˜¯æœ‰å®šæ—¶ä»»åŠ¡æ·»åŠ ï¼Œæ‰ä¼šå¯åŠ¨ start(); // Add the timeout to the timeout queue which will be processed on the next tick. // During processing all the queued HashedWheelTimeouts will be added to the correct HashedWheelBucket. // deadline è¡¨ç¤ºè¦ç­‰å¾…çš„é—´éš”æ—¶é—´ long deadline = System.nanoTime() + unit.toNanos(delay) - startTime; // Guard against overflow. if (delay \u003e 0 \u0026\u0026 deadline \u003c 0) { deadline = Long.MAX_VALUE; } // åˆ›å»º timeout, ç„¶åæ·»åŠ åˆ° timeouts é˜Ÿåˆ—ä¸­ï¼Œä¹‹å work çº¿ç¨‹ä¼šä»é˜Ÿåˆ—ä¸­è·å– HashedWheelTimeout timeout = new HashedWheelTimeout(this, task, deadline); timeouts.add(timeout); return timeout; } æºç ä½ç½®: io.netty.util.HashedWheelTimer#start // å¯åŠ¨ work çº¿ç¨‹ public void start() { // åˆ¤æ–­çŠ¶æ€ switch (WORKER_STATE_UPDATER.get(this)) { case WORKER_STATE_INIT: // å¯èƒ½å¤šçº¿ç¨‹å¯åŠ¨ï¼Œæ‰€ä»¥ cas åˆ¤æ–­ if (WORKER_STATE_UPDATER.compareAndSet(this, WORKER_STATE_INIT, WORKER_STATE_STARTED)) { // å¯åŠ¨ work çº¿ç¨‹ï¼Œæ‰§è¡Œ run æ–¹æ³• workerThread.start(); } break; case WORKER_STATE_STARTED: break; case WORKER_STATE_SHUTDOWN: throw new IllegalStateException(\"cannot be started once stopped\"); default: throw new Error(\"Invalid WorkerState\"); } // Wait until the startTime is initialized by the worker. while (startTime == 0) { try { startTimeInitialized.aw","date":"2023-08-22","objectID":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/:3:0","tags":["netty","source code","æºç åˆ†æ netty ç³»åˆ—"],"title":"æ—¶é—´è½®ç®—æ³•","uri":"/ooooo-notes/%E6%97%B6%E9%97%B4%E8%BD%AE%E7%AE%97%E6%B3%95/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ nacos è®¢é˜…æœåŠ¡ä¸»è¦åˆ†ä¸º http+udp å’Œ grpc è¿™ä¸¤ç§æ–¹å¼ï¼Œè¿™ä¸¤è€…çš„å†…éƒ¨è°ƒç”¨æ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸»è¦åˆ†æ http+udp çš„æ–¹å¼ã€‚ ","date":"2023-08-21","objectID":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"04 è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" è®¢é˜…æœåŠ¡çš„ curl curl --location 'localhost:8848/nacos/v2/ns/instance/list?serviceName=test' ","date":"2023-08-21","objectID":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"04 è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" è®¢é˜…æœåŠ¡çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.naming.controllers.v2.InstanceControllerV2#list // å¤„ç†è¯·æ±‚ public Result\u003cServiceInfo\u003e list(@RequestParam(value = \"namespaceId\", defaultValue = Constants.DEFAULT_NAMESPACE_ID) String namespaceId, @RequestParam(value = \"groupName\", defaultValue = Constants.DEFAULT_GROUP) String groupName, @RequestParam(\"serviceName\") String serviceName, @RequestParam(value = \"clusterName\", defaultValue = StringUtils.EMPTY) String clusterName, @RequestParam(value = \"ip\", defaultValue = StringUtils.EMPTY) String ip, @RequestParam(value = \"port\", defaultValue = \"0\") Integer port, @RequestParam(value = \"healthyOnly\", defaultValue = \"false\") Boolean healthyOnly, @RequestParam(value = \"app\", defaultValue = StringUtils.EMPTY) String app, @RequestHeader(value = HttpHeaderConsts.USER_AGENT_HEADER, required = false) String userAgent, @RequestHeader(value = HttpHeaderConsts.CLIENT_VERSION_HEADER, required = false) String clientVersion) { if (StringUtils.isEmpty(userAgent)) { userAgent = StringUtils.defaultIfEmpty(clientVersion, StringUtils.EMPTY); } String compositeServiceName = NamingUtils.getGroupedName(serviceName, groupName); // æ ¹æ® ip å’Œ port æ¥è¿›è¡Œ udp æ¨é€ Subscriber subscriber = new Subscriber(ip + \":\" + port, userAgent, app, ip, namespaceId, compositeServiceName, port, clusterName); // è·å–æ‰€æœ‰çš„å®ä¾‹ return Result.success(instanceServiceV2.listInstance(namespaceId, compositeServiceName, subscriber, clusterName, healthyOnly)); } æºç ä½ç½®: com.alibaba.nacos.naming.core.InstanceOperatorClientImpl#listInstance // è·å–æ‰€æœ‰çš„å®ä¾‹ @Override public ServiceInfo listInstance(String namespaceId, String serviceName, Subscriber subscriber, String cluster, boolean healthOnly) { Service service = getService(namespaceId, serviceName, true); // For adapt 1.X subscribe logic if (subscriber.getPort() \u003e 0 \u0026\u0026 pushService.canEnablePush(subscriber.getAgent())) { // clientId = address + ID_DELIMITER + ephemeral, è¿™ä¸ªå¾ˆé‡è¦ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ udp push String clientId = IpPortBasedClient.getClientId(subscriber.getAddrStr(), true); // æ ¹æ® udp çš„ ip å’Œ port æ¥åˆ›å»º client createIpPortClientIfAbsent(clientId); // æ·»åŠ è®¢é˜…, å®ç°ç±»åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ EphemeralClientOperationServiceImplï¼Œæ¥ä¸‹æ¥åˆ†æè¿™ä¸ª clientOperationService.subscribeService(service, subscriber, clientId); } ServiceInfo serviceInfo = serviceStorage.getData(service); ServiceMetadata serviceMetadata = metadataManager.getServiceMetadata(service).orElse(null); // æ ¹æ®æ¡ä»¶æ¥ç­›é€‰æœ€ç»ˆçš„ instances ServiceInfo result = ServiceUtil .selectInstancesWithHealthyProtection(serviceInfo, serviceMetadata, cluster, healthOnly, true, subscriber.getIp()); // adapt for v1.x sdk result.setName(NamingUtils.getGroupedName(result.getName(), result.getGroupName())); return result; } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.EphemeralClientOperationServiceImpl#subscribeService @Override public void subscribeService(Service service, Subscriber subscriber, String clientId) { // è·å–å•ä¾‹çš„ service Service singleton = ServiceManager.getInstance().getSingletonIfExist(service).orElse(service); Client client = clientManager.getClient(clientId); if (!clientIsLegal(client, clientId)) { return; } // client æ·»åŠ  service å’Œ subscriber client.addServiceSubscriber(singleton, subscriber); // è®¾ç½®æ›´æ–°æ—¶é—´ï¼Œä»¥é˜²è¢«è¿‡æœŸå®šæ—¶ä»»åŠ¡æ¸…ç†äº† client.setLastUpdatedTime(); // å‘å¸ƒ ClientSubscribeServiceEvent NotifyCenter.publishEvent(new ClientOperationEvent.ClientSubscribeServiceEvent(singleton, clientId)); } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.index.ClientServiceIndexesManager#handleClientOperation // ClientServiceIndexesManager ç›‘å¬ ClientSubscribeServiceEvent äº‹ä»¶ private void handleClientOperation(ClientOperationEvent event) { Service service = event.getService(); String clientId = event.getClientId(); if (event instanceof ClientOperationEvent.ClientRegisterServiceEvent) { addPublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientDeregisterServiceEvent) { removePublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientSubscribeServiceEvent) { // æ·»åŠ  service å¯¹åº”çš„ client","date":"2023-08-21","objectID":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"04 è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" å»¶æ—¶ä»»åŠ¡æ¨é€æ¯ä¸ª PushDelayTask åˆ°æœŸä¹‹åï¼Œéƒ½ä¼šè¢« PushDelayTaskProcessor æ¥å¤„ç†ï¼Œé‡æ–°åŒ…è£…ä¸º PushExecuteTask. æºç ä½ç½®: `` private static class PushDelayTaskProcessor implements NacosTaskProcessor { private final PushDelayTaskExecuteEngine executeEngine; public PushDelayTaskProcessor(PushDelayTaskExecuteEngine executeEngine) { this.executeEngine = executeEngine; } @Override public boolean process(NacosTask task) { PushDelayTask pushDelayTask = (PushDelayTask) task; Service service = pushDelayTask.getService(); // ä¸¢ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ¥æ‰§è¡Œ NamingExecuteTaskDispatcher.getInstance() .dispatchAndExecuteTask(service, new PushExecuteTask(service, executeEngine, pushDelayTask)); return true; } } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.task.PushExecuteTask#run // æ‰§è¡Œ push ä»»åŠ¡ public void run() { try { PushDataWrapper wrapper = generatePushData(); ClientManager clientManager = delayTaskEngine.getClientManager(); // è·å–æ‰€æœ‰æ¨é€çš„ clientId for (String each : getTargetClientIds()) { Client client = clientManager.getClient(each); if (null == client) { // means this client has disconnect continue; } // è·å– service å¯¹åº”çš„ subscriber Subscriber subscriber = client.getSubscriber(service); // skip if null if (subscriber == null) { continue; } // æ‰§è¡Œå…·ä½“çš„ push, æ¥ä¸‹æ¥çœ‹çœ‹æ˜¯å¦‚ä½•è·å–å¯¹åº”çš„ pushExecutor delayTaskEngine.getPushExecutor().doPushWithCallback(each, subscriber, wrapper, new ServicePushCallback(each, subscriber, wrapper.getOriginalData(), delayTask.isPushToAll())); } } catch (Exception e) { Loggers.PUSH.error(\"Push task for service\" + service.getGroupedServiceName() + \" execute failed \", e); delayTaskEngine.addTask(service, new PushDelayTask(service, 1000L)); } } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.executor.PushExecutorDelegate#doPushWithCallback @Override public void doPushWithCallback(String clientId, Subscriber subscriber, PushDataWrapper data, NamingPushCallback callBack) { getPushExecuteService(clientId, subscriber).doPushWithCallback(clientId, subscriber, data, callBack); } private PushExecutor getPushExecuteService(String clientId, Subscriber subscriber) { Optional\u003cSpiPushExecutor\u003e result = SpiImplPushExecutorHolder.getInstance() .findPushExecutorSpiImpl(clientId, subscriber); if (result.isPresent()) { return result.get(); } // è·å–å¯¹åº”çš„ pushExecuteService, ä¹‹å‰çš„ clientId = address + ID_DELIMITER + ephemeral // use nacos default push executor return clientId.contains(IpPortBasedClient.ID_DELIMITER) ? udpPushExecuteService : rpcPushExecuteService; } // udpPushExecuteService çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å‘é€ä¸€ä¸ª udp çš„æ•°æ®åŒ…ï¼Œè¿™é‡Œä¸ç»§ç»­åˆ†æäº†ã€‚ // rpcPushExecuteService çš„é€»è¾‘å°±æ˜¯å‘é€ä¸€ä¸ª rpc çš„æ•°æ®åŒ…ï¼Œåé¢çš„æ–‡ç« è¯¦è¯´ ","date":"2023-08-21","objectID":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"04 è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.SubscribeCluster_ITCase#subscribeAdd ","date":"2023-08-21","objectID":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"04 è®¢é˜…æœåŠ¡","uri":"/ooooo-notes/04-%E8%AE%A2%E9%98%85%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ ","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨é”€å®ä¾‹çš„ curl curl --location --request DELETE 'http://localhost:8848/nacos/v2/ns/instance' \\ --header 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'serviceName=test' \\ --data-urlencode 'ip=1.2.3.4' \\ --data-urlencode 'port=80' ","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨é”€å®ä¾‹çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.naming.controllers.v2.InstanceControllerV2#deregister public Result\u003cString\u003e deregister(InstanceForm instanceForm) throws NacosException { // check param instanceForm.validate(); checkWeight(instanceForm.getWeight()); // build instance Instance instance = buildInstance(instanceForm); // ç§»é™¤ instance instanceServiceV2.removeInstance(instanceForm.getNamespaceId(), buildCompositeServiceName(instanceForm), instance); // å‘å¸ƒ DeregisterInstanceTraceEvent äº‹ä»¶ NotifyCenter.publishEvent(new DeregisterInstanceTraceEvent(System.currentTimeMillis(), \"\", false, DeregisterInstanceReason.REQUEST, instanceForm.getNamespaceId(), instanceForm.getGroupName(), instanceForm.getServiceName(), instance.getIp(), instance.getPort())); return Result.success(\"ok\"); } æºç ä½ç½®: com.alibaba.nacos.naming.core.InstanceOperatorClientImpl#removeInstance @Override public void removeInstance(String namespaceId, String serviceName, Instance instance) { // åˆ¤æ–­ instance æ˜¯å¦å·²ç»æ³¨å†Œè¿‡, å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸ç”¨å¤„ç† boolean ephemeral = instance.isEphemeral(); String clientId = IpPortBasedClient.getClientId(instance.toInetAddr(), ephemeral); if (!clientManager.contains(clientId)) { Loggers.SRV_LOG.warn(\"remove instance from non-exist client: {}\", clientId); return; } Service service = getService(namespaceId, serviceName, ephemeral); // æ³¨é”€å®ä¾‹ï¼Œå¦‚æœæ˜¯ä¸´æ—¶å®ä¾‹ï¼ŒEphemeralClientOperationServiceImplï¼Œå¦‚æœæ˜¯æŒä¹…åŒ–å®ä¾‹ï¼ŒPersistentClientOperationServiceImpl clientOperationService.deregisterInstance(service, instance, clientId); } ","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" ä¸´æ—¶å®ä¾‹æ³¨é”€æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.EphemeralClientOperationServiceImpl#deregisterInstance @Override public void deregisterInstance(Service service, Instance instance, String clientId) { // åˆ¤æ–­ service æ˜¯å¦å­˜åœ¨ if (!ServiceManager.getInstance().containSingleton(service)) { Loggers.SRV_LOG.warn(\"remove instance from non-exist service: {}\", service); return; } Service singleton = ServiceManager.getInstance().getSingleton(service); Client client = clientManager.getClient(clientId); if (!clientIsLegal(client, clientId)) { return; } // ç§»é™¤å†…å­˜ä¸­çš„ instance å¯¹è±¡ï¼Œè¿™é‡Œä¼šå‘å¸ƒ ClientChangedEvent äº‹ä»¶ï¼Œè¿™ä¸ªå¾ˆé‡è¦ InstancePublishInfo removedInstance = client.removeServiceInstance(singleton); client.setLastUpdatedTime(); client.recalculateRevision(); if (null != removedInstance) { // å‘å¸ƒ ClientDeregisterServiceEvent äº‹ä»¶ NotifyCenter.publishEvent(new ClientOperationEvent.ClientDeregisterServiceEvent(singleton, clientId)); // å‘å¸ƒ InstanceMetadataEvent äº‹ä»¶ NotifyCenter.publishEvent( new MetadataEvent.InstanceMetadataEvent(singleton, removedInstance.getMetadataId(), true)); } } æºç ä½ç½®: com.alibaba.nacos.naming.consistency.ephemeral.distro.v2.DistroClientDataProcessor#syncToAllServer // DistroClientDataProcessor æ¥å— ClientChangedEvent, è´Ÿè´£åŒæ­¥æ•°æ®ç»™å…¶ä»–èŠ‚ç‚¹ private void syncToAllServer(ClientEvent event) { Client client = event.getClient(); // Only ephemeral data sync by Distro, persist client should sync by raft. if (null == client || !client.isEphemeral() || !clientManager.isResponsibleClient(client)) { return; } if (event instanceof ClientEvent.ClientDisconnectEvent) { DistroKey distroKey = new DistroKey(client.getClientId(), TYPE); distroProtocol.sync(distroKey, DataOperation.DELETE); } else if (event instanceof ClientEvent.ClientChangedEvent) { DistroKey distroKey = new DistroKey(client.getClientId(), TYPE); distroProtocol.sync(distroKey, DataOperation.CHANGE); } } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.index.ClientServiceIndexesManager#handleClientOperation // ClientServiceIndexesManager ä¼šç›‘å¬ ClientDeregisterServiceEvent äº‹ä»¶ private void handleClientOperation(ClientOperationEvent event) { Service service = event.getService(); String clientId = event.getClientId(); if (event instanceof ClientOperationEvent.ClientRegisterServiceEvent) { addPublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientDeregisterServiceEvent) { // ç§»é™¤ service çš„ clientId removePublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientSubscribeServiceEvent) { addSubscriberIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientUnsubscribeServiceEvent) { removeSubscriberIndexes(service, clientId); } } private void removePublisherIndexes(Service service, String clientId) { publisherIndexes.computeIfPresent(service, (s, ids) -\u003e { ids.remove(clientId); // å‘å¸ƒ ServiceChangedEvent äº‹ä»¶ NotifyCenter.publishEvent(new ServiceEvent.ServiceChangedEvent(service, true)); return ids.isEmpty() ? null : ids; }); } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.NamingSubscriberServiceV2Impl#onEvent // NamingSubscriberServiceV2Impl ä¼šç›‘å¬ ServiceChangedEvent äº‹ä»¶ @Override public void onEvent(Event event) { if (event instanceof ServiceEvent.ServiceChangedEvent) { // If service changed, push to all subscribers. // æ³¨é”€ instanceï¼Œ å¿…é¡»æ¨é€ç»™æ‰€æœ‰çš„è®¢é˜…è€… ServiceEvent.ServiceChangedEvent serviceChangedEvent = (ServiceEvent.ServiceChangedEvent) event; Service service = serviceChangedEvent.getService(); delayTaskEngine.addTask(service, new PushDelayTask(service, PushConfig.getInstance().getPushTaskDelay())); MetricsMonitor.incrementServiceChangeCount(service.getNamespace(), service.getGroup(), service.getName()); } else if (event instanceof ServiceEvent.ServiceSubscribedEvent) { // If service is subscribed by one client, only push this client. ServiceEvent.ServiceSubscribedEvent subscribedEvent = (ServiceEvent.ServiceSubscribedEvent) event; Service service = subscribedEvent.getService(); delayTaskEngine.addTask(service, new PushDelayTask(service,","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æŒä¹…åŒ–å®ä¾‹æ³¨é”€æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.PersistentClientOperationServiceImpl#deregisterInstance @Override public void deregisterInstance(Service service, Instance instance, String clientId) { final InstanceStoreRequest request = new InstanceStoreRequest(); request.setService(service); request.setInstance(instance); request.setClientId(clientId); // æ³¨æ„è¿™é‡Œçš„ groupï¼Œåœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œæ³¨å†Œå¯¹åº”çš„ processor final WriteRequest writeRequest = WriteRequest.newBuilder().setGroup(group()) .setData(ByteString.copyFrom(serializer.serialize(request))).setOperation(DataOperation.DELETE.name()) .build(); try { // ç”± CPProtcol å†™å…¥è¯·æ±‚åˆ°æœ¬åœ°ï¼Œç„¶ååŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæœ€ååº”ç”¨çŠ¶æ€æœº protocol.write(writeRequest); Loggers.RAFT.info(\"Client unregistered. service={}, clientId={}, instance={}\", service, instance, clientId); } catch (Exception e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, e); } } // æ„é€ å‡½æ•°ä¸­æ³¨å†Œ requestProcessor, è¿™ä¸ªå¯ä»¥åˆ†ç»„çš„ public PersistentClientOperationServiceImpl(final PersistentIpPortClientManager clientManager) { this.clientManager = clientManager; this.protocol = ApplicationUtils.getBean(ProtocolManager.class).getCpProtocol(); this.protocol.addRequestProcessors(Collections.singletonList(this)); } // å¤„ç†çŠ¶æ€æœº @Override public Response onApply(WriteRequest request) { final Lock lock = readLock; lock.lock(); try { final InstanceStoreRequest instanceRequest = serializer.deserialize(request.getData().toByteArray()); final DataOperation operation = DataOperation.valueOf(request.getOperation()); switch (operation) { case ADD: onInstanceRegister(instanceRequest.service, instanceRequest.instance, instanceRequest.getClientId()); break; case DELETE: // æ³¨é”€å®ä¾‹ onInstanceDeregister(instanceRequest.service, instanceRequest.getClientId()); break; case CHANGE: if (instanceAndServiceExist(instanceRequest)) { onInstanceRegister(instanceRequest.service, instanceRequest.instance, instanceRequest.getClientId()); } break; default: return Response.newBuilder().setSuccess(false).setErrMsg(\"unsupport operation : \" + operation) .build(); } return Response.newBuilder().setSuccess(true).build(); } catch (Exception e) { Loggers.RAFT.warn(\"Persistent client operation failed. \", e); return Response.newBuilder().setSuccess(false) .setErrMsg(\"Persistent client operation failed. \" + e.getMessage()).build(); } finally { lock.unlock(); } } // æ³¨é”€å®ä¾‹ï¼Œ è¿™é‡Œçš„é€»è¾‘å’Œä¸´æ—¶å®ä¾‹æ³¨é”€çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°±ä¸ç»§ç»­è§£æäº† private void onInstanceDeregister(Service service, String clientId) { Service singleton = ServiceManager.getInstance().getSingleton(service); Client client = clientManager.getClient(clientId); if (client == null) { Loggers.RAFT.warn(\"client not exist onInstanceDeregister, clientId : {} \", clientId); return; } // ç§»é™¤å†…å­˜çš„ instanceï¼Œå‘å¸ƒ ClientChangedEvent äº‹ä»¶ client.removeServiceInstance(singleton); client.setLastUpdatedTime(); if (client.getAllPublishedService().isEmpty()) { clientManager.clientDisconnected(clientId); } // å‘å¸ƒ ClientDeregisterServiceEvent äº‹ä»¶ NotifyCenter.publishEvent(new ClientOperationEvent.ClientDeregisterServiceEvent(singleton, clientId)); } ","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-20","objectID":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"03 æ³¨é”€å®ä¾‹","uri":"/ooooo-notes/03-%E6%B3%A8%E9%94%80%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ ","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨å†Œå®ä¾‹çš„ curl curl --location 'http://localhost:8848/nacos/v2/ns/instance' \\ --header 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'serviceName=test' \\ --data-urlencode 'ip=1.2.3.4' \\ --data-urlencode 'port=80' ","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æ³¨å†Œå®ä¾‹çš„ä¸»æµç¨‹æºç ä½ç½®: com.alibaba.nacos.naming.controllers.v2.InstanceControllerV2#register public Result\u003cString\u003e register(InstanceForm instanceForm) throws NacosException { // check param instanceForm.validate(); checkWeight(instanceForm.getWeight()); // build instance Instance instance = buildInstance(instanceForm); // æ³¨å†Œå®ä¾‹ instanceServiceV2.registerInstance(instanceForm.getNamespaceId(), buildCompositeServiceName(instanceForm), instance); // å‘å¸ƒ traceEvent NotifyCenter.publishEvent(new RegisterInstanceTraceEvent(System.currentTimeMillis(), \"\", false, instanceForm.getNamespaceId(), instanceForm.getGroupName(), instanceForm.getServiceName(), instance.getIp(), instance.getPort())); return Result.success(\"ok\"); } æºç ä½ç½®: com.alibaba.nacos.naming.core.InstanceOperatorClientImpl#registerInstance public void registerInstance(String namespaceId, String serviceName, Instance instance) throws NacosException { NamingUtils.checkInstanceIsLegal(instance); boolean ephemeral = instance.isEphemeral(); String clientId = IpPortBasedClient.getClientId(instance.toInetAddr(), ephemeral); // åˆ›å»º client createIpPortClientIfAbsent(clientId); // æ„å»º service å¯¹è±¡ï¼Œåœ¨ nacos2.0 ä¸­ï¼Œä¸´æ—¶å±æ€§åœ¨ service ä¸Š, instance çš„ä¸´æ—¶å±æ€§å·²ç»æ²¡æœ‰äº† Service service = getService(namespaceId, serviceName, ephemeral); // å…·ä½“å®ç°ç±»è´Ÿè´£æ³¨å†Œï¼Œå¦‚æœæ˜¯ä¸´æ—¶å®ä¾‹ï¼ŒEphemeralClientOperationServiceImplï¼Œå¦‚æœæ˜¯æŒä¹…åŒ–å®ä¾‹ï¼ŒPersistentClientOperationServiceImpl clientOperationService.registerInstance(service, instance, clientId); } ","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" ä¸´æ—¶å®ä¾‹æ³¨å†Œæºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.EphemeralClientOperationServiceImpl#registerInstance @Override public void registerInstance(Service service, Instance instance, String clientId) throws NacosException { NamingUtils.checkInstanceIsLegal(instance); // è·å¾—å•ä¾‹çš„ serviceï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šæ³¨å†Œ Service singleton = ServiceManager.getInstance().getSingleton(service); if (!singleton.isEphemeral()) { throw new NacosRuntimeException(NacosException.INVALID_PARAM, String.format(\"Current service %s is persistent service, can't register ephemeral instance.\", singleton.getGroupedServiceName())); } // è·å– clientï¼Œå¹¶æ£€æŸ¥ client Client client = clientManager.getClient(clientId); if (!clientIsLegal(client, clientId)) { return; } // InstancePublishInfo å°±æ˜¯ nacos å†…éƒ¨å®ä¾‹ InstancePublishInfo instanceInfo = getPublishInfo(instance); // æ·»åŠ  service å’Œ instanceï¼Œè¿™é‡Œä¼šå‘å¸ƒ ClientChangedEvent äº‹ä»¶ï¼Œéå¸¸é‡è¦ client.addServiceInstance(singleton, instanceInfo); client.setLastUpdatedTime(); client.recalculateRevision(); // å‘å¸ƒ ClientRegisterServiceEvent äº‹ä»¶ NotifyCenter.publishEvent(new ClientOperationEvent.ClientRegisterServiceEvent(singleton, clientId)); // å‘å¸ƒ InstanceMetadataEvent äº‹ä»¶ NotifyCenter .publishEvent(new MetadataEvent.InstanceMetadataEvent(singleton, instanceInfo.getMetadataId(), false)); } æºç ä½ç½®: com.alibaba.nacos.naming.consistency.ephemeral.distro.v2.DistroClientDataProcessor#syncToAllServer // DistroClientDataProcessor ä¼šç›‘å¬ ClientChangedEvent äº‹ä»¶ private void syncToAllServer(ClientEvent event) { Client client = event.getClient(); // Only ephemeral data sync by Distro, persist client should sync by raft. if (null == client || !client.isEphemeral() || !clientManager.isResponsibleClient(client)) { return; } if (event instanceof ClientEvent.ClientDisconnectEvent) { DistroKey distroKey = new DistroKey(client.getClientId(), TYPE); distroProtocol.sync(distroKey, DataOperation.DELETE); } else if (event instanceof ClientEvent.ClientChangedEvent) { DistroKey distroKey = new DistroKey(client.getClientId(), TYPE); // åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ distroProtocol.sync(distroKey, DataOperation.CHANGE); } } æºç ä½ç½®: com.alibaba.nacos.naming.core.v2.index.ClientServiceIndexesManager#handleClientOperation // ClientServiceIndexesManager ä¼šç›‘å¬ ClientRegisterServiceEvent äº‹ä»¶ private void handleClientOperation(ClientOperationEvent event) { Service service = event.getService(); String clientId = event.getClientId(); if (event instanceof ClientOperationEvent.ClientRegisterServiceEvent) { // æ·»åŠ  client çš„ publishIndex addPublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientDeregisterServiceEvent) { removePublisherIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientSubscribeServiceEvent) { addSubscriberIndexes(service, clientId); } else if (event instanceof ClientOperationEvent.ClientUnsubscribeServiceEvent) { removeSubscriberIndexes(service, clientId); } } private void addPublisherIndexes(Service service, String clientId) { // service å’Œ clientId æ˜¯ä¸€å¯¹å¤šçš„å…³ç³» publisherIndexes.computeIfAbsent(service, key -\u003e new ConcurrentHashSet\u003c\u003e()); publisherIndexes.get(service).add(clientId); // å‘å¸ƒ ServiceChangedEvent äº‹ä»¶ NotifyCenter.publishEvent(new ServiceEvent.ServiceChangedEvent(service, true)); } æºç ä½ç½®: com.alibaba.nacos.naming.push.v2.NamingSubscriberServiceV2Impl#onEvent // NamingSubscriberServiceV2Impl ç›‘å¬ ServiceChangedEvent public void onEvent(Event event) { if (event instanceof ServiceEvent.ServiceChangedEvent) { // If service changed, push to all subscribers. // service ä¸‹çš„ instance æ”¹å˜ä¹‹åï¼Œè¦æ¨é€ç»™æ‰€æœ‰çš„è®¢é˜…è€… ServiceEvent.ServiceChangedEvent serviceChangedEvent = (ServiceEvent.ServiceChangedEvent) event; Service service = serviceChangedEvent.getService(); delayTaskEngine.addTask(service, new PushDelayTask(service, PushConfig.getInstance().getPushTaskDelay())); MetricsMonitor.incrementServiceChangeCount(service.getNamespace(), service.getGroup(), service.getName()); } else if (event instanceof ServiceEvent.ServiceSubscribedEvent) { // If service is subscribed by one cl","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æŒä¹…åŒ–å®ä¾‹æ³¨å†Œæºç ä½ç½®: com.alibaba.nacos.naming.core.v2.service.impl.PersistentClientOperationServiceImpl#registerInstance @Override public void registerInstance(Service service, Instance instance, String clientId) { // å’Œä¸´æ—¶å®ä¾‹æ³¨å†Œä¸€æ ·ï¼Œè·å–å•ä¾‹çš„ service Service singleton = ServiceManager.getInstance().getSingleton(service); if (singleton.isEphemeral()) { throw new NacosRuntimeException(NacosException.INVALID_PARAM, String.format(\"Current service %s is ephemeral service, can't register persistent instance.\", singleton.getGroupedServiceName())); } // åŒ…è£…ä¸º writeRequest å¯¹è±¡ final InstanceStoreRequest request = new InstanceStoreRequest(); request.setService(service); request.setInstance(instance); request.setClientId(clientId); // è¿™é‡Œè®¾ç½®äº† groupï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ– group çš„ RequestProcessor final WriteRequest writeRequest = WriteRequest.newBuilder().setGroup(group()) .setData(ByteString.copyFrom(serializer.serialize(request))).setOperation(DataOperation.ADD.name()) .build(); try { // CPProtocol è´Ÿè´£å†™è¯·æ±‚ï¼ŒåŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ï¼Œç„¶ååº”ç”¨çŠ¶æ€æœº protocol.write(writeRequest); Loggers.RAFT.info(\"Client registered. service={}, clientId={}, instance={}\", service, instance, clientId); } catch (Exception e) { throw new NacosRuntimeException(NacosException.SERVER_ERROR, e); } } // æ„é€ å‡½æ•°ä¸­ï¼Œåˆå§‹åŒ–è¯äº† public PersistentClientOperationServiceImpl(final PersistentIpPortClientManager clientManager) { this.clientManager = clientManager; this.protocol = ApplicationUtils.getBean(ProtocolManager.class).getCpProtocol(); // è‡ªå·±è´Ÿè´£æ¥å¤„ç† apply WriteRequest this.protocol.addRequestProcessors(Collections.singletonList(this)); } // åº”ç”¨ raft çš„çŠ¶æ€æœº // protocol.write(writeRequest) ä¹‹å, å°±ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³• @Override public Response onApply(WriteRequest request) { final Lock lock = readLock; lock.lock(); try { final InstanceStoreRequest instanceRequest = serializer.deserialize(request.getData().toByteArray()); final DataOperation operation = DataOperation.valueOf(request.getOperation()); switch (operation) { case ADD: // å¤„ç†å®ä¾‹æ³¨å†Œ onInstanceRegister(instanceRequest.service, instanceRequest.instance, instanceRequest.getClientId()); break; case DELETE: onInstanceDeregister(instanceRequest.service, instanceRequest.getClientId()); break; case CHANGE: if (instanceAndServiceExist(instanceRequest)) { onInstanceRegister(instanceRequest.service, instanceRequest.instance, instanceRequest.getClientId()); } break; default: return Response.newBuilder().setSuccess(false).setErrMsg(\"unsupport operation : \" + operation) .build(); } return Response.newBuilder().setSuccess(true).build(); } catch (Exception e) { Loggers.RAFT.warn(\"Persistent client operation failed. \", e); return Response.newBuilder().setSuccess(false) .setErrMsg(\"Persistent client operation failed. \" + e.getMessage()).build(); } finally { lock.unlock(); } } // å¤„ç†å®ä¾‹æ³¨å†Œ, åŸºæœ¬å’Œä¸´æ—¶å®ä¾‹æ³¨å†Œä¸€æ ·, åé¢å°±ä¸é‡å¤åˆ†æäº† private void onInstanceRegister(Service service, Instance instance, String clientId) { // è·å– service å’Œ client Service singleton = ServiceManager.getInstance().getSingleton(service); if (!clientManager.contains(clientId)) { clientManager.clientConnected(clientId, new ClientAttributes()); } Client client = clientManager.getClient(clientId); InstancePublishInfo instancePublishInfo = getPublishInfo(instance); // æ·»åŠ  service å’Œ instanceï¼Œå‘å¸ƒ ClientChangedEvent äº‹ä»¶ client.addServiceInstance(singleton, instancePublishInfo); client.setLastUpdatedTime(); // å‘å¸ƒ ClientRegisterServiceEvent äº‹ä»¶ NotifyCenter.publishEvent(new ClientOperationEvent.ClientRegisterServiceEvent(singleton, clientId)); } ","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:4:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" æµ‹è¯•ç±»com.alibaba.nacos.test.naming.CPInstancesAPI_ITCase#registerInstance_ephemeral_true ","date":"2023-08-19","objectID":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/:5:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"02 æ³¨å†Œå®ä¾‹","uri":"/ooooo-notes/02-%E6%B3%A8%E5%86%8C%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":" nacos åŸºäº 2.2.4 ç‰ˆæœ¬ ","date":"2023-08-18","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:0:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"01 æ­å»º nacos æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" ä¸‹è½½æºç å’Œç¼–è¯‘ git clone git@github.com:alibaba/nacos.git mvn clean install -U -DskipTests ","date":"2023-08-18","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"01 æ­å»º nacos æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" é…ç½®ç¯å¢ƒå‚è€ƒ startup.sh æ–‡ä»¶ï¼Œæ·»åŠ ç›¸åº”çš„ jvm å’Œ program çš„å‚æ•°ã€‚ æ·»åŠ  jvm å‚æ•°ï¼Œ-Dnacos.standalone=true, å•æœºå¯åŠ¨ æ·»åŠ  jvm å‚æ•°ï¼Œ-Dnacos.home=/Users/ooooo/Code/Demo/nacos/distribution, é›†ç¾¤å¯åŠ¨ æ·»åŠ  program å‚æ•°ï¼Œ--spring.config.additional-location=/Users/ooooo/Code/Demo/nacos/distribution/conf/application.properties é…ç½® cluster.confï¼Œæ·»åŠ è‡ªå·±æœºå™¨çš„ ip é…ç½® application.properties, æ·»åŠ æ•°æ®åº“ç›¸å…³é…ç½®ï¼Œè„šæœ¬ä½ç½®åœ¨ /Users/ooooo/Code/Demo/nacos/distribution/conf/mysql-schema.sql ç›¸å…³æˆªå›¾å¦‚ä¸‹ï¼š run cluster-config application-properties ","date":"2023-08-18","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"01 æ­å»º nacos æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" å¯åŠ¨log ","date":"2023-08-18","objectID":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:3:0","tags":["nacos","source code","æºç åˆ†æ nacos ç³»åˆ—"],"title":"01 æ­å»º nacos æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/01-%E6%90%AD%E5%BB%BA-nacos-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 1. goreleaser çš„ç®€å•è¯´æ˜ # install goreleaser brew install goreleaser # init goreleaser, create .goreleaser.yml goreleaser init # available commands goreleaser build --clean goreleaser release --snapshot --clean ","date":"2023-08-01","objectID":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/:1:0","tags":["github","tools","goreleaser"],"title":"github ä¸Šä½¿ç”¨ goreleaser","uri":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/"},{"categories":null,"content":" 2. .goreleaser.yml ç¤ºä¾‹æ–‡ä»¶ # This is an example .goreleaser.yml file with some sensible defaults. # Make sure to check the documentation at https://goreleaser.com before: hooks: # You may remove this if you don't use go modules. - go mod tidy # you may remove this if you don't need go generate # - go generate ./... builds: - id: http-tunnel-client binary: http-tunnel-client main: ./cmd/http-tunnel-client env: - CGO_ENABLED=0 goos: - linux - windows - darwin goarch: - amd64 - arm64 - id: http-tunnel-server binary: http-tunnel-server main: ./cmd/http-tunnel-server env: - CGO_ENABLED=0 goos: - linux - windows - darwin goarch: - amd64 - arm64 archives: - format: tar.gz # this name template makes the OS and Arch compatible with the results of uname. name_template: \u003e- {{ .ProjectName }}_ {{- .Version }}_ {{- title .Os }}_ {{- .Arch }} {{- if .Arm }}v{{ .Arm }}{{ end }} # use zip for windows archives format_overrides: - goos: windows format: zip checksum: name_template: 'checksums.txt' snapshot: name_template: \"{{ incpatch .Version }}-next\" changelog: sort: asc filters: exclude: - '^docs:' - '^test:' # The lines beneath this are called `modelines`. See `:help modeline` # Feel free to remove those if you don't want/use them. # yaml-language-server: $schema=https://goreleaser.com/static/schema.json # vim: set ts=2 sw=2 tw=0 fo=cnqoj ","date":"2023-08-01","objectID":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/:2:0","tags":["github","tools","goreleaser"],"title":"github ä¸Šä½¿ç”¨ goreleaser","uri":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/"},{"categories":null,"content":" 3. github action é…ç½®æ–‡ä»¶è·¯å¾„ï¼š.github/workflows/goreleaser.yml name: goreleaser on: push: tags: - '*.*.*' # Trigger the workflow by mannually workflow_dispatch: jobs: goreleaser: runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@v3 with: fetch-depth: 0 - name: Set up Go uses: actions/setup-go@v4 with: go-version: '1.20' - name: Run GoReleaser uses: goreleaser/goreleaser-action@v4 with: version: latest args: release --clean env: GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} ","date":"2023-08-01","objectID":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/:3:0","tags":["github","tools","goreleaser"],"title":"github ä¸Šä½¿ç”¨ goreleaser","uri":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/"},{"categories":null,"content":" 4. github tokenread write permisson ","date":"2023-08-01","objectID":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/:4:0","tags":["github","tools","goreleaser"],"title":"github ä¸Šä½¿ç”¨ goreleaser","uri":"/ooooo-notes/github-%E4%B8%8A%E4%BD%BF%E7%94%A8-goreleaser/"},{"categories":null,"content":" 1. æ­å»º kafka ç¯å¢ƒè¿™é‡Œä½¿ç”¨ docker æ¥æ­å»ºã€‚ docker-compose.yml é…ç½®å¦‚ä¸‹ï¼Œå®¢æˆ·ç«¯ç«¯å£:9094 version: \"3\" services: kafka: image: 'bitnami/kafka:latest' ports: - '9092:9092' - '9094:9094' environment: - KAFKA_CFG_NODE_ID=0 - KAFKA_CFG_PROCESS_ROLES=controller,broker - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094 - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094 - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:SASL_PLAINTEXT,PLAINTEXT:PLAINTEXT - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093 - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER - KAFKA_CLIENT_USERS=user - KAFKA_CLIENT_PASSWORDS=password - KAFKA_CLIENT_LISTENER_NAME=SASL_PLAINTEXT å¯åŠ¨kafka docker-compose up -d ","date":"2023-08-01","objectID":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/:1:0","tags":["kafka"],"title":"kafka çš„ SASL è®¤è¯","uri":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":" 2. å®¢æˆ·ç«¯è¿æ¥é…ç½® spring: kafka: bootstrap-servers: localhost:9094 properties: security.protocol: SASL_PLAINTEXT sasl.jaas.config: org.apache.kafka.common.security.scram.ScramLoginModule required username='user' password='password'; sasl.mechanism: SCRAM-SHA-512 ","date":"2023-08-01","objectID":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/:2:0","tags":["kafka"],"title":"kafka çš„ SASL è®¤è¯","uri":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":" 3. å‚è€ƒ docker kafka kafka sasl ","date":"2023-08-01","objectID":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/:3:0","tags":["kafka"],"title":"kafka çš„ SASL è®¤è¯","uri":"/ooooo-notes/kafka-%E7%9A%84-sasl-%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":" websocket ","date":"2023-07-31","objectID":"/ooooo-notes/protocols/:0:0","tags":["protocol"],"title":"protocols","uri":"/ooooo-notes/protocols/"},{"categories":null,"content":" 1. HttpHelloWorldServerHandler ä¸ºå•¥éœ€è¦ä½¿ç”¨ SimpleChannelInboundHandler ?HttpObject çš„å­ç±»æœ‰ LastHttpContent, HttpContent, HttpDataï¼Œ å®ƒéœ€è¦æ‰‹åŠ¨è°ƒç”¨ release()ã€‚ ","date":"2023-07-30","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-netty-%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9/:1:0","tags":["netty"],"title":"ä½¿ç”¨ netty çš„æ³¨æ„ç‚¹","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-netty-%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9/"},{"categories":null,"content":" 1. ä»£ç åœ¨è‡ªå®šä¹‰å°è£… MQ æ—¶ï¼Œè¦æ³¨æ„ producer å’Œ consumer çš„åˆå§‹åŒ–æ—¶æœºï¼Œå¦åˆ™ä¼šå‡ºç° consumer å ç”¨ consumerQueue çš„æƒ…å†µ @Slf4j public class RocketMQHandler extends AbstractMQHandler { private final RocketMQConfig config; private final Supplier\u003cDefaultMQProducer\u003e producer; private final Supplier\u003cDefaultLitePullConsumer\u003e consumer; public RocketMQHandler(RocketMQProperties properties, RocketMQConfig config) { this.config = config; // è¿™é‡Œè¦å»¶è¿Ÿåˆå§‹åŒ–ï¼Œå¦åˆ™å¯åŠ¨ consumer å ç”¨ consumerQueue this.producer = SingletonSupplier.of(() -\u003e createProducer(properties, config)); this.consumer = SingletonSupplier.of(() -\u003e createConsumer(properties, config)); } @SneakyThrows @Override public void send(String message) { Message m = new Message(config.getDestinationName(), message.getBytes(StandardCharsets.UTF_8)); if (log.isTraceEnabled()) { log.trace(\"{} send message: {}\", RocketMQHandler.this.getClass().getSimpleName(), message); } producer.get().send(m); } @Override public void receive(MQListener listener) { ConsumerTask task = new ConsumerTask(listener); executorService.schedule(task, PULL_PERIOD, TimeUnit.MILLISECONDS); } @AllArgsConstructor private class ConsumerTask implements Runnable { private MQListener listener; @Override public void run() { List\u003cMessageExt\u003e msgs = consumer.get().poll(PULL_PERIOD); if (CollectionUtils.isNotEmpty(msgs)) { msgs.forEach(m -\u003e { String message = new String(m.getBody(), StandardCharsets.UTF_8); if (log.isTraceEnabled()) { log.trace(\"{} receive message: {}\", RocketMQHandler.this.getClass().getSimpleName(), message); } listener.onMessage(message); }); } executorService.schedule(this, PULL_PERIOD, TimeUnit.MILLISECONDS); } } @SneakyThrows private DefaultMQProducer createProducer(RocketMQProperties properties, RocketMQConfig config) { DefaultMQProducer producer = new DefaultMQProducer(config.getProducerGroup()); producer.setNamesrvAddr(properties.getNamesrvAddr()); producer.start(); return producer; } @SneakyThrows private DefaultLitePullConsumer createConsumer(RocketMQProperties properties, RocketMQConfig config) { DefaultLitePullConsumer consumer = new DefaultLitePullConsumer(config.getConsumerGroup()); consumer.setNamesrvAddr(properties.getNamesrvAddr()); switch (config.getConsumeMode()) { case P2P: consumer.setMessageModel(MessageModel.CLUSTERING); break; case BROADCAST: consumer.setMessageModel(MessageModel.BROADCASTING); break; } consumer.subscribe(config.getDestinationName(), \"*\"); consumer.start(); return consumer; } } ","date":"2023-07-07","objectID":"/ooooo-notes/rocketmq-%E7%9A%84-litepullconsumer-%E4%BD%BF%E7%94%A8/:1:0","tags":["spring","rocketmq"],"title":"rocketmq çš„ LitePullConsumer ä½¿ç”¨","uri":"/ooooo-notes/rocketmq-%E7%9A%84-litepullconsumer-%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 1. é…ç½® dubbo: application: parameters: registry-type: service registries: a: address: nacos://172.16.1.104:7848 group: DUBBO_SERVICE_GROUP parameters: namespace: a b: address: nacos://172.16.1.104:7848 group: DUBBO_SERVICE_GROUP parameters: namespace: b ","date":"2023-07-03","objectID":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/:1:0","tags":["dubbo"],"title":"dubbo3 å¤šæ³¨å†Œä¸­å¿ƒçš„å° bug","uri":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/"},{"categories":null,"content":" 2. é—®é¢˜åªä¼šæ³¨å†Œåˆ°ä¸€ä¸ª namespace ä¸­ ","date":"2023-07-03","objectID":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/:2:0","tags":["dubbo"],"title":"dubbo3 å¤šæ³¨å†Œä¸­å¿ƒçš„å° bug","uri":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/"},{"categories":null,"content":" 3. githubdubbo issue ","date":"2023-07-03","objectID":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/:3:0","tags":["dubbo"],"title":"dubbo3 å¤šæ³¨å†Œä¸­å¿ƒçš„å° bug","uri":"/ooooo-notes/dubbo3-%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%B0%8Fbug/"},{"categories":null,"content":" 1. é—®é¢˜åœ¨çœŸå®çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¸åŒçš„ mapper æ¥å£ä½¿ç”¨çš„ sqlSessionFactory ä¸ä¸€æ ·ã€‚å°±æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚ // è¿™ä¸ªæ³¨è§£è™½ç„¶å¯ä»¥æŒ‡å®š sqlSessionFactory, ä½†æ˜¯æœ€ç»ˆä½¿ç”¨çš„ configuration å¯¹è±¡æ˜¯åŒä¸€ä»½ã€‚ @MapperScan(\"com.ooooo.**.mapper1\") @MapperScan(\"com.ooooo.**.mapper2\") public class DemoApplication { public static void main(String[] args) { SpringApplication.run(DemoApplication.class, args); } } ","date":"2023-06-08","objectID":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/:1:0","tags":["spring","mybatis"],"title":"mybatis-plus è‡ªå®šä¹‰ mapper","uri":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/"},{"categories":null,"content":" 2. è§£å†³æ–¹å¼å¯ä»¥ä½¿ç”¨ MapperFactoryBean æ¥æ‰©å±•ï¼Œä¸‹é¢æˆ‘ç»™å‡ºç›¸åº”çš„ç¤ºä¾‹ä»£ç ã€‚ @Configuration public class ComponentConfigMybatiPlusConfiguration { @Getter public static SqlSessionFactory sqlSessionFactory; @Bean public MapperFactoryBean\u003cComponentTreeMapper\u003e componentTreeMapper() { return createMapper(ComponentTreeMapper.class); } private \u003cT\u003e MapperFactoryBean\u003cT\u003e createMapper(Class\u003cT\u003e clazz) { MapperFactoryBean\u003cT\u003e factoryBean = new MapperFactoryBean\u003c\u003e(clazz); factoryBean.setSqlSessionFactory(sqlSessionFactory()); return factoryBean; } private synchronized SqlSessionFactory sqlSessionFactory() { if (sqlSessionFactory != null) { return sqlSessionFactory; } // ä½¿ç”¨é»˜è®¤çš„dataSource DataSource dataSource = SpringUtil.getBean(DataSource.class); Environment environment = new Environment(COMPONENT_CONFIG, new SpringManagedTransactionFactory(), dataSource); // build configuration MybatisConfiguration configuration = new MybatisConfiguration(); configuration.setEnvironment(environment); configuration.setCacheEnabled(false); configuration.setLocalCacheScope(LocalCacheScope.STATEMENT); setInterceptors(configuration); setMapperLocations(configuration, new String[]{\"classpath*:/mapper/**/*.xml\"}); setGlobalConfig(configuration); // factory sqlSessionFactory = new MybatisSqlSessionFactoryBuilder().build(configuration); return sqlSessionFactory; } private void setInterceptors(MybatisConfiguration configuration) { MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor(); mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor()); configuration.addInterceptor(mybatisPlusInterceptor); } private void setMapperLocations(MybatisConfiguration configuration, String[] mapperLocations) { ResourcePatternResolver resourceResolver = new PathMatchingResourcePatternResolver(); for (String mapperLocation : mapperLocations) { try { Resource[] resources = resourceResolver.getResources(mapperLocation); for (Resource resource : resources) { if (resource.exists()) { XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(resource.getInputStream(), configuration, resource.toString(), configuration.getSqlFragments()); xmlMapperBuilder.parse(); } } } catch (IOException ignored) { } } } private void setGlobalConfig(MybatisConfiguration configuration) { GlobalConfig globalConfig = GlobalConfigUtils.getGlobalConfig(configuration); // MetaObjectHandler globalConfig.setMetaObjectHandler(new ComponentMetaObjectHandler()); } } ","date":"2023-06-08","objectID":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/:2:0","tags":["spring","mybatis"],"title":"mybatis-plus è‡ªå®šä¹‰ mapper","uri":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/"},{"categories":null,"content":" æ‰‹åŠ¨åˆ›å»º Mapper // ç”¨æ³• DataSource dataSource = DBUtil.buildDataSource(dbProperties); SqlSession sqlSession = DBUtil.buildSqlSession(dbProperties.getName(), dataSource, MockInfoMapper.class); mockInfoMapper = sqlSession.getMapper(MockInfoMapper.class); // å·¥å…·ç±» public class DBUtil { public static DataSource buildDataSource(AbstractDBProperties dbProperties) { HikariConfig config = new HikariConfig(); config.setPoolName(\"pool-\" + dbProperties.getName()); config.setDriverClassName(dbProperties.getDriverClassName()); config.setJdbcUrl(dbProperties.getUrl()); config.setUsername(dbProperties.getUsername()); config.setPassword(dbProperties.getPassword()); return new HikariDataSource(config); } public static SqlSessionTemplate buildSqlSession(String id, DataSource dataSource, Class\u003c?\u003e... mapperClazz) { Environment environment = new Environment(id, new SpringManagedTransactionFactory(), dataSource); MybatisConfiguration configuration = new MybatisConfiguration(environment); if (ArrayUtil.isNotEmpty(mapperClazz)) { for (Class\u003c?\u003e clazz : mapperClazz) { configuration.addMapper(clazz); } } configuration.addInterceptor(buildInterceptor()); SqlSessionFactory sqlSessionFactory = new MybatisSqlSessionFactoryBuilder().build(configuration); return new SqlSessionTemplate(sqlSessionFactory); } private static MybatisPlusInterceptor buildInterceptor() { MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor(); interceptor.addInnerInterceptor(new PaginationInnerInterceptor()); return interceptor; } } ","date":"2023-06-08","objectID":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/:3:0","tags":["spring","mybatis"],"title":"mybatis-plus è‡ªå®šä¹‰ mapper","uri":"/ooooo-notes/mybatis-plus-%E8%87%AA%E5%AE%9A%E4%B9%89-mapper/"},{"categories":null,"content":" 1. åœ¨ docker ä¸Šå®‰è£… harbor # ä¸‹è½½harbor wget https://github.com/goharbor/harbor/releases/download/v2.8.1/harbor-offline-installer-v2.8.1.tgz # ç”ŸæˆCAç§˜é’¥ openssl genrsa -out ca.key 4096 # ç”ŸæˆCAè¯ä¹¦ openssl req -x509 -new -nodes -sha512 -days 3650 \\ -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com\" \\ -key ca.key \\ -out ca.crt # ç”Ÿæˆç§˜é’¥ openssl genrsa -out yourdomain.com.key 4096 # ç”Ÿæˆè¯ä¹¦è¯·æ±‚ openssl req -sha512 -new \\ -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=yourdomain.com\" \\ -key yourdomain.com.key \\ -out yourdomain.com.csr # ç”Ÿæˆè¯ä¹¦ cat \u003e v3.ext \u003c\u003c-EOF authorityKeyIdentifier=keyid,issuer basicConstraints=CA:FALSE keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment extendedKeyUsage = serverAuth subjectAltName = @alt_names [alt_names] DNS.1=yourdomain.com DNS.2=yourdomain DNS.3=hostname EOF openssl x509 -req -sha512 -days 3650 \\ -extfile v3.ext \\ -CA ca.crt -CAkey ca.key -CAcreateserial \\ -in yourdomain.com.csr \\ -out yourdomain.com.crt # å¤åˆ¶åˆ°harborä¸­ï¼Œ /data/cert/ æ˜¯harborçš„è¯ä¹¦ç›®å½• cp yourdomain.com.crt /data/cert/ cp yourdomain.com.key /data/cert/ # è½¬æ¢ä¸ºcertæ ¼å¼, ç»™dockerä½¿ç”¨ openssl x509 -inform PEM -in yourdomain.com.crt -out yourdomain.com.cert # å¤åˆ¶åˆ°dockerä¸­ï¼Œè¿™é‡Œæ˜¯åŒå‘tls cp yourdomain.com.cert /etc/docker/certs.d/yourdomain.com/ cp yourdomain.com.key /etc/docker/certs.d/yourdomain.com/ cp ca.crt /etc/docker/certs.d/yourdomain.com/ # é‡å¯docker,åŠ è½½è¯ä¹¦ systemctl restart docker # æ‰§è¡Œharborè„šæœ¬ï¼Œå¯åŠ¨harbor ./prepare # å…³é—­ harbor docker-compose down -v # å¯åŠ¨ harbor docker-compose up -d # éªŒè¯docker docker login yourdomain.com harborå®˜æ–¹æ–‡æ¡£ ","date":"2023-06-02","objectID":"/ooooo-notes/%E5%AE%89%E8%A3%85-harbor/:1:0","tags":["docker","harbor"],"title":"å®‰è£… harbor","uri":"/ooooo-notes/%E5%AE%89%E8%A3%85-harbor/"},{"categories":null,"content":" 2. containerd é…ç½® harbor # å¤åˆ¶è¯ä¹¦åˆ°containerd mkdir /etc/containerd/yourdomain.com cp ca.crt /etc/containerd/yourdomain.com/ # é…ç½®containerd vim /etc/containerd/config.toml #é…ç½®endpointè¿æ¥åœ°å€ [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors] [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"yourdomain.com\"] endpoint = [\"https://yourdomain.com\"] #é…ç½®caæ–‡ä»¶è·¯å¾„å’Œç”¨æˆ·åå¯†ç  [plugins.\"io.containerd.grpc.v1.cri\".registry.configs] [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"yourdomain.com\".tls] ca_file = \"/etc/containerd/yourdomain.com/ca.crt\" [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"yourdomain.com\".auth] username = \"admin\" password = \"Harbor12345\" åšå®¢ ","date":"2023-06-02","objectID":"/ooooo-notes/%E5%AE%89%E8%A3%85-harbor/:2:0","tags":["docker","harbor"],"title":"å®‰è£… harbor","uri":"/ooooo-notes/%E5%AE%89%E8%A3%85-harbor/"},{"categories":null,"content":" 1. nacos çš„ç«¯å£nacos çš„ http ç«¯å£ä¸º 8848ï¼Œä½†æ˜¯ nacos2.0 ä¹‹åä½¿ç”¨ grpc ç«¯å£, è€Œä¸”æ˜¯åç§»é‡è®¡ç®—çš„ï¼Œæ‰€ä»¥ä½¿ç”¨ nginx ä»£ç†å°±æœ‰å‘ã€‚ å¯¹äº spring æ¥è¯´, å¯ä»¥é…ç½®å¤šä¸ªåœ°å€ spring: cloud: nacos: server-addr: 172.168.0.101:8848,172.168.0.102:8848,172.168.0.103:8848 ","date":"2023-06-01","objectID":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/:1:0","tags":["nacos","spring"],"title":"nacos é›†ç¾¤ç”¨ nginx ä»£ç†é—®é¢˜","uri":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 2. æºç å‘é€è¯·æ±‚çš„æ–¹æ³• com.alibaba.nacos.common.remote.client.grpc.GrpcConnection#request @Override public Response request(Request request, long timeouts) throws NacosException { Payload grpcRequest = GrpcUtils.convert(request); // å‘é€è¯·æ±‚ ListenableFuture\u003cPayload\u003e requestFuture = grpcFutureServiceStub.request(grpcRequest); Payload grpcResponse; try { grpcResponse = requestFuture.get(timeouts, TimeUnit.MILLISECONDS); } catch (Exception e) { throw new NacosException(NacosException.SERVER_ERROR, e); } return (Response) GrpcUtils.parse(grpcResponse); } åˆ›å»º grpcå®¢æˆ·ç«¯ çš„æ–¹æ³• com.alibaba.nacos.common.remote.client.grpc.GrpcClient#connectToServer @Override public Connection connectToServer(ServerInfo serverInfo) { try { if (grpcExecutor == null) { this.grpcExecutor = createGrpcExecutor(serverInfo.getServerIp()); } // è¿™é‡Œå°±æ˜¯è®¡ç®—ç«¯å£çš„é€»è¾‘ï¼Œ serverPort é»˜è®¤ä¸º 8848ï¼Œ rpcPortOffset ä¸º 1000 int port = serverInfo.getServerPort() + rpcPortOffset(); ManagedChannel managedChannel = createNewManagedChannel(serverInfo.getServerIp(), port); // æ–°å»º RequestGrpc.RequestFutureStub newChannelStubTemp = createNewChannelStub(managedChannel); if (newChannelStubTemp != null) { Response response = serverCheck(serverInfo.getServerIp(), port, newChannelStubTemp); if (response == null || !(response instanceof ServerCheckResponse)) { shuntDownChannel(managedChannel); return null; } BiRequestStreamGrpc.BiRequestStreamStub biRequestStreamStub = BiRequestStreamGrpc .newStub(newChannelStubTemp.getChannel()); GrpcConnection grpcConn = new GrpcConnection(serverInfo, grpcExecutor); grpcConn.setConnectionId(((ServerCheckResponse) response).getConnectionId()); //create stream request and bind connection event to this connection. StreamObserver\u003cPayload\u003e payloadStreamObserver = bindRequestStream(biRequestStreamStub, grpcConn); // stream observer to send response to server grpcConn.setPayloadStreamObserver(payloadStreamObserver); grpcConn.setGrpcFutureServiceStub(newChannelStubTemp); grpcConn.setChannel(managedChannel); //send a setup request. ConnectionSetupRequest conSetupRequest = new ConnectionSetupRequest(); conSetupRequest.setClientVersion(VersionUtils.getFullClientVersion()); conSetupRequest.setLabels(super.getLabels()); conSetupRequest.setAbilities(super.clientAbilities); conSetupRequest.setTenant(super.getTenant()); grpcConn.sendRequest(conSetupRequest); //wait to register connection setup Thread.sleep(100L); return grpcConn; } return null; } catch (Exception e) { LOGGER.error(\"[{}]Fail to connect to server!,error={}\", GrpcClient.this.getName(), e); } return null; } ","date":"2023-06-01","objectID":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/:2:0","tags":["nacos","spring"],"title":"nacos é›†ç¾¤ç”¨ nginx ä»£ç†é—®é¢˜","uri":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 3. å‚è€ƒ å®˜æ–¹æ–‡æ¡£-ç«¯å£è¯´æ˜ ","date":"2023-06-01","objectID":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/:3:0","tags":["nacos","spring"],"title":"nacos é›†ç¾¤ç”¨ nginx ä»£ç†é—®é¢˜","uri":"/ooooo-notes/nacos-%E9%9B%86%E7%BE%A4%E7%94%A8-nginx-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" æˆ‘åœ¨ chrome å®‰è£…äº† SwitchyOmega ä»£ç†æ’ä»¶ï¼Œå¯¼è‡´èµ„æºåŠ è½½æœ‰é—®é¢˜ã€‚ æ£€æŸ¥ clash ä»£ç†ï¼Œåˆ·æ–° dns é…ç½®ï¼Œè¯•è¯•å…¨å±€ä»£ç† å¯ä»¥å¢åŠ  SwitchyOmega é…ç½® ","date":"2023-05-27","objectID":"/ooooo-notes/github-page-%E5%9B%BE%E7%89%87%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE/:0:0","tags":["resolution"],"title":"github page å›¾ç‰‡æ— æ³•è®¿é—®","uri":"/ooooo-notes/github-page-%E5%9B%BE%E7%89%87%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE/"},{"categories":null,"content":" -n ä»¥æ•°å­—æ˜¾ç¤º -X æ˜¾ç¤ºåŒ…ä½“ -i æŒ‡å®šç½‘å¡ -w å†™å…¥æ–‡ä»¶ -c åŒ…çš„ä¸ªæ•° ","date":"2023-05-24","objectID":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/:0:0","tags":["linux"],"title":"tcpdump å¸¸ç”¨å‘½ä»¤","uri":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" 1. æŒ‡å®šç«¯å£ tcpdump -n -X -i any port 1234 -w 1.cap ","date":"2023-05-24","objectID":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/:1:0","tags":["linux"],"title":"tcpdump å¸¸ç”¨å‘½ä»¤","uri":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" 2. æŒ‡å®šä¸»æœº tcpdump -n -X -i any host 192.168.0.101 -w 1.cap ","date":"2023-05-24","objectID":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/:2:0","tags":["linux"],"title":"tcpdump å¸¸ç”¨å‘½ä»¤","uri":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" 3. å…¶ä»– # ç›‘è§†æŒ‡å®šä¸»æœºå’Œç«¯å£çš„æ•°æ®åŒ… tcpdump -i ens33 port 8080 and host node1 # ç›‘è§†æŒ‡å®šç½‘ç»œçš„æ•°æ®åŒ…ï¼Œå¦‚æœ¬æœºä¸192.168ç½‘æ®µé€šä¿¡çš„æ•°æ®åŒ…ï¼Œ\"-c 10\"è¡¨ç¤ºåªæŠ“å–10ä¸ªåŒ… tcpdump -i ens33 -c 10 net 192.168 # æŠ“å–pingåŒ… tcpdump -c 5 -nn -i eth0 icmp and src 192.168.100.62 ","date":"2023-05-24","objectID":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/:3:0","tags":["linux"],"title":"tcpdump å¸¸ç”¨å‘½ä»¤","uri":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" 3.å‚è€ƒ tcpdumpè¯´æ˜ ","date":"2023-05-24","objectID":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/:4:0","tags":["linux"],"title":"tcpdump å¸¸ç”¨å‘½ä»¤","uri":"/ooooo-notes/tcpdump-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"categories":null,"content":" 1. æ£€æŸ¥æœ¬æœºçš„ dns é…ç½® # å»ºè®®ä¸è¦é…ç½® searchï¼Œé™¤éä½ è‡ªå·±æ˜ç¡®, å¯ç”¨çš„ dns åŸŸåï¼Œå¦‚ 8.8.8.8 # ä¿®æ”¹åï¼Œcentosç³»ç»Ÿä¸éœ€è¦é‡å¯ NetworkManager, é‡å¯å¯èƒ½è¢«è¦†ç›– cat /etc/resolv.conf # é‡å¯ kubelet systemctl restart kubelet # é‡å¯ k8s pod kubectl rollout restart deploy ","date":"2023-05-19","objectID":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/:1:0","tags":["resolution","k8s","dns","cloud native"],"title":"k8s ä¸­çš„ dns é—®é¢˜","uri":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 2. æ£€æŸ¥ pod çš„ dns é…ç½® # è¿›å…¥å®¹å™¨ä¸­ kubectl debug -it some-pod --image=busybox -- sh # åœ¨å®¹å™¨ä¸­æŸ¥çœ‹ dns é…ç½®, è¿™é‡Œä¸€å®šè¦æ˜¯ coredns çš„ clusterIP, å¦‚æœä¸å¯¹ï¼Œæ£€æŸ¥ kubelet çš„ dns é…ç½® cat /etc/resolv.conf # åœ¨å®¹å™¨ä¸­æŸ¥çœ‹ hosts é…ç½® cat /etc/hosts ","date":"2023-05-19","objectID":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/:2:0","tags":["resolution","k8s","dns","cloud native"],"title":"k8s ä¸­çš„ dns é—®é¢˜","uri":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 3. æ£€æŸ¥å¹¶é…ç½® coredns é…ç½® # æ£€æŸ¥é…ç½® kubectl get cm coredns -n kube-system -oyaml # è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚æ·»åŠ  hosts é…ç½® kubectl apply -f - \u003c\u003cEOF apiVersion: v1 data: Corefile: | .:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 # æ·»åŠ  hosts é…ç½® hosts { 172.16.1.36 git.abc.com fallthrough } # ä¸è½¬å‘åˆ° /etc/resolv.conf forward . 8.8.8.8 cache 30 loop reload loadbalance } kind: ConfigMap metadata: name: coredns namespace: kube-system EOF ","date":"2023-05-19","objectID":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/:3:0","tags":["resolution","k8s","dns","cloud native"],"title":"k8s ä¸­çš„ dns é—®é¢˜","uri":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 4. é—®é¢˜ç°è±¡tektonçš„ pod dns æ˜¾ç¤ºé”™è¯¯ï¼Œé‡æ–°è®¾ç½®ä¸»æœºçš„ /etc/resolv.conf, é‡å¯ kubeletï¼Œ é‡å¯ tekton. ","date":"2023-05-19","objectID":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/:4:0","tags":["resolution","k8s","dns","cloud native"],"title":"k8s ä¸­çš„ dns é—®é¢˜","uri":"/ooooo-notes/k8s-%E4%B8%AD%E7%9A%84-dns-%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" # open target dir cd /etc/netplan # edit config file, you must creat if not exist sudo vim 00-installer-config.yaml # network device setting template network: ethernets: ens33: #dhcp4: yes dhcp4: no addresses: - 192.168.130.129/24 routes: - to: default via: 192.168.130.2 #nameservers: # addresses: [192.168.130.2] version: 2 # netplan apply sudo netplan apply # restart reboot ","date":"2023-04-01","objectID":"/ooooo-notes/ubuntu-add-static-ip/:0:0","tags":["ubuntu","resolution"],"title":"ubuntu add static ip","uri":"/ooooo-notes/ubuntu-add-static-ip/"},{"categories":null,"content":" 1. æ–‡ä»¶å¤¹æƒé™ Volume ä¸º hostPath, è¦æ³¨æ„æ–‡ä»¶å¤¹æƒé™ï¼Œ chmod 777 /data ","date":"2023-03-21","objectID":"/ooooo-notes/k8s-%E7%9A%84%E5%B0%8F%E9%97%AE%E9%A2%98/:1:0","tags":["k8s","cloud native"],"title":"k8s çš„å°é—®é¢˜","uri":"/ooooo-notes/k8s-%E7%9A%84%E5%B0%8F%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 1. æ£€æŸ¥ kubelet çš„ criåœ¨ k8s ä¸­ï¼Œç”± kubelet æ¥æ‹‰å–èŠ‚ç‚¹ï¼Œè€Œ kubelet åˆå€Ÿç”¨äº† cri æ¥æ“ä½œå®¹å™¨å’Œé•œåƒ. # æŸ¥çœ‹ kubelet çš„å¯åŠ¨å‚æ•°, å…¶ä¸­çš„ --container-runtime-endpoint å°±æ˜¯ cri ps aux | grep kubelet # æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ containerd ","date":"2023-03-21","objectID":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/:1:0","tags":["k8s","containerd"],"title":"k8s æ‹‰å–é•œåƒæ…¢","uri":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/"},{"categories":null,"content":" 2. è®¾ç½® containerd ä»£ç† # æ£€æŸ¥ containerd æœåŠ¡çš„ unit æ–‡ä»¶, å…¶ä¸­ Loaded å±æ€§å°±æ˜¯æ–‡ä»¶ä½ç½® systemctl status containerd # ç¼–è¾‘ containerd.service æ–‡ä»¶ï¼Œæˆ‘è¿™é‡Œçš„æ–‡ä»¶ä½ç½®æ˜¯ /lib/systemd/system/containerd.service vim /lib/systemd/system/containerd.service # åœ¨ [service] ä¸‹æ·»åŠ ç¯å¢ƒå˜é‡ [Service] Environment=HTTP_PROXY=http://ooooo:10800 Environment=HTTPS_PROXY=http://ooooo:10800 # é‡å¯ containerd sudo systemctl daemon-reload sudo systemctl restart containerd ","date":"2023-03-21","objectID":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/:2:0","tags":["k8s","containerd"],"title":"k8s æ‹‰å–é•œåƒæ…¢","uri":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/"},{"categories":null,"content":" 3. å‚è€ƒ cri proxy systemd environment ","date":"2023-03-21","objectID":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/:3:0","tags":["k8s","containerd"],"title":"k8s æ‹‰å–é•œåƒæ…¢","uri":"/ooooo-notes/k8s-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%85%A2/"},{"categories":null,"content":" 1. go list all ä¸€ç›´åŠ è½½go list all å‘½ä»¤éœ€è¦å‘é€è¯·æ±‚ï¼Œå¯¼è‡´è¿æ¥è¶…æ—¶ã€‚ goland é…ç½®ä»£ç† ","date":"2023-03-20","objectID":"/ooooo-notes/goland-%E6%89%93%E5%BC%80-go-%E9%A1%B9%E7%9B%AE%E4%B8%80%E7%9B%B4-loading/:1:0","tags":["ide","goland"],"title":"goland æ‰“å¼€ go é¡¹ç›®ä¸€ç›´ loading","uri":"/ooooo-notes/goland-%E6%89%93%E5%BC%80-go-%E9%A1%B9%E7%9B%AE%E4%B8%80%E7%9B%B4-loading/"},{"categories":null,"content":" vim /etc/docker/daemon.json # æ·»åŠ ä»¥ä¸‹é…ç½® { \"registry-mirrors\": [ \"https://hub-mirror.c.163.com\", \"https://mirror.baidubce.com\" ] } # é‡å¯docker sudo systemctl daemon-reload sudo systemctl restart docker ","date":"2023-03-18","objectID":"/ooooo-notes/docker-%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E6%BA%90/:0:0","tags":["docker"],"title":"docker è®¾ç½®é•œåƒæº","uri":"/ooooo-notes/docker-%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E6%BA%90/"},{"categories":null,"content":" 1. è§£å†³æ–¹æ³•è®¾ç½®åŒºåŸŸå’Œè¯­è¨€ ","date":"2023-03-17","objectID":"/ooooo-notes/ubuntu-%E6%89%93%E4%B8%8D%E5%BC%80%E7%BB%88%E7%AB%AF/:1:0","tags":["ubuntu","resolution"],"title":"ubuntu æ‰“ä¸å¼€ç»ˆç«¯","uri":"/ooooo-notes/ubuntu-%E6%89%93%E4%B8%8D%E5%BC%80%E7%BB%88%E7%AB%AF/"},{"categories":null,"content":" 2. å‚è€ƒ åšå®¢ ","date":"2023-03-17","objectID":"/ooooo-notes/ubuntu-%E6%89%93%E4%B8%8D%E5%BC%80%E7%BB%88%E7%AB%AF/:2:0","tags":["ubuntu","resolution"],"title":"ubuntu æ‰“ä¸å¼€ç»ˆç«¯","uri":"/ooooo-notes/ubuntu-%E6%89%93%E4%B8%8D%E5%BC%80%E7%BB%88%E7%AB%AF/"},{"categories":null,"content":" 1. enable enhanced keyboard ","date":"2023-03-17","objectID":"/ooooo-notes/vmware-%E4%B8%80%E4%BA%9B%E8%AE%BE%E7%BD%AE/:1:0","tags":["vmware","resolution"],"title":"vmware ä¸€äº›è®¾ç½®","uri":"/ooooo-notes/vmware-%E4%B8%80%E4%BA%9B%E8%AE%BE%E7%BD%AE/"},{"categories":null,"content":" 2. enable back/forward mouse buttons in vmwarepath : somepath/Virtual Machines/Ubuntu 64-bit/*.vmx usb.generic.allowHID = \"TRUE\" mouse.vusb.enable = \"TRUE\" reference Back / Forward mouse buttons do not work in VMWare ","date":"2023-03-17","objectID":"/ooooo-notes/vmware-%E4%B8%80%E4%BA%9B%E8%AE%BE%E7%BD%AE/:2:0","tags":["vmware","resolution"],"title":"vmware ä¸€äº›è®¾ç½®","uri":"/ooooo-notes/vmware-%E4%B8%80%E4%BA%9B%E8%AE%BE%E7%BD%AE/"},{"categories":null,"content":"æ€ä¹ˆä½¿ç”¨ h2 æ•°æ®åº“ã€‚ ","date":"2023-03-15","objectID":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/:0:0","tags":["java"],"title":"h2 æ•°æ®åº“ä½¿ç”¨","uri":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 1. å¼•å…¥ä¾èµ– dependencies { api('p6spy:p6spy') api('com.h2database:h2') } ","date":"2023-03-15","objectID":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/:1:0","tags":["java"],"title":"h2 æ•°æ®åº“ä½¿ç”¨","uri":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 2. ä»¥å†…å­˜çš„æ–¹å¼ä½¿ç”¨ # spring boot é…ç½® spring: datasource: driverClassName: com.p6spy.engine.spy.P6SpyDriver url: jdbc:p6spy:h2:mem:test;DB_CLOSE_DELAY=1000 ","date":"2023-03-15","objectID":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/:2:0","tags":["java"],"title":"h2 æ•°æ®åº“ä½¿ç”¨","uri":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 3. ä»¥è¿›ç¨‹çš„æ–¹å¼ä½¿ç”¨ # å¯åŠ¨ h2 æ•°æ®åº“ java -cp h2*.jar org.h2.tools.Server -ifNotExists # å¯åŠ¨ h2 console (å¯é€‰) java -cp h2*.jar org.h2.tools.Console # è¿æ¥é…ç½®ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ url: jdbc:h2:tcp://localhost/~/test ","date":"2023-03-15","objectID":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/:3:0","tags":["java"],"title":"h2 æ•°æ®åº“ä½¿ç”¨","uri":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 4. å‚è€ƒ å®˜æ–¹æ–‡æ¡£ ","date":"2023-03-15","objectID":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/:4:0","tags":["java"],"title":"h2 æ•°æ®åº“ä½¿ç”¨","uri":"/ooooo-notes/h2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" ç›¸å…³å‘½ä»¤ sudo apt install build-essential manpages-dev software-properties-common sudo add-apt-repository ppa:ubuntu-toolchain-r/test sudo apt update \u0026\u0026 sudo apt install gcc-11 g++-11 1. sudo apt update \u0026\u0026 sudo apt upgrade gcc libfontconfig1-dev systemtap-sdt-dev libx11-dev sudo apt-get install libx11-dev libxext-dev libxrender-dev libxrandr-dev libxtst-dev libxt-dev sudo apt-get install libcups2-dev sudo apt-get install libasound2-dev bash configure --build=x86_64-unknown-linux-gnu --enable-debug --with-jvm-variants=server --enable-dtrace bash configure --enable-debug --with-jvm-variants=server bash configure --enable-debug --with-jvm-variants=server --with-toolchain-type=gcc --with-boot-jdk=C:/Users/ooooo/Development/Jdk/jdk17 ","date":"2023-02-01","objectID":"/ooooo-notes/openjdk-build/:1:0","tags":["java"],"title":"openjdk build","uri":"/ooooo-notes/openjdk-build/"},{"categories":null,"content":" 2. å‚è€ƒ æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ jdk build ","date":"2023-02-01","objectID":"/ooooo-notes/openjdk-build/:2:0","tags":["java"],"title":"openjdk build","uri":"/ooooo-notes/openjdk-build/"},{"categories":null,"content":" 1. æ£€æŸ¥ cgroup çš„ç‰ˆæœ¬ # check if cgroup is supported cat /proc/filesystems | grep cgroup # check cgroup version cat /proc/mounts | grep cgroup ","date":"2023-01-29","objectID":"/ooooo-notes/linux-%E4%B8%AD%E7%9A%84-cgroup-%E6%9C%BA%E5%88%B6/:1:0","tags":["linux"],"title":"linux ä¸­çš„ cgroup æœºåˆ¶","uri":"/ooooo-notes/linux-%E4%B8%AD%E7%9A%84-cgroup-%E6%9C%BA%E5%88%B6/"},{"categories":null,"content":" 2. cgroup v2 æ“ä½œ # create new dir cd /sys/fs/cgroup mkdir test # creat loop.sh for testing cpu quota vim loop.sh while : do : done # lunch loop.sh, generate pid -\u003e 2584068 nohup sh loop.sh \u0026 # echo pid to cgroup.procs echo 2584068 \u003e test/cgroup.procs # set cpu, at lease 0.1 echo 1000 10000 \u003e test/cpu.max # check top # recovery all kill 2584068 rmdir test å‚è€ƒï¼š åšå®¢ ","date":"2023-01-29","objectID":"/ooooo-notes/linux-%E4%B8%AD%E7%9A%84-cgroup-%E6%9C%BA%E5%88%B6/:2:0","tags":["linux"],"title":"linux ä¸­çš„ cgroup æœºåˆ¶","uri":"/ooooo-notes/linux-%E4%B8%AD%E7%9A%84-cgroup-%E6%9C%BA%E5%88%B6/"},{"categories":null,"content":" 1. å‡†å¤‡æ•°æ® # create new schema create schema test; use test; # create table test create table user ( id int primary key, age int ); alter table user add index age_idx (age); # insert some test data insert into user values (3, 10), (5, 20), (8, 30); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:1:0","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 2. é—´éš™é”æµ‹è¯•","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:0","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 1. ä½¿ç”¨ä¸»é”®ç´¢å¼•ï¼ŒæŒ‡å®šè¡Œå­˜åœ¨ # session 1, the row is exist for id = 3 , so it doesn't lock. begin; select * from user where id = 3 for update; # session 2, execute successful. begin; insert into user value (1, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:1","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 2. ä½¿ç”¨ä¸»é”®ç´¢å¼•ï¼ŒæŒ‡å®šè¡Œä¸å­˜åœ¨ # session 1, the row isn't exist for id = 2, so it locks range (,3] begin; select * from user where id = 2 for update; # session 2, execute block. begin; insert into user value (1, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:2","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 3. ä½¿ç”¨ä¸»é”®ç´¢å¼•ï¼ŒèŒƒå›´æŸ¥æ‰¾ # session 1, it locks range [1,5] begin; select * from user where id \u003e= 1 and id \u003c= 5 for update; # session 2, execute block begin; insert into user value (2, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:3","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 4. ä½¿ç”¨äºŒçº§ç´¢å¼•ï¼ŒæŒ‡å®šè¡Œå­˜åœ¨ # session 1, it locks range [3,8] begin; select * from user where age = 20 for update; # session 2, execute block. begin; insert into user value (4, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:4","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 5. ä½¿ç”¨äºŒçº§ç´¢å¼•ï¼ŒæŒ‡å®šè¡Œä¸å­˜åœ¨ # session 1, it locks range [3,5] begin; select * from user where age = 15 for update; # session 2, execute block. begin; insert into user value (4, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:5","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 6. ä½¿ç”¨äºŒçº§ç´¢å¼•ï¼ŒèŒƒå›´æŸ¥è¯¢ # session 1, it locks range [3,8] begin; select * from user where age \u003e= 12 and age \u003c= 28 for update; # session 2, execute block. begin; insert into user value (4, 20); ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:6","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 7. ç»“è®º ä½¿ç”¨ä¸»é”®ç´¢å¼•ï¼Œè¡Œå­˜åœ¨æ—¶ï¼Œæ‰åªä¼šé”å®šè¿™ä¸€è¡Œã€‚ å…¶ä»–æƒ…å†µéƒ½æ˜¯ä½¿ç”¨èŒƒå›´é”å®š ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:2:7","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 3. æ¢å¤æ•°æ® drop schame test; ","date":"2023-01-28","objectID":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/:3:0","tags":["mysql"],"title":"mysql é—´éš™é”","uri":"/ooooo-notes/mysql-%E9%97%B4%E9%9A%99%E9%94%81/"},{"categories":null,"content":" 1. aufs å­˜å‚¨é©±åŠ¨ Ubuntu 22.04 LTS ä¸æ”¯æŒ aufs æ–‡ä»¶ç³»ç»Ÿ å‚è€ƒï¼š ubuntuå®˜æ–¹æ–‡æ¡£ ","date":"2023-01-24","objectID":"/ooooo-notes/docker-%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/:1:0","tags":["docker","storage"],"title":"docker å­˜å‚¨é©±åŠ¨","uri":"/ooooo-notes/docker-%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/"},{"categories":null,"content":" 2. overlay2 å­˜å‚¨é©±åŠ¨ # creat dir mkdir lower upper work mnt # mount lower upper work to mnt mount -t overlay -o lowerdir=lower,upperdir=upper,workdir=work none mnt # testing echo 1 \u003e lower/1 mkdir lower/2 mkdir upper/3 ll mnt # recovery all setting umount mnt rm -rf lower upper work mnt å‚è€ƒï¼š æ–‡æ¡£ linuxæ–‡æ¡£ ","date":"2023-01-24","objectID":"/ooooo-notes/docker-%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/:2:0","tags":["docker","storage"],"title":"docker å­˜å‚¨é©±åŠ¨","uri":"/ooooo-notes/docker-%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/"},{"categories":null,"content":"è¿™ç¯‡æ–‡ç« ä¸»è¦ç®€è¿° docker ä¸­çš„ bridge ç½‘ç»œé©±åŠ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ ","date":"2023-01-20","objectID":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/:0:0","tags":["docker","network"],"title":"docker å•ä¸»æœºç½‘ç»œ","uri":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/"},{"categories":null,"content":" 1. æµ‹è¯•ä¸€ï¼Œveth1 (ns1) â€” veth2 (ns2) # create ns1, ns2 ip netns add ns1 ip netns add ns2 # create veth1, veth2 ip link add veth1 type veth peer name veth2 # set veth1 for ns1, set veth2 for ns2 ip link set dev veth1 netns ns1 ip link set dev veth2 netns ns2 # set veth1 ip, set veth2 ip ip netns exec ns1 ip addr add 172.16.0.1/24 dev veth1 ip netns exec ns2 ip addr add 172.16.0.2/24 dev veth2 # set veth1 up, set veth2 up ip netns exec ns1 ip link set dev veth1 up ip netns exec ns2 ip link set dev veth2 up # show ip address ip netns exec ns1 ip addr ip netns exec ns2 ip addr # test for ping ip netns exec ns1 ping 172.16.0.2 ip netns exec ns2 ping 172.16.0.1 # recovery all setting ip netns delete ns1 ip netns delete ns2 ","date":"2023-01-20","objectID":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/:1:0","tags":["docker","network"],"title":"docker å•ä¸»æœºç½‘ç»œ","uri":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/"},{"categories":null,"content":" 2. æµ‹è¯•äºŒï¼Œveth0 (bridge0) â€” veth1 (ns1) # create ns1 ip netns add ns1 # create veth0, veth1 ip link add veth0 type veth peer name veth1 # create bridge0 ip link add bridge0 type bridge # set veth1 for ns1 ip link set dev veth1 netns ns1 # set veth0 for bridge0 ip link set dev veth0 master bridge0 # set veth0 ip address ip addr add 172.16.0.1/24 dev veth0 # set bridge0 ip address ip addr add 172.16.0.0/24 dev bridge0 # set veth1 ip address ip netns exec ns1 ip addr add 172.16.0.2/24 dev veth1 # set veth0, veth1, bridge0 up ip link set dev veth0 up ip link set dev bridge0 up ip netns exec ns1 ip link set dev veth1 up # delete veth0 route ip route del 172.16.0.0/24 dev veth0 # show ip address ip addr ip netns exec ns1 ip addr # test for ping ping 172.16.0.2 ip netns exec ns1 ping 172.16.0.1 # recovery all setting ip netns del ns1 ip link del bridge0 ","date":"2023-01-20","objectID":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/:2:0","tags":["docker","network"],"title":"docker å•ä¸»æœºç½‘ç»œ","uri":"/ooooo-notes/docker-%E5%8D%95%E4%B8%BB%E6%9C%BA%E7%BD%91%E8%B7%AF/"},{"categories":null,"content":" 0ã€æŒç»­å­¦ä¹ è€… Talk is cheap. Show me the code. è‹±è¯­æ¯”ç¼–ç¨‹ç®€å•ã€‚ å­¦ä¹ å’Œå®è·µè¦å¹³è¡¡ã€‚ å­¦ä¼šå’Œæ—¶é—´åšæœ‹å‹ã€‚ å­¦ä¼šæŠ•èµ„ï¼Œå­¦ä¼šç†è´¢ã€‚ å­¦ä¼šå…ˆåšå‡æ³•ï¼Œå†åšåŠ æ³•ã€‚ å­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ã€‚ è¯´æ˜ï¼š â­• è¿›è¡Œä¸­ âœ… å·²å®Œæˆ âŒ å·²åºŸå¼ƒ â“ æœ‰å¿…è¦ â— é‡è¦æ€§ ğŸ“ è®°ç¬”è®° ğŸ–Šï¸ å†™ä»£ç  ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:1:0","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€å…³äºè‹±è¯­ ã€Šæ–°æ¦‚å¿µäºŒã€‹ â­• ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:2:0","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€å…³äºæŠ€æœ¯è®¡åˆ’ ğŸ‰ï¼š åªè®°å½•è‡ªå·±è®¤ä¸ºæœ‰ç”¨çš„ç¬”è®°ã€‚ ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:3:0","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç±0ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Kafkaï¼šæ ¸å¿ƒè®¾è®¡ä¸å®è·µåŸç†ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•å¼€å‘å®æˆ˜ã€‹ âŒ 0ï¸âƒ£3ï¸âƒ£. ã€ŠGo Web ç¼–ç¨‹ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€ŠEffective C++ã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€ŠMore Effective C++ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€Šæ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ 0ï¸âƒ£8ï¸âƒ£. ã€ŠVimå®ç”¨æŠ€å·§ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ â­• 0ï¸âƒ£9ï¸âƒ£. ã€ŠRocketMQæŠ€æœ¯å†…å¹• ç¬¬äºŒç‰ˆã€‹ â­• 1ï¸âƒ£0ï¸âƒ£. ã€Šäº‘åŸç”ŸæœåŠ¡ç½‘æ ¼Istioï¼šåŸç†ã€å®è·µã€æ¶æ„ä¸æºç è§£æã€‹ âœ… 1ï¸âƒ£1ï¸âƒ£. ã€ŠMySQLæŠ€æœ¯å†…å¹•ã€‹ â­• 1ï¸âƒ£2ï¸âƒ£. ã€Šæ·±å…¥è§£æJavaè™šæ‹ŸæœºHotSpotã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€ŠRustæƒå¨æŒ‡å—ã€‹ âœ… 1ï¸âƒ£4ï¸âƒ£. ã€Šæ·±å…¥å‰–æKubernetesã€‹ 1ï¸âƒ£5ï¸âƒ£. ã€ŠKubernetesç¼–ç¨‹ã€‹ âŒ 1ï¸âƒ£6ï¸âƒ£. ã€ŠKubernetesè®¾è®¡æ¨¡å¼ã€‹ âŒ 1ï¸âƒ£7ï¸âƒ£. ã€Šæ·±å…¥å‰–æJavaè™šæ‹Ÿæœºã€‹ 1ï¸âƒ£8ï¸âƒ£. ã€Šç®—æ³•è®­ç»ƒè¥ï¼šæµ·é‡å›¾è§£+ç«èµ›åˆ·é¢˜ï¼ˆå…¥é—¨ç¯‡ã€‹ âœ… 1ï¸âƒ£9ï¸âƒ£. ã€Šç®—æ³•è®­ç»ƒè¥ï¼šæµ·é‡å›¾è§£+ç«èµ›åˆ·é¢˜ï¼ˆè¿›é˜¶ç¯‡ï¼‰ã€‹ 2ï¸âƒ£0ï¸âƒ£. ã€ŠTCP/IPè¯¦è§£ å·1ï¼šåè®®ã€‹ âœ… 2ï¸âƒ£1ï¸âƒ£. ã€Šè‡ªå·±åŠ¨æ‰‹å†™Dockerã€‹ âœ… 2ï¸âƒ£2ï¸âƒ£. ã€ŠUNIXç½‘ç»œç¼–ç¨‹ å·1ï¼šå¥—æ¥å­—è”ç½‘APIï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ 2ï¸âƒ£3ï¸âƒ£. ã€ŠDockerâ€”â€”å®¹å™¨ä¸å®¹å™¨äº‘ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ âœ… 2ï¸âƒ£4ï¸âƒ£. ã€Šé«˜æ€§èƒ½MySQLï¼ˆç¬¬4ç‰ˆï¼‰ã€‹ âœ… 2ï¸âƒ£5ï¸âƒ£. ã€ŠKubernetesç½‘ç»œæƒå¨æŒ‡å—ï¼šåŸºç¡€ã€åŸç†ä¸å®è·µï¼‰ã€‹ âœ… 2ï¸âƒ£6ï¸âƒ£. ã€ŠKubernetes Operatorå¼€å‘è¿›é˜¶ã€‹ âŒ 2ï¸âƒ£7ï¸âƒ£. ã€ŠKafkaæƒå¨æŒ‡å—ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ 2ï¸âƒ£8ï¸âƒ£. ã€Šæ“ä½œç³»ç»Ÿå¯¼è®ºã€‹ â­• 2ï¸âƒ£9ï¸âƒ£. ã€ŠGoè¯­è¨€åº•å±‚åŸç†å‰–æã€‹ âŒ 3ï¸âƒ£0ï¸âƒ£. ã€ŠKubernetesè¿›é˜¶å®æˆ˜ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ âœ… 3ï¸âƒ£1ï¸âƒ£. ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ âœ… 3ï¸âƒ£2ï¸âƒ£. ã€ŠC++è¯­è¨€å¯¼å­¦ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ âœ… 3ï¸âƒ£3ï¸âƒ£. ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°(åŸä¹¦ç¬¬3ç‰ˆ)ã€‹ â­• ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:3:1","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€æ–‡æ¡£0ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥æ‹†è§£ Java è™šæ‹Ÿæœºã€‹ 0ï¸âƒ£2ï¸âƒ£. ä» 0 å¼€å§‹å¸¦ä½ æˆä¸ºJVMå®æˆ˜é«˜æ‰‹ âŒ 0ï¸âƒ£3ï¸âƒ£. Go è¯­è¨€é¡¹ç›®å¼€å‘å®æˆ˜ âŒ 0ï¸âƒ£4ï¸âƒ£. Redis æºç å‰–æä¸å®æˆ˜ âœ… 0ï¸âƒ£5ï¸âƒ£. æ·±å…¥ C è¯­è¨€å’Œç¨‹åºè¿è¡ŒåŸç† ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:3:2","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3. æºç 0ï¸âƒ£1ï¸âƒ£. ã€Šrocketmq æºç ã€‹ â­• 0ï¸âƒ£2ï¸âƒ£. ã€Škubernetes æºç ã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€Šistio æºç ã€‹ âŒ 0ï¸âƒ£4ï¸âƒ£. ã€Šetcd æºç ã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€Šdubbo æºç ã€‹ â­• 0ï¸âƒ£6ï¸âƒ£. ã€Šarthas æºç ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šnsq æºç ã€‹ âŒ 0ï¸âƒ£8ï¸âƒ£. ã€Ševenting æºç ã€‹ âŒ 0ï¸âƒ£9ï¸âƒ£. ã€Šserving æºç ã€‹ âŒ 1ï¸âƒ£0ï¸âƒ£. ã€Šgrpc-go æºç ã€‹ 1ï¸âƒ£1ï¸âƒ£. ã€Šnacos æºç ã€‹ âœ… 1ï¸âƒ£2ï¸âƒ£. ã€Šactiviti æºç ã€‹ âœ… ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:3:3","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€è§†é¢‘0ï¸âƒ£1ï¸âƒ£. ã€Šç©è½¬ç®—æ³•ç³»åˆ—â€“å›¾è®ºç²¾è®²ã€‹ âŒ 0ï¸âƒ£2ï¸âƒ£. ã€Šç©è½¬ç®—æ³•é¢è¯•ã€‹ âŒ ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:3:4","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€å…³äºå…¶ä»–","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:4:0","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç± ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šå“æœ‰æˆæ•ˆçš„å·¥ç¨‹å¸ˆã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šéæš´åŠ›æ²Ÿé€šã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€ŠåŸåˆ™ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šåˆ»æ„ç»ƒä¹ ã€‹ â­• 0ï¸âƒ£5ï¸âƒ£. ã€Šå…³é”®å¯¹è¯ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€Šå½“ä¸‹çš„å¯è’™ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šäº²å¯†å…³ç³»ï¼šé€šå¾€çµé­‚çš„æ¡¥æ¢ã€‹ â­• 0ï¸âƒ£8ï¸âƒ£. ã€Šäººæ€§çš„å¼±ç‚¹ã€‹ 0ï¸âƒ£9ï¸âƒ£. ã€Šå½“æˆ‘è°ˆè·‘æ­¥æ—¶ï¼Œæˆ‘è°ˆäº›ä»€ä¹ˆã€‹ ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:4:1","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€å°è¯• ğŸ‰0ï¸âƒ£1ï¸âƒ£. å­¦ä¼šä½¿ç”¨å°¤å…‹é‡Œé‡Œå¼¹å¥ âŒ ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:4:2","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3ã€äº†è§£ ğŸ‰0ï¸âƒ£1ï¸âƒ£. æš‚æ—  ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:4:3","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€å¨±ä¹0ï¸âƒ£1ï¸âƒ£. ã€Šå¥‡é‡äººç”Ÿ ç¬¬ä¸€å­£ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šä¸€æœ¬å¥½ä¹¦ 1ã€‹ 0ï¸âƒ£3ï¸âƒ£. ã€Šä¸€æœ¬å¥½ä¹¦ 2ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šå¤©æ°”ä¹‹å­ã€‹ âœ… ","date":"2023-01-01","objectID":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/:4:4","tags":["learning"],"title":"2023å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2023%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1. å‰ç½®æ¡ä»¶ å®‰è£… dockerï¼Œå¿…é¡»é…ç½® docker ä»£ç†ï¼Œå¦åˆ™ build å¤±è´¥ã€‚ å‚è€ƒ ä¸‹è½½ istio æºç ã€‚ å®‰è£… go å’Œ dlv å·¥å…·ã€‚å‚è€ƒ ","date":"2022-12-19","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["istio","cloud native"],"title":"æ­å»º istio æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 2. è®¾ç½®ç¯å¢ƒå˜é‡ # docker åœ°å€ export HUB=\"docker.io/youwillsee\" # istio çš„æºç ç›®å½• export ISTIO=/root/code/istio # docker çš„ tag export TAG=1.17-debug ","date":"2022-12-19","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["istio","cloud native"],"title":"æ­å»º istio æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 3. build istio # æ„å»º debug çš„ç‰ˆæœ¬ï¼Œä¼šè¾“å‡ºåœ¨ out ç›®å½•ä¸‹ make DEBUG=1 build # æ„å»º debug çš„ç‰ˆæœ¬ï¼Œæ¨åˆ°æœ¬åœ°çš„ docker ä¸­ make DEBUG=1 docker # æ¨é€åˆ°è¿œç«¯çš„ docker ä¸­ make docker.push # æ¸…ç† make clean å‚è€ƒ istio-devlopment istio-code-base ","date":"2022-12-19","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:3:0","tags":["istio","cloud native"],"title":"æ­å»º istio æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 4. dlv è¿æ¥ # æ‰¾åˆ° pid ps -ef | grep pilot-discovery # attach pid dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient attach 172965 # ä½¿ç”¨ IDE è¿œç¨‹è¿æ¥ GOland -\u003e go remote ","date":"2022-12-19","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:4:0","tags":["istio","cloud native"],"title":"æ­å»º istio æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 5. bind dlv to pilot (optional)Dockerfile.pilot # BASE_DISTRIBUTION is used to switch between the old base distribution and distroless base images ARG BASE_DISTRIBUTION=debug # Version is the base image version from the TLD Makefile ARG BASE_VERSION=latest ARG ISTIO_BASE_REGISTRY=gcr.io/istio-release # The following section is used as base image if BASE_DISTRIBUTION=debug FROM ${ISTIO_BASE_REGISTRY}/base:${BASE_VERSION} as debug # The following section is used as base image if BASE_DISTRIBUTION=distroless FROM ${ISTIO_BASE_REGISTRY}/distroless:${BASE_VERSION} as distroless # Add dlv FROM golang:1.20 AS build-dlv ENV GOPROXY=https://goproxy.io,direct RUN go install github.com/go-delve/delve/cmd/dlv@latest # This will build the final image based on either debug or distroless from above # hadolint ignore=DL3006 FROM ${BASE_DISTRIBUTION:-debug} ARG TARGETARCH COPY ${TARGETARCH:-amd64}/pilot-discovery /usr/local/bin/pilot-discovery # Copy templates for bootstrap generation. COPY envoy_bootstrap.json /var/lib/istio/envoy/envoy_bootstrap_tmpl.json COPY gcp_envoy_bootstrap.json /var/lib/istio/envoy/gcp_envoy_bootstrap_tmpl.json COPY --from=build-dlv /go/bin/dlv / USER 1337:1337 ENTRYPOINT [\"/dlv\", \"--listen=:1234\", \"--headless=true\", \"--api-version=2\", \"--accept-multiclient\", \"exec\", \"/usr/local/bin/pilot-discovery\", \"--\"] #ENTRYPOINT [\"/usr/local/bin/pilot-discovery\"] ","date":"2022-12-19","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:5:0","tags":["istio","cloud native"],"title":"æ­å»º istio æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-istio-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 1. é…ç½® docker ä»£ç† # åˆ›å»ºé…ç½®ç›®å½• mkdir -p /etc/systemd/system/docker.service.d # åˆ›å»ºé…ç½®æ–‡ä»¶ vim /etc/systemd/system/docker.service.d/http-proxy.conf # é…ç½®æ–‡ä»¶å†…å®¹ [Service] Environment=\"HTTP_PROXY=http://ooooo:10800\" Environment=\"HTTPS_PROXY=http://ooooo:10800\" # é‡å¯ docker systemctl daemon-reload \u0026\u0026 systemctl restart docker # æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ systemctl show --property=Environment docker ","date":"2022-12-18","objectID":"/ooooo-notes/%E8%AE%BE%E7%BD%AE-docker-%E4%BB%A3%E7%90%86/:1:0","tags":["docker","cloud native"],"title":"è®¾ç½® docker ä»£ç†","uri":"/ooooo-notes/%E8%AE%BE%E7%BD%AE-docker-%E4%BB%A3%E7%90%86/"},{"categories":null,"content":" 1. å®ç°é˜Ÿåˆ—ä»£ç ï¼š ä½¿ç”¨ head å’Œ tail æ¥å®ç°å•é“¾è¡¨ å•é“¾è¡¨æ¶‰åŠåˆ°ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ¯æ¬¡éƒ½è¦åˆ¤æ–­ä¸­é—´çŠ¶æ€ è¿™é‡Œä½¿ç”¨çš„æ˜¯ AtomicReference æ¥å®ç°çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ unsafe æ¥å®ç°ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å°è¯•ä¸‹ è¿™é‡Œä½¿ç”¨ curTail.next è¿›è¡Œ CAS æ¥æŒ‡å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹, å¾ˆå°‘è¿™ä¹ˆä½¿ç”¨ï¼Œåé¢å†è¯¦ç»†è¯´è¯´ public class LinkedQueue\u003cE\u003e { private final Node\u003cE\u003e dummy = new Node\u003c\u003e(null, null); private final AtomicReference\u003cNode\u003cE\u003e\u003e head = new AtomicReference\u003c\u003e(dummy); private final AtomicReference\u003cNode\u003cE\u003e\u003e tail = new AtomicReference\u003c\u003e(dummy); public boolean put(E item) { Node\u003cE\u003e newNode = new Node\u003c\u003e(item, null); while (true) { Node\u003cE\u003e curTail = tail.get(); Node\u003cE\u003e tailNext = curTail.next.get(); if (curTail == tail.get()) { if (tailNext != null) { // é˜Ÿåˆ—å¤„äºä¸­é—´çŠ¶æ€ï¼Œæ¨è¿›å°¾èŠ‚ç‚¹ tail.compareAndSet(curTail, tailNext); } else { // å¤„äºç¨³å®šçŠ¶æ€ï¼Œå°è¯•æ’å…¥æ–°èŠ‚ç‚¹ if (curTail.next.compareAndSet(null, newNode)) { // æ’å…¥æ“ä½œæˆåŠŸï¼Œå°è¯•æ¨è¿›å°¾èŠ‚ç‚¹ tail.compareAndSet(curTail, newNode); return true; } } } } } public E take() { while (true) { if (head.get() == tail.get()) { return null; } Node\u003cE\u003e oldHead = head.get(); Node\u003cE\u003e newHead = oldHead.next.get(); // é˜Ÿåˆ—å¤„äºä¸­é—´çŠ¶æ€ï¼Œå¯èƒ½å¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç» CAS æˆåŠŸï¼Œ åªå‰©ä¸‹ä¸€ä¸ªå…ƒç´  dummy äº† if (newHead == null) { return null; } if (head.compareAndSet(oldHead, newHead)) { oldHead.next = null; return oldHead.item; } } } private static class Node\u003cE\u003e { private final E item; private AtomicReference\u003cNode\u003cE\u003e\u003e next; public Node(E item, Node\u003cE\u003e next) { this.item = item; this.next = new AtomicReference\u003c\u003e(next); } } } ","date":"2022-11-16","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/:1:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°é˜Ÿåˆ—","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-11-16","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/:2:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°é˜Ÿåˆ—","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/"},{"categories":null,"content":" 1. ä½¿ç”¨ Lock æ¥å®ç° Semaphoreä»£ç ï¼š Semaphore çš„åŠŸèƒ½å°±æ˜¯å…è®¸åŒæ—¶æœ‰å‡ ä¸ªçº¿ç¨‹æ“ä½œ acquire æ–¹æ³•ï¼Œpermit ä¼šå‡ä¸€ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™çº¿ç¨‹éœ€è¦ç­‰å¾… release æ–¹æ³•ï¼Œpermit ä¼šåŠ ä¸€ï¼Œå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ public class SemaphoreOnLock { private final ReentrantLock lock = new ReentrantLock(); private final Condition condition = lock.newCondition(); private int permit; public SemaphoreOnLock(int permit) { this.permit = permit; } /** * è·å–é” */ public void acquire() { lock.lock(); try { while (permit \u003c= 0) { condition.await(); } permit--; } catch (InterruptedException ignored) { } finally { lock.unlock(); } } public void release() { lock.lock(); try { permit++; condition.signal(); } finally { lock.unlock(); } } } ","date":"2022-11-14","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-lock-%E6%9D%A5%E5%AE%9E%E7%8E%B0-semaphore/:1:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ Lock æ¥å®ç° Semaphore","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-lock-%E6%9D%A5%E5%AE%9E%E7%8E%B0-semaphore/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-11-14","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-lock-%E6%9D%A5%E5%AE%9E%E7%8E%B0-semaphore/:2:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ Lock æ¥å®ç° Semaphore","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-lock-%E6%9D%A5%E5%AE%9E%E7%8E%B0-semaphore/"},{"categories":null,"content":" 1. ä½¿ç”¨æ•°ç»„æ¥å®ç°æ ˆä»£ç ï¼š ç”¨æ•°ç»„æ¥å®ç° ç”¨ CTL æ¥æ§åˆ¶ æµ‹è¯•ç±»ï¼Œå‚è€ƒ ConcurrentStackUsingArrayTest public class ConcurrentStackUsingArray\u003cE\u003e { private final AtomicInteger CTL = new AtomicInteger(0); private final AtomicReference\u003cE[]\u003e arr = new AtomicReference\u003c\u003e((E[]) new Object[10]); private final AtomicInteger index = new AtomicInteger(0); public void push(E e) { while (!CTL.compareAndSet(0, 1)) { Thread.yield(); } while (index.get() \u003e= arr.get().length) { E[] oldArr = arr.get(); E[] newArr = (E[]) new Object[oldArr.length * 2]; System.arraycopy(oldArr, 0, newArr, 0, oldArr.length); if (arr.compareAndSet(oldArr, newArr)) { break; } } arr.get()[index.getAndIncrement()] = e; CTL.lazySet(0); } public E pop() { while (!CTL.compareAndSet(0, 1)) { Thread.yield(); } E e = arr.get()[index.decrementAndGet()]; CTL.lazySet(0); return e; } } ","date":"2022-11-13","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%882/:1:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°æ ˆ2","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%882/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-11-13","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%882/:2:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°æ ˆ2","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%882/"},{"categories":null,"content":" 1. java å¤šçº¿ç¨‹æµ‹è¯•åœ¨ä»»ä½•è¯­è¨€ä¸­ï¼Œå¤šçº¿ç¨‹æµ‹è¯•éƒ½æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»‹ç»ä¸‹ java çš„å¤šçº¿ç¨‹æµ‹è¯• jcstress. jcstress æ˜¯ OpenJDK æä¾›çš„ä¸€ä¸ªæµ‹è¯•å¤šçº¿ç¨‹çš„æ¡†æ¶ ä¸»è¦ç”±å¤šä¸ª Actor æ¥æ„æˆï¼Œæ¯ä¸ª Actor å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚ é€šè¿‡åŒ¹é… Outcome çš„ç»“æœæ¥æŠ¥å‘Šæµ‹è¯• è¿è¡Œä¹‹åçš„ç»“æœä¸º html æ–‡ä»¶ï¼Œéœ€è¦ä½ è‡ªå·±æŸ¥çœ‹ã€‚ ç¤ºä¾‹ä»£ç : æµ‹è¯•è‡ªæ—‹é”ï¼Œå…¶å®ä¹Ÿå‘Šè¯‰ä½ è¯¥æ€ä¹ˆç¼–å†™ CAS æ‰§è¡Œå‘½ä»¤ gradle jcstressï¼Œä¼šç”Ÿæˆç›®å½• build/reports/jcstress @JCStressTest @Outcome(id = {\"1, 2\", \"2, 1\"}, expect = Expect.ACCEPTABLE, desc = \"Mutex works\") @Outcome(id = \"1, 1\", expect = Expect.FORBIDDEN, desc = \"Mutex failure\") @State public class Mutex_03_SpinLock { private final AtomicBoolean taken = new AtomicBoolean(false); private int v; @Actor public void actor1(II_Result r) { while (taken.get() || !taken.compareAndSet(false, true)) ; // wait { // critical section r.r1 = ++v; } taken.set(false); } @Actor public void actor2(II_Result r) { while (taken.get() || !taken.compareAndSet(false, true)) ; // wait { // critical section r.r2 = ++v; } taken.set(false); } } ","date":"2022-11-12","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/:1:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¤šçº¿ç¨‹æµ‹è¯•","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-11-12","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/:2:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¤šçº¿ç¨‹æµ‹è¯•","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":" 3. å‚è€ƒ å¼ºçƒˆå»ºè®®å¤§å®¶çœ‹å®˜æ–¹ä»£ç , åœ°å€: https://github.com/openjdk/jcstress ","date":"2022-11-12","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/:3:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¤šçº¿ç¨‹æµ‹è¯•","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":" 1. å®ç°ç®€å•çš„ CAS ä¾‹å­CAS ç›¸ä¿¡å¤§å®¶éƒ½å¬è¿‡ï¼Œå°±æ˜¯ compareAndSet(V expectedValue, V newValue), çœŸæ­£ä¼šç”¨çš„äººå¾ˆå°‘ï¼Œè¿™é‡Œçš„éš¾ç‚¹ä¸»è¦æ˜¯æ— é˜»å¡ç®—æ³•ã€‚ å…ˆå®ç°ä¸€ä¸ªç®€å• CAS ä¾‹å­ï¼Œåªå…·æœ‰å­¦ä¹ çš„æ„ä¹‰ã€‚ getValue: è·å–å€¼ compareAndSet: æ¯”è¾ƒæ—§å€¼ï¼Œè®¾ç½®æ–°å€¼ public class SimulatedCAS { private int value; public SimulatedCAS(int value) { this.value = value; } public synchronized int getValue() { return value; } public synchronized boolean compareAndSet(int expectedValue, int newValue) { if (expectedValue == value) { this.value = newValue; return true; } return false; } } é‡ç‚¹ï¼šçœŸæ­£ç”¨ CAS çš„æ—¶å€™ï¼Œéƒ½æ˜¯ while å¾ªç¯ ","date":"2022-11-09","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/:1:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°æ ˆ","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/"},{"categories":null,"content":" 2. ç”¨ CAS æ¥å®ç°ä¸€ä¸ªæ ˆä»£ç ï¼š ç”¨é“¾è¡¨æ¥å®ç°ï¼Œå½“ç„¶ç”¨æ•°ç»„å®ç°ä¹Ÿå¯ä»¥ï¼Œæ¯”è¾ƒéº»çƒ¦ä¸€ç‚¹ï¼Œåé¢æˆ‘å†å†™ä¸€ä¸ªç¤ºä¾‹ æ¯æ¬¡æ“ä½œéƒ½æ˜¯å…ˆ get æ¥è·å– top å¯¹è±¡ï¼Œç„¶åå† compareAndSet top public class ConcurrentStack\u003cE\u003e { private final AtomicReference\u003cNode\u003cE\u003e\u003e top = new AtomicReference\u003c\u003e(); public void push(E e) { Node\u003cE\u003e newHead = new Node\u003c\u003e(e); Node\u003cE\u003e oldHead; do { oldHead = top.get(); newHead.next = oldHead; } while (!top.compareAndSet(oldHead, newHead)); } public E pop() { Node\u003cE\u003e oldHead; Node\u003cE\u003e newHead; do { oldHead = top.get(); if (oldHead == null) { return null; } newHead = oldHead.next; } while (!top.compareAndSet(oldHead, newHead)); oldHead.next = null; return oldHead.e; } private static class Node\u003cE\u003e { private final E e; private Node\u003cE\u003e next; public Node(E e) { this.e = e; } } } ","date":"2022-11-09","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/:2:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°æ ˆ","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/"},{"categories":null,"content":" 3. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-11-09","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/:3:0","tags":["java"],"title":"åœ¨ java ä¸­ä½¿ç”¨ CAS æ¥å®ç°æ ˆ","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E4%BD%BF%E7%94%A8-cas-%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%A0%88/"},{"categories":null,"content":" grpc ä½¿ç”¨æ–¹å¼grpc ä½œä¸ºä¸€ä¸ªé€šä¿¡æ–¹å¼ï¼Œç°åœ¨å¯ä»¥è¯´æ˜¯éå¸¸æµè¡Œã€‚å¦‚æœä¸ä¼š grpcï¼Œä½ å¯èƒ½è·Ÿä¸ä¸Šæ—¶ä»£äº†, è¿™é‡Œæˆ‘åªæ˜¯åšä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œå¹¶è¯´ä¸‹å¦‚ä½•è¿›ä¸€æ­¥å­¦ä¹  grpcã€‚ grpc æ¥å£éœ€è¦ç¼–å†™ .proto æ–‡ä»¶ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š æœ‰ä¸€ä¸ªæ¥å£ç±»ï¼šGreeter. æœ‰ä¸¤ä¸ªæ–¹æ³• SayHello, SayHi. syntax = \"proto3\"; option java_multiple_files = true; option java_package = \"com.ooooo.grpc.helloworld\"; option java_outer_classname = \"HelloWorldProto\"; package helloworld; // The greeting service definition. service Greeter { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} rpc SayHi (HelloRequest) returns (HelloReply) {} } // The request message containing the user's name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } åœ¨è¿™é‡Œï¼Œæˆ‘å¾ˆæ¨èå¤§å®¶çœ‹ä¸‹ï¼Œprotobuf æ˜¯æ€ä¹ˆç¼–ç çš„ã€‚ proto3, å®˜æ–¹åœ°å€ï¼š https://developers.google.com/protocol-buffers/docs/proto3 proto3 encoding, å®˜æ–¹åœ°å€ï¼š https://developers.google.com/protocol-buffers/docs/encoding ç¼–å†™å®Œ .proto æ–‡ä»¶ï¼Œæ‰§è¡Œ gradle çš„ generateProto ä»»åŠ¡, å°±ä¼šç”Ÿæˆç›¸åº”çš„ java ä»£ç ã€‚ ç„¶åç¼–å†™å…¥å£ç¨‹åº GrpcClient å’Œ GrpcServerã€‚ ","date":"2022-10-22","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/:1:0","tags":["java","grpc"],"title":"åœ¨ java ä¸­å¦‚ä½•ä½¿ç”¨ grpc","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/"},{"categories":null,"content":" å¦‚ä½•è¿›ä¸€æ­¥å­¦ä¹  grpc å­¦ä¹  grpc å¦‚ä½•ä½¿ç”¨ï¼Œå¦‚ä½•æ‰©å±•ï¼Œå¯ä»¥çœ‹ https://github.com/grpc/grpc-java/tree/master/examples. åœ¨ spring-boot ä¸­å¦‚ä½•ä½¿ç”¨ï¼Œæœ‰å¼€æºçš„ starter. grpc æ˜¯åŸºäº http2 åè®®çš„ï¼Œä½ å¿…é¡»ç†Ÿæ‚‰ http2 åè®®ã€‚ æ›´æ·±å…¥çš„å­¦ä¹ ï¼Œä¹Ÿå°±æ˜¯å­¦ä¹ æºç ï¼Œæœ‰æ—¶é—´ç»™å¤§å®¶è¯´ä¸‹ grpc çš„æºç ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚ ","date":"2022-10-22","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/:2:0","tags":["java","grpc"],"title":"åœ¨ java ä¸­å¦‚ä½•ä½¿ç”¨ grpc","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-10-22","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/:3:0","tags":["java","grpc"],"title":"åœ¨ java ä¸­å¦‚ä½•ä½¿ç”¨ grpc","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-grpc/"},{"categories":null,"content":" 1. æ·»åŠ æ‰“å° SQL çš„æ–¹å¼æ‰“å° SQL çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æœ‰ idea æ’ä»¶ï¼Œæœ‰ mybatis æ‹¦æˆªå™¨ï¼Œæœ‰ä»£ç† datasource, æœ‰ä»£ç† driver. æˆ‘æ¯”è¾ƒè®¤å¯çš„æ–¹å¼å°±æ˜¯ä»£ç† driver. è¿™ç§æ— ä»»ä½•ä¾µå…¥æ€§ã€‚ ä¸‹é¢æ¥ä»‹ç»å¦‚ä½•ä½¿ç”¨ p6spy Driverã€‚ ç¤ºä¾‹ä»£ç ï¼š ä½¿ç”¨ BeanPostProcessor æ¥åŠ¨æ€æ‰©å±• beanã€‚ åˆ¤æ–­ bean æ˜¯å¦ä¸º DataSource ç±»å‹ï¼Œå¹¶åˆ¤æ–­å¼€å‘é…ç½® dev.sql-log.enabledã€‚ æ ¹æ®ç°æœ‰çš„ driver é…ç½®æ¥åˆ›å»ºæ–°çš„ datasourceï¼Œå¹¶è®¾ç½® urlã€‚ å®é™…å¼€å¯ï¼Œè¿˜éœ€è¦ spy.properties é…ç½®æ–‡ä»¶ @Slf4j @Configuration public class DevDataSourceConfiguration implements BeanPostProcessor, EnvironmentAware { @Setter private Environment environment; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { if (bean instanceof DataSource \u0026\u0026 parseBoolean(environment.resolvePlaceholders(\"${dev.sql-log.enabled:false}\"))) { log.info(\"å·²å¼€å¯æ—¥å¿—æ‰“å°ï¼Œå°†ä½¿ç”¨[P6SpyDriver]\"); if (environment.acceptsProfiles(Profiles.of(\"run\"))) { log.warn(\"åœ¨ç”Ÿäº§ç¯å¢ƒä¸€å®šè¦å…³é—­é…ç½®[dev.sql-log.enabled]\"); } return proxyDataSource((DataSource) bean); } return bean; } public DataSource proxyDataSource(DataSource dataSource) { if (dataSource instanceof AbstractRoutingDataSource) { AbstractRoutingDataSource abstractRoutingDataSource = (AbstractRoutingDataSource) dataSource; // resolvedDataSources Field resolvedDataSourcesField = findField(AbstractRoutingDataSource.class, \"resolvedDataSources\"); makeAccessible(resolvedDataSourcesField); @SuppressWarnings(\"unchecked\") Map\u003cObject, DataSource\u003e resolvedDataSources = (Map\u003cObject, DataSource\u003e) getField(resolvedDataSourcesField, abstractRoutingDataSource); if (resolvedDataSources != null) { resolvedDataSources.forEach((k, v) -\u003e resolvedDataSources.put(k, convertToProxyDataSource(v))); } // resolvedDefaultDataSource Field resolvedDefaultDataSourceField = findField(AbstractRoutingDataSource.class, \"resolvedDefaultDataSource\"); makeAccessible(resolvedDefaultDataSourceField); DataSource resolvedDefaultDataSource = (DataSource) getField(resolvedDefaultDataSourceField, abstractRoutingDataSource); if (resolvedDefaultDataSource != null) { ReflectionUtils.setField(resolvedDefaultDataSourceField, abstractRoutingDataSource, convertToProxyDataSource(resolvedDefaultDataSource)); } return abstractRoutingDataSource; } return convertToProxyDataSource(dataSource); } public DataSource convertToProxyDataSource(DataSource dataSource) { if (dataSource instanceof HikariDataSource) { HikariConfig oldConfig = (HikariDataSource) dataSource; // jdbc:h2:mem:test to jdbc:p6spy:h2:mem:test String jdbcUrl = oldConfig.getJdbcUrl(); if (!jdbcUrl.contains(\"p6spy\")) { jdbcUrl = \"jdbc:p6spy\" + jdbcUrl.substring(4); } HikariConfig newConfig = new HikariConfig(); newConfig.setPoolName(\"proxy-P6SpyDriver\"); newConfig.setDriverClassName(\"com.p6spy.engine.spy.P6SpyDriver\"); newConfig.setJdbcUrl(jdbcUrl); newConfig.setUsername(oldConfig.getUsername()); newConfig.setPassword(oldConfig.getPassword()); return new HikariDataSource(newConfig); } return dataSource; } } ","date":"2022-10-22","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0-sql-%E6%97%A5%E5%BF%97/:1:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•æ·»åŠ  SQL æ—¥å¿—","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0-sql-%E6%97%A5%E5%BF%97/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-10-22","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0-sql-%E6%97%A5%E5%BF%97/:2:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•æ·»åŠ  SQL æ—¥å¿—","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0-sql-%E6%97%A5%E5%BF%97/"},{"categories":null,"content":" 1. è‡ªå®šä¹‰ classloaderæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®å¼€å‘çš„æ—¶å€™ï¼Œä¼šé‡åˆ°æ¯”è¾ƒæ¶å¿ƒçš„é—®é¢˜ï¼Œå­˜åœ¨ä¸¤ä¸ªä¸åŒ jar åŒ…ï¼Œä½†æ˜¯ç±»çš„å…¨é™å®šåæ˜¯ä¸€æ ·çš„ï¼Œè€Œè¿™ä¸¤ä¸ªåŒ…éƒ½ä¸èƒ½åˆ é™¤ï¼Œè¿™æ—¶å€™è°ƒç”¨å¯èƒ½å°±ä¼šå‡ºé—®é¢˜ã€‚ å¦‚ä½•è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Ÿ æˆ‘çš„ç­”æ¡ˆå°±æ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚ åœºæ™¯æ¨¡æ‹Ÿ module-a: è¡¨ç¤º a.jar module-b: è¡¨ç¤º b.jar module-main: è¡¨ç¤º ç¨‹åºå…¥å£ ç”±äºåœ¨ module-main é¡¹ç›®ä¸­åŒæ—¶å¼•å…¥äº† module-a å’Œ module-b è¿™ä¸¤ä¸ª jar åŒ…ï¼Œä½†æ˜¯å­˜åœ¨å†²çªç±» HelloService, æœ€ç»ˆå¯¼è‡´ç¨‹åºè¿è¡Œé”™è¯¯ã€‚ å¦‚ä½•è‡ªå®šä¹‰ classloaderï¼Œæ¥è§£å†³é—®é¢˜ï¼Ÿ é‡æ–°å®šä¹‰ loadClass æ–¹æ³•ï¼Œæ‰“ç ´çˆ¶ç±»å§”æ‰˜æœºåˆ¶ ä½¿ç”¨ getResources æ–¹æ³•æ¥è·å–æ‰€æœ‰çš„ class æ–‡ä»¶ï¼Œç„¶ååˆ¤æ–­ @SneakyThrows public String test1(String message) { // æŸ¥æ‰¾ç±» ClassLoader classLoader = new ModuleAClassLoader(); Class\u003c?\u003e clazz = classLoader.loadClass(\"com.ooooo.HelloService\"); // æ‰§è¡Œ Method test1 = ReflectionUtils.findMethod(clazz, \"test1\", String.class); Object result = test1.invoke(null, message); return (String) result; } @SneakyThrows public String test2(String message) { // æŸ¥æ‰¾ç±» ClassLoader classLoader = new ModuleBClassLoader(); Class\u003c?\u003e clazz = classLoader.loadClass(\"com.ooooo.HelloService\"); // æ‰§è¡Œ Method test2 = ReflectionUtils.findMethod(clazz, \"test2\", String.class); Object result = test2.invoke(null, message); return (String) result; } private static class ModuleAClassLoader extends ClassLoader { public ModuleAClassLoader() { super(ModuleAClassLoader.class.getClassLoader()); } @SneakyThrows @Override protected Class\u003c?\u003e loadClass(String name, boolean resolve) throws ClassNotFoundException { Class\u003c?\u003e c = findLoadedClass(name); if (c == null) { // å½“å‰è·¯å¾„ä¸‹å»æ‰¾ if (name.contains(\"com.ooooo\")) { String path = name.replace(\".\", \"/\") + \".class\"; Enumeration\u003cURL\u003e resources = getResources(path); URL targetUrl = null; while (resources.hasMoreElements()) { targetUrl = resources.nextElement(); if (targetUrl.toString().contains(\"module-a\")) { break; } } // è¯»å– class æ–‡ä»¶ InputStream in = targetUrl.openStream(); byte[] bytes = StreamUtils.copyToByteArray(in); in.close(); c = defineClass(name, bytes, 0, bytes.length); } } if (c == null) { c = getParent().loadClass(name); } if (resolve) { resolveClass(c); } return c; } } private static class ModuleBClassLoader extends ClassLoader { public ModuleBClassLoader() { super(ModuleAClassLoader.class.getClassLoader()); } @SneakyThrows @Override protected Class\u003c?\u003e loadClass(String name, boolean resolve) throws ClassNotFoundException { Class\u003c?\u003e c = findLoadedClass(name); if (c == null) { // å½“å‰è·¯å¾„ä¸‹å»æ‰¾ if (name.contains(\"com.ooooo\")) { String path = name.replace(\".\", \"/\") + \".class\"; Enumeration\u003cURL\u003e resources = getResources(path); URL targetUrl = null; while (resources.hasMoreElements()) { targetUrl = resources.nextElement(); if (targetUrl.toString().contains(\"module-b\")) { break; } } // è¯»å– class æ–‡ä»¶ InputStream in = targetUrl.openStream(); byte[] bytes = StreamUtils.copyToByteArray(in); in.close(); c = defineClass(name, bytes, 0, bytes.length); } } if (c == null) { c = getParent().loadClass(name); } if (resolve) { resolveClass(c); } return c; } } } ","date":"2022-10-18","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%B1%BB%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98/:1:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è§£å†³ç±»å†²çªé—®é¢˜","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%B1%BB%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-10-18","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%B1%BB%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98/:2:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è§£å†³ç±»å†²çªé—®é¢˜","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%B1%BB%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" 1. methodHandle è°ƒç”¨åœ¨è¿‡å»ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼Œé™¤äº†ç›´æ¥è°ƒç”¨ï¼Œå†å°±æ˜¯ä½¿ç”¨åå°„æ¥è°ƒç”¨äº†ã€‚è€Œä»Šå¤©æˆ‘è¦è¯´è¯´ jdk æ–°å¼•å…¥çš„æ–¹å¼æ¥è°ƒç”¨ã€‚ æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆç®€å•çš„ UserService ç±»ã€‚ public class UserService { public String getUsername(String id) { return \"username\" + id; } } ç›´æ¥è°ƒç”¨å’Œåå°„è°ƒç”¨çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸è¯´æ˜äº†ã€‚ ä¸‹é¢æ¥æ¼”ç¤º invoke åŒ…çš„ä½¿ç”¨ã€‚ ä½¿ç”¨ MethodHandles.lookup() æ¥æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³• ä½¿ç”¨ methodHandle æ¥è°ƒç”¨ï¼Œåˆ†ä¸ºå‡ ç§ä¸åŒçš„æ–¹å¼ public class UserServiceTest { private MethodType methodType; private Lookup lookup; private MethodHandle methodHandle; @SneakyThrows @BeforeEach public void beforeEach() { methodType = MethodType.methodType(String.class, String.class); lookup = MethodHandles.lookup(); methodHandle = lookup.findVirtual(UserService.class, \"getUsername\", methodType); } @SneakyThrows @Test public void invokeWithArguments() { UserService userService = new UserService(); Object obj = methodHandle.bindTo(userService).invokeWithArguments(\"1\"); assertEquals(\"username1\", obj); } @SneakyThrows @Test public void invoke() { UserService userService = new UserService(); Object obj = methodHandle.invoke(userService, \"1\"); assertEquals(\"username1\", obj); } /** * è¦æ±‚ç±»å‹å…¨åŒ¹é…, åŒ…æ‹¬è¿”å›å€¼ç±»å‹ */ @SneakyThrows @Test public void invokeExact() { UserService userService = new UserService(); String s = (String) methodHandle.invokeExact(userService, \"1\"); assertEquals(\"username1\", s); } } ","date":"2022-10-17","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-%E4%B8%AD-invoke-%E5%8C%85/:1:0","tags":["java"],"title":"å¦‚ä½•ä½¿ç”¨ java ä¸­ invoke åŒ…?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-%E4%B8%AD-invoke-%E5%8C%85/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-10-17","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-%E4%B8%AD-invoke-%E5%8C%85/:2:0","tags":["java"],"title":"å¦‚ä½•ä½¿ç”¨ java ä¸­ invoke åŒ…?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-java-%E4%B8%AD-invoke-%E5%8C%85/"},{"categories":null,"content":" 1. jmh å¾®åŸºå‡†æµ‹è¯•å®é™…ä¸Šï¼Œåœ¨ java ä¸­è¿›è¡Œå¾®åŸºæ¤æµ‹è¯•å¹¶ä¸å®¹æ˜“ï¼Œä¸»è¦åŸå› åœ¨äºè§£é‡Šæ‰§è¡Œï¼Œç¼–è¯‘æ‰§è¡Œï¼Œè€Œç¼–è¯‘æ‰§è¡Œåˆåˆ†ä¸º C1ç¼–è¯‘, C2ç¼–è¯‘ã€‚å³ä½¿æ˜¯å¯¹åŒä¸€ä¸ªä»£ç æ¥è¯´ï¼Œä¸åŒçš„ jvm å‚æ•°ä¹Ÿä¼šå¯¼è‡´æµ‹è¯•ä¸ä¸€æ ·ã€‚ é‚£æ˜¯å¦åº”è¯¥äº†è§£å¾®åŸºå‡†æµ‹è¯•ï¼Ÿ æˆ‘çš„ç­”æ¡ˆï¼Œæ˜¯å¿…é¡»æŒæ¡çš„ã€‚ jmh å°±æ˜¯æˆ‘ä»¬åº”è¯¥å­¦ä¹ çš„å¾®åŸºå‡†æµ‹è¯•çš„æ¡†æ¶ã€‚ ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹æµ‹è¯•ï¼Œæµ‹è¯• StringBuilderï¼Œ StringBufferï¼Œ String è¿æ¥å­—ç¬¦çš„æ€§èƒ½ã€‚ æ³¨æ„ç‚¹ï¼š Fork å‚æ•°å¯ä»¥æµ‹è¯•ä¸åŒçš„ Jvm å‚æ•°ã€‚ è¾“å‡ºç»“æœçš„æ—¶é—´å•ä½æœ€å¥½æ˜¯çº³ç§’ã€‚ æµ‹è¯•æ¨¡å¼å¯ä»¥è‡ªç”±é€‰æ‹©ï¼Œå¦‚æœæµ‹è¯•æ€§èƒ½ï¼Œæœ€å¥½é€‰æ‹©å¹³å‡æ—¶é—´ã€‚ å¦‚æœæ˜¯åœ¨ IDE ä¸­ï¼Œå»ºè®®å®‰è£… jmh æ’ä»¶æ¥æ‰§è¡Œã€‚ ä»£ç ç¤ºä¾‹ // é¢„çƒ­çš„å‚æ•° @Warmup(time = 1) // æµ‹è¯•çš„å‚æ•° @Measurement(time = 1) // å¯ä»¥æ·»åŠ  JVM å‚æ•°æ¥æµ‹è¯• @Fork(value = 1) @State(Scope.Thread) @OutputTimeUnit(TimeUnit.NANOSECONDS) @BenchmarkMode(Mode.AverageTime) public class TestStringBenchmark { @Benchmark public String stringBuilder() { StringBuilder sb = new StringBuilder(); sb.append(\"hello\"); sb.append(\"world\"); return sb.toString(); } @Benchmark public String stringBuffer() { StringBuffer sb = new StringBuffer(); sb.append(\"hello\"); sb.append(\"world\"); return sb.toString(); } @Benchmark public String stringConcat() { return \"hello\" + \"world\"; } } ","date":"2022-10-16","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/:1:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¾®åŸºå‡†æµ‹è¯• ?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®github åœ°å€ ","date":"2022-10-16","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/:2:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¾®åŸºå‡†æµ‹è¯• ?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":" 3. å‚è€ƒ å¼ºçƒˆå»ºè®®å¤§å®¶çœ‹å®˜æ–¹ä»£ç , åœ°å€: https://github.com/openjdk/jmh ","date":"2022-10-16","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/:3:0","tags":["java"],"title":"åœ¨ java ä¸­å¦‚ä½•è¿›è¡Œå¾®åŸºå‡†æµ‹è¯• ?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"},{"categories":null,"content":"æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šä½¿ç”¨ lambda å‡½æ•°å¼ç¼–ç¨‹ï¼Œè¿™æ ·ä¼šæ›´åŠ ç®€å•ã€‚ ","date":"2022-10-11","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/:0:0","tags":["IDE"],"title":"åœ¨ java ä¸­å¦‚ä½•è·å– lambda çš„æ–¹æ³•åç§°?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/"},{"categories":null,"content":" 1. ä½¿ç”¨æ–¹å¼æ¯”å¦‚ä¸‹é¢æœ‰ä¸€ä¸ªå¾ˆç®€å•çš„ User ç±»ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå±æ€§ username @Data public class User { private String username; public String getPassword(String password) { return password; } } // ä½¿ç”¨çš„æ–¹å¼ // user -\u003e user.getUsername() ç­‰ä»·äº User::getUsername Function\u003cUser, String\u003e getUsername1 = User::getUsername æ¯”å¦‚æˆ‘ç°åœ¨è¦ä½¿ç”¨ user -\u003e user.getUsername()ï¼Œ è¿™æ ·çš„ lambda è¡¨è¾¾å¼æ¥è·å–ä¸€ä¸ª User å¯¹è±¡çš„ username å±æ€§å€¼ã€‚ æˆ‘ç°åœ¨å¯ä»¥è¿™æ ·æ¥è·å– username è¿™ä¸ªæ–¹æ³•åç§°ã€‚ public class LambdaUtils { // æ­£å¸¸æƒ…å†µï¼Œè¦åšç¼“å­˜ public static \u003cT\u003e String resolveMethod(SFunction\u003cT, ?\u003e func) { SerializedLambda serializedLambda = resovle(func); String methodName = serializedLambda.getImplMethodName(); return methodName; } @SneakyThrows public static SerializedLambda resovle(SFunction\u003c?, ?\u003e func) { Method method = func.getClass().getDeclaredMethod(\"writeReplace\"); method.setAccessible(true); return (SerializedLambda) method.invoke(func); } } ","date":"2022-10-11","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/:1:0","tags":["IDE"],"title":"åœ¨ java ä¸­å¦‚ä½•è·å– lambda çš„æ–¹æ³•åç§°?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/"},{"categories":null,"content":" 2. ä»£ç å®ç°ä½ç½®æœ¬èŠ‚çš„å†…å®¹ï¼Œæˆ‘å™è¿°çš„ä¸æ˜¯å¾ˆå¥½ï¼Œå¯èƒ½çœ‹çš„ä¸€è„¸æ‡µ, ä½¿ç”¨è¿‡ mybatis-plus çš„äººï¼Œå¯èƒ½ä¼šæœ‰ç‚¹å°è±¡ LambdaQueryWrapperï¼Œ æ¨èçœ‹ä¸‹è¿™ä¸ªæµ‹è¯•ç±» LambdaUtilsTests github åœ°å€ ","date":"2022-10-11","objectID":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/:2:0","tags":["IDE"],"title":"åœ¨ java ä¸­å¦‚ä½•è·å– lambda çš„æ–¹æ³•åç§°?","uri":"/ooooo-notes/%E5%9C%A8-java-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-lambda-%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0/"},{"categories":null,"content":" å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ±  ?","date":"2022-09-13","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/:0:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/"},{"categories":null,"content":" 1. éœ€æ±‚","date":"2022-09-13","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/:1:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/"},{"categories":null,"content":" 2. å®ç°çš„å…³é”®ç‚¹","date":"2022-09-13","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/:2:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/"},{"categories":null,"content":" 3. druid datasource","date":"2022-09-13","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/:3:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/"},{"categories":null,"content":" 4. common-pool2","date":"2022-09-13","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/:4:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªè¿æ¥æ± ","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E6%B1%A0/"},{"categories":null,"content":" å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯¹è±¡æ±  ?","date":"2022-09-12","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/:0:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯¹è±¡æ±  ?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/"},{"categories":null,"content":" 1. éœ€æ±‚","date":"2022-09-12","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/:1:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯¹è±¡æ±  ?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/"},{"categories":null,"content":" 2. ç®€å•çš„å®ç°","date":"2022-09-12","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/:2:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯¹è±¡æ±  ?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/"},{"categories":null,"content":" 3. å®ç°åƒåœ¾å›æ”¶è½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨ ","date":"2022-09-12","objectID":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/:3:0","tags":["java"],"title":"å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¯¹è±¡æ±  ?","uri":"/ooooo-notes/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%B1%A0/"},{"categories":null,"content":"åœ¨ idea ä¸­å®é™…æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯è¿œç«¯æ„å»ºå’Œè¿œç«¯è¿è¡Œã€‚ åœ¨æˆ‘ä»¬å®é™…å¼€å‘é¡¹ç›®ä¸­ï¼Œè‡ªå·±çš„æœ¬åœ°ç¯å¢ƒå’ŒæœåŠ¡å™¨ç¯å¢ƒä¸å¤ªä¸€æ ·ï¼Œä¾‹å¦‚ go å¼€å‘ä¸­çš„ build-tags, è¿˜æœ‰ c/c++ å¼€å‘ä¸­çš„API è°ƒç”¨ä¸ä¸€æ ·ï¼Œæ— æ³•æ¨¡æ‹Ÿç›¸åŒçš„å¼€å‘ç¯å¢ƒã€‚ ","date":"2022-09-12","objectID":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/:0:0","tags":["IDE"],"title":"åœ¨ idea ä¸­ä½¿ç”¨è¿œç«¯ build å’Œ run","uri":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/"},{"categories":null,"content":" 1. é—®é¢˜è¯´æ˜ è¿™é‡Œæ‹¿ è¿è¡Œ kubernetes æ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ã€‚ æˆ‘ä»¬éƒ½çŸ¥é“åœ¨ windows ç³»ç»Ÿ å’Œ mac ç³»ç»Ÿä¸­ï¼Œä½ æ˜¯å¾ˆéš¾åœ¨æœ¬åœ°è¿è¡Œ kubernetes çš„ï¼Œå› ä¸ºéœ€è¦æ¶‰åŠåˆ°å¾ˆå¤šçš„ç»„ä»¶ï¼Œå¾ˆå¤šåŠŸèƒ½ä¹Ÿåªæœ‰åœ¨ linux ç³»ç»Ÿä¸­æ‰ä¼šå¼€å¯ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä»»ä½•ç¨‹åºéƒ½åº”è¯¥æ˜¯æœ‰è¿œç¨‹è°ƒè¯•è¿™ä¸ªåŠŸèƒ½çš„ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½åœ¨æœ¬åœ°å­¦ä¹ æºç æ—¶ä¼šæœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œä¸»è¦ä½“ç°åœ¨è‡ªå·±åœ¨æœ¬åœ°æ”¹äº†æºç ï¼Œéœ€è¦åŒæ­¥åˆ°ä½ è¿œç«¯çš„æœºå™¨ä¸Šï¼Œç„¶å build å’Œ runï¼Œ æ•´å¥—è¿‡ç¨‹ä¸æ˜¯è‡ªåŠ¨çš„ã€‚ ","date":"2022-09-12","objectID":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/:1:0","tags":["IDE"],"title":"åœ¨ idea ä¸­ä½¿ç”¨è¿œç«¯ build å’Œ run","uri":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/"},{"categories":null,"content":" 2. ä½¿ç”¨æ•™ç¨‹ é€‰æ‹©åœ¨è¿œç«¯æœºå™¨ä¸Šè¿è¡Œã€‚ é€‰æ‹©åœ¨è¿œç«¯æœºå™¨ä¸Šæ„å»ºå’Œç¼–è¯‘å®Œæˆåè¿è¡Œã€‚ æŒ‡å®šç¨‹åºå‚æ•°ã€‚ å¦‚ä¸‹å›¾ï¼š åœ¨è¿œç«¯æ„å»ºå’Œè¿è¡Œ æ–°å»ºä¸€ä¸ªtargeté…ç½®ã€‚ æ–°å»ºæˆ–é€‰æ‹©ä¸€ä¸ªsshé…ç½®, å¯¹äº rsync å¯ä»¥ä¸ç”¨å¼€å¯ã€‚ è®¾ç½®è¿œç«¯goçš„æ‰§è¡Œè·¯å¾„ï¼Œè¿™ä¸ªå¿…é¡»è¦æŒ‡å®šï¼Œå¦‚æœ GOPATH ä¸æŒ‡å®šï¼Œåˆ™ä½¿ç”¨è¿œç«¯é»˜è®¤é…ç½®*ã€‚ å»ºè®®æŒ‡å®šä¸€ä¸ªå…·ä½“çš„è·¯å¾„ï¼Œå¦åˆ™ï¼Œæ¯æ¬¡éƒ½ä¼šç”Ÿæˆæ–°çš„ç›®å½•ï¼Œæ„å»ºæ¯”è¾ƒç¼“æ…¢ã€‚ å¦‚ä¸‹å›¾ï¼š åœ¨è¿œç«¯æ„å»ºå’Œè¿è¡Œ ","date":"2022-09-12","objectID":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/:2:0","tags":["IDE"],"title":"åœ¨ idea ä¸­ä½¿ç”¨è¿œç«¯ build å’Œ run","uri":"/ooooo-notes/%E5%9C%A8-idea-%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%AB%AF-build-%E5%92%8C-run/"},{"categories":null,"content":"åœ¨ spring ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šåŸºäºç°æœ‰çš„ä»£ç æ¥æ‰©å±•ä¹‹å‰çš„åŠŸèƒ½ï¼Œæˆ–è€…æ¢ä¸€ä¸ªå®ç°çš„æ–¹å¼ã€‚ åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä½¿ç”¨ BeanPostProcessor æ¥è¿›è¡Œæ‰©å±•ã€‚ è€Œåœ¨è¿™ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä½¿ç”¨ BeanDefinitionRegistryPostProcessor æ¥è¿›è¡Œæ‰©å±•ã€‚ ç”±äºå·²ç»å®ç°è¿‡ä¸€æ¬¡ï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/:0:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½2 ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/"},{"categories":null,"content":" 1. å®ç°æ€è·¯ åˆ¤æ–­ beanName åˆ é™¤åŸæœ‰çš„ beanDefinition æ³¨å†Œæ–°çš„ beanDefinition æ³¨æ„ç‚¹ï¼š æ–°å®ç°çš„ç±»ï¼Œå¿…é¡»è¦æ˜¯ CompositePropertySources çš„å­ç±»ï¼Œå¦åˆ™æ³¨å…¥ä¼šæœ‰é—®é¢˜ æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»é‡æ–°å®ç°ä¸€éï¼Œæ— æ³•å¤ç”¨çˆ¶ç±»çš„æ–¹æ³• @Component public class CompositePropertySourcesBeanDefinitionRegistry implements BeanDefinitionRegistryPostProcessor { public static final String COMPOSITE_PROPERTY_SOURCES_BEAN_NAME = \"compositePropertySources\"; @Override public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException { if (registry.containsBeanDefinition(COMPOSITE_PROPERTY_SOURCES_BEAN_NAME)) { registry.removeBeanDefinition(COMPOSITE_PROPERTY_SOURCES_BEAN_NAME); RootBeanDefinition definition = new RootBeanDefinition(ProxyCompositePropertySources.class); definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR); registry.registerBeanDefinition(COMPOSITE_PROPERTY_SOURCES_BEAN_NAME, definition); } } @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/:1:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½2 ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/"},{"categories":null,"content":" 2. å¦‚ä½•é€‰æ‹© å¦‚æœæ˜¯æ”¹è¿›ä¹‹å‰çš„åŠŸèƒ½ï¼Œå°±ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼, BeanPostProcessor å¦‚æœæ˜¯é‡å†™ä¹‹å‰çš„åŠŸèƒ½ï¼Œå°±ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼, BeanDefinitionRegistryPostProcessor å¦‚æœä¸å¥½é€‰æ‹©ï¼Œå°±å•¥ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ€å¼ºå¤§çš„ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/:2:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½2 ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/"},{"categories":null,"content":" 2. å®Œæ•´ä»£ç å®ç°github åœ°å€ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/:3:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½2 ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD2/"},{"categories":null,"content":"åœ¨ spring ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šåŸºäºç°æœ‰çš„ä»£ç æ¥æ‰©å±•ä¹‹å‰çš„åŠŸèƒ½ï¼Œæˆ–è€…æ¢ä¸€ä¸ªå®ç°çš„æ–¹å¼ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/:0:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½ ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/"},{"categories":null,"content":" 1. åŸæœ‰çš„åŠŸèƒ½åœ¨è¿™é‡ŒåŸºäºä¹‹å‰çš„åŠŸèƒ½è·å–å±æ€§æ¥ç»§ç»­æ·±å…¥ã€‚ å¤§è‡´ä»£ç å¦‚ä¸‹ @Slf4j @Order public class CompositePropertySources implements PropertySources { private final MutablePropertySources mutablePropertySources = new MutablePropertySources(); public CompositePropertySources(List\u003cAbstractSimplePropertySource\u003e sources) { if (sources == null) return; AnnotationAwareOrderComparator.sort(sources); for (AbstractSimplePropertySource source : sources) { mutablePropertySources.addLast(source); } } public boolean containsProperty(String name) { return stream().anyMatch(p -\u003e p.containsProperty(name)); } public String getProperty(String name) { return isBlank(name) ? name : getProperty(name, null); } public String getProperty(String propertyName, String defaultValue) { String value = null; for (PropertySource\u003c?\u003e ps : mutablePropertySources) { value = (String) ps.getProperty(propertyName); if (value != null) { return value; } } return defaultValue; } public Map\u003cString, String\u003e getProperties(String... propertyNames) { if (propertyNames != null) { Map\u003cString, String\u003e map = new HashMap\u003c\u003e(); for (String key : propertyNames) { map.put(key, getProperty(key, null)); } return map; } return null; } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/:1:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½ ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/"},{"categories":null,"content":" 2. æ–°çš„éœ€æ±‚ç”±äºä¹‹å‰çš„åŠŸèƒ½æ˜¯æ ¹æ® key æ¥è·å– valueçš„ï¼Œè€Œç°åœ¨éœ€è¦æ ¹æ®ä¸šåŠ¡ç¼–å·å’Œ key æ¥è·å– valueã€‚ å…ˆæ ¹æ® businType.key æ¥è·å– value å¦‚æœç»“æœä¸æ˜¯ nullï¼Œåˆ™è¿”å› å¦‚æœç»“æœæ˜¯ nullï¼Œ å†æ ¹æ® key æ¥è·å– value æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œä¹Ÿå°±æ˜¯ä¼˜å…ˆå–ä¸šåŠ¡ç±»å‹çš„é…ç½® å› ä¸ºæˆ‘ä»¬çš„åŠŸèƒ½å®é™…ä¸Šåœ¨ä¸Šä¸€ç¯‡å°±å·²ç»å®Œæˆäº†ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œåªéœ€è¦æ‰©å±•åŸæœ‰çš„åŠŸèƒ½å°±è¡Œäº†ã€‚ è¿™é‡Œæˆ‘ä½¿ç”¨ BeanPostProcessor æ¥è¿›è¡Œæ‰©å±•ï¼Œé€‰æ‹©è¿™ä¸ªç±»çš„åŸå› æ˜¯åŸæœ‰çš„ bean å·²ç»ç”Ÿæˆäº†ï¼Œæ— éœ€æ›´æ”¹ bean å®šä¹‰. å®ç°å¦‚ä¸‹ï¼š åˆ¤æ–­ bean æ˜¯å¦ä¸º CompositePropertySources çš„å®ä¾‹ ä½¿ç”¨ ProxyCompositePropertySources å¯¹è±¡æ¥ä»£æ›¿åŸæœ‰çš„ç±» ä½¿ç”¨ propertyNamesFunction æ¥åˆ†éš” propertyName @Component public class CompositePropertySourcesBeanPostProcessor implements BeanPostProcessor { @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { if (bean instanceof CompositePropertySources) { return new ProxyCompositePropertySources((CompositePropertySources) bean); } return bean; } protected static class ProxyCompositePropertySources extends CompositePropertySources { private final CompositePropertySources compositePropertySources; public ProxyCompositePropertySources(CompositePropertySources compositePropertySources) { super(null); this.compositePropertySources = compositePropertySources; } @Override public String getProperty(String propertyName, String defaultValue) { String[] propertyNames = propertyNamesFunction.apply(propertyName); for (String p : propertyNames) { String v = compositePropertySources.getProperty(p); if (v != null) { return v; } } return defaultValue; } @Override public boolean containsProperty(String propertyName) { String[] propertyNames = propertyNamesFunction.apply(propertyName); for (String p : propertyNames) { boolean contains = compositePropertySources.containsProperty(p); if (contains) { return true; } } return false; } } private static final Function\u003cString, String[]\u003e propertyNamesFunction = (propertyName) -\u003e { if (propertyName == null) { return new String[0]; } propertyName = propertyName.trim(); if (propertyName.contains(\".\")) { return new String[]{propertyName, propertyName.substring(propertyName.lastIndexOf(\".\") + 1)}; } return new String[]{propertyName}; }; } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/:2:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½ ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/"},{"categories":null,"content":" 3. å®Œæ•´ä»£ç å®ç°github åœ°å€ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/:3:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•æ‰©å±•ç°æœ‰ç±»çš„åŠŸèƒ½ ?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%E7%8E%B0%E6%9C%89%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD/"},{"categories":null,"content":" 1. éœ€æ±‚å¸Œæœ›æ ¹æ® propertyName æ¥è·å–ç›¸åº”çš„ propertyValue, è¿™ä¸ªæ¥å£éœ€è¦æ”¯æŒå¤šç§æ•°æ®æ¥æºã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:1:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 2. è®¾è®¡æ¥å£å¾ˆæ˜æ˜¾è¿™ä¸ªæ¥å£åº”è¯¥è®¾è®¡ä¸ºè¿™æ ·, æœ‰ä¸€ä¸ªæ–¹æ³•ä¸º Object getProperty(String name) æ¥è·å–å±æ€§ã€‚ å› ä¸ºæ˜¯åœ¨ spring ä¸­ï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥å¤ç”¨äº† org.springframework.core.env.PropertySource, ä½†è¿™ä¸ªç±»éœ€è¦æ³›å‹ï¼Œæ‰€ä»¥æˆ‘å°±éšä¾¿å®ç°äº†ä¸€ä¸ª Map\u003cString, String\u003e çš„æ³›å‹ï¼Œä¹Ÿä¸ä¼šç”¨åˆ°è¿™ä¸ªã€‚ æŠ½è±¡ç±»çš„è®¾è®¡å¦‚ä¸‹ï¼š public abstract class AbstractSimplePropertySource extends PropertySource\u003cMap\u003cString, String\u003e\u003e implements EnvironmentAware { protected Environment environment; public AbstractSimplePropertySource(String name) { super(name, Collections.emptyMap()); } public void setEnvironment(@NonNull Environment environment) { this.environment = environment; } public Environment getEnvironment() { return environment; } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:2:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 3. å…·ä½“ç±»çš„å®ç°","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:3:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 3.1 æ ¹æ®è¯·æ±‚å‚æ•°æ¥è·å–é…ç½® å…ˆä»è¯·æ±‚å‚æ•°ä¸­è·å– å†ä»è¯·æ±‚å¤´ä¸­è·å– ä»£ç é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæˆ‘å°±ä¸è§£é‡Šäº†ã€‚ è¿™ç§å½¢å¼ï¼Œè§£å†³äº†å‰ç«¯å¯ä»¥ä¼ å…¥ç›¸åº”çš„é…ç½®ï¼Œæ¥æ”¹å˜åç«¯çš„æ‰§è¡Œé€»è¾‘ã€‚ @Order(0) public class RequestParamsPropertySource extends AbstractSimplePropertySource { public RequestParamsPropertySource() { super(ENV_PREFIX + \"request_params\"); } @Override public Object getProperty(String name) { String propertyKey = ENV_PREFIX + name.replace(\".\", \"_\"); String propertyValue = null; try { // å…ˆè¯·æ±‚å‚æ•°ä¸­è·å– ServletRequestAttributes attr = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes(); HttpServletRequest request = attr.getRequest(); propertyValue = request.getParameter(propertyKey); if (StringUtils.isBlank(propertyValue)) { // å†ä»è¯·æ±‚å¤´ä¸­è·å– propertyValue = request.getHeader(propertyKey); } } catch (Throwable ignored) { } // ç©ºå­—ç¬¦ä¹Ÿå½“åšnull propertyValue = defaultIfBlank(propertyValue, null); return propertyValue; } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:3:1","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 3.2 æ ¹æ®ç¯å¢ƒå˜é‡æ¥è·å–é…ç½®ä»£ç é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæˆ‘å°±ä¸è§£é‡Šäº†ã€‚ @Order(2) public class EnvironmentPropertySource extends AbstractSimplePropertySource { public EnvironmentPropertySource() { super(ENV_PREFIX + \"environment\"); } @Override public Object getProperty(String name) { String env_property_key = ENV_PREFIX + name.replace(\".\", \"_\"); return System.getenv(env_property_key.toUpperCase()); } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:3:2","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 3.3 æ ¹æ®æœ¬åœ°é…ç½®æ–‡ä»¶æ¥è·å–å‚æ•° åœ¨å®é™…å¼€å‘è¿‡ç¨‹ï¼Œå¤§å®¶å¯èƒ½æ˜¯å…±ç”¨ä¸€å¥—æ•°æ®åº“ç¯å¢ƒï¼Œåœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸€ä¸ªäººæ”¹äº†æ•°æ®åº“é…ç½®ï¼Œè¿™æ ·ä¼šå¯¹å…¶ä»–äººé€ æˆå½±å“ï¼Œæ‰€ä»¥å¿…é¡»è¦è®¾è®¡å‡ºä¸€ä¸ªç”¨äºå¼€å‘çš„é…ç½®ç±»ã€‚ ä½¿ç”¨ apache çš„ configuration åŒ…ï¼Œæ¥å®ç°é…ç½®æ–‡ä»¶çš„åŠ¨æ€åˆ·æ–° ä» builder.getConfiguration() å¯¹è±¡ä¸­è·å–é…ç½® å¤§è‡´ä»£ç å¦‚ä¸‹ï¼š @Order(1) public class LocalPropertiesPropertySource extends AbstractSimplePropertySource implements InitializingBean { @Autowired private ApplicationEventPublisher publisher; private ReloadingFileBasedConfigurationBuilder\u003cPropertiesConfiguration\u003e builder; private static final String DEFAULT_LOCAL_PROPERTIES_PATH = \"sysoptions.properties\"; public LocalPropertiesPropertySource() { super(ENV_PREFIX + \"local_properties\"); log.debug(\"å¼€å‘ç¯å¢ƒï¼Œå¯ç”¨[{}]é…ç½®\", getClass()); } @Override public void afterPropertiesSet() { Integer sysOptionsLoadInterval = getEnvironment().getProperty(\"dev.localPropertiesLoadInterval\", Integer.class, 1); String sysOptionsPath = getEnvironment().getProperty(\"dev.localPropertiesPath\", DEFAULT_LOCAL_PROPERTIES_PATH); File propertiesFile = new File(sysOptionsPath); if (!propertiesFile.exists()) { return; } // server boot will publish event publisher.publishEvent(new LocalProperitesReReloadingEvent(new Object(), propertiesFile.getAbsolutePath())); builder = new ReloadingFileBasedConfigurationBuilder\u003c\u003e(PropertiesConfiguration.class).configure(new Parameters().fileBased().setFile(propertiesFile)); ReloadingController reloadingController = builder.getReloadingController(); reloadingController.addEventListener(ReloadingEvent.ANY, e -\u003e publisher.publishEvent(new LocalProperitesReReloadingEvent(e, propertiesFile.getAbsolutePath()))); PeriodicReloadingTrigger trigger = new PeriodicReloadingTrigger(reloadingController, null, sysOptionsLoadInterval, SECONDS); trigger.start(); } @Override public Object getProperty(@NonNull String name) { if (builder == null) return null; Configuration configuration = null; try { configuration = builder.getConfiguration(); String config_value = configuration.getString(name); if (config_value != null) { return config_value; } } catch (ConfigurationException e) { log.error(e.getMessage(), e); } return null; } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:3:3","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 3.4 å…¶ä»–çš„æ‰©å±•åˆ°è¿™é‡Œï¼Œä½ å°±åº”è¯¥å¾ˆæ¸…æ¥šçš„çŸ¥é“æ€ä¹ˆå»æ‰©å±•å…¶ä»–çš„ç±»äº†ï¼Œæ¯”å¦‚æ•°æ®åº“çš„å®ç°ï¼Œ redis çš„å®ç° ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:3:4","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 4. ä½¿ç”¨çš„å…¥å£ä¸Šé¢åªæ˜¯å®šä¹‰äº†ä¸€ä¸ªæ¥å£å’Œå‡ ä¸ªå®ç°ç±»ï¼Œç»Ÿä¸€çš„å…¥å£ç±»ï¼Œå®é™…ä¸Šè¿˜æ²¡æœ‰ã€‚ ä½¿ç”¨æ„é€ å‡½æ•°çš„æ–¹å¼æ¥æ³¨å…¥æ‰€æœ‰çš„ AbstractSimplePropertySource ã€‚ å¯¹äºæ¯ä¸ªè·å–é…ç½®çš„ç±»ï¼Œè‚¯å®šæœ‰ä¼˜å…ˆçº§ï¼Œæ‰€ä»¥è¦æ’åºã€‚ ä½¿ç”¨ MutablePropertySources è¿™ä¸ªç±»åšè¾…åŠ©ã€‚ å¤§è‡´ä»£ç å¦‚ä¸‹ï¼š @Slf4j @Order public class CompositePropertySources implements PropertySources { private final MutablePropertySources mutablePropertySources = new MutablePropertySources(); public CompositePropertySources(List\u003cAbstractSimplePropertySource\u003e sources) { if (sources == null) return; AnnotationAwareOrderComparator.sort(sources); for (AbstractSimplePropertySource source : sources) { mutablePropertySources.addLast(source); } } public boolean containsProperty(String name) { return stream().anyMatch(p -\u003e p.containsProperty(name)); } public String getProperty(String name) { return isBlank(name) ? name : getProperty(name, null); } public String getProperty(String propertyName, String defaultValue) { String value = null; for (PropertySource\u003c?\u003e ps : mutablePropertySources) { value = (String) ps.getProperty(propertyName); if (value != null) { return value; } } return defaultValue; } public Map\u003cString, String\u003e getProperties(String... propertyNames) { if (propertyNames != null) { Map\u003cString, String\u003e map = new HashMap\u003c\u003e(); for (String key : propertyNames) { map.put(key, getProperty(key, null)); } return map; } return null; } } ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:4:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":" 5. å®Œæ•´ä»£ç å®ç°github åœ°å€ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/:5:0","tags":["java","spring","spring-extension"],"title":"åœ¨ spring ä¸­å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·å–é…ç½®çš„æ¥å£?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E7%9A%84%E6%8E%A5%E5%8F%A3/"},{"categories":null,"content":"ä½œä¸ºä¸€ä¸ª Java å¼€å‘ï¼ŒSpring çš„æŠ€æœ¯å¯ä»¥è¯´æ˜¯å¿…é¡»è¦æŒæ¡çš„ï¼Œä¸ä»…ä»…æ˜¯ä¼šä½¿ç”¨ï¼Œè€Œä¸”è¦æŒæ¡åŸç†ï¼Œå­¦ä¼šæ‰©å±•ã€‚ ä»Šå¤©æˆ‘å°±è¯´è¯´ï¼Œå“ªäº›æ ¸å¿ƒç±»å’Œæ‰©å±•ç±»æ˜¯å¿…é¡»è¦æŒæ¡çš„ï¼ŒåŒæ—¶æˆ‘ä¹Ÿè¯´æ˜è¿™äº›æ‰©å±•å¯ä»¥å¹²ä»€ä¹ˆï¼Œåé¢ Spring æ–‡ç« ï¼Œæˆ‘ä¼šç”¨åˆ°è¿™äº›æ‰©å±•ç±»ï¼Œè®©ä½ å­¦æ‡‚è¿™äº›ç±»ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/:0:0","tags":["java","spring"],"title":"åœ¨ spring ä¸­æœ‰å“ªäº›æ ¸å¿ƒç±»å’Œæ‰©å±•ç±»?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/"},{"categories":null,"content":" æ ¸å¿ƒç±»ï¼šIOCå®¹å™¨: org.springframework.context.ApplicationContext é…ç½®ç±»: org.springframework.core.env.Environment Beanå·¥å‚ï¼šorg.springframework.beans.factory.BeanFactory äº‹ä»¶å‘å¸ƒå™¨ï¼š org.springframework.context.ApplicationEventPublisher èµ„æºåŠ è½½å™¨ï¼š org.springframework.core.io.ResourceLoader ä¸Šé¢è¿™å‡ ä¸ªç±»ï¼Œæ˜¯æˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ°çš„ã€‚å®ƒä»¬éƒ½æœ‰ç›¸åº”çš„ Aware æ¥å£, å¦‚ org.springframework.context.ApplicationContextAware, å¯ä»¥è®¾ç½® applicationContext å¯¹è±¡åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ bean å¯¹è±¡ä¸­. æ³¨æ„è¿™æ · setApplicationContext çš„æ–¹å¼æ¯” @Autowired æ³¨è§£æ³¨å…¥ applicationContext çš„æ–¹å¼çš„æ—¶æœºè¦æ—©å¾ˆå¤šï¼Œæ‰€ä»¥ä¸€èˆ¬æ¨èç”¨ setApplicationContext çš„æ–¹å¼ã€‚ ç›¸åº”çš„æºç  ApplicationContextAwareProcessor ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/:1:0","tags":["java","spring"],"title":"åœ¨ spring ä¸­æœ‰å“ªäº›æ ¸å¿ƒç±»å’Œæ‰©å±•ç±»?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/"},{"categories":null,"content":" æ‰©å±•ç±»beanFactoryçš„åç½®å¤„ç†å™¨ï¼š org.springframework.beans.factory.config.BeanFactoryPostProcessor beançš„åç½®å¤„ç†å™¨ï¼š org.springframework.beans.factory.config.BeanPostProcessor ä¸Šé¢çš„ä¸¤ä¸ªç±»éå¸¸é‡è¦ï¼Œå¦‚æœä½ ç°åœ¨è¿˜ä¸ä¼šç†Ÿç»ƒä½¿ç”¨å®ƒä»¬ï¼Œè¯´æ˜ spring æŒæ¡çš„å¾ˆä¸€èˆ¬ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/:2:0","tags":["java","spring"],"title":"åœ¨ spring ä¸­æœ‰å“ªäº›æ ¸å¿ƒç±»å’Œæ‰©å±•ç±»?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/"},{"categories":null,"content":" éå¸¸æœ‰ç”¨çš„ç±»ä»£ç†å·¥å‚ï¼š org.springframework.aop.framework.ProxyFactory beanå·¥å‚ï¼š org.springframework.beans.factory.ObjectFactory å±æ€§ç»‘å®šï¼š org.springframework.boot.context.properties.bind.Binder é€‰æ‹©æ€§å¯¼å…¥bean: org.springframework.context.annotation.ImportSelector ä¸Šé¢è¿™å‡ ä¸ªç±»ï¼Œä¸€èˆ¬åœ¨æ‰©å±•åŠŸèƒ½æ—¶ï¼Œéƒ½ä¼šç”¨åˆ°ã€‚ ","date":"2022-09-05","objectID":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/:3:0","tags":["java","spring"],"title":"åœ¨ spring ä¸­æœ‰å“ªäº›æ ¸å¿ƒç±»å’Œæ‰©å±•ç±»?","uri":"/ooooo-notes/%E5%9C%A8-spring-%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%92%8C%E6%89%A9%E5%B1%95%E7%B1%BB/"},{"categories":null,"content":" 1. ä¸‹è½½ä»£ç  git clone git@github.com:apache/tomcat.git ","date":"2022-08-10","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["tomcat","source code"],"title":"æ­å»º tomcat æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 2. å®‰è£…ant æˆ‘æœ¬åœ°å®‰è£…çš„æ˜¯ 1.10.12 ç‰ˆæœ¬, ant ä¸‹è½½åœ°å€ é…ç½®ç¯å¢ƒå˜é‡ ANT_HOME, åŠ å…¥åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ æ‰§è¡Œå‘½ä»¤éªŒè¯ ant -version ","date":"2022-08-10","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["tomcat","source code"],"title":"æ­å»º tomcat æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 3. å¯¼å…¥åˆ° idea ä¸­ # è¿›å…¥ tomcat æ ¹ç›®å‰ cd tomcat # å¤åˆ¶é…ç½®æ–‡ä»¶ build.properties cp build.properties.default build.properties # æ›´æ”¹ build.properties ä¸­çš„é…ç½® base.path=ç¬¬ä¸‰æ–¹jarçš„ä¸‹è½½ç›®å½• # è®¾ç½® idea ant ide-intellij # æ‰§è¡Œç¼–è¯‘å‘½ä»¤, ä¼šç”Ÿæˆ output ç›®å½• ant deploy ç„¶åç”¨ idea æ‰“å¼€é¡¹ç›®ï¼Œidea ä¼šå¼¹å‡ºè®©ä½ é…ç½®ä¸‹é¢çš„å˜é‡ ANT_HOME = ${ant.home} TOMCAT_BUILD_LIBS = ${base.path} ","date":"2022-08-10","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:3:0","tags":["tomcat","source code"],"title":"æ­å»º tomcat æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 4. idea ä¸­ é…ç½® æ£€æŸ¥ä½ çš„é¡¹ç›®ä¾èµ–æœ‰æ²¡æœ‰é—®é¢˜ é¡¹ç›®ä¾èµ–é…ç½® ä¸Šé¢çš„ä¸‰ä¸ªä¾èµ–ï¼Œå…¶å®å°±æ˜¯ ServletContainerInitializer çš„å®ç°, æ¯”å¦‚ res/META-INF/jasper.jar/services/jakarta.servlet.ServletContainerInitializer. æ›´æ”¹é…ç½®æ–‡ä»¶ conf/server.xml # æ”¹ä¸ºç¼–è¯‘è¾“å‡ºç›®å½• appBase=\"output/build/webapps\" è¿è¡Œç¨‹åº org.apache.catalina.startup.Bootstrap#main ","date":"2022-08-10","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:4:0","tags":["tomcat","source code"],"title":"æ­å»º tomcat æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-tomcat-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" deployment èµ„æºæ˜¯æˆ‘ä»¬ç»å¸¸éœ€è¦ä½¿ç”¨çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ€åº”è¯¥ç†Ÿæ‚‰çš„æºç . å¯¹äºè°ƒè¯•æºç ï¼Œæˆ‘ä½¿ç”¨æ˜¯ deployment_controller_test.go æµ‹è¯•ç±»ï¼Œ TestSyncDeploymentCreatesReplicaSet æ–¹æ³•. ","date":"2022-07-15","objectID":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/:0:0","tags":["k8s","cloud native","source code"],"title":"è°ƒè¯• deployment-controller çš„æºç ","uri":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/"},{"categories":null,"content":" TestSyncDeploymentCreatesReplicaSet æµ‹è¯•æ–¹æ³•çš„ç»“æ„æºç è·¯å¾„ï¼škubernetes\\pkg\\controller\\deployment\\deployment_controller_test.go æµ‹è¯•é…ç½®å¯¹è±¡ f := newFixture(t) åˆ›å»ºä¸€ä¸ª fixture å¯¹è±¡ï¼Œ é‡Œé¢æœ‰ objects å±æ€§ï¼Œè¿™ä¸ªç”¨æ¥æ¨¡æ‹Ÿ clientSet, ä¹Ÿå°±æ˜¯è¯·æ±‚ etcd çš„æ¥å£ï¼Œåé¢å°†ä¼šè¯¦ç»†æè¿°ã€‚ åˆ›å»ºä¸€ä¸ª Deployment å¯¹è±¡ï¼Œ æ ‡ç­¾ä¸º â€œfooâ€: â€œbarâ€ d := newDeployment(\"foo\", 1, nil, nil, nil, map[string]string{\"foo\": \"bar\"}) æ·»åŠ ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºåç»­çš„Listæ¥å£ f.dLister = append(f.dLister, d) f.objects = append(f.objects, d) åˆ›å»ºä¸€ä¸ª ReplicaSet å¯¹è±¡ rs := newReplicaSet(d, \"deploymentrs-4186632231\", 1) å¸Œæœ›çš„æµ‹è¯•ç»“æœ f.expectCreateRSAction(rs) f.expectUpdateDeploymentStatusAction(d) f.expectUpdateDeploymentStatusAction(d) ä»ä¸Šé¢çš„è¯­å¥å°±å¯ä»¥å‘ç°ï¼Œkubernetes çš„æµ‹è¯•ç±»ï¼Œæ„å›¾éå¸¸æ˜ç¡®ã€‚ ä¹Ÿå°±æ˜¯è¯´ æˆ‘åˆ›å»ºä¸€ä¸ª Deployment ** å¯¹è±¡ï¼Œè‚¯å®šä¼šäº§ç”Ÿä¸€ä¸ª ReplicaSet å¯¹è±¡ï¼Œå¹¶ä¸” DeploymentStatus ä¼šè¢«æ›´æ–°ä¸¤æ¬¡, æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯kuberneteså¦‚ä½•åšåˆ°çš„ã€‚ ","date":"2022-07-15","objectID":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/:1:0","tags":["k8s","cloud native","source code"],"title":"è°ƒè¯• deployment-controller çš„æºç ","uri":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/"},{"categories":null,"content":" æµ‹è¯•æ–¹æ³•çš„æ‰§è¡Œ f.run(testutil.GetKey(d, t)) è·å– Deployment çš„ key å±æ€§ ä»£ç  testutil.GetKey(d, t) func GetKey(obj interface{}, t *testing.T) string { // æ¯ä¸ªåˆ é™¤çš„å¯¹è±¡éƒ½æ˜¯è¿™ä¸ªç±»å‹, è¿™é‡Œå–å‡ºäº†çœŸå®çš„å¯¹è±¡ tombstone, ok := obj.(cache.DeletedFinalStateUnknown) if ok { // if tombstone , try getting the value from tombstone.Obj obj = tombstone.Obj } // å–å‡ºæŒ‡é’ˆç±»å‹ä¸­ valueï¼Œè·å– Name å±æ€§ val := reflect.ValueOf(obj).Elem() name := val.FieldByName(\"Name\").String() if len(name) == 0 { t.Errorf(\"Unexpected object %v\", obj) } // è·å–key, ç»“æœå°±æ˜¯ {namespace}/{name} key, err := keyFunc(obj) if err != nil { t.Errorf(\"Unexpected error getting key for %T %v: %v\", val.Interface(), name, err) return \"\" } return key } è°ƒç”¨ fixture.run_() æ–¹æ³• è¿™ä¸ªå‡½æ•°æœ‰ä¸‰ä¸ªå…¥å‚ï¼šrun_(deploymentName string, startInformers bool, expectError bool). å½“å‰çš„æµ‹è¯•æ–¹æ³• TestSyncDeploymentCreatesReplicaSet çš„ startInformers å‚æ•°ä¸º false, è¡¨ç¤ºä¸å¯åŠ¨ Informer, åç»­ä¼šç”¨å¦å¤–ä¸€ä¸ªæµ‹è¯•ç±»æ¥è¯´æ˜ Informer çš„å¯åŠ¨è¿‡ç¨‹. æ¥ä¸‹æ¥è¯¦ç»†çœ‹çœ‹ fixture.run_() æ–¹æ³•éƒ½å¹²äº†å•¥ã€‚ åˆ›å»ºä¸€ä¸ª controller c, informers, err := f.newController() func (f *fixture) newController() (*DeploymentController, informers.SharedInformerFactory, error) { // è¿™ä¸ªä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„ï¼Œobjects ä¼šç”¨æ¥æ„å»º æ¨¡æ‹Ÿçš„ clientSet f.client = fake.NewSimpleClientset(f.objects...) // åˆ›å»ºäº† informer å’Œ deploymentController informers := informers.NewSharedInformerFactory(f.client, controller.NoResyncPeriodFunc()) c, err := NewDeploymentController(informers.Apps().V1().Deployments(), informers.Apps().V1().ReplicaSets(), informers.Core().V1().Pods(), f.client) if err != nil { return nil, nil, err } // æ¨¡æ‹Ÿä¸€ä¸ª recorder c.eventRecorder = \u0026record.FakeRecorder{} // æ‰€æœ‰çŠ¶æ€é»˜è®¤ä¸º synced c.dListerSynced = alwaysReady c.rsListerSynced = alwaysReady c.podListerSynced = alwaysReady // ä¸‹é¢è¿™ä¸ªä»£ç å¾ˆå…³é”® // å…ˆå‰åœ¨ fixture å¯¹è±¡ä¸­åŠ å…¥äº†ç›¸åº”çš„ Listerï¼Œåœ¨è¿™é‡Œéå†è¿™äº› Lister, å°±æ˜¯ä¸ºäº†æ¨¡æ‹Ÿ Informer çš„æœ¬åœ°ç¼“å­˜ // kube_controller_manager ç¨‹åºå¯åŠ¨ä¹‹åï¼Œä¼šè¯·æ±‚ kube_apiserver æ¥è·å–ç›¸åº”çš„èµ„æºï¼Œä»è€Œæ›´æ–°åˆ°è‡ªå·±çš„ç¼“å­˜ä¸­ for _, d := range f.dLister { informers.Apps().V1().Deployments().Informer().GetIndexer().Add(d) } for _, rs := range f.rsLister { informers.Apps().V1().ReplicaSets().Informer().GetIndexer().Add(rs) } for _, pod := range f.podLister { informers.Core().V1().Pods().Informer().GetIndexer().Add(pod) } return c, informers, nil } è¯¦ç»†åˆ†ææ˜¯æ€ä¹ˆæ¨¡æ‹Ÿ clientSet çš„ï¼Ÿ f.client = fake.NewSimpleClientset(f.objects...) func NewSimpleClientset(objects ...runtime.Object) *Clientset { // è¿™ä¸ªæ˜¯æ¨¡æ‹Ÿçš„æœ€ç»ˆå®ç°å¯¹è±¡ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¾èµ–å®ƒæ¥å®Œæˆçš„ o := testing.NewObjectTracker(scheme, codecs.UniversalDecoder()) // éå†å¯¹è±¡ï¼Œä¾æ¬¡æ·»åŠ  for _, obj := range objects { if err := o.Add(obj); err != nil { panic(err) } } // åˆ›å»ºä¸€ä¸ª clientSet cs := \u0026Clientset{tracker: o} // ä¸‹é¢ä¸‰ä¸ªéƒ½æ˜¯ä¾èµ– tracker æ¥å®ç°çš„ï¼Œ é€šè¿‡ä¸åŒçš„ Action, æ¯”å¦‚ ListActionImplã€GetActionImpl ç­‰ cs.discovery = \u0026fakediscovery.FakeDiscovery{Fake: \u0026cs.Fake} cs.AddReactor(\"*\", \"*\", testing.ObjectReaction(o)) cs.AddWatchReactor(\"*\", func(action testing.Action) (handled bool, ret watch.Interface, err error) { gvr := action.GetResource() ns := action.GetNamespace() watch, err := o.Watch(gvr, ns) if err != nil { return false, nil, err } return true, watch, nil }) return cs } ObjectTracker å¦‚æœæ·»åŠ å¯¹è±¡çš„ï¼Ÿ testing.NewObjectTracker(scheme, codecs.UniversalDecoder()) func (t *tracker) Add(obj runtime.Object) error { // æ·»åŠ  List if meta.IsListType(obj) { return t.addList(obj, false) } // ç”¨æ¥è·å– namespace objMeta, err := meta.Accessor(obj) // è·å– gvk gvks, _, err := t.scheme.ObjectKinds(obj) for _, gvk := range gvks { // NOTE: UnsafeGuessKindToResource is a heuristic and default match. The // actual registration in apiserver can specify arbitrary route for a // gvk. If a test uses such objects, it cannot preset the tracker with // objects via Add(). Instead, it should trigger the Create() function // of the tracker, where an arbitrary gvr can be specified. gvr, _ := meta.UnsafeGuessKindToResource(gvk) // Resource doesn't have the concept of \"__internal\" version, just set it to \"\". if gvr.Version == runtime.APIVersionInternal { gvr.Version = \"\" } // æ·»åŠ è¿™ä¸ª err := t.add(gvr, obj, objMeta.GetNamespace(), false) if err != nil { return err } } return nil } func (t *tracker) add(gvr schema.GroupVersionResource, obj runtime.Object, ns s","date":"2022-07-15","objectID":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/:2:0","tags":["k8s","cloud native","source code"],"title":"è°ƒè¯• deployment-controller çš„æºç ","uri":"/ooooo-notes/%E8%B0%83%E8%AF%95-deployment-controller-%E7%9A%84%E6%BA%90%E7%A0%81/"},{"categories":null,"content":" 1. GVK å®šä¹‰GVK(group version kind): èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºç±»å‹ è¡¨ç¤º apps ç»„ä¸‹ v1 ç‰ˆæœ¬ Deployment ç±»å‹çš„èµ„æºã€‚ apiVersion: apps/v1 kind: Deployment è¡¨ç¤º core ç»„ä¸‹ v1 ç‰ˆæœ¬ Pod ç±»å‹çš„èµ„æºã€‚(æ²¡æœ‰ç»„ä¿¡æ¯è¡¨ç¤ºæ ¸å¿ƒç»„) apiVersion: v1 kind: Pod ","date":"2022-07-02","objectID":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/:1:0","tags":["k8s","cloud native","source code"],"title":"å­¦ä¹  k8s æºç çš„å‰ç½®çŸ¥è¯†","uri":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/"},{"categories":null,"content":" 2. kubernetes å¯¹è±¡ç»“æ„æ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ã€‚ ä¾‹å¦‚ Deployment èµ„æºï¼š TypeMeta: GVK ä¿¡æ¯ ObjectMeta: å¯¹è±¡å…ƒæ•°æ®ï¼Œæ¯”å¦‚æœ‰å±æ€§ nameã€namespace DeploymentSpec: å¯¹è±¡å®šä¹‰è§„èŒƒï¼Œæ¯”å¦‚æœ‰å±æ€§ replicas(æ§åˆ¶å‰¯æœ¬æ•°é‡)ã€template(å®šä¹‰ Pod çš„æ¨¡æ¿)ã€selector(æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ Pod æ ‡ç­¾ä¸€æ ·)ã€strategy(Pod å‡çº§ç­–ç•¥) DeploymentStatus: å¯¹è±¡è¿è¡Œæ—¶çŠ¶æ€ï¼Œ æ¯”å¦‚æœ‰å±æ€§ replicas(æ€»çš„å‰¯æœ¬æ•°) ä»£ç è·¯å¾„ï¼škubernetes\\vendor\\k8s.io\\api\\apps\\v1\\types.go type Deployment struct { metav1.TypeMeta `json:\",inline\"` // Standard object's metadata. // More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata // +optional metav1.ObjectMeta `json:\"metadata,omitempty\" protobuf:\"bytes,1,opt,name=metadata\"` // Specification of the desired behavior of the Deployment. // +optional Spec DeploymentSpec `json:\"spec,omitempty\" protobuf:\"bytes,2,opt,name=spec\"` // Most recently observed status of the Deployment. // +optional Status DeploymentStatus `json:\"status,omitempty\" protobuf:\"bytes,3,opt,name=status\"` } ","date":"2022-07-02","objectID":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/:2:0","tags":["k8s","cloud native","source code"],"title":"å­¦ä¹  k8s æºç çš„å‰ç½®çŸ¥è¯†","uri":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/"},{"categories":null,"content":" 3. kubernetes æºç ç›®å½•ç»“æ„ cmd: å¯æ‰§è¡Œç¨‹åºåŒ…ï¼Œ ä¾‹å¦‚ kubelet çš„å…¥å£ä¸º kubernetes\\cmd\\kubelet\\kubelet.go pkg: kubernetes åŒ…è·¯å¾„, æœ‰äº›å­ç›®å½•ä¸ cmd ç›®å½•ä¸€æ ·ï¼Œå°±æ˜¯å…¥å£æ–‡ä»¶ä¾èµ–çš„åŒ… vendor: ç¬¬ä¸‰æ–¹åŒ…ï¼Œå…¶ä¸­ä¹Ÿæœ‰ kubernetes çš„åŒ… plugin: å‡†å…¥æ’ä»¶å’Œè®¤è¯æ’ä»¶ hack: è„šæœ¬è·¯å¾„ï¼Œéå¸¸æœ‰ç”¨ api: OpenAPI å®šä¹‰ ä¸Šè¿°,åªæ˜¯ç®€å•çš„æè¿°äº†ï¼Œç›®å‰åªéœ€è¦çŸ¥é“ cmd, pkg, vendor æ˜¯éå¸¸é‡è¦çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸çœ‹çš„ã€‚ ","date":"2022-07-02","objectID":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/:3:0","tags":["k8s","cloud native","source code"],"title":"å­¦ä¹  k8s æºç çš„å‰ç½®çŸ¥è¯†","uri":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/"},{"categories":null,"content":" 4. å¦‚ä½•å»é˜…è¯»æºç ï¼ŒçœŸçš„éœ€è¦æŠŠæ•´ä¸ªé¡¹ç›®éƒ½è¿è¡Œèµ·æ¥å—ï¼Ÿæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯å®Œå…¨ä¸éœ€è¦ã€‚ ä¸€èˆ¬æ¥è¯´çœ‹æºç ï¼Œåªéœ€è¦äº†è§£ä¸»çº¿ä»£ç ï¼ŒçŸ¥é“å“ªäº›ç±»æ˜¯æ€ä¹ˆé…åˆçš„ï¼Œä¸€èµ·å®Œæˆäº†ä»€ä¹ˆæ ·çš„åŠŸèƒ½ï¼Œå³ä½¿ä½ æŠŠæ•´ä¸ªç¨‹åºéƒ½è¿è¡Œèµ·æ¥äº†ï¼Œæœ‰äº›åˆ†æ”¯æ¡ä»¶çš„ä»£ç ï¼Œéœ€è¦ç‰¹æ®Šçš„è¾“å…¥æ•°æ®ï¼Œåœ¨ä½ ä¸ç†Ÿæ‚‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œä½ ä¹Ÿå¾ˆéš¾å»æ¨¡æ‹Ÿï¼Œè¿™æ—¶å€™æˆ‘ä»¬åªèƒ½çœ‹ä»£ç çš„æµ‹è¯•ç±» ï¼Œæ¥äº†è§£ä»£ç æ˜¯æ€æ ·å¤„ç†è¿™ä¸ªç‰¹æ®Šæ•°æ®çš„ã€‚ ç‰¹æ„è¯´æ˜ä¸€ä¸‹ï¼š ä»¥åçš„é˜…è¯»ä»£ç çš„éƒ¨åˆ†ï¼Œæˆ‘åŸºæœ¬ä»¥æµ‹è¯•ç±»æ¥å¸¦é¢†å¤§å®¶é˜…è¯»ã€‚ ","date":"2022-07-02","objectID":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/:4:0","tags":["k8s","cloud native","source code"],"title":"å­¦ä¹  k8s æºç çš„å‰ç½®çŸ¥è¯†","uri":"/ooooo-notes/%E5%AD%A6%E4%B9%A0-k8s-%E6%BA%90%E7%A0%81%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/"},{"categories":null,"content":" 1. æ–¹æ³•1ï¼Œåœ¨æœ¬æœºçš„ IDE æ¥è°ƒè¯•æºç å¦‚æœä½ æ˜¯ linux ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ linux ä¸­æ­å»ºä¸€ä¸ª kubernetes å•æœºçš„é›†ç¾¤ï¼Œåœ¨æ­¤ç³»ç»Ÿä¸­å®‰è£… IDE(Goland) æ¥è°ƒè¯•. å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:0","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 1. ä¸‹è½½æºç  (go çš„ç‰ˆæœ¬è¦æ±‚ 1.18.x) git clone git@github.com:kubernetes/kubernetes.git cd kubernetes git checkout -b origin/release-1.24 go mod download ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:1","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 2. ç”¨ IDE æ‰“å¼€ kubernetes æºç ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:2","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 3. æ‰¾åˆ°æœåŠ¡çš„å¯åŠ¨å‚æ•°ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ # æ‰§è¡Œå‘½ä»¤ ps aux | grep kube-controller-manager | grep -v grep # å‘½ä»¤æ‰§è¡Œä¹‹åï¼Œè¾“å‡ºå¦‚ä¸‹, kube-controller-manager åé¢çš„å°±æ˜¯ç¨‹åºçš„å‚æ•° root 1584 4.0 0.8 820020 110072 ? Ssl 23:28 0:02 kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/etc/kubernetes/pki/ca.crt --cluster-cidr=10.244.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --root-ca-file=/etc/kubernetes/pki/ca.crt --service-account-private-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --use-service-account-credentials=true ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:3","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 4. ç§»åŠ¨ kubernetes çš„é™æ€ pod ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ cd /etc/kubernetes mv manifests/kube-controller-manager.yaml ./ ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:4","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 5. ç”¨ IDE å¯åŠ¨æœåŠ¡ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ç¨‹åºçš„å…¥å£ï¼š cmd/kube-controller-manager/controller-manager.go (å…¶ä»–çš„æœåŠ¡ä¹Ÿæ˜¯ç±»ä¼¼çš„è·¯å¾„) ç‚¹å‡»ï¼Œé…ç½®å¯åŠ¨å‚æ•°ï¼Œå¦‚ä¸‹å›¾ 02-é…ç½®å¯åŠ¨å‚æ•° ç°åœ¨åŸºæœ¬å°±é…ç½®å¥½äº† ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:5","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 6. æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ # æ‰§è¡Œå‘½ä»¤çœ‹æ²¡æœ‰ kube-controller-manager kubectl get pods -A ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:1:6","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 2. æ–¹æ³•2. å€ŸåŠ© dlv æ¥è°ƒè¯•æºç å¦‚æœä½ æ˜¯ mac/window ç³»ç»Ÿï¼Œå¯ä»¥å€ŸåŠ© dlv æ¥è°ƒè¯•æºç ã€‚ å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:0","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 1. ä¸‹è½½æºç  (go çš„ç‰ˆæœ¬è¦æ±‚ 1.18.x) git clone git@github.com:kubernetes/kubernetes.git cd kubernetes git checkout -b origin/release-1.24 go mod download ä¸Šè¿°ä¸‹è½½æºç ï¼Œéœ€è¦åœ¨ æœ¬åœ°window å’Œ k8sèŠ‚ç‚¹ ä¸Šéƒ½ä¸‹è½½ã€‚ æ³¨æ„ï¼šç”±äºæ˜¯è¿œç«¯è°ƒè¯•ï¼Œæ‰€ä»¥éœ€è¦åœ¨ k8s master èŠ‚ç‚¹ä¸Šï¼Œé‡æ–°ç¼–è¯‘æºç ï¼Œå»æ‰ -N -l. ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:1","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 2. åœ¨ k8s master èŠ‚ç‚¹ä¸Šï¼Œé‡æ–°ç¼–è¯‘æºç  cd kubernetes make DBG=1 # åœ¨ hack/lib/golang.sh ä¸­ ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:2","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 3. ä¸‹è½½å¯èƒ½ç”¨åˆ°çš„å·¥å…·ï¼Œå¦‚ dlv (ä½ å¯èƒ½éœ€è¦æå‰è®¾ç½® GOPATH ç¯å¢ƒå˜é‡) # å¯èƒ½éå¸¸æ…¢ï¼Œéœ€è¦è®¾ç½®ä»£ç† go get -u github.com/cloudflare/cfssl/cmd/cfssl go get -u github.com/cloudflare/cfssl/cmd/cfssljson go get -u github.com/go-delve/delve/cmd/dlv # é…ç½®ç¯å¢ƒå˜é‡ PATH=$PATH:$GOPATH/bin ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:3","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 4. æ‰¾åˆ°æœåŠ¡çš„å¯åŠ¨å‚æ•°ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ # æ‰§è¡Œå‘½ä»¤ ps aux | grep kube-controller-manager | grep -v grep # å‘½ä»¤æ‰§è¡Œä¹‹åï¼Œè¾“å‡ºå¦‚ä¸‹, kube-controller-manager åé¢çš„å°±æ˜¯ç¨‹åºçš„å‚æ•° root 1584 4.0 0.8 820020 110072 ? Ssl 23:28 0:02 kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/etc/kubernetes/pki/ca.crt --cluster-cidr=10.244.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --root-ca-file=/etc/kubernetes/pki/ca.crt --service-account-private-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --use-service-account-credentials=true ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:4","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 5. ç§»åŠ¨ kubernetes çš„é™æ€ pod ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ cd /etc/kubernetes mv manifests/kube-controller-manager.yaml ./ ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:5","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 6. ç”¨ dlv å¯åŠ¨æœåŠ¡æ³¨æ„: å¯åŠ¨å‚æ•°å’Œç¨‹åºè·¯å¾„ï¼Œé…ç½®æˆä½ è‡ªå·±çš„ï¼Œç›‘å¬çš„ç«¯å£æ˜¯ 2346 dlv åœ¨é…ç½®ç¨‹åºå‚æ•°æ—¶ï¼Œæœ‰ --ï¼Œ å¦‚æœåé¢å‚æ•°æœ‰ç‰¹æ®Šç¬¦å·ï¼Œç”¨ --key=\"value\" å½¢å¼ dlv å¯åŠ¨ä¹‹åï¼Œå¿…é¡»è¦è§¦å‘(IDE go remote)ï¼Œæ‰èƒ½å¯åŠ¨, å¦åˆ™ä¼šä¸€ç›´ç­‰ç€ã€‚ dlv --listen=:2346 --headless=true --api-version=2 --accept-multiclient exec /root/kubernetes/_output/bin/kube-controller-manager -- --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/etc/kubernetes/pki/ca.crt --cluster-cidr=10.244.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --root-ca-file=/etc/kubernetes/pki/ca.crt --service-account-private-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --use-service-account-credentials=true ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:6","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 7. ç”¨ IDE è¿æ¥ dlv æœåŠ¡ï¼ˆæ¯”å¦‚ kube-controller-managerï¼‰ç¨‹åºçš„å…¥å£ï¼š cmd/kube-controller-manager/controller-manager.go (å…¶ä»–çš„æœåŠ¡ä¹Ÿæ˜¯ç±»ä¼¼çš„è·¯å¾„) æ·»åŠ  Go Remoteï¼Œ é…ç½® host å’Œ portã€‚ ç‚¹å‡» okï¼Œç„¶åå¯åŠ¨æœåŠ¡ã€‚ 02-è¿æ¥dlv ç°åœ¨åŸºæœ¬å°±é…ç½®å¥½äº† ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:7","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 8. æä¾›ä¸€ä¸ªè°ƒè¯•çš„è„šæœ¬ ï¼ˆå¯é€‰ï¼‰ä½ ç°åœ¨ä¼šå‘ç°ï¼Œå¦‚æœæƒ³è¦è°ƒè¯•ï¼Œå°±å¿…é¡»è¦æŠŠ manifests/kube-controller-manager.yaml ç§»å‡ºå»ï¼Œç­‰ä¸éœ€è¦è°ƒè¯•äº†ï¼Œå†æŠŠè¿™ä¸ªæ–‡ä»¶ç§»å›æ¥ï¼Œè¿™æ ·éå¸¸éº»çƒ¦ã€‚æ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªè„šæœ¬æ¥å®ç°ã€‚ è„šæœ¬å†…å®¹å¦‚ä¸‹(æ³¨æ„æ›´æ”¹ä½ çš„è·¯å¾„)ï¼š cleanup() { mv /etc/kubernetes/kube-controller-manager.yaml /etc/kubernetes/manifests } trap cleanup EXIT mv /etc/kubernetes/manifests/kube-controller-manager.yaml /etc/kubernetes dlv --listen=:2346 --headless=true --api-version=2 --accept-multiclient exec /root/kubernetes/_output/bin/kube-controller-manager -- --allocate-node-cidrs=true --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/etc/kubernetes/pki/ca.crt --cluster-cidr=10.244.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --root-ca-file=/etc/kubernetes/pki/ca.crt --service-account-private-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --use-service-account-credentials=true ","date":"2022-06-28","objectID":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/:2:8","tags":["k8s","cloud native","source code"],"title":"æ­å»º k8s 1.24 ç‰ˆæœ¬çš„æºç è°ƒè¯•ç¯å¢ƒ","uri":"/ooooo-notes/%E6%90%AD%E5%BB%BA-k8s-1.24-%E7%89%88%E6%9C%AC%E7%9A%84%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/"},{"categories":null,"content":" 1. install logstashrefer to logstash document ","date":"2022-06-01","objectID":"/ooooo-notes/logstash-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/:1:0","tags":["logstash"],"title":"logstash çš„ç®€å•ä½¿ç”¨","uri":"/ooooo-notes/logstash-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 2. logstash example config file input { tcp { port =\u003e 12345 codec =\u003e \"json_lines\" } } filter{ grok { match =\u003e [\"message\", \"%{TIMESTAMP_ISO8601:logdate}\"] } date { match =\u003e [\"logdate\", \"yyyy-MM-dd HH:mm:ss.SSS\"] target =\u003e \"@timestamp\" } mutate { remove_field =\u003e [\"logdate\"] } ruby { code =\u003e \"event.set('timestamp', event.get('@timestamp').time.localtime + 8*60*60)\" } ruby { code =\u003e \"event.set('@timestamp',event.get('timestamp'))\" } mutate { remove_field =\u003e [\"timestamp\"] } } output { stdout { codec =\u003e rubydebug { metadata =\u003e true } } file { path =\u003e \"./logs/%{+YYYY-MM-dd-HH}.log\" codec =\u003e line { format =\u003e \"%{message}\"} } } notes: it will serve TCP connection on localhost:12345. uses codec named json_lines, json data format such as { \"message\" : \"xxxx\" }. matche date pattern in the log, then use it as its time. reset the field @timestamp, output to the local file. ","date":"2022-06-01","objectID":"/ooooo-notes/logstash-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/:1:1","tags":["logstash"],"title":"logstash çš„ç®€å•ä½¿ç”¨","uri":"/ooooo-notes/logstash-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":" 1. install wslopen Microsoft Store, then search ubuntu and click to install it. open terminal # list all linux subsystem wsl --list # set default linux subsystem, then you can input 'wsl' to inter system wsl --set-default ubuntu # enter default linux subsystem wsl # install cmake, g++, gccï¼Œgdb cd /usr/local wget https://cmake.org/files/v3.22/cmake-3.22.0-linux-x86_64.tar.gz tar xf cmake-3.22.0-linux-x86_64.tar.gz ln -s /usr/local/cmake-3.22.0-linux-x86_64/bin/cmake /usr/bin sudo apt install build-essential ","date":"2022-06-01","objectID":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%8A%E8%B0%83%E8%AF%95-redis/:1:0","tags":["redis"],"title":"åœ¨ windows ä¸Šè°ƒè¯• redis","uri":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%8A%E8%B0%83%E8%AF%95-redis/"},{"categories":null,"content":" 2. setting clion open File | Settings | Build, Execution, Deployment | Toolchains menu. add new toolchains and select wsl. clion toolchains setting wsl configuration, you maybe install cmake, gcc, g++, gdb. you must execute command git config core.autocrlf input in your terminal, because windows is CRLF, then git clone . select wsl in File | Settings | Build, Execution, Deployment | Makefile, because building redis by using makefile. login wsl and enter redis directory, for example: cd /mnt/c/Users/ooooo/Development/code/Demo/redis execute command make, you maybe need to execute cd src \u0026\u0026 ls | grep .sh | xargs chmod a+x makefile application ","date":"2022-06-01","objectID":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%8A%E8%B0%83%E8%AF%95-redis/:2:0","tags":["redis"],"title":"åœ¨ windows ä¸Šè°ƒè¯• redis","uri":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%8A%E8%B0%83%E8%AF%95-redis/"},{"categories":null,"content":" 1. æœºå™¨åˆå§‹åŒ–è®¾ç½®","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:1:0","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" hostname è®¾ç½® hostnamectl ## æŸ¥çœ‹å½“å‰çš„hostname hostnamectl set-hostname node1 ## è®¾ç½®ä¸»æœºåä¸ºnode1 ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:1:1","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" /etc/hosts æ–‡ä»¶ å’Œ DNS é…ç½® # k8s master 192.168.130.131 node1 # æ›´æ”¹dnsé…ç½® vim /etc/systemd/resolved.conf # æ›´æ”¹ä¸‹é¢å†…å®¹ [Resolve] DNS=8.8.8.8 8.8.4.4 # é‡å¯dns systemctl restart systemd-resolved.service refer: ubuntu dns resolver ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:1:2","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" åˆ›å»ºé root ç”¨æˆ·(å¯é€‰) # æ·»åŠ ç”¨æˆ· useradd ooooo -g ooooo # ä¿®æ”¹ç”¨æˆ·å¯†ç  passwd ooooo ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:1:3","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" å®‰è£… containerd å’Œ runcå®‰è£… containerd wget https://github.com/containerd/containerd/releases/download/v1.6.6/containerd-1.6.6-linux-amd64.tar.gz tar Cxzvf /usr/local containerd-1.6.6-linux-amd64.tar.gz mkdir -p /usr/local/lib/systemd/system/ é€šè¿‡ systemd æ¥å¯åŠ¨ containerd å°†ä¸‹é¢çš„å†…å®¹å†™å…¥ /usr/local/lib/systemd/system/containerd.service # Copyright The containerd Authors. # # Licensed under the Apache License, Version 2.0 (the \"License\"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \"AS IS\" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/local/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 # Having non-zero Limit*s causes performance problems due to accounting overhead # in the kernel. We recommend using cgroups to do container-local accounting. LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=infinity # Comment TasksMax if your systemd version does not supports it. # Only systemd 226 and above support this version. TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target å¯åŠ¨ containerd systemctl daemon-reload systemctl enable --now containerd é…ç½® containerd mkdir -p /etc/containerd # ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶ containerd config default | tee /etc/containerd/config.toml # ä¿®æ”¹ /etc/containerd/config.toml é…ç½® # image ä½¿ç”¨é˜¿é‡Œäº‘çš„åœ°å€ï¼Œ SystemdCgroup æ›´æ”¹ä¸º true sandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.6\" ... [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] ... SystemdCgroup = true # ä¿®æ”¹å®Œæˆå systemctl restart containerd å®‰è£… runc wget https://github.com/opencontainers/runc/releases/download/v1.1.3/runc.amd64 install -m 755 runc.amd64 /usr/local/sbin/runc å®‰è£… cni æ’ä»¶ wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz mkdir -p /opt/cni/bin tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:1:4","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" 2. k8s å®‰è£… å®˜æ–¹ k8s å®‰è£…æ–‡æ¡£ # å‚è€ƒæ–‡æ¡£æ£€æŸ¥æœåŠ¡å™¨çš„çŠ¶æ€æ˜¯å¦å¯ä»¥å®‰è£… k8s æœåŠ¡ # ä¸´æ—¶å…³é—­ swap åˆ†åŒº swapoff -a # æŸ¥çœ‹ swap åˆ†åŒºæ˜¯å¦å…³é—­ï¼Œæ˜¾ç¤º 0 è¡¨ç¤ºå·²å…³é—­ free -h # æ°¸ä¹…å…³é—­ swap åˆ†åŒº ç¼–è¾‘ /etc/fstab æ–‡ä»¶, æ³¨é‡Šæœ€åä¸€è¡Œ # æ£€æŸ¥ br_netfilter æ˜¯å¦è¢«åŠ è½½ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œè¡¨ç¤ºæ²¡æœ‰åŠ è½½ lsmod | grep br_netfilter # åŠ è½½ br_netfilter æ¨¡å— sudo modprobe br_netfilter ## é…ç½®ç½‘ç»œ cat \u003c\u003cEOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat \u003c\u003cEOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 EOF sudo sysctl --system # å®‰è£…è½¯ä»¶ sudo apt-get update sudo apt-get install -y apt-transport-https ca-certificates curl sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg echo \"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list sudo apt-get update # é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ sudo apt-get install -y kubelet kubeadm kubectl # ä¸è‡ªåŠ¨æ›´æ–° sudo apt-mark hold kubelet kubeadm kubectl # æŸ¥çœ‹é•œåƒåˆ—è¡¨ï¼Œ æŠ¥é”™éœ€è¦æ·»åŠ é…ç½®, crictl æ˜¯å®˜æ–¹æä¾›çš„ crictl images # vim /etc/crictl.yaml æ·»åŠ ä»¥ä¸‹å†…å®¹ runtime-endpoint: unix:///run/containerd/containerd.sock image-endpoint: unix:///run/containerd/containerd.sock timeout: 10 debug: false # è®¾ç½® kubelet å¼€æœºå¯åŠ¨ï¼Œå¹¶ä¸”ç°åœ¨å¯åŠ¨ # å¯åŠ¨ä¹‹åå¯èƒ½ä¼šæŠ¥é”™ï¼Œå¦‚æœåŸå› æ˜¯ æ²¡æœ‰è¯»å–åˆ° kubelet çš„é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨ç®¡ï¼Œç¨åä¼šé‡å¯è¿™ä¸ªæœåŠ¡ sudo systemctl enable --now kubelet # æŸ¥çœ‹ kubelet çš„çŠ¶æ€ sudo systemctl status kubelet # æŸ¥çœ‹ kubelet çš„æ—¥å¿— journalctl -xeu kubelet ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:2:0","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" 3. åˆ›å»º k8s é›†ç¾¤ åˆ›å»º k8s é›†ç¾¤å®˜æ–¹æ–‡æ¡£ k8s pod network æ’ä»¶æ–‡æ¡£ # æ‰§è¡Œ kubeadm init å‘½ä»¤ï¼Œ åœ¨ k8s master æœºå™¨ä¸Šæ‰§è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ k8s åˆ›å»º pod ä¸ä¼šåœ¨ master æœºå™¨ä¸Š # é‡ç‚¹æ³¨æ„: --pod-network-cidr=10.244.0.0/16 è¿™ä¸ªå‚æ•°å¿…é¡»è¦æœ‰ï¼Œæ²¡æœ‰çš„è¯å®‰è£… cni ä¼šæŠ¥é”™ # æ³¨æ„ preflight çš„å‰ç½®æ£€æŸ¥è¾“å‡ºï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œç™¾åº¦è‡ªè¡Œè§£å†³ # æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ ip å’Œ hostname sudo kubeadm init --image-repository registry.aliyuncs.com/google_containers --apiserver-advertise-address=192.168.130.128 --pod-network-cidr=10.244.0.0/16 --control-plane-endpoint=node1 # æ‰§è¡Œå‘½ä»¤ä¹‹åï¼Œä¼šæœ‰ kubeadm join è¾“å‡ºè¡Œ # ï¼ˆåˆ†ä¸º master-token å’Œ worker-tokenï¼‰ï¼Œ ç±»ä¼¼äºä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ worker-join-token çš„å‘½ä»¤ sudo kubeadm join 192.168.130.128:6443 --token 8auvt0.zfw0ayr45d80q8pb \\ --discovery-token-ca-cert-hash sha256:efe854739efef5fbaf3f6e28c899481c8d7797c1997fc8315b921a9ede400ca8 # å»æ‰æ±¡ç‚¹ï¼Œè®©å•ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥è¿è¡Œ, (æˆ‘è¿™é‡Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹) kubectl taint nodes --all node-role.kubernetes.io/control-plane- node-role.kubernetes.io/master- ## åœ¨æœºå™¨ä¸Šæ‰§è¡Œ kubeadm join æˆ–è€… kubeadm init å‘½ä»¤ä¹‹åï¼Œé‡å¯ kubelet æœåŠ¡ sudo systemctl restart kubelet sudo systemctl status kubelet # è®¾ç½® kubectl çš„é…ç½®æ–‡ä»¶ï¼Œ ä¸º $HOME/.kube/config mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config # å®‰è£… pod network æ’ä»¶, è¿™é‡Œä½¿ç”¨ calico æ’ä»¶ curl -o calico-operator.yaml https://projectcalico.docs.tigera.io/manifests/tigera-operator.yaml curl -o calico-custom-resources.yaml https://projectcalico.docs.tigera.io/manifests/custom-resources.yaml # é‡ç‚¹ # æ›´æ”¹ calico-custom-resources.yaml çš„ cidr é…ç½®, å€¼ä¸º --pod-network-cidr ï¼ˆåœ¨ kubeadm init æŒ‡å®šäº†ï¼‰ # å¤šä¸ªç½‘å¡ï¼Œä¹Ÿå¯ä»¥æ›´æ”¹ï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥é”™ï¼Œæœç´¢ interface kubectl create -f calico-operator.yaml kubectl create -f calico-custom-resources.yaml # æŸ¥çœ‹ calico æ˜¯å¦å·²ç»å¯åŠ¨å®Œæˆ, cni ä¹Ÿå¯åŠ¨æˆåŠŸ kubectl get pods -A # æˆåŠŸä¹‹åä¼šæœ‰ä¸‹é¢çš„æœåŠ¡ï¼Œ éƒ½æ˜¯ running çŠ¶æ€ calico-apiserver calico-apiserver-78c5f69667-gbxbv 1/1 Running 0 88s calico-apiserver calico-apiserver-78c5f69667-h64wk 1/1 Running 0 88s calico-system calico-kube-controllers-68884f975d-q4l8s 1/1 Running 0 40m calico-system calico-node-4d7hs 1/1 Running 0 40m calico-system calico-typha-854c6b9b4b-s8ls7 1/1 Running 0 40m kube-system coredns-74586cf9b6-4pkxf 1/1 Running 0 76m kube-system coredns-74586cf9b6-9hxwl 1/1 Running 0 76m kube-system etcd-node1 1/1 Running 0 76m kube-system kube-apiserver-node1 1/1 Running 0 76m kube-system kube-controller-manager-node1 1/1 Running 0 76m kube-system kube-proxy-mn6fr 1/1 Running 0 76m kube-system kube-scheduler-node1 1/1 Running 0 76m tigera-operator tigera-operator-5fb55776df-gjs7s 1/1 Running 0 64m ","date":"2022-04-01","objectID":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/:3:0","tags":["k8s","cloud native"],"title":"ä½¿ç”¨ ubuntu æ¥å®‰è£… kubernetes 1.24 ç‰ˆæœ¬","uri":"/ooooo-notes/%E4%BD%BF%E7%94%A8-ubuntu-%E6%9D%A5%E5%AE%89%E8%A3%85-kubernetes-1.24-%E7%89%88%E6%9C%AC/"},{"categories":null,"content":" install nfs in docker","date":"2022-03-01","objectID":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/:1:0","tags":["docker","nfs"],"title":"åœ¨ docker ä¸Šå®‰è£… nfs","uri":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/"},{"categories":null,"content":" 1. create share directory used by nfs mkdir -p /home/ooooo/shared/nfs ","date":"2022-03-01","objectID":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/:1:1","tags":["docker","nfs"],"title":"åœ¨ docker ä¸Šå®‰è£… nfs","uri":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/"},{"categories":null,"content":" 2. create exports.txt used by nfsThis the exports.txt mainly used to mount dir (path in the container ) and permission. for example: It indicates read only for all ip. vim /home/ooooo/exports.txt /home/ooooo/shared/nfs *(ro,no_subtree_check) ","date":"2022-03-01","objectID":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/:1:2","tags":["docker","nfs"],"title":"åœ¨ docker ä¸Šå®‰è£… nfs","uri":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/"},{"categories":null,"content":" 3. execute docker command docker run -d \\ -v /home/ooooo/shared/nfs:/home/ooooo/shared/nfs \\ -v /home/ooooo/exports.txt:/etc/exports:ro \\ --cap-add SYS_ADMIN \\ -p 2049:2049 \\ erichough/nfs-server # check nfs server netstat -nla | grep 2049 # mount nfs dir (check mount.nfs whether is exist ) # 172.17.0.2 is container ip mount 172.17.0.2:/home/ooooo/shared/nfs /home/ooooo/nfs-mount ","date":"2022-03-01","objectID":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/:1:3","tags":["docker","nfs"],"title":"åœ¨ docker ä¸Šå®‰è£… nfs","uri":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/"},{"categories":null,"content":" 5. å‚è€ƒdocker images ","date":"2022-03-01","objectID":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/:1:4","tags":["docker","nfs"],"title":"åœ¨ docker ä¸Šå®‰è£… nfs","uri":"/ooooo-notes/%E5%9C%A8-docker-%E4%B8%8A%E5%AE%89%E8%A3%85-nfs/"},{"categories":null,"content":" cygwin çš„ç¯å¢ƒå˜é‡è¦æ”¾åœ¨ç¬¬ä¸€ä¸ªï¼Œè¿™æ · rsync å’Œ ssh éƒ½æ˜¯ cygwin çš„. window æ˜¯æ‰§è¡Œå‘½ä»¤ where sshï¼Œ çœ‹çœ‹ ssh æœ‰å‡ ä¸ªå®ç° ï¼ˆæ¯”å¦‚ openssh å’Œ cygwin çš„ ssh ï¼‰ refer: window install cygwin ","date":"2022-01-03","objectID":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%AD-rsync-%E9%97%AE%E9%A2%98/:0:0","tags":["resolution"],"title":"åœ¨ windows ä¸­ rsync é—®é¢˜","uri":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%AD-rsync-%E9%97%AE%E9%A2%98/"},{"categories":null,"content":" win10å®‰è£…wiresharkç»å¸¸æŠ¥â€œKB2999226 å’Œ KB3118401â€ install wireshark open installation directory, manually install vc_redist.x64.exe by double click reinstall wireshark ","date":"2022-01-02","objectID":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%AD%E5%AE%89%E8%A3%85-wireshark-%E6%8A%A5%E9%94%99/:0:0","tags":["resolution","wireshark"],"title":"åœ¨ windows ä¸­å®‰è£… wireshark æŠ¥é”™","uri":"/ooooo-notes/%E5%9C%A8-windows-%E4%B8%AD%E5%AE%89%E8%A3%85-wireshark-%E6%8A%A5%E9%94%99/"},{"categories":null,"content":" 0ã€æŒç»­å­¦ä¹ è€… Talk is cheap. Show me the code. è‹±è¯­æ¯”ç¼–ç¨‹ç®€å•ã€‚ å­¦ä¹ å’Œå®è·µè¦å¹³è¡¡ã€‚ å­¦ä¼šå’Œæ—¶é—´åšæœ‹å‹ã€‚ å­¦ä¼šæŠ•èµ„ï¼Œå­¦ä¼šç†è´¢ã€‚ å­¦ä¼šå…ˆåšå‡æ³•ï¼Œå†åšåŠ æ³•ã€‚ å­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ã€‚ è¯´æ˜ï¼š â­• è¿›è¡Œä¸­ âœ… å·²å®Œæˆ âŒ å·²åºŸå¼ƒ â“ æœ‰å¿…è¦ â— é‡è¦æ€§ ğŸ“ è®°ç¬”è®° ğŸ–Šï¸ å†™ä»£ç  ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:1:0","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€å…³äºè‹±è¯­ ã€Šæ–°æ¦‚å¿µè‹±è¯­ã€‹ â­• ã€Šæ¯æ—¥è‹±è¯­å¬åŠ› ~ EnglishPodã€‹ ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:2:0","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€å…³äºæŠ€æœ¯è®¡åˆ’ ğŸ‰ï¼š åªè®°å½•è‡ªå·±è®¤ä¸ºæœ‰ç”¨çš„ç¬”è®°ã€‚ ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:3:0","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç±0ï¸âƒ£1ï¸âƒ£. ã€ŠJava æ€§èƒ½ä¼˜åŒ–æƒå¨æŒ‡å—ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€ŠSpring Cloud å¾®æœåŠ¡ï¼šå…¥é—¨ã€å®æˆ˜ä¸è¿›é˜¶ã€‹ âŒ 0ï¸âƒ£4ï¸âƒ£. ã€Šarthasã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Kafkaï¼šæ ¸å¿ƒè®¾è®¡ä¸å®è·µåŸç†ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šä»é›¶å¼€å§‹å­¦æ¶æ„ã€‹ âœ… 0ï¸âƒ£8ï¸âƒ£. ã€Šé«˜å¯ç”¨å¯ä¼¸ç¼©å¾®æœåŠ¡æ¶æ„ã€‹ âŒ 0ï¸âƒ£9ï¸âƒ£. ã€Šåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•å¼€å‘å®æˆ˜ã€‹ 1ï¸âƒ£0ï¸âƒ£. ã€ŠGo Web ç¼–ç¨‹ã€‹ â­• 1ï¸âƒ£2ï¸âƒ£. ã€ŠEffective C++ã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€ŠMore Effective C++ã€‹ 1ï¸âƒ£4ï¸âƒ£. ã€Šæ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹ 1ï¸âƒ£5ï¸âƒ£. ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ 1ï¸âƒ£6ï¸âƒ£. ã€Šwiresharkç½‘ç»œåˆ†æçš„è‰ºæœ¯ã€‹ âœ… 1ï¸âƒ£7ï¸âƒ£. ã€ŠVimå®ç”¨æŠ€å·§ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ â­• 1ï¸âƒ£8ï¸âƒ£. ã€ŠRocketMQæŠ€æœ¯å†…å¹• ç¬¬äºŒç‰ˆã€‹ 1ï¸âƒ£9ï¸âƒ£. ã€ŠKubernetes in Actionä¸­æ–‡ç‰ˆã€‹ âœ… 2ï¸âƒ£1ï¸âƒ£. ã€Šrocketmq æºç ã€‹ â­• 2ï¸âƒ£2ï¸âƒ£. ã€Škubernetes æºç ã€‹ â­• 2ï¸âƒ£3ï¸âƒ£. ã€Šistio æºç ã€‹ 2ï¸âƒ£4ï¸âƒ£. ã€Šetcd æºç ã€‹ 2ï¸âƒ£5ï¸âƒ£. ã€Šdubbo æºç ã€‹ â­• 2ï¸âƒ£6ï¸âƒ£. ã€Špulsar æºç ã€‹ âŒ 2ï¸âƒ£7ï¸âƒ£. ã€Šnsq æºç ã€‹ 2ï¸âƒ£8ï¸âƒ£. ã€Ševenting æºç ã€‹ 2ï¸âƒ£9ï¸âƒ£. ã€Šserving æºç ã€‹ 3ï¸âƒ£0ï¸âƒ£. ã€Šæ·±å…¥æµ…å‡ºIstioï¼šService Meshå¿«é€Ÿå…¥é—¨ä¸å®è·µã€‹ âœ… 3ï¸âƒ£1ï¸âƒ£. ã€ŠIstioæœåŠ¡ç½‘æ ¼æŠ€æœ¯è§£æä¸å®è·µã€‹ âœ… 3ï¸âƒ£2ï¸âƒ£. ã€Šäº‘åŸç”ŸæœåŠ¡ç½‘æ ¼Istioï¼šåŸç†ã€å®è·µã€æ¶æ„ä¸æºç è§£æã€‹ 3ï¸âƒ£3ï¸âƒ£. ã€ŠgRPCä¸äº‘åŸç”Ÿåº”ç”¨å¼€å‘ã€‹ âœ… 3ï¸âƒ£4ï¸âƒ£. ã€ŠQuarkus å®æˆ˜ã€‹ âœ… 3ï¸âƒ£4ï¸âƒ£. ã€Šgin æºç ã€‹ âœ… 3ï¸âƒ£4ï¸âƒ£. ã€Šgrpc-go æºç ã€‹ â­• 3ï¸âƒ£5ï¸âƒ£. ã€ŠGoè¯­è¨€ç²¾è¿›ä¹‹è·¯ Iã€‹ âœ… 3ï¸âƒ£6ï¸âƒ£. ã€ŠGoè¯­è¨€ç²¾è¿›ä¹‹è·¯ IIã€‹ âœ… 3ï¸âƒ£7ï¸âƒ£. ã€ŠWiresharkç½‘ç»œåˆ†æå°±è¿™ä¹ˆç®€å•ã€‹ âœ… 3ï¸âƒ£8ï¸âƒ£. ã€ŠMySQLæŠ€æœ¯å†…å¹•ã€‹ 3ï¸âƒ£9ï¸âƒ£. ã€Šæ·±å…¥è§£æJavaè™šæ‹ŸæœºHotSpotã€‹ 4ï¸âƒ£0ï¸âƒ£. ã€ŠRustæƒå¨æŒ‡å—ã€‹ â­• 4ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥å‰–æKubernetesã€‹ 4ï¸âƒ£2ï¸âƒ£. ã€ŠKubernetesç¼–ç¨‹ã€‹ â­• 4ï¸âƒ£3ï¸âƒ£. ã€ŠKubernetesæºç å‰–æã€‹ âœ… 4ï¸âƒ£4ï¸âƒ£. ã€ŠKubernetesè®¾è®¡æ¨¡å¼ã€‹ 4ï¸âƒ£5ï¸âƒ£. ã€ŠHelmå­¦ä¹ æŒ‡å—ï¼šKubernetesä¸Šçš„åº”ç”¨ç¨‹åºç®¡ç†ã€‹ âœ… 4ï¸âƒ£6ï¸âƒ£. ã€ŠKnativeå®æˆ˜:åŸºäºKubernetesçš„æ— æœåŠ¡å™¨æ¶æ„å®è·µã€‹ âœ… 4ï¸âƒ£7ï¸âƒ£. ã€Šæ·±å…¥å‰–æJavaè™šæ‹Ÿæœºã€‹ 4ï¸âƒ£8ï¸âƒ£. ã€ŠGroovyç¨‹åºè®¾è®¡ã€‹ âœ… ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:3:1","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€æ–‡æ¡£0ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥æ‹†è§£ Java è™šæ‹Ÿæœºã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€ŠHow to write Go codeã€‹ 0ï¸âƒ£3ï¸âƒ£. ã€ŠEffective Goã€‹ 0ï¸âƒ£4ï¸âƒ£. ä» 0 å¼€å§‹å¸¦ä½ æˆä¸ºJVMå®æˆ˜é«˜æ‰‹ â­• 0ï¸âƒ£4ï¸âƒ£. Go è¯­è¨€é¡¹ç›®å¼€å‘å®æˆ˜ â­• 0ï¸âƒ£5ï¸âƒ£. Redis æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ âœ… 0ï¸âƒ£6ï¸âƒ£. Redis æºç å‰–æä¸å®æˆ˜ â­• 0ï¸âƒ£7ï¸âƒ£. æ·±å…¥æ‹†è§£ Tomcat \u0026 Jetty âœ… 0ï¸âƒ£8ï¸âƒ£. æ·±å…¥ C è¯­è¨€å’Œç¨‹åºè¿è¡ŒåŸç† 0ï¸âƒ£9ï¸âƒ£. ç½—å‰‘é”‹çš„ C++ å®æˆ˜ç¬”è®° âœ… ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:3:2","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3ã€è§†é¢‘0ï¸âƒ£1ï¸âƒ£. ã€Šç©è½¬ç®—æ³•ç³»åˆ—â€“å›¾è®ºç²¾è®²ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šç©è½¬ç®—æ³•é¢è¯•ã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€Šçœ‹çš„è§çš„ç®—æ³•ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šæå®¢æ—¶é—´â€“ ç®—æ³•è¿›é˜¶è®­ç»ƒè¥ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€ŠDubbo 3 æ·±åº¦å‰–æ - é€è¿‡æºç è®¤è¯†ä½ ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€ŠGo å¾®æœåŠ¡å®æˆ˜ 38 è®²ã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€ŠNetty æºç å‰–æä¸å®æˆ˜ã€‹ âœ… ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:3:3","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€ç®—æ³•0ï¸âƒ£1ï¸âƒ£. æ¯å‘¨è‡³å°‘ 5 é“ Leetcodeã€‚ â­• 0ï¸âƒ£2ï¸âƒ£. leetcode å…¨ç«™æ’å1000ä»¥å†…ã€‚ â­• 0ï¸âƒ£3ï¸âƒ£. leetcode å‘¨èµ›å…¨å›½æ’å2000ä»¥å†…ã€‚ â­• 0ï¸âƒ£4ï¸âƒ£. leetcode å‘¨èµ›å…¨çƒæ’å10000ä»¥å†…ã€‚ â­• ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:3:4","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€å…³äºå…¶ä»–","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:0","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç± ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šä¸€ä¸‡å°æ—¶å¤©æ‰ç†è®ºã€‹ âŒ 0ï¸âƒ£3ï¸âƒ£. ã€Šç•ªèŒ„å·¥ä½œæ³•å›¾è§£ã€‹ âŒ 0ï¸âƒ£4ï¸âƒ£. ã€Šä¸‰ä½“ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€Šä¸‰ä½“â…¡ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€Šä¸‰ä½“â…¢ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šéæš´åŠ›æ²Ÿé€šã€‹ â­• 0ï¸âƒ£8ï¸âƒ£. ã€Šç®¡ç†ä½ çš„æ¯ä¸€å¤©ã€‹ âŒ 0ï¸âƒ£9ï¸âƒ£. ã€ŠåŸåˆ™ã€‹ 1ï¸âƒ£0ï¸âƒ£. ã€Šæ€è€ƒï¼Œå¿«ä¸æ…¢ã€‹ 1ï¸âƒ£1ï¸âƒ£. ã€Šå…³é”®å¯¹è¯ã€‹ 1ï¸âƒ£2ï¸âƒ£. ã€Šå½“ä¸‹çš„å¯è’™ã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€ŠæŠŠæ—¶é—´å½“ä½œæœ‹å‹ã€‹ âŒ 1ï¸âƒ£4ï¸âƒ£. ã€Šç™½å¤œè¡Œã€‹ âŒ 1ï¸âƒ£5ï¸âƒ£. ã€Šäº²å¯†å…³ç³»ï¼šé€šå¾€çµé­‚çš„æ¡¥æ¢ã€‹ â­• 1ï¸âƒ£6ï¸âƒ£. ã€Šè›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿã€‹ âœ… 1ï¸âƒ£7ï¸âƒ£. ã€Šåˆ»æ„ç»ƒä¹ ã€‹ â­• 1ï¸âƒ£7ï¸âƒ£. ã€Šå“æœ‰æˆæ•ˆçš„å·¥ç¨‹å¸ˆã€‹ â­• ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:1","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€é€‰è¯» ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šäººæ€§çš„å¼±ç‚¹ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šç®—æ³• 4ã€‹ 0ï¸âƒ£3ï¸âƒ£. ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šå½“æˆ‘è°ˆè·‘æ­¥æ—¶ï¼Œæˆ‘è°ˆäº›ä»€ä¹ˆã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€ŠKafka å®˜ç½‘ã€‹ â“ 0ï¸âƒ£6ï¸âƒ£. ã€ŠMIT é«˜çº§æ•°æ®è¯¾ç¨‹ã€‹ â“ ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:2","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3ã€å°è¯• ğŸ‰0ï¸âƒ£1ï¸âƒ£. å­¦ä¼šä½¿ç”¨å°¤å…‹é‡Œé‡Œå¼¹å¥ ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:3","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€äº†è§£ ğŸ‰0ï¸âƒ£1ï¸âƒ£. æš‚æ—  ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:4","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 5ã€å¨±ä¹0ï¸âƒ£1ï¸âƒ£. ã€Šè’å²›ä½™ç”Ÿã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šæ˜Ÿé™…ç©¿è¶Šã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šè¿™ä¸ªæ€æ‰‹ä¸å¤ªå†·ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€Šç¾ä¸½äººç”Ÿã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€Šé˜¿ç”˜æ­£ä¼ ã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€Šå¥‡é‡äººç”Ÿ ç¬¬ä¸€å­£ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šä¸€æœ¬å¥½ä¹¦ 1ã€‹ 0ï¸âƒ£8ï¸âƒ£. ã€Šä¸€æœ¬å¥½ä¹¦ 2ã€‹ 0ï¸âƒ£9ï¸âƒ£. ã€Šæ¥šé—¨çš„ä¸–ç•Œã€‹ âœ… 1ï¸âƒ£0ï¸âƒ£. ã€Šç©¿è¶Šæ—¶ç©ºçš„å°‘å¥³ã€‹ âœ… 1ï¸âƒ£1ï¸âƒ£. ã€Šäº”ç­‰åˆ†çš„æ–°å¨˜ å‰§åœºç‰ˆã€‹ âœ… 1ï¸âƒ£2ï¸âƒ£. ã€Šä½ çš„åå­—ã€‹ âœ… 1ï¸âƒ£3ï¸âƒ£. ã€Šå·¥ä½œç»†èƒã€‹ âœ… ","date":"2022-01-01","objectID":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/:4:5","tags":["learning"],"title":"2022å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2022%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" idea gradle project show duplicated file treeï¼ˆproject view and packages viewï¼‰ you must select idea as run test and building é¡¹ç›®ä¾èµ–é…ç½® ","date":"2022-01-01","objectID":"/ooooo-notes/idea-%E4%B8%AD-gradle-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%98%BE%E7%A4%BA%E9%94%99%E8%AF%AF/:0:0","tags":["resolution"],"title":"idea ä¸­ gradle é¡¹ç›®ç»“æ„æ˜¾ç¤ºé”™è¯¯","uri":"/ooooo-notes/idea-%E4%B8%AD-gradle-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%98%BE%E7%A4%BA%E9%94%99%E8%AF%AF/"},{"categories":null,"content":" 1. ä¸¤å°æœºå™¨åˆå§‹åŒ–è®¾ç½®","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:0","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 1.1 hostname è®¾ç½® hostnamectl ## æŸ¥çœ‹å½“å‰çš„hostname hostnamectl set-hostname centos1 ## è®¾ç½®ä¸»æœºåä¸ºcentos1, åœ¨ 192.168.130.131 ä¸Šæ‰§è¡Œ hostnamectl set-hostname centos2 ## è®¾ç½®ä¸»æœºåä¸ºcentos1, åœ¨ 192.168.130.132 ä¸Šæ‰§è¡Œ ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:1","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 1.2 /etc/hosts æ–‡ä»¶ (ä¸¤ä¸ªæœºå™¨éƒ½éœ€è¦) 192.168.1.8 ooooo 192.168.130.131 centos1 ## k8s master 192.168.130.132 centos2 ## k8s worker ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:2","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 1.3 åˆ›å»ºé root ç”¨æˆ· (ä¸¤ä¸ªæœºå™¨éƒ½éœ€è¦) useradd ooooo -g ooooo ## æ·»åŠ ç”¨æˆ·ï¼Œä¸¤ä¸ªæœºå™¨éƒ½æ‰§è¡Œ passwd ooooo ## ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼Œä¸¤ä¸ªæœºå™¨éƒ½æ‰§è¡Œ ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:3","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 1.4 æ·»åŠ  yum ä»£ç† (ä¸¤ä¸ªæœºå™¨éƒ½éœ€è¦) sudo vim /etc/yum.conf ## ç¼–è¾‘ yum é…ç½®æ–‡ä»¶ proxy=http://ooooo:10800 ## åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:4","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 1.5 å®‰è£… docker æœåŠ¡ (ä¸¤ä¸ªæœºå™¨éƒ½éœ€è¦) å®˜æ–¹ docker å®‰è£…æ–‡æ¡£ å‚è€ƒæ–‡æ¡£å®‰è£… docker sudo vim /etc/docker/daemon.json ## ç¼–è¾‘ docker é…ç½®æ–‡ä»¶ï¼Œ æ·»åŠ ä¸‹é¢ json é…ç½®ï¼Œè¿™æ˜¯å› ä¸º k8s é»˜è®¤ä½¿ç”¨çš„ cgroup driver æ˜¯ systemd { \"exec-opts\": [\"native.cgroupdriver=systemd\"] } sudo systemctl enable --now docker.service ## è®¾ç½® docker æœåŠ¡å¼€æœºå¯åŠ¨ï¼Œå¹¶ä¸”ç°åœ¨å¯åŠ¨ sudo systemctl status docker ## æŸ¥çœ‹ docker æœåŠ¡çš„çŠ¶æ€ï¼Œ å¤±è´¥äº†ï¼Œä½¿ç”¨ä¸‹ä¸€æ¡å‘½ä»¤æŸ¥çœ‹æ—¥å¿— journalctl -xeu docker ## æŸ¥çœ‹ docker æ—¥å¿—æœåŠ¡ ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:1:5","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 2. k8s çš„ kubeadm å®‰è£… (ä¸¤å°éƒ½éœ€è¦) å®˜æ–¹ k8s å®‰è£…æ–‡æ¡£ å‚è€ƒæ–‡æ¡£æ£€æŸ¥æœåŠ¡å™¨çš„çŠ¶æ€æ˜¯å¦å¯ä»¥å®‰è£… k8s æœåŠ¡ ## å…³é—­ swap åˆ†åŒº swapoff -a sudo echo vm.swappiness=0 \u003e\u003e /etc/sysctl.con ## æ°¸ä¹…å…³é—­ swap åˆ†åŒºï¼Œ k8s ä¸èƒ½è¿è¡Œåœ¨æœ‰ swap åˆ†åŒºçš„æœºå™¨ä¸Š free -h ## æŸ¥çœ‹ swap åˆ†åŒºæ˜¯å¦å…³é—­ï¼Œæ˜¾ç¤º 0 è¡¨ç¤ºå·²å…³é—­ ## æ£€æŸ¥ br_netfilter æ˜¯å¦è¢«åŠ è½½ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œè¡¨ç¤ºæ²¡æœ‰åŠ è½½ lsmod | grep br_netfilter sudo modprobe br_netfilter ## åŠ è½½ br_netfilter æ¨¡å— ## é…ç½®ç½‘ç»œ cat \u003c\u003cEOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat \u003c\u003cEOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sudo sysctl --system å®‰è£…å®¹å™¨è¿è¡Œæ—¶(runtime),k8s é«˜ç‰ˆæœ¬é‡‡ç”¨è‡ªåŠ¨æ£€æŸ¥æ–¹å¼,ä¸ç”¨åšä»»ä½•å¤„ç† ## æ·»åŠ  k8s é•œåƒä»“åº“ï¼Œåœ¨å‰é¢ä¸­ï¼Œè®¾ç½®äº† yum ä»£ç† ## åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å¤šäº† exclude=kubelet kubeadm kubectl ï¼Œè¿™é‡Œå»æ‰, ç›´æ¥å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ cat \u003c\u003cEOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF ## å…³é—­ selinux sudo setenforce 0 sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config ## å®‰è£… k8s æœåŠ¡, --disableexcludes=kubernetes è¡¨ç¤ºæ’é™¤ kubernetes ä¹‹å¤–çš„é•œåƒæº sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes ## è®¾ç½® kubelet å¼€æœºå¯åŠ¨ï¼Œå¹¶ä¸”ç°åœ¨å¯åŠ¨ ## å¯åŠ¨ä¹‹åå¯èƒ½ä¼šæŠ¥é”™ï¼Œå¦‚æœåŸå› æ˜¯ æ²¡æœ‰è¯»å–åˆ° kubelet çš„é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨ç®¡ï¼Œç¨åä¼šé‡å¯è¿™ä¸ªæœåŠ¡ sudo systemctl enable --now kubelet sudo systemctl status kubelet ## æŸ¥çœ‹ kubelet çš„çŠ¶æ€ journalctl -xeu kubelet ## æŸ¥çœ‹ kubelet çš„æ—¥å¿— ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:2:0","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":" 3. åˆ›å»º k8s é›†ç¾¤ (ä¸¤å°éƒ½éœ€è¦) åˆ›å»º k8s é›†ç¾¤å®˜æ–¹æ–‡æ¡£ k8s pod network æ’ä»¶æ–‡æ¡£ ## æ‰§è¡Œ kubeadm init å‘½ä»¤ï¼Œ åœ¨ k8s master æœºå™¨ä¸Šæ‰§è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ k8s åˆ›å»º pod ä¸ä¼šåœ¨ master æœºå™¨ä¸Š ## é‡ç‚¹æ³¨æ„: --pod-network-cidr=10.244.0.0/16 è¿™ä¸ªå‚æ•°å¿…é¡»è¦æœ‰ï¼Œæ²¡æœ‰çš„è¯å®‰è£… cni ä¼šæŠ¥é”™ ## æ³¨æ„ preflight çš„å‰ç½®æ£€æŸ¥è¾“å‡ºï¼Œå¯èƒ½éœ€è¦æ·»åŠ  docker groupï¼Œè¿™ä¸ªä¼šè¾“å‡ºæœ‰æç¤ºçš„å‘½ä»¤ sudo kubeadm init --image-repository registry.aliyuncs.com/google_containers --apiserver-advertise-address=192.168.130.131 --pod-network-cidr=10.244.0.0/16 ## æ‰§è¡Œå‘½ä»¤ä¹‹åï¼Œä¼šæœ‰ kubeadm join è¾“å‡ºè¡Œ ## ï¼ˆåˆ†ä¸º master-token å’Œ worker-tokenï¼‰ï¼Œ ç±»ä¼¼äºä¸‹é¢çš„å‘½ä»¤ï¼Œåœ¨ centos2 ä¸Šæ‰§è¡Œ worker-join-token çš„å‘½ä»¤ sudo kubeadm join 192.168.130.131:6443 --token 8auvt0.zfw0ayr45d80q8pb \\ --discovery-token-ca-cert-hash sha256:efe854739efef5fbaf3f6e28c899481c8d7797c1997fc8315b921a9ede400ca8 ## åœ¨æœºå™¨ä¸Šæ‰§è¡Œ kubeadm join æˆ–è€… kubeadm init å‘½ä»¤ä¹‹åï¼Œé‡å¯ kubelet æœåŠ¡ sudo systemctl restart kubelet sudo systemctl status kubelet ## è®¾ç½® kubectl çš„é…ç½®æ–‡ä»¶ï¼Œ ä¸º $HOME/.kube/config mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config ## å®‰è£… pod network æ’ä»¶, è¿™é‡Œä½¿ç”¨ flannel æ’ä»¶ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml ## æŸ¥çœ‹ flannel æ˜¯å¦å·²ç»å¯åŠ¨å®Œæˆ, cni ä¹Ÿå¯åŠ¨æˆåŠŸ kubectl get pods -A ## æˆåŠŸä¹‹åä¼šæœ‰ä¸‹é¢çš„æœåŠ¡ï¼Œ éƒ½æ˜¯ running çŠ¶æ€ kube-system coredns-7f6cbbb7b8-5hqt5 1/1 Running 15 (76m ago) 26h kube-system coredns-7f6cbbb7b8-lwdrv 1/1 Running 15 (76m ago) 26h kube-system etcd-centos1 1/1 Running 18 (76m ago) 26h kube-system kube-apiserver-centos1 1/1 Running 25 (76m ago) 26h kube-system kube-controller-manager-centos1 1/1 Running 12 (76m ago) 26h kube-system kube-flannel-ds-6lx7s 1/1 Running 6 (76m ago) 21h kube-system kube-flannel-ds-n5tfn 1/1 Running 6 (76m ago) 21h kube-system kube-proxy-78jrm 1/1 Running 8 (76m ago) 26h kube-system kube-proxy-wl5jg 1/1 Running 8 (76m ago) 26h kube-system kube-scheduler-centos1 1/1 Running 16 (76m ago) 26h ","date":"2021-12-01","objectID":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/:3:0","tags":["k8s","cloud native"],"title":"åœ¨ centos ä¸Šå®‰è£… k8s","uri":"/ooooo-notes/%E5%9C%A8-centos-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-k8s/"},{"categories":null,"content":"åœ¨ ~\\.gradle ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ init.gradle, å†…å®¹å¦‚ä¸‹ allprojects { repositories { mavenLocal() maven { name \"Alibaba\" ; url \"https://maven.aliyun.com/repository/public\" } maven { name \"Bstek\" ; url \"http://nexus.bsdn.org/content/groups/public/\" } } buildscript { repositories { maven { name \"Alibaba\" ; url 'https://maven.aliyun.com/repository/public' } maven { name \"Bstek\" ; url 'https://nexus.bsdn.org/content/groups/public/' } maven { name \"M2\" ; url 'https://plugins.gradle.org/m2/' } } } } ","date":"2021-01-02","objectID":"/ooooo-notes/gradle-%E5%85%A8%E5%B1%80%E8%AE%BE%E7%BD%AE%E4%BB%93%E5%BA%93%E9%95%9C%E5%83%8F/:0:0","tags":["resolution"],"title":"gradle å…¨å±€è®¾ç½®ä»“åº“é•œåƒ","uri":"/ooooo-notes/gradle-%E5%85%A8%E5%B1%80%E8%AE%BE%E7%BD%AE%E4%BB%93%E5%BA%93%E9%95%9C%E5%83%8F/"},{"categories":null,"content":" 0ã€æŒç»­å­¦ä¹ è€… Talk is cheap. Show me the code. è‹±è¯­æ¯”ç¼–ç¨‹ç®€å•ã€‚ å­¦ä¹ å’Œå®è·µè¦å¹³è¡¡ã€‚ å­¦ä¼šå’Œæ—¶é—´åšæœ‹å‹ã€‚ å­¦ä¼šæŠ•èµ„ï¼Œå­¦ä¼šç†è´¢ã€‚ å­¦ä¼šå…ˆåšå‡æ³•ï¼Œå†åšåŠ æ³•ã€‚ å­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ã€‚ è¯´æ˜ï¼š â­• è¿›è¡Œä¸­ âœ… å·²å®Œæˆ âŒ å·²åºŸå¼ƒ â“ æœ‰å¿…è¦ â— é‡è¦æ€§ ğŸ“ è®°ç¬”è®° ğŸ–Šï¸ å†™ä»£ç  ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:1:0","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€å…³äºè‹±è¯­å¬è¯´è¯»å†™ï¼Œç›®å‰çš„å­¦ä¹ é‡ç‚¹æ˜¯æ—¥å¸¸æ²Ÿé€šï¼Œæ‰€ä»¥æ”¾å¼ƒèƒŒå•è¯ã€‚ è®¡åˆ’ ğŸ‰ï¼š ç›®å‰æˆ‘å·²ç»èƒŒå•è¯ 518 å¤šå¤©ï¼Œæˆ‘å°†ä¼šç»§ç»­èƒŒå•è¯ï¼ˆå¢¨å¢¨èƒŒå•è¯ï¼‰ã€‚ âŒ å­¦ä¹ ã€Šæ–°æ¦‚å¿µè‹±è¯­ä¸€ã€‹ âœ… çœ‹ Spring Frameworkã€‚ å­¦ä¹ ã€Šèµ–ä¸–é›„ç¾è¯­éŸ³æ ‡ã€‹ å­¦ä¹ ã€Šæ–°æ¦‚å¿µè‹±è¯­äºŒã€‹ ç›®å‰çŠ¶æ€: ã€Šæ–°æ¦‚å¿µè‹±è¯­äºŒã€‹ã€‚ ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:2:0","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€å…³äºæŠ€æœ¯è®¡åˆ’ ğŸ‰ï¼š åªè®°å½•è‡ªå·±è®¤ä¸ºæœ‰ç”¨çš„ç¬”è®°ã€‚ ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:3:0","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç±0ï¸âƒ£1ï¸âƒ£. ã€ŠJava æ€§èƒ½ä¼˜åŒ–æƒå¨æŒ‡å—ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€ŠNetty å®æˆ˜ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šç¨‹åºå‘˜é¢è¯•é‡‘å…¸ï¼ˆç¬¬6ç‰ˆï¼‰ã€‹ â­• 0ï¸âƒ£4ï¸âƒ£. ã€Šå›¾è§£TCP/IPã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€ŠSpring æºç æ·±åº¦è§£æã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ â­• 0ï¸âƒ£7ï¸âƒ£. ã€ŠSpring Cloud å¾®æœåŠ¡ï¼šå…¥é—¨ã€å®æˆ˜ä¸è¿›é˜¶ã€‹ 0ï¸âƒ£8ï¸âƒ£. ã€ŠSpring Cloud Alibaba å¾®æœåŠ¡åŸç†ä¸å®æˆ˜ã€‹ âœ… 0ï¸âƒ£9ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Apache Dubbo ä¸å®æˆ˜ã€‹ âœ… 1ï¸âƒ£0ï¸âƒ£. ã€Šarthasã€‹ 1ï¸âƒ£1ï¸âƒ£. ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ 1ï¸âƒ£2ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Kafkaï¼šæ ¸å¿ƒè®¾è®¡ä¸å®è·µåŸç†ã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€ŠSpring 5æ ¸å¿ƒåŸç†ä¸30ä¸ªç±»æ‰‹å†™å®æˆ˜ã€‹ âŒ 1ï¸âƒ£4ï¸âƒ£. ã€ŠNetty 4æ ¸å¿ƒåŸç†ä¸æ‰‹å†™RPCæ¡†æ¶å®æˆ˜ã€‹ âŒ 1ï¸âƒ£5ï¸âƒ£. ã€Šä»é›¶å¼€å§‹å­¦æ¶æ„ã€‹ 1ï¸âƒ£6ï¸âƒ£. ã€Šé«˜å¯ç”¨å¯ä¼¸ç¼©å¾®æœåŠ¡æ¶æ„ã€‹ 1ï¸âƒ£7ï¸âƒ£. ã€Šå®æˆ˜Javaè™šæ‹Ÿæœºã€‹ â“ 1ï¸âƒ£9ï¸âƒ£. ã€Šåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•å¼€å‘å®æˆ˜ã€‹ 2ï¸âƒ£0ï¸âƒ£. ã€ŠGo Web ç¼–ç¨‹ã€‹ 2ï¸âƒ£1ï¸âƒ£. ã€Šconsulã€‹ âŒ 2ï¸âƒ£2ï¸âƒ£. ã€ŠJava å¼‚æ­¥ç¼–ç¨‹å®æˆ˜ã€‹ â“ 2ï¸âƒ£3ï¸âƒ£. ã€ŠEffective C++ã€‹ 2ï¸âƒ£4ï¸âƒ£. More Effective C++ 2ï¸âƒ£5ï¸âƒ£. æ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ 2ï¸âƒ£6ï¸âƒ£. ã€Šæ·±å…¥æµ…å‡º Dockerã€‹ âœ… 2ï¸âƒ£7ï¸âƒ£. ã€Šç å‡ºé«˜æ•ˆï¼šJavaå¼€å‘æ‰‹å†Œã€‹ 2ï¸âƒ£8ï¸âƒ£. ã€ŠGo ä¸“å®¶ç¼–ç¨‹ã€‹ 2ï¸âƒ£9ï¸âƒ£. ã€Šæµç•…çš„ Pythonã€‹ 3ï¸âƒ£0ï¸âƒ£. ã€Šwiresharkç½‘ç»œåˆ†æçš„è‰ºæœ¯ã€‹ 3ï¸âƒ£2ï¸âƒ£. ã€ŠRocketMQæŠ€æœ¯å†…å¹•ã€‹ âœ… 3ï¸âƒ£3ï¸âƒ£. ã€ŠRocketMQåˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ï¼šæ ¸å¿ƒåŸç†ä¸æœ€ä½³å®è·µã€‹ âœ… 3ï¸âƒ£4ï¸âƒ£. ã€ŠRocketMQå®æˆ˜ä¸åŸç†è§£æã€‹ âœ… 3ï¸âƒ£5ï¸âƒ£. ã€ŠVimå®ç”¨æŠ€å·§ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹ â­• 3ï¸âƒ£6ï¸âƒ£. ã€ŠRocketMQæŠ€æœ¯å†…å¹• ç¬¬äºŒç‰ˆã€‹ 3ï¸âƒ£7ï¸âƒ£. ã€ŠKubernetes in Actionä¸­æ–‡ç‰ˆã€‹ â­• 3ï¸âƒ£8ï¸âƒ£. ã€Šrocketmqã€‹ â­• 3ï¸âƒ£9ï¸âƒ£. ã€Šspring cloud streamã€‹ âœ… 3ï¸âƒ£9ï¸âƒ£. ã€Šdubboã€‹ â­• 4ï¸âƒ£0ï¸âƒ£. ã€Špulsarã€‹ â­• 4ï¸âƒ£0ï¸âƒ£. ã€Šnsqã€‹ 4ï¸âƒ£0ï¸âƒ£. ã€Ševentingã€‹ 4ï¸âƒ£0ï¸âƒ£. ã€Šservingã€‹ 4ï¸âƒ£1ï¸âƒ£. ã€ŠActivitiã€‹ âœ… ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:3:1","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€æ–‡æ¡£0ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥æ‹†è§£ Java è™šæ‹Ÿæœºã€‹ 0ï¸âƒ£2ï¸âƒ£. é€šè¯» Spring å®˜ç½‘ï¼Œ+å®è·µ+ä»£ç +ç¬”è®°ã€‚ 0ï¸âƒ£1ï¸âƒ£ spring-cloud-netflix-eureka-clients 0ï¸âƒ£2ï¸âƒ£ spring-cloud-netflix-eureka-server 0ï¸âƒ£3ï¸âƒ£ spring-cloud-task âœ… 0ï¸âƒ£3ï¸âƒ£. å­¦ä¹  Go è¯­è¨€ï¼Œé€šè¯» Go å®˜ç½‘ï¼Œ+å®è·µ+ä»£ç +ç¬”è®°ã€‚ 0ï¸âƒ£1ï¸âƒ£. ã€ŠA Tour of Goã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€ŠTutorial: Create a moduleã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€ŠWriting Web Applicationsã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€ŠHow to write Go codeã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€ŠEffective Goã€‹ 0ï¸âƒ£4ï¸âƒ£. Protobuf javaTutorial âœ… 0ï¸âƒ£5ï¸âƒ£. Goè¯­è¨€æ ¸å¿ƒ36è®² âœ… 0ï¸âƒ£6ï¸âƒ£. æ¶ˆæ¯é˜Ÿåˆ—é«˜æ‰‹è¯¾ âœ… 0ï¸âƒ£7ï¸âƒ£. ä» 0 å¼€å§‹å¸¦ä½ æˆä¸ºæ¶ˆæ¯ä¸­é—´ä»¶å®æˆ˜é«˜æ‰‹ âœ… 0ï¸âƒ£8ï¸âƒ£. ä» 0 å¼€å§‹å¸¦ä½ æˆä¸ºJVMå®æˆ˜é«˜æ‰‹ â­• ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:3:2","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3ã€è§†é¢‘0ï¸âƒ£1ï¸âƒ£. ã€Šç©è½¬ç®—æ³•ç³»åˆ—â€“å›¾è®ºç²¾è®²ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šç©è½¬ç®—æ³•é¢è¯•ã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€Šåˆ©ç”¨Goä¼˜è¶Šçš„æ€§èƒ½è®¾è®¡ä¸å®ç°é«˜æ€§èƒ½ä¼ä¸šçº§å¾®æœåŠ¡ç½‘å…³ã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€Šçœ‹çš„è§çš„ç®—æ³•ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€Šæå®¢æ—¶é—´â€“ Java è¿›é˜¶è®­ç»ƒè¥ã€‹ âŒ 0ï¸âƒ£5ï¸âƒ£. ã€Šæå®¢æ—¶é—´â€“ go è¿›é˜¶è®­ç»ƒè¥ã€‹ âŒ 0ï¸âƒ£5ï¸âƒ£. ã€Šæå®¢æ—¶é—´â€“ ç®—æ³•è¿›é˜¶è®­ç»ƒè¥ã€‹ â­• ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:3:3","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€ç®—æ³•0ï¸âƒ£1ï¸âƒ£. æ¯å‘¨è‡³å°‘ 5 é“ Leetcodeã€‚ â­• 0ï¸âƒ£2ï¸âƒ£. leetcode å…¨ç«™æ’å1000ä»¥å†…ã€‚ â­• 0ï¸âƒ£3ï¸âƒ£. leetcode å‘¨èµ›å…¨å›½æ’å2000ä»¥å†…ã€‚ â­• 0ï¸âƒ£4ï¸âƒ£. leetcode å‘¨èµ›å…¨çƒæ’å10000ä»¥å†…ã€‚ â­• ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:3:4","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€å…³äºå…¶ä»–","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:0","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€ä¹¦ç± ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šèªæ˜çš„æŠ•èµ„è€…ã€‹ 0ï¸âƒ£2ï¸âƒ£. ã€Šä¸€ä¸‡å°æ—¶å¤©æ‰ç†è®ºã€‹ â­• 0ï¸âƒ£3ï¸âƒ£. ã€Šç•ªèŒ„å·¥ä½œæ³•å›¾è§£ã€‹ â­• 0ï¸âƒ£4ï¸âƒ£. ã€Šä¸‰ä½“ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€Šä¸‰ä½“â…¡ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€Šä¸‰ä½“â…¢ã€‹ 0ï¸âƒ£7ï¸âƒ£. ã€Šéæš´åŠ›æ²Ÿé€šã€‹ â­• 0ï¸âƒ£8ï¸âƒ£. ã€Šç®¡ç†ä½ çš„æ¯ä¸€å¤©ã€‹ â­• 0ï¸âƒ£9ï¸âƒ£. ã€ŠåŸåˆ™ã€‹ 1ï¸âƒ£0ï¸âƒ£. ã€Šæ€è€ƒï¼Œå¿«ä¸æ…¢ã€‹ 1ï¸âƒ£1ï¸âƒ£. ã€Šå…³é”®å¯¹è¯ã€‹ 1ï¸âƒ£2ï¸âƒ£. ã€Šå½“ä¸‹çš„å¯è’™ã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€ŠæŠŠæ—¶é—´å½“ä½œæœ‹å‹ã€‹ â­• 1ï¸âƒ£3ï¸âƒ£. ã€Šæ´»ç€ã€‹ âœ… 1ï¸âƒ£4ï¸âƒ£. ã€Šç™½å¤œè¡Œã€‹ â­• 1ï¸âƒ£5ï¸âƒ£. ã€Šäº²å¯†å…³ç³»ï¼šé€šå¾€çµé­‚çš„æ¡¥æ¢ã€‹ â­• ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:1","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€é€‰è¯» ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€ŠC++ Primeï¼ˆç¬¬5ç‰ˆï¼‰ã€‹ âŒ 0ï¸âƒ£2ï¸âƒ£. ã€Šç®—æ³• 4ã€‹ 0ï¸âƒ£3ï¸âƒ£. ã€ŠJMC å·¥å…·(Java Mission Control)ã€‹ 0ï¸âƒ£4ï¸âƒ£. ã€ŠZooKeeperã€‹ 0ï¸âƒ£5ï¸âƒ£. ã€ŠMIT é«˜çº§æ•°æ®è¯¾ç¨‹ã€‹ 0ï¸âƒ£6ï¸âƒ£. ã€ŠResilience4jã€‹ â“ 0ï¸âƒ£7ï¸âƒ£. ã€ŠGoogle Guavaã€‹ â“ 0ï¸âƒ£8ï¸âƒ£. ã€ŠKafka å®˜ç½‘ã€‹ 0ï¸âƒ£9ï¸âƒ£. ã€ŠSpring Security å®æˆ˜ã€‹ âŒ 1ï¸âƒ£0ï¸âƒ£. ã€ŠJvisualvmã€‹ 1ï¸âƒ£1ï¸âƒ£. ã€Šæ·±å…¥ç†è§£ Nginxï¼ˆç¬¬ 2 ç‰ˆï¼‰ã€‹ â“ 1ï¸âƒ£2ï¸âƒ£. ã€Šåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼šåŸç†ä¸å®è·µã€‹ 1ï¸âƒ£3ï¸âƒ£. ã€Šchrome-devtoolsã€‹ âŒ 1ï¸âƒ£4ï¸âƒ£. ã€Šäººæ€§çš„å¼±ç‚¹ã€‹ 1ï¸âƒ£5ï¸âƒ£. ã€Šæ·±å…¥å‰–æ Tomcatã€‹ 1ï¸âƒ£6ï¸âƒ£. ã€ŠJava ç¼–ç¨‹æ–¹æ³•è®ºï¼šå“åº”å¼Spring Reactor 3è®¾è®¡ä¸å®ç°ã€‹ 1ï¸âƒ£7ï¸âƒ£. ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ã€‹ 1ï¸âƒ£8ï¸âƒ£. ã€ŠGo ç¨‹åºè®¾è®¡è¯­è¨€ã€‹ âŒ 1ï¸âƒ£9ï¸âƒ£. ã€Šæœºå™¨å­¦ä¹ å®æˆ˜ï¼šåŸºäºScikit-Learnã€Keraså’ŒTensorFlowã€‹ 2ï¸âƒ£0ï¸âƒ£. ã€ŠPythonæ·±åº¦å­¦ä¹ ã€‹ 2ï¸âƒ£1ï¸âƒ£. ã€Šå½“æˆ‘è°ˆè·‘æ­¥æ—¶ï¼Œæˆ‘è°ˆäº›ä»€ä¹ˆã€‹ ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:2","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3ã€å°è¯• ğŸ‰0ï¸âƒ£1ï¸âƒ£. å­¦ä¼šä½¿ç”¨å°¤å…‹é‡Œé‡Œå¼¹å¥ ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:3","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€äº†è§£ ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šhugoã€‹ âœ… ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:4","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 5ã€å¨±ä¹0ï¸âƒ£1ï¸âƒ£. ã€Šå‚²æ…¢ä¸åè§ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šå¿—æ˜ä¸æ˜¥å¨‡ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€Šæ˜¥å¨‡ä¸å¿—æ˜ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€Šæ˜¥å¨‡æ•‘å¿—æ˜ã€‹ âœ… ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:5","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 6. æ€»ç»“ ä»Šå¹´å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½æ”¾åœ¨é˜…è¯»æºç ä¸Šï¼Œå¯¼è‡´å¾ˆå¤šçš„ä¹¦ç±æ²¡æœ‰çœ‹å®Œï¼Œä¹Ÿæ”¾å¼ƒäº†è‹±è¯­å­¦ä¹ ã€‚ å¹´åˆå®šçš„è®¡åˆ’åœ¨å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸¤æ¬¡æ”¹å˜äº†å­¦ä¹ é‡ç‚¹ï¼Œ 1. mq æºç  2. k8s æºç ã€‚ è®¤çœŸæ€è€ƒæŒ‡å®š 2022 çš„è®¡åˆ’ ","date":"2021-01-01","objectID":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/:4:6","tags":["learning"],"title":"2021å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2021%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":"åœ¨ conf/server.xml ä¸­çš„ Hostæ ‡ç­¾æ·»åŠ  \u003cHost name=\"localhost\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"true\"\u003e \u003cValve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\" prefix=\"localhost_access_log\" suffix=\".txt\" pattern=\"%h %l %u %t \u0026quot;%r\u0026quot; %s %b\" /\u003e // è¿™æ˜¯æ–°åŠ çš„ \u003cValve className=\"org.apache.catalina.valves.ErrorReportValve\" errorCode.400=\"webapps/ROOT/error.jsp\" errorCode.0=\"webapps/ROOT/error.jsp\" showReport=\"false\" showServerInfo=\"false\" /\u003e // è¿™æ˜¯æ–°åŠ çš„ \u003c/Host\u003e ä¸Šé¢çš„ error.jsp æ”¾åœ¨ webapps/ROOT/ å‚è€ƒ https://stackoverflow.com/questions/52814582/tomcat-is-not-redirecting-to-400-bad-request-custom-error-page å‚è€ƒ https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Error_Report_Valve ","date":"2021-01-01","objectID":"/ooooo-notes/tomcat-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5/:0:0","tags":["resolution"],"title":"tomcat è‡ªå®šä¹‰é”™è¯¯é¡µ","uri":"/ooooo-notes/tomcat-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5/"},{"categories":null,"content":" é‡å†™æ–¹æ³•XMLHttpRequest.prototype.send XMLHttpRequest.prototype._send = XMLHttpRequest.prototype.send XMLHttpRequest.prototype.send = function (params) { var attached_params = mdcUtil.MDC_DEVICE_ID + \"=\" + mdcUtil.getMdcDeviceId(); if (params) { params += \"\u0026\" + attached_params; } else { params = attached_params; } return this._send(params) } ","date":"2020-01-05","objectID":"/ooooo-notes/%E5%9C%A8-js-%E4%B8%AD%E7%BB%9F%E4%B8%80%E8%AE%BE%E7%BD%AE%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95/:0:0","tags":["resolution"],"title":"åœ¨ js ä¸­ç»Ÿä¸€è®¾ç½®è¯·æ±‚å‚æ•°çš„å¦ä¸€ç§æ–¹æ³•","uri":"/ooooo-notes/%E5%9C%A8-js-%E4%B8%AD%E7%BB%9F%E4%B8%80%E8%AE%BE%E7%BD%AE%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":null,"content":" ç¼–è¾‘è¿è¡Œé…ç½®ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ä¸­çš„å·¥ä½œç›®å½•ä¸ºå½“å‰æ¨¡å—ç›®å½•ã€‚ ","date":"2020-01-04","objectID":"/ooooo-notes/idea-%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8webapp-%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%88%B0/:0:0","tags":["resolution"],"title":"idea å¤šæ¨¡å—é¡¹ç›®å¯åŠ¨ï¼Œwebapp ç›®å½•ä¸‹æ–‡ä»¶è®¿é—®ä¸åˆ°","uri":"/ooooo-notes/idea-%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8webapp-%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%88%B0/"},{"categories":null,"content":" å»æ‰å±æ€§ requiredï¼Œæ·»åŠ  rules è§„åˆ™ { required: true, message: 'è¯·è¾“å…¥å§“å', trigger: 'blur' } ","date":"2020-01-03","objectID":"/ooooo-notes/element-ui-%E4%B8%AD-el-form-item-%E6%A0%A1%E9%AA%8C%E5%87%BA%E7%8E%B0%E8%8B%B1%E6%96%87/:0:0","tags":["resolution"],"title":"element-ui ä¸­ el-form-item æ ¡éªŒå‡ºç°è‹±æ–‡","uri":"/ooooo-notes/element-ui-%E4%B8%AD-el-form-item-%E6%A0%A1%E9%AA%8C%E5%87%BA%E7%8E%B0%E8%8B%B1%E6%96%87/"},{"categories":null,"content":"é—®é¢˜ If you see that the storm process is getting crashed even though you have enough memory (swap/free) available then you should also check the â€œ/proc/sys/vm/overcommit_memoryâ€ This switch knows 3 different settings: =\u003e 0: The Linux kernel is free to over commit memory(this is the default), a heuristic algorithm is applied to figure out if enough memory is available. =\u003e 1: The Linux kernel will always over commit memory, and never check if enough memory is available. This increases the risk of out-of-memory situations, but also improves memory-intensive workloads. =\u003e 2: The Linux kernel will not over commit memory, and only allocate as much memory as defined in over commit_ratio. As sometimes OS kills /crashes a process due to a system OS setting, the system OS memory overcommit setting was 2 (when it should have been set to 0) - ","date":"2020-01-02","objectID":"/ooooo-notes/java-%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%A4%B1%E8%B4%A5/:0:0","tags":["resolution"],"title":"java å‡ºç°å†…å­˜åˆ†é…å¤±è´¥","uri":"/ooooo-notes/java-%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%A4%B1%E8%B4%A5/"},{"categories":null,"content":" 0ã€æŒç»­å­¦ä¹ è€… Talk is cheap. Show me the code. è‹±è¯­æ¯”ç¼–ç¨‹ç®€å•ã€‚ å­¦ä¹ å’Œå®è·µè¦å¹³è¡¡ã€‚ å­¦ä¼šå’Œæ—¶é—´åšæœ‹å‹ã€‚ å­¦ä¼šæŠ•èµ„ï¼Œå­¦ä¼šç†è´¢ã€‚ å­¦ä¼šå…ˆåšå‡æ³•ï¼Œå†åšåŠ æ³•ã€‚ å­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ï¼Œå­¦è‹±è¯­å¾ˆé‡è¦ã€‚ è¯´æ˜ï¼š â­• è¿›è¡Œä¸­ âœ… å·²å®Œæˆ âŒ å·²åºŸå¼ƒ â“ æœ‰å¿…è¦ â— é‡è¦ ğŸ“ è®°ç¬”è®°* ğŸ–Šï¸ å†™ä»£ç  ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:1:0","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1ã€å…³äºè‹±è¯­å¬è¯´è¯»å†™ï¼Œå…¶ä¸­æœ€å®¹æ˜“çš„åº”è¯¥æ˜¯è¯»ï¼Œç„¶åå†æ˜¯å†™ï¼Œæˆ‘æœ‰å¾ˆå¤§çš„ä¿¡å¿ƒèƒ½åœ¨ä¸¤ä¸‰å¹´ä¹‹å†…ï¼ˆ2022ï¼‰æ­£å¸¸è¯»å†™ã€‚å‰©ä½™å°±æ˜¯å¬å’Œè¯´äº†ï¼Œç›®å‰å¯¹æˆ‘çœŸçš„å¤ªéš¾äº†ã€‚ è®¡åˆ’ ğŸ‰ï¼š ç›®å‰æˆ‘å·²ç»èƒŒå•è¯ 430 å¤šå¤©ï¼Œæˆ‘å°†ä¼šç»§ç»­èƒŒå•è¯ï¼ˆå¢¨å¢¨èƒŒå•è¯ï¼‰ğŸ˜„ ã€‚ çœ‹ YouTube - English with Lucyã€‚ â“ çœ‹ Springã€‚ çœ‹ Friendsã€‚ â“ ç›®å‰çŠ¶æ€: æ‰‡è´é˜…è¯»ã€‚ â— ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:2:0","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2ã€å…³äºæŠ€æœ¯åªè®°å½•è‡ªå·±è®¤ä¸ºæœ‰ç”¨çš„ç¬”è®°ã€‚ è®¡åˆ’ ğŸ‰ï¼š ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:3:0","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 1. ä¹¦ç±0ï¸âƒ£1ï¸âƒ£. ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€ŠRedis å¼€å‘ä¸è¿ç»´ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šå‰‘æŒ‡ Offerã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€ŠEffective Javaä¸­æ–‡ç‰ˆï¼ˆç¬¬3ç‰ˆï¼‰ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€ŠJava 8 å‡½æ•°å¼ç¼–ç¨‹ ã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€Šç®—æ³•å›¾è§£ã€‹ âœ… 0ï¸âƒ£7ï¸âƒ£. ã€Šè®¾è®¡æ¨¡å¼ã€‹ âœ… 0ï¸âƒ£8ï¸âƒ£. ã€Šå›¾è§£ HTTP ã€‹ âœ… 0ï¸âƒ£9ï¸âƒ£. ã€ŠSpring Bootç¼–ç¨‹æ€æƒ³ï¼ˆæ ¸å¿ƒç¯‡ï¼‰ã€‹ âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:3:1","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 2. æ–‡æ¡£0ï¸âƒ£1ï¸âƒ£. ã€ŠMySQL å®æˆ˜ 45 è®²ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€ŠKafka æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€ŠJava æ ¸å¿ƒæŠ€æœ¯ 36 è®²ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:3:2","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 3. è§†é¢‘0ï¸âƒ£1ï¸âƒ£. ã€Šç®—æ³•é¢è¯•é€šå…³ 40 è®²ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šç©è½¬ç®—æ³•ç³»åˆ—â€“ç©è½¬æ•°æ®ç»“æ„ Java ç‰ˆã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šç®—æ³•ä¸æ•°æ®ç»“æ„-ç»¼åˆæå‡ C++ ç‰ˆã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€Šç©è½¬ Spring å…¨å®¶æ¡¶ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€ŠGo è¯­è¨€ä»å…¥é—¨åˆ°å®æˆ˜ã€‹ âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:3:3","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4. é€šè¯» Spring å®˜ç½‘0ï¸âƒ£1ï¸âƒ£ spring-cloud-stream âœ… 0ï¸âƒ£2ï¸âƒ£ spring-cloud-netflix-zuul âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:3:4","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 4ã€å…³äºå…¶ä»– é˜…è¯»ï¼Œ+ç¬”è®° 0ï¸âƒ£1ï¸âƒ£. ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€Šå¯Œçˆ¸çˆ¸ç©·çˆ¸çˆ¸ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€Šè§£è¯»åŸºé‡‘ã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€Šå¯Œçˆ¸çˆ¸è´¢åŠ¡è‡ªç”±ä¹‹è·¯ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€Šå…‹è±å› å£¶ã€‹ âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:4:0","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" 5ã€é€‰è¯» ğŸ‰0ï¸âƒ£1ï¸âƒ£. ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ âœ… 0ï¸âƒ£2ï¸âƒ£. ã€ŠSpring å®æˆ˜ï¼ˆç¬¬5ç‰ˆ ï¼‰ã€‹ âœ… 0ï¸âƒ£3ï¸âƒ£. ã€ŠCloud Native Javaã€‹ âœ… 0ï¸âƒ£4ï¸âƒ£. ã€ŠMyBatis æŠ€æœ¯å†…å¹•ã€‹ âœ… 0ï¸âƒ£5ï¸âƒ£. ã€Šçœ‹é€ Spring MVCã€‹ âœ… 0ï¸âƒ£6ï¸âƒ£. ã€ŠRedis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µã€‹ âœ… 0ï¸âƒ£7ï¸âƒ£. ã€ŠOfferæ¥äº†ï¼šJavaé¢è¯•æ ¸å¿ƒçŸ¥è¯†ç‚¹ç²¾è®²ï¼ˆåŸç†ç¯‡ï¼‰ã€‹ âœ… 0ï¸âƒ£8ï¸âƒ£. ã€ŠOfferæ¥äº†ï¼šJavaé¢è¯•æ ¸å¿ƒçŸ¥è¯†ç‚¹ç²¾è®²ï¼ˆæ¡†æ¶ç¯‡ï¼‰ã€‹ âœ… ","date":"2020-01-01","objectID":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/:5:0","tags":["learning"],"title":"2020å¹´å­¦ä¹ è®¡åˆ’","uri":"/ooooo-notes/2020%E5%B9%B4%E8%AE%A1%E5%88%92/"},{"categories":null,"content":" æ‰§è¡Œå‘½ä»¤ rm -rf ~/.zcompdump* ","date":"2020-01-01","objectID":"/ooooo-notes/zsh-%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6%E5%90%8E%E4%B8%8D%E7%94%9F%E6%95%88/:0:0","tags":["resolution"],"title":"zsh æ·»åŠ æ’ä»¶åï¼Œä¸ç”Ÿæ•ˆ","uri":"/ooooo-notes/zsh-%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6%E5%90%8E%E4%B8%8D%E7%94%9F%E6%95%88/"},{"categories":null,"content":" 1ã€Redis ç‰¹æ€§","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 1ã€é€Ÿåº¦å¿« Redis çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ”¾åœ¨å†…å­˜ä¸­çš„ã€‚ Redis æ˜¯ C è¯­è¨€å®ç°çš„ã€‚ Redis ä½¿ç”¨å•çº¿ç¨‹æ¶æ„ï¼Œé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 2ã€åŸºäºé”®å€¼å¯¹çš„æ•°æ®ç»“æ„æœåŠ¡å™¨Redis ä¸»è¦æä¾›äº”ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼šstringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€hashï¼ˆå“ˆå¸Œï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ã€setï¼ˆé›†åˆï¼‰ã€zsetï¼ˆæœ‰åºé›†åˆï¼‰ï¼Œè¿˜æä¾› Bitmapsï¼ˆä½å›¾ï¼‰ã€HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ç®—æ³•ï¼‰ã€GEOï¼ˆåœ°ç†ä½ç½®ï¼‰é«˜çº§æ•°æ®ç»“æ„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 3ã€ä¸°å¯Œçš„åŠŸèƒ½ æä¾›äº†é”®è¿‡æœŸåŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥å®ç°ç¼“å­˜ã€‚ æä¾›äº†å‘å¸ƒè®¢é˜…åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥å®ç°æ¶ˆæ¯ç³»ç»Ÿã€‚ æ”¯æŒ Lua è„šæœ¬åŠŸèƒ½ï¼Œå¯ä»¥åˆ©ç”¨ Lua åˆ›é€ æ–°çš„ Redis å‘½ä»¤ã€‚ æä¾›äº†ç®€å•äº‹åŠ¡åŠŸèƒ½ã€‚ æä¾›äº† Pipelineï¼ˆæµæ°´çº¿ï¼‰åŠŸèƒ½ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 4ã€ç®€å•ç¨³å®šæ—©æœŸçš„ Redis æºç åªæœ‰ä¸¤ä¸‡è¡Œï¼Œ3.0 ç‰ˆæœ¬åæ·»åŠ äº†é›†ç¾¤ç‰¹æ€§ï¼Œä»£ç å¢åˆ° 5 ä¸‡è¡Œå·¦å³ï¼ŒRedis è‡ªå·±å®ç°äº†äº‹ä»¶å¤„ç†åŠŸèƒ½ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 5ã€å®¢æˆ·ç«¯è¯­è¨€å¤šRedis æä¾›äº†ç®€å•çš„ TCP é€šä¿¡åè®®ï¼Œä¸»æµçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å…¶å®¢æˆ·ç«¯å®ç°ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 6ã€æŒä¹…åŒ–Redis æä¾›äº† AOF ã€ RDB ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:6","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 7ã€ä¸»ä»å¤åˆ¶ã€é«˜å¯ç”¨å’Œåˆ†å¸ƒå¼Redis Sentinel ã€Redis Cluster ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:1:7","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 2ã€Redis ä½¿ç”¨åœºæ™¯","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" Redis å¯ä»¥åšä»€ä¹ˆ ç¼“å­˜ã€‚ï¼ˆ Redis æä¾›äº†é”®è¿‡æœŸæ—¶é—´è®¾ç½®ï¼‰ æ’è¡Œæ¦œç³»ç»Ÿã€‚ï¼ˆ Redis æä¾›äº†åˆ—è¡¨ list å’Œæœ‰åºé›†åˆ set æ•°æ®ç»“æ„ï¼‰ è®¡æ•°å™¨åº”ç”¨ã€‚ï¼ˆ Redis æä¾›äº†è®¡æ•°åŠŸèƒ½ incrã€decr ï¼‰ ç¤¾äº¤ç½‘ç»œã€‚ï¼ˆèµ/è¸©ã€ç²‰ä¸ã€å…±åŒå¥½å‹/å–œå¥½ï¼‰ æ¶ˆæ¯é˜Ÿåˆ—ã€‚ï¼ˆ Redis æä¾›äº†åˆ—è¡¨ list çš„ rpush, blpop å‘½ä»¤ ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" Redis ä¸å¯ä»¥åšä»€ä¹ˆ Redis åŸºäºå†…å­˜ï¼Œä¸èƒ½åšå­˜å‚¨ã€‚ é¿å…ç”¨ Redis æ¥ç¼“å­˜å†·æ•°æ®ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/01/"},{"categories":null,"content":" 1ã€é¢„å¤‡","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€å…¨å±€å‘½ä»¤ help HELP command æŸ¥çœ‹æ‰€æœ‰çš„key KEYS * é”®æ€»æ•° DBSIZE æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ EXISTS key åˆ é™¤é”® DEL key é”®è¿‡æœŸ EXPIRE key sencond ttl è¿”å›è¿‡æœŸæ—¶é—´ TTL key \u003e0: å‰©ä½™è¿‡æœŸæ—¶é—´ -1: æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ -2: é”®ä¸å­˜åœ¨ keyçš„æ•°æ®ç»“æ„ç±»å‹ TYPE key ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€æ•°æ®ç»“æ„ä¸å†…éƒ¨ç¼–ç æ¯ç§æ•°æ®ç»“æ„éƒ½æœ‰è‡ªå·±åº•å±‚çš„å†…éƒ¨ç¼–ç å®ç°ï¼Œé€šè¿‡å‘½ä»¤ OBJECT ENCODING key æ¥æŸ¥çœ‹ã€‚ string å†…éƒ¨ç¼–ç ï¼š rawã€intã€embstr hash å†…éƒ¨ç¼–ç ï¼š ziplistã€hashtable list å†…éƒ¨ç¼–ç ï¼š ziplistã€linkedlistã€quicklist set å†…éƒ¨ç¼–ç ï¼š intsetã€hashtable zset å†…éƒ¨ç¼–ç ï¼š ziplistã€skiplist ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€string","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€å¸¸ç”¨å‘½ä»¤ è®¾ç½®å€¼ã€è·å–å€¼ SET key value [expiration EX seconds|PX milliseconds] [NX|XX] GET key è¯´æ˜ï¼š NXï¼šä¸å­˜åœ¨ keyï¼Œæ‰è®¾ç½®æˆåŠŸã€‚åŒå‘½ä»¤ SETNX key value XXï¼šå­˜åœ¨ keyï¼Œæ‰è®¾ç½®æˆåŠŸã€‚ æ‰¹é‡è®¾ç½®ã€æ‰¹é‡è·å– MSET key value [key value ...] MGET key [key ...] è¯´æ˜ï¼š æ‰¹é‡æ“ä½œå¯ä»¥å‡å°‘ç½‘ç»œæ—¶é—´ã€‚ è®¡æ•° INCR key INCRBY key increment INCRBYFLOAT key increment DECR key DECRBY key decrement ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€ä¸å¸¸ç”¨çš„å‘½ä»¤ è¿½åŠ å€¼ APPEND key value å­—ç¬¦ä¸²é•¿åº¦ STRLEN key è®¾ç½®å¹¶è¿”å›åŸå€¼ GETSET key value è®¾ç½®æŒ‡å®šä½ç½®çš„å­—ç¬¦ SETRANGE key offset value è·å–éƒ¨åˆ†å­—ç¬¦ä¸² GETRANGE key start end ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 3ã€å†…éƒ¨ç¼–ç å­—ç¬¦ä¸²å†…éƒ¨ç¼–ç æœ‰ä¸‰ç§ï¼š intï¼š8 ä¸ªå­—èŠ‚çš„é•¿æ•´å‹ embstrï¼šå°äºç­‰äº 39 ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸² rawï¼šå¤§äº 39 ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸² ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:2:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 4ã€ä½¿ç”¨åœºæ™¯ ç¼“å­˜ ï¼ˆç½‘ç«™è¯·æ±‚æ•°æ®ç¼“å­˜ï¼‰ è®¡æ•° ï¼ˆç½‘ç«™çš„æµè§ˆæ•°å’Œæ’­æ”¾æ•°ï¼‰ å…±äº« Session ï¼ˆç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼‰ é™é€Ÿ ï¼ˆéªŒè¯ç æ¥å£ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:2:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 3ã€hash","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€å‘½ä»¤ è®¾ç½®å€¼ã€è·å–å€¼ HSET key field value HGET key field åˆ é™¤ field HDEL key field [field ...] è®¡ç®— field çš„ä¸ªæ•° HLEN key æ‰¹é‡è®¾ç½®ã€æ‰¹é‡è·å– HMSET key field value [field value ...] HMGET key field [field ...] æ˜¯å¦å­˜åœ¨ field HEXISTS key field è·å–æ‰€æœ‰çš„ field HKEYS key è·å–æ‰€æœ‰çš„ value HVALS key è·å–æ‰€æœ‰çš„ field-value HGETALL key è¯´æ˜ï¼š field ä¸ªæ•°æ¯”è¾ƒå¤šæ—¶ï¼Œä¼šé˜»å¡ redisã€‚ è®¡æ•° HINCRBY key field increment HINCRBYFLOAT key field increment è·å– value é•¿åº¦ HSTRLEN key field ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:3:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€å†…éƒ¨ç¼–ç  ziplistï¼ˆå‹ç¼©è¡¨ï¼‰ï¼šå…ƒç´ ä¸ªæ•°å°äº hash-max-ziplist-entries = 512 ï¼ŒåŒæ—¶ value å°äº hash-max-ziplist-value = 64ï¼Œå°±ä½¿ç”¨ ziplistï¼Œ é…ç½®å‚æ•°åœ¨ redis.conf ä¸­ã€‚ hashtableï¼ˆå“ˆå¸Œè¡¨ï¼‰ï¼šæ— æ³•æ»¡è¶³ ziplist çš„æ¡ä»¶ï¼Œä¼šä½¿ç”¨ hashtableã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:3:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 4ã€list","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€å‘½ä»¤ æ·»åŠ  RPUSH key value [value ...] # å³è¾¹æ·»åŠ  LPUSH key value [value ...] # å·¦è¾¹æ·»åŠ  LINSERT key BEFORE|AFTER pivot value # æŒ‡å®šä½ç½®æ’å…¥ æŸ¥è¯¢ LRANGE key start stop # èŒƒå›´ä¸º[start, stop], æŸ¥è¯¢æ‰€æœ‰æ˜¯ start = 0, stop = -1 LLEN key # åˆ—è¡¨é•¿åº¦ åˆ é™¤ LPOP key # å·¦è¾¹å¼¹å‡º RPOP key # å³è¾¹å¼¹å‡º LREM key count value ## åˆ é™¤ count ä¸ª value å€¼, count \u003e 0,ä»å·¦è¾¹åˆ é™¤ï¼›count \u003c 0,ä»å³è¾¹åˆ é™¤ï¼›count = 0, åˆ é™¤æ‰€æœ‰ LTRIM key start stop # åªä¿ç•™[start, stop]çš„å…ƒç´  ä¿®æ”¹ LSET key index value # è®¾ç½®æŒ‡å®šç´¢å¼•çš„å€¼ é˜»å¡ BLPOP key [key ...] timeout # ä»å·¦è¾¹å¼¹å‡ºå…ƒç´ ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é˜»å¡ BRPOP key [key ...] timeout # ä»å³è¾¹å¼¹å‡ºå…ƒç´ ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é˜»å¡ # timeoutï¼šé˜»å¡æ—¶é—´ã€‚å¤šä¸ª key, ä»å·¦æ‰«æã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:4:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€å†…éƒ¨ç¼–ç  ziplistï¼ˆå‹ç¼©è¡¨ï¼‰ï¼šå…ƒç´ ä¸ªæ•°å°äº list-max-ziplist-entries = 512 ï¼ŒåŒæ—¶ value å°äº list-max-ziplist-value = 64ï¼Œå°±ä½¿ç”¨ ziplistï¼Œ é…ç½®å‚æ•°åœ¨ redis.conf ä¸­ã€‚ linkedlistï¼ˆé“¾è¡¨ï¼‰ï¼šæ— æ³•æ»¡è¶³ ziplist çš„æ¡ä»¶ï¼Œä¼šä½¿ç”¨ linkedlistã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:4:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 5ã€set","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€é›†åˆå†…æ“ä½œ æ·»åŠ  SADD key member [member ...] åˆ é™¤ SREM key member [member ...] è®¡ç®—å…ƒç´ ä¸ªæ•° SCARD key æ˜¯å¦åœ¨é›†åˆä¸­ SISMEMBER key member # éšæœºè¿”å› count ä¸ªå…ƒç´ ï¼Œä¸ä¼šåˆ é™¤å…ƒç´  SRANDMEMBER key [count] éšæœºå¼¹å‡º count ä¸ªå…ƒç´ ï¼Œä¼šåˆ é™¤å…ƒç´  SPOP key [count] è·å–æ‰€æœ‰å…ƒç´  SMEMBERS key ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:5:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€é›†åˆé—´æ“ä½œ å¤šä¸ªé›†åˆçš„äº¤é›† SINTER key [key ...] å¤šä¸ªé›†åˆçš„å¹¶é›† SUNION key [key ...] å¤šä¸ªé›†åˆçš„å·®é›† SDIFF key [key ...] å°†äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„ç»“æœä¿å­˜ SINTERSTORE destination key [key ...] SUNIONSTORE destination key [key ...] SDIFFSTORE destination key [key ...] è¯´æ˜ï¼š destination è¡¨ç¤ºç›®æ ‡ keyã€‚ key è¡¨ç¤ºéœ€è¦æ“ä½œçš„ keyã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:5:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 3ã€å†…éƒ¨ç¼–ç  intsetï¼ˆæ•´æ•°é›†åˆï¼‰ï¼švalue å€¼ä¸ºæ•´å‹ï¼Œä¸ªæ•°å°äº set-max-intset-entries = 512 æ—¶ï¼Œä½¿ç”¨ intsetã€‚é…ç½®å‚æ•°åœ¨ redis.conf ä¸­ã€‚ hashtableï¼ˆå“ˆå¸Œè¡¨ï¼‰ï¼šä¸æ»¡è¶³ intset æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ hashtableã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:5:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 4ã€ä½¿ç”¨åœºæ™¯æ ‡ç­¾ç³»ç»Ÿï¼šè®¡ç®—ä¸åŒäººç›¸åŒå–œå¥½çš„æ ‡ç­¾ (SINTERå‘½ä»¤)ã€‚ SADD user1:tags tag1 tag2 SADD user2:tags tag2 tag3 SINTER user1:tags user2:tags ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:5:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 6ã€zset","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€é›†åˆå†…æ“ä½œ æ·»åŠ  ZADD key [NX|XX] [CH] [INCR] score member [score member ...] # NX: ä¸å­˜åœ¨ keyï¼Œæ‰è®¾ç½®æˆåŠŸ # XX: å­˜åœ¨ å¯ä»¥ï¼Œæ‰è®¾ç½®æˆåŠŸ è®¡ç®—æˆå‘˜ä¸ªæ•° ZCARD key è·å–æŸä¸ªæˆå‘˜çš„åˆ†æ•° ZSCORE key member è·å–æŸä¸ªæˆå‘˜çš„æ’å ZRANK key member # ä»ä½åˆ°é«˜ ZREVRANK key member # ä»é«˜åˆ°ä½ åˆ é™¤ ZREM key member [member ...] # åˆ é™¤æˆå‘˜ ZREMRANGEBYRANK key start stop # åˆ é™¤æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜ ZREMRANGEBYSCORE key min max # åˆ é™¤æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜ å¢åŠ æˆå‘˜çš„åˆ†æ•° ZINCRBY key increment member è·å–æŒ‡å®šæ’åèŒƒå›´çš„æˆå‘˜ ZRANGE key start stop [WITHSCORES] # ä»ä½åˆ°é«˜ ZREVRANGE key start stop [WITHSCORES] # ä»é«˜åˆ°åº• è·å–æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜ ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count] # WITHSCORESï¼šç»“æœè¿”å›åˆ†æ•° # LIMIT offset countï¼šé™åˆ¶è¿”å›ä¸ªæ•° è·å–æŒ‡å®šåˆ†æ•°èŒƒå›´çš„æˆå‘˜ä¸ªæ•° ZCOUNT key min max ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:6:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€é›†åˆé—´æ“ä½œ äº¤é›† ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX] # destinationï¼šè®¡ç®—ç»“æœä¿å­˜çš„é”® # numkeysï¼šå‚ä¸çš„é”®ï¼Œä¹Ÿå°±æ˜¯ key çš„æ€»æ•° # weightï¼šæ¯ä¸€ä¸ª key å‚ä¸çš„æƒé‡ï¼Œé»˜è®¤ä¸º 1 # AGGREGATEï¼šèšåˆæ“ä½œï¼Œé»˜è®¤ä¸º sum å¹¶é›† ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX] # å‚æ•°åŒ ZINTERSTORE ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:6:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 3ã€å†…éƒ¨ç¼–ç  ziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ï¼šä¸ªæ•°å°äº zset-max-ziplist-entries = 128 æ—¶ï¼Œvalue å°äº zet-max-ziplist-value = 64 ä½¿ç”¨ ziplistã€‚é…ç½®å‚æ•°åœ¨ redis.conf ä¸­ã€‚ skiplistï¼ˆè·³è·ƒè¡¨ï¼‰ï¼šä¸æ»¡è¶³ ziplist æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ skiplistã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:6:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 6ã€é”®ç®¡ç†","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:7:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€å•ä¸ªé”®ç®¡ç† é”®é‡å‘½å RENAME key newkey # å­˜åœ¨ keyï¼Œä¼šè¦†ç›– RENAMENX key newkey # ä¸å­˜åœ¨ keyï¼Œæ‰é‡å‘½åæˆåŠŸ éšæœºè¿”å›ä¸€ä¸ªé”® RANDOMKEY é”®è¿‡æœŸ EXPIRE key seconds # \u003e0: å‰©ä½™è¿‡æœŸæ—¶é—´ # -1: æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼› # -2: é”®ä¸å­˜åœ¨ Redis ä¸æ”¯æŒäºŒçº§æ•°æ®ç»“æ„ï¼ˆå“ˆå¸Œè¡¨ã€åˆ—è¡¨ï¼‰è¿‡æœŸ setex åŸå­å‘½ä»¤è®¾ç½® value å’Œ expire è¿ç§»é”® MOVE key db # è¿ç§»åˆ°å¦ä¸€ä¸ªdb, ä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºé›†ç¾¤ç¯å¢ƒåªèƒ½ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ DUMP key; RESTORE key ttl serialized-value [REPLACE] # æ“ä½œéº»çƒ¦ï¼Œä¸å»ºè®®ä½¿ç”¨ MIGRATE host port key| destination-db timeout [COPY] [REPLACE] [KEYS key] # å¯ä»¥ä½¿ç”¨ # COPY: è¿ç§»åä¸ä¼šåˆ é™¤æºé”® # REPLACE: è¿ç§»åä¼šè¦†ç›–ç›®æ ‡åº“çš„é”® ç¤ºä¾‹ï¼š è¿ç§»åˆ° localhost:6380 çš„ db0 åº“ä¸Šï¼Œtimeoutä¸º 1000msï¼Œå‘½ä»¤ä¸º MIGRATE localhost 6380 hello 0 1000ã€‚ è¿ç§»å¤šä¸ªé”® k1, k2, k3ï¼Œå‘½ä»¤ä¸º MIGRATE localhost 6380 \"\" 0 1000 KEYS k1 k2 k3ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:7:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 2ã€éå†é”® å…¨é‡éå†é”® KEYS pattern # é”®å¾ˆå¤šæ—¶ï¼Œä¼šé˜»å¡ Redis æ¸è¿›å¼éå†å»º SCAN cursor [MATCH pattern] [COUNT count] # count: æ¯æ¬¡æŸ¥è¯¢ key çš„ä¸ªæ•°ã€‚ # pattern: åŒå‘½ä»¤ scanã€‚ è¯´æ˜ï¼š ç¬¬ä¸€æ¬¡æŸ¥è¯¢è®¾ç½® cursor ä¸º 0ï¼Œç»“æœä¼šè¿”å› cursorï¼Œå¦‚æœ cursor ä¸º 0ï¼Œè¡¨ç¤ºéå†ç»“æŸï¼Œå¦åˆ™è®¾ç½® cursor ä¸ºå½“å‰è¿”å›å€¼ï¼Œå†æ¬¡æŸ¥è¯¢ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:7:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 3ã€æ•°æ®åº“ç®¡ç†æ— ï¼Œå› ä¸ºé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œåªèƒ½ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ï¼Œç”Ÿäº§ç¯å¢ƒä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/:7:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/02/"},{"categories":null,"content":" 1ã€æ…¢æŸ¥è¯¢","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€æ…¢æŸ¥è¯¢é…ç½® slowlog-log-slower-than: 10000 (é»˜è®¤å€¼ï¼Œå•ä½å¾®ç§’)ï¼Œè¶…è¿‡ 10 æ¯«ç§’çš„è¯­å¥å°±ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚ slowlog-max-len: 128ï¼ˆé»˜è®¤å€¼ï¼‰ï¼ŒRedis å†…éƒ¨ä½¿ç”¨åˆ—è¡¨æ¥ä¿å­˜æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚ lowlog-log-slower-than = 0, ä¼šè®°å½•æ‰€æœ‰å‘½ä»¤ã€‚ lowlog-log-slower-than \u003c 0, ä¸ä¼šè®°å½•ä»»ä½•å‘½ä»¤ã€‚ é…ç½®æ–¹å¼ï¼š ä¿®æ”¹é…ç½®æ–‡ä»¶ redis.confã€‚ åŠ¨æ€ä¿®æ”¹ config set lowlog-log-slower-than 20000 # è®¾ç½®æ…¢æŸ¥è¯¢æ—¶é—´ config set slowlog-max-len 1000 # è®¾ç½®æ…¢æŸ¥è¯¢æ—¥å¿—å¤§å° config rewrite # æŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶ æ…¢æŸ¥è¯¢å‘½ä»¤ SLOWLOG GET 10 # è·å–æœ€è¿‘ 10 æ¡æ—¥å¿— SLOWLOG LEN # è·å–æ—¥å¿—æ¡æ•° SLOWLOG RESET # æ…¢æŸ¥è¯¢æ—¥å¿—é‡ç½® ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€æœ€ä½³å®è·µå‚æ•° slowlog-max-lenï¼Œå»ºè®®è°ƒå¤§æ—¥å¿—åˆ—è¡¨ï¼Œæ¯”å¦‚ 1000ä»¥ä¸Šï¼›å‚æ•° slowlog-log-slower-thanï¼Œé»˜è®¤è¶…è¿‡ 10ms å°±åˆ¤æ–­ä¸ºæ…¢æŸ¥è¯¢ï¼Œå¦‚æœæ¯æ¡å‘½ä»¤æ‰§è¡Œæ—¶é—´åœ¨ 1ms ä»¥ä¸Šï¼Œåˆ™ 1s çš„å¹¶å‘é‡ä¸è¶³ 1000ï¼Œæ‰€ä»¥å¯¹äºé«˜ OPS åœºæ™¯è®¾ç½®ä¸º 1msã€‚ æ…¢æŸ¥è¯¢åªè®°å½•å‘½ä»¤æ‰§è¡Œæ—¶é—´ï¼Œä¸åŒ…æ‹¬å‘½ä»¤æ’é˜Ÿå’Œç½‘ç»œä¼ è¾“æ—¶é—´ã€‚ æ…¢æŸ¥è¯¢æ—¥å¿—åªæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå¦‚æœæŸ¥è¯¢è¾ƒå¤šï¼Œå¯èƒ½ä¼šä¸¢å¤±æ—¥å¿—æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨ SLOWLOG GET å‘½ä»¤å°†æ—¥å¿—å­˜å…¥ mysql ä¸­ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å¼€æºå·¥å…· CacheCloudã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€Redis shell","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€redis-cli å‘½ä»¤ -x å‚æ•° echo \"world\" | redis-cli -x set hello # è®¾ç½®keyä¸º helloï¼Œ valueä¸º world -c å‚æ•° é›†ç¾¤å‚æ•°ï¼Œé˜²æ­¢ moved å’Œ asked å¼‚å¸¸ã€‚ â€“rdb å‚æ•° è¯·æ±‚ Redis å®ä¾‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚ â€“bigkeys å‚æ•° é€‰å‡ºå¤§ keyï¼Œè¿™äº› key å¯èƒ½æ˜¯ç³»ç»Ÿç“¶é¢ˆã€‚ â€“eval å‚æ•° è¿è¡Œ lua è„šæœ¬ã€‚ latency å‚æ•° â€“latency: å®¢æˆ·ç«¯ä¸ä¸»æœºå»¶è¿Ÿ ã€‚ â€“latency-history: åˆ†æ—¶æ®µå±•ç¤ºå»¶è¿Ÿï¼Œç”¨ -i å‚æ•°æ¥æŒ‡å®šï¼Œé»˜è®¤ä¸º 15sã€‚ â€“latency-dist: ç»Ÿè®¡å›¾è¡¨å½¢å¼å±•ç¤ºå»¶è¿Ÿã€‚ â€“stat å‚æ•° å®æ—¶è·å– Redis é‡è¦ç»Ÿè®¡ä¿¡æ¯ï¼Œä¿¡æ¯æ¯” info å‘½ä»¤å°‘ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€redis-server å‘½ä»¤ â€“test-memory å‚æ•° redis-server --test-memory 1024 # æ£€æµ‹æ˜¯å¦å¯ä»¥ç»™ Redis åˆ†é… 1G å†…å­˜ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 3ã€redis-benchmark å‘½ä»¤ç”¨æ¥åšåŸºå‡†æ€§èƒ½æµ‹è¯•ã€‚ redis-benchmark -c 100 -n 20000 -q -r 10000 -t get,set --csv # -c å®¢æˆ·ç«¯å¹¶å‘æ•° # -n å®¢æˆ·ç«¯è¯·æ±‚æ€»æ•° # -q ä»…ä»…æ˜¾ç¤º requests per second ä¿¡æ¯ # -r éšæœºé”®çš„èŒƒå›´ï¼ˆ0-9999ï¼‰ï¼Œä¸æ˜¯ä¸ªæ•° # -t æŒ‡å®šå‘½ä»¤ # --csv ç»“æœæŒ‰ç…§ csv æ ¼å¼è¾“å‡º ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:2:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 3ã€Pipeline","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€pipeline æ¦‚å¿µredis æ‰§è¡Œä¸€æ¡å‘½ä»¤å¯ä»¥åˆ†ä¸ºå››ä¸ªè¿‡ç¨‹ï¼š å‘é€å‘½ä»¤ å‘½ä»¤æ’é˜Ÿ æ‰§è¡Œå‘½ä»¤ è¿”å›ç»“æœ å…¶ä¸­ 1. å’Œ 4. ç§°ä¸º RTT (å¾€è¿”æ—¶é—´)ã€‚ pipeline å¯ä»¥å°†ä¸€ç»„ redis å‘½ä»¤é€šè¿‡ä¸€æ¬¡ RTT å‘ç»™ Redisï¼Œå†æŒ‰ç…§æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ redis-cli è„šæœ¬çš„ â€“pipe é€‰é¡¹å°±æ˜¯ä½¿ç”¨ pipeline æœºåˆ¶ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:3:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€æ€§èƒ½æµ‹è¯•pipeline æ‰§è¡Œé€Ÿåº¦ä¸€èˆ¬æ¯”é€æ¡æ‰§è¡Œå¿«ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç½‘è·¯å»¶æ—¶è¶Šå¤§ï¼Œæ•ˆæœè¶Šæ˜æ˜¾ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:3:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 3ã€åŸç”Ÿæ‰¹é‡å’Œ pipeline åŸç”Ÿæ‰¹é‡å‘½ä»¤æ˜¯åŸå­çš„ï¼Œpipeline ä¸æ˜¯åŸå­çš„ï¼ˆä¸­é—´å¯ä»¥æ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼‰ã€‚ åŸç”Ÿæ‰¹é‡å‘½ä»¤æ˜¯ä¸€ä¸ªå‘½ä»¤å¯¹åº”å¤šä¸ª key, pipeline æ”¯æŒå¤šä¸ªå‘½ä»¤ã€‚ åŸç”Ÿæ‰¹é›¶å‘½ä»¤æ˜¯ Redis æœåŠ¡ç«¯å®ç°çš„ï¼Œpipeline æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±åŒå®ç°çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:3:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 4ã€æœ€ä½³å®è·µ pipeline å°è£…çš„æ•°æ®ä¸èƒ½è¿‡å¤šï¼Œå³å¤§æ•°æ®å¯ä»¥æ‹†åˆ†ä¸ºæ‰¹é‡çš„å° pipeline å‘½ä»¤ã€‚ pipeline åªèƒ½æ“ä½œä¸€ä¸ª Redis å®ä¾‹ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:3:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 4ã€äº‹åŠ¡ä¸Lua ä¸ºäº†ä¿è¯å¤šä¸ªå‘½ä»¤ç»„åˆçš„åŸå­æ€§ï¼ŒRedis æä¾›äº†ç®€å•äº‹åŠ¡åŠŸèƒ½å’Œ lua è„šæœ¬ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€äº‹åŠ¡ MULTI # å¼€å¯äº‹åŠ¡ set a 1 # æ‰§è¡Œå‘½ä»¤ï¼Œå®é™…ä¸ŠæŠŠå‘½ä»¤æ”¾åˆ°é˜Ÿåˆ—ä¸­ set b 1 # æ‰§è¡Œå‘½ä»¤ï¼Œå®é™…ä¸ŠæŠŠå‘½ä»¤æ”¾åˆ°é˜Ÿåˆ—ä¸­ EXEC # çœŸæ­£çš„æ‰§è¡Œå‘½ä»¤ å‘½ä»¤é”™è¯¯ï¼Œä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œæ¯”å¦‚ set a 1 å†™æˆäº† sett a 1ã€‚ è¿è¡Œæ—¶é”™è¯¯ï¼Œredis ä¸æ”¯æŒå›æ»šï¼Œæ¯”å¦‚ sadd a 1 å†™æˆäº† zadd a 1 bï¼Œå‡è®¾ a è¿™ä¸ª key å·²ç»å­˜åœ¨ï¼Œå°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚ äº‹åŠ¡ç®€å•ä¸»è¦åŸå› å°±æ˜¯ï¼Œredis ä¸æ”¯æŒå›æ»šã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:4:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€Luaåœ¨ Redis ä¸­ä½¿ç”¨ Luaï¼Œæœ‰ä¸¤ç§æ–¹å¼ eval å’Œ evalshaã€‚ eval EVAL script numkeys key [key ...] arg [arg ...] eval 'return \"hello \" .. KEYS[1] .. ARGV[1]' 1 world redis # ä¾‹å­ # è¾“å‡º \"hello worldredis\" å¦‚æœ Lua è„šæœ¬è¾ƒé•¿ï¼Œå¯ä»¥ä½¿ç”¨ redis-cli â€“eval é€‰é¡¹æ¥æ‰§è¡Œã€‚ evalsha ä½¿ç”¨ eval å‘½ä»¤ï¼Œæ¯æ¬¡éƒ½éœ€è¦å°†è„šæœ¬å‘é€åˆ°æœåŠ¡ç«¯ï¼Œä½¿ç”¨ evalsha å‘½ä»¤å°±é¿å…äº†å¼€é”€ã€‚ redis-cli script load hello.lua # åŠ è½½ lua è„šæœ¬åˆ°æœåŠ¡ç«¯ï¼Œä¼šè¿”å› sha1 å€¼ã€‚ EVALSHA sha1 numkeys key [key ...] arg [arg ...] # æ‰§è¡Œ lua è„šæœ¬ï¼Œå‚æ•° sha1 å°±æ˜¯è¿”å›çš„ sha1 å€¼ï¼Œå…¶ä»–å‚æ•°åŒ eval å‘½ä»¤ã€‚ lua ä¸­ä½¿ç”¨ redis API redis.call(\"set\", \"a\" , 1) redis.call(\"get\", \"a\" ) ä¹Ÿå¯ä»¥ä½¿ç”¨ redis.pcall å‘½ä»¤ï¼Œä¸¤è€…å·®åˆ«åœ¨äº pcall å‘½ä»¤ä¼šå¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œï¼Œcall é‡åˆ°é”™è¯¯åœæ­¢ã€‚ lua è„šæœ¬æ‰§è¡Œæ˜¯åŸå­æ€§çš„ï¼Œä¸­é—´ä¸ä¼šæ’å…¥åˆ«çš„å‘½ä»¤ã€‚ ç®¡ç† lua è„šæœ¬å‘½ä»¤ SCRIPT LOAD [script] # åŠ è½½ lua è„šæœ¬ï¼Œè¿”å› sha1 å€¼ SCRIPT EXISTS sha1 [sha1] # æ˜¯å¦å­˜åœ¨ sha1 çš„è„šæœ¬ SCRIPT FLUSH # æ¸…ç©º lua è„šæœ¬ SCRIPT KILL # æ€æ‰ lua è„šæœ¬ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:4:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 5ã€Bitmaps","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€æ•°æ®ç»“æ„æ¨¡å‹Bitmaps ä¸æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šå®ƒæ˜¯å­—ç¬¦ä¸²ï¼Œä½†å®ƒå¯ä»¥å¯¹å­—ç¬¦ä¸²çš„ä½è¿›è¡Œæ“ä½œï¼Œä½ å¯ä»¥æƒ³è±¡ä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œæ¯ä¸ªå•å…ƒåªèƒ½å­˜å‚¨ 0 å’Œ1ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:5:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 2ã€å‘½ä»¤ è®¾ç½®å€¼ SETBIT key offset value # offset ä» 0 å¼€å§‹ è·å–å€¼ GETBIT key offset # ç»“æœåªæœ‰ 0 æˆ–è€… 1 BITCOUNT key [start end] # å¯¹[start, end]èŒƒå›´è·å–å€¼ä¸º 1 çš„ä¸ªæ•° Bitmaps é—´çš„è¿ç®— BITOP operation destkey key [key ...] # operation å¯ä»¥æ˜¯ and(äº¤é›†)ã€or(å¹¶é›†)ã€not(é)ã€xor(å¼‚æˆ–) è·å–ç¬¬ä¸€ä¸ªä¸º bit çš„ offset å€¼ BITPOS key bit [start] [end] # [start,end]èŒƒå›´ä¸­ç¬¬ä¸€ä¸ªå‡ºç° bit çš„ offset ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:5:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 3ã€åˆ†æåˆ©ç”¨ Bitmaps æ¥ç»Ÿè®¡ç½‘ç«™è®¿é—®ç”¨æˆ·ï¼š SETBIT users:2020-03-22 1 1 # 2020-03-22 è¿™ä¸€å¤© 1 å·è®¿é—®äº†ã€‚ SETBIT users:2020-03-23 2 1 # 2020-03-23 è¿™ä¸€å¤© 2 å·è®¿é—®äº†ã€‚ BITCOUNT users:2020-03-23 # 2020-03-23 è¿™ä¸€å¤© è®¿é—®ç”¨æˆ·é‡ BITOP and users:2020-03-22_23 users:2020-03-23 users:2020-03-22 # ä¸¤å¤©éƒ½è®¿é—®çš„ç”¨æˆ·é‡ set å’Œ bitmaps å¯¹æ¯”ï¼š æ•°æ®ç±»å‹ æ¯ä¸ªç”¨æˆ· id å ç”¨ç©ºé—´ éœ€è¦å­˜å‚¨ç”¨æˆ·é‡ å…¨éƒ¨å†…å­˜é‡ set 64 ä½ 5 åƒä¸‡ 64 ä½ * 5 åƒä¸‡ = 400 MB bitmaps 1 ä½ 1 äº¿ 1 ä½ * 1 äº¿ = 12.5 MB ä»è¡¨æ ¼å¯ä»¥çœ‹å‡º bitmaps èŠ‚çœå†…å­˜ã€‚ ä½†å¦‚æœæ¯å¤©çš„æ´»è·ƒç”¨æˆ·å¾ˆå°‘ï¼Œset å¯èƒ½æ¯” bitmaps å¥½ï¼Œå› ä¸º set éœ€è¦å†…å­˜ 64 ä½ * 10 ä¸‡ = 800 KBï¼Œè€Œ bitmap è¿˜æ˜¯éœ€è¦ 12.5 MB å†…å­˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:5:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 6ã€HyperLogLogHyperLoglog ä¸æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ä¸€ç§åŸºæ•°ç®—æ³•ï¼Œå¯ä»¥åˆ©ç”¨æå°çš„å†…å­˜ç©ºé—´å®Œæˆç‹¬ç«‹æ€»æ•°ç»Ÿè®¡ï¼Œæ•°æ®é›†å¯ä»¥ IDã€Emailã€IPã€‚ å‘½ä»¤ PFADD key element [element ...] # æ·»åŠ å…ƒç´  PFCOUNT key [key ...] # è®¡æ•° PFMERGE destkey sourcekey [sourcekey ...] # merge æ³¨æ„ï¼š åªæ˜¯è®¡ç®—ç‹¬ç«‹æ€»æ•°ï¼Œä¸éœ€è¦è·å–å•æ¡æ•°æ® HyperLogLog æœ‰è¯¯å·® ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 7ã€å‘å¸ƒè®¢é˜…Redis æä¾›å‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯æœºåˆ¶ã€‚ å‘½ä»¤ PUBLISH channel message # å‘æŒ‡å®šçš„ channel å‘å¸ƒæ¶ˆæ¯ SUBSCRIBE channel [channel ...] # å‘æŒ‡å®šçš„ channel è®¢é˜…æ¶ˆæ¯ PSUBSCRIBE pattern [pattern ...] # æ¨¡å¼è®¢é˜…æ¶ˆæ¯ UNSUBSCRIBE [channel [channel ...]] # å–æ¶ˆè®¢é˜… PUNSUBSCRIBE [pattern [pattern ...]] # æ¨¡å¼å–æ¶ˆè®¢é˜… PUBSUB subcommand [argument [argument ...]] # æŸ¥çœ‹è®¢é˜… # PUBSUB channels [pattern] # é¢‘é“ # PUBSUB numsub [channel ...] # channel è®¢é˜…æ•° # PUBSUB numpat # æ¨¡å¼è®¢é˜…æ•° æ³¨æ„ï¼š Redis æä¾›çš„æ¶ˆæ¯æœºåˆ¶ï¼Œæ— æ³•å®ç°æ¶ˆæ¯å †ç§¯ã€å›æº¯ æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜ç‚¹ï¼šå¼‚æ­¥ã€è§£è€¦ã€å‰Šå³°ï¼Œç¼ºç‚¹ï¼šå¤æ‚åº¦æé«˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:7:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 8ã€GEORedis æä¾›äº† GEOï¼ˆåœ°å€ä½ç½®ï¼‰åŠŸèƒ½ï¼Œæ”¯æŒå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ã€‚ æ·»åŠ ä½ç½®ä¿¡æ¯ GEOADD key longitude latitude member [longitude latitude member ...] è·å–ä½ç½®ä¿¡æ¯ GEOPOS key member [member ...] è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦» GEODIST key member1 member2 [unit] # unit: m(ç±³)ï¼›ï¼ˆkmï¼‰å…¬é‡Œï¼›ï¼ˆmiï¼‰è‹±é‡Œï¼›ï¼ˆflï¼‰å°º è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆ GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key] # æ ¹æ®å…·ä½“çš„ç»çº¬åº¦æ¥è·å– GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] [STORE key] [STOREDIST key] # æ ¹æ®æŸä¸€ä¸ªæˆå‘˜æ¥è·å– è·å– geohash GEOHASH key member [member ...] # Redis å°†äºŒç»´çš„ç»çº¬åº¦è½¬åŒ–ä¸ºä¸€ç»´å­—ç¬¦ä¸² åˆ é™¤åœ°ç†ä½ç½® ZREM key member [member ...] # Redis æ²¡æœ‰æä¾›ä¸“é—¨çš„åˆ é™¤å‘½ä»¤ï¼Œå¯ä»¥å€ŸåŠ© ZREM å‘½ä»¤æ¥åˆ é™¤ # GEO çš„æ•°æ®ç±»å‹ä¸º zset ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/:8:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/03/"},{"categories":null,"content":" 1ã€å®¢æˆ·ç«¯é€šä¿¡åè®®Redis åˆ¶å®šäº† RESPï¼ˆredisåºåˆ—åŒ–åè®®ï¼‰å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ­£å¸¸äº¤äº’ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 1ã€å‘é€å‘½ä»¤æ ¼å¼CRLF ä¸º â€˜\\r\\nâ€™ *\u003cå‚æ•°æ•°é‡\u003e CRLF $\u003cå‚æ•° 1 çš„å­—èŠ‚æ•°é‡\u003e CRLF \u003cå‚æ•° 1\u003e CRLF ... $\u003cå‚æ•° N çš„å­—èŠ‚æ•°é‡\u003e CRLF \u003cå‚æ•° N\u003e CRLF ä»¥ set hello world å‘½ä»¤ä¸ºä¾‹ï¼š *3 $3 set $5 hello $5 world ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 2ã€è¿”å›ç»“æœæ ¼å¼ çŠ¶æ€å›å¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º â€œ+\"ã€‚å¦‚ set é”™è¯¯å›å¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º â€œ-\"ã€‚å¦‚ é”™è¯¯å‘½ä»¤ æ•´æ•°å›å¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º â€œ:\"ã€‚å¦‚ incr å­—ç¬¦ä¸²å›å¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º â€œ$\"ã€‚å¦‚ get å¤šæ¡å­—ç¬¦ä¸²å›å¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º â€œ*\"ã€‚å¦‚ mget ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 2ã€Java å®¢æˆ·ç«¯ Jedisjedis ç”¨çš„å¾ˆå°‘äº†ï¼Œè¯·å‚è€ƒ lettuceã€redisson ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 3ã€Python å®¢æˆ·ç«¯ redis-pyç•¥ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 4ã€å®¢æˆ·ç«¯ç®¡ç†","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 1ã€å®¢æˆ·ç«¯ API 1ã€client listä¸ Redis æœåŠ¡ç«¯ç›¸è¿çš„æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥ä¿¡æ¯ è¯´æ˜ï¼š id: å®¢æˆ·ç«¯è¿æ¥å”¯ä¸€æ ‡è¯†ï¼Œé€’å¢ï¼Œä½† Redis é‡å¯åé‡ç½®ä¸º 0ã€‚ addr: å®¢æˆ·ç«¯ IP å’Œ PORTã€‚ fd: socket æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸ lsof å‘½ä»¤ä¸­ fd æ˜¯åŒä¸€ä¸ªã€‚ name: å®¢æˆ·ç«¯åå­—ï¼Œä¸ client setName å’Œ client getName æœ‰å…³ Redis ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…äº†è¾“å…¥ç¼“å†²åŒºï¼Œå®ƒçš„ä½œç”¨å°†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¸´æ—¶ä¿å­˜ï¼ŒRedis ä¼šä»è¾“å…¥ç¼“å†²åŒºä¸­æ‹‰å–å‘½ä»¤å¹¶æ‰§è¡Œã€‚ä¸å— maxmemory å‚æ•°å½±å“ã€‚ qbuf: å®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºæ€»å®¹é‡ qbuf-free: å®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºå‰©ä½™å®¹é‡ è¾“å…¥ç¼“å†²åŒºè¿‡å¤§çš„åŸå› ï¼š Redis å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šè¾“å…¥ç¼“å†²åŒºçš„è¾“å…¥é€Ÿåº¦ï¼Œå¯èƒ½å­˜åœ¨ bigKeyã€‚ Redis å‘ç”Ÿäº†é˜»å¡ã€‚ Redis ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…äº†è¾“å‡ºç¼“å†²åŒºï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¿å­˜å‘½ä»¤æ‰§è¡Œçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ client-output-buffer-limit \u003cclass\u003e \u003chard limit\u003e \u003csoft limit\u003e \u003csoft seconds\u003e æ¥é…ç½®ã€‚ä¸å— maxmemory å‚æ•°å½±å“ã€‚ obl: å›ºå®šè¾“å‡ºç¼“å†²åŒºå¤§å° oll: åŠ¨æ€è¾“å‡ºç¼“å†²åŒºå¤§å°ï¼Œå½“å›ºå®šç¼“å†²åŒºæ»¡äº†ï¼Œå°±ä¼šä½¿ç”¨åŠ¨æ€ç¼“å†²åŒº omem: è¾“å‡ºç¼“å†²åŒºæ€»è®¡çš„å­—èŠ‚æ•° å…¶ä»–ä¿¡æ¯ï¼š age: å·²è¿æ¥çš„æ—¶é—´ idle: æœ€è¿‘ä¸€æ¬¡ç©ºé—²æ—¶é—´ flag: S è¡¨ç¤º slave å®¢æˆ·ç«¯ï¼ŒN è¡¨ç¤ºæ™®é€šå®¢æˆ·ç«¯ï¼ŒO è¡¨ç¤ºæ‰§è¡Œ monitor å‘½ä»¤çš„å®¢æˆ·ç«¯ db: æ•°æ®åº“ç´¢å¼•ä¸‹æ ‡ sub/psub: å½“å‰å®¢æˆ·ç«¯è®¢é˜…çš„é¢‘é“ multi: å½“å‰äº‹åŠ¡å·²æ‰§è¡Œå‘½ä»¤ä¸ªæ•° å®¢æˆ·ç«¯é™åˆ¶ maxclients (é»˜è®¤ä¸º 1000) å’Œ timeoutï¼Œé€šè¿‡ config set maxclients 10000 å‘½ä»¤å’Œ config set timeout 30 å‘½ä»¤æ¥è®¾ç½®ã€‚ ç›‘æ§ç¼“å†²åŒºæ–¹æ³•ï¼š å®šæœŸæ‰§è¡Œ client list å‘½ä»¤ï¼Œæ”¶é›† qbuf å’Œ qbuf-freeã€‚ æ‰§è¡Œ info clients å‘½ä»¤ï¼Œæ‰¾åˆ°æœ€å¤§çš„è¾“å…¥ç¼“å†²åŒº client_recent_max_input_buffer 2ã€client getName / setNameç»™å½“å‰å®¢æˆ·ç«¯è®¾ç½®åå­— 3ã€client killæ€æ‰æŒ‡å®š ip å’Œ port çš„å®¢æˆ·ç«¯ client kill ip:port 4ã€client pauseé˜»å¡å®¢æˆ·ç«¯ timeout æ¯«ç§’ client pause timeout(æ¯«ç§’) 5ã€monitorç›‘æ§ Redis æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¦‚æœå¹¶å‘é‡è¿‡å¤§ï¼Œä¼šé€ æˆè¾“å‡ºç¼“å†²åŒºæš´æ¶¨ã€‚ monitor ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:4:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 2ã€å®¢æˆ·ç«¯ç›¸å…³é…ç½®å®¢æˆ·ç«¯çš„é…ç½®å¦‚ä¸‹ï¼š timeoutï¼š ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ tcp-keepaliveï¼š æ£€æŸ¥æ­»çš„è¿æ¥ tcp-backlog: TCP è¿æ¥è¿‡åï¼Œä¼šå°†æ¥å—çš„è¿æ¥æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œtcp-backlog å°±æ˜¯è¿™ä¸ªé˜Ÿåˆ—çš„å¤§å°ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:4:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 3ã€å®¢æˆ·ç«¯ç»Ÿè®¡ä¿¡æ¯ 1ã€info clientsè¿è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š 2ã€info statsè¿è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯ç›¸å…³çš„æŒ‡æ ‡ total_connections_receivedï¼š æ€»å…±æ¥å—çš„è¿æ¥æ•° rejected_connectionsï¼š æ‹’ç»çš„è¿æ¥æ•° ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:4:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 5ã€å®¢æˆ·ç«¯å¸¸è§å¼‚å¸¸","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 1ã€æ— æ³•ä»è¿æ¥æ± ä¸­è·å–è¿æ¥å¯èƒ½çš„åŸå› ï¼š è¿æ¥æ± è®¾ç½®è¿‡å°ã€‚ æ²¡æœ‰æ­£ç¡®ä½¿ç”¨è¿æ¥æ± ï¼Œç”¨è¿‡åæ²¡æœ‰é‡Šæ”¾ã€‚ å…·ä½“è¿˜æ˜¯è¦çœ‹é€‰ç”¨çš„å®¢æˆ·ç«¯ï¼Œæ²¡æœ‰è¿æ¥äº†æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿï¼ˆæ˜¯ç­‰å¾…è¿˜æ˜¯ç›´æ¥æ‹’æ¥æŠ›å‡ºå¼‚å¸¸ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 2ã€å®¢æˆ·ç«¯è¯»å†™è¶…æ—¶å¯èƒ½çš„åŸå› ï¼š è¯»å†™è¶…æ—¶æ—¶é—´è®¾ç½®çŸ­ã€‚ å‘½ä»¤æœ¬èº«å°±å¾ˆæ…¢ã€‚ ç½‘ç»œä¸æ­£å¸¸ã€‚ Redis é˜»å¡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 3ã€å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶å¯èƒ½çš„åŸå› ï¼š è¿æ¥è¶…æ—¶æ—¶é—´è®¾ç½®çŸ­ã€‚ ç½‘ç»œä¸æ­£å¸¸ã€‚ Redis å‘ç”Ÿé˜»å¡ï¼Œå¯¼è‡´ tcp-backlog å·²æ»¡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 4ã€å®¢æˆ·ç«¯ç¼“å†²åŒºå¼‚å¸¸å¯èƒ½çš„åŸå› ï¼š è¾“å‡ºç¼“å†²åŒºæ»¡ï¼Œæ¯”å¦‚ç”¨ get å‘½ä»¤æ¥è·å–ä¸€ä¸ªbigKeyã€‚ é•¿æ—¶é—´ç©ºé—²è¿æ¥è¢«æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€ã€‚ ä¸æ­£å¸¸çš„å¹¶å‘è¯»å†™ï¼ŒRedis å¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘æ“ä½œã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 5ã€Lua è„šæœ¬æ‰§è¡Œå¯èƒ½çš„åŸå› ï¼š lua è„šæœ¬æ‰§è¡Œæ—¶é—´è¶…è¿‡å‚æ•° lua-time-limitã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 6ã€å®¢æˆ·ç«¯è¿æ¥æ•°è¿‡å¤§å®¢æˆ·ç«¯è¿æ¥æ•°è¶…è¿‡ maxclientsï¼Œæ–°çš„è¿æ¥å°±ä¼šè¢«æ‹’ç»ã€‚ ä»ä¸¤ä¸ªæ–¹é¢æ¥è§£å†³ï¼š å®¢æˆ·ç«¯ï¼šé€šè¿‡ä¸‹çº¿éƒ¨åˆ†åº”ç”¨èŠ‚ç‚¹ï¼Œä½¿ Redis çš„è¿æ¥æ•°é™ä¸‹æ¥ï¼Œä»è€Œç»§ç»­æ‰¾å…¶æ ¹æœ¬åŸå› ï¼Œæˆ–è€…è°ƒæ•´ maxclients å‚æ•°ã€‚ æœåŠ¡ç«¯ï¼šå¦‚æœ Redis æ˜¯é«˜å¯ç”¨æ¨¡å¼ï¼Œå¯ä»¥æŠŠå½“å‰çš„èŠ‚ç‚¹æ•…éšœè½¬ç§»ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:5:6","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 6ã€å®¢æˆ·ç«¯æ¡ˆä¾‹åˆ†æ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 1ã€Redis å†…å­˜é™¡å¢ç°è±¡ï¼š æœåŠ¡ç«¯ï¼šRedis ä¸»èŠ‚ç‚¹å†…å­˜é™¡å¢ï¼Œä»èŠ‚ç‚¹å†…å­˜æ— å˜åŒ–ã€‚ å®¢æˆ·ç«¯ï¼šäº§ç”Ÿ OOM å¼‚å¸¸ã€‚ å¯èƒ½çš„åŸå› ï¼š ç¡®å®æœ‰å¤§é‡çš„å†™å…¥ï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤ dbsize æ¥è·å–ä¸»ä»èŠ‚ç‚¹çš„é”®ä¸ªæ•°ã€‚ æ’æŸ¥æ˜¯å¦ç”±å®¢æˆ·ç«¯ç¼“å†²åŒºåº”å¼•å‘çš„é—®é¢˜ï¼Œé€šè¿‡æ‰§è¡Œå‘½ä»¤ info clientsæ¥æŸ¥çœ‹ã€‚ å¤„ç†æ–¹æ³•ï¼š é€šè¿‡å‘½ä»¤ redis-cli info list | grep -v \"omemo=0\"ï¼Œ æ‰¾åˆ°éé›¶çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œç„¶å kill æ‰ã€‚ å¯èƒ½å°±æ˜¯è¿è¡Œå‘½ä»¤ monitor é€ æˆçš„ï¼Œä¸€èˆ¬éƒ½å»ºè®®åœ¨ç”Ÿå‚ç¯å¢ƒä¸­ç¦ç”¨ monitorã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:6:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 2ã€å®¢æˆ·ç«¯å‘¨æœŸæ€§è¶…æ—¶ç°è±¡ï¼š å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯å‘¨æœŸæ€§è¶…æ—¶ æœåŠ¡ç«¯ï¼šæ— æ˜æ˜¾ç°è±¡ï¼Œåªæ˜¯ä¸€äº›æ…¢æŸ¥è¯¢ã€‚ å¯èƒ½çš„åŸå› ï¼š ç½‘ç»œä¸æ­£å¸¸ã€‚ æ‰§è¡Œå‘½ä»¤é€ æˆæ…¢æŸ¥è¯¢å¯¼è‡´çš„å‘¨æœŸæ€§è¶…æ—¶ã€‚ å¤„ç†æ–¹æ³•ï¼š è¿ç»´å±‚é¢ï¼Œç›‘æ§æ…¢æŸ¥è¯¢ï¼Œä¸€æ—¦è¶…å¤šé˜ˆå€¼ï¼Œå°±å‘å‡ºæŠ¥è­¦ã€‚ é¿å…ä¸æ­£ç¡®ä½¿ç”¨å‘½ä»¤ï¼Œå¦‚ KEYS *ã€HGETALL key ç­‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/:6:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/04/"},{"categories":null,"content":" 1ã€RDB","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 1ã€è§¦å‘æœºåˆ¶æ‰‹åŠ¨è§¦å‘ï¼Œåˆ†åˆ«æœ‰ save å’Œ bgsave ä¸¤ä¸ªå‘½ä»¤ã€‚ saveï¼š ä¼šé˜»å¡å½“å‰ Redis æœåŠ¡å™¨ï¼Œç›´åˆ° RDB è¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚ bgsaveï¼š Redis è¿›ç¨‹ä¼š fork å‡ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹è¿›è¡Œ RDB æŒä¹…åŒ–ï¼Œé˜»å¡åªä¼šå‘ç”Ÿåœ¨ fork é˜¶æ®µã€‚ è‡ªåŠ¨è§¦å‘çš„åœºæ™¯ï¼š save m n é…ç½®ï¼Œè¡¨ç¤ºåœ¨ m ç§’ä¸­å­˜åœ¨ n æ¬¡æ•°æ®æ”¹å˜ï¼Œæ‰ä¼šè§¦å‘ bgsaveã€‚ ä»èŠ‚ç‚¹å…¨é‡å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šæ‰§è¡Œ bgsave ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œå‘é€å­èŠ‚ç‚¹ã€‚ é»˜è®¤å…³é—­æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ AOFï¼Œä¹Ÿä¼šæ‰§è¡Œ bgsaveã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 2ã€è§¦å‘æµç¨‹bgsave å‘½ä»¤çš„è¿è¡Œæµç¨‹å¦‚ä¸‹å›¾ï¼š è¯´æ˜ï¼› æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œ åˆ¤æ–­æ˜¯å¦æœ‰ AOF/RDB è¿›ç¨‹ã€‚ æ‰§è¡Œ info stats å‘½ä»¤ï¼Œé€‰é¡¹ latest_fork_usec è¡¨ç¤ºæœ€åä¸€æ¬¡ fork ä½¿ç”¨çš„ç§’æ•°ã€‚ bgsave å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œä¼šå‡ºç° Background saving started æç¤ºã€‚ å­è¿›ç¨‹åˆ›å»º RDB æ–‡ä»¶æˆåŠŸåï¼Œå¯¹åŸæœ‰çš„æ–‡ä»¶è¿›è¡ŒåŸå­æ›¿æ¢, æ‰§è¡Œ lastsave å‘½ä»¤è·å–æœ€åä¸€æ¬¡ç”Ÿæˆ RDB æ–‡ä»¶çš„æ—¶é—´ï¼Œå¯¹åº” info Persistence å‘½ä»¤ä¸­çš„é€‰é¡¹ rdb_last_save_timeã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 3ã€RDB æ–‡ä»¶çš„å¤„ç† RDB æ–‡ä»¶é€šè¿‡é…ç½®æ–‡ä»¶å‚æ•° dbfilename å’Œ diræ¥é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤ config set dir {dir} å’Œ config set dbfilename {dbfilename} æ¥åŠ¨æ€é…ç½®ã€‚ RDB æ–‡ä»¶é»˜è®¤é‡‡ç”¨ LZF å‹ç¼©ï¼Œé€šå¸¸å»ºè®®å¼€å¯ï¼Œå› ä¸ºä¸»ä»å¤åˆ¶æ—¶ï¼Œéœ€è¦å‘é€ RDB æ–‡ä»¶åˆ°ä»èŠ‚ç‚¹ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå¸¦å®½ã€‚ RDB é»˜è®¤ä¹Ÿå¼€å¯æ ¡éªŒï¼Œå¯ä»¥é€šè¿‡è„šæœ¬ redis-check-rdb æ¥æ ¡éªŒç”Ÿæˆç›¸åº”çš„é”™è¯¯æŠ¥å‘Šã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 4ã€RDB çš„ä¼˜ç¼ºç‚¹ä¼˜ç‚¹ï¼š RDB éå¸¸é€‚åˆå¤‡ä»½ã€å…¨é‡å¤åˆ¶ç­‰åœºæ™¯ï¼Œæ¯”å¦‚æ¯ 6 å°æ—¶å®šæ—¶æ‰§è¡Œ bgsaveï¼Œå¯ç”¨äºç¾éš¾æ¢å¤ã€‚ RDB çš„æ¢å¤æ•°æ®è¿œè¿œå¿«äº AOF æ–¹å¼ã€‚ ç¼ºç‚¹ï¼š RDB æ— æ³•åšåˆ°ç§’çº§æŒä¹…åŒ–ï¼Œfork åˆ›å»ºå­è¿›ç¨‹ä¹Ÿå±äºé‡é‡çº§æ“ä½œã€‚ RDB ç”¨ç‰¹å®šçš„äºŒè¿›åˆ¶æ ¼å¼ä¿å­˜ï¼Œå¯èƒ½æœ‰ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:1:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 2ã€AOF ä»¥ç‹¬ç«‹çš„æ—¥å¿—è®°å½•æ¯æ¬¡å†™å‘½ä»¤ï¼Œé‡å¯æ—¶å†é‡æ–°æ‰§è¡Œ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤è¾¾åˆ°æ¢å¤æ•°æ®çš„ç›®çš„ã€‚ AOF è§£å†³äº†æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 1ã€AOF å·¥ä½œæµç¨‹ å¼€å¯ AOF éœ€è¦è®¾ç½®å‚æ•° appendonly yesã€‚ é€šè¿‡å‚æ•° appendfilename æ¥è®¾ç½®æ–‡ä»¶åã€‚ å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾ï¼š è¯´æ˜ï¼š æ‰€æœ‰çš„å†™å…¥å‘½ä»¤ä¼šè¿½åŠ åˆ° aof_buf (ç¼“å†²åŒº)ä¸­ã€‚ AOF ç¼“å†²åŒºä¼šæ ¹æ®åŒæ­¥ç­–ç•¥ï¼ˆå‚æ•°é»˜è®¤è®¾ç½® appendfsync everysecï¼‰æ¥åšåŒæ­¥æ“ä½œã€‚ ä¼šå®šæœŸå¯¹ AOF æ–‡ä»¶è¿›è¡Œ rewriteï¼Œè¾¾åˆ°å‹ç¼©çš„ç›®çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰äº› key è¿‡æœŸäº†ã€‚ æœºå™¨é‡å¯æ—¶ï¼Œå¦‚æœå¼€å¯äº† AOFï¼Œåˆ™ä½¿ç”¨ AOF åŠ è½½æ•°æ®ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 2ã€å‘½ä»¤å†™å…¥ AOF é‡‡ç”¨æ–‡æœ¬åè®®æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯è¯´ AOF æ–‡ä»¶ä¸­å­˜å‚¨å°±æ˜¯å†™å…¥çš„å‘½ä»¤ï¼Œè¿™æ ·å…·æœ‰é˜…è¯»æ€§ã€ä¾¿äºä¿®æ”¹ã€‚ AOF æŠŠå‘½ä»¤å…ˆå†™å…¥ aof_buf ä¸­ï¼Œæ ¹æ®ä¸åŒçš„åŒæ­¥ç­–ç•¥å¯ä»¥åœ¨æ€§èƒ½å’Œå®‰å…¨ä¸Šåšå‡ºå¹³è¡¡ï¼Œæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå°±è®¾ç½®ä¸º everysecã€‚ ä¸‰ç§ç­–ç•¥ï¼› no: donâ€™t fsync, just let the OS flush the data when it wants. Faster. always: fsync after every write to the append only log. Slow, Safest. everysec: fsync only one time every second. Compromise. ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 3ã€é‡å†™æœºåˆ¶AOF æ–‡ä»¶å¯ä»¥å˜å°çš„åŸå› ï¼š è¶…æ—¶çš„æ•°æ®ï¼Œå¯ä»¥ä¸ç”¨å†å†™å…¥æ–‡ä»¶ä¸­ã€‚ key è¿‡æœŸäº†ï¼Œå¯èƒ½å«æœ‰æ— æ•ˆå‘½ä»¤ï¼Œå¦‚ del key1ã€‚ å¤šä¸ªå‘½ä»¤å¯ä»¥åˆå¹¶æˆä¸€ä¸ªï¼Œå¦‚ lpush list a å’Œ lpush list b å¯ä»¥åˆå¹¶ä¸º lpush list a bã€‚ è§¦å‘ AOF é‡å†™æ–¹å¼ï¼š æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ bgrewriteaof è‡ªåŠ¨è§¦å‘ï¼Œæ ¹æ®é…ç½®å‚æ•° auto-aof-rewrite-percentage 100 å’Œ auto-aof-rewrite-min-size 64mbã€‚ å‚æ•°è¯´æ˜ï¼š This is how it works: Redis remembers the size of the AOF file after the latest rewrite (if no rewrite has happened since the restart, the size of the AOF at startup is used). This base size is compared to the current size. If the current size is bigger than the specified percentage, the rewrite is triggered. Also you need to specify a minimal size for the AOF file to be rewritten, this is useful to avoid rewriting the AOF file even if the percentage increase is reached but it is still pretty small è‡ªåŠ¨è§¦å‘æ—¶æœº: aof_current_size \u003e auto-aof-rewrite-min-size \u0026\u0026 (aof_current_size - aof_base_size) / aof_base_size \u003e auto-aof-rewrite-percentage AOF é‡å†™æµç¨‹å›¾å¦‚ä¸‹ï¼š è¯´æ˜ï¼š æ‰§è¡Œ AOF é‡å†™è¯·æ±‚ï¼Œå¦‚æœæœ‰å­è¿›ç¨‹åœ¨æ‰§è¡Œ bgsave åˆ™ç­‰å¾…å®Œæˆä¹‹åå†æ“ä½œã€‚ fork å­è¿›ç¨‹è¿›è¡Œé‡å†™ï¼Œçˆ¶è¿›ç¨‹æ¥å—è¯·æ±‚ï¼Œä¿®æ”¹å‘½ä»¤å†™å…¥ aof_buf ä¸­æ ¹æ®ç­–ç•¥åŒæ­¥åˆ°ç£ç›˜ã€‚ fork æ“ä½œè¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œæ‰€ä»¥å­è¿›ç¨‹åªèƒ½å…±äº«æ“ä½œ fork æ—¶çš„å†…å­˜ï¼Œè¿™æ—¶çˆ¶è¿›ç¨‹å¯èƒ½è¿˜åœ¨å“åº”è¯·æ±‚ï¼Œæ‰€ä»¥æŠŠé‡å†™åçš„æ–°å‘½ä»¤æ”¾å…¥ aof_rewrite_buf ç¼“å†²åŒºä¸­ã€‚ æŠŠ aof_rewrite_buf ä¸­æ•°æ®å†™å…¥æ–°çš„ AOF æ–‡ä»¶ä¸­ï¼Œæ ¹æ®å¼€å¯å‚æ•° aof-rewrite-incremental-fsync yesï¼Œæ¯ 32MB åŒæ­¥åˆ°ç£ç›˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 4ã€é‡å¯åŠ è½½é‡å¯åŠ è½½å›¾ï¼š ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 5ã€æ–‡ä»¶æ ¡éªŒåŠ è½½æŸåçš„ AOF æ–‡ä»¶ä¼šæ‹’ç»å¯åŠ¨ï¼Œå¯ä»¥å…ˆå¤‡ä»½æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œå‘½ä»¤ redis-check-aof [--fix] \u003cfile.aof\u003e æ¥è¿›è¡Œä¿®å¤ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:2:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 3ã€é—®é¢˜å®šä½ä¸ä¼˜åŒ–","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 1ã€fork æ“ä½œRedis åš RDB æˆ–è€… AOF é‡å†™æ—¶ï¼Œå¿…ä¸å¯å°‘çš„æ“ä½œå°±æ˜¯ forkã€‚fork ç”¨çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜é¡µè¡¨ã€‚ æ”¹å–„ forkæ“ä½œçš„è€—æ—¶ï¼š ä¼˜å…ˆä½¿ç”¨ç‰©ç†æœºæˆ–è€…é«˜æ•ˆæ”¯æŒ fork æ“ä½œçš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚ fork è€—æ—¶å’Œå†…å­˜é‡æˆæ­£æ¯”ï¼Œå•ä¸ª Redis å®ä¾‹å»ºè®®ä¸è¶…è¿‡ 10Gã€‚ linux å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé¿å…ç‰©ç†å†…å­˜ä¸è¶³å¯¼è‡´ fork å¤±è´¥ã€‚ é™ä½ fork æ“ä½œé¢‘ç‡ï¼Œæ¯”å¦‚é¿å…ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ï¼Œé€‚å½“æ”¾å®½ AOF è‡ªåŠ¨è§¦å‘æ—¶æœºã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:3:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 2ã€å­è¿›ç¨‹å¼€é”€ç›‘æ§å’Œä¼˜åŒ– CPUï¼Œå­è¿›ç¨‹è´Ÿè´£æŠŠå†…å­˜ä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ä¸­ï¼Œå±äº IO å¯†é›†å‹æ“ä½œï¼Œä¸è¦å’Œå…¶ä»– IO å¯†é›†å‹æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·ã€‚ å†…å­˜ï¼Œå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œé¿å…åœ¨å¤§é‡å†™å…¥æ—¶åšå­è¿›ç¨‹é‡å†™æ“ä½œï¼Œå¯¼è‡´çˆ¶è¿›ç¨‹ç»´æŠ¤å¤§é‡é¡µå‰¯æœ¬ï¼Œé€ æˆå†…å­˜æ¶ˆè€—ï¼Œå¯ä»¥å…³é—­ THPã€‚ ç£ç›˜ï¼ŒAOF é‡å†™ä¼šæ¶ˆè€—å¤§é‡ç£ç›˜ IOï¼Œå¯ä»¥å…³é—­ï¼Œå‚æ•°è®¾ç½®ä¸º no-appendfsync-on-rewrite yesï¼Œé»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½†æ˜¯å¼€å¯åï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:3:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 3ã€AOF è¿½åŠ é˜»å¡AOF æŒä¹…åŒ–ï¼Œå¸¸ç”¨çš„åŒæ­¥ç­–ç•¥æ˜¯ everysecï¼Œç”¨äºå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§ï¼Œå¯¹äºè¿™ç§æ–¹å¼ï¼ŒRedis ä½¿ç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ¯ç§’æ‰§è¡Œ fsync åŒæ­¥ç£ç›˜ï¼Œå½“ç³»ç»Ÿç£ç›˜ç¹å¿™æ—¶ï¼Œå¯èƒ½é€ æˆ Redis ä¸»è¿›ç¨‹é˜»å¡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:3:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 4ã€å¤šå®ä¾‹éƒ¨ç½²ç•¥ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/05/"},{"categories":null,"content":" 1ã€é…ç½®","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 1ã€å»ºç«‹å¤åˆ¶å»ºç«‹å¤åˆ¶å‰ä¼šåˆ é™¤å…¨éƒ¨æ•°æ®ã€‚ é…ç½®å¤åˆ¶çš„æ–¹å¼æœ‰ä¸‰ç§ï¼› é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ slaveof {masterHost} {masterPort}ã€‚ redis å¯åŠ¨å‘½ä»¤ååŠ å…¥ slaveof {masterHost} {masterPort}ã€‚ ç›´æ¥æ‰§è¡Œå‘½ä»¤ slaveof {masterHost} {masterPort}ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 2ã€æ–­å¼€å¤åˆ¶åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ slaveof no one æ¥æ–­å¼€å¤åˆ¶ã€‚æ‰€è°“åˆ‡ä¸»æ“ä½œï¼Œå°±æ˜¯å…ˆæ–­å¼€å¤åˆ¶ï¼Œç„¶åå†å»ºç«‹å¤åˆ¶ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 3ã€å®‰å…¨æ€§ä¸ºäº†å®‰å…¨æ€§ï¼Œä¸€èˆ¬éƒ½ä¼šåœ¨ä¸»èŠ‚ç‚¹ä¸Šè®¾ç½® requirepass 123456ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯è®¿é—®å¿…é¡»ä½¿ç”¨ auth 123456 éªŒè¯ã€‚å› æ­¤ä»èŠ‚ç‚¹å¼€å¯å¤åˆ¶æ—¶ï¼Œä¹Ÿè¦è®¾ç½® masterauth 123456ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 4ã€åªè¯»é»˜è®¤æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹ä½¿ç”¨ slave-read-only=yes é…ç½®ä¸ºåªè¯»æ¨¡å¼ã€‚ç”±äºå·²ç»å¼€å¯äº†å¤åˆ¶ï¼Œå»ºè®®ä»èŠ‚ç‚¹ä¿æŒåªè¯»æ¨¡å¼ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 5ã€ä¼ è¾“å»¶è¿Ÿä¸»ä»èŠ‚ç‚¹ä¹‹é—´å¤åˆ¶æ•°æ®ï¼Œè‚¯å®šä¼šæœ‰å»¶è¿Ÿã€‚ redis æä¾›äº† repl-disable-tcp-nodelay å‚æ•°ç”¨äºå…³é—­ TCP_NODELAYï¼Œé»˜è®¤å…³é—­ã€‚ å½“å…³é—­æ—¶ï¼Œä¸»èŠ‚ç‚¹çš„æ•°æ®æ— è®ºå¤§å°éƒ½ä¼šå‘é€åˆ°ä»èŠ‚ç‚¹ï¼Œè¿™æ ·å°±é™ä½äº†å»¶è¿Ÿï¼Œä½†å¢åŠ äº†å¸¦å®½ã€‚ å½“å¼€å¯æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šåˆå¹¶è¾ƒå°çš„ TCP æ•°æ®åŒ…ï¼Œä»è€ŒèŠ‚çœå¸¦å®½ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:1:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 2ã€æ‹“æ‰‘ä¸»è¦æœ‰ä¸‰ç§ï¼›ä¸€ä¸»ä¸€ä»ï¼Œä¸€ä¸»å¤šä»ï¼Œæ ‘çŠ¶ä¸»ä»ã€‚ ä¸€ä¸»ä¸€ä»ï¼š æœ€ç®€å•çš„ç»“æ„ï¼Œä¸€èˆ¬åªåœ¨ ä»èŠ‚ç‚¹ä¸Šå¼€å¯ AOF æ“ä½œã€‚ ä¸€ä¸»å¤šä»ï¼š ç”¨äºè¯»å¤šå†™å°‘ã€è¯»å†™åˆ†ç¦»çš„åœºæ™¯ æ ‘çŠ¶ä¸»ä»ï¼š ä»èŠ‚ç‚¹ä¸ä½†å¯ä»¥å¤åˆ¶ä¸»èŠ‚ç‚¹çš„æ•°æ®ï¼Œè¿˜å¯ä»¥ä½œä¸ºå…¶ä»–çš„èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 3ã€åŸç†","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 1ã€å¤åˆ¶è¿‡ç¨‹ æ‰§è¡Œ slaveof {masterHost} {masterPort} å‘½ä»¤åï¼Œä¿å­˜ä¸»èŠ‚ç‚¹ä¿¡æ¯ã€‚ ä»èŠ‚ç‚¹æ¯ç§’è¿è¡Œå®šæ—¶ä»»åŠ¡ç»´æŠ¤å¤åˆ¶é€»è¾‘ï¼Œå½“å‘ç°æ–°çš„ä¸»èŠ‚ç‚¹åï¼Œå»ºç«‹è¿æ¥ã€‚ å‘é€ ping å‘½ä»¤ï¼Œä¸»è¦æ˜¯æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯ç”¨å’Œæ˜¯å¦å¯ä»¥å¤„ç†å‘½ä»¤ï¼ˆå¯èƒ½ä¸»èŠ‚ç‚¹é˜»å¡äº†ï¼‰ã€‚ æƒé™éªŒè¯ï¼Œrequirepass å’Œ masterauth æ˜¯å¦åŒ¹é…ã€‚ åŒæ­¥æ•°æ®é›†ï¼Œåˆ†ä¸ºå…¨é‡åŒæ­¥å’Œéƒ¨åˆ†åŒæ­¥ã€‚ å‘½ä»¤æŒç»­å¤åˆ¶ï¼Œæ–°çš„å‘½ä»¤æŒç»­å‘ç»™ä»èŠ‚ç‚¹ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 2ã€æ•°æ®åŒæ­¥åŒæ­¥è¿‡ç¨‹åˆ†ä¸ºå…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶ã€‚ å‚ä¸ä¸»ä»å¤åˆ¶çš„èŠ‚ç‚¹éƒ½ä¼šç»´æŠ¤è‡ªèº«å¤åˆ¶åç§»é‡ã€‚å‘½ä»¤ info ä¸­ master_repl_offset å’Œ slave_repl_offset ã€‚ å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œä¸»èŠ‚ç‚¹æŠŠå‘½ä»¤å‘é€ä»èŠ‚ç‚¹ï¼Œè¿˜ä¼šæŠŠå‘½ä»¤å†™å…¥å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œè¿™ä¸ªç”¨äºéƒ¨åˆ†å¤åˆ¶å’Œå‘½ä»¤ä¸¢å¤±çš„åœºæ™¯ã€‚å‘½ä»¤ info ä¸­ repl_backlog_*ã€‚ ä¸»èŠ‚ç‚¹è¿è¡Œ IDï¼Œç”¨æ¥å”¯ä¸€è¯†åˆ« Redis èŠ‚ç‚¹ï¼Œå½“è¿è¡Œ ID å˜åŒ–äº†ï¼Œä»èŠ‚ç‚¹å°†åšå…¨é‡å¤åˆ¶äº†ã€‚èŠ‚ç‚¹é‡å¯äº†ï¼Œè¿è¡Œ ID ä¹Ÿä¼šå˜åŒ–ã€‚å¯ä»¥æ‰§è¡Œå‘½ä»¤ debug reload æ¥é‡æ–°åŠ è½½å¹¶ä¿æŒè¿è¡Œ ID ä¸å˜ï¼Œä½†æ˜¯ä¼šé˜»å¡å½“å‰ Redisã€‚ å‘½ä»¤ info ä¸­ run_idã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 3ã€å…¨é‡å¤åˆ¶","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 4ã€éƒ¨åˆ†å¤åˆ¶","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 5ã€å¿ƒè·³","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 6ã€å¼‚æ­¥å¤åˆ¶","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:3:6","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" 4ã€å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/06/"},{"categories":null,"content":" Redis å¼€å‘ä¸è¿ç»´ç¬¬ä¸€ç«  åˆè¯† Redis ç¬¬äºŒç«  API çš„ç†è§£å’Œä½¿ç”¨ ç¬¬ä¸‰ç«  å°åŠŸèƒ½å¤§ç”¨å¤„ ç¬¬å››ç«  å®¢æˆ·ç«¯ ç¬¬äº”ç«  æŒä¹…åŒ– ç¬¬å…­ç«  å¤åˆ¶ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/redis-development-and-operation-and-maintenance/readme/"},{"categories":null,"content":" 1ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ CPU é€šè¿‡æ—¶é—´ç‰‡åˆ†é…ç®—æ³•æ¥å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Œå½“å‰ä»»åŠ¡æ‰§è¡Œå®Œä¸€ä¸ªæ—¶é—´ç‰‡åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ä½†æ˜¯åœ¨åˆ‡æ¢å‰ä¼šä¿å­˜ä¸Šä¸€ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå†æ¬¡åŠ è½½è¯¥ä»»åŠ¡çŠ¶æ€ã€‚è¿™å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œä¼šä½¿ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹ï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿå¯èƒ½ä¸å¦‚å•çº¿ç¨‹ã€‚ ä¸Šå›¾çš„ cs (context switch) è¡¨ç¤ºä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ã€‚ å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ–¹æ³•ï¼š æ— é”å¹¶å‘ç¼–ç¨‹ï¼Œå¤šçº¿ç¨‹å¤„ç†æ•°æ®æ—¶ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ–¹æ³•æ¥é¿å…é”ã€‚å¦‚å°†æ•°æ®çš„ ID æŒ‰ç…§ Hash ç®—æ³•å–ä½™åˆ†æ®µï¼Œä¸åŒçš„çº¿ç¨‹å¤„ç†ä¸åŒæ®µçš„æ•°æ®ã€‚ CAS ç®—æ³•ï¼ŒJava çš„ Atomic åŒ…ã€‚ ä½¿ç”¨æœ€å°‘çº¿ç¨‹ï¼Œé¿å…åˆ›å»ºä¸éœ€è¦çš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä»»åŠ¡å¾ˆå°‘ï¼Œåˆ›å»ºçš„çº¿ç¨‹è¾ƒå¤šã€‚ åç¨‹ï¼Œå•çº¿ç¨‹å®ç°å¤šä»»åŠ¡çš„è°ƒåº¦ï¼Œå¹¶ç»´æŒå¤šä»»åŠ¡çŠ¶æ€åˆ‡æ¢ã€‚ å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ç¤ºä¾‹ jstack å‘½ä»¤æ¥ dump çº¿ç¨‹ jstack 31177 \u003e /home/xxx/dump-31177 ç»Ÿè®¡çº¿ç¨‹éƒ½å¤„äºä»€ä¹ˆçŠ¶æ€ grep java.lang.Thread.State dump-31177 | awk '{print $2$3$4$5}' | sort | uniq -c æŸ¥çœ‹è¿™äº› waiting çš„çº¿ç¨‹ï¼Œæ ¹æ®éœ€è¦åˆç†é…ç½®çº¿ç¨‹æ•°ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/"},{"categories":null,"content":" 2ã€æ­»é”æ­»é”ç¤ºä¾‹ï¼š public static void main(String[] args) { Object lockA = new Object(); Object lockB = new Object(); Thread t1 = new Thread(() -\u003e { synchronized (lockA) { System.out.println(\"get lockA\"); timeSleep(2); synchronized (lockB) { System.out.println(\"get lockB\"); } } }); Thread t2 = new Thread(() -\u003e { synchronized (lockB) { System.out.println(\"get lockB\"); synchronized (lockA) { System.out.println(\"get lockA\"); } } }); t1.start(); t2.start(); } é¿å…æ­»é”çš„æ–¹æ³•ï¼š é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶ç”³è¯·æ‰€æœ‰çš„èµ„æºã€‚ å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œå¦‚ lock.tryLock(timeout) æ¥æ›¿æ¢å†…éƒ¨é”ã€‚ å¯¹äºæ•°æ®åº“é”ï¼ŒåŠ é”å’ŒåŠ é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥é‡Œã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/"},{"categories":null,"content":" 3ã€èµ„æºé™åˆ¶çš„æŒ‘æˆ˜ å¸¦å®½ï¼Œæ¯”å¦‚å¸¦å®½åªæœ‰ 20M, ä¸€ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½ä½¿ç”¨ 10Mï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹æ•°æœ€å¤§åªèƒ½æ˜¯ 2ï¼Œå¤šä½™çš„çº¿ç¨‹æ²¡æœ‰èµ„æºå¯ä»¥ä½¿ç”¨ã€‚ ç£ç›˜ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/"},{"categories":null,"content":" 4ã€æ€»ç»“å¼ºçƒˆå»ºè®®ä½¿ç”¨ JDK å¹¶å‘åŒ…æä¾›çš„å¹¶å‘å®¹å™¨å’Œå·¥å…·ç±»æ¥è§£å†³å¹¶å‘é—®é¢˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/01/"},{"categories":null,"content":" Java å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ç¬¬ä¸€ç«  å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜ ç¬¬äºŒç«  Java å¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç† ç¬¬ä¸‰ç«  Java å†…å­˜æ¨¡å‹ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/books/the-art-of-java-concurrent-programming/readme/"},{"categories":null,"content":" Java å¹¶å‘ç¼–ç¨‹å®æˆ˜","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-con-practice/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-con-practice/readme/"},{"categories":null,"content":" 1ã€Javaæœ¬èº«æœ‰ä¸¤ä¸ªæ˜¾è‘—çš„ç‰¹æ€§ JRE å°±æ˜¯ Java è¿è¡Œç¯å¢ƒï¼Œ JDK å°±æ˜¯ Java å¼€å‘å·¥å…·åŒ… è·¨å¹³å°è¿è¡Œï¼ˆä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œï¼‰ åƒåœ¾å›æ”¶å™¨ï¼ˆç¨‹åºå‘˜ä¸ç”¨æ‰‹åŠ¨å›æ”¶å†…å­˜ï¼Œä½†ä»ç„¶å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/01/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/01/"},{"categories":null,"content":" 2ã€Javaæ˜¯è§£ææ‰§è¡Œï¼Ÿï¼ˆä¸å¤ªæ­£ç¡®ï¼‰æˆ‘ä»¬å¼€å‘çš„ java æºä»£ç ï¼Œç»è¿‡ javac ç¼–è¯‘æˆä¸ºå­—èŠ‚ç ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡ JVM å†…ç½®çš„è§£æå™¨å°†å­—èŠ‚ç è£…æ¢ä¸ºæœºå™¨ç ã€‚ å¸¸è§çš„ JVMï¼Œ æ¯”å¦‚ Oracle çš„ Hotspot JVMï¼Œæä¾›äº† JITï¼ˆJust-In-Timeï¼‰åŠ¨æ€ç¼–è¯‘å™¨ã€‚ åœ¨ä¸»æµçš„ Java ç‰ˆæœ¬ä¸­ï¼ŒJava 8 é‡‡ç”¨æ··åˆæ¨¡å¼-Xmixedè¿›è¡Œã€‚ Oracle Hotspot JVM æä¾›äº†ä¸¤ç§ä¸åŒçš„ JIT ç¼–è¯‘å™¨ï¼ŒC1 å¯¹åº” client æ¨¡å¼ï¼Œé€‚ç”¨äºå¯åŠ¨æ•æ„Ÿçš„åº”ç”¨ï¼ŒC2 å¯¹åº” server æ¨¡å¼ï¼Œé€‚ç”¨äºé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨ã€‚é»˜è®¤é‡‡ç”¨çš„æ˜¯åˆ†å±‚ç¼–è¯‘ã€‚ JVM å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šä¸åŒçš„å‚æ•°å¯¹è¿è¡Œæ¨¡å¼é€‰æ‹©ã€‚ -Xint JVM åªè¿›è¡Œè§£é‡Šæ‰§è¡Œã€‚ -Xcomp JVM åªè¿›è¡Œç¼–è¯‘æ‰§è¡Œã€‚ é™¤äº†ä¸Šé¢çš„ç¼–è¯‘æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§æ–°çš„ç¼–è¯‘æ–¹å¼ï¼ˆAOTï¼‰ï¼Œå°±æ˜¯ç›´æ¥æŠŠå­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ã€‚ åˆ©ç”¨ä¸‹é¢çš„å‘½ä»¤æŠŠæŸä¸ªç±»æˆ–è€…æŸä¸ªæ¨¡å—ç¼–è¯‘æˆä¸ºAOTåº“ jaotc --output libHelloWorld.so HelloWorld.class jaotc --output libjava.base.so --module java.base ç„¶ååœ¨å¯åŠ¨æ—¶ç›´æ¥æŒ‡å®š java -XX:AOTLibrary=./libHelloWorld.so,./libjava.base.so HelloWorld ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/01/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/01/"},{"categories":null,"content":" 1ã€Exception å’Œ Error Exception å’Œ Error éƒ½ç»§æ‰¿ Throwable ç±»ï¼Œåªæœ‰ Throwable ç±»çš„å®ä¾‹æ‰å¯ä»¥æŠ›å‡ºã€‚ Exception æ˜¯å¯ä»¥é¢„æ–™çš„æ„å¤–æƒ…å†µï¼Œå¯ä»¥è¢«æ•è·è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è€Œ Error æ˜¯ä¸å¤ªå¯èƒ½å‡ºç°çš„æƒ…å†µï¼Œå¯èƒ½ä¼šé€ æˆç¨‹åºç»ˆæ­¢ï¼Œå¦‚ OutOfMemoryErrorï¼ˆå†…å­˜æº¢å‡ºï¼‰ã€‚ Exception åˆ†ä¸ºå¯æ£€æŸ¥ï¼ˆcheckedï¼‰å¼‚å¸¸å’Œä¸æ£€æŸ¥ï¼ˆuncheckedï¼‰å¼‚å¸¸ï¼Œå¯æ£€æŸ¥å¼‚å¸¸å¿…é¡»æ˜¾å¼æ•è·å¤„ç†ï¼Œä¸æ£€æŸ¥å¼‚å¸¸å°±æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ã€‚å¦‚ NullPointerException ã€‚ å¸¸è§çš„ Exception NullPointerException ï¼ˆç©ºæŒ‡é’ˆå¼‚å¸¸ï¼‰ ArrayIndexOutOfBoundsException ï¼ˆæ•°ç»„è¶Šç•Œå¼‚å¸¸ï¼‰ NoSuchFileException ï¼ˆæ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°å¼‚å¸¸ï¼‰ InterruptedException ï¼ˆçº¿ç¨‹è¢«æ‰“æ–­å¼‚å¸¸ï¼‰ ClassCastException ï¼ˆç±»å‹è½¬æ¢å¼‚å¸¸ï¼‰ å¸¸è§çš„ Error NoClassDefFoundError ï¼ˆç±»æ²¡æœ‰è¢«æ‰¾åˆ°é”™è¯¯ï¼‰ OutOfMemoryError ï¼ˆå †å†…å­˜æº¢å‡ºé”™è¯¯ï¼‰ StackOverflowError ï¼ˆæ ˆå†…å­˜æº¢å‡ºé”™è¯¯ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/02/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/02/"},{"categories":null,"content":" 2ã€try-catch-finally try (BuferedReader br = new BuferedReader(...); BuferedWriter writer = new BuferedWriter(...)) { // do something catch ( IOException | XEception e) { // Multiple catch // Handle it } finally { // do something } æ³¨æ„ å°½é‡ä¸è¦æ•è· Exception ç±»å‹çš„å¼‚å¸¸ï¼Œå…·ä½“å¼‚å¸¸å…·ä½“å¤„ç†ã€‚ ä¸è¦ç”Ÿåï¼ˆswallowï¼‰å¼‚å¸¸ï¼Œé¿å…é”™è¯¯åå‡ºç°éš¾ä»¥è¯Šæ–­çš„æƒ…å†µï¼Œå¯ä»¥è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚ Java çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ä¼šæœ‰é¢å¤–çš„å¼€é”€ try-catch çš„ä»£ç æ®µä¼šå½±å“ JVM çš„ä¼˜åŒ–ï¼Œå°½é‡åªæ•è·æœ‰å¿…è¦çš„ä»£ç æ®µã€‚ Java æ¯å®ä¾‹åŒ–ä¸€ä¸ª Exceptionï¼Œå°±ä¼šå¯¹å½“å‰æ ˆè¿›è¡Œå¿«ç…§ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/02/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/02/"},{"categories":null,"content":" 1ã€final final ä¿®é¥°çš„ç±»ï¼Œä¸èƒ½è¢«ç»§æ‰¿ã€‚ final ä¿®é¥°çš„å˜é‡ï¼Œä¸èƒ½è¢«ä¿®æ”¹ã€‚ final ä¿®é¥°çš„æ–¹æ³•ï¼Œä¸èƒ½è¢«é‡å†™ã€‚ final ä¸æ˜¯ immutableï¼Œå¯¹è±¡çš„å±æ€§è¿˜æ˜¯å¯ä»¥æ”¹å˜çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/03/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/03/"},{"categories":null,"content":" 2ã€finally finally æ˜¯ Java ä¿è¯ä»£ç ä¸€å®šä¼šè¢«æ‰§è¡Œçš„æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ try-catch-finallyã€try-finally æ¥å…³é—­æ•°æ®åº“è¿æ¥ï¼Œunlock()ç­‰ã€‚ å¦‚æœæ˜¯åˆ©ç”¨ finally æœºåˆ¶æ¥å…³é—­èµ„æºï¼Œæœ€å¥½æ˜¯ç”¨ try-with-resourcesã€‚ ç‰¹ä¾‹ try { // do something Sysem.exit(1); } finally{ Sysem.out.println(â€œPrint from fnallyâ€); } ä¸Šé¢çš„ finally è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/03/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/03/"},{"categories":null,"content":" 3ã€finalize finalize æ–¹æ³•æ˜¯ Object ä¸­ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„è®¾è®¡ç›®çš„æ˜¯ä¿è¯å¯¹è±¡åœ¨åƒåœ¾æ”¶é›†å‰å®Œæˆèµ„æºçš„å›æ”¶ï¼Œç°åœ¨å·²ç»ä¸æ¨èä½¿ç”¨ï¼Œåœ¨ Java 9 ä¸­å·²è¢«æ ‡è®°ä¸º @Deprecatedã€‚ ä½¿ç”¨ finalize å¯èƒ½ä¼šä½¿ç¨‹åºæ€§èƒ½é™ä½ï¼Œå› ä¸º JVM ä¼šåšé¢å¤–å¤„ç†ã€‚ Java ç›®å‰ä½¿ç”¨ Cleaner æ¥æ›¿æ¢ finalizeï¼ŒCleanerçš„å®ç°åˆ©ç”¨äº†å¹»è±¡å¼•ç”¨ï¼ˆè™šå¼•ç”¨ï¼‰å’Œå¼•ç”¨é˜Ÿåˆ—ï¼Œæ¯”å¦‚ mysql-connector-java å°±æ˜¯åˆ©ç”¨å¹»è±¡å¼•ç”¨æ¥å›æ”¶èµ„æºã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/03/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/03/"},{"categories":null,"content":" 1ã€kafkaæ¦‚å¿µâ€‹ Apache Kafkaæ˜¯ä¸€æ¬¾å¼€æºçš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼›æ¶ˆæ¯å¼•æ“ç³»ç»Ÿæ˜¯ä¸€ç»„è§„èŒƒï¼Œä¼ä¸šåˆ©ç”¨è¿™ç»„è§„èŒƒåœ¨ä¸åŒç³»ç»Ÿä¹‹é—´ä¼ é€’è¯­ä¹‰å‡†ç¡®çš„æ¶ˆæ¯ï¼Œå®ç°æ¾è€¦åˆçš„å¼‚æ­¥å¼æ•°æ®ä¼ è¾“ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€kafkaç‰¹ç‚¹ ä½¿ç”¨çº¯äºŒè¿›åˆ¶çš„å­—èŠ‚åºåˆ— åŒæ—¶æ”¯æŒä¸¤ç§æ¶ˆæ¯å¼•æ“æ¨¡å‹ï¼ˆç‚¹å¯¹ç‚¹ã€å‘å¸ƒ/è®¢é˜…ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 3ã€kafkaçš„æ¶æ„ Topicï¼šä¸»é¢˜ï¼Œæ‰¿è½½æ¶ˆæ¯çš„é€»è¾‘å®¹å™¨ï¼Œç”¨æ¥åŒºåˆ†ä¸šåŠ¡ï¼› Producerï¼šç”Ÿäº§è€…ï¼Œå‘ä¸»é¢˜å‘å¸ƒæ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºï¼› Consumerï¼šæ¶ˆè´¹è€…ï¼Œå‘ä¸»é¢˜è®¢é˜…æ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºï¼› Partitionï¼šåˆ†åŒºï¼Œæ¯ä¸ªTopicå¯ä»¥è®¾ç½®å¤šä¸ªåˆ†åŒºï¼› Replicaï¼šå‰¯æœ¬ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯ä»¥æä¾›æ•°æ®å†—ä½™å¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œåˆ†ä¸ºé¢†å¯¼è€…å‰¯æœ¬ï¼ˆå¯å¯¹å¤–æä¾›æœåŠ¡ï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆä¸å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ï¼‰ï¼›å¯¹äºåˆ†åŒºå®ç°é«˜å¯ç”¨ï¼› Consumer Groupï¼šæ¶ˆè´¹è€…ç»„ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼ŒåŒæ—¶æ¶ˆè´¹å¤šä¸ªåˆ†åŒºå®ç°é«˜ååï¼›åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…çš„æ¶ˆè´¹è€…ä¸å¯é‡å¤æ¶ˆè´¹åŒä¸€åˆ†åŒºçš„æ¶ˆæ¯ï¼› Rebalanceï¼šé‡å¹³è¡¡ï¼Œæ¶ˆè´¹è€…ç»„å†…çš„æŸä¸ªæ¶ˆè´¹è€…æŒ‚æ‰åï¼Œä¼šé‡æ–°åˆ†é…è®¢é˜…ä¸»é¢˜åˆ†åŒºï¼› Offsetï¼šä½ç§»ï¼Œæœ‰åˆ†åŒºä½ç§»å’Œæ¶ˆè´¹è€…ä½ç§»ä¸¤ä¸ªæ¦‚å¿µï¼›åˆ†åŒºä½ç§»æ˜¯æ¶ˆæ¯çš„ä½ç½®æ ‡è®°ï¼ˆä»0å¼€å§‹ï¼‰ï¼Œæ˜¯å›ºå®šçš„ï¼›æ¶ˆè´¹è€…ä½ç§»æ˜¯æ¶ˆè´¹è€…åœ¨è®¢é˜…æ¶ˆæ¯æ—¶çš„æ¶ˆè´¹è¿›åº¦ï¼Œæ˜¯åŠ¨æ€çš„ï¼› å›¾è§£partitionå’Œreplicationçš„æ¦‚å¿µ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 4ã€å¤šç§Kafkaå¯¹æ¯” Apache Kafkaï¼šç¤¾åŒºç‰ˆkafkaï¼›è¿­ä»£é€Ÿåº¦å¿«ï¼Œç¤¾åŒºå“åº”å¿«ï¼Œä½†æ˜¯ä»…æä¾›æ ¸å¿ƒåŠŸèƒ½ï¼Œç¼ºå°‘é«˜çº§ç‰¹æ€§ï¼› Confluent Kafkaï¼šConfluentå…¬å¸æä¾›çš„Kafkaï¼›é›†æˆäº†å¾ˆå¤šé«˜çº§ç‰¹æ€§ï¼Œåˆ†å…è´¹ç‰ˆå’Œæ”¶è´¹ç‰ˆï¼Œä½†æ˜¯ç›¸å…³èµ„æ–™ä¸å…¨ï¼Œæ™®åŠç‡ä½ï¼› CDH/HDP Kafkaï¼šå¤§æ•°æ®å¹³å°å†…åµŒçš„Apache Kafkaï¼Œæ“ä½œç®€å•ï¼ŒèŠ‚çœè¿ç»´æˆæœ¬ï¼Œä½†æ˜¯æŠŠæ§åº¦ä½ï¼Œæ¼”è¿›é€Ÿåº¦æ…¢ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 5ã€Kafkaç‰ˆæœ¬æ¼”å˜â€‹ kafkaç‰ˆæœ¬å‘½åè§„èŒƒï¼šä¾‹kafka_2.11-2.1.1.tgzï¼ˆ2.11è¡¨ç¤ºscalaç‰ˆæœ¬ï¼Œ2.1.1è¡¨ç¤ºkafkaç‰ˆæœ¬ï¼‰ kafkaç‰ˆæœ¬å·è§„èŒƒï¼šå¤§ç‰ˆæœ¬å· - å°ç‰ˆæœ¬å· - Patch å·ï¼ˆä¿®è®¢å·ï¼‰ 0.7ç‰ˆæœ¬ï¼šåªæä¾›æœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ï¼› 0.8ç‰ˆæœ¬ï¼šå¼•å…¥äº†å‰¯æœ¬æœºåˆ¶ï¼Œ æˆä¸ºäº†ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šå®Œå¤‡çš„åˆ†å¸ƒå¼é«˜å¯é æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æ–¹æ¡ˆï¼›ï¼ˆä½†æ˜¯ç”Ÿäº§å’Œæ¶ˆè´¹çš„å®¢æˆ·ç«¯è¿˜æ˜¯è€ç‰ˆæœ¬çš„ï¼Œåº”æŒ‡å®šzkåœ°å€è€Œä¸æ˜¯brokeråœ°å€ï¼‰ï¼› 0.8.2.0ç‰ˆæœ¬ï¼šå¼•å…¥äº†æ–°ç‰ˆæœ¬Producer APIï¼ˆä½†æ˜¯bugè¿˜æœ‰ç‚¹å¤šï¼Œä¸å»ºè®®ä½¿ç”¨ï¼‰ï¼› 0.8.2.2ç‰ˆæœ¬ï¼šè€ç‰ˆæœ¬çš„Consumer APIæ¯”è¾ƒç¨³å®šäº†ï¼› 0.9ç‰ˆæœ¬ï¼šå¢åŠ äº†åŸºç¡€çš„å®‰å…¨è®¤è¯/æƒé™åŠŸèƒ½ï¼ŒåŒæ—¶ä½¿ç”¨javaé‡å†™äº†Consumer APIï¼Œè¿˜å¼•å…¥äº†Kafka Connectç»„ä»¶ç”¨äºå®ç°é«˜æ€§èƒ½çš„æ•°æ®æŠ½å–ï¼›å¦å¤–æ–°ç‰ˆæœ¬çš„Producer APIæ¯”è¾ƒç¨³å®šäº†ï¼Œä¸å»ºè®®ä½¿ç”¨æ–°ç‰ˆæœ¬çš„Consumer APIï¼› 0.10ç‰ˆæœ¬ï¼šå¼•å…¥äº†Kafka Streamsï¼Œæ­£å¼å‡çº§ä¸ºåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼› 0.10.2.2ç‰ˆæœ¬ï¼šæ–°ç‰ˆæœ¬çš„Consumer APIæ¯”è¾ƒç¨³å®šäº†ï¼Œè¯¥ç‰ˆæœ¬ä¹Ÿä¿®å¤äº†ä¸€ä¸ªå¯èƒ½å¯¼è‡´Produceræ€§èƒ½é™ä½çš„bugï¼› 0.11ç‰ˆæœ¬ï¼šæä¾›äº†å¹‚ç­‰æ€§Producer APIï¼ˆå¹‚ç­‰æ€§å°±æ˜¯æ¶ˆæ¯å»é‡ï¼Œé»˜è®¤ä¸å¼€å¯ï¼‰å’Œäº‹åŠ¡APIï¼ˆå®ç°æµå¤„ç†ç»“æœæ­£ç¡®æ€§çš„åŸºçŸ³ï¼‰ï¼Œè¿˜å¯¹Kafkaæ¶ˆæ¯æ ¼å¼åšäº†é‡æ„ï¼›ï¼ˆè¯¥ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸»æµç‰ˆæœ¬ï¼‰ï¼› 0.11.0.3ç‰ˆæœ¬ï¼šæ¶ˆæ¯å¼•æ“åŠŸèƒ½éå¸¸å®Œå–„äº†ï¼› 1.1ç‰ˆæœ¬ï¼šå®ç°æ•…éšœè½¬ç§»ï¼ˆå³Failoverï¼‰ï¼› 1.0ç‰ˆæœ¬å’Œ2.0ç‰ˆæœ¬ï¼šåªè¦æ˜¯æ˜¯å¯¹Kafka Streamsçš„æ”¹è¿›ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 6ã€Kafkaçš„æ ¸å¿ƒå‚æ•°","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 1ã€é…ç½®æ–‡ä»¶å‚æ•° log.dirsï¼šæŒ‡å®šbrokeréœ€è¦ä½¿ç”¨çš„è‹¥å¹²ä¸ªæ–‡ä»¶ç›®å½•è·¯å¾„ï¼Œæ— é»˜è®¤å€¼ï¼›ç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®ï¼ŒCSVæ ¼å¼ï¼ˆä¾‹å¦‚ï¼š/home/kafka1,/home/kafka2ï¼‰ zookeeper.connectï¼šæŒ‡å®šzkçš„åœ°å€å’Œç«¯å£ï¼ˆä¾‹hadoop01:2181,hadoop02:2181,hadoop03:2181ï¼‰ï¼Œzkä¿å­˜äº†topicã€åˆ†åŒºçš„ä¿¡æ¯ç­‰ç­‰ï¼Œå¦‚æœå¤šä¸ªkafkaé›†ç¾¤å…±æœ‰ä¸€ä¸ªzké›†ç¾¤ï¼ŒåŠ ä¸Šchrootå³å¯ï¼Œchrootæ˜¯åˆ«åï¼Œåˆ™æŒ‡å®šæ ¼å¼ä¸ºhadoop01:2181,hadoop02:2181,hadoop03:2181/kafka1æˆ–hadoop01:2181,hadoop02:2181,hadoop03:2181/kafka2; listenersï¼šç›‘å¬å™¨ï¼ŒæŒ‡å®šåè®®ã€ä¸»æœºåã€ç«¯å£ï¼› advertised.listenersï¼šæŒ‡è¯¥ç›‘å¬å™¨æ˜¯brokerå¯¹å¤–å‘å¸ƒçš„ï¼› host.name/portï¼šè¿‡æœŸå‚æ•°ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼› auto.create.topics.enableï¼šæ˜¯å¦å…è®¸è‡ªåŠ¨åˆ›å»ºtopicï¼› unclean.leader.election.enableï¼šæ˜¯å¦å…è®¸unclean leaderé€‰ä¸¾ï¼ŒåŸæœ¬æ•°æ®å¤šçš„åˆ†åŒºæ‰æœ‰èµ„æ ¼é€‰ä¸¾leaderï¼Œè¯¥å‚æ•°è®¾ç½®ä¸ºtrueåï¼Œæ•°æ®å°‘çš„ä¹Ÿå¯ä»¥å‚ä¸é€‰ä¸¾ï¼Œä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Œå»ºè®®è®¾ç½®ä¸ºfalseï¼› auto.leader.rebalance.enableï¼šæ˜¯å¦å…è®¸å®šæœŸé€‰ä¸¾leaderï¼Œä¸å»ºè®®å¼€å¯ï¼› log.retention.{hour|minutes|ms}ï¼šæ§åˆ¶ä¸€æ¡æ¶ˆæ¯è¢«ä¿å­˜å¤šé•¿æ—¶é—´ï¼Œmsä¼˜å…ˆçº§æœ€é«˜ï¼› log.retention.bytesï¼šæŒ‡å®šbrokerä¸ºæ¶ˆæ¯ä¿å­˜çš„æ€»ç£ç›˜å®¹é‡å¤§å°ï¼Œé»˜è®¤å€¼ä¸º-1ï¼Œè¡¨ç¤ºæ²¡æœ‰ä¸Šé™ï¼› message.max.bytesï¼šæ§åˆ¶brokerèƒ½å¤Ÿæ¥æ”¶çš„æœ€å¤§æ¶ˆæ¯å¤§å°ï¼Œé»˜è®¤å€¼ä¸º1000012ï¼Œå¤ªå°ï¼Œå»ºè®®é‡è®¾ç½®ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:6:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€Topicçº§åˆ«å‚æ•° retention.msï¼šè§„å®šäº†è¯¥topicæ¶ˆæ¯è¢«ä¿å­˜çš„æ—¶é•¿ï¼› retention.bytesï¼šè§„å®šäº†è¦ä¸ºè¯¥topicé¢„ç•™å¤šå¤§çš„ç£ç›˜ç©ºé—´ï¼ˆé»˜è®¤-1ï¼Œè¡¨ç¤ºæ²¡æœ‰ä¸Šé™ï¼‰ï¼› max.message.bytesï¼šBrokerèƒ½å¤Ÿæ¥æ”¶çš„è¯¥topicçš„æœ€å¤§æ¶ˆæ¯å¤§å°ï¼› ä»¥ä¸Šå‚æ•°å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è®¾ç½® åˆ›å»ºtopicæ—¶è¿›è¡Œè®¾ç½®ï¼šä¾‹bin/kafka-topics.sh â€“zookeeper hadoop01:2181,hadoop02:2181,hadoop03:2181 â€“create â€“topic my-topic â€“partitions 1 â€“replication-factor 1 â€“config max.message.bytes=64000 â€“config flush.messages=1 ä¿®æ”¹topicæ—¶è®¾ç½®ï¼šä¾‹bin/kafka-topics.sh â€“zookeeper hadoop01:2181,hadoop02:2181,hadoop03:2181 â€“alter â€“topic my-topic â€“config max.message.bytes=128000 ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:6:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 3ã€JVMå‚æ•° KAFKA_HEAP_OPTSï¼šæŒ‡å®šå †å¤§å°ï¼› KAFKA_JVM_PERFORMANCE_OPTSï¼šæŒ‡å®šGCå‚æ•°ï¼› åœ¨å¯åŠ¨kafkaå‰è®¾ç½®è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:6:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 4ã€æ“ä½œç³»ç»Ÿå‚æ•° ulimit -nï¼šæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æœ€å¤§å€¼ï¼ˆä¾‹ulimit -n 100000ï¼‰ï¼› æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼šå»ºè®®é€‰æ‹©XFSï¼› swappniessï¼šswapç©ºé—´å¤§å°ï¼Œå»ºè®®è®¾ç½®ç•¥å¤§äº0çš„å€¼ï¼› æäº¤æ—¶é—´ï¼šå³flushè½ç›˜æ—¶é—´ï¼Œkafkaçš„æ•°æ®ä¼šå…ˆå†™åˆ°æ“ä½œç³»ç»Ÿçš„é¡µç¼“å­˜ä¸Šï¼Œç„¶åä¼šæ ¹æ®LRUç®—æ³•å®šæœŸå°†é¡µç¼“å­˜çš„æ•°æ®è½ç›˜åˆ°ç£ç›˜ï¼Œé»˜è®¤ä¸º5ç§’ï¼Œå¯é€‚å½“å¢å¤§æ—¶é—´é—´éš”ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:6:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 7ã€åˆ†åŒºç­–ç•¥","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:7:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 1ã€ç”Ÿäº§è€…åˆ†åŒºç­–ç•¥ è½®è¯¢ç­–ç•¥ï¼ˆRound-robinï¼‰ï¼škafkaç”Ÿäº§è€…APIé»˜è®¤çš„åˆ†åŒºç­–ç•¥ï¼Œæœ€å¤§é™åº¦è´Ÿè½½å‡è¡¡ï¼› éšæœºç­–ç•¥ï¼ˆRandomnessï¼‰ï¼šå¯è‡ªå®šä¹‰å®ç°è¯¥ç­–ç•¥ï¼› æŒ‰æ¶ˆæ¯é”®ä¿å­˜ç­–ç•¥ï¼ˆKey-orderingï¼‰ï¼škeyå¯ä»¥æ˜¯ä¸šåŠ¡ä¸Šçš„å­—æ®µä¿¡æ¯ï¼ŒæŒ‰ä¸šåŠ¡åœºæ™¯è‡ªå®šä¹‰åˆ†åŒºï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:7:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€æ¶ˆè´¹è€…åˆ†åŒºç­–ç•¥ æŒ‰èŒƒå›´åˆ†é…ï¼šæŒ‡å®šåˆ†åŒºæ¶ˆè´¹ï¼› è½®è¯¢åˆ†é…ï¼šæŒ‰é¡ºåºåˆ†é…ç»™æ¶ˆè´¹è€…ï¼› è‡ªå®šä¹‰ï¼šè®¾ç½®partition.assignment.strategyä¸ºè‡ªå®šä¹‰çš„ç±»ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:7:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 8ã€å‹ç¼©â€‹ kafkaçš„æ¶ˆæ¯å±‚æ¬¡åˆ†ä¸ºæ¶ˆæ¯é›†åˆå’Œæ¶ˆæ¯ã€‚ä¸€ä¸ªæ¶ˆæ¯é›†åˆåŒ…å«è‹¥å¹²æ¡æ—¥å¿—é¡¹ï¼Œæ—¥å¿—é¡¹å°±æ˜¯è£…æ¶ˆæ¯çš„åœ°æ–¹ï¼›kafkaåº•å±‚çš„æ¶ˆæ¯æ—¥å¿—ç”±ä¸€ç³»åˆ—æ¶ˆæ¯é›†åˆæ—¥å¿—é¡¹ç»„æˆï¼Œkafkaæ˜¯åœ¨æ¶ˆæ¯é›†åˆå±‚é¢ä¸Šè¿›è¡Œå†™å…¥æ“ä½œï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:8:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 1ã€kafkaæ¶ˆæ¯æ ¼å¼â€‹ kafkaæœ‰ä¸¤å¤§æ¶ˆæ¯æ ¼å¼ï¼šV1å’ŒV2ï¼ˆ0.11.0.0ç‰ˆæœ¬åå¼•å…¥çš„ï¼‰ï¼› â€‹ V1ä¸­æ¯æ¡æ¶ˆæ¯éœ€è¦æ‰§è¡ŒCRCæ ¡éªŒï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹CRCå€¼æ˜¯ä¼šå˜åŒ–çš„ï¼Œä¼šæµªè´¹ç©ºé—´å’Œè€½è¯¯CPUæ—¶é—´ï¼›åœ¨ä¿å­˜å‹ç¼©æ¶ˆæ¯ä¸Šï¼Œæ˜¯æŠŠå¤šæ¡æ¶ˆæ¯è¿›è¡Œå‹ç¼©ç„¶åä¿å­˜åˆ°å¤–å±‚æ¶ˆæ¯çš„æ¶ˆæ¯ä½“å­—æ®µä¸­ã€‚ â€‹ V2å¯¹V1æ”¹è¿›äº†å¾ˆå¤šï¼ŒCRCæ ¡éªŒå·¥ä½œç§»åˆ°äº†æ¶ˆæ¯é›†åˆè¿™ä¸€å±‚ï¼Œè€Œä¸”åœ¨ä¿å­˜å‹ç¼©æ¶ˆæ¯ä¸Šï¼Œæ˜¯å¯¹æ•´ä¸ªæ¶ˆæ¯é›†åˆè¿›è¡Œå‹ç¼©ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:8:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€ä½•æ—¶å‹ç¼©å’Œè§£å‹ç¼© ç”Ÿäº§è€…ç«¯ï¼šç”Ÿäº§æ¶ˆæ¯æ—¶æŒ‡å®šå‹ç¼©æ–¹æ³•ã€‚ brokerç«¯ï¼šé»˜è®¤çš„å‹ç¼©æ–¹å¼æ˜¯producerï¼Œå¦‚æœæŒ‡å®šäº†è·Ÿproducerä¸åŒçš„å‹ç¼©æ–¹å¼æ—¶ï¼Œä¼šå…ˆè§£å‹ç¼©å†æŒ‰æ–°æŒ‡å®šçš„æ–¹å¼å‹ç¼©ï¼›æˆ–è€…brokerç«¯å‘ç”Ÿäº†æ¶ˆæ¯æ ¼å¼è½¬æ¢ä¹Ÿä¼šé‡å‹ç¼©ã€‚ consumerç«¯ï¼šè§£å‹ç¼©ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:8:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 3ã€å‹ç¼©ç®—æ³•ï¼ˆkafka2.1.0ç‰ˆæœ¬å‰æ”¯æŒçš„ç®—æ³•ï¼šGZIPã€Snappyã€LZ4ï¼›è¯¥ç‰ˆæœ¬å¼€å§‹åæ”¯æŒZstandardç®—æ³•ï¼‰ å‹ç¼©ç®—æ³•çš„ä¼˜åŠ£æœ‰ä¸¤ä¸ªæŒ‡æ ‡ï¼šå‹ç¼©æ¯”å’Œå‹ç¼©/è§£å‹ç¼©ååé‡ï¼› å‹ç¼©æ¯”ï¼šzstd \u003e LZ4 \u003e GZIP \u003e Snappy ååé‡ï¼šLZ4 \u003e Snappy \u003e zstd / GZIP ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:8:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 9ã€æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®kafkaåªå¯¹å·²æäº¤çš„æ¶ˆæ¯åšæœ‰é™åº¦çš„æŒä¹…åŒ–ä¿è¯ã€‚ ä¸è¦ä½¿ç”¨producer.send(msg),è€Œè¦ä½¿ç”¨producer.send(msg,callback); è®¾ç½®acks = allï¼›è¡¨æ˜æ‰€æœ‰å‰¯æœ¬brokeréƒ½è¦æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œä¿è¯æ¶ˆæ¯â€å·²æäº¤â€œï¼› è®¾ç½®retriesä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼› è®¾ç½®unclean.leader.election.enable = falseï¼›è¡¨ç¤ºç¦æ­¢è½åçš„brokerè¢«é€‰ä¸ºleaderã€‚ è®¾ç½®replication.factor \u003e= 3ï¼› è®¾ç½®min.insync.replicas \u003e 1ï¼›æ§åˆ¶æ¶ˆæ¯è‡³å°‘è¢«å†™å…¥å¤šå°‘ä¸ªå‰¯æœ¬æ‰ç®—â€œå·²æäº¤â€ï¼› ç¡®ä¿replication.factor \u003e min.insync.replicasï¼›æ¨èreplication.factor = min.insync.replicas + 1ï¼› è®¾ç½®enable.auto.commit = falseï¼›ç¡®ä¿æ¶ˆæ¯æ¶ˆè´¹å®Œæˆå†æäº¤ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:9:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 10ã€å¹‚ç­‰æ€§å’Œäº‹åŠ¡æ€§â€‹ å¹‚ç­‰æ€§ï¼šæŒ‡æŸäº›æ“ä½œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œåœ¨kafkaä¸­æ˜¯å¯¹é‡å¤æ¶ˆæ¯å»é‡ã€‚ â€‹ å¼•å…¥äº‹åŠ¡çš„ä½œç”¨ï¼š1ã€ ç”Ÿäº§è€…å¤šæ¬¡å‘é€æ¶ˆæ¯å¯ä»¥å°è£…æˆä¸€ä¸ªåŸå­æ“ä½œï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼›2ã€ consumer-transform-produceræ¨¡å¼ä¸‹ï¼Œå› ä¸ºæ¶ˆè´¹è€…æäº¤åç§»é‡å‡ºç°é—®é¢˜ï¼Œå¯¼è‡´åœ¨é‡å¤æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…é‡å¤ç”Ÿäº§æ¶ˆæ¯ã€‚éœ€è¦å°†è¿™ä¸ªæ¨¡å¼ä¸‹æ¶ˆè´¹è€…æäº¤åç§»é‡æ“ä½œå’Œç”Ÿäº§è€…ä¸€ç³»åˆ—ç”Ÿæˆæ¶ˆæ¯çš„æ“ä½œå°è£…æˆä¸€ä¸ªåŸå­æ“ä½œã€‚ â€‹ kafkaäº‹åŠ¡ä¸€èˆ¬ä¸ºä¸¤ç§ï¼š1ã€ åªæœ‰Producerç”Ÿäº§æ¶ˆæ¯ ï¼›2ã€ç”Ÿäº§æ¶ˆè´¹å¹¶å­˜ï¼ˆconsumer-transform-producerï¼‰ï¼›3ã€åªæœ‰Consumeræ¶ˆè´¹æ¶ˆæ¯ã€‚ å¹‚ç­‰æ€§Producerï¼šåªèƒ½ä¿è¯å•åˆ†åŒºã€å•ä¼šè¯ä¸Šçš„æ¶ˆæ¯å¹‚ç­‰æ€§ï¼ˆè®¾ç½®å¹‚ç­‰æ€§ï¼šprops.put(â€œenable.idempotenceâ€, true)æˆ–props.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true)ï¼‰ äº‹åŠ¡æä¾›çš„ACIDç‰¹æ€§ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ éš”ç¦»æ€§ï¼šè¡¨ç¤ºå¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡å½¼æ­¤ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚ äº‹åŠ¡å‹Producerï¼šèƒ½å¤Ÿä¿è¯è·¨åˆ†åŒºã€è·¨ä¼šè¯é—´çš„å¹‚ç­‰æ€§(è®¾ç½®äº‹åŠ¡å‹Producerï¼šå¼€å¯enable.idempotence = trueï¼Œç„¶åè®¾ç½®Producerç«¯å‚æ•°transctional.id,è¿˜è¦è°ƒç”¨ä¸€äº›äº‹åŠ¡APIï¼Œå¦‚ä¸‹åˆ—ä»£ç ï¼›è¡¨ç¤ºrecord1å’Œrecord2è¦ä¹ˆå…¨éƒ¨å†™å…¥æˆåŠŸè¦ä¹ˆå¤±è´¥ã€‚åœ¨consumerç«¯è¦è®¾ç½®isolation.levelï¼Œread_uncommittedæ˜¯é»˜è®¤å€¼ï¼Œè¡¨ç¤ºå¯ä»¥è¯»å–åˆ°kafkaä»»ä½•æ¶ˆæ¯ï¼Œä¸ç®¡äº‹åŠ¡å‹Produceræ˜¯æäº¤äº‹åŠ¡è¿˜æ˜¯ç»ˆæ­¢äº‹åŠ¡ï¼›å»ºè®®ä½¿ç”¨read_committedï¼Œè¡¨ç¤ºåªè¯»å–äº‹åŠ¡å‹æˆåŠŸæäº¤çš„æ¶ˆæ¯ä»¥åŠéäº‹åŠ¡å‹Producerå†™å…¥çš„æ¶ˆæ¯ã€‚) producer.initTransactions(); try{ producer.beginTransaction(); producer.send(record1); producer.send(record2); producer.commitTransaction(); }catch(KafkaException e){ producer.abortTransaction(); } ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:10:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 11ã€Consumer Group","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:11:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 1ã€ç‰¹æ€§ ä¸€ä¸ªConsumer Groupå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªConsumerï¼› Droup IDæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ‡è¯†è¿™ä¸€ä¸ªå”¯ä¸€çš„Consumer Groupï¼› åŒä¸€ä¸ªGroupä¸­çš„Consumerä¸èƒ½é‡å¤è®¢é˜…ä¸€ä¸ªåˆ†åŒºï¼› ï¼ˆè€ç‰ˆæœ¬çš„Consumer GroupæŠŠæ¶ˆè´¹è€…ä½ç§»ä¿å­˜åœ¨zkä¸­ï¼Œç”±äºé¢‘ç¹è¯»å†™ä¼šå¯¼è‡´zké›†ç¾¤æ€§èƒ½é™ä½ï¼Œæ–°ç‰ˆæœ¬æŠŠæ¶ˆè´¹è€…ä½ç§»ä¿å­˜åœ¨kafkaçš„_consumer_offsetsçš„topicä¸­ã€‚ï¼‰ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:11:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€rebalanceçš„è§¦å‘æ¡ä»¶ Consumer Groupä¸­çš„æˆå‘˜æ•°å˜æ›´ï¼› è®¢é˜…çš„topicæ•°å˜æ›´ï¼ˆæ¯”å¦‚è®¢é˜…äº†ç”¨æ­£åˆ™åŒ¹é…çš„topicï¼Œæ–°å¢äº†ä¸€ä¸ªç¬¦åˆçš„topicï¼‰ï¼› è®¢é˜…çš„topicçš„åˆ†åŒºæ•°å˜æ›´ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:11:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 3ã€rebalanceçš„å¼Šç«¯ rebalanceå½±å“Consumerç«¯TPSï¼›ï¼ˆrebalanceæœŸé—´ï¼Œconsumerä¼šåœæ­¢å·¥ä½œï¼‰ rebalanceè¿‡ç¨‹å¾ˆæ…¢ï¼› rebalanceæ•ˆç‡ä¸é«˜ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:11:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 4ã€éå¿…è¦rebalance consumeræœªèƒ½åŠæ—¶ç»™coordinatorå‘é€å¿ƒè·³ï¼Œå¯¼è‡´consumerè¢«è¸¢å‡ºConsumer Groupï¼›éœ€è®¾ç½®åˆç†çš„session.timeout.msï¼ˆé»˜è®¤å€¼æ˜¯10sï¼Œè¡¨ç¤ºcoordinatoråœ¨10så†…æ²¡æ”¶åˆ°consumerçš„å¿ƒè·³æ¶ˆæ¯ï¼Œè¯¥consumerè¢«åˆ¤å®šä¸ºdeadï¼‰å’Œheartbeat.interval.msï¼ˆè¡¨ç¤ºconsumerå‘é€å¿ƒè·³è¯·æ±‚çš„é¢‘ç‡ï¼‰çš„å€¼ ï¼ˆæ¨èsession.timeout.ms=2sï¼Œheartbeat.interval.ms=6sï¼‰ consumeræ¶ˆè´¹æ—¶é—´è¿‡é•¿ï¼›éœ€è®¾ç½®max.poll.interval.msçš„å€¼ï¼Œè¡¨ç¤ºä¸‹æ¸¸å¤„ç†æ•°æ®çš„æ—¶é—´ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:11:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 12ã€ä½ç§»ä¸»é¢˜ï¼ˆ_consumer_offsetsï¼‰â€‹ _consumer_offsetsçš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¿å­˜Kafkaæ¶ˆè´¹è€…çš„ä½ç§»æ¶ˆæ¯ã€‚æ¶ˆæ¯æ ¼å¼æ˜¯KVå¯¹ï¼ŒKeyä¿å­˜çš„æ˜¯\u003cGroup ID,ä¸»é¢˜åï¼Œåˆ†åŒºå·\u003eï¼›å¦å¤–è¿˜æœ‰ä¸¤ç§æ¶ˆæ¯æ ¼å¼ï¼š1.ç”¨äºä¿å­˜Consumer Groupä¿¡æ¯çš„æ¶ˆæ¯ï¼›2.ç”¨äºåˆ é™¤Groupè¿‡æœŸä½ç§»ç”šè‡³æ˜¯åˆ é™¤Groupçš„æ¶ˆæ¯ã€‚ â€‹ å½“æœ‰ç¬¬ä¸€ä¸ªConsumeræ¶ˆè´¹æ•°æ®æ—¶ï¼ŒKafkaå°±ä¼šè‡ªåŠ¨åˆ›å»º_consumer_offsetsè¿™ä¸ªä¸»é¢˜ï¼Œé»˜è®¤æœ‰50ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:12:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 13ã€æäº¤ä½ç§»â€‹ ä»ç”¨æˆ·è§’åº¦ï¼Œåˆ†ä¸ºè‡ªåŠ¨æäº¤å’Œæ‰‹åŠ¨æäº¤ï¼›ä»Consumerè§’åº¦åˆ†ä¸ºåŒæ­¥æäº¤å’Œå¼‚æ­¥æäº¤ã€‚ org.apache.kafka.common.serialization.StringSerializer è‡ªåŠ¨æäº¤ è®¾ç½®ä¸ºè‡ªåŠ¨æäº¤åï¼Œè°ƒç”¨pollæ–¹æ³•æ—¶ï¼Œä¼šæäº¤ä¸Šæ¬¡pollè¿”å›çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œpollæ–¹æ³•çš„é€»è¾‘æ˜¯å…ˆæäº¤ä¸Šä¸€æ‰¹æ¶ˆæ¯çš„ä½ç§»ï¼Œå†å¤„ç†ä¸‹ä¸€æ‰¹æ¶ˆæ¯ï¼Œå¯ä»¥ä¿è¯ä¸å‡ºç°æ¶ˆè´¹ä¸¢å¤±çš„æƒ…å†µï¼Œç¼ºç‚¹æ˜¯å¯èƒ½å‡ºç°é‡å¤æ¶ˆè´¹ã€‚ Properties props = new Properties(); props.put(\"bootstrap.servers\",\"localhost:9092\"); props.put(\"group.id\",\"test\"); props.put(\"enable.auto.commit\",\"true\"); props.put(\"auto.commit.interval.ms\",\"2000\"); props.put(\"key.deserializer\",\"org.apache.kafka.common.serialization.String*Serializer\"); props.put(\"value.deserializer\",\"org.apache.kafka.common.serialization.String*Serializer\"); KafkaConsumer\u003cString,String\u003e consumer = new KafkaConsumer\u003c\u003e(props); consumer.subscribe(Arrays.asList(\"foo\",\"bar\")); while(true){ ConsumerRecords\u003cString,String\u003e records = consumer.poll(100); for(ConsumerRecord\u003cString,String\u003e record : records){ System.out.printf(\"offset = %d, key = %s, value = %s%n\", record.offset(), record.key(), resord.value()); } } åŒæ­¥æäº¤commitSync() æ‰‹åŠ¨æäº¤åœ¨è°ƒç”¨commitSync()æ—¶ï¼ŒConsumerä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°Brokerç«¯è¿”å›ç»“æœï¼Œå½±å“æ•´ä¸ªç¨‹åºçš„TPSã€‚ while(true){ ConsumerRecords\u003cString,String\u003e records = consumer.poll(Duration.ofSeconds(1)); process(records); //å¤„ç†æ¶ˆæ¯ try{ consumer.commitSync(); }catch (CommitFailedException e){ handle(e); } } å¼‚æ­¥æäº¤commitAsync() åœ¨è°ƒç”¨commitAsync()æ—¶ï¼Œä¼šç«‹å³è¿”å›ç»“æœï¼Œä¸ä¼šé˜»å¡ï¼›ç¼ºç‚¹æ˜¯å‡ºç°é—®é¢˜æ—¶ä¸èƒ½è‡ªåŠ¨é‡è¯•ã€‚ while(true){ ConsumerRecords\u003cString,String\u003e records = consumer.poll(Duration.ofSeconds(1)); process(records); //å¤„ç†æ¶ˆæ¯ consumer.commitAsync((offsets,exception) -\u003e { if(exception != null) handle(exception); }); } åŒæ­¥+å¼‚æ­¥æäº¤ æ‰‹åŠ¨æäº¤ä¸­ï¼ŒcommitSync()å’ŒcommitAsync()ç»“åˆä½¿ç”¨ä¼šæœ‰å¾ˆå¥½çš„æ•ˆæœï¼Œåˆ©ç”¨commitSync()çš„è‡ªåŠ¨é‡è¯•é¿å…ç¬æ—¶é”™è¯¯ï¼Œåˆ©ç”¨commitAsync()ä¸ä¼šé˜»å¡ã€‚ try { while (true) { ConsumerRecords\u003cString, String\u003e records = consumer.poll(Duration.ofSeconds(1)); process(records); // å¤„ç†æ¶ˆæ¯ commitAysnc(); // ä½¿ç”¨å¼‚æ­¥æäº¤è§„é¿é˜»å¡ } } catch (Exception e) { handle(e); // å¤„ç†å¼‚å¸¸ } finally { try { consumer.commitSync(); // æœ€åä¸€æ¬¡æäº¤ä½¿ç”¨åŒæ­¥é˜»å¡å¼æäº¤ } finally { consumer.close(); } } åŒæ­¥/å¼‚æ­¥çš„ç»†ç²’åº¦æäº¤ é€šå¸¸pollçš„æ•°æ®å…¨éƒ¨å¤„ç†å®Œåå†æäº¤ä½ç§»ï¼Œå¦‚æœpollçš„æ€»æ•°å¾ˆå¤§ï¼Œè€Œå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°å·®é”™äº†ï¼Œä¸‹ä¸€æ¬¡ä¼šé‡å¤æ¶ˆè´¹ï¼Œå°±éœ€è¦è®¾ç½®ç»†ç²’åº¦çš„æäº¤ä½ç§»ã€‚ private Map\u003cTopicPartition, OffsetAndMetadata\u003e offsets = new HashMap\u003c\u003e(); int count = 0; â€¦â€¦ while (true) { ConsumerRecords\u003cString, String\u003e records = consumer.poll(Duration.ofSeconds(1)); for (ConsumerRecord\u003cString, String\u003e record: records) { process(record); // å¤„ç†æ¶ˆæ¯ offsets.put(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset() + 1)); ifï¼ˆcount % 100 == 0ï¼‰ consumer.commitAsync(offsets, null); // å›è°ƒå¤„ç†é€»è¾‘æ˜¯ count++; } } ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:13:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 14ã€CommitFailedExceptionâ€‹ CommitFailedExceptionæ˜¯æŒ‡Consumerå®¢æˆ·ç«¯åœ¨æäº¤ä½ç§»æ—¶å‡ºç°äº†é”™è¯¯æˆ–å¼‚å¸¸ï¼Œè€Œä¸”ä¸å¯æ¢å¤ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:14:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 1ã€åœºæ™¯ä¸€â€‹ å½“æ¶ˆæ¯å¤„ç†çš„æ€»æ—¶é—´è¶…è¿‡é¢„è®¾çš„ max.poll.interval.ms å‚æ•°å€¼æ—¶ï¼ŒKafka Consumer ç«¯ä¼šæŠ›å‡º CommitFailedException å¼‚å¸¸ã€‚ è§£å†³æ–¹æ³•å¦‚ä»£ç ï¼š â€¦ Properties props = new Properties(); â€¦ props.put(\"max.poll.interval.ms\", 5000); consumer.subscribe(Arrays.asList(\"test-topic\")); while (true) { ConsumerRecords\u003cString, String\u003e records = consumer.poll(Duration.ofSeconds(1)); // ä½¿ç”¨ Thread.sleep æ¨¡æ‹ŸçœŸå®çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ Thread.sleep(6000L); consumer.commitSync(); } é˜²æ­¢å‡ºç°è¯¥å¼‚å¸¸çš„åŠæ³•ï¼š ç¼©çŸ­å•æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´ï¼› å¢åŠ Comsumerç«¯å…è®¸ä¸‹æ¸¸ç³»ç»Ÿæ¶ˆè´¹ä¸€æ‰¹æ¶ˆæ¯çš„æœ€å¤§æ—¶é•¿ï¼ˆè®¾ç½®max.poll.interval.msçš„å€¼ï¼Œåœ¨0.10.1.0ç‰ˆæœ¬åæ‰æœ‰è¯¥å‚æ•°ï¼‰ï¼› å‡å°‘ä¸‹æ¸¸ç³»ç»Ÿä¸€æ¬¡æ€§æ¶ˆè´¹çš„æ¶ˆæ¯æ€»æ•°ï¼ˆè®¾ç½®max.poll.recordsçš„å€¼ï¼‰ï¼› ä¸‹æ¸¸ç³»ç»Ÿä½¿ç”¨å¤šçº¿ç¨‹åŠ é€Ÿæ¶ˆè´¹ï¼› ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:14:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 2ã€åœºæ™¯äºŒâ€‹ Standalone Consumeråœ¨æ¶ˆè´¹æ—¶ä¹Ÿéœ€è¦æŒ‡å®šgroud.idï¼Œå¦‚æœå‡ºç°äº†ä¸€ä¸ªç›¸åŒgroup.idçš„Consumer Groupï¼Œkafkaä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼›è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œç›®å‰æ²¡æœ‰è§£å†³åŠæ³•ï¼Œè¦å°½é‡å»é¿å…ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:14:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" 15ã€å¤šçº¿ç¨‹â€‹ kafka 0.10.1.0ç‰ˆæœ¬å¼€å§‹ï¼ŒKafkaConsumerå°±æ˜¯åŒçº¿ç¨‹è®¾è®¡ï¼Œå³ç”¨æˆ·ä¸»çº¿ç¨‹å’Œå¿ƒè·³çº¿ç¨‹ï¼›ç”¨æˆ·ä¸»çº¿ç¨‹å°±æ˜¯å¯åŠ¨Consumeråº”ç”¨ç¨‹åºmainæ–¹æ³•çš„é‚£ä¸ªç¨‹åºï¼Œå¿ƒè·³çº¿ç¨‹åªè´Ÿè´£å®šæœŸç»™å¯¹åº”çš„çš„Brokeræœºå™¨å‘é€å¿ƒè·³è¯·æ±‚ï¼Œä»¥æ ‡è¯†æ¶ˆè´¹è€…åº”ç”¨çš„å­˜æ´»æ€§ã€‚æ‰€ä»¥åœ¨æ¶ˆè´¹å±‚é¢ä¸Šï¼ŒConsumerä¾ç„¶æ˜¯å•çº¿ç¨‹è®¾è®¡ã€‚ å¤šçº¿ç¨‹æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼š â€‹ æ¶ˆè´¹è€…ç¨‹åºå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸“å±çš„KafkaConsumerå®ä¾‹ï¼Œè´Ÿè´£å®Œæ•´çš„æ¶ˆæ¯è·å–å’Œæ¶ˆæ¯å¤„ç†æµç¨‹ï¼› ä¼˜ç‚¹ï¼š å®ç°èµ·æ¥ç®€å•ï¼› çº¿ç¨‹ä¹‹é—´æ²¡æœ‰äº¤äº’ï¼Œçœå»ä¿éšœçº¿ç¨‹å®‰å…¨çš„å¼€é”€ï¼› ç”±äºæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ä¸“å±çš„Consumerå®ä¾‹æ‰§è¡Œæ¶ˆæ¯è·å–å’Œæ¶ˆæ¯å¤„ç†ï¼Œå¯ä»¥ä¿è¯åˆ†åŒºå†…çš„æ¶ˆè´¹é¡ºåºï¼› ç¼ºç‚¹ï¼š ç”±äºæ¯ä¸ªçº¿ç¨‹è¦ç»´æŠ¤è‡ªå·±çš„Consumerå®ä¾‹ï¼Œä¼šå ç”¨å¾ˆå¤šç³»ç»Ÿèµ„æºï¼› çº¿ç¨‹æ•°å—é™äºConsumerè®¢é˜…ä¸»é¢˜çš„æ€»åˆ†åŒºæ•°ï¼› å¦‚æœ‰æŸä¸ªçº¿ç¨‹å¤„ç†è¾ƒæ…¢ï¼Œä¼šé€ æˆrebalanceï¼› å®ç°ä»£ç å¦‚ä¸‹ï¼š public class KafkaConsumerRunner implements Runnable { private final AtomicBoolean closed = new AtomicBoolean(false); private final KafkaConsumer consumer; public void run() { try { consumer.subscribe(Arrays.asList(\"topic\")); while (!closed.get()) { ConsumerRecords records = consumer.poll(Duration.ofMillis(10000)); // æ‰§è¡Œæ¶ˆæ¯å¤„ç†é€»è¾‘ ... } } catch (WakeupException e) { // Ignore exception if closing if (!closed.get()) throw e; } finally { consumer.close(); } } // Shutdown hook which can be called from a separate thread public void shutdown() { closed.set(true); consumer.wakeup(); } } æ–¹æ¡ˆäºŒï¼š â€‹ æ¶ˆè´¹è€…ç¨‹åºä½¿ç”¨å•æˆ–å¤šçº¿ç¨‹è·å–æ¶ˆæ¯ï¼ŒåŒæ—¶åˆ›å»ºå¤šä¸ªæ¶ˆè´¹çº¿ç¨‹æ‰§è¡Œæ¶ˆæ¯å¤„ç†é€»è¾‘ï¼› ä¼˜ç‚¹ï¼š é«˜ä¼¸ç¼©æ€§ï¼Œè‡ªç”±è°ƒèŠ‚æ¶ˆæ¯è·å–å’Œæ¶ˆæ¯å¤„ç†çš„çº¿ç¨‹æ•°ï¼› ç¼ºç‚¹ï¼š å®ç°éš¾åº¦å¤§ï¼› ç”±äºæ¶ˆæ¯è·å–å’Œæ¶ˆæ¯å¤„ç†è§£è€¦ï¼Œä¼šç ´åæ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„é¡ºåºï¼› ä¼šä½¿å¾—æ•´ä¸ªæ¶ˆæ¯æ¶ˆè´¹é“¾è·¯è¢«æ‹‰é•¿ï¼Œä½ç§»æäº¤å¯èƒ½ä¼šå‡ºé”™ï¼Œå¯¼è‡´é‡å¤æ¶ˆè´¹ï¼› private final KafkaConsumer\u003cString, String\u003e consumer; private ExecutorService executors; ... private int workerNum = ...; executors = new ThreadPoolExecutor( workerNum, workerNum, 0L, TimeUnit.MILLISECONDS, new ArrayBlockingQueue\u003c\u003e(1000), new ThreadPoolExecutor.CallerRunsPolicy() ); ... while (true) { ConsumerRecords\u003cString, String\u003e records = consumer.poll(Duration.ofSeconds(1)); for (final ConsumerRecord record : records) { executors.submit(new Worker(record)); } } .. ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/04/:15:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/04/"},{"categories":null,"content":" Java æ ¸å¿ƒæŠ€æœ¯ 36è®²01ã€è°ˆè°ˆä½ å¯¹ Java çš„ç†è§£ 02ã€Exception å’Œ Error çš„åŒºåˆ« 03ã€finalã€finallyã€finalize çš„åŒºåˆ« ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/java-core-36/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/java-core-36/readme/"},{"categories":null,"content":" 1ã€Kafka æ˜¯ä¸€æ¬¾æ¶ˆæ¯å¼•æ“ç³»ç»Ÿ æ¶ˆæ¯å¼•æ“ç³»ç»Ÿæ˜¯ä¸€ç»„è§„èŒƒã€‚ä¼ä¸šåˆ©ç”¨è¿™ç»„è§„èŒƒåœ¨ä¸åŒç³»ç»Ÿä¹‹é—´ä¼ é€’è¯­ä¹‰å‡†ç¡®çš„æ¶ˆæ¯ï¼Œå®ç°æ¾è€¦åˆçš„å¼‚æ­¥å¼æ•°æ®ä¼ é€’ã€‚ Kafka çš„æ¶ˆæ¯ç¼–ç æ ¼å¼æ˜¯ äºŒè¿›åˆ¶çš„å­—èŠ‚åºåˆ— Kafka æ”¯æŒçš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ ç‚¹å¯¹ç‚¹æ¨¡å‹ï¼Œç³»ç»Ÿ A å‘é€çš„æ¶ˆæ¯åªèƒ½è¢« B ç³»ç»Ÿæ¶ˆè´¹ï¼Œå…¶ä»–ç³»ç»Ÿä¸èƒ½è¯»å– A ç³»ç»Ÿå‘é€çš„æ¶ˆæ¯ï¼Œä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ å‘å¸ƒ / è®¢é˜…æ¨¡å‹ï¼Œæœ‰ Topicï¼ˆä¸»é¢˜ï¼‰ã€Producerï¼ˆç”Ÿäº§è€…ï¼‰ã€Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰çš„æ¦‚å¿µï¼Œå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ª Producer å‘ Topic å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨å¤šä¸ª Consumer æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¤šå¯¹å¤šçš„å…³ç³»ã€‚ æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜ç‚¹ï¼šè§£è€¦ã€å¼‚æ­¥ã€å‰Šå³° ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/01/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/01/"},{"categories":null,"content":" 1ã€Kafka æœ¯è¯­","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Recordï¼ˆæ¶ˆæ¯ï¼‰Kafka å¤„ç†çš„ä¸»è¦å¯¹è±¡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Topicï¼ˆä¸»é¢˜ï¼‰ä¸»é¢˜æ˜¯æ‰¿è½½æ¶ˆæ¯çš„é€»è¾‘å®¹å™¨ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¤šç”¨æ¥åŒºåˆ†å…·ä½“çš„ä¸šåŠ¡ã€‚ ä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸šåŠ¡ã€æ¯ä¸ªåº”ç”¨ç”šè‡³æ˜¯æ¯ç±»æ•°æ®éƒ½åˆ›å»ºä¸“å±çš„ä¸»é¢˜ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Partitionï¼ˆåˆ†åŒºï¼‰ä¸€ä¸ªæœ‰åºä¸å˜çš„æ¶ˆæ¯åºåˆ—ã€‚æ¯ä¸ªä¸»é¢˜ä¸‹å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Offsetï¼ˆæ¶ˆæ¯ä½ç§»ï¼‰åˆ†åŒºä¸­æ¯æ¡æ¶ˆæ¯çš„ä½ç½®ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢ä¸”ä¸å˜çš„å€¼ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Producerï¼ˆç”Ÿäº§è€…ï¼‰å‘ä¸»é¢˜å‘å¸ƒæ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ä»ä¸»é¢˜è®¢é˜…æ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:6","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Consumer Offsetï¼ˆæ¶ˆè´¹è€…ä½ç§»ï¼‰æ¶ˆè´¹è€…æ¶ˆè´¹è¿›åº¦ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„æ¶ˆè´¹è€…ä½ç§»ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:7","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å…±åŒç»„æˆçš„ä¸€ä¸ªç»„ï¼ŒåŒæ—¶æ¶ˆè´¹å¤šä¸ªåˆ†åŒºä»¥å®ç°é«˜ååã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:8","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" Rebalance ï¼ˆé‡å¹³è¡¡ï¼‰æ¶ˆè´¹è€…ç»„å†…æŸä¸ªæ¶ˆè´¹è€…å®ä¾‹æŒ‚æ‰åï¼Œå…¶ä»–æ¶ˆè´¹è€…å®ä¾‹è‡ªåŠ¨é‡æ–°åˆ†é…è®¢é˜…ä¸»é¢˜åˆ†åŒºçš„è¿‡ç¨‹ã€‚ Rebalance æ˜¯ Kafka æ¶ˆè´¹è€…ç«¯å®ç°é«˜å¯ç”¨çš„é‡è¦æ‰‹æ®µã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:1:9","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" 2ã€Kafka ä¸‰å±‚æ¶ˆæ¯æ¶æ„ ç¬¬ä¸€å±‚æ˜¯ä¸»é¢˜å±‚ï¼Œæ¯ä¸ªä¸»é¢˜å¯ä»¥é…ç½® M ä¸ªåˆ†åŒºï¼Œè€Œæ¯ä¸ªåˆ†åŒºåˆå¯ä»¥é…ç½® N ä¸ªå‰¯æœ¬ã€‚ ç¬¬äºŒå±‚æ˜¯åˆ†åŒºå±‚ï¼Œæ¯ä¸ªåˆ†åŒºçš„ N ä¸ªå‰¯æœ¬ä¸­åªèƒ½æœ‰ä¸€ä¸ªå……å½“é¢†å¯¼è€…è§’è‰²ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼›å…¶ä»– N-1 ä¸ªå‰¯æœ¬æ˜¯è¿½éšè€…å‰¯æœ¬ï¼Œåªæ˜¯æä¾›æ•°æ®å†—ä½™ä¹‹ç”¨ã€‚ ç¬¬ä¸‰å±‚æ˜¯æ¶ˆæ¯å±‚ï¼Œåˆ†åŒºä¸­åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯çš„ä½ç§»ä» 0 å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ã€‚ æœ€åï¼Œå®¢æˆ·ç«¯ç¨‹åºåªèƒ½ä¸åˆ†åŒºçš„é¢†å¯¼è€…å‰¯æœ¬è¿›è¡Œäº¤äº’ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" 3ã€Kafka æŒä¹…åŒ–æ•°æ®Kafka ä½¿ç”¨æ¶ˆæ¯æ—¥å¿—ï¼ˆLogï¼‰æ¥ä¿å­˜æ•°æ®ï¼Œæ¶ˆæ¯æ—¥å¿—åªèƒ½è¿½åŠ å†™å…¥ï¼Œæ‰€ä»¥é¿å…äº†éšæœº I/O æ“ä½œï¼Œæ”¹ä¸ºæ€§èƒ½è¾ƒå¥½çš„é¡ºåº I/O å†™æ“ä½œã€‚ åœ¨ Kafka åº•å±‚ï¼Œä¸€ä¸ªæ—¥å¿—ä¼šç»†åˆ†æˆå¤šä¸ªæ—¥å¿—æ®µï¼Œæ¶ˆæ¯è¢«è¿½åŠ å†™åˆ°å½“å‰æœ€æ–°çš„æ—¥å¿—æ®µä¸­ï¼Œå½“å†™æ»¡äº†ä¸€ä¸ªæ—¥å¿—æ®µåï¼ŒKafka ä¼šè‡ªåŠ¨åˆ‡åˆ†å‡ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ®µï¼Œå¹¶å°†è€çš„æ—¥å¿—æ®µå°å­˜èµ·æ¥ã€‚Kafka åœ¨åå°è¿˜æœ‰å®šæ—¶ä»»åŠ¡ä¼šå®šæœŸåœ°æ£€æŸ¥è€çš„æ—¥å¿—æ®µæ˜¯å¦èƒ½å¤Ÿè¢«åˆ é™¤ï¼Œä»è€Œå®ç°å›æ”¶ç£ç›˜ç©ºé—´çš„ç›®çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/02/"},{"categories":null,"content":" 1ã€Kafka æ˜¯åˆ†å¸ƒå¼æµå¤„ç†å¹³å° Apache Kafka æ˜¯æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ã€‚ Kafka çš„ç‰¹æ€§ï¼š æä¾›ä¸€å¥— API å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚ é™ä½ç½‘ç»œä¼ è¾“å’Œç£ç›˜å­˜å‚¨å¼€é”€ã€‚ å®ç°é«˜ä¼¸ç¼©æ€§æ¶æ„ã€‚ å¯ä»¥å®ç°ç«¯åˆ°ç«¯çš„ç²¾ç¡®ä¸€æ¬¡å¤„ç†è¯­ä¹‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/03/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/03/"},{"categories":null,"content":" 1ã€Kafka ä¸åŒçš„\"å‘è¡Œç‰ˆ\"","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/"},{"categories":null,"content":" 1ã€Apache Kafkaåªæä¾›æœ€åŸºç¡€çš„ç»„ä»¶ï¼Œæ²¡æœ‰ä»»ä½•ç›‘æ§æ¡†æ¶æˆ–å·¥å…·ã€‚ å¦‚æœä½ ä»…ä»…éœ€è¦ä¸€ä¸ªæ¶ˆæ¯å¼•æ“ç³»ç»Ÿäº¦æˆ–æ˜¯ç®€å•çš„æµå¤„ç†åº”ç”¨åœºæ™¯ï¼ŒåŒæ—¶éœ€è¦å¯¹ç³»ç»Ÿæœ‰è¾ƒå¤§æŠŠæ§åº¦ï¼Œé‚£ä¹ˆæˆ‘æ¨èä½ ä½¿ç”¨ Apache Kafkaã€‚ ä¼˜åŠ¿åœ¨äºè¿­ä»£é€Ÿåº¦å¿«ï¼Œç¤¾åŒºå“åº”åº¦é«˜ï¼Œä½¿ç”¨å®ƒå¯ä»¥è®©ä½ æœ‰æ›´é«˜çš„æŠŠæ§åº¦ï¼›ç¼ºé™·åœ¨äºä»…æä¾›åŸºç¡€æ ¸å¿ƒç»„ä»¶ï¼Œç¼ºå¤±ä¸€äº›é«˜çº§çš„ç‰¹æ€§ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/"},{"categories":null,"content":" 2ã€Confluent Kafkaåˆ†ä¸ºå…è´¹ç‰ˆå’Œä¼ä¸šç‰ˆã€‚ å…è´¹ç‰ˆåŒ…å« Schema æ³¨å†Œä¸­å¿ƒå’Œ REST proxy ä¸¤å¤§åŠŸèƒ½ã€‚å‰è€…æ˜¯å¸®åŠ©ä½ é›†ä¸­ç®¡ç† Kafka æ¶ˆæ¯æ ¼å¼ä»¥å®ç°æ•°æ®å‰å‘ / åå‘å…¼å®¹ï¼›åè€…ç”¨å¼€æ”¾ HTTP æ¥å£çš„æ–¹å¼å…è®¸ä½ é€šè¿‡ç½‘ç»œè®¿é—® Kafka çš„å„ç§åŠŸèƒ½ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯ Apache Kafka æ‰€æ²¡æœ‰çš„ã€‚ ä¼ä¸šç‰ˆåŒ…å«è·¨æ•°æ®ä¸­å¿ƒå¤‡ä»½å’Œé›†ç¾¤ç›‘æ§ä¸¤å¤§åŠŸèƒ½ã€‚ ä¼˜åŠ¿åœ¨äºé›†æˆäº†å¾ˆå¤šé«˜çº§ç‰¹æ€§ä¸”ç”± Kafka åŸç­äººé©¬æ‰“é€ ï¼Œè´¨é‡ä¸Šæœ‰ä¿è¯ï¼›ç¼ºé™·åœ¨äºç›¸å…³æ–‡æ¡£èµ„æ–™ä¸å…¨ï¼Œæ™®åŠç‡è¾ƒä½ï¼Œæ²¡æœ‰å¤ªå¤šå¯ä¾›å‚è€ƒçš„èŒƒä¾‹ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/"},{"categories":null,"content":" 3ã€Cloudera/Hortonworks Kafkaå¤§æ•°æ®äº‘å…¬å¸å‘å¸ƒçš„ Kafkaï¼ˆCDH/HDP Kafkaï¼‰ã€‚è¿™äº›å¤§æ•°æ®å¹³å°å¤©ç„¶é›†æˆäº† Apache Kafkaï¼Œé€šè¿‡ä¾¿æ·åŒ–çš„ç•Œé¢æ“ä½œå°† Kafka çš„å®‰è£…ã€è¿ç»´ã€ç®¡ç†ã€ç›‘æ§å…¨éƒ¨ç»Ÿä¸€åœ¨æ§åˆ¶å°ä¸­ã€‚ å¦‚æœä½ éœ€è¦å¿«é€Ÿåœ°æ­å»ºæ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œæˆ–è€…ä½ éœ€è¦æ­å»ºçš„æ˜¯å¤šæ¡†æ¶æ„æˆçš„æ•°æ®å¹³å°ä¸” Kafka åªæ˜¯å…¶ä¸­ä¸€ä¸ªç»„ä»¶ï¼Œé‚£ä¹ˆæˆ‘æ¨èä½ ä½¿ç”¨è¿™äº›å¤§æ•°æ®äº‘å…¬å¸æä¾›çš„ Kafkaã€‚ ä¼˜åŠ¿åœ¨äºæ“ä½œç®€å•ï¼ŒèŠ‚çœè¿ç»´æˆæœ¬ï¼›ç¼ºé™·åœ¨äºæŠŠæ§åº¦ä½ï¼Œæ¼”è¿›é€Ÿåº¦è¾ƒæ…¢ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/04/"},{"categories":null,"content":" 1ã€Kafka çš„ç‰ˆæœ¬ [scala-version] - [kafka-version].tar.gz 0.10.0.0 å¼•è¿› Kafka Stream 0.11.0.0 æ·»åŠ å¹‚ç­‰æ€§ Producer å’Œäº‹åŠ¡ APIï¼Œå¹¶å¯¹ Kafka æ¶ˆæ¯æ ¼å¼è¿›è¡Œé‡æ„ æ€»ç»“ï¼š å¦‚æœåªä½¿ç”¨ Kafka çš„æ¶ˆæ¯å¼•æ“åŠŸèƒ½ï¼Œ æœ€å°‘ 0.10.2.2ï¼Œ å¯ä»¥ä½¿ç”¨æ–°ç‰ˆçš„ Consumer APIã€‚ å¦‚æœä½¿ç”¨ Kafka Streamï¼Œæœ€å°‘ 2.0.0ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/05/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/05/"},{"categories":null,"content":" 1ã€æ“ä½œç³»ç»Ÿä¸‰ä¸ªæ–¹é¢é€‰æ‹©ï¼š I/O æ¨¡å‹çš„ä½¿ç”¨ æ•°æ®ç½‘ç»œä¼ è¾“æ•ˆç‡ ç¤¾åŒºæ”¯æŒåº¦ äº”ç§ I/O æ¨¡å‹ï¼šé˜»å¡å¼ I/Oã€éé˜»å¡å¼ I/Oã€I/O å¤šè·¯å¤ç”¨ã€ä¿¡å·é©±åŠ¨ I/O å’Œå¼‚æ­¥ I/Oã€‚ Linux ä¸­çš„ç³»ç»Ÿè°ƒç”¨ select å‡½æ•°å°±å±äº I/O å¤šè·¯å¤ç”¨æ¨¡å‹ï¼›epoll ç³»ç»Ÿè°ƒç”¨åˆ™ä»‹äºç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ¨¡å‹ä¹‹é—´ã€‚ Linux è¿˜å¯ä»¥ä½¿ç”¨ zero copyã€‚ æ€»ç»“ï¼› é«˜æ€§èƒ½åªèƒ½é€‰æ‹© linuxã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/"},{"categories":null,"content":" 2ã€ç£ç›˜æ€»ç»“ï¼š è¿½æ±‚æ€§ä»·æ¯”çš„å…¬å¸å¯ä»¥ä¸æ­å»º RAIDã€‚ ä½¿ç”¨æœºæ¢°ç£ç›˜å®Œå…¨èƒ½å¤Ÿèƒœä»» Kafka çº¿ä¸Šç¯å¢ƒã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/"},{"categories":null,"content":" 3ã€ç£ç›˜å®¹é‡è§„åˆ’ç£ç›˜å®¹é‡çš„æ€è€ƒå› ç´ ï¼š æ–°å¢æ¶ˆæ¯æ•° æ¶ˆæ¯ç•™å­˜æ—¶é—´ å¹³å‡æ¶ˆæ¯å¤§å° å¤‡ä»½æ•° æ˜¯å¦å¯ç”¨å‹ç¼© ä¾‹å¦‚ï¼š æ¯ä¸€å¤© 1 äº¿æ¡ 1KB å¤§å°çš„æ¶ˆæ¯ï¼Œä¿å­˜ä¸¤ä»½ä¸”å­˜ç•™ä¸¤å‘¨çš„æ—¶é—´ã€‚ ä¸€å¤©æ•°æ®å¤§å°ï¼š 1 äº¿ * 1 KB * 2 ä»½ / 1000 / 1000 = 200 GB é¢„ç•™ 10% çš„ç£ç›˜ç©ºé—´ï¼š 200 GB * 1.1 = 220 GB ä¸¤å‘¨æ—¶é—´ï¼š 220 GB * 14 = 3 TB å¼€å¯äº†å‹ç¼©æ¯”ï¼Œæ¯”å¦‚ 0.75ï¼š 3 TB * 0.75 = 2.25 TB ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/"},{"categories":null,"content":" 4ã€å¸¦å®½ä»¥ 1Gbps çš„åƒå…†ç½‘ç»œä¸ºä¾‹ï¼Œ åœ¨ 1 å°æ—¶å†…å¤„ç† 1TB çš„ä¸šåŠ¡æ•°æ®ï¼Œéœ€è¦æœºå™¨æ•°ï¼Ÿ å¸¦å®½æ˜¯ 1Gbpsï¼Œå³æ¯ç§’å¤„ç† 1Gb çš„æ•°æ®ï¼Œé€šå¸¸å‡è®¾ Kafka åªèƒ½ç”¨åˆ° 70% çš„å¸¦å®½èµ„æºï¼Œæ¯•ç«Ÿå…¶ä»–è¿›ç¨‹ä¹Ÿéœ€è¦ä¸€äº›èµ„æºï¼Œä¹Ÿå°±æ˜¯Kafka æœ€å¤§åªèƒ½ä½¿ç”¨ 700MB çš„å¸¦å®½èµ„æºï¼Œå¸¸è§„æ€§ä½¿ç”¨è¦é¢„ç•™ 2/3ï¼Œæ‰€ä»¥å•å° Kafka ä½¿ç”¨çš„å¸¦å®½ä¸º 700 Mb / 3 = 240 Mbpsã€‚ 1 ä¸ªå°æ—¶å¤„ç† 1TB æ•°æ®ï¼Œ 1024 * 1024 / 3600 / (240 / 8) = 9.7 (æ³¨æ„ 240 Mbps æ˜¯å¸¦å®½ï¼Œå˜ä¸º MB å•ä½æ—¶ï¼Œè¦é™¤ä»¥ 8)ã€‚ å¦‚æœæ¶ˆæ¯çš„å‰¯æœ¬æ•°ä¸º 3ï¼Œå¤§çº¦å°±æ˜¯ 30 å°æœºå™¨ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/06/"},{"categories":null,"content":" 1ã€Broker ç«¯å‚æ•°","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 1ã€broker å­˜å‚¨ä¿¡æ¯ log.dirs: æ—¥å¿—ç›®å½•ï¼Œä¾‹å¦‚ /home/kafka1,/home/kafka2,/home/kafka3ã€‚ log.dir: åªéœ€è¦è®¾ç½®å‚æ•°log.dirsï¼Œæ­¤å‚æ•°ä¸éœ€è¦ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 2ã€zk ä¿¡æ¯ zookeeper.connect: è¿æ¥ zk çš„å‚æ•°ï¼Œä¾‹å¦‚ zk1:2181,zk2:2181,zk3:2181ã€‚ å¦‚æœè®©å¤šä¸ª Kafka é›†ç¾¤ä½¿ç”¨åŒä¸€å¥— zk é›†ç¾¤ï¼Œåˆ©ç”¨ zk çš„ chroot è®¾ç½®ï¼Œä¾‹å¦‚ zookeeper.connect å¯ä»¥è®¾ç½®ä¸º zk1:2181,zk2:2181,zk3:2181/kafka1 å’Œ zk1:2181,zk2:2181,zk3:2181/kafka2ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 3ã€broker è¿æ¥ä¿¡æ¯ listeners: ç›‘å¬å™¨ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä»€ä¹ˆåè®®è®¿é—®æŒ‡å®šä¸»æœºåå’Œç«¯å£å¼€æ”¾çš„ Kafka æœåŠ¡ã€‚ advertised.listeners: Broker ç”¨äºå¯¹å¤–å‘å¸ƒçš„ç›‘å¬å™¨ã€‚ ç›‘å¬å™¨é…ç½®ï¼Œç”±ä¸‰å…ƒç»„ \u003cåè®®åç§°ï¼Œä¸»æœºåï¼Œç«¯å£å·\u003e æ„æˆï¼Œä¾‹å¦‚ä½ è‡ªå·±å®šä¹‰çš„åè®®åå­— CONTROLLER://localhost:9092ã€‚ ä¸€æ—¦ä½ è‡ªå·±å®šä¹‰äº†åè®®åç§°ï¼Œä½ å¿…é¡»è¿˜è¦æŒ‡å®š listener.security.protocol.map å‚æ•°å‘Šè¯‰è¿™ä¸ªåè®®åº•å±‚ä½¿ç”¨äº†å“ªç§å®‰å…¨åè®®ï¼Œæ¯”å¦‚æŒ‡å®š listener.security.protocol.map=CONTROLLER:PLAINTEXT è¡¨ç¤º CONTROLLER è¿™ä¸ªè‡ªå®šä¹‰åè®®åº•å±‚ä½¿ç”¨æ˜æ–‡ä¸åŠ å¯†ä¼ è¾“æ•°æ®ã€‚ host.name/port: è¿‡æœŸã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 4ã€topic ç®¡ç† auto.create.topics.enable: æ˜¯å¦å…è®¸è‡ªåŠ¨åˆ›å»º Topic, å»ºè®®ä¸º falseã€‚ unclean.leader.election.enableï¼š æ˜¯å¦å…è®¸ Unclean Leader é€‰ä¸¾ï¼Œ å»ºè®®ä¸º falseã€‚ Unclean Leader é€‰ä¸¾ï¼ŒæŒ‡çš„æ˜¯è½åå¤ªå¤šçš„å‰¯æœ¬å‚ä¸é€‰ä¸¾ï¼Œå¯èƒ½ä¼šä½¿æ•°æ®ä¸¢å¤±ã€‚ auto.leader.rebalance.enable: æ˜¯å¦å…è®¸å®šæœŸè¿›è¡Œ Leader é€‰ä¸¾ï¼Œå»ºè®®ä¸º falseã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 5ã€æ•°æ®ç•™å­˜ log.retention.{hour|minutes|ms}: æ—¥å¿—ä¿ç•™æ—¶é—´ã€‚ä¾‹å¦‚ log.retention.hour=168 è¡¨ç¤ºé»˜è®¤ä¿å­˜ 7 å¤©çš„æ•°æ®ã€‚ log.retention.bytes: æ¶ˆæ¯ä¿å­˜çš„æ€»ç£ç›˜å®¹é‡å¤§å°ã€‚é»˜è®¤ä¸º -1ï¼Œè¡¨ç¤ºå®¹é‡æ— é™åˆ¶ï¼Œåœ¨äº‘ä¸Šçš„å¤šç§Ÿæˆ·æ‰ç”¨åˆ°æ­¤å‚æ•°ã€‚ message.max.bytes: æœ€å¤§æ¶ˆæ¯å¤§å°ã€‚å®é™…ä¸Šï¼Œ1MB çš„æ¶ˆæ¯å¾ˆå¸¸è§ã€‚ æ³¨æ„ï¼šä¸Šè¿°çš„å‚æ•°éƒ½ä¸èƒ½ä½¿ç”¨é»˜è®¤å€¼ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/:1:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/07/"},{"categories":null,"content":" 1ã€Topic çº§åˆ«å‚æ•°å¦‚æœåŒæ—¶è®¾ç½®äº† Topic çº§åˆ«å‚æ•°å’Œå…¨å±€ Broker å‚æ•°ï¼ŒTopic çº§åˆ«å‚æ•°ä¼šè¦†ç›–å…¨å±€ Broker å‚æ•°çš„å€¼ï¼Œè€Œæ¯ä¸ª Topic éƒ½èƒ½è®¾ç½®è‡ªå·±çš„å‚æ•°å€¼ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ Topic çº§åˆ«å‚æ•°ã€‚ retention.ms: è¯¥ Topic æ¶ˆæ¯è¢«ä¿å­˜çš„æ—¶é•¿ï¼Œä¼šè¦†ç›–æ‰ Broker ç«¯çš„å…¨å±€å‚æ•°å€¼ã€‚ retention.bytes: è¯¥ Topic é¢„ç•™å¤šå¤§çš„ç£ç›˜ç©ºé—´ï¼Œå½“å‰é»˜è®¤å€¼æ˜¯ -1ï¼Œè¡¨ç¤ºå¯ä»¥æ— é™ä½¿ç”¨ç£ç›˜ç©ºé—´ï¼Œåœ¨å¤šç§Ÿæˆ·çš„ Kafka é›†ç¾¤ä¸­ç”¨åˆ°ã€‚ max.message.bytes: Topic çš„æœ€å¤§æ¶ˆæ¯å¤§å°ã€‚ Topic è®¾ç½®æ–¹å¼ï¼ˆğŸ‰Kafkaå®˜æ–¹æ–‡æ¡£ğŸ‰ï¼‰ï¼š åˆ›å»º Topic æ—¶è®¾ç½® â€“config åé¢æŒ‡å®šäº†æƒ³è¦è®¾ç½®çš„ Topic çº§åˆ«å‚æ•°ã€‚ bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic my-topic --partitions 1 --replication-factor 1 --config retention.ms=15552000000 --config max.message.bytes=5242880 ä¿®æ”¹ Topic æ—¶è®¾ç½® bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --entity-name my-topic --alter --add-config max.message.bytes=10485760 ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/"},{"categories":null,"content":" 2ã€JVM å‚æ•°Java7 ä¸­ï¼Œå¦‚æœ Broker æ‰€åœ¨æœºå™¨çš„ CPU èµ„æºéå¸¸å……è£•ï¼Œåˆ™å»ºè®®å¼€å¯ CMS åƒåœ¾å›æ”¶å™¨, -XX:+UseCurrentMarkSweepGCã€‚å¦åˆ™ï¼Œä½¿ç”¨ååé‡æ”¶é›†å™¨ã€‚å¼€å¯æ–¹æ³•æ˜¯æŒ‡å®š -XX:+UseParallelGCã€‚ Java8 ä¸­ï¼Œå»ºè®®ä½¿ç”¨ G1 åƒåœ¾å›æ”¶å™¨ã€‚ å»ºè®®ä½¿ç”¨ Java8ã€‚ KAFKA_HEAP_OPTS: å †å¤§å°, å»ºè®®ä¸º 6GBï¼Œè¿™æ˜¯æ¯”è¾ƒå…¬è®¤çš„åˆç†å€¼ã€‚ KAFKA_JVM_PERFORMANCE_OPTS: æŒ‡å®š GC å‚æ•°ã€‚ æ¯”å¦‚ä½ å¯ä»¥è¿™æ ·å¯åŠ¨ Kafkaï¼š export KAFKA_HEAP_OPTS=--Xms6g --Xmx6g export KAFKA_JVM_PERFORMANCE_OPTS= -server -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+ExplicitGCInvokesConcurrent -Djava.awt.headless=true bin/kafka-server-start.sh config/server.properties ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/"},{"categories":null,"content":" 3ã€æ“ä½œç³»ç»Ÿå‚æ•°ä¸»è¦ç³»ç»Ÿå‚æ•°ï¼š æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ æ‰§è¡Œå‘½ä»¤ ulimit -n 1000000 æ¥è®¾ç½®ã€‚ æ–‡ä»¶ç³»ç»Ÿç±»å‹ XFS çš„æ€§èƒ½è¦å¼ºäº ext4ã€‚ Swappiness å°† swap äº¤æ¢å†…å­˜é…ç½®æˆä¸€ä¸ªæ¥è¿‘ 0 ä½†ä¸ä¸º 0 çš„å€¼ï¼Œæ¯”å¦‚ 1ã€‚ æäº¤æ—¶é—´ å‘ Kafka å‘é€æ•°æ®å¹¶ä¸æ˜¯çœŸè¦ç­‰æ•°æ®è¢«å†™å…¥ç£ç›˜æ‰ä¼šè®¤ä¸ºæˆåŠŸï¼Œè€Œæ˜¯åªè¦æ•°æ®è¢«å†™å…¥åˆ°æ“ä½œç³»ç»Ÿçš„é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ä¸Šå°±å¯ä»¥äº†ï¼Œéšåæ“ä½œç³»ç»Ÿæ ¹æ® LRU ç®—æ³•ä¼šå®šæœŸå°†é¡µç¼“å­˜ä¸Šçš„\"è„\"æ•°æ®è½ç›˜åˆ°ç‰©ç†ç£ç›˜ä¸Šã€‚è¿™ä¸ªå®šæœŸå°±æ˜¯ç”±æäº¤æ—¶é—´æ¥ç¡®å®šçš„ï¼Œé»˜è®¤æ˜¯ 5 ç§’ã€‚ç”±äº Kafka çš„å¤šå‰¯æœ¬çš„å†—ä½™æœºåˆ¶ï¼Œå¯ä»¥ç¨å¾®æ‹‰å¤§æäº¤é—´éš”æ¥æé«˜æ€§èƒ½ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/08/"},{"categories":null,"content":" 1ã€ä¸ºä»€ä¹ˆåˆ†åŒºKafka çš„æ¶ˆæ¯ç»„ç»‡æ–¹å¼å®é™…ä¸Šæ˜¯ä¸‰çº§ç»“æ„ï¼šä¸»é¢˜ - åˆ†åŒº - æ¶ˆæ¯ï¼Œä¸»é¢˜ä¸‹çš„æ¯æ¡æ¶ˆæ¯åªä¼šä¿å­˜åœ¨æŸä¸€ä¸ªåˆ†åŒºä¸­ã€‚ Kafka çš„ä¸‰çº§ç»“æ„ï¼š åˆ†åŒºæ˜¯ä¸ºäº†å®ç°ç³»ç»Ÿçš„é«˜ä¼¸ç¼©æ€§ï¼ˆScalabilityï¼‰ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ æ–°çš„èŠ‚ç‚¹æ¥å¢åŠ æ•´ä½“ç³»ç»Ÿçš„ååé‡ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 2ã€åˆ†åŒºç­–ç•¥ æ‰€è°“åˆ†åŒºç­–ç•¥æ˜¯å†³å®šç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°å“ªä¸ªåˆ†åŒºçš„ç®—æ³•ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 1ã€è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ä½ éœ€è¦æ˜¾å¼åœ°é…ç½®ç”Ÿäº§è€…ç«¯çš„å‚æ•° partitioner.classï¼Œåœ¨ç¼–å†™ç”Ÿäº§è€…ç¨‹åºæ—¶ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªå…·ä½“çš„ç±»å®ç° org.apache.kafka.clients.producer.Partitioner æ¥å£ï¼Œå®ç° partition() å’Œ close() æ¥å£ã€‚ æ–¹æ³•ç­¾åï¼š int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster); ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 2ã€è½®è¯¢ç­–ç•¥ Kafka é»˜è®¤çš„åˆ†åŒºç­–ç•¥å°±æ˜¯è½®è¯¢ç­–ç•¥ï¼Œè½®è¯¢ç­–ç•¥æœ‰éå¸¸ä¼˜ç§€çš„è´Ÿè½½å‡è¡¡è¡¨ç°ï¼Œå®ƒæ€»æ˜¯èƒ½ä¿è¯æ¶ˆæ¯æœ€å¤§é™åº¦åœ°è¢«å¹³å‡åˆ†é…åˆ°æ‰€æœ‰åˆ†åŒºä¸Šã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 3ã€éšæœºç­–ç•¥ è¦å®ç°éšæœºç­–ç•¥ç‰ˆçš„ partition æ–¹æ³•(è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥)ï¼Œå¦‚ä¸‹ï¼š List\u003cPartitionInfo\u003e partitions = cluster.partitionsForTopic(topic); return ThreadLocalRandom.current().nextInt(partitions.size()); ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 4ã€æŒ‰æ¶ˆæ¯é”®ä¿åºç­–ç•¥ å®ç°è¿™ä¸ªç­–ç•¥çš„ partition æ–¹æ³•(è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥)ï¼Œå¦‚ä¸‹ï¼š List\u003cPartitionInfo\u003e partitions = cluster.partitionsForTopic(topic); return Math.abs(key.hashCode()) % partitions.size(); Kafka é»˜è®¤åˆ†åŒºç­–ç•¥å®é™…ä¸ŠåŒæ—¶å®ç°äº†ä¸¤ç§ç­–ç•¥ï¼šå¦‚æœæŒ‡å®šäº† Keyï¼Œé‚£ä¹ˆé»˜è®¤å®ç°æŒ‰æ¶ˆæ¯é”®ä¿åºç­–ç•¥ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®š Keyï¼Œåˆ™ä½¿ç”¨è½®è¯¢ç­–ç•¥ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 5ã€å…¶ä»–åˆ†åŒºç­–ç•¥æ¯”è¾ƒå¸¸è§çš„ä¸€ç§å°±æ˜¯åŸºäºåœ°ç†ä½ç½®çš„åˆ†åŒºç­–ç•¥ã€‚ æ¯”å¦‚æ ¹æ® Broker æ‰€åœ¨çš„ IP åœ°å€å®ç°å®šåˆ¶åŒ–çš„åˆ†åŒºç­–ç•¥ï¼Œå¦‚ä¸‹ï¼š List\u003cPartitionInfo\u003e partitions = cluster.partitionsForTopic(topic); return partitions.stream().filter(p -\u003e isSouth(p.leader().host())).map(PartitionInfo::partition).findAny().get(); æˆ‘ä»¬å¯ä»¥ä»æ‰€æœ‰åˆ†åŒºä¸­æ‰¾å‡ºé‚£äº› Leader å‰¯æœ¬åœ¨å—æ–¹çš„æ‰€æœ‰åˆ†åŒºï¼Œç„¶åéšæœºæŒ‘é€‰ä¸€ä¸ªè¿›è¡Œæ¶ˆæ¯å‘é€ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/:2:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/09/"},{"categories":null,"content":" 1ã€æ¶ˆæ¯æ ¼å¼Kafka çš„æ¶ˆæ¯æ ¼å¼ç›®å‰æœ‰ä¸¤ç§ï¼šV1 å’Œ V2ã€‚ ä¸è®ºæ˜¯å“ªä¸ªç‰ˆæœ¬ï¼ŒKafka çš„æ¶ˆæ¯å±‚æ¬¡éƒ½åˆ†ä¸ºä¸¤å±‚ï¼šæ¶ˆæ¯é›†åˆ(message set) å’Œ æ¶ˆæ¯(message)ã€‚ä¸€ä¸ªæ¶ˆæ¯é›†åˆåŒ…å«è‹¥å¹²æ¡æ—¥å¿—é¡¹(record item)ï¼Œæ—¥å¿—é¡¹ä¸­åŒ…å«å¤šæ¡æ¶ˆæ¯ã€‚ åœ¨ V1 ç‰ˆæœ¬ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½è¦æ‰§è¡Œ CRC æ ¡éªŒï¼Œä½†æœ‰äº›æƒ…å†µä¸‹æ¶ˆæ¯çš„ CRC å€¼æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„ã€‚æ¯”å¦‚åœ¨ Broker ç«¯å¯èƒ½ä¼šå¯¹æ¶ˆæ¯æ—¶é—´æˆ³å­—æ®µè¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…åœ¨æ‰§è¡Œæ¶ˆæ¯æ ¼å¼è½¬æ¢ï¼ˆå…¼å®¹è€ç‰ˆæœ¬å®¢æˆ·ç«¯ç¨‹åºï¼‰ã€‚å¯¹äºè¿™äº›æƒ…å†µï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æ‰§è¡Œ CRC æ ¡éªŒå°±æœ‰ç‚¹æ²¡å¿…è¦äº†ã€‚åœ¨ V2 ç‰ˆæœ¬ä¸­ï¼Œæ¶ˆæ¯çš„ CRC æ ¡éªŒå·¥ä½œå°±è¢«ç§»åˆ°äº†æ¶ˆæ¯é›†åˆè¿™ä¸€å±‚ã€‚ åœ¨ V1 ç‰ˆæœ¬ä¸­ï¼Œä¿å­˜å‹ç¼©æ¶ˆæ¯çš„æ–¹æ³•æ˜¯æŠŠå¤šæ¡æ¶ˆæ¯è¿›è¡Œå‹ç¼©ç„¶åä¿å­˜åˆ°å¤–å±‚æ¶ˆæ¯çš„æ¶ˆæ¯ä½“å­—æ®µä¸­ï¼›è€Œåœ¨ V2 ç‰ˆæœ¬ä¸­ï¼Œæ˜¯å¯¹æ•´ä¸ªæ¶ˆæ¯é›†åˆè¿›è¡Œå‹ç¼©ã€‚æ˜¾ç„¶åè€…åº”è¯¥æ¯”å‰è€…æœ‰æ›´å¥½çš„å‹ç¼©æ•ˆæœã€‚ åœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œä¸è®ºæ˜¯å¦å¯ç”¨å‹ç¼©ï¼ŒV2 ç‰ˆæœ¬éƒ½æ¯” V1 ç‰ˆæœ¬èŠ‚çœç£ç›˜ç©ºé—´ã€‚å½“å¯ç”¨å‹ç¼©æ—¶ï¼Œè¿™ç§èŠ‚çœç©ºé—´çš„æ•ˆæœæ›´åŠ æ˜æ˜¾ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/"},{"categories":null,"content":" 2ã€ä½•æ—¶å‹ç¼©åœ¨ Kafka ä¸­ï¼Œå‹ç¼©å¯èƒ½å‘ç”Ÿåœ¨ä¸¤ä¸ªåœ°æ–¹ï¼šç”Ÿäº§è€…ç«¯å’Œ Broker ç«¯ã€‚ Properties props = new Properties(); props.put(\"bootstrap.servers\", \"localhost:9092\"); props.put(\"compression.type\", \"gzip\"); Producer\u003cString, String\u003e producer = new KafkaProducer\u003c\u003e(props); ä¸Šè¿°ä»£ç ï¼Œè¡¨æ˜è¯¥ Producer çš„å‹ç¼©ç®—æ³•ä½¿ç”¨çš„æ˜¯ GZIPã€‚ ä½†æœ‰ä¸¤ç§ä¾‹å¤–æƒ…å†µè®© Broker é‡æ–°å‹ç¼©æ¶ˆæ¯ï¼š Broker ç«¯æŒ‡å®šäº†å’Œ Producer ç«¯ä¸åŒçš„å‹ç¼©ç®—æ³•ã€‚ Broker ç«¯å‘ç”Ÿäº†æ¶ˆæ¯æ ¼å¼è½¬æ¢ï¼ˆå…¼å®¹è€çš„å®¢æˆ·ç«¯ç¨‹åºï¼‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/"},{"categories":null,"content":" 3ã€ä½•æ—¶è§£å‹ç¼©ä¸€å¥è¯ï¼šProducer ç«¯å‹ç¼©ã€Broker ç«¯ä¿æŒã€Consumer ç«¯è§£å‹ç¼©ã€‚ é™¤äº†åœ¨ Consumer ç«¯è§£å‹ç¼©ï¼ŒBroker ç«¯ä¹Ÿä¼šè¿›è¡Œè§£å‹ç¼©ï¼Œç›®çš„æ˜¯ä¸ºäº†å¯¹æ¶ˆæ¯æ‰§è¡Œå„ç§éªŒè¯ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/"},{"categories":null,"content":" 4ã€å‹ç¼©ç®—æ³•å¯¹æ¯”åœ¨ Kafka 2.1.0 ç‰ˆæœ¬ä¹‹å‰ï¼ŒKafka æ”¯æŒ 3 ç§å‹ç¼©ç®—æ³•ï¼šGZIPã€Snappy å’Œ LZ4ã€‚ä» 2.1.0 å¼€å§‹ï¼ŒKafka æ­£å¼æ”¯æŒ Zstandard ç®—æ³•ï¼ˆzstdï¼‰ã€‚ å‹ç¼©ç®—æ³•æœ‰ä¸¤ä¸ªé‡è¦æŒ‡æ ‡ï¼šå‹ç¼©æ¯”ã€å‹ç¼©/è§£å‹ç¼©ååé‡ã€‚ ååé‡æ–¹é¢: LZ4 \u003e Snappy \u003e zstd å’Œ GZIPã€‚ å‹ç¼©æ¯”æ–¹é¢ï¼šzstd \u003e LZ4 \u003e GZIP \u003e Snappy æ€»ç»“ï¼š æœºå™¨çš„ CPU èµ„æºä¸å……è¶³ï¼Œä¸å»ºè®®å¼€å¯å‹ç¼©ï¼Œå› ä¸ºå‹ç¼©éœ€è¦æ¶ˆè€—å¤§é‡ CPUã€‚ æœºå™¨çš„ CPU èµ„æºå……è¶³ï¼Œå¼ºçƒˆå»ºè®®ä½ å¼€å¯ zstd å‹ç¼©ï¼Œè¿™æ ·èƒ½æå¤§åœ°èŠ‚çœç½‘ç»œèµ„æºæ¶ˆè€—ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/10/"},{"categories":null,"content":" Kafka æ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜01ã€æ¶ˆæ¯å¼•æ“ç³»ç»Ÿ 02ã€Kafka æœ¯è¯­ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/kafka-core-tech/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/kafka-core-tech/readme/"},{"categories":null,"content":" 1ã€MySQL çš„åŸºæœ¬æ¶æ„ ä¸»è¦åˆ†ä¸ºServerå±‚å’Œå­˜å‚¨å¼•æ“å±‚ã€‚ Serverå±‚åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›–MySQLçš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚ å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒ InnoDB ã€ MyISAM ã€ Memory ç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯ InnoDB ï¼Œå®ƒä» MySQL 5.5.5ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº†é»˜è®¤å­˜å‚¨å¼•æ“ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 2ã€æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 1ã€è¿æ¥å™¨è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥ã€‚ è¿æ¥å‘½ä»¤ï¼š mysql -h$ip -P$port -u$user -p å¦‚æœç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œè¿æ¥å™¨ä¼šåˆ°æƒé™è¡¨é‡Œé¢æŸ¥å‡ºä½ æ‹¥æœ‰çš„æƒé™ã€‚ è¿æ¥å®Œæˆåï¼Œå¦‚æœä½ æ²¡æœ‰åç»­çš„åŠ¨ä½œï¼Œè¿™ä¸ªè¿æ¥å°±å¤„äºç©ºé—²çŠ¶æ€ï¼ˆSleepï¼‰ï¼Œé€šè¿‡ show processlist å‘½ä»¤æŸ¥çœ‹å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯é•¿æ—¶é—´å¤„äº Sleep çŠ¶æ€ï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨å°†å®ƒæ–­å¼€ã€‚ç”±å‚æ•° wait_timeout æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼æ˜¯8å°æ—¶ã€‚ æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹é€šå¸¸æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ‰€ä»¥å°½é‡ä½¿ç”¨é•¿è¿æ¥ã€‚ ä½†å…¨éƒ¨ä½¿ç”¨é•¿è¿æ¥åï¼Œæœ‰äº›æ—¶å€™ MySQL å ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ«å¿«ï¼Œè¿™æ˜¯å› ä¸º MySQL åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ï¼Œè¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰ï¼ˆOOMï¼‰ï¼Œä»ç°è±¡çœ‹å°±æ˜¯ MySQL å¼‚å¸¸é‡å¯äº†ã€‚ é•¿è¿æ¥è§£å†³æ–¹æ¡ˆï¼š å®šæœŸæ–­å¼€é•¿è¿æ¥. åœ¨ MySQL 5.7 ç‰ˆæœ¬åï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connectionæ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºï¼Œ æ— éœ€é‡æ–°è¿æ¥å’Œæƒé™è®¤è¯ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 2ã€æŸ¥è¯¢ç¼“å­˜åªè¦å¯¹ä¸€ä¸ªè¡¨æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚ MySQL 8.0 ç¼“å­˜åŠŸèƒ½å·²ç»è¢«åˆ é™¤ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 3ã€åˆ†æå™¨å¯¹SQLè¯­å¥åšè§£æï¼Œè¯æ³•åˆ†æï¼ˆselectã€insertã€deleteã€updateï¼‰ã€è¯­æ³•åˆ†æï¼ˆè¯­æ³•æ˜¯å¦æ­£ç¡®ï¼‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 4ã€ä¼˜åŒ–å™¨ä¼˜åŒ–å™¨é€‰æ‹©ç´¢å¼•ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºä¸‹é¢çš„è¯­å¥ï¼Œæœ‰ä¸¤ç§æŸ¥è¯¢é€»è¾‘ï¼š mysql\u003e select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20; å…ˆä» t1 é‡Œé¢å–å‡º c = 10 çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ° t2ï¼Œå†åˆ¤æ–­ t2 é‡Œé¢ d çš„å€¼æ˜¯å¦ç­‰äº 20ã€‚ å…ˆä» t2 é‡Œé¢å–å‡º d = 20 çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ° t1ï¼Œå†åˆ¤æ–­ t1 é‡Œé¢ c çš„å€¼æ˜¯å¦ç­‰äº 10ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:4","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 5ã€æ‰§è¡Œå™¨å…ˆåˆ¤æ–­æŸ¥è¯¢æƒé™ï¼Œå¦‚æœæœ‰æƒé™ï¼Œæ‰§è¡Œå™¨å°±ä¼šè°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ¥å£ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:2:5","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 3ã€é—®é¢˜å¦‚æœä½ æ‰§è¡Œ select * from T where k=1ï¼ŒæŠ¥ä¸å­˜åœ¨ K è¿™ä¸€åˆ—ã€‚æ˜¯åœ¨å“ªä¸ªé˜¶æ®µæŠ¥å‡ºæ¥çš„ï¼Ÿ åˆ†æå™¨é˜¶æ®µ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/01/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/01/"},{"categories":null,"content":" 1ã€æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹åˆ›å»ºè¡¨ T: mysql\u003e create table T(ID int primary key, c int); å°† ID = 2 è¿™ä¸€è¡Œçš„å€¼åŠ  1 çš„ SQL è¯­å¥: mysql\u003e update T set c=c+1 where ID=2; æŸ¥è¯¢è¯­å¥çš„é‚£ä¸€å¥—æµç¨‹ï¼Œæ›´æ–°è¯­å¥ä¹Ÿæ˜¯åŒæ ·ä¼šèµ°ä¸€éã€‚ ç»è¿‡è¿æ¥å™¨å’ŒæŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œåˆ†æå™¨é€šè¿‡è¯æ³•å’Œè¯­æ³•åˆ†æçŸ¥é“è¿™æ˜¯ä¸€æ¡æ›´æ–°è¯­å¥ï¼Œä¼˜åŒ–å™¨å†³å®šè¦ä½¿ç”¨ ID è¿™ä¸ªç´¢å¼•ï¼Œæ‰§è¡Œå™¨è´Ÿè´£å…·ä½“æ‰§è¡Œï¼Œæ‰¾åˆ°è¿™ä¸€è¡Œï¼Œç„¶åæ›´æ–°ã€‚ ä¸æŸ¥è¯¢æµç¨‹ä¸ä¸€æ ·çš„æ˜¯ï¼Œæ›´æ–°æµç¨‹è¿˜æ¶‰åŠä¸¤ä¸ªé‡è¦çš„æ—¥å¿—æ¨¡å—ï¼š **redo logï¼ˆé‡åšæ—¥å¿—ï¼‰**å’Œ binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 2ã€redo logredo log æ˜¯ InnoDB å¼•æ“ç‰¹æœ‰çš„æ—¥å¿—æ¨¡å—ã€‚ åœ¨ MySQL ä¸­ï¼Œå¦‚æœæ¯ä¸€æ¬¡çš„æ›´æ–°æ“ä½œéƒ½éœ€è¦å†™è¿›ç£ç›˜ï¼Œç„¶åç£ç›˜ä¹Ÿè¦æ‰¾åˆ°å¯¹åº”çš„é‚£æ¡è®°å½•ï¼Œç„¶åå†æ›´æ–°ï¼Œæ•´ä¸ªè¿‡ç¨‹ IO æˆæœ¬ã€æŸ¥æ‰¾æˆæœ¬éƒ½å¾ˆé«˜ã€‚ä¸ºäº†æé«˜æ›´æ–°æ•ˆç‡ï¼ŒMySQL ä½¿ç”¨ WALï¼ˆWrite-Ahead Loggingï¼‰æŠ€æœ¯ï¼Œå®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ã€‚ å½“æœ‰è®°å½•éœ€è¦æ›´æ–°æ—¶ï¼ŒInnoDB å¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™æ—¶æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚åŒæ—¶ï¼ŒInnoDBå¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼ˆç³»ç»Ÿæ¯”è¾ƒç©ºé—²ï¼‰ï¼Œå°†è¿™ä¸ªè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ã€‚ InnoDBçš„ redo log æ˜¯å›ºå®šå¤§å°çš„ï¼Œæ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„ 4 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ 1GBï¼Œé‚£ä¹ˆæ€»å…±å¯ä»¥è®°å½• 4GB çš„æ“ä½œã€‚ä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾åˆå›åˆ°å¼€å¤´å¾ªç¯å†™ã€‚ write pos æ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åç§»ã€‚ checkpoint æ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œæ“¦é™¤è®°å½•å‰è¦æŠŠè®°å½•æ›´æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚ æœ‰äº† redo logï¼ŒInnoDB å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¹‹å‰æäº¤çš„è®°å½•éƒ½ä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¸º crash-safeã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 3ã€binlogbinlog æ˜¯ Sever å±‚çš„æ—¥å¿—æ¨¡å—ï¼Œåªèƒ½ç”¨äºå½’æ¡£ï¼Œæ¯”å¦‚ä¸»ä»å¤åˆ¶ã€‚ ä¸¤ç§æ—¥å¿—ä¸åŒï¼š redo log æ˜¯InnoDBå¼•æ“ç‰¹æœ‰çš„ï¼›binlogæ˜¯MySQLçš„Serverå±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ã€‚ redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼›binlog æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œæ¯”å¦‚â€œç»™ID=2è¿™ä¸€è¡Œçš„cå­—æ®µåŠ 1â€ã€‚ redo log æ˜¯å¾ªç¯å†™ï¼Œå†™åˆ°æœ«å°¾åˆå›åˆ°å¼€å¤´å†™ï¼›binlogæ˜¯è¿½åŠ å†™å…¥ï¼Œå†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œå¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 4ã€ä¸¤é˜¶æ®µæäº¤ä¸Šé¢ç®€å•çš„ updata è¯­å¥çš„æ‰§è¡Œæµç¨‹ã€‚ æ‰§è¡Œå™¨å…ˆæ‰¾å¼•æ“å– ID = 2 è¿™ä¸€è¡Œã€‚ID æ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœID=2 è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨ï¼›å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥å†…å­˜ï¼Œç„¶åå†è¿”å›ã€‚ æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯Nï¼Œç°åœ¨å°±æ˜¯N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œæ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®ã€‚ å¼•æ“å°†è¿™è¡Œæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ° redo log é‡Œé¢ï¼Œæ­¤æ—¶ redo log å¤„äº prepare çŠ¶æ€ã€‚ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚ æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶æŠŠ binlog å†™å…¥ç£ç›˜ã€‚ æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„ redo log æ”¹æˆ commit çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆã€‚ å¦‚æœä¸ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ å…ˆå†™ redo log åå†™ binlogã€‚å‡è®¾åœ¨ redo log å†™å®Œï¼Œbinlog è¿˜æ²¡æœ‰å†™å®Œçš„æ—¶å€™ï¼ŒMySQLè¿›ç¨‹å¼‚å¸¸é‡å¯ï¼Œbinlog ä¸­æ²¡æœ‰æ›´æ–°çš„æ•°æ®ã€‚ å…ˆå†™ binlog åå†™ redo logã€‚å¦‚æœåœ¨ binlog å†™å®Œä¹‹å crashï¼Œç”±äº redo log æ²¡æœ‰å†™ï¼Œå´©æºƒæ¢å¤ä»¥åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œæ‰€ä»¥è¿™ä¸€è¡Œ c çš„å€¼æ˜¯ 0ï¼Œä½† binlog ä¸­ c = 1 äº†ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 5ã€é…ç½®åŒ1è®¾ç½®ï¼š innodb_flush_log_at_trx_commit = 1 è¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„ redo log éƒ½ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™æ ·å¯ä»¥ä¿è¯ MySQL å¼‚å¸¸é‡å¯ä¹‹åæ•°æ®ä¸ä¸¢å¤±ã€‚ sync_binlog = 1 è¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„ binlog éƒ½æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™æ ·å¯ä»¥ä¿è¯ MySQL å¼‚å¸¸é‡å¯ä¹‹å binlog ä¸ä¸¢å¤±ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 6ã€é—®é¢˜åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä¸€å¤©ä¸€å¤‡ä¼šæ¯”ä¸€å‘¨ä¸€å¤‡æ›´æœ‰ä¼˜åŠ¿å‘¢ï¼Ÿ å¥½å¤„æ˜¯â€œæœ€é•¿æ¢å¤æ—¶é—´â€æ›´çŸ­ã€‚ åœ¨ä¸€å¤©ä¸€å¤‡çš„æ¨¡å¼é‡Œï¼Œæœ€åæƒ…å†µä¸‹éœ€è¦åº”ç”¨ä¸€å¤©çš„ binlogã€‚æ¯”å¦‚ï¼Œä½ æ¯å¤© 0 ç‚¹åšä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œè€Œè¦æ¢å¤å‡ºä¸€ä¸ªåˆ°æ˜¨å¤©æ™šä¸Š 23 ç‚¹çš„å¤‡ä»½ã€‚ ä¸€å‘¨ä¸€å¤‡æœ€åæƒ…å†µå°±è¦åº”ç”¨ä¸€å‘¨çš„ binlog äº†ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/02/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/02/"},{"categories":null,"content":" 1ã€äº‹åŠ¡éš”ç¦»çº§åˆ« äº‹åŠ¡çš„ ACID ä¸­çš„ I æŒ‡çš„å°±æ˜¯éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 1ã€éš”ç¦»çº§åˆ«è¯»æœªæäº¤ï¼ˆread-uncommittedï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ°ã€‚ è¯»æäº¤ï¼ˆread-committedï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚ å¯é‡å¤è¯»ï¼ˆrepeatable-readï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚ ä¸²è¡ŒåŒ–ï¼ˆserializableï¼‰ï¼šå½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œåæ‰§è¡Œäº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚ MySQL çš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸º\"è¯»æäº¤\"ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 2ã€äº‹åŠ¡éš”ç¦»ä¾‹å­ mysql\u003e create table T(c int) engine=InnoDB; insert into T(c) values(1); åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹çš„ç»“æœï¼š éš”ç¦»çº§åˆ«ä¸ºè¯»æœªæäº¤ï¼Œv1 = 2, v2 = 2, v3 = 2ã€‚ éš”ç¦»çº§åˆ«ä¸ºè¯»æäº¤ï¼Œv1 = 1, v2 = 2, v3 = 2ã€‚ éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼Œv1 = 1, v2 = 1, v3 = 2ã€‚ éš”ç¦»çº§åˆ«ä¸ºä¸²è¡ŒåŒ–ï¼Œv1 = 1, v2 = 1, v3 = 2ã€‚ åœ¨å®ç°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚ åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚ åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚ åœ¨è¯»æœªæäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µã€‚ åœ¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ï¼Œç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 3ã€äº‹åŠ¡é…ç½®æ–¹å¼é€šè¿‡å‘½ä»¤ show variables like 'transaction_isolation'; æ¥æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«ã€‚é€šè¿‡å‘½ä»¤ set transaction_isolation = 'read-committed'; æ¥è®¾ç½®éš”ç¦»çº§åˆ«ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 2ã€äº‹åŠ¡éš”ç¦»çš„å®ç°åœ¨ MySQL ä¸­ï¼Œå®é™…ä¸Šæ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›æ»šæ“ä½œã€‚è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œé€šè¿‡å›æ»šæ“ä½œï¼Œéƒ½å¯ä»¥å¾—åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚ å‡è®¾ä¸€ä¸ªå€¼ä» 1 è¢«æŒ‰é¡ºåºæ”¹æˆäº† 2ã€3ã€4ï¼Œåœ¨å›æ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚ é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›æ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚é•¿äº‹åŠ¡è¿˜å ç”¨é”èµ„æºï¼Œä¹Ÿå¯èƒ½æ‹–å®æ•´ä¸ªåº“ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 3ã€äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼å»ºè®®ä½ æ€»æ˜¯ä½¿ç”¨ set autocommit = 1, é€šè¿‡æ˜¾å¼è¯­å¥çš„æ–¹å¼æ¥å¯åŠ¨äº‹åŠ¡ã€‚ åœ¨ autocommit = 1 çš„æƒ…å†µä¸‹ï¼Œç”¨ begin æ˜¾å¼å¯åŠ¨çš„äº‹åŠ¡ï¼Œå¦‚æœæ‰§è¡Œ commit åˆ™æäº¤äº‹åŠ¡ã€‚å¦‚æœæ‰§è¡Œ commit work and chainï¼Œåˆ™æ˜¯æäº¤äº‹åŠ¡å¹¶è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªäº‹åŠ¡ã€‚ ä½ å¯ä»¥åœ¨ information_schema åº“çš„ innodb_trx è¿™ä¸ªè¡¨ä¸­æŸ¥è¯¢é•¿äº‹åŠ¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªè¯­å¥ï¼Œç”¨äºæŸ¥æ‰¾æŒç»­æ—¶é—´è¶…è¿‡ 60s çš„äº‹åŠ¡ã€‚ mysql\u003e select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))\u003e60 ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 4ã€é—®é¢˜æ€æ ·é¿å…é•¿äº‹åŠ¡ï¼Ÿ åœ¨å¼€å‘ç«¯ï¼š è®¾ç½®set autocommit = 0ã€‚ ç¡®è®¤æ˜¯å¦æœ‰ä¸å¿…è¦çš„åªè¯»äº‹åŠ¡ã€‚ é€šè¿‡ SET MAX_EXECUTION_TIME å‘½ä»¤ï¼Œæ¥æ§åˆ¶æ¯ä¸ªè¯­å¥æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œé¿å…å•ä¸ªè¯­å¥æ„å¤–æ‰§è¡Œå¤ªé•¿æ—¶é—´ã€‚ åœ¨æ•°æ®åº“ç«¯ï¼š æ§ information_schema.Innodb_trx è¡¨ï¼Œè®¾ç½®é•¿äº‹åŠ¡é˜ˆå€¼ï¼Œè¶…è¿‡å°±æŠ¥è­¦/æˆ–è€… killã€‚ ercona çš„ pt-kill è¿™ä¸ªå·¥å…·ä¸é”™ï¼Œæ¨èä½¿ç”¨ã€‚ åœ¨ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•é˜¶æ®µè¦æ±‚è¾“å‡ºæ‰€æœ‰çš„ general_logï¼Œåˆ†ææ—¥å¿—è¡Œä¸ºæå‰å‘ç°é—®é¢˜ã€‚ å¦‚æœä½¿ç”¨çš„æ˜¯MySQL 5.6æˆ–è€…æ›´æ–°ç‰ˆæœ¬ï¼ŒæŠŠ innodb_undo_tablespaces è®¾ç½®æˆ2ï¼ˆæˆ–æ›´å¤§çš„å€¼ï¼‰ã€‚å¦‚æœçœŸçš„å‡ºç°å¤§äº‹åŠ¡å¯¼è‡´å›æ»šæ®µè¿‡å¤§ï¼Œè¿™æ ·è®¾ç½®åæ¸…ç†èµ·æ¥æ›´æ–¹ä¾¿ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/03/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/03/"},{"categories":null,"content":" 1ã€ç´¢å¼•çš„å¸¸è§æ¨¡å‹","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 1ã€å“ˆå¸Œè¡¨ä»¥é”®-å€¼ï¼ˆkey-valueï¼‰å­˜å‚¨æ•°æ®çš„ç»“æ„ã€‚åªé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢çš„åœºæ™¯ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:1:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 2ã€æœ‰åºæ•°ç»„æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œä½†æ›´æ–°æ•°æ®ï¼Œæˆæœ¬é«˜ã€‚åªé€‚ç”¨é™æ€å­˜å‚¨å¼•æ“ã€‚ ä¸Šé¢æ•°ç»„çš„æŒ‰ç…§ ID_card å‡åºæ’åˆ—ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯ where ID_card = '?'ï¼Œå¯ä»¥ç”¨äºŒåˆ†æ³•æŸ¥è¯¢ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:1:2","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 3ã€æœç´¢æ ‘InnoDB å¼•æ“ä¸­ä½¿ç”¨ B+ æ ‘ï¼ˆ N å‰æ ‘ï¼‰ã€‚å¯ä»¥å‡å°‘ç£ç›˜ IOã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:1:3","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 2ã€InnoDBçš„ç´¢å¼•æ¨¡å‹æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»é”®åˆ—ä¸º ID çš„è¡¨ï¼Œè¡¨ä¸­æœ‰å­—æ®µ kï¼Œå¹¶ä¸”åœ¨ k ä¸Šæœ‰ç´¢å¼•ï¼Œå»ºè¡¨è¯­å¥å¦‚ä¸‹ï¼š mysql\u003e create table T( id int primary key, k int not null, name varchar(16), index (k))engine=InnoDB; è¡¨ä¸­ R1 ~ R5 çš„ (ID,k) å€¼åˆ†åˆ«ä¸º (100,1)ã€(200,2)ã€(300,3)ã€(500,5) å’Œ (600,6)ã€‚ åœ¨ InnoDB å¼•æ“ä¸­ï¼Œæ¯ä¸ªç´¢å¼•å°±æ˜¯ä¸€é¢— B+ æ ‘ã€‚ä¸¤é¢—ç´¢å¼•æ ‘å¦‚ä¸‹ã€‚ æ ¹æ®å¶å­èŠ‚ç‚¹çš„å†…å®¹ï¼Œç´¢å¼•ç±»å‹åˆ†ä¸ºä¸»é”®ç´¢å¼•å’Œéä¸»é”®ç´¢å¼•ã€‚ ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯æ•´è¡Œæ•°æ®ã€‚ éä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®çš„å€¼ã€‚ åŸºäºä¸»é”®ç´¢å¼•å’Œæ™®é€šç´¢å¼•çš„æŸ¥è¯¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ å¦‚æœè¯­å¥æ˜¯ select * from T where ID=500ï¼Œå³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢ ID è¿™æ£µB+æ ‘ï¼› å¦‚æœè¯­å¥æ˜¯ select * from T where k=5ï¼Œå³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢ k ç´¢å¼•æ ‘ï¼Œå¾—åˆ° ID çš„å€¼ä¸º 500ï¼Œå†åˆ° ID ç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›è¡¨ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 3ã€ç´¢å¼•ç»´æŠ¤B+ æ ‘ä¸ºäº†ç»´æŠ¤ç´¢å¼•æœ‰åºæ€§ï¼Œåœ¨æ’å…¥æ–°å€¼çš„æ—¶å€™éœ€è¦åšå¿…è¦çš„ç»´æŠ¤ã€‚ä»¥ä¸Šé¢è¿™ä¸ªå›¾ä¸ºä¾‹ï¼Œå¦‚æœæ’å…¥æ–°çš„è¡Œ ID å€¼ä¸º 700ï¼Œåˆ™åªéœ€è¦åœ¨ R5 çš„è®°å½•åé¢æ’å…¥ä¸€ä¸ªæ–°è®°å½•ã€‚å¦‚æœæ–°æ’å…¥çš„ ID å€¼ä¸º 400ï¼Œå°±ç›¸å¯¹éº»çƒ¦äº†ï¼Œéœ€è¦é€»è¾‘ä¸ŠæŒªåŠ¨åé¢çš„æ•°æ®ï¼Œç©ºå‡ºä½ç½®ã€‚ è€Œæ›´ç³Ÿçš„æƒ…å†µæ˜¯ï¼Œå¦‚æœ R5 æ‰€åœ¨çš„æ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œæ ¹æ® B+ æ ‘çš„ç®—æ³•ï¼Œè¿™æ—¶å€™éœ€è¦ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°æ®é¡µï¼Œç„¶åæŒªåŠ¨éƒ¨åˆ†æ•°æ®è¿‡å»ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºé¡µåˆ†è£‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ€§èƒ½è‡ªç„¶ä¼šå—å½±å“ã€‚ é™¤äº†æ€§èƒ½å¤–ï¼Œé¡µåˆ†è£‚æ“ä½œè¿˜å½±å“æ•°æ®é¡µçš„åˆ©ç”¨ç‡ã€‚åŸæœ¬æ”¾åœ¨ä¸€ä¸ªé¡µçš„æ•°æ®ï¼Œç°åœ¨åˆ†åˆ°ä¸¤ä¸ªé¡µä¸­ï¼Œæ•´ä½“ç©ºé—´åˆ©ç”¨ç‡é™ä½å¤§çº¦50%ã€‚å½“ç›¸é‚»ä¸¤ä¸ªé¡µç”±äºåˆ é™¤äº†æ•°æ®ï¼Œåˆ©ç”¨ç‡å¾ˆä½ä¹‹åï¼Œä¼šå°†æ•°æ®é¡µåšåˆå¹¶ã€‚ æ€»ç»“ï¼š å¦‚æœä¸»é”®æ˜¯è‡ªå¢çš„ï¼Œæ¯æ¬¡æ’å…¥ä¸€æ¡æ–°çš„æ•°æ®ï¼Œå°±æ˜¯è¿½åŠ æ“ä½œï¼Œå°±ä¸ä¼šè§¦å‘é¡µåˆ†è£‚ã€‚ ä¸»é”®é•¿åº¦è¶Šå°ï¼Œæ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œå ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå°ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 4ã€é—®é¢˜å¯¹äºä¸Šé¢ä¾‹å­ä¸­çš„ InnoDB è¡¨ Tï¼Œå¦‚æœä½ è¦é‡å»ºç´¢å¼• kï¼Œä½ çš„ä¸¤ä¸ª SQL è¯­å¥å¯ä»¥è¿™ä¹ˆå†™ï¼š alter table T drop index k; alter table T add index(k); å¦‚æœä½ è¦é‡å»ºä¸»é”®ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ï¼š alter table T drop primary key; alter table T add primary key(id); å¯ä»¥æ‰§è¡Œ alter table T engine=InnoDB; æ¥é‡å»ºç´¢å¼•ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/04/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/04/"},{"categories":null,"content":" 1ã€è¦†ç›–ç´¢å¼•åˆ›å»ºè¡¨ T : mysql\u003e create table T ( ID int primary key, k int NOT NULL DEFAULT 0, s varchar(16) NOT NULL DEFAULT '', index k(k)) engine=InnoDB; insert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg'); æ‰§è¡Œè¯­å¥ select ID from T where k between 3 and 5ï¼Œåªéœ€è¦æ‰«æ k ç´¢å¼•æ ‘ã€‚å› ä¸ºç»“æœåªéœ€è¦æŸ¥è¯¢ IDï¼Œè€Œ ID åœ¨ k ç´¢å¼•æ ‘ä¸Šï¼Œå‡å°‘äº†å›è¡¨æ“ä½œã€‚ ç´¢å¼•æ ‘å·²ç»è¦†ç›–äº†æŸ¥è¯¢ç»“æœï¼Œç§°ä¹‹ä¸ºè¦†ç›–ç´¢å¼•ã€‚è¦†ç›–ç´¢å¼•å¯ä»¥å‡å°‘æ ‘çš„æœç´¢æ¬¡æ•°ï¼Œæ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/05/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/05/"},{"categories":null,"content":" 2ã€æœ€å·¦å‰ç¼€åŒ¹é…B+ æ ‘è¿™ç§ç´¢å¼•ç»“æ„ï¼Œå¯ä»¥åˆ©ç”¨ç´¢å¼•çš„æœ€å·¦å‰ç¼€ï¼Œæ¥å®šä½è®°å½•ã€‚ åˆ›å»ºè¡¨ tuser ï¼š CREATE TABLE `tuser` ( `id` int(11) NOT NULL, `id_card` varchar(32) DEFAULT NULL, `name` varchar(32) DEFAULT NULL, `age` int(11) DEFAULT NULL, `ismale` tinyint(1) DEFAULT NULL, PRIMARY KEY (`id`), KEY `id_card` (`id_card`), KEY `name_age` (`name`,`age`) ) ENGINE=InnoDB å½“ä½ çš„æŸ¥è¯¢æ¡ä»¶æ˜¯ where name like â€˜å¼ %â€™ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼ˆname,ageï¼‰çš„ã€‚ è”åˆç´¢å¼•å»ºç«‹è§„åˆ™ï¼š é€šè¿‡è°ƒæ•´é¡ºåºï¼Œå¯ä»¥å°‘ç»´æŠ¤ä¸€ä¸ªç´¢å¼•ï¼Œè¿™æ˜¯ä¼˜å…ˆè€ƒè™‘çš„ã€‚ ç´¢å¼•çš„ç©ºé—´ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/05/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/05/"},{"categories":null,"content":" 3ã€ç´¢å¼•ä¸‹æ¨å¯ä»¥å¯¹ç´¢å¼•ä¸­å­˜åœ¨çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚ å½“æŸ¥è¯¢æ¡ä»¶æ˜¯ where name like 'å¼ %' and age=10 and ismale=1;ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨åˆ°ç´¢å¼•æ ‘ï¼ˆname,ageï¼‰çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/05/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/05/"},{"categories":null,"content":" 4ã€é—®é¢˜æœ‰å¦‚ä¸‹è¡¨ï¼š CREATE TABLE `geek` ( `a` int(11) NOT NULL, `b` int(11) NOT NULL, `c` int(11) NOT NULL, `d` int(11) NOT NULL, PRIMARY KEY (`a`,`b`), KEY `c` (`c`), KEY `ca` (`c`,`a`), KEY `cb` (`c`,`b`) ) ENGINE=InnoDB; ç”±äºå†å²åŸå› ï¼Œè¿™ä¸ªè¡¨éœ€è¦aã€båšè”åˆä¸»é”®ã€‚ æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š select * from geek where c=N order by a limit 1; select * from geek where c=N order by b limit 1; ç´¢å¼•ï¼ˆc,aï¼‰ã€ï¼ˆc,bï¼‰æ˜¯å¦éƒ½æ˜¯å¿…é¡»çš„? ç´¢å¼• (c,a) ä¸éœ€è¦ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/05/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/05/"},{"categories":null,"content":" 1ã€å…¨å±€è¡¨ æ ¹æ®åŠ é”çš„èŒƒå›´ï¼ŒMySQL é‡Œé¢çš„é”å¤§è‡´å¯ä»¥åˆ†æˆå…¨å±€é”ã€è¡¨çº§é”å’Œè¡Œé”ä¸‰ç±»ã€‚ MySQL åŠ å…¨å±€è¯»é”çš„å‘½ä»¤ï¼šflush tables with read lock;ï¼ˆFTWRLï¼‰, è§£é”å‘½ä»¤ï¼šunlock tables;ã€‚è®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€ã€‚ä»»ä½•å¢åˆ æ”¹è¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚ å…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œåšå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯ select æ‰€æœ‰çš„æ•°æ®ã€‚ å¯¹äº MyISAM å¼•æ“æ¥è¯´ï¼Œå¤‡ä»½åªèƒ½åŠ å…¨å±€é”ã€‚ å¯¹äº Innodb å¼•æ“æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨è„šæœ¬ mysqldumpï¼Œå‚æ•°ä¸º â€“-single-transactionï¼Œæ¥å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œç¡®ä¿æ‹¿åˆ°ä¸€è‡´æ€§è§†å›¾æ¥å¤‡ä»½æ•°æ®ã€‚MyISAM ä¸æ”¯æŒäº‹åŠ¡ï¼Œæ‰€ä»¥æ— æ³•ç”¨æ­¤è„šæœ¬ã€‚ å…¨åº“åªè¯»ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ set global readonly=true çš„æ–¹å¼ï¼Œä¸»è¦åŸå› æœ‰ä¸¤ç‚¹ï¼š åœ¨æœ‰äº›ç³»ç»Ÿä¸­ï¼Œreadonly ä¼šè¢«ç”¨æ¥åšå…¶ä»–é€»è¾‘ï¼Œæ¯”å¦‚åˆ¤æ–­ä¸€ä¸ªåº“æ˜¯ä¸»åº“è¿˜æ˜¯å¤‡åº“ã€‚ å¼‚å¸¸å¤„ç†æœºåˆ¶æœ‰å·®å¼‚ã€‚ æ‰§è¡Œ FTWRL å‘½ä»¤åï¼Œå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸æ–­å¼€ï¼ŒMySQL ä¼šè‡ªåŠ¨é‡Šæ”¾è¿™ä¸ªå…¨å±€é”ã€‚å¦‚æœæ•´åº“å¤„ç† readonly çŠ¶æ€ï¼Œå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸ï¼Œæ•°æ®åº“ä¼šä¸€ç›´å¤„äº readonly çŠ¶æ€ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/06/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/06/"},{"categories":null,"content":" 2ã€è¡¨çº§é” MySQL é‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯è¡¨é”ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDL)ã€‚ ä¾‹å¦‚ï¼šå¦‚æœåœ¨æŸä¸ªçº¿ç¨‹ A ä¸­æ‰§è¡Œ lock tables t1 read, t2 write; è¿™ä¸ªè¯­å¥ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å†™ t1 ã€è¯»å†™ t2 çš„è¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚çº¿ç¨‹ A æ‰§è¡Œ unlock tables; è¯­å¥æ¥è§£é”ã€‚ MDL ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚MDL çš„ä½œç”¨æ˜¯ï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚ åœ¨ MySQL 5.5 ç‰ˆæœ¬ä¸­å¼•å…¥äº† MDLï¼Œå½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”ã€‚ ç»™ä¸€ä¸ªå°è¡¨åŠ ä¸ªå­—æ®µï¼Œå¯¼è‡´æ•´ä¸ªåº“æŒ‚äº†ã€‚ session A å’Œ session B éƒ½ä¼šåŠ ä¸Š MDLè¯»é”ã€‚ session C è¦å˜æ›´è¡¨ç»“æ„ï¼Œå¿…è¦è¦åŠ ä¸Š MDLå†™é”ï¼Œæ­¤æ—¶åªèƒ½é˜»å¡ã€‚ session D ç”³è¯· MDLè¯»é” å°±ä¼šè¢« session C é˜»å¡ã€‚ MDL é”å¿…é¡»è¦ç­‰æ•´ä¸ªäº‹åŠ¡æäº¤åå†é‡Šæ”¾ã€‚ å¦‚ä½•å®‰å…¨åœ°ç»™å°è¡¨åŠ å­—æ®µï¼Ÿ é¦–å…ˆè¦è§£å†³é•¿äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸æäº¤ï¼Œå°±ä¼šä¸€ç›´å ç€ MDLé”ã€‚åœ¨ MySQL çš„ information_schema åº“çš„ innodb_trx è¡¨ä¸­ï¼Œä½ å¯ä»¥æŸ¥åˆ°å½“å‰æ‰§è¡Œä¸­çš„äº‹åŠ¡ã€‚å¦‚æœä½ è¦åš DDL å˜æ›´çš„è¡¨åˆšå¥½æœ‰é•¿äº‹åŠ¡åœ¨æ‰§è¡Œï¼Œè¦è€ƒè™‘å…ˆæš‚åœ DDLï¼Œæˆ–è€… kill æ‰è¿™ä¸ªé•¿äº‹åŠ¡ã€‚ å¦‚æœè¦å˜æ›´çš„è¡¨æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¡¨ï¼Œè™½ç„¶æ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯ä¸Šé¢çš„è¯·æ±‚å¾ˆé¢‘ç¹ï¼Œè€Œä½ ä¸å¾—ä¸åŠ ä¸ªå­—æ®µ, kill å¯èƒ½æœªå¿…ç®¡ç”¨ï¼Œæ¯”è¾ƒç†æƒ³çš„æœºåˆ¶æ˜¯ï¼Œåœ¨ alter table è¯­å¥é‡Œé¢è®¾å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸ªç­‰å¾…æ—¶é—´é‡Œé¢èƒ½å¤Ÿæ‹¿åˆ° MDLå†™é” æœ€å¥½ï¼Œæ‹¿ä¸åˆ°ä¹Ÿä¸è¦é˜»å¡åé¢çš„ä¸šåŠ¡è¯­å¥ï¼Œå…ˆæ”¾å¼ƒã€‚ä¹‹åå†é€šè¿‡é‡è¯•å‘½ä»¤é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚ ALTER TABLE tbl_name NOWAIT add column ... ALTER TABLE tbl_name WAIT N add column ... ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/06/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/06/"},{"categories":null,"content":" 3ã€é—®é¢˜å¤‡ä»½ä¸€èˆ¬éƒ½ä¼šåœ¨å¤‡åº“ä¸Šæ‰§è¡Œï¼Œä½ åœ¨ç”¨ â€“-single-transaction æ–¹æ³•åšé€»è¾‘å¤‡ä»½çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»åº“ä¸Šçš„ä¸€ä¸ªå°è¡¨åšäº†ä¸€ä¸ªDDLï¼Œæ¯”å¦‚ç»™ä¸€ä¸ªè¡¨ä¸ŠåŠ äº†ä¸€åˆ—ã€‚è¿™æ—¶å€™ï¼Œä»å¤‡åº“ä¸Šä¼šçœ‹åˆ°ä»€ä¹ˆç°è±¡å‘¢ï¼Ÿ å‡è®¾è¿™ä¸ª DDL æ˜¯é’ˆå¯¹è¡¨ t1 çš„ï¼Œ è¿™é‡ŒæŠŠå¤‡ä»½è¿‡ç¨‹ä¸­å‡ ä¸ªå…³é”®çš„è¯­å¥åˆ—å‡ºæ¥ï¼š Q1:SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ; Q2:START TRANSACTION WITH CONSISTENT SNAPSHOT; /* other tables */ Q3:SAVEPOINT sp; /* æ—¶åˆ» 1 */ Q4:show create table `t1`; /* æ—¶åˆ» 2 */ Q5:SELECT * FROM `t1`; /* æ—¶åˆ» 3 */ Q6:ROLLBACK TO SAVEPOINT sp; /* æ—¶åˆ» 4 */ /* other tables */ åœ¨å¤‡ä»½å¼€å§‹çš„æ—¶å€™ï¼Œä¸ºäº†ç¡®ä¿RRï¼ˆå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«ï¼Œå†è®¾ç½®ä¸€æ¬¡RRéš”ç¦»çº§åˆ«(Q1); å¯åŠ¨äº‹åŠ¡(Q2); è®¾ç½®ä¸€ä¸ªä¿å­˜ç‚¹ï¼Œè¿™ä¸ªå¾ˆé‡è¦(Q3); show create æ˜¯ä¸ºäº†æ‹¿åˆ°è¡¨ç»“æ„(Q4)ï¼Œç„¶åæ­£å¼å¯¼æ•°æ® ï¼ˆQ5ï¼‰ï¼Œå›æ»šåˆ°SAVEPOINT spï¼Œåœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯é‡Šæ”¾ t1 çš„ MDLé”ã€‚ ç­”æ¡ˆå¦‚ä¸‹ï¼š å¦‚æœåœ¨ Q4 è¯­å¥æ‰§è¡Œä¹‹å‰åˆ°è¾¾ï¼Œç°è±¡ï¼šæ²¡æœ‰å½±å“ï¼Œå¤‡ä»½æ‹¿åˆ°çš„æ˜¯DDLåçš„è¡¨ç»“æ„ã€‚ å¦‚æœåœ¨\"æ—¶åˆ» 2\"åˆ°è¾¾ï¼Œåˆ™ Q5 æ‰§è¡Œçš„æ—¶å€™è¡¨ç»“æ„è¢«æ”¹è¿‡ï¼ŒæŠ¥ Table definition has changed, please retry transactionï¼Œç°è±¡ï¼šmysqldump ç»ˆæ­¢ï¼› å¦‚æœåœ¨\"æ—¶åˆ»2\"å’Œ\"æ—¶åˆ»3\"ä¹‹é—´åˆ°è¾¾ï¼Œmysqldump å ç€ t1 çš„ MDLè¯»é”ï¼Œbinlog è¢«é˜»å¡ï¼Œç°è±¡ï¼šä¸»ä»å»¶è¿Ÿï¼Œç›´åˆ° Q6 æ‰§è¡Œå®Œæˆã€‚ ä»\"æ—¶åˆ»4\"å¼€å§‹ï¼Œmysqldump é‡Šæ”¾äº† MDLè¯»é”ï¼Œç°è±¡ï¼šæ²¡æœ‰å½±å“ï¼Œå¤‡ä»½æ‹¿åˆ°çš„æ˜¯ DDL å‰çš„è¡¨ç»“æ„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/06/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/06/"},{"categories":null,"content":" 1ã€è¡Œé” MySQL çš„è¡Œé”æ˜¯åœ¨å¼•æ“å±‚ç”±å„ä¸ªå¼•æ“è‡ªå·±å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼•æ“éƒ½æ”¯æŒè¡Œé”ï¼Œæ¯”å¦‚ MyISAM å¼•æ“å°±ä¸æ”¯æŒï¼ŒInnoDB å¼•æ“æ”¯æŒè¡Œé”ã€‚ ä¸¤é˜¶æ®µé”ï¼š å®é™…ä¸Šäº‹åŠ¡Bçš„ update è¯­å¥ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°äº‹åŠ¡Aæ‰§è¡Œ commit ä¹‹åï¼Œäº‹åŠ¡Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚ åœ¨ InnoDB äº‹åŠ¡ä¸­ï¼Œè¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹åˆ»é‡Šæ”¾ï¼Œè€Œæ˜¯è¦ç­‰åˆ°äº‹åŠ¡ç»“æŸæ—¶æ‰é‡Šæ”¾ã€‚è¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚ å¦‚æœä½ çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠæœ€å¯èƒ½é€ æˆé”å†²çªã€æœ€å¯èƒ½å½±å“å¹¶å‘åº¦çš„é”å°½é‡å¾€åæ”¾ã€‚ æ¯”å¦‚ï¼Œç”µå½±ç¥¨åœ¨çº¿äº¤æ˜“ä¸šåŠ¡ï¼š ä»é¡¾å®¢Aè´¦æˆ·ä½™é¢ä¸­æ‰£é™¤ç”µå½±ç¥¨ä»·ã€‚ ç»™å½±é™¢Bçš„è´¦æˆ·ä½™é¢å¢åŠ è¿™å¼ ç”µå½±ç¥¨ä»·ã€‚ è®°å½•ä¸€æ¡äº¤æ˜“æ—¥å¿—ã€‚ è¦ä¿è¯äº¤æ˜“çš„åŸå­æ€§ï¼Œå°±è¦æŠŠè¿™ä¸‰ä¸ªæ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ŒæŒ‰ç…§ 3 -\u003e 1 -\u003e 2 çš„é¡ºåºæ‰§è¡Œï¼Œå°±å‡å°‘äº†äº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…ï¼Œæå‡äº†å¹¶å‘åº¦ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/07/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/07/"},{"categories":null,"content":" 2ã€æ­»é”å’Œæ­»é”æ£€æµ‹æ­»é”ä¾‹å­ï¼š äº‹åŠ¡Aåœ¨ç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾ id=2 çš„è¡Œé”ï¼Œè€Œäº‹åŠ¡Båœ¨ç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾ id=1 çš„è¡Œé”ã€‚ äº‹åŠ¡Aå’Œäº‹åŠ¡Båœ¨äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„èµ„æºé‡Šæ”¾ï¼Œå°±æ˜¯è¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚ å½“å‡ºç°æ­»é”ä»¥åï¼Œæœ‰ä¸¤ç§ç­–ç•¥ ç›´æ¥è¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´é€šè¿‡å‚æ•° innodb_lock_wait_timeout æ¥è®¾ç½®ã€‚ å‘èµ·æ­»é”æ£€æµ‹ï¼Œå‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚é€šè¿‡å‚æ•° innodb_deadlock_detect è®¾ç½®ä¸º onã€‚ åœ¨ InnoDB ä¸­ï¼Œinnodb_lock_wait_timeout çš„é»˜è®¤å€¼æ˜¯ 50sï¼Œå½“å‡ºç°æ­»é”ä»¥åï¼Œç¬¬ä¸€ä¸ªè¢«é”ä½çš„çº¿ç¨‹è¦è¿‡ 50s æ‰ä¼šè¶…æ—¶é€€å‡ºï¼Œè¿™ä¸ªç­‰å¾…æ—¶é—´è‚¯å®šæ˜¯æ— æ³•æ¥å—çš„ï¼Œä½†å¦‚æœè®¾ç½®ä¸º 1sï¼Œå¯èƒ½å‡ºç°ä¸æ˜¯æ­»é”çš„æƒ…å†µï¼ˆå¤§äº‹åŠ¡ï¼‰ï¼Œé€ æˆè¯¯ä¼¤ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é‡‡ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼šä¸»åŠ¨æ­»é”æ£€æµ‹ã€‚innodb_deadlock_detect çš„é»˜è®¤å€¼ä¸º onã€‚ å½“æ›´æ–°åŒä¸€è¡Œæ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹æ£€æŸ¥çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n), ä¹Ÿå°±æ˜¯è¯´ 1000 ä¸ªçº¿ç¨‹ï¼Œè¦æ“ä½œ 100w æ¬¡ï¼Œæ‰€ä»¥æ­»é”æ£€æµ‹è¦è€—è´¹å¤§é‡çš„ CPU èµ„æºã€‚ æ€ä¹ˆè§£å†³ç”±è¿™ç§çƒ­ç‚¹è¡Œæ›´æ–°å¯¼è‡´çš„æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿ ä¸€ç§å¤´ç—›åŒ»å¤´çš„æ–¹æ³•ï¼Œå°±æ˜¯å¦‚æœä½ èƒ½ç¡®ä¿è¿™ä¸ªä¸šåŠ¡ä¸€å®šä¸ä¼šå‡ºç°æ­»é”ï¼Œå¯ä»¥ä¸´æ—¶æŠŠæ­»é”æ£€æµ‹å…³æ‰ã€‚ä¸šåŠ¡æœ‰æŸã€‚ æ§åˆ¶å¹¶å‘åº¦ã€‚æ¯”å¦‚åŒä¸€è¡ŒåŒæ—¶æœ€å¤šåªæœ‰ 10 ä¸ªçº¿ç¨‹åœ¨æ›´æ–°ï¼Œé‚£ä¹ˆæ­»é”æ£€æµ‹çš„æˆæœ¬å¾ˆä½ï¼Œå°±ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚ å¹¶å‘æ§åˆ¶è¦åšåœ¨æ•°æ®åº“æœåŠ¡ç«¯ï¼Œå¦‚æœä½ æœ‰ä¸­é—´ä»¶ï¼Œå¯ä»¥è€ƒè™‘åœ¨ä¸­é—´ä»¶å®ç°ï¼›å¦‚æœä½ çš„å›¢é˜Ÿæœ‰èƒ½ä¿®æ”¹ MySQL æºç çš„äººï¼Œä¹Ÿå¯ä»¥åšåœ¨ MySQL é‡Œé¢ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯ï¼Œå¯¹äºç›¸åŒè¡Œçš„æ›´æ–°ï¼Œåœ¨è¿›å…¥å¼•æ“ä¹‹å‰æ’é˜Ÿã€‚è¿™æ ·åœ¨ InnoDB å†…éƒ¨å°±ä¸ä¼šæœ‰å¤§é‡çš„æ­»é”æ£€æµ‹å·¥ä½œäº†ã€‚ æ§åˆ¶å¹¶å‘åº¦ä¹Ÿå¯ä»¥ä»ä¸šåŠ¡è®¾è®¡ä¸Šä¼˜åŒ–ã€‚è€ƒè™‘å°†ä¸€è¡Œæ”¹æˆé€»è¾‘ä¸Šçš„å¤šè¡Œæ¥å‡å°‘é”å†²çªã€‚ è¿˜æ˜¯ä»¥å½±é™¢è´¦æˆ·ä¸ºä¾‹ï¼Œå¯ä»¥è€ƒè™‘æ”¾åœ¨å¤šæ¡è®°å½•ä¸Šï¼Œæ¯”å¦‚ 10 ä¸ªè®°å½•ï¼Œå½±é™¢çš„è´¦æˆ·æ€»é¢ç­‰äºè¿™ 10 ä¸ªè®°å½•çš„å€¼çš„æ€»å’Œã€‚è¿™æ ·æ¯æ¬¡è¦ç»™å½±é™¢è´¦æˆ·åŠ é‡‘é¢çš„æ—¶å€™ï¼Œéšæœºé€‰å…¶ä¸­ä¸€æ¡è®°å½•æ¥åŠ ã€‚è¿™æ ·æ¯æ¬¡å†²çªæ¦‚ç‡å˜æˆåŸæ¥çš„ 1/10ï¼Œå¯ä»¥å‡å°‘é”ç­‰å¾…ä¸ªæ•°ï¼Œä¹Ÿå°±å‡å°‘äº†æ­»é”æ£€æµ‹çš„ CPU æ¶ˆè€—ã€‚ å¦‚æœè´¦æˆ·ä½™é¢å¯èƒ½ä¼šå‡å°‘ï¼Œæ¯”å¦‚é€€ç¥¨é€»è¾‘ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±éœ€è¦è€ƒè™‘å½“ä¸€éƒ¨åˆ†è¡Œè®°å½•å˜æˆ 0 çš„æ—¶å€™ï¼Œä»£ç è¦æœ‰ç‰¹æ®Šå¤„ç†ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/07/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/07/"},{"categories":null,"content":" 3ã€é—®é¢˜å¦‚æœä½ è¦åˆ é™¤ä¸€ä¸ªè¡¨é‡Œé¢çš„å‰ 10000 è¡Œæ•°æ®ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§æ–¹æ³•å¯ä»¥åšåˆ°ï¼š ç¬¬ä¸€ç§ï¼Œç›´æ¥æ‰§è¡Œ delete from T limit 10000; ç¬¬äºŒç§ï¼Œåœ¨ä¸€ä¸ªè¿æ¥ä¸­å¾ªç¯æ‰§è¡Œ20æ¬¡ delete from T limit 500; ç¬¬ä¸‰ç§ï¼Œåœ¨ 20 ä¸ªè¿æ¥ä¸­åŒæ—¶æ‰§è¡Œ delete from T limit 500ã€‚ ä½ ä¼šé€‰æ‹©å“ªä¸€ç§æ–¹æ³•å‘¢ï¼Ÿä¸ºä»€ä¹ˆå‘¢ï¼Ÿ ç¬¬äºŒç§æ–¹å¼æ˜¯ç›¸å¯¹è¾ƒå¥½çš„ã€‚ ç¬¬ä¸€ç§æ–¹å¼å•ä¸ªè¯­å¥å ç”¨æ—¶é—´é•¿ï¼Œé”çš„æ—¶é—´ä¹Ÿæ¯”è¾ƒé•¿ï¼›è€Œä¸”å¤§äº‹åŠ¡è¿˜ä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚ ç¬¬ä¸‰ç§æ–¹å¼ä¼šäººä¸ºé€ æˆé”å†²çªã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/07/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/07/"},{"categories":null,"content":" 1ã€äº‹åŠ¡ åœ¨ç¬¬ 3 ç¯‡æ–‡ç« å’Œä½ è®²äº‹åŠ¡éš”ç¦»çº§åˆ«çš„æ—¶å€™æåˆ°è¿‡ï¼Œå¦‚æœæ˜¯å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡ T å¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ read-viewï¼Œä¹‹åäº‹åŠ¡ T æ‰§è¡ŒæœŸé—´ï¼Œå³ä½¿æœ‰å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œäº‹åŠ¡ T çœ‹åˆ°çš„ä»ç„¶è·Ÿåœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„ä¸€æ ·ã€‚ ä¾‹å­ï¼š mysql\u003e CREATE TABLE `t` ( `id` int(11) NOT NULL, `k` int(11) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB; insert into t(id, k) values(1,1),(2,2); åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œbegin/start transaction å¹¶ä¸æ˜¯äº‹åŠ¡çš„èµ·ç‚¹ï¼Œåªæœ‰æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªè¯­å¥æ—¶æ‰ä¼šçœŸæ­£å¯åŠ¨äº‹åŠ¡ã€‚å¦‚æœä½ æƒ³è¦é©¬ä¸Šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ start transaction with consistent snapshot è¿™ä¸ªå‘½ä»¤ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œäº‹åŠ¡ C æ²¡æœ‰æ˜¾å¼åœ°ä½¿ç”¨ begin/commit ï¼Œè¡¨ç¤ºè¿™ä¸ª update è¯­å¥æœ¬èº«å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¯­å¥å®Œæˆçš„æ—¶å€™ä¼šè‡ªåŠ¨æäº¤ã€‚ ç»“æœæ˜¯äº‹åŠ¡ B çš„ k å€¼ä¸º 3ï¼Œäº‹åŠ¡Açš„ k å€¼ä¸º 1ã€‚ åœ¨ MySQL é‡Œï¼Œæœ‰ä¸¤ä¸ª\"è§†å›¾\"çš„æ¦‚å¿µ: ä¸€ä¸ªæ˜¯ viewï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æŸ¥è¯¢è¯­å¥å®šä¹‰çš„è™šæ‹Ÿè¡¨ã€‚ å¦ä¸€ä¸ªæ˜¯ InnoDB åœ¨å®ç° MVCC æ—¶ç”¨åˆ°çš„ä¸€è‡´æ€§è¯»è§†å›¾ï¼Œå³ consistent read viewã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/08/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/08/"},{"categories":null,"content":" 2ã€â€œå¿«ç…§\"æ€ä¹ˆå·¥ä½œçš„åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å°±\"æ‹äº†ä¸ªå¿«ç…§â€ã€‚è¿™ä¸ªå¿«ç…§æ˜¯åŸºäºæ•´åº“çš„ã€‚ InnoDB é‡Œé¢æ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡ IDï¼Œå«ä½œ transaction id ã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘ InnoDB çš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„ã€‚ è€Œæ¯è¡Œæ•°æ®ä¹Ÿéƒ½æ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬çš„ã€‚æ¯æ¬¡äº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œå¹¶ä¸”æŠŠtransaction idèµ‹å€¼ç»™è¿™ä¸ªæ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡ IDï¼Œè®°ä¸º row trx_idã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¡¨ä¸­çš„ä¸€è¡Œè®°å½•ï¼Œå…¶å®å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬(row)ï¼Œæ¯ä¸ªç‰ˆæœ¬æœ‰è‡ªå·±çš„ row trx_idã€‚ ä¸€ä¸ªè®°å½•è¢«å¤šä¸ªäº‹åŠ¡è¿ç»­æ›´æ–°åçš„çŠ¶æ€: å›¾ä¸­è™šçº¿æ¡†é‡Œæ˜¯åŒä¸€è¡Œæ•°æ®çš„4ä¸ªç‰ˆæœ¬ï¼Œå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ V4ï¼Œk çš„å€¼æ˜¯ 22ï¼Œå®ƒæ˜¯è¢«transaction id ä¸º 25 çš„äº‹åŠ¡æ›´æ–°çš„ï¼Œå› æ­¤å®ƒçš„ row trx_id ä¹Ÿæ˜¯ 25ã€‚ å›¾ä¸­ä¸‰ä¸ªè™šçº¿ç®­å¤´ï¼Œå°±æ˜¯ undo logï¼Œè€Œ V1ã€V2ã€V3 å¹¶ä¸æ˜¯ç‰©ç†ä¸ŠçœŸå®å­˜åœ¨çš„ï¼Œè€Œæ˜¯æ¯æ¬¡éœ€è¦çš„æ—¶å€™æ ¹æ®å½“å‰ç‰ˆæœ¬å’Œ undo log è®¡ç®—å‡ºæ¥çš„ã€‚ ä¸€ä¸ªäº‹åŠ¡åªéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™å£°æ˜è¯´ï¼Œâ€œä»¥æˆ‘å¯åŠ¨çš„æ—¶åˆ»ä¸ºå‡†ï¼Œå¦‚æœä¸€ä¸ªæ•°æ®ç‰ˆæœ¬æ˜¯åœ¨æˆ‘å¯åŠ¨ä¹‹å‰ç”Ÿæˆçš„ï¼Œå°±è®¤ï¼›å¦‚æœæ˜¯æˆ‘å¯åŠ¨ä»¥åæ‰ç”Ÿæˆçš„ï¼Œæˆ‘å°±ä¸è®¤ï¼Œæˆ‘å¿…é¡»è¦æ‰¾åˆ°å®ƒçš„ä¸Šä¸€ä¸ªç‰ˆæœ¬â€ã€‚å¦‚æœ\"ä¸Šä¸€ä¸ªç‰ˆæœ¬\"ä¹Ÿä¸å¯è§ï¼Œé‚£å°±å¾—ç»§ç»­å¾€å‰æ‰¾ã€‚ åœ¨å®ç°ä¸Šï¼Œ InnoDB ä¸ºæ¯ä¸ªäº‹åŠ¡æ„é€ äº†ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥ä¿å­˜è¿™ä¸ªäº‹åŠ¡å¯åŠ¨ç¬é—´ï¼Œå½“å‰æ­£åœ¨ æ´»è·ƒ (å¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤)çš„æ‰€æœ‰äº‹åŠ¡ IDã€‚ æ•°ç»„é‡Œé¢äº‹åŠ¡ ID çš„æœ€å°å€¼è®°ä¸ºä½æ°´ä½ï¼Œå½“å‰ç³»ç»Ÿé‡Œé¢å·²ç»åˆ›å»ºè¿‡çš„äº‹åŠ¡ ID çš„æœ€å¤§å€¼åŠ 1è®°ä¸ºé«˜æ°´ä½ã€‚ å¯¹äºä¸€ä¸ªæ•°æ®ç‰ˆæœ¬çš„ row trx_id, æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š å¦‚æœè½åœ¨ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²æäº¤çš„äº‹åŠ¡æˆ–è€…æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å¯è§çš„ï¼› å¦‚æœè½åœ¨çº¢è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±å°†æ¥å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ˜¯è‚¯å®šä¸å¯è§çš„ï¼› å¦‚æœè½åœ¨é»„è‰²éƒ¨åˆ†ï¼Œé‚£å°±åŒ…æ‹¬ä¸¤ç§æƒ…å†µ a. è‹¥ row trx_id åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±è¿˜æ²¡æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œä¸å¯è§ï¼› b. è‹¥ row trx_id ä¸åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²ç»æäº¤äº†çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œå¯è§ã€‚ åˆ†æä¸‹å›¾ 1 ä¸­çš„ä¸‰ä¸ªäº‹åŠ¡ï¼Œäº‹åŠ¡ A ä¸ºä»€ä¹ˆæ˜¯ k=1 ï¼Ÿ å‡è®¾ï¼š äº‹åŠ¡Aå¼€å§‹å‰ï¼Œç³»ç»Ÿé‡Œé¢åªæœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡ ID æ˜¯ 99ï¼› äº‹åŠ¡ Aã€Bã€C çš„ç‰ˆæœ¬å·åˆ†åˆ«æ˜¯ 100ã€101ã€102ï¼Œä¸”å½“å‰ç³»ç»Ÿé‡Œåªæœ‰è¿™å››ä¸ªäº‹åŠ¡ï¼› ä¸‰ä¸ªäº‹åŠ¡å¼€å§‹å‰ï¼Œ(1,1ï¼‰è¿™ä¸€è¡Œæ•°æ®çš„ row trx_idæ˜¯ 90ã€‚ è¿™æ ·ï¼Œäº‹åŠ¡ A çš„è§†å›¾æ•°ç»„å°±æ˜¯ [99,100] , äº‹åŠ¡Bçš„è§†å›¾æ•°ç»„æ˜¯ [99,100,101], äº‹åŠ¡Cçš„è§†å›¾æ•°ç»„æ˜¯ [99,100,101,102]ã€‚ äº‹åŠ¡AæŸ¥è¯¢é€»è¾‘æœ‰å…³çš„æ“ä½œ: æ€»ç»“ï¼š ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡è§†å›¾æ¥è¯´ï¼Œé™¤äº†è‡ªå·±çš„æ›´æ–°æ€»æ˜¯å¯è§ä»¥å¤–ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š ç‰ˆæœ¬æœªæäº¤ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œä½†æ˜¯æ˜¯åœ¨è§†å›¾åˆ›å»ºåæäº¤çš„ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œè€Œä¸”æ˜¯åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„ï¼Œå¯è§ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/08/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/08/"},{"categories":null,"content":" 3ã€æ›´æ–°é€»è¾‘æ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åå†™çš„ï¼Œè€Œè¿™ä¸ªè¯»ï¼Œåªèƒ½è¯»å½“å‰çš„å€¼ï¼Œç§°ä¸º\"å½“å‰è¯»\"ï¼ˆcurrent readï¼‰ã€‚ åœ¨æ‰§è¡Œäº‹åŠ¡ B è¯­å¥çš„æ—¶å€™ï¼Œupdate è¯­å¥æ˜¯å½“å‰è¯»ï¼Œè¿™æ˜¯ row trx_id ä¸º 101ï¼Œæ‰€ä»¥ select è¯­å¥èƒ½è¯»åˆ° k=3ã€‚ é™¤äº† update è¯­å¥å¤–ï¼Œselect è¯­å¥å¦‚æœåŠ é”ï¼Œä¹Ÿæ˜¯å½“å‰è¯»ã€‚ mysql\u003e select k from t where id=1 lock in share mode; # è¯»é”ï¼ˆSé”ï¼Œå…±äº«é”ï¼‰ mysql\u003e select k from t where id=1 for update; # å†™é”ï¼ˆXé”ï¼Œæ’ä»–é”ï¼‰ å‡è®¾äº‹åŠ¡ C ä¸æ˜¯é©¬ä¸Šæäº¤çš„ï¼Œè€Œæ˜¯å˜æˆäº†ä¸‹é¢çš„äº‹åŠ¡ Câ€™ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ äº‹åŠ¡ Câ€™ æ²¡æäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´ (1,2) è¿™ä¸ªç‰ˆæœ¬ä¸Šçš„å†™é”è¿˜æ²¡é‡Šæ”¾ã€‚è€Œäº‹åŠ¡B æ˜¯å½“å‰è¯»ï¼Œå¿…é¡»è¦è¯»æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œä¸”å¿…é¡»åŠ é”ï¼Œå› æ­¤å°±è¢«é”ä½äº†ï¼Œå¿…é¡»ç­‰åˆ°äº‹åŠ¡ Câ€™ é‡Šæ”¾è¿™ä¸ªé”ï¼Œæ‰èƒ½ç»§ç»­å®ƒçš„å½“å‰è¯»ã€‚ æ€»ç»“ï¼š å¯é‡å¤è¯»çš„æ ¸å¿ƒå°±æ˜¯ä¸€è‡´æ€§è¯»ï¼ˆconsistent readï¼‰ï¼›è€Œäº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œåªèƒ½ç”¨å½“å‰è¯»ã€‚å¦‚æœå½“å‰çš„è®°å½•çš„è¡Œé”è¢«å…¶ä»–äº‹åŠ¡å ç”¨çš„è¯ï¼Œå°±éœ€è¦è¿›å…¥é”ç­‰å¾…ã€‚ è¯»æäº¤çš„é€»è¾‘å’Œå¯é‡å¤è¯»çš„é€»è¾‘ç±»ä¼¼ï¼Œå®ƒä»¬æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼š åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œåªéœ€è¦åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™åˆ›å»ºä¸€è‡´æ€§è§†å›¾ï¼Œä¹‹åäº‹åŠ¡é‡Œçš„å…¶ä»–æŸ¥è¯¢éƒ½å…±ç”¨è¿™ä¸ªä¸€è‡´æ€§è§†å›¾ï¼› åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸€ä¸ªè¯­å¥æ‰§è¡Œå‰éƒ½ä¼šé‡æ–°ç®—å‡ºä¸€ä¸ªæ–°çš„è§†å›¾ã€‚ æ³¨æ„ï¼Œè¯­å¥ start transaction with consistent snapshot; åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚ è¯»æäº¤æ—¶çš„çŠ¶æ€å›¾ï¼Œæ³¨æ„æ˜¯äº‹åŠ¡ Cã€‚ äº‹åŠ¡ A æŸ¥è¯¢è¯­å¥è¿”å›çš„æ˜¯ k=2ï¼Œäº‹åŠ¡ B æŸ¥è¯¢ç»“æœ k=3ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/08/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/08/"},{"categories":null,"content":" 4ã€æœ€é‡è¦çš„æ€»ç»“ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡è§†å›¾æ¥è¯´ï¼Œé™¤äº†è‡ªå·±çš„æ›´æ–°æ€»æ˜¯å¯è§ä»¥å¤–ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š ç‰ˆæœ¬æœªæäº¤ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œä½†æ˜¯æ˜¯åœ¨è§†å›¾åˆ›å»ºåæäº¤çš„ï¼Œä¸å¯è§ï¼› ç‰ˆæœ¬å·²æäº¤ï¼Œè€Œä¸”æ˜¯åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„ï¼Œå¯è§ã€‚ è¯­å¥ update ã€for update ã€lock in share mode æ˜¯å½“å‰è¯»ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/08/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/08/"},{"categories":null,"content":" 5ã€é—®é¢˜æˆ‘ç”¨ä¸‹é¢çš„è¡¨ç»“æ„å’Œåˆå§‹åŒ–è¯­å¥ä½œä¸ºè¯•éªŒç¯å¢ƒï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ã€‚ç°åœ¨ï¼Œæˆ‘è¦æŠŠæ‰€æœ‰\"å­—æ®µcå’Œidå€¼ç›¸ç­‰çš„è¡Œ\"çš„ c å€¼æ¸…é›¶ï¼Œä½†æ˜¯å´å‘ç°äº†ä¸€ä¸ªâ€œè¯¡å¼‚â€çš„ã€æ”¹ä¸æ‰çš„æƒ…å†µã€‚è¯·ä½ æ„é€ å‡ºè¿™ç§æƒ…å†µï¼Œå¹¶è¯´æ˜å…¶åŸç†ã€‚ mysql\u003e CREATE TABLE `t` ( `id` int(11) NOT NULL, `c` int(11) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB; insert into t(id, c) values(1,1),(2,2),(3,3),(4,4); å‡ºç°çš„æƒ…å†µï¼š ç¬¬ä¸€ç§æƒ…å†µ 2. ç¬¬äºŒç§æƒ…å†µ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/08/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/08/"},{"categories":null,"content":" 1ã€æŸ¥è¯¢è¿‡ç¨‹ä¸»é”®ç´¢å¼• ID å’Œ æ™®é€šç´¢å¼• K: å‡è®¾æ‰§è¡ŒæŸ¥è¯¢çš„è¯­å¥æ˜¯ select id from T where k=5, ä½¿ç”¨äºŒåˆ†æ³•æŸ¥è¯¢ï¼š å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè®°å½•(5,500)åï¼Œéœ€è¦æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè®°å½•ï¼Œç›´åˆ°ç¢°åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³ k=5 æ¡ä»¶çš„è®°å½•ã€‚ å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œç”±äºç´¢å¼•å®šä¹‰äº†å”¯ä¸€æ€§ï¼ŒæŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•åï¼Œå°±ä¼šåœæ­¢ç»§ç»­æ£€ç´¢ã€‚ ä¸¤ä¸ªç´¢å¼•çš„æ€§èƒ½å·®åˆ«ï¼Œå¾®ä¹å…¶å¾®ã€‚ InnoDB çš„æ•°æ®æ˜¯æŒ‰æ•°æ®é¡µä¸ºå•ä½æ¥è¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰¾åˆ° k=5 çš„è®°å½•çš„æ—¶å€™ï¼Œå®ƒæ‰€åœ¨çš„æ•°æ®é¡µå°±éƒ½åœ¨å†…å­˜é‡Œäº†ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸‹ä¸€æ¡è®°å½•æ˜¯å¾ˆå¿«çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 2ã€æ›´æ–°è¿‡ç¨‹å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨å†…å­˜ä¸­å°±ç›´æ¥æ›´æ–°ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µè¿˜æ²¡æœ‰åœ¨å†…å­˜ä¸­ï¼Œåœ¨ä¸å½±å“æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼ŒInooDB ä¼šå°†è¿™äº›æ›´æ–°æ“ä½œç¼“å­˜åœ¨ change buffer ä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥è¿™ä¸ªæ•°æ®é¡µäº†ã€‚åœ¨ä¸‹æ¬¡æŸ¥è¯¢éœ€è¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œå°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œç„¶åæ‰§è¡Œ change buffer ä¸­ä¸è¿™ä¸ªé¡µæœ‰å…³çš„æ“ä½œã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¿è¯è¿™ä¸ªæ•°æ®é€»è¾‘çš„æ­£ç¡®æ€§ã€‚ å°† change buffer ä¸­çš„æ“ä½œåº”ç”¨åˆ°åŸæ•°æ®é¡µï¼Œå¾—åˆ°æœ€æ–°ç»“æœçš„è¿‡ç¨‹ç§°ä¸º mergeã€‚é™¤äº†è®¿é—®è¿™ä¸ªæ•°æ®é¡µä¼šè§¦å‘ merge å¤–ï¼Œç³»ç»Ÿæœ‰åå°çº¿ç¨‹ä¼šå®šæœŸ merge ã€‚åœ¨æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ‰§è¡Œ merge æ“ä½œã€‚ å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œæ‰€æœ‰çš„æ›´æ–°æ“ä½œéƒ½è¦å…ˆåˆ¤æ–­è¿™ä¸ªæ“ä½œæ˜¯å¦è¿åå”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥å¿…é¡»è¦å°†æ•°æ®é¡µè¯»å…¥å†…å­˜æ‰èƒ½åˆ¤æ–­ï¼Œè¿™æ—¶ change buffer ä¸èƒ½ä½¿ç”¨äº†ã€‚ change buffer ç”¨çš„æ˜¯ buffer pool é‡Œçš„å†…å­˜ï¼Œå› æ­¤ä¸èƒ½æ— é™å¢å¤§ã€‚change buffer çš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡å‚æ•° innodb_change_buffer_max_size æ¥åŠ¨æ€è®¾ç½®ã€‚è¿™ä¸ªå‚æ•°è®¾ç½®ä¸º 50 çš„æ—¶å€™ï¼Œè¡¨ç¤º change buffer çš„å¤§å°æœ€å¤šåªèƒ½å ç”¨ buffer pool çš„ 50%ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 3ã€change buffer çš„ä½¿ç”¨åœºæ™¯change buffer çš„ä¸»è¦ç›®çš„å°±æ˜¯å°†è®°å½•çš„å˜æ›´åŠ¨ä½œç¼“å­˜ä¸‹æ¥ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªæ•°æ®é¡µåš merge ä¹‹å‰ï¼Œchange buffer è®°å½•çš„å˜æ›´è¶Šå¤šï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªé¡µé¢ä¸Šè¦æ›´æ–°çš„æ¬¡æ•°è¶Šå¤šï¼‰ï¼Œæ”¶ç›Šå°±è¶Šå¤§ã€‚ å¯¹äºå†™å¤šè¯»å°‘çš„ä¸šåŠ¡æ¥è¯´ï¼Œ change buffer çš„ä½¿ç”¨æ•ˆæœæœ€å¥½ã€‚è¿™ç§ä¸šåŠ¡æ¨¡å‹å¸¸è§çš„å°±æ˜¯è´¦å•ç±»ã€æ—¥å¿—ç±»çš„ç³»ç»Ÿã€‚ å‡è®¾ä¸€ä¸ªä¸šåŠ¡çš„æ›´æ–°æ¨¡å¼æ˜¯å†™å…¥ä¹‹åé©¬ä¸Šä¼šåšæŸ¥è¯¢ï¼Œé‚£ä¹ˆå³ä½¿æ»¡è¶³äº†æ¡ä»¶ï¼Œå°†æ›´æ–°å…ˆè®°å½•åœ¨ change bufferï¼Œä½†ä¹‹åç”±äºé©¬ä¸Šè¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µï¼Œä¼šç«‹å³è§¦å‘ merge è¿‡ç¨‹ã€‚è¿™æ ·éšæœºè®¿é—® IO çš„æ¬¡æ•°ä¸ä¼šå‡å°‘ï¼Œåè€Œå¢åŠ äº† change buffer çš„ç»´æŠ¤ä»£ä»·ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 4ã€ç´¢å¼•é€‰æ‹©å’Œå®è·µåœ¨ä¸å½±å“ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä½ å°½é‡é€‰æ‹©æ™®é€šç´¢å¼•ã€‚ æ™®é€šç´¢å¼•å’Œ change buffer çš„é…åˆä½¿ç”¨ï¼Œå¯¹äºæ•°æ®é‡å¤§çš„è¡¨çš„æ›´æ–°ä¼˜åŒ–è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 5ã€change buffer å’Œ redo logæ‰§è¡Œæ’å…¥è¯­å¥ï¼š mysql\u003e insert into t(id,k) values(id1,k1),(id2,k2); æˆ‘ä»¬å‡è®¾\bå½“å‰ k ç´¢å¼•æ ‘çš„çŠ¶æ€ï¼ŒæŸ¥æ‰¾åˆ°ä½ç½®åï¼Œk1 æ‰€åœ¨çš„æ•°æ®é¡µåœ¨å†…å­˜(InnoDB buffer pool)ä¸­ï¼Œk2 æ‰€åœ¨çš„æ•°æ®é¡µä¸åœ¨å†…å­˜ä¸­ã€‚ä¸‹å›¾æ˜¯å¸¦ change buffer çš„æ›´æ–°çŠ¶æ€å›¾ã€‚ è¿™æ¡æ’å…¥è¯­å¥åšäº†å¦‚ä¸‹çš„æ“ä½œ: Page 1 åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥æ›´æ–°å†…å­˜ã€‚ Page 2 æ²¡æœ‰åœ¨å†…å­˜ä¸­ï¼Œå°±åœ¨å†…å­˜çš„ change buffer åŒºåŸŸï¼Œè®°å½•ä¸‹\"æˆ‘è¦å¾€ Page 2 æ’å…¥ä¸€è¡Œ\"è¿™ä¸ªä¿¡æ¯ã€‚ å°†ä¸Šè¿°ä¸¤ä¸ªåŠ¨ä½œè®°å…¥ redo log ä¸­ï¼ˆå›¾ä¸­3å’Œ4ï¼‰ã€‚ å›¾ä¸­çš„ä¸¤ä¸ªè™šçº¿ç®­å¤´ï¼Œæ˜¯åå°æ“ä½œï¼Œä¸å½±å“æ›´æ–°çš„å“åº”æ—¶é—´ã€‚ ç°åœ¨è¦æ‰§è¡Œè¯­å¥ select * from t where k in (k1, k2)ï¼Œè¿™ä¸¤ä¸ªè¯»è¯·æ±‚çš„æµç¨‹å›¾ï¼š è¯» Page 1 çš„æ—¶å€™ï¼Œç›´æ¥ä»å†…å­˜è¿”å›ã€‚ è¦è¯» Page 2 çš„æ—¶å€™ï¼Œéœ€è¦æŠŠ Page 2 ä»ç£ç›˜è¯»å…¥å†…å­˜ä¸­ï¼Œç„¶ååº”ç”¨ change buffer é‡Œé¢çš„æ“ä½œæ—¥å¿—ï¼Œç”Ÿæˆä¸€ä¸ªæ­£ç¡®çš„ç‰ˆæœ¬å¹¶è¿”å›ç»“æœã€‚ ä»ä¸Šå›¾å¯çŸ¥ï¼Œredo log ä¸»è¦èŠ‚çœçš„æ˜¯éšæœºå†™ç£ç›˜çš„ IO æ¶ˆè€—ï¼ˆè½¬æˆé¡ºåºå†™ï¼‰ï¼Œè€Œ change buffer ä¸»è¦èŠ‚çœçš„åˆ™æ˜¯éšæœºè¯»ç£ç›˜çš„ IO æ¶ˆè€—ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:5:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 6ã€é—®é¢˜change buffer ä¸€å¼€å§‹æ˜¯å†™å†…å­˜çš„ï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ªæ—¶å€™æœºå™¨æ‰ç”µé‡å¯ï¼Œä¼šä¸ä¼šå¯¼è‡´ change buffer ä¸¢å¤±å‘¢ï¼Ÿchange buffer ä¸¢å¤±å¯ä¸æ˜¯å°äº‹å„¿ï¼Œå†ä»ç£ç›˜è¯»å…¥æ•°æ®å¯å°±æ²¡æœ‰äº† merge è¿‡ç¨‹ï¼Œå°±ç­‰äºæ˜¯æ•°æ®ä¸¢å¤±äº†ã€‚ä¼šä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ ä¸ä¼šä¸¢å¤±ã€‚è™½ç„¶æ˜¯åªæ›´æ–°å†…å­˜ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠ change buffer çš„æ“ä½œä¹Ÿè®°å½•åˆ° redo log é‡Œäº†ï¼Œæ‰€ä»¥å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œchange buffer ä¹Ÿèƒ½æ‰¾å›æ¥ã€‚ merge çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š ä»ç£ç›˜è¯»å…¥æ•°æ®é¡µåˆ°å†…å­˜ï¼ˆè€ç‰ˆæœ¬çš„æ•°æ®é¡µï¼‰ï¼› ä» change buffer é‡Œæ‰¾å‡ºè¿™ä¸ªæ•°æ®é¡µçš„ change buffer è®°å½•(å¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œä¾æ¬¡åº”ç”¨ï¼Œå¾—åˆ°æ–°ç‰ˆæ•°æ®é¡µï¼› å†™ redo logã€‚è¿™ä¸ª redo log åŒ…å«äº†æ•°æ®çš„å˜æ›´å’Œ change buffer çš„å˜æ›´ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/09/:6:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/09/"},{"categories":null,"content":" 1ã€é€‰é”™ç´¢å¼•ä¸€ä¸ªä¾‹å­ï¼Œå»ºè¡¨è¯­å¥å¦‚ä¸‹ï¼š CREATE TABLE `x` ( `id` int(11) NOT NULL, `a` int(11) DEFAULT NULL, `b` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `a` (`a`), KEY `b` (`b`) ) ENGINE=InnoDB; å¾€è¡¨ x ä¸­æ’å…¥ 10 ä¸‡è¡Œè®°å½•ï¼Œå–å€¼æŒ‰æ•´æ•°é€’å¢ï¼Œå³ï¼š(1,1,1)ï¼Œ(2,2,2)ï¼Œ(3,3,3) ç›´åˆ°(100000,100000,100000)ï¼Œå­˜å‚¨è¿‡ç¨‹å¦‚ä¸‹ï¼š delimiter ;; create procedure idata() begin declare i int; set i=1; while(i\u003c=100000)do insert into x values(i, i, i); set i=i+1; end while; end;; delimiter ; call idata(); åˆ†æä¸€æ¡ SQL è¯­å¥ select * from x where a between 10000 and 20000; æˆ‘ä»¬å†åšå¦‚ä¸‹æ“ä½œã€‚ è¿™æ—¶å€™ï¼Œsession B çš„æŸ¥è¯¢è¯­å¥ select * from t where a between 10000 and 20000 å°±ä¸ä¼šå†é€‰æ‹©ç´¢å¼• a äº†ã€‚ æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼š ä¸´æ—¶å¼€å¯æ…¢æŸ¥è¯¢ï¼š set global slow_query_log='ON'; set global slow_query_log_file='/var/lib/mysql/instance-1-slow.log'; å®éªŒè¿‡ç¨‹å°±æ˜¯è¿™ä¸‰ä¸ªè¯­å¥ï¼š set long_query_time=0; # è®°å½•æ‰€æœ‰çš„æŸ¥è¯¢åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ select * from x where a between 10000 and 20000; # Q1 æŸ¥è¯¢ select * from x force index(a) where a between 10000 and 20000; # Q2 å¼ºåˆ¶ä½¿ç”¨ç´¢å¼• a è¿™ä¸‰æ¡ SQL è¯­å¥æ‰§è¡Œå®Œæˆåçš„æ…¢æŸ¥è¯¢æ—¥å¿—: Q1 æ‰«æäº† 10 ä¸‡è¡Œï¼Œæ˜¾ç„¶æ˜¯èµ°äº†å…¨è¡¨æ‰«æï¼Œæ‰§è¡Œæ—¶é—´æ˜¯ 40 æ¯«ç§’ã€‚Q2 æ‰«æäº† 10001 è¡Œï¼Œæ‰§è¡Œäº†21æ¯«ç§’ï¼Œå¾ˆæ˜¾ç„¶ mysql é€‰é”™äº†ç´¢å¼•ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/10/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/10/"},{"categories":null,"content":" 2ã€ä¼˜åŒ–å™¨çš„é€»è¾‘åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°±æåˆ°è¿‡ï¼Œé€‰æ‹©ç´¢å¼•æ˜¯ä¼˜åŒ–å™¨çš„å·¥ä½œã€‚ ä¼˜åŒ–å™¨é€‰æ‹©ç´¢å¼•ä¼šæ ¹æ®æ‰«æè¡Œæ•°ã€æ˜¯å¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ˜¯å¦æ’åºç­‰å› ç´ è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªä¾‹å­ä¸­åªæœ‰æ‰«æè¡Œæ•°è¿™ä¸ªå› ç´ ï¼Œå¯¹äºæ‰«æè¡Œæ•°ï¼ŒMySQL æ ¹æ®ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—è®°å½•æ•°ï¼ŒæŠ½æ ·æ¥å¾—åˆ°ç´¢å¼•çš„åŸºæ•°ä¿¡æ¯ï¼ˆåŒºåˆ«åº¦ï¼‰ï¼Œå¦‚ä¸‹å›¾ã€‚ é‡‡æ ·ç»Ÿè®¡çš„æ—¶å€™ï¼ŒInnoDB é»˜è®¤ä¼šé€‰æ‹© N ä¸ªæ•°æ®é¡µï¼Œç»Ÿè®¡è¿™äº›é¡µé¢ä¸Šçš„ä¸åŒå€¼ï¼Œå¾—åˆ°ä¸€ä¸ªå¹³å‡å€¼ï¼Œç„¶åä¹˜ä»¥è¿™ä¸ªç´¢å¼•çš„é¡µé¢æ•°ï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªç´¢å¼•çš„åŸºæ•°ã€‚ åœ¨ MySQL ä¸­ï¼Œæœ‰ä¸¤ç§å­˜å‚¨ç´¢å¼•ç»Ÿè®¡çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•° innodb_stats_persistent çš„å€¼æ¥é€‰æ‹©ï¼š è®¾ç½®ä¸º onï¼Œè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯ä¼šæŒä¹…åŒ–å­˜å‚¨ã€‚è¿™æ—¶ï¼Œé»˜è®¤çš„ N æ˜¯ 20ï¼ŒM æ˜¯ 10ã€‚ è®¾ç½®ä¸º offï¼Œè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯åªå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚è¿™æ—¶ï¼Œé»˜è®¤çš„ Næ˜¯ 8ï¼ŒM æ˜¯ 16ã€‚ MySQL é€‰é”™ç´¢å¼•ï¼Œæ˜¯å› ä¸ºç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œä¿®æ­£ç»Ÿè®¡ä¿¡æ¯ï¼Œæ‰§è¡Œ analyze table x; å‘½ä»¤ã€‚ å¦å¤–ä¸€ä¸ªè¯­å¥ï¼š mysql\u003e select * from t where (a between 1 and 1000) and (b between 50000 and 100000) order by b limit 1; ä»æ¡ä»¶ä¸Šçœ‹ï¼Œè¿™ä¸ªæŸ¥è¯¢æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå› æ­¤ä¼šè¿”å›ç©ºé›†åˆã€‚ å¦‚æœä¼˜åŒ–å™¨ä½¿ç”¨ç´¢å¼• a çš„è¯ï¼Œæ‰§è¡Œé€Ÿåº¦æ˜æ˜¾ä¼šå¿«å¾ˆå¤šï¼Œæ‰§è¡Œ explainå‘½ä»¤åï¼š è¿”å›ç»“æœä¸­ key å­—æ®µæ˜¾ç¤ºï¼Œè¿™æ¬¡ä¼˜åŒ–å™¨é€‰æ‹©äº†ç´¢å¼• bã€‚ ä»è¿™ä¸ªç»“æœä¸­ï¼Œä½ å¯ä»¥å¾—åˆ°ä¸¤ä¸ªç»“è®ºï¼š æ‰«æè¡Œæ•°çš„ä¼°è®¡å€¼ä¾ç„¶ä¸å‡†ç¡®ã€‚ è¿™ä¸ªä¾‹å­é‡Œ MySQL åˆé€‰é”™äº†ç´¢å¼•ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/10/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/10/"},{"categories":null,"content":" 3ã€ç´¢å¼•é€‰æ‹©å¼‚å¸¸å’Œå¤„ç† ä¸€ç§æ–¹æ³•æ˜¯ï¼Œé‡‡ç”¨ force index å¼ºè¡Œé€‰æ‹©ä¸€ä¸ªç´¢å¼•ã€‚ å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¿®æ”¹è¯­å¥ï¼Œå¼•å¯¼ MySQL ä½¿ç”¨æˆ‘ä»¬æœŸæœ›çš„ç´¢å¼•ã€‚ ä¿®æ”¹è¯­å¥åï¼š ä¹‹å‰ä¼˜åŒ–å™¨é€‰æ‹©ä½¿ç”¨ç´¢å¼• bï¼Œæ˜¯å› ä¸ºå®ƒè®¤ä¸ºä½¿ç”¨ç´¢å¼• b å¯ä»¥é¿å…æ’åºï¼ˆ b æœ¬èº«æ˜¯ç´¢å¼•ï¼Œå·²ç»æ˜¯æœ‰åºçš„äº†ï¼Œå¦‚æœé€‰æ‹©ç´¢å¼• b çš„è¯ï¼Œä¸éœ€è¦å†åšæ’åºï¼Œåªéœ€è¦éå†ï¼‰ï¼Œæ‰€ä»¥å³ä½¿æ‰«æè¡Œæ•°å¤šï¼Œä¹Ÿåˆ¤å®šä¸ºä»£ä»·æ›´å°ã€‚ ç°åœ¨ order by b,a è¿™ç§å†™æ³•ï¼Œè¦æ±‚æŒ‰ç…§ b,a æ’åºï¼Œå°±æ„å‘³ç€ä½¿ç”¨è¿™ä¸¤ä¸ªç´¢å¼•éƒ½éœ€è¦æ’åºã€‚å› æ­¤ï¼Œæ‰«æè¡Œæ•°æˆäº†å½±å“å†³ç­–çš„ä¸»è¦æ¡ä»¶ï¼Œäºæ˜¯æ­¤æ—¶ä¼˜åŒ–å™¨é€‰äº†åªéœ€è¦æ‰«æ 1000 è¡Œçš„ç´¢å¼• aã€‚ è¿™ç§ä¿®æ”¹å¹¶ä¸æ˜¯é€šç”¨çš„ä¼˜åŒ–æ‰‹æ®µï¼Œåªæ˜¯åˆšå¥½åœ¨è¿™ä¸ªè¯­å¥é‡Œé¢æœ‰ limit 1,order by b limit 1 å’Œ order by b,a limit 1 éƒ½ä¼šè¿”å›b æ˜¯æœ€å°çš„é‚£ä¸€è¡Œï¼Œé€»è¾‘ä¸Šä¸€è‡´ï¼Œæ‰å¯ä»¥è¿™ä¹ˆåšã€‚ å¦ä¸€ç§ä¿®æ”¹è¯­å¥ï¼š åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ç”¨ limit 100 è®©ä¼˜åŒ–å™¨æ„è¯†åˆ°ï¼Œä½¿ç”¨ b ç´¢å¼•ä»£ä»·æ˜¯å¾ˆé«˜çš„ã€‚å…¶å®æ˜¯æˆ‘ä»¬æ ¹æ®æ•°æ®ç‰¹å¾è¯±å¯¼äº†ä¸€ä¸‹ä¼˜åŒ–å™¨ï¼Œä¹Ÿä¸å…·å¤‡é€šç”¨æ€§ã€‚ ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ï¼Œæœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ï¼Œæ¥æä¾›ç»™ä¼˜åŒ–å™¨åšé€‰æ‹©ï¼Œæˆ–åˆ æ‰è¯¯ç”¨çš„ç´¢å¼•ã€‚ ç¬¬å››ç§æ–¹æ³•æ˜¯ï¼Œåˆ æ‰ç´¢å¼• bã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/10/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/10/"},{"categories":null,"content":" 4ã€é—®é¢˜å‰é¢æˆ‘ä»¬åœ¨æ„é€ ç¬¬ä¸€ä¸ªä¾‹å­çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ session A çš„é…åˆï¼Œè®© session B åˆ é™¤æ•°æ®ååˆé‡æ–°æ’å…¥äº†ä¸€éæ•°æ®ï¼Œç„¶åå°±å‘ç° explain ç»“æœä¸­ï¼Œrows å­—æ®µä» 10001 å˜æˆ 37000 å¤šã€‚ è€Œå¦‚æœæ²¡æœ‰ session A çš„é…åˆï¼Œåªæ˜¯å•ç‹¬æ‰§è¡Œ delete from t ã€call idata()ã€explain è¿™ä¸‰å¥è¯ï¼Œä¼šçœ‹åˆ° rows å­—æ®µå…¶å®è¿˜æ˜¯10000å·¦å³ã€‚ ç­”æ¡ˆï¼š delete è¯­å¥åˆ æ‰äº†æ‰€æœ‰çš„æ•°æ®ï¼Œç„¶åå†é€šè¿‡ call idata() æ’å…¥äº† 10 ä¸‡è¡Œæ•°æ®ï¼Œçœ‹ä¸Šå»æ˜¯è¦†ç›–äº†åŸæ¥çš„ 10 ä¸‡è¡Œã€‚ ä½†æ˜¯ï¼Œsession A å¼€å¯äº†äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥ä¹‹å‰æ’å…¥çš„ 10 ä¸‡è¡Œæ•°æ®æ˜¯ä¸èƒ½åˆ é™¤çš„ã€‚è¿™æ ·ï¼Œä¹‹å‰çš„æ•°æ®æ¯ä¸€è¡Œæ•°æ®éƒ½æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬æ˜¯ delete ä¹‹å‰çš„æ•°æ®ï¼Œæ–°ç‰ˆæœ¬æ˜¯æ ‡è®°ä¸º deleted çš„æ•°æ®ã€‚ è¿™æ ·ï¼Œç´¢å¼• a ä¸Šçš„æ•°æ®å…¶å®å°±æœ‰ä¸¤ä»½ã€‚ è¡¨çš„è¡Œæ•°ï¼Œä¼˜åŒ–å™¨ç›´æ¥ç”¨çš„æ˜¯ show table status çš„å€¼ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/10/:4:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/10/"},{"categories":null,"content":" 1ã€å­—ç¬¦ä¸²ç´¢å¼•å‡è®¾ï¼Œä½ ç°åœ¨ç»´æŠ¤ä¸€ä¸ªæ”¯æŒé‚®ç®±ç™»å½•çš„ç³»ç»Ÿï¼Œç”¨æˆ·è¡¨æ˜¯è¿™ä¹ˆå®šä¹‰çš„ mysql\u003e create table SUser( ID bigint unsigned primary key, email varchar(64), ... )engine=innodb; è¦ä½¿ç”¨é‚®ç®±ç™»å½•ï¼Œä¸€å®šä¼šå‡ºç°ç±»ä¼¼ä¸‹é¢çš„è¯­å¥ï¼š mysql\u003e select f1, f2 from SUser where email='xxx'; email è¿™ä¸ªå­—æ®µä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯­å¥å°±åªèƒ½åšå…¨è¡¨æ‰«æã€‚ MySQL æ˜¯æ”¯æŒå‰ç¼€ç´¢å¼•çš„ï¼Œä½ å¯ä»¥å®šä¹‰å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ä½œä¸ºç´¢å¼•ï¼Œä¾‹å¦‚ï¼š mysql\u003e alter table SUser add index index1(email); ## æ•´ä¸ªå­—ç¬¦ä¸² mysql\u003e alter table SUser add index index2(email(6)); ## å‰ 6 ä¸ªå­—èŠ‚ ä¸¤ä¸ªç´¢å¼•å›¾å·®åˆ«å¦‚ä¸‹ï¼š ä½¿ç”¨å‰ç¼€ç´¢å¼•çš„ä¼˜åŠ¿ï¼Œå ç”¨çš„ç©ºé—´ä¼šæ›´å°ï¼Œä½†å¯èƒ½ä¼šå¢åŠ é¢å¤–çš„è®°å½•æ‰«ææ¬¡æ•°ã€‚ ä¾‹å¦‚åˆ†ææ‰§è¡Œè¯­å¥ select id,name,email from SUser where email='zhangssxyz@xxx.com'; çš„è¿‡ç¨‹ã€‚ ä½¿ç”¨ index1 (æ•´ä¸ªå­—ç¬¦ä¸²)ï¼š è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦ä» index1 ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯ â€™zhangssxyz@xxx.comâ€™ çš„è¿™æ¡è®°å½•ï¼Œå†è¿›è¡Œå›è¡¨æ“ä½œï¼Œå°±å¯ä»¥è¿”å›ç»“æœã€‚ ä½¿ç”¨ index2 (å‰ 6 ä¸ªå­—èŠ‚)ï¼š è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä» index2 ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯ â€™zhangsâ€™ çš„å…¨éƒ¨è®°å½•ï¼Œå†è¿›è¡Œå›è¡¨æ“ä½œï¼Œé€ä¸€åˆ¤æ–­ email æ˜¯ â€™zhangssxyz@xxx.comâ€™ï¼Œæœ€åè¿”å›ç»“æœã€‚å¯èƒ½æœ‰å¤§é‡ä»¥ â€™zhangsâ€™ å¼€å¤´çš„è®°å½•ï¼Œ æ‰€ä»¥å¯èƒ½ä¼šå¢åŠ é¢å¤–çš„è®°å½•æ‰«ææ¬¡æ•°ã€‚ ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå®šä¹‰å¥½é•¿åº¦ï¼Œå°±å¯ä»¥åšåˆ°æ—¢èŠ‚çœç©ºé—´ï¼Œåˆä¸ç”¨é¢å¤–å¢åŠ å¤ªå¤šçš„æŸ¥è¯¢æˆæœ¬ã€‚ å¦‚æœå»ºç«‹å‰ç¼€ç´¢å¼•ï¼Œå°±è¦å…³æ³¨åŒºåˆ†åº¦ï¼ŒåŒºåˆ†åº¦è¶Šé«˜è¶Šå¥½ã€‚ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥ï¼Œç»Ÿè®¡ä¸åŒç´¢å¼•çš„ä¸ªæ•°ï¼š mysql\u003e select count(distinct email) as L from SUser; ä¾‹å¦‚ï¼Œç»Ÿè®¡ 4~7 ä¸ªå­—èŠ‚çš„å‰ç¼€ç´¢å¼•ï¼š mysql\u003e select count(distinct left(email,4)ï¼‰as L4, count(distinct left(email,5)ï¼‰as L5, count(distinct left(email,6)ï¼‰as L6, count(distinct left(email,7)ï¼‰as L7, from SUser; ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/11/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/11/"},{"categories":null,"content":" 2ã€å…¶ä»–æ–¹å¼å¯¹äºç±»ä¼¼äºé‚®ç®±è¿™æ ·çš„å­—æ®µæ¥è¯´ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•çš„æ•ˆæœå¯èƒ½è¿˜ä¸é”™,é‡åˆ°å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿå¥½çš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ ä¾‹å¦‚å¯¹èº«ä»½è¯å·çš„è§£å†³æ–¹æ³•ã€‚ ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨ã€‚ mysql\u003e select field_list from t where id_card = reverse('input_id_card_string'); ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µ ## æ·»åŠ ç´¢å¼•ï¼Œç”¨æ¥å­˜å‚¨ crc32ã€‚ mysql\u003e alter table t add id_card_crc int unsigned, add index(id_card_crc); # æŸ¥è¯¢æ—¶åˆ¤æ–­ crc32 å€¼ mysql\u003e select field_list from t where id_card_crc=crc32('input_id_card_string') and id_card='input_id_card_string' å®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œéƒ½ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/11/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/11/"},{"categories":null,"content":" 3ã€é—®é¢˜å¦‚æœä½ åœ¨ç»´æŠ¤ä¸€ä¸ªå­¦æ ¡çš„å­¦ç”Ÿä¿¡æ¯æ•°æ®åº“ï¼Œå­¦ç”Ÿç™»å½•åçš„ç»Ÿä¸€æ ¼å¼æ˜¯ â€å­¦å·@gmail.com\", è€Œå­¦å·çš„è§„åˆ™æ˜¯ï¼šåäº”ä½çš„æ•°å­—ï¼Œå…¶ä¸­å‰ä¸‰ä½æ˜¯æ‰€åœ¨åŸå¸‚ç¼–å·ã€ç¬¬å››åˆ°ç¬¬å…­ä½æ˜¯å­¦æ ¡ç¼–å·ã€ç¬¬ä¸ƒä½åˆ°ç¬¬åä½æ˜¯å…¥å­¦å¹´ä»½ã€æœ€åäº”ä½æ˜¯é¡ºåºç¼–å·ã€‚ ç³»ç»Ÿç™»å½•çš„æ—¶å€™éƒ½éœ€è¦å­¦ç”Ÿè¾“å…¥ç™»å½•åå’Œå¯†ç ï¼ŒéªŒè¯æ­£ç¡®åæ‰èƒ½ç»§ç»­ä½¿ç”¨ç³»ç»Ÿã€‚å°±åªè€ƒè™‘ç™»å½•éªŒè¯è¿™ä¸ªè¡Œä¸ºçš„è¯ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡è¿™ä¸ªç™»å½•åçš„ç´¢å¼•å‘¢ï¼Ÿ ç­”æ¡ˆï¼š å¯ä»¥åªå­˜å…¥å­¦å¹´ä»½åŠ é¡ºåºç¼–å·ï¼Œå®ƒä»¬çš„é•¿åº¦æ˜¯ 9 ä½ã€‚å¦‚æœæ•°å­—ç±»å‹æ¥å­˜è¿™ 9 ä½æ•°å­—ã€‚æ¯”å¦‚ 201100001 ï¼Œè¿™æ ·åªéœ€è¦å  4 ä¸ªå­—èŠ‚ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/11/:3:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/11/"},{"categories":null,"content":" 1ã€SQLè¯­å¥ä¸ºä»€ä¹ˆå˜\"æ…¢\"äº†åœ¨å‰é¢ç¬¬ 2 ç¯‡æ–‡ç« ã€Šæ—¥å¿—ç³»ç»Ÿï¼šä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿã€‹ä¸­ï¼ŒInnoDB åœ¨å¤„ç†æ›´æ–°è¯­å¥æ—¶ï¼Œåªåšäº†å†™æ—¥å¿—è¿™ä¸€ä¸ªç£ç›˜æ“ä½œï¼Œè¿™ä¸ªæ—¥å¿—å«ä½œ redo logã€‚æ›´æ–°å†…å­˜å†™å®Œ redo log åï¼Œå°±è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæœ¬æ¬¡æ›´æ–°æˆåŠŸã€‚ã€‚ å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é¡µä¸º\"è„é¡µ\"ã€‚å†…å­˜æ•°æ®å†™å…¥åˆ°ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µçš„å†…å®¹å°±ä¸€è‡´äº†ï¼Œç§°ä¸º\"å¹²å‡€é¡µ\"ã€‚ MySQL å¶å°”\"æŠ–\"ä¸€ä¸‹çš„é‚£ä¸ªç¬é—´ï¼Œå¯èƒ½å°±æ˜¯åœ¨åˆ·è„é¡µï¼ˆflushï¼‰ã€‚ å¼•å‘æ•°æ®åº“çš„ flush è¿‡ç¨‹çš„å‡ ç§æƒ…å†µï¼š InnoDB çš„ redo log å†™æ»¡äº†ã€‚ ç³»ç»Ÿå†…å­˜ä¸è¶³ã€‚å½“éœ€è¦æ–°çš„å†…å­˜é¡µï¼Œè€Œå†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå°±è¦æ·˜æ±°ä¸€äº›æ•°æ®é¡µï¼Œç©ºå‡ºå†…å­˜ç»™åˆ«çš„æ•°æ®é¡µä½¿ç”¨ã€‚å¦‚æœæ·˜æ±°çš„æ˜¯\"è„é¡µ\"ï¼Œå°±è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜ã€‚ MySQL è®¤ä¸ºç³»ç»Ÿ\"ç©ºé—²\"çš„æ—¶å€™ã€‚ MySQL æ­£å¸¸å…³é—­ã€‚ ä¸Šé¢å››ç§åœºæ™¯å¯¹æ€§èƒ½çš„å½±å“ï¼š ç¬¬ 3 ç§æƒ…å†µå’Œç¬¬ 4 ç§åœºæ™¯æ˜¯ MySQL æ­£å¸¸æƒ…å†µï¼Œä¸ç”¨å¤ªå…³å¿ƒæ€§èƒ½ã€‚ ç¬¬ 1 ç§æ˜¯ â€œredo log å†™æ»¡äº†ï¼Œè¦ flush è„é¡µâ€ï¼Œå‡ºç°è¿™ç§æƒ…å†µäº†ï¼Œæ•´ä¸ªç³»ç»Ÿå°±ä¸èƒ½å†æ¥å—æ›´æ–°ï¼Œå¦‚æœä½ ä»ç›‘æ§ä¸Šçœ‹ï¼Œè¿™æ—¶å€™æ›´æ–°æ•°ä¼šè·Œä¸º 0ã€‚ ç¬¬ 2 ç§æ˜¯\"å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œè¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜\"ï¼Œè¿™ç§æƒ…å†µå…¶å®æ˜¯å¸¸æ€ã€‚InnoDBç”¨ç¼“å†²æ± ï¼ˆbuffer poolï¼‰ç®¡ç†å†…å­˜ï¼Œç¼“å†²æ± ä¸­çš„å†…å­˜é¡µæœ‰ä¸‰ç§çŠ¶æ€ï¼š ç¬¬ä¸€ç§æ˜¯ï¼Œè¿˜æ²¡æœ‰ä½¿ç”¨çš„ï¼› ç¬¬äºŒç§æ˜¯ï¼Œä½¿ç”¨äº†å¹¶ä¸”æ˜¯å¹²å‡€é¡µï¼› ç¬¬ä¸‰ç§æ˜¯ï¼Œä½¿ç”¨äº†å¹¶ä¸”æ˜¯è„é¡µã€‚ InnoDB çš„ç­–ç•¥æ˜¯å°½é‡ä½¿ç”¨å†…å­˜ï¼Œå› æ­¤å¯¹äºä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åº“æ¥è¯´ï¼Œæœªè¢«ä½¿ç”¨çš„é¡µé¢å¾ˆå°‘ã€‚åˆ·è„é¡µè™½ç„¶æ˜¯å¸¸æ€ï¼Œä½†æ˜¯å‡ºç°ä»¥ä¸‹è¿™ä¸¤ç§æƒ…å†µï¼Œéƒ½æ˜¯ä¼šæ˜æ˜¾å½±å“æ€§èƒ½çš„ï¼š ä¸€ä¸ªæŸ¥è¯¢è¦æ·˜æ±°çš„è„é¡µä¸ªæ•°å¤ªå¤šï¼Œä¼šå¯¼è‡´æŸ¥è¯¢çš„å“åº”æ—¶é—´æ˜æ˜¾å˜é•¿ã€‚ æ—¥å¿—å†™æ»¡ï¼Œæ›´æ–°å…¨éƒ¨å µä½ï¼Œå†™æ€§èƒ½è·Œä¸º 0ï¼Œè¿™ç§æƒ…å†µå¯¹æ•æ„Ÿä¸šåŠ¡æ¥è¯´ï¼Œæ˜¯ä¸èƒ½æ¥å—çš„ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/12/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/12/"},{"categories":null,"content":" 2ã€InnoDB åˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥ innodb_io_capacity å‚æ•°ï¼šå‘Šè¯‰ InnoDB æ‰€åœ¨ä¸»æœºçš„ IO èƒ½åŠ›ã€‚ å¯ä»¥ä½¿ç”¨ fio è¿™ä¸ªå·¥å…·æ¥æµ‹è¯• IO èƒ½åŠ›ï¼š fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest InnoDB çš„åˆ·ç›˜é€Ÿåº¦å°±æ˜¯è¦å‚è€ƒè¿™ä¸¤ä¸ªå› ç´ ï¼šä¸€ä¸ªæ˜¯è„é¡µæ¯”ä¾‹ï¼Œä¸€ä¸ªæ˜¯redo logå†™ç›˜é€Ÿåº¦ã€‚ å‚æ•° innodb_max_dirty_pages_pct æ˜¯è„é¡µæ¯”ä¾‹ä¸Šé™ï¼Œé»˜è®¤å€¼æ˜¯ 75%ã€‚ è„é¡µæ¯”ä¾‹æ˜¯é€šè¿‡ Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total å¾—åˆ°çš„ï¼Œå…·ä½“çš„å‘½ä»¤å¦‚ä¸‹ï¼š select VARIABLE_VALUE into @a from global_status where VARIABLE_NAME = 'Innodb_buffer_pool_pages_dirty'; select VARIABLE_VALUE into @b from global_status where VARIABLE_NAME = 'Innodb_buffer_pool_pages_total'; select @a/@b; è¦å°½é‡é¿å…åˆ·è„é¡µè¿™ç§æƒ…å†µï¼Œä½ å°±è¦åˆç†åœ°è®¾ç½® innodb_io_capacity çš„å€¼ï¼Œå¹¶ä¸”å¹³æ—¶è¦å¤šå…³æ³¨è„é¡µæ¯”ä¾‹ï¼Œä¸è¦è®©å®ƒç»å¸¸æ¥è¿‘ 75%ã€‚ ä¸€ä¸ªæœ‰è¶£çš„ç­–ç•¥ï¼š ä¸€æ—¦ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚éœ€è¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å…ˆ flush æ‰ä¸€ä¸ªè„é¡µæ—¶ï¼Œè¿™ä¸ªæŸ¥è¯¢å°±å¯èƒ½è¦æ¯”å¹³æ—¶æ…¢äº†ã€‚è€Œ MySQLä¸­ çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå¯èƒ½è®©ä½ çš„æŸ¥è¯¢ä¼šæ›´æ…¢ï¼šåœ¨å‡†å¤‡åˆ·ä¸€ä¸ªè„é¡µçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µæ—è¾¹çš„æ•°æ®é¡µåˆšå¥½æ˜¯è„é¡µï¼Œå°±ä¼šæŠŠè¿™ä¸ª\"é‚»å±…\"ä¹Ÿå¸¦ç€ä¸€èµ·åˆ·æ‰ï¼›è€Œä¸”è¿™ä¸ªæŠŠ\"é‚»å±…\"æ‹–ä¸‹æ°´çš„é€»è¾‘è¿˜å¯ä»¥ç»§ç»­è”“å»¶ï¼Œä¹Ÿå°±æ˜¯å¯¹äºæ¯ä¸ªé‚»å±…æ•°æ®é¡µï¼Œå¦‚æœè·Ÿå®ƒç›¸é‚»çš„æ•°æ®é¡µä¹Ÿè¿˜æ˜¯è„é¡µçš„è¯ï¼Œä¹Ÿä¼šè¢«æ”¾åˆ°ä¸€èµ·åˆ·ã€‚ åœ¨ InnoDB ä¸­ï¼Œinnodb_flush_neighbors å‚æ•°å°±æ˜¯ç”¨æ¥æ§åˆ¶è¿™ä¸ªè¡Œä¸ºçš„ï¼Œå€¼ä¸º 1 çš„æ—¶å€™ä¼šæœ‰ä¸Šè¿°çš„\"è¿å\"æœºåˆ¶ï¼Œå€¼ä¸º 0 æ—¶è¡¨ç¤ºä¸æ‰¾é‚»å±…ï¼Œè‡ªå·±åˆ·è‡ªå·±çš„ã€‚ å¦‚æœæ˜¯ SSD è¿™ç§ï¼Œ å»ºè®® innodb_flush_neighbors = 0ã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/12/:2:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/12/"},{"categories":null,"content":" 3ã€é—®é¢˜ä¸€ä¸ªå†…å­˜é…ç½®ä¸º 128GBã€innodb_io_capacityè®¾ç½®ä¸º 20000 çš„å¤§è§„æ ¼å®ä¾‹ï¼Œæ­£å¸¸ä¼šå»ºè®®ä½ å°†redo log è®¾ç½®æˆ 4 ä¸ª 1GB çš„æ–‡ä»¶ã€‚ ä½†å¦‚æœä½ åœ¨é…ç½®çš„æ—¶å€™ä¸æ…å°† redo log è®¾ç½®æˆäº† 1ä¸ª 100M çš„æ–‡ä»¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿåˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µå‘¢ï¼Ÿ ç­”æ¡ˆï¼š redo log å¤ªå°ï¼Œå¾ˆå¿«å°±ä¼šè¢«å†™æ»¡ï¼Œå°±å¿…é¡»è¦ flushï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ change buffer çš„ä¼˜åŒ–ä¹Ÿå¤±æ•ˆäº†ï¼Œå› ä¸º flush æ—¶ï¼Œå¿…é¡»è¦è¿›è¡Œ merge æ“ä½œã€‚ä½ çœ‹åˆ°çš„ç°è±¡å°±æ˜¯ç£ç›˜å‹åŠ›å¾ˆå°ï¼Œä½†æ˜¯æ•°æ®åº“å‡ºç°é—´æ­‡æ€§çš„æ€§èƒ½ä¸‹è·Œã€‚ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/12/:2:1","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/12/"},{"categories":null,"content":" MySQL å®æˆ˜ 45 è®²01ã€SQL æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ ","date":"0001-01-01","objectID":"/ooooo-notes/old-notes/geektime/mysql-45/readme/:1:0","tags":null,"title":"","uri":"/ooooo-notes/old-notes/geektime/mysql-45/readme/"}]